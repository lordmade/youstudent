<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #181818;
    }
    .loader-container {
      display: none;
      justify-content: center;
      align-items: center;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 9999;
    }
    .animate-spin-slow {
      animation: spin 4s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .post-card {
      transition: transform 0.2s;
      padding: 1.5rem;
    }
    .post-card:hover {
      transform: scale(1.02);
    }
    .post-image {
      height: 16rem;
    }
    .btn-like, .btn-comment, .btn-follow {
      background-color: #282828;
      color: #fff;
      transition: background-color 0.2s;
    }
    .btn-like:hover, .btn-comment:hover, .btn-follow:hover {
      background-color: #ff0000;
    }
    .btn-like.liked svg {
      fill: #ff0000;
    }
    .btn-follow.following {
      background-color: #ff0000;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #282828;
      padding: 24px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-content textarea {
      background-color: #121212;
      border: 1px solid #444;
      color: #fff;
    }
    .modal-content button {
      transition: background-color 0.2s;
    }
    @media (max-width: 768px) {
      .post-actions {
        flex-wrap: wrap;
        gap: 8px;
      }
      .profile-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .btn-follow {
        width: 100%;
        text-align: center;
      }
    }
  </style>
</head>
<body class="bg-[#181818] text-white">
  <!-- Loader Overlay -->
  <div id="loader-overlay" class="loader-container">
    <svg width="80" height="80" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg" class="animate-spin-slow">
      <circle cx="60" cy="60" r="50" stroke="#ff0000" stroke-width="6" stroke-linecap="round" stroke-dasharray="240" stroke-dashoffset="60">
        <animate attributeName="stroke-dashoffset" values="60;300" dur="2s" repeatCount="indefinite"/>
      </circle>
    </svg>
  </div>

  <!-- Comment Modal -->
  <div id="comment-modal" class="modal">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4">Comments</h2>
      <div id="comment-list" class="mb-4"></div>
      <textarea id="comment-input" rows="3" class="w-full px-4 py-2 rounded-md mb-4" placeholder="Add a comment..."></textarea>
      <p id="comment-error" class="text-sm text-red-500 mb-4 hidden"></p>
      <div class="flex justify-end space-x-2">
        <button id="comment-cancel" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">Cancel</button>
        <button id="comment-submit" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Submit</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="container mx-auto p-6">
    <!-- Profile Header -->
    <div id="profile-header" class="profile-header flex items-center space-x-6 mb-8">
      <img id="profile-pic" src="https://www.gravatar.com/avatar?d=mp" alt="w-16 h-16 rounded-full border border-gray-300" />
      <div class="flex-1">
        <h1 id="text-2xl font-bold" id="profile-email"></h1>
        <p id="followers-count" class="text-sm text-gray-500"></p>
        <button id="follow-btn" class="btn-follow px-6 py-2 rounded-md text-sm mt-2 hidden">Follow</button>
      </div>
    </div>

    <!-- Timeline -->
    <section>
      <div id="timeline" class="grid grid-cols-1 gap-4"></div>
    </section>

    <p id="error-text" class="text-red-500 text-center mt-4 hidden"></p>
  </main>

  <!-- Firebase and JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
    import { getDatabase, ref, set, get, push, remove } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNpjemvouPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97YHMSHL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const loaderOverlay = document.getElementById("loader-overlay");
    const profilePic = document.getElementById("profile-pic");
    const profileEmail = document.getElementById("profile-email");
    const followersCount = document.getElementById("followers-count");
    const followBtn = document.getElementById("follow-btn");
    const timeline = document.getElementById("timeline");
    const errorMessage = document.getElementById("error-text");
    const commentModal = document.getElementById("comment-modal");
    const commentList = document.getElementById("comment-list");
    const commentInput = document.getElementById("comment-input");
    const commentCancel = document.getElementById("comment-cancel");
    const commentSubmit = document.getElementById("comment-submit");
    const commentError = document.getElementById("comment-error");

    // Get UID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const profileUid = urlParams.get("uid");

    // Relative Time
    function getRelativeTime(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      if (seconds < 60) return seconds === 1 ? "1 second ago" : `${seconds} seconds ago`;
      if (minutes < 60) return minutes === 1 ? "1 minute ago" : `${minutes} minutes ago`;
      if (hours < 24) return hours === 1 ? "1 hour ago" : `${hours} hours ago`;
      return days === 1 ? "1 day ago" : `${days} days ago`;
    }

    // Toggle Follow
    async function toggleFollow() {
      const user = auth.currentUser;
      if (!user) {
        errorMessage.textContent = "Please log in to follow.";
        errorMessage.classList.remove("hidden");
        return;
      }
      if (user.uid === profileUid) return;
      loaderOverlay.style.display = "flex";
      try {
        const followRef = ref(db, `users/${profileUid}/followers/${user.uid}`);
        const followingRef = ref(db, `users/${user.uid}/following/${profileUid}`);
        const followSnapshot = await get(followRef);
        if (followSnapshot.exists()) {
          await remove(followRef);
          await remove(followingRef);
          followBtn.classList.remove("following");
          followBtn.textContent = "Follow";
        } else {
          await set(followRef, true);
          await set(followingRef, true);
          followBtn.classList.add("following");
          followBtn.textContent = "Following";
        }
        await renderProfile();
      } catch (error) {
        console.error("Error toggling follow:", error.code, error.message);
        errorMessage.textContent = "Error following user: " + error.message;
        errorMessage.classList.remove("hidden");
      } finally {
        loaderOverlay.style.display = "none";
      }
    }

    // Toggle Like
    async function toggleLike(postId, button) {
      const user = auth.currentUser;
      if (!user) {
        errorMessage.textContent = "Please log in to like a post.";
        errorMessage.classList.remove("hidden");
        return;
      }
      loaderOverlay.style.display = "flex";
      try {
        const likeRef = ref(db, `posts/${postId}/likes/${user.uid}`);
        const likeSnapshot = await get(likeRef);
        if (likeSnapshot.exists()) {
          await remove(likeRef);
          button.classList.remove("liked");
        } else {
          await set(likeRef, true);
          button.classList.add("liked");
        }
        await renderTimeline();
      } catch (error) {
        console.error("Error toggling like:", error.code, error.message);
        errorMessage.textContent = "Error liking post: " + error.message;
        errorMessage.classList.remove("hidden");
      } finally {
        loaderOverlay.style.display = "none";
      }
    }

    // Comment Modal Controls
    function openCommentModal(postId) {
      commentModal.style.display = "flex";
      commentInput.value = "";
      commentError.classList.add("hidden");
      commentModal.dataset.postId = postId;
      renderComments(postId);
    }

    function closeCommentModal() {
      commentModal.style.display = "none";
      commentInput.value = "";
      commentError.classList.add("hidden");
    }

    commentCancel.addEventListener("click", closeCommentModal);

    document.addEventListener("click", (e) => {
      if (e.target === commentModal) {
        closeCommentModal();
      }
    });

    // Render Comments
    async function renderComments(postId) {
      try {
        const commentsRef = ref(db, `posts/${postId}/comments`);
        const snapshot = await get(commentsRef);
        commentList.innerHTML = "";
        if (snapshot.exists()) {
          const comments = snapshot.val();
          Object.entries(comments).forEach(([_, comment]) => {
            const commentDiv = document.createElement("div");
            commentDiv.className = "mb-3 border-b border-gray-600 pb-2";
            commentDiv.innerHTML = `
              <p class="text-sm font-semibold">${comment.authorEmail}</p>
              <p class="text-sm text-gray-300">${comment.text}</p>
              <p class="text-xs text-gray-500">${getRelativeTime(comment.timestamp)}</p>
            `;
            commentList.appendChild(commentDiv);
          });
        } else {
          commentList.innerHTML = "<p class='text-gray-400 text-sm'>No comments yet.</p>";
        }
      } catch (error) {
        console.error("Error fetching comments:", error.code, error.message);
        commentError.textContent = "Error loading comments: " + error.message;
        commentError.classList.remove("hidden");
      }
    }

    // Add Comment
    commentSubmit.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) {
        closeCommentModal();
        errorMessage.textContent = "Please log in to comment.";
        errorMessage.classList.remove("hidden");
        return;
      }
      const postId = commentModal.dataset.postId;
      const text = commentInput.value.trim();
      if (!text) {
        commentError.textContent = "Please enter a comment.";
        commentError.classList.remove("hidden");
        return;
      }
      loaderOverlay.style.display = "flex";
      try {
        const userRef = ref(db, `users/${user.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.exists() ? userSnapshot.val() : {};
        const userEmail = userData.email || user.email;
        const commentsRef = ref(db, `posts/${postId}/comments`);
        await push(commentsRef, {
          text,
          authorEmail: userEmail,
          timestamp: Date.now()
        });
        commentInput.value = "";
        await renderComments(postId);
      } catch (error) {
        console.error("Error adding comment:", error.code, error.message);
        commentError.textContent = "Error adding comment: " + error.message;
        commentError.classList.remove("hidden");
      } finally {
        loaderOverlay.style.display = "none";
      }
    });

    // Render Profile and Timeline
    async function renderProfile() {
      loaderOverlay.style.display = "flex";
      try {
        const userRef = ref(db, `users/${profileUid}`);
        const userSnapshot = await get(userRef);
        if (!userSnapshot.exists()) {
          errorMessage.textContent = "User not found.";
          errorMessage.classList.remove("hidden");
          return;
        }
        const userData = userSnapshot.val();
        profilePic.src = userData.photoURL || "https://www.gravatar.com/avatar?d=mp";
        profileEmail.textContent = userData.email || "Unknown User";
        const followerCount = userData.followers ? Object.keys(userData.followers).length : 0;
        followersCount.textContent = `${followerCount} Follower${followerCount === 1 ? '' : 's'}`;

        const currentUser = auth.currentUser;
        if (currentUser && currentUser.uid !== profileUid) {
          followBtn.style.display = "inline-flex";
          const followRef = ref(db, `users/${profileUid}/followers/${currentUser.uid}`);
          const followSnapshot = await get(followRef);
          if (followSnapshot.exists()) {
            followBtn.classList.add("following");
            followBtn.textContent = "Following";
          } else {
            followBtn.classList.remove("following");
            followBtn.textContent = "Follow";
          }
        } else {
          followBtn.style.display = "none";
        }

        // Render Timeline
        const postsRef = ref(db, "posts");
        const snapshot = await get(postsRef);
        timeline.innerHTML = "";
        if (snapshot.exists()) {
          const posts = snapshot.val();
          const userPosts = Object.entries(posts).filter(([_, post]) => post.uid === profileUid).reverse();
          if (userPosts.length === 0) {
            timeline.innerHTML = "<p class='text-gray-400 text-center'>No posts yet.</p>";
            return;
          }
          userPosts.forEach(([postId, post]) => {
            const likeCount = post.likes ? Object.keys(post.likes).length : 0;
            const commentCount = post.comments ? Object.keys(post.comments).length : 0;
            const isLiked = currentUser && post.likes && post.likes[currentUser.uid];
            const card = document.createElement("div");
            card.className = "post-card bg-[#282828] rounded-lg";
            card.innerHTML = `
              <div class="flex items-center mb-3">
                <img src="${userData.photoURL || 'https://www.gravatar.com/avatar?d=mp'}" alt="Author" class="w-10 h-10 rounded-full mr-3">
                <div>
                  <p class="text-base font-semibold">${post.authorEmail}</p>
                  <p class="text-sm text-gray-500">${getRelativeTime(post.timestamp)}</p>
                </div>
              </div>
              ${post.type === "image" ? `<img src="${post.content}" alt="Post Image" class="post-image w-full object-cover rounded-md mb-3" onerror="this.src='https://via.placeholder.com/300?text=Invalid+Image';" />` : `<p class="text-base text-gray-300">${post.content}</p>`}
              <div class="post-actions flex justify-between mt-3">
                <button class="btn-like flex items-center space-x-1 px-3 py-1 rounded-md text-sm ${isLiked ? 'liked' : ''}" data-post-id="${postId}">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 0-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                </svg>
                <span>${likeCount} Like${likeCount === 1 ? '' : 's'}</span>
                </button>
                <button class="btn-comment flex items-center space-x-1 px-3 py-1 rounded-md text-sm" data-post-id="${postId}">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 01-2 2h-5l-5 5v-5z"/>
                <span>${commentCount} Comment${commentCount === 1 ? '' : 's'}</span>
                </button>
              </div>
            `;
            timeline.appendChild(card);
          });

          // Add Like and Comment Listeners
          document.querySelectorAll(".btn-like").forEach(button => {
            button.addEventListener("click", () => toggleLike(button.dataset.post-id, button));
          });
          document.querySelectorAll(".btn-comment").forEach(button => {
            button.addEventListener("click", () => openCommentModal(button.dataset.postId));
          });
        } else {
          timeline.appendChild.innerHTML = "<p class='text-gray-400 text-center'>No posts available.</p>";
        }
      } catch (error) {
        console.error("Error loading profile:", error.code, error.message);
        errorMessage.textContent = "Error loading profile: " + error.message;
        errorMessage.classList.remove("hidden");
      } finally {
        loaderOverlay.style.display = "none";
      }
    }

    // Follow Button Listener
    followBtn.addEventListener("click", toggleFollow);

    // Auth State Listener
    onAuthStateChanged(auth, async (user) {
      loaderOverlay.style.display = "flex";
      try {
        if (user) {
          await renderProfile();
        } else {
          window.location.href = "login.html";
        }
      } catch (error) {
        console.error("Auth state error:", error.code, error.message);
        errorMessage.textContent = "Error loading user data: " + error.message;
        errorMessage.classList.remove("hidden");
      } finally {
        loaderOverlay.style.display = "none";
      }
    });
  </script>
</body>
</html>
