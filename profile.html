<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9f9;
      margin: 0;
      min-height: 100vh;
      padding: 1rem;
    }
    .profile-container {
      max-width: 400px;
      margin: 2rem auto;
      background: white;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    img.avatar {
      width: 120px;
      height: 120px;
      border-radius: 9999px;
      object-fit: cover;
      margin-bottom: 1rem;
    }
    label {
      display: block;
      font-weight: 600;
      margin-top: 1rem;
      margin-bottom: 0.25rem;
    }
    input[type=text], textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      font-size: 1rem;
      resize: vertical;
    }
    button {
      margin-top: 1.5rem;
      background: #ef4444;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 9999px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    .readonly {
      background: #f3f4f6;
      padding: 0.5rem;
      border-radius: 0.5rem;
      user-select: none;
      white-space: pre-wrap;
      min-height: 1.5rem;
    }
  </style>
</head>
<body>

<div class="profile-container">
  <button onclick="location.href='chat.html?uid=' + profileUid" class="mb-4 text-red-500 font-semibold">‚Üê Back to Chat</button>

  <img id="profile-photo" class="avatar" src="https://www.gravatar.com/avatar?d=mp" alt="User Avatar" />
  
  <div>
    <label for="name">Name</label>
    <input type="text" id="name" />
  </div>

  <div>
    <label for="bio">Bio</label>
    <textarea id="bio" rows="4"></textarea>
  </div>

  <button id="save-btn" style="display:none;">Save Profile</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
  import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
    authDomain: "fire-b-a8878.firebaseapp.com",
    databaseURL: "https://fire-b-a8878.firebaseio.com",
    projectId: "fire-b-a8878",
    storageBucket: "fire-b-a8878.appspot.com",
    messagingSenderId: "658673187627",
    appId: "1:658673187627:web:6e4c29af661785f0afa36e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getDatabase();

  const urlParams = new URLSearchParams(window.location.search);
  const profileUid = urlParams.get("uid");

  if (!profileUid) {
    alert("No user specified");
    location.href = "index.html";
  }

  const nameInput = document.getElementById("name");
  const bioInput = document.getElementById("bio");
  const photoImg = document.getElementById("profile-photo");
  const saveBtn = document.getElementById("save-btn");

  let currentUserUid;

  onAuthStateChanged(auth, async (user) => {
    if (!user) return location.href = "login.html";
    currentUserUid = user.uid;

    const userSnap = await get(ref(db, `users/${profileUid}`));
    if (!userSnap.exists()) {
      alert("User profile not found");
      return;
    }
    const data = userSnap.val();

    photoImg.src = data.photoURL || "https://www.gravatar.com/avatar?d=mp";
    nameInput.value = data.name || "";
    bioInput.value = data.bio || "";

    if (currentUserUid === profileUid) {
      // Owner: editable fields
      nameInput.disabled = false;
      bioInput.disabled = false;
      saveBtn.style.display = "inline-block";
    } else {
      // Not owner: readonly mode
      nameInput.disabled = true;
      bioInput.disabled = true;

      nameInput.classList.add("readonly");
      bioInput.classList.add("readonly");
      saveBtn.style.display = "none";
    }
  });

  saveBtn.onclick = async () => {
    const newName = nameInput.value.trim();
    const newBio = bioInput.value.trim();

    if (!newName) {
      alert("Name cannot be empty");
      return;
    }

    await update(ref(db, `users/${profileUid}`), {
      name: newName,
      bio: newBio
    });

    alert("Profile saved!");
  };
</script>

</body>
</html>
