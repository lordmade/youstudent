<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BanterBox - Profile</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Roboto', 'Segoe UI', sans-serif;
      background-color: #f5f8fa;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      color: #0f1419;
    }
    body.dark {
      background-color: #000;
      color: #e7e9ea;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 0;
    }
    .profile-header {
      position: relative;
      height: 200px;
      background-color: #c4d4e5;
    }
    .profile-header.dark {
      background-color: #1a1a1b;
    }
    .cover-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-pic {
      position: absolute;
      bottom: -60px;
      left: 20px;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid #fff;
      object-fit: cover;
      transition: transform 0.2s ease;
    }
    .profile-pic:hover {
      transform: scale(1.1);
    }
    .profile-pic.dark {
      border-color: #000;
    }
    .user-info {
      padding: 70px 20px 20px;
    }
    .user-info h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }
    .user-info p {
      font-size: 0.9rem;
      color: #536471;
      margin: 0.5rem 0;
    }
    .user-info.dark h1 {
      color: #e7e9ea;
    }
    .user-info.dark p {
      color: #71767b;
    }
    .stats {
      display: flex;
      gap: 1.5rem;
      margin-top: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #cfd9de;
    }
    .stats.dark {
      border-bottom-color: #2f3336;
    }
    .stat {
      font-size: 0.9rem;
    }
    .stat strong {
      font-weight: 700;
      color: #0f1419;
    }
    .stat.dark strong {
      color: #e7e9ea;
    }
    .bio {
      padding: 1rem 20px;
      border-bottom: 1px solid #cfd9de;
    }
    .bio.dark {
      border-bottom-color: #2f3336;
    }
    .bio p {
      margin: 0;
      font-size: 0.9rem;
      color: #536471;
    }
    .bio.dark p {
      color: #71767b;
    }
    .edit-section {
      padding: 1rem 20px;
      display: none;
    }
    .edit-section.active {
      display: block;
    }
    .input-field {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #cfd9de;
      border-radius: 4px;
      font-size: 0.9rem;
      background: #fff;
      margin-bottom: 0.5rem;
    }
    .input-field.dark {
      background: #16181c;
      border-color: #2f3336;
      color: #e7e9ea;
    }
    .input-field:focus {
      outline: none;
      border-color: #1d9bf0;
      box-shadow: 0 0 0 2px rgba(29, 155, 240, 0.3);
    }
    .upload-result {
      font-size: 0.85rem;
      color: #17bf63;
      margin-top: 0.5rem;
    }
    .upload-result.error {
      color: #f4212e;
    }
    .upload-result.dark {
      color: #00ba7c;
    }
    .upload-result.dark.error {
      color: #f4212e;
    }
    .media-grid {
      padding: 1rem 0;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 2px;
    }
    .media-card {
      aspect-ratio: 1 / 1;
      background-color: #f5f8fa;
      cursor: pointer;
      overflow: hidden;
    }
    .media-card:hover img {
      transform: scale(1.1);
    }
    .media-card.dark {
      background-color: #16181c;
    }
    .media-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.2s ease;
    }
    .btn-primary {
      background-color: #1d9bf0;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .btn-primary:hover {
      background-color: #1a8cd8;
    }
    .btn-primary.dark {
      background-color: #1d9bf0;
    }
    .btn-primary.dark:hover {
      background-color: #1a8cd8;
    }
    @media (max-width: 600px) {
      .profile-pic {
        width: 100px;
        height: 100px;
        bottom: -50px;
      }
      .user-info {
        padding-top: 60px;
      }
      .stats {
        flex-direction: column;
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="profile-header">
      <img src="https://via.placeholder.com/600x200" alt="Cover Image" class="cover-image" id="cover-image" />
    </div>
    <img src="https://via.placeholder.com/120" alt="Profile Picture" class="profile-pic" id="profile-pic" />
    <div class="user-info">
      <h1 id="user-name">Loading...</h1>
      <p id="user-email">Loading...</p>
      <div class="stats" id="stats"></div>
      <button id="edit-profile-btn" class="btn-primary mt-2">Edit Profile</button>
    </div>
    <div class="bio" id="bio">
      <p>No bio yet.</p>
    </div>
    <div class="media-grid" id="media-grid"></div>
    <div class="edit-section" id="edit-section">
      <input type="text" id="edit-name" class="input-field dark:input-field" placeholder="Display Name" />
      <input type="email" id="edit-email" class="input-field dark:input-field" placeholder="Email" />
      <input type="file" id="profile-pic-file" class="input-field dark:input-field" accept="image/jpeg,image/png" />
      <input type="file" id="cover-pic-file" class="input-field dark:input-field" accept="image/jpeg,image/png" />
      <textarea id="edit-bio" class="input-field dark:input-field h-24" placeholder="Bio (160 characters max)"></textarea>
      <button id="save-profile-btn" class="btn-primary mt-2">Save Changes</button>
      <p id="upload-result" class="upload-result dark:upload-result" role="alert" aria-live="polite"></p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, updateEmail, updateProfile } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDatabase, ref, get, set, child } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const userName = document.getElementById('user-name');
    const userEmail = document.getElementById('user-email');
    const profilePic = document.getElementById('profile-pic');
    const coverImage = document.getElementById('cover-image');
    const stats = document.getElementById('stats');
    const bio = document.getElementById('bio');
    const mediaGrid = document.getElementById('media-grid');
    const editProfileBtn = document.getElementById('edit-profile-btn');
    const editSection = document.getElementById('edit-section');
    const editName = document.getElementById('edit-name');
    const editEmail = document.getElementById('edit-email');
    const profilePicFile = document.getElementById('profile-pic-file');
    const coverPicFile = document.getElementById('cover-pic-file');
    const editBio = document.getElementById('edit-bio');
    const saveProfileBtn = document.getElementById('save-profile-btn');
    const uploadResult = document.getElementById('upload-result');

    let currentUserId = null;
    let isCurrentUser = false;
    const urlParams = new URLSearchParams(window.location.search);
    const profileUserId = urlParams.get('uid');
    const isOwner = urlParams.get('owner') === 'true';

    function showLoading() {
      uploadResult.textContent = 'Saving...';
    }
    function hideLoading() {
      uploadResult.textContent = '';
    }

    function applyTheme(themeValue) {
      const isDark = themeValue === 'dark';
      document.body.classList.toggle('dark', isDark);
      document.querySelectorAll('.input-field').forEach(input => input.classList.toggle('dark', isDark));
      document.querySelector('.upload-result').classList.toggle('dark', isDark);
      document.querySelector('.profile-header').classList.toggle('dark', isDark);
      document.querySelector('.profile-pic').classList.toggle('dark', isDark);
      document.querySelector('.user-info').classList.toggle('dark', isDark);
      document.querySelector('.stats').classList.toggle('dark', isDark);
      document.querySelector('.bio').classList.toggle('dark', isDark);
      document.querySelectorAll('.media-card').forEach(card => card.classList.toggle('dark', isDark));
      document.querySelector('.btn-primary').classList.toggle('dark', isDark);
    }

    async function uploadToCloudinary(file) {
      const cloudName = "dqkujefxj";
      const uploadPreset = "banter_box";
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", uploadPreset);

      try {
        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`, {
          method: "POST",
          body: formData
        });
        const data = await response.json();
        if (data.secure_url) {
          return data.secure_url;
        } else {
          throw new Error("Upload failed: " + (data.error?.message || "Unknown error"));
        }
      } catch (error) {
        console.error('Error uploading to Cloudinary:', error);
        throw error;
      }
    }

    function updateUserStats(userId) {
      const userRef = ref(db, `users/${userId}`);
      get(userRef).then((snapshot) => {
        const userData = snapshot.val() || {};
        userName.textContent = userData.displayName || 'Anonymous';
        userEmail.textContent = userData.email || 'No email';
        profilePic.src = userData.photoURL || 'https://via.placeholder.com/120';
        coverImage.src = userData.coverURL || 'https://via.placeholder.com/600x200';
        bio.innerHTML = userData.bio ? `<p>${userData.bio}</p>` : '<p>No bio yet.</p>';
        if (isCurrentUser) {
          editName.value = userData.displayName || '';
          editEmail.value = userData.email || '';
          editBio.value = userData.bio || '';
        }
      }).catch((error) => {
        console.error('Error fetching user data:', error);
        userName.textContent = 'Error';
        userEmail.textContent = 'N/A';
        bio.innerHTML = '<p>Error loading bio.</p>';
      });

      const mediaRef = ref(db, 'media');
      get(mediaRef).then((snapshot) => {
        const mediaData = snapshot.val() || {};
        const userMedia = Object.values(mediaData).filter(media => media.postedBy === userId);
        const totalPosts = userMedia.length;
        const totalImpressions = userMedia.reduce((sum, media) => sum + (media.impressions || 0), 0);
        const followersRef = ref(db, `users/${userId}/followers`);
        const followersSnap = get(followersRef);
        const followingRef = ref(db, `users/${userId}/friends`);
        const followingSnap = get(followingRef);

        stats.innerHTML = `
          <div class="stat"><strong>${totalPosts}</strong> Posts</div>
          <div class="stat"><strong>${followersSnap.val() ? Object.keys(followersSnap.val()).length : 0}</strong> Followers</div>
          <div class="stat"><strong>${followingSnap.val() ? Object.keys(followingSnap.val()).length : 0}</strong> Following</div>
        `;
      }).catch((error) => {
        console.error('Error fetching stats:', error);
        stats.innerHTML = '<div class="stat"><strong>0</strong> Posts</div><div class="stat"><strong>0</strong> Followers</div><div class="stat"><strong>0</strong> Following</div>';
      });
    }

    function updateMediaGrid(userId) {
      const mediaRef = ref(db, 'media');
      get(mediaRef).then((snapshot) => {
        const mediaData = snapshot.val() || {};
        const userMedia = Object.values(mediaData).filter(media => media.postedBy === userId)
          .sort((a, b) => b.timestamp - a.timestamp);

        mediaGrid.innerHTML = '';
        if (userMedia.length === 0) {
          mediaGrid.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">No media uploaded.</p>';
          return;
        }

        userMedia.forEach(({ mediaId, url, thumbnailUrl, resourceType }) => {
          const mediaCard = document.createElement('div');
          mediaCard.className = 'media-card dark:media-card';
          mediaCard.dataset.mediaId = mediaId;
          mediaCard.onclick = () => window.location.href = `media.html?mediaId=${mediaId}`;
          mediaCard.innerHTML = `<img src="${thumbnailUrl || url || 'https://via.placeholder.com/120'}" alt="Media" />`;
          mediaGrid.appendChild(mediaCard);
        });
      }).catch((error) => {
        console.error('Error loading media grid:', error);
        mediaGrid.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Error loading media.</p>';
      });
    }

    onAuthStateChanged(auth, (user) => {
      if (!user && !profileUserId) {
        window.location.href = 'signup.html';
        return;
      }
      currentUserId = user ? user.uid : null;
      isCurrentUser = currentUserId === profileUserId && isOwner;

      const userIdToLoad = profileUserId || currentUserId;
      updateUserStats(userIdToLoad);
      updateMediaGrid(userIdToLoad);

      const settingsRef = ref(db, `users/${currentUserId}/settings`);
      get(settingsRef).then((snapshot) => {
        const settings = snapshot.val() || {};
        applyTheme(settings.theme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
      }).catch((error) => {
        console.error('Error fetching settings:', error);
        applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      });

      if (isCurrentUser) {
        editProfileBtn.style.display = 'block';
        editProfileBtn.addEventListener('click', () => {
          editSection.classList.toggle('active');
        });

        saveProfileBtn.addEventListener('click', async () => {
          const newName = editName.value.trim();
          const newEmail = editEmail.value.trim();
          const bioText = editBio.value.trim().slice(0, 160);
          const profileFile = profilePicFile.files[0];
          const coverFile = coverPicFile.files[0];
          const user = auth.currentUser;

          if (!newName && !newEmail && !bioText && !profileFile && !coverFile) {
            uploadResult.classList.add('error');
            uploadResult.textContent = 'Please make at least one change.';
            return;
          }

          showLoading();
          try {
            let photoURL = profilePic.src;
            let coverURL = coverImage.src;

            if (profileFile) {
              if (!['image/jpeg', 'image/png'].includes(profileFile.type)) throw new Error('Invalid profile image type.');
              if (profileFile.size > 5 * 1024 * 1024) throw new Error('Profile image exceeds 5MB.');
              photoURL = await uploadToCloudinary(profileFile);
            }
            if (coverFile) {
              if (!['image/jpeg', 'image/png'].includes(coverFile.type)) throw new Error('Invalid cover image type.');
              if (coverFile.size > 5 * 1024 * 1024) throw new Error('Cover image exceeds 5MB.');
              coverURL = await uploadToCloudinary(coverFile);
            }

            const updates = {};
            if (newName) updates.displayName = newName;
            if (newEmail) updates.email = newEmail;
            if (bioText) updates.bio = bioText;
            if (photoURL !== profilePic.src) updates.photoURL = photoURL;
            if (coverURL !== coverImage.src) updates.coverURL = coverURL;

            await set(ref(db, `users/${currentUserId}`), updates, { merge: true });

            if (newName || photoURL !== profilePic.src) {
              await updateProfile(user, {
                displayName: newName || user.displayName,
                photoURL: photoURL
              });
            }
            if (newEmail) {
              await updateEmail(user, newEmail);
            }

            profilePic.src = photoURL;
            coverImage.src = coverURL;
            userName.textContent = newName || userName.textContent;
            userEmail.textContent = newEmail || userEmail.textContent;
            bio.innerHTML = bioText ? `<p>${bioText}</p>` : '<p>No bio yet.</p>';
            editSection.classList.remove('active');
            uploadResult.textContent = 'Profile updated successfully!';
          } catch (error) {
            uploadResult.classList.add('error');
            uploadResult.textContent = `Error: ${error.message || 'Unknown error'}`;
          } finally {
            hideLoading();
          }
        });
      } else {
        editProfileBtn.style.display = 'none';
      }
    });
  </script>
</body>
</html>
