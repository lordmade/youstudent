<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Nexus - Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>

  <style>
    :root {
      --primary-color: #6366F1;
      --border: #EFF3F4;
      --hover-bg: #F7F9F9;
      --text-dark: #0F1419;
      --text-light: #536471;
      --like-red: #F91880;
      --danger: #e0245e;
      --success: #10b981;
    }

    body {
      background: white;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: var(--text-dark);
      overflow-y: scroll;
    }

    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }

    .post-text, .comment-content, .tweet-textarea {
      -webkit-user-select: text;
      user-select: text;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: 80px 1fr;
      max-width: 1265px;
      margin: 0 auto;
      min-height: 100vh;
    }
    @media (min-width: 640px) { .layout-grid { grid-template-columns: 275px 1fr; } }
    @media (min-width: 1024px) { .layout-grid { grid-template-columns: 275px 600px 1fr; } }

    .sidebar {
      position: sticky;
      top: 0;
      height: 100vh;
      padding: 0.5rem 1rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border-right: 1px solid var(--border);
    }

    .logo-box { padding: 10px; margin-bottom: 10px; }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      padding: 0.9rem;
      border-radius: 9999px;
      cursor: pointer;
      font-size: 1.25rem;
      color: var(--text-dark);
      width: fit-content;
      transition: 0.2s;
    }
    .nav-item:hover { background-color: var(--hover-bg); color: var(--primary-color); }
    .nav-text { display: none; }
    @media (min-width: 640px) { .nav-text { display: block; } }

    .feed-header {
      position: sticky;
      top: 0;
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(12px);
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      font-weight: 800;
      font-size: 1.25rem;
      z-index: 10;
    }

    .main-feed { border-right: 1px solid var(--border); max-width: 600px; width: 100%; }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #e1e8ed;
      object-fit: cover;
      flex-shrink: 0;
      border: 1px solid var(--border);
    }

    .post {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 1rem;
      transition: 0.2s;
    }
    .post:hover { background-color: #fafafa; }

    .post-content { width: 100%; }
    .post-header { display: flex; justify-content: space-between; align-items: flex-start; position: relative; }
    .post-meta { flex: 1; }
    .post-name { font-weight: 700; }
    .post-username, .post-timestamp { color: var(--text-light); }
    .post-timestamp { font-size: 0.85rem; margin-top: 2px; }
    .post-text { margin-top: 0.25rem; font-size: 1rem; white-space: pre-wrap; line-height: 1.5; }
    .post-image { margin-top: 0.75rem; border-radius: 12px; border: 1px solid var(--border); max-width: 100%; }

    .post-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 0.75rem;
      max-width: 80%;
      color: var(--text-light);
    }
    .action-item {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      transition: 0.2s;
      font-size: 0.85rem;
    }
    .action-item:hover { color: var(--primary-color); }
    .action-item.liked { color: var(--like-red); }
    .action-item.liked svg { fill: var(--like-red); }

    .kebab-menu {
      padding: 8px;
      border-radius: 50%;
      cursor: pointer;
      color: var(--text-light);
    }
    .kebab-menu:hover { background: var(--hover-bg); }

    .kebab-dropdown {
      position: absolute;
      top: 40px;
      right: 4px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      min-width: 160px;
      z-index: 30;
      display: none;
    }
    .kebab-dropdown.show { display: block; }
    .kebab-item {
      padding: 12px 16px;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .kebab-item:hover { background: var(--hover-bg); }
    .kebab-item.delete-post { color: var(--danger); }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid var(--border);
      z-index: 50;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .bottom-nav-inner {
      display: flex;
      justify-content: space-around;
      height: 56px;
      max-width: 500px;
      margin: 0 auto;
    }
    .nav-bottom-item {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 56px;
      height: 56px;
      color: var(--text-dark);
      position: relative;
    }
    .nav-bottom-item.active { color: var(--primary-color); }
    .nav-bottom-item.active::after {
      content: '';
      position: absolute;
      bottom: 6px;
      width: 24px;
      height: 3px;
      background: var(--primary-color);
      border-radius: 9999px;
    }

    #loading-overlay {
      position: fixed; inset: 0;
      background: rgba(255,255,255,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #toast {
      position: fixed;
      bottom: calc(80px + env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 12px 24px;
      border-radius: 9999px;
      z-index: 200;
      opacity: 0;
      transition: opacity 0.4s;
      pointer-events: none;
    }
    #toast.show { opacity: 1; }
    #toast.success { background: var(--success); }
    #toast.error { background: var(--danger); }

    .search-highlight {
      background-color: rgba(99, 102, 241, 0.2);
      border-radius: 2px;
      padding: 0 2px;
    }

    .profile-header { position: relative; height: 300px; }
    .profile-banner { height: 200px; background: linear-gradient(135deg, #6366F1, #4f46e5); }
    .profile-avatar-container {
      position: absolute;
      bottom: -48px;
      left: 16px;
      width: 120px;
      height: 120px;
      border: 4px solid white;
      border-radius: 9999px;
      overflow: hidden;
      background: white;
      cursor: pointer;
    }
    .profile-avatar { width: 100%; height: 100%; object-fit: cover; }

    .profile-edit-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(15,20,25,0.6);
      color: white;
      border: none;
      border-radius: 9999px;
      padding: 8px 16px;
      font-weight: 700;
      backdrop-filter: blur(8px);
      cursor: pointer;
    }

    .profile-info { padding: 60px 16px 16px; }
    .profile-name { font-size: 1.5rem; font-weight: 800; }
    .profile-username { color: var(--text-light); font-size: 1rem; }
    .profile-bio { margin: 12px 0; line-height: 1.4; white-space: pre-wrap; }
    .profile-joined { color: var(--text-light); font-size: 0.95rem; margin: 8px 0; }

    .profile-stats { display: flex; gap: 1.5rem; margin-top: 12px; font-size: 0.95rem; }
    .stat-number { font-weight: 700; }
    .stat-label { color: var(--text-light); }

    .profile-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-top: 16px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 14px 0;
      font-weight: 700;
      color: var(--text-light);
      cursor: pointer;
    }
    .tab.active {
      color: var(--primary-color);
      position: relative;
    }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-color);
      border-radius: 9999px;
    }

    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal-overlay.show { display: flex; }
    .modal-content {
      background: white;
      border-radius: 16px;
      width: 100%; max-width: 480px;
      max-height: 90vh; overflow-y: auto;
    }
    .modal-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 800;
    }
    .modal-body { padding: 20px; }
    .form-group { margin-bottom: 20px; }
    .form-label { font-weight: 600; margin-bottom: 6px; display: block; }
    .form-input, .form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
    }
    .form-textarea { min-height: 96px; resize: vertical; }
    .char-counter {
      font-size: 0.85rem;
      color: var(--text-light);
      text-align: right;
      margin-top: 4px;
    }
    .char-counter.warn { color: #d97706; }
    .char-counter.danger { color: var(--danger); }

    .save-profile-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 9999px;
      font-weight: 700;
      width: 100%;
      margin-top: 16px;
      cursor: pointer;
    }
    .save-profile-btn:disabled { opacity: 0.6; cursor: not-allowed; }
  </style>
</head>
<body>

  <div id="loading-overlay">
    <div class="spinner"></div>
  </div>

  <div id="toast"></div>

  <div class="layout-grid">
    <aside class="sidebar">
      <div>
        <div class="logo-box">
          <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="40" height="40" rx="12" fill="#6366F1"/>
            <path d="M12 20L18 26L28 14" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="28" cy="26" r="4" fill="white"/>
          </svg>
        </div>
        <div class="nav-item">
          <i data-feather="home"></i> <span class="nav-text">Home</span>
        </div>
        <div class="nav-item">
          <i data-feather="hash"></i> <span class="nav-text">Explore</span>
        </div>
        <div class="nav-item">
          <i data-feather="bell"></i> <span class="nav-text">Notifications</span>
        </div>
        <div class="nav-item active">
          <i data-feather="user"></i> <span class="nav-text">Profile</span>
        </div>
      </div>
      <div class="nav-item" id="logout-btn">
        <i data-feather="log-out"></i> <span class="nav-text">Logout</span>
      </div>
    </aside>

    <main class="main-feed">
      <div class="feed-header">
        <span class="feed-header-title">Profile</span>
      </div>

      <div class="profile-header">
        <div class="profile-banner"></div>
        <div class="profile-avatar-container" id="avatar-trigger">
          <img id="profile-avatar" class="profile-avatar" src="https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png" alt="Profile picture">
        </div>
        <button id="edit-profile-btn" class="profile-edit-btn">Edit profile</button>
      </div>

      <div class="profile-info">
        <div class="profile-name" id="profile-name">Loading...</div>
        <div class="profile-username" id="profile-username">@loading</div>
        <div class="profile-bio" id="profile-bio"></div>
        <div class="profile-joined" id="profile-joined">Joined ...</div>

        <div class="profile-stats">
          <div><span class="stat-number" id="following-count">0</span> <span class="stat-label">Following</span></div>
          <div><span class="stat-number" id="followers-count">0</span> <span class="stat-label">Followers</span></div>
        </div>
      </div>

      <div class="profile-tabs">
        <div class="tab active">Posts</div>
        <div class="tab">Replies</div>
        <div class="tab">Media</div>
        <div class="tab">Likes</div>
      </div>

      <div id="profile-feed"></div>
    </main>

    <aside class="right-sidebar"></aside>
  </div>

  <nav class="bottom-nav md:hidden">
    <div class="bottom-nav-inner">
      <a href="index.html" class="nav-bottom-item">
        <i data-feather="home" class="w-7 h-7"></i>
      </a>
      <a href="#" class="nav-bottom-item">
        <i data-feather="hash" class="w-7 h-7"></i>
      </a>
      <a href="#" class="nav-bottom-item">
        <i data-feather="bell" class="w-7 h-7"></i>
      </a>
      <a href="profile.html" class="nav-bottom-item active">
        <i data-feather="user" class="w-7 h-7"></i>
      </a>
    </div>
  </nav>

  <!-- Edit Profile Modal -->
  <div id="edit-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <span>Edit profile</span>
        <button id="close-modal"><i data-feather="x"></i></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Profile picture</label>
          <img id="preview-avatar" style="width:96px;height:96px;border-radius:9999px;object-fit:cover;" src="" alt="">
          <input type="file" id="avatar-upload" accept="image/*" style="display:none;">
          <button id="upload-avatar-btn" style="color:var(--primary-color);font-weight:600;margin-top:8px;">Change picture</button>
        </div>

        <div class="form-group">
          <label class="form-label">Name</label>
          <input type="text" id="edit-name" class="form-input" maxlength="50">
          <div id="name-counter" class="char-counter">50</div>
        </div>

        <div class="form-group">
          <label class="form-label">Username</label>
          <input type="text" id="edit-username" class="form-input" maxlength="30">
          <div id="username-counter" class="char-counter">30</div>
        </div>

        <div class="form-group">
          <label class="form-label">Bio</label>
          <textarea id="edit-bio" class="form-textarea" maxlength="160"></textarea>
          <div id="bio-counter" class="char-counter">160</div>
        </div>

        <button id="save-profile-btn" class="save-profile-btn" disabled>Save</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
    import { getDatabase, ref, get, set, onValue, query, orderByChild, equalTo, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const CLOUD_NAME = "dqkujefxj";
    const UPLOAD_PRESET = "banter_box";
    const DEFAULT_AVATAR = "https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let currentProfile = null;
    let selectedAvatarFile = null;

    const avatarCache = new Map();

    async function getUserAvatar(uid) {
      if (avatarCache.has(uid)) return avatarCache.get(uid);

      try {
        const snapshot = await get(ref(db, `users/${uid}`));
        if (snapshot.exists()) {
          const userData = snapshot.val();
          const url = userData.photoURL || DEFAULT_AVATAR;
          avatarCache.set(uid, url);
          return url;
        }
      } catch (err) {
        console.error("Error fetching avatar:", err);
      }
      return DEFAULT_AVATAR;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function highlightText(text, query) {
      if (!query || !text) return text;
      const lowerQuery = query.toLowerCase().trim();
      if (!lowerQuery) return text;
      const regex = new RegExp(`(${escapeRegex(lowerQuery)})`, 'gi');
      return text.replace(regex, '<span class="search-highlight">$1</span>');
    }

    function parseText(text, searchQuery = '') {
      if (!text) return '';
      let parsed = escapeHtml(text);

      if (searchQuery) {
        const lower = searchQuery.toLowerCase().trim();
        if (lower) {
          parsed = parsed.replace(new RegExp(`(${escapeRegex(lower)})`, 'gi'), '<span class="search-highlight">$1</span>');
        }
      }

      parsed = parsed.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer" class="link">$1</a>');
      parsed = parsed.replace(/(#\w+)/g, '<span class="hashtag" data-hashtag="$1">$1</span>');
      parsed = parsed.replace(/(@\w+)/g, '<span class="mention" style="color:var(--primary-color);font-weight:500;">$1</span>');

      return parsed;
    }

    function getTimeAgo(timestamp) {
      if (!timestamp) return '';
      const diff = Math.floor((Date.now() - timestamp) / 1000);
      if (diff < 60) return 'now';
      if (diff < 3600) return Math.floor(diff / 60) + 'm';
      if (diff < 86400) return Math.floor(diff / 3600) + 'h';
      if (diff < 604800) return Math.floor(diff / 86400) + 'd';
      return new Date(timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    async function renderPost(key, post, searchQuery = '') {
      const el = document.createElement('div');
      el.className = 'post';
      el.id = `post-${key}`;

      const avatarUrl = await getUserAvatar(post.uid);
      const imgHtml = post.imageUrl ? `<img src="${post.imageUrl}" class="post-image" loading="lazy" />` : '';
      const timeAgo = getTimeAgo(post.timestamp);
      const isOwner = currentUser && currentUser.uid === post.uid;
      const parsedText = parseText(post.text, searchQuery);
      const highlightedUsername = highlightText(post.username, searchQuery);

      el.innerHTML = `
        <img src="\( {avatarUrl}" class="user-avatar" onerror="this.src=' \){DEFAULT_AVATAR}'">
        <div class="post-content">
          <div class="post-header">
            <div class="post-meta">
              <div>
                <span class="post-name">${highlightedUsername}</span>
                <span class="post-username">@${post.username.toLowerCase().replace(/\s/g,'')}</span>
              </div>
              <div class="post-timestamp">${timeAgo}</div>
            </div>
            <div class="kebab-menu">
              <i data-feather="more-horizontal" style="width:20px;height:20px;"></i>
            </div>
          </div>
          <div class="post-text">${parsedText}</div>
          ${imgHtml}
          <div class="post-actions">
            <div class="action-item comment-trigger" data-id="${key}">
              <i data-feather="message-circle" style="width:18px"></i>
              <span id="comment-count-\( {key}"> \){post.commentCount || 0}</span>
            </div>
            <div class="action-item like-trigger" id="like-btn-\( {key}" data-id=" \){key}">
              <i data-feather="heart" style="width:18px"></i>
              <span id="like-count-\( {key}"> \){post.likes || 0}</span>
            </div>
            <div class="action-item">
              <i data-feather="share" style="width:18px"></i>
            </div>
          </div>
        </div>
        <div class="kebab-dropdown">
          <div class="kebab-item kebab-action" data-action="copy">Copy link</div>
          <div class="kebab-item kebab-action" data-action="share">Share via...</div>
          ${isOwner ? `<div class="kebab-item delete-post">Delete</div>` : ''}
          <div class="kebab-item kebab-action" data-action="report">Report post</div>
        </div>
      `;

      // Like handling
      const likeBtn = el.querySelector(`#like-btn-${key}`);
      likeBtn?.addEventListener('click', () => toggleLike(key));
      checkIfLiked(key, likeBtn);

      feather.replace();
      return el;
    }

    async function toggleLike(postId) {
      if (!currentUser) return;

      const likeRef = ref(db, `postLikes/\( {postId}/ \){currentUser.uid}`);
      const postRef = ref(db, `posts/${postId}`);

      try {
        const snapshot = await get(likeRef);
        if (snapshot.exists()) {
          await set(likeRef, null);
          await runTransaction(postRef, (post) => {
            if (post) post.likes = Math.max((post.likes || 0) - 1, 0);
            return post;
          });
          document.getElementById(`like-btn-${postId}`)?.classList.remove('liked');
        } else {
          await set(likeRef, true);
          await runTransaction(postRef, (post) => {
            if (post) post.likes = (post.likes || 0) + 1;
            return post;
          });
          document.getElementById(`like-btn-${postId}`)?.classList.add('liked');
        }
      } catch (err) {
        console.error("Like operation failed:", err);
      }
    }

    async function checkIfLiked(postId, element = null) {
      if (!currentUser) return;
      try {
        const snapshot = await get(ref(db, `postLikes/\( {postId}/ \){currentUser.uid}`));
        if (snapshot.exists()) {
          const target = element || document;
          target.querySelector(`#like-btn-${postId}`)?.classList.add('liked');
        }
      } catch (err) {
        console.error("Check like failed:", err);
      }
    }

    function showToast(message, type = 'success') {
      const toastEl = document.getElementById('toast');
      toastEl.textContent = message;
      toastEl.className = `show ${type}`;
      setTimeout(() => toastEl.classList.remove('show'), 2800);
    }

    // ────────────────────────────────────────────────
    //   Profile logic
    // ────────────────────────────────────────────────

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "signup.html";
        return;
      }

      currentUser = user;

      const userRef = ref(db, `users/${user.uid}`);
      const snap = await get(userRef);

      if (snap.exists()) {
        currentProfile = snap.val();
      } else {
        currentProfile = {
          username: user.email?.split('@')[0] || `user_${user.uid.slice(0,6)}`,
          displayName: "New User",
          bio: "",
          photoURL: DEFAULT_AVATAR,
          createdAt: Date.now()
        };
        await set(userRef, currentProfile);
      }

      // Fill profile view
      document.getElementById('profile-name').textContent = currentProfile.displayName || currentProfile.username;
      document.getElementById('profile-username').textContent = `@${currentProfile.username}`;
      document.getElementById('profile-bio').textContent = currentProfile.bio || "No bio yet.";
      document.getElementById('profile-joined').textContent = `Joined ${new Date(currentProfile.createdAt).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
      document.getElementById('profile-avatar').src = currentProfile.photoURL || DEFAULT_AVATAR;

      // Fill edit form
      document.getElementById('edit-name').value = currentProfile.displayName || "";
      document.getElementById('edit-username').value = currentProfile.username || "";
      document.getElementById('edit-bio').value = currentProfile.bio || "";
      document.getElementById('preview-avatar').src = currentProfile.photoURL || DEFAULT_AVATAR;

      updateCharCounters();
      updateSaveButton();

      // Load posts
      loadUserPosts(user.uid);
    });

    // ────────────────────────────────────────────────
    //   Edit modal logic
    // ────────────────────────────────────────────────

    document.getElementById('edit-profile-btn').addEventListener('click', () => {
      document.getElementById('edit-modal').classList.add('show');
    });

    document.getElementById('close-modal').addEventListener('click', () => {
      document.getElementById('edit-modal').classList.remove('show');
    });

    document.getElementById('avatar-trigger').addEventListener('click', () => {
      document.getElementById('avatar-upload').click();
    });

    document.getElementById('upload-avatar-btn').addEventListener('click', () => {
      document.getElementById('avatar-upload').click();
    });

    document.getElementById('avatar-upload').addEventListener('change', (e) => {
      if (e.target.files?.[0]) {
        selectedAvatarFile = e.target.files[0];
        document.getElementById('preview-avatar').src = URL.createObjectURL(selectedAvatarFile);
        updateSaveButton();
      }
    });

    function updateCharCounters() {
      const counters = [
        { el: document.getElementById('name-counter'), val: document.getElementById('edit-name').value.length, max: 50 },
        { el: document.getElementById('username-counter'), val: document.getElementById('edit-username').value.length, max: 30 },
        { el: document.getElementById('bio-counter'), val: document.getElementById('edit-bio').value.length, max: 160 }
      ];

      counters.forEach(c => {
        const remaining = c.max - c.val;
        c.el.textContent = remaining;
        c.el.className = 'char-counter' +
          (remaining <= 10 ? ' warn' : '') +
          (remaining <= 3 ? ' danger' : '');
      });
    }

    function updateSaveButton() {
      const name = document.getElementById('edit-name').value.trim();
      const username = document.getElementById('edit-username').value.trim();
      const bio = document.getElementById('edit-bio').value.trim();

      const hasChange =
        name !== (currentProfile?.displayName || "") ||
        username !== (currentProfile?.username || "") ||
        bio !== (currentProfile?.bio || "") ||
        !!selectedAvatarFile;

      document.getElementById('save-profile-btn').disabled = !hasChange;
    }

    ['edit-name', 'edit-username', 'edit-bio'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => {
        updateCharCounters();
        updateSaveButton();
      });
    });

    document.getElementById('save-profile-btn').addEventListener('click', async () => {
      const btn = document.getElementById('save-profile-btn');
      if (btn.disabled) return;

      btn.disabled = true;
      btn.textContent = "Saving...";

      try {
        let photoURL = currentProfile?.photoURL || DEFAULT_AVATAR;

        if (selectedAvatarFile) {
          const formData = new FormData();
          formData.append("file", selectedAvatarFile);
          formData.append("upload_preset", UPLOAD_PRESET);

          const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
            method: "POST",
            body: formData
          });
          const data = await res.json();
          if (data.secure_url) photoURL = data.secure_url;
        }

        const updates = {
          displayName: document.getElementById('edit-name').value.trim() || currentUser.email?.split('@')[0] || "User",
          username: document.getElementById('edit-username').value.trim().toLowerCase().replace(/[^a-z0-9_]/g, ''),
          bio: document.getElementById('edit-bio').value.trim(),
          photoURL,
          updatedAt: Date.now()
        };

        await set(ref(db, `users/${currentUser.uid}`), { ...currentProfile, ...updates });
        currentProfile = { ...currentProfile, ...updates };

        document.getElementById('profile-name').textContent = updates.displayName;
        document.getElementById('profile-username').textContent = `@${updates.username}`;
        document.getElementById('profile-bio').textContent = updates.bio || "No bio yet.";
        document.getElementById('profile-avatar').src = photoURL;
        document.getElementById('preview-avatar').src = photoURL;

        document.getElementById('edit-modal').classList.remove('show');
        showToast("Profile updated!", "success");
      } catch (err) {
        console.error(err);
        showToast("Failed to update profile", "error");
      } finally {
        btn.textContent = "Save";
        btn.disabled = false;
      }
    });

    async function loadUserPosts(uid) {
      const container = document.getElementById('profile-feed');
      container.innerHTML = '<div style="padding:3rem 1rem;text-align:center;color:#536471;">Loading your posts...</div>';

      const postsQuery = query(ref(db, 'posts'), orderByChild('uid'), equalTo(uid));

      onValue(postsQuery, async (snapshot) => {
        container.innerHTML = '';

        if (!snapshot.exists()) {
          container.innerHTML = '<div style="padding:4rem 1rem;text-align:center;color:#536471;">No posts yet.</div>';
          return;
        }

        const posts = [];
        snapshot.forEach(child => {
          posts.push({ key: child.key, data: child.val() });
        });

        posts.sort((a, b) => b.data.timestamp - a.data.timestamp);

        for (const post of posts) {
          const postElement = await renderPost(post.key, post.data, '');
          container.appendChild(postElement);
        }
      });
    }

    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

    feather.replace();
  </script>
</body>
</html>
