<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BanterBox - Profile</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Roboto', 'Segoe UI', sans-serif;
      background: linear-gradient(180deg, #f5f7fa 0%, #e0e7ff 100%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      color: #1e293b;
    }
    body.dark {
      background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
      color: #e2e8f0;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 0;
    }
    .profile-header {
      position: relative;
      height: 200px;
      background: linear-gradient(180deg, #ef4444 0%, #f97316 100%);
    }
    .profile-header.dark {
      background: linear-gradient(180deg, #dc2626 0%, #f97316 100%);
    }
    .cover-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }
    .cover-image:hover {
      opacity: 0.8;
    }
    .profile-pic {
      position: absolute;
      top: 140px;
      left: 20px;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid #fff;
      object-fit: cover;
      cursor: pointer;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }
    .profile-pic:hover {
      transform: scale(1.1);
      opacity: 0.8;
    }
    .profile-pic.dark {
      border-color: #1e293b;
    }
    .user-info {
      padding: 80px 20px 20px;
    }
    .user-info h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .user-info p {
      font-size: 0.9rem;
      color: #64748b;
      margin: 0.5rem 0;
    }
    .user-info.dark h1 {
      color: #e2e8f0;
    }
    .user-info.dark p {
      color: #94a3b8;
    }
    .stats {
      display: flex;
      gap: 1.5rem;
      margin-top: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e0e0e0;
    }
    .stats.dark {
      border-bottom-color: #2d3748;
    }
    .stat {
      font-size: 0.9rem;
    }
    .stat strong {
      font-weight: 700;
      color: #1e293b;
    }
    .stat.dark strong {
      color: #e2e8f0;
    }
    .bio {
      padding: 1rem 20px;
      border-bottom: 1px solid #e0e0e0;
    }
    .bio.dark {
      border-bottom-color: #2d3748;
    }
    .bio p {
      margin: 0;
      font-size: 0.9rem;
      color: #64748b;
    }
    .bio.dark p {
      color: #94a3b8;
    }
    .edit-section {
      padding: 1rem 20px;
      display: none;
    }
    .edit-section.active {
      display: block;
    }
    .input-field {
      width: 100%;
      padding: 0.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 0.9rem;
      background: #fafafa;
      margin-bottom: 0.5rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .input-field.dark {
      background: #2d3748;
      border-color: #4b5563;
      color: #e2e8f0;
    }
    .input-field:focus {
      outline: none;
      border-color: #ef4444;
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.3);
    }
    .upload-result {
      font-size: 0.85rem;
      color: #2ecc71;
      margin-top: 0.5rem;
    }
    .upload-result.error {
      color: #e53e3e;
    }
    .upload-result.dark {
      color: #48bb78;
    }
    .upload-result.dark.error {
      color: #fc8181;
    }
    .media-grid {
      padding: 1rem 0;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 2px;
    }
    .media-card {
      aspect-ratio: 1 / 1;
      background: #fff;
      cursor: pointer;
      overflow: hidden;
    }
    .media-card:hover img {
      transform: scale(1.1);
    }
    .media-card.dark {
      background: #1e293b;
    }
    .media-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.2s ease;
    }
    .btn-primary {
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .btn-primary:hover {
      background: #dc2626;
    }
    .btn-primary.dark {
      background: #dc2626;
    }
    .btn-primary.dark:hover {
      background: #f97316;
    }
    .message-btn {
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-weight: 700;
      cursor: pointer;
      margin-left: 0.5rem;
      transition: background 0.2s ease;
    }
    .message-btn:hover {
      background: #dc2626;
    }
    .message-btn.dark {
      background: #dc2626;
    }
    .message-btn.dark:hover {
      background: #f97316;
    }
    .custom-alert {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .custom-alert.active {
      display: flex;
    }
    .alert-content {
      background: #fff;
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      max-width: 300px;
      width: 90%;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .alert-content.dark {
      background: #1e293b;
      color: #e2e8f0;
    }
    .alert-content h2 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    .alert-content p {
      margin-bottom: 1.5rem;
      color: #64748b;
    }
    .alert-content.dark p {
      color: #94a3b8;
    }
    .alert-btn {
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .alert-btn:hover {
      background: #dc2626;
    }
    .alert-btn.dark {
      background: #dc2626;
    }
    .alert-btn.dark:hover {
      background: #f97316;
    }
    @media (max-width: 600px) {
      .profile-pic {
        width: 100px;
        height: 100px;
        top: 120px;
      }
      .user-info {
        padding-top: 70px;
      }
      .stats {
        flex-direction: column;
        gap: 0.5rem;
      }
      .message-btn {
        margin-left: 0;
        margin-top: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="profile-header">
      <img src="https://via.placeholder.com/600x200" alt="Cover Image" class="cover-image" id="cover-image" />
    </div>
    <img src="https://via.placeholder.com/120" alt="Profile Picture" class="profile-pic" id="profile-pic" />
    <div class="user-info">
      <h1 id="user-name">Loading...<span id="verified-icon" style="display: none;"></span></h1>
      <p id="user-email">Loading...</p>
      <div class="stats" id="stats"></div>
      <button id="edit-profile-btn" class="btn-primary mt-2">Edit Profile</button>
      <button id="message-btn" class="message-btn mt-2" style="display: none;">Message</button>
    </div>
    <div class="bio" id="bio">
      <p>No bio yet.</p>
    </div>
    <div class="media-grid" id="media-grid"></div>
    <div class="edit-section" id="edit-section">
      <input type="text" id="edit-name" class="input-field dark:input-field" placeholder="Display Name" />
      <input type="email" id="edit-email" class="input-field dark:input-field" placeholder="Email" />
      <input type="file" id="profile-pic-file" class="input-field dark:input-field" accept="image/jpeg,image/png" style="display: none;" />
      <input type="file" id="cover-pic-file" class="input-field dark:input-field" accept="image/jpeg,image/png" style="display: none;" />
      <textarea id="edit-bio" class="input-field dark:input-field h-24" placeholder="Bio (160 characters max)"></textarea>
      <button id="save-profile-btn" class="btn-primary mt-2">Save Changes</button>
      <p id="upload-result" class="upload-result dark:upload-result" role="alert" aria-live="polite"></p>
    </div>
    <!-- Custom Alert Dialogue -->
    <div class="custom-alert" id="custom-alert">
      <div class="alert-content dark:alert-content">
        <h2>Profile Update</h2>
        <p id="alert-message"></p>
        <button class="alert-btn" id="alert-close">OK</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, updateEmail, updateProfile } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDatabase, ref, get, set, child } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const userName = document.getElementById('user-name');
    const userEmail = document.getElementById('user-email');
    const profilePic = document.getElementById('profile-pic');
    const coverImage = document.getElementById('cover-image');
    const stats = document.getElementById('stats');
    const bio = document.getElementById('bio');
    const mediaGrid = document.getElementById('media-grid');
    const editProfileBtn = document.getElementById('edit-profile-btn');
    const editSection = document.getElementById('edit-section');
    const editName = document.getElementById('edit-name');
    const editEmail = document.getElementById('edit-email');
    const profilePicFile = document.getElementById('profile-pic-file');
    const coverPicFile = document.getElementById('cover-pic-file');
    const editBio = document.getElementById('edit-bio');
    const saveProfileBtn = document.getElementById('save-profile-btn');
    const uploadResult = document.getElementById('upload-result');
    const messageBtn = document.getElementById('message-btn');
    const verifiedIcon = document.getElementById('verified-icon');
    const customAlert = document.getElementById('custom-alert');
    const alertMessage = document.getElementById('alert-message');
    const alertClose = document.getElementById('alert-close');

    let currentUserId = null;
    let isCurrentUser = false;
    const urlParams = new URLSearchParams(window.location.search);
    const profileUserId = urlParams.get('uid');
    const isOwner = urlParams.get('owner') === 'true';

    function showLoading() {
      uploadResult.textContent = 'Saving...';
    }
    function hideLoading() {
      uploadResult.textContent = '';
    }

    function showAlert(message) {
      alertMessage.textContent = message;
      customAlert.classList.add('active');
    }

    function hideAlert() {
      customAlert.classList.remove('active');
    }

    function applyTheme(themeValue) {
      const isDark = themeValue === 'dark';
      document.body.classList.toggle('dark', isDark);
      document.querySelectorAll('.input-field').forEach(input => input.classList.toggle('dark', isDark));
      document.querySelector('.upload-result').classList.toggle('dark', isDark);
      document.querySelector('.profile-header').classList.toggle('dark', isDark);
      document.querySelector('.profile-pic').classList.toggle('dark', isDark);
      document.querySelector('.user-info').classList.toggle('dark', isDark);
      document.querySelector('.stats').classList.toggle('dark', isDark);
      document.querySelector('.bio').classList.toggle('dark', isDark);
      document.querySelectorAll('.media-card').forEach(card => card.classList.toggle('dark', isDark));
      document.querySelector('.btn-primary').classList.toggle('dark', isDark);
      document.querySelector('.message-btn').classList.toggle('dark', isDark);
      document.querySelector('.alert-content').classList.toggle('dark', isDark);
    }

    async function uploadToCloudinary(file) {
      const cloudName = "dqkujefxj";
      const uploadPreset = "banter_box";
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", uploadPreset);

      try {
        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`, {
          method: "POST",
          body: formData
        });
        const data = await response.json();
        if (data.secure_url) {
          return data.secure_url;
        } else {
          throw new Error("Upload failed: " + (data.error?.message || "Unknown error"));
        }
      } catch (error) {
        console.error('Error uploading to Cloudinary:', error);
        throw error;
      }
    }

    function updateUserStats(userId) {
      const userRef = ref(db, `users/${userId}`);
      get(userRef).then((snapshot) => {
        const userData = snapshot.val() || {};
        userName.textContent = userData.displayName || 'Anonymous';
        userEmail.textContent = userData.email || 'No email';
        profilePic.src = userData.photoURL || 'https://via.placeholder.com/120';
        coverImage.src = userData.coverURL || 'https://via.placeholder.com/600x200';
        bio.innerHTML = userData.bio ? `<p>${userData.bio}</p>` : '<p>No bio yet.</p>';
        const settingsRef = ref(db, `users/${userId}/settings`);
        get(settingsRef).then((settingsSnapshot) => {
          const settings = settingsSnapshot.val() || {};
          verifiedIcon.style.display = settings.verified ? 'inline-block' : 'none';
          verifiedIcon.innerHTML = settings.verified ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#1DA1F2" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>` : '';
        }).catch((error) => {
          console.error('Error fetching settings:', error);
          verifiedIcon.style.display = 'none';
        });
        if (isCurrentUser) {
          editName.value = userData.displayName || '';
          editEmail.value = userData.email || '';
          editBio.value = userData.bio || '';
        }
      }).catch((error) => {
        console.error('Error fetching user data:', error);
        userName.textContent = 'Error';
        userEmail.textContent = 'N/A';
        bio.innerHTML = '<p>Error loading bio.</p>';
      });

      const mediaRef = ref(db, 'media');
      get(mediaRef).then((snapshot) => {
        const mediaData = snapshot.val() || {};
        const userMedia = Object.values(mediaData).filter(media => media.postedBy === userId);
        const totalPosts = userMedia.length;
        const totalImpressions = userMedia.reduce((sum, media) => sum + (media.impressions || 0), 0);
        const followersRef = ref(db, `users/${userId}/followers`);
        const followersSnap = get(followersRef);
        const followingRef = ref(db, `users/${userId}/friends`);
        const followingSnap = get(followingRef);

        stats.innerHTML = `
          <div class="stat"><strong>${totalPosts}</strong> Posts</div>
          <div class="stat"><strong>${followersSnap.val() ? Object.keys(followersSnap.val()).length : 0}</strong> Followers</div>
          <div class="stat"><strong>${followingSnap.val() ? Object.keys(followingSnap.val()).length : 0}</strong> Following</div>
        `;
      }).catch((error) => {
        console.error('Error fetching stats:', error);
        stats.innerHTML = '<div class="stat"><strong>0</strong> Posts</div><div class="stat"><strong>0</strong> Followers</div><div class="stat"><strong>0</strong> Following</div>';
      });
    }

    function updateMediaGrid(userId) {
      const mediaRef = ref(db, 'media');
      get(mediaRef).then((snapshot) => {
        const mediaData = snapshot.val() || {};
        const userMedia = Object.values(mediaData).filter(media => media.postedBy === userId)
          .sort((a, b) => b.timestamp - a.timestamp);

        mediaGrid.innerHTML = '';
        if (userMedia.length === 0) {
          mediaGrid.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">No media uploaded.</p>';
          return;
        }

        userMedia.forEach(({ mediaId, url, thumbnailUrl, resourceType }) => {
          const mediaCard = document.createElement('div');
          mediaCard.className = 'media-card dark:media-card';
          mediaCard.dataset.mediaId = mediaId;
          mediaCard.onclick = () => window.location.href = `media.html?mediaId=${mediaId}`;
          mediaCard.innerHTML = `<img src="${thumbnailUrl || url || 'https://via.placeholder.com/120'}" alt="Media" />`;
          mediaGrid.appendChild(mediaCard);
        });
      }).catch((error) => {
        console.error('Error loading media grid:', error);
        mediaGrid.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Error loading media.</p>';
      });
    }

    onAuthStateChanged(auth, (user) => {
      if (!user && !profileUserId) {
        window.location.href = 'signup.html';
        return;
      }
      currentUserId = user ? user.uid : null;
      isCurrentUser = currentUserId === profileUserId && isOwner;

      const userIdToLoad = profileUserId || currentUserId;
      updateUserStats(userIdToLoad);
      updateMediaGrid(userIdToLoad);

      const settingsRef = ref(db, `users/${currentUserId}/settings`);
      get(settingsRef).then((snapshot) => {
        const settings = snapshot.val() || {};
        applyTheme(settings.theme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
      }).catch((error) => {
        console.error('Error fetching settings:', error);
        applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      });

      if (isCurrentUser) {
        editProfileBtn.style.display = 'block';
        messageBtn.style.display = 'none'; // Hide message button for owner
        editProfileBtn.addEventListener('click', () => {
          editSection.classList.toggle('active');
        });

        // Trigger file input for profile picture
        profilePic.addEventListener('click', () => {
          if (isCurrentUser) {
            profilePicFile.click();
          }
        });

        // Trigger file input for cover photo
        coverImage.addEventListener('click', () => {
          if (isCurrentUser) {
            coverPicFile.click();
          }
        });

        saveProfileBtn.addEventListener('click', async () => {
          const newName = editName.value.trim();
          const newEmail = editEmail.value.trim();
          const bioText = editBio.value.trim().slice(0, 160);
          const profileFile = profilePicFile.files[0];
          const coverFile = coverPicFile.files[0];
          const user = auth.currentUser;

          if (!newName && !newEmail && !bioText && !profileFile && !coverFile) {
            showAlert('Please make at least one change.');
            return;
          }

          showLoading();
          try {
            let photoURL = profilePic.src;
            let coverURL = coverImage.src;

            if (profileFile) {
              if (!['image/jpeg', 'image/png'].includes(profileFile.type)) throw new Error('Invalid profile image type.');
              if (profileFile.size > 5 * 1024 * 1024) throw new Error('Profile image exceeds 5MB.');
              photoURL = await uploadToCloudinary(profileFile);
            }
            if (coverFile) {
              if (!['image/jpeg', 'image/png'].includes(coverFile.type)) throw new Error('Invalid cover image type.');
              if (coverFile.size > 5 * 1024 * 1024) throw new Error('Cover image exceeds 5MB.');
              coverURL = await uploadToCloudinary(coverFile);
            }

            const updates = {};
            if (newName) updates.displayName = newName;
            if (newEmail) updates.email = newEmail;
            if (bioText) updates.bio = bioText;
            if (photoURL !== profilePic.src) updates.photoURL = photoURL;
            if (coverURL !== coverImage.src) updates.coverURL = coverURL;

            await set(ref(db, `users/${currentUserId}`), updates, { merge: true });

            if (newName || photoURL !== profilePic.src) {
              await updateProfile(user, {
                displayName: newName || user.displayName,
                photoURL: photoURL
              });
            }
            if (newEmail) {
              await updateEmail(user, newEmail);
            }

            profilePic.src = photoURL;
            coverImage.src = coverURL;
            userName.textContent = newName || userName.textContent;
            userEmail.textContent = newEmail || userEmail.textContent;
            bio.innerHTML = bioText ? `<p>${bioText}</p>` : '<p>No bio yet.</p>';
            editSection.classList.remove('active');
            showAlert('Profile updated successfully!');
          } catch (error) {
            showAlert(`Error: ${error.message || 'Unknown error'}`);
          } finally {
            hideLoading();
          }
        });
      } else {
        editProfileBtn.style.display = 'none';
        messageBtn.style.display = 'block'; // Show message button for non-owners
        messageBtn.addEventListener('click', () => {
          if (profileUserId) {
            window.location.href = `chat.html?uid=${profileUserId}`;
          }
        });
      }

      alertClose.addEventListener('click', hideAlert);
    });
  </script>
</body>
</html>
