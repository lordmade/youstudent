<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chaxo - Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f9f9f9; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
    .container { max-width: 500px; margin: 0 auto; padding: 1rem; }
    .avatar { width: 120px; height: 120px; border-radius: 9999px; object-fit: cover; border: 4px solid #ef4444; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1;} }
  </style>
</head>
<body>
<div class="container fade-in">

  <header class="flex items-center justify-between py-4 border-b">
    <button onclick="location.href='friends.html'" class="text-red-500 font-bold">‚Üê Back</button>
    <h1 class="text-xl font-bold">Profile</h1>
  </header>

  <div class="text-center mt-6">
    <img id="avatar-img" src="https://www.gravatar.com/avatar?d=mp" alt="Avatar" class="avatar mx-auto mb-4"/>
    <label id="upload-label" class="hidden relative cursor-pointer">
      <input id="avatar-input" type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer"/>
      <div class="absolute inset-0 bg-black bg-opacity-25 flex items-center justify-center rounded-full text-white text-sm">Change</div>
    </label>
  </div>

  <form id="profile-form" class="mt-4 space-y-4">
    <div>
      <label class="block text-sm font-medium">Name</label>
      <input id="name-input" type="text" class="w-full border rounded p-2" readonly />
    </div>
    <div>
      <label class="block text-sm font-medium">Email</label>
      <input id="email-input" type="email" class="w-full border rounded p-2 bg-gray-100" readonly />
    </div>
    <div>
      <label class="block text-sm font-medium">Bio</label>
      <textarea id="bio-input" class="w-full border rounded p-2" rows="3" readonly placeholder="Something about you..."></textarea>
    </div>
    <div class="flex justify-center space-x-4">
      <button id="edit-btn" type="button" class="px-4 py-2 text-white bg-red-500 rounded">Edit</button>
      <button id="save-btn" type="submit" class="px-4 py-2 text-white bg-green-500 rounded hidden">Save</button>
      <button id="cancel-btn" type="button" class="px-4 py-2 bg-gray-300 rounded hidden">Cancel</button>
    </div>
  </form>

  <div class="mt-6 space-y-3">
    <button id="signout-btn" class="w-full py-2 bg-gray-200 hover:bg-gray-300 rounded">Sign Out</button>
    <button id="delete-btn" class="w-full py-2 bg-red-600 text-white hover:bg-red-700 rounded">Delete Account</button>
  </div>

</div>

<!-- Confirmation Modal -->
<div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
  <div class="bg-white p-6 rounded shadow-lg space-y-4">
    <h2 class="text-lg font-bold">Confirm Account Deletion</h2>
    <p>This action is irreversible. Are you sure?</p>
    <div class="flex justify-between space-x-4">
      <button id="cancel-delete" class="flex-1 py-2 bg-gray-300 rounded">Cancel</button>
      <button id="confirm-delete" class="flex-1 py-2 bg-red-600 text-white rounded">Delete</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
  import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

  const firebaseConfig = { /* your config */ };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getDatabase();

  const avatarImg = document.getElementById('avatar-img');
  const uploadLabel = document.getElementById('upload-label');
  const avatarInput = document.getElementById('avatar-input');
  const nameInput = document.getElementById('name-input');
  const emailInput = document.getElementById('email-input');
  const bioInput = document.getElementById('bio-input');
  const editBtn = document.getElementById('edit-btn');
  const saveBtn = document.getElementById('save-btn');
  const cancelBtn = document.getElementById('cancel-btn');
  const signoutBtn = document.getElementById('signout-btn');
  const deleteBtn = document.getElementById('delete-btn');
  const confirmModal = document.getElementById('confirm-modal');
  const cancelDelete = document.getElementById('cancel-delete');
  const confirmDelete = document.getElementById('confirm-delete');

  let currentUser;

  onAuthStateChanged(auth, async user => {
    if (!user) return location.href = 'login.html';
    currentUser = user;
    const uid = new URLSearchParams(location.search).get('uid');
    const isOwner = location.search.includes('owner=true');

    if (!uid || uid !== user.uid) {
      // view only mode: hide edit features
      uploadLabel.classList.add('hidden');
      editBtn.classList.add('hidden');
      saveBtn.classList.add('hidden');
      cancelBtn.classList.add('hidden');
    }

    const snap = await get(ref(db, `users/${isOwner ? user.uid : uid}`));
    const data = snap.val() || {};
    avatarImg.src = data.photoURL || avatarImg.src;
    nameInput.value = data.name || '';
    emailInput.value = data.email || '';
    bioInput.value = data.bio || '';

    if (isOwner) {
      editBtn.onclick = () => {
        [nameInput, bioInput].forEach(i => i.removeAttribute('readonly'));
        [editBtn, saveBtn, cancelBtn].forEach(b => b.classList.toggle('hidden'));
      };

      cancelBtn.onclick = () => location.reload();

      saveBtn.onclick = async () => {
        await update(ref(db, `users/${user.uid}`), {
          name: nameInput.value,
          bio: bioInput.value
        });
        location.reload();
      };

      // TODO: handle avatar upload via storage...
    }

    signoutBtn.onclick = () => signOut(auth);
    deleteBtn.onclick = () => confirmModal.classList.remove('hidden');
    cancelDelete.onclick = () => confirmModal.classList.add('hidden');
    confirmDelete.onclick = async () => {
      await deleteUser(currentUser);
      confirmModal.classList.add('hidden');
      location.href = 'login.html';
    };
  });
</script>
</body>
</html>
