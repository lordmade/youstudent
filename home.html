<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>BanterBox - Home</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary-red: #ed4956;
      --background: #fafafa;
      --border: #dbdbdb;
      --text-dark: #262626;
      --text-light: #8e8e8e;
      --white: #ffffff;
      --gradient: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
    }

    * {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      touch-action: manipulation;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--background);
      min-height: 100vh;
      margin: 0;
      overflow-x: hidden;
    }

    .container {
      max-width: 614px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* Tab Navigation */
    .tab-nav {
      position: sticky;
      top: 0;
      background: var(--white);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 0.75rem 0;
      z-index: 10;
    }

    .tab-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-dark);
      padding: 0.5rem;
      transition: transform 0.2s ease, color 0.2s ease;
    }

    .tab-btn:hover {
      transform: scale(1.1);
    }

    .tab-btn.active {
      color: var(--primary-red);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 2px;
      background: var(--primary-red);
    }

    .tab-btn svg {
      width: 24px;
      height: 24px;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease-out;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Post Styling */
    .post {
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 1.5rem;
      background: var(--white);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      animation: slideUp 0.5s ease-out forwards;
    }

    .post:nth-child(1) { animation-delay: 0.1s; }
    .post:nth-child(2) { animation-delay: 0.2s; }
    .post:nth-child(3) { animation-delay: 0.3s; }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .post-header {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      gap: 0.75rem;
      flex-direction: row;
    }

    .post-header .user-info {
      display: flex;
      flex-direction: column;
    }

    .post-header .timestamp {
      font-size: clamp(0.7rem, 2.5vw, 0.75rem);
      color: var(--text-light);
      margin-top: 0.2rem;
    }

    .post-header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid var(--white);
      background: var(--gradient);
      padding: 2px;
    }

    .post-header span {
      font-size: clamp(0.85rem, 3vw, 0.9rem);
      color: var(--text-dark);
      font-weight: 600;
      cursor: pointer;
    }

    .post-image {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 8px;
      transition: transform 0.3s ease;
    }

    .post-image:hover {
      transform: scale(1.02);
    }

    .post-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
    }

    .post-actions button {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-dark);
      padding: 0.5rem;
      transition: transform 0.2s ease, color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .post-actions .like-count {
      font-size: clamp(0.75rem, 2.5vw, 0.8rem);
      color: var(--text-dark);
    }

    .post-actions button:hover {
      color: var(--primary-red);
      transform: scale(1.1);
    }

    .post-actions .comment-btn {
      font-size: clamp(0.75rem, 2.5vw, 0.8rem);
      color: var(--text-dark);
    }

    .post-caption .song-display audio,
    .post-caption audio {
      display: none !important;
      visibility: hidden !important;
      height: 0 !important;
      width: 0 !important;
    }

    .post-actions svg {
      width: 24px;
      height: 24px;
    }

    .like-btn .text-red-500 {
      fill: var(--primary-red);
    }

    .post-caption {
      padding: 0.75rem 1rem;
      font-size: clamp(0.85rem, 3vw, 0.9rem);
      color: var(--text-dark);
      line-height: 1.4;
    }

    .post-caption strong {
      font-weight: 600;
    }

    .post-caption .song-display {
      font-size: clamp(0.8rem, 2.5vw, 0.85rem);
      color: var(--text-light);
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }

    .post-caption .song-display audio {
      display: none;
    }

    .post-caption audio {
      width: 100%;
      height: 30px;
      margin-top: 0.5rem;
      border-radius: 8px;
    }

    /* Post Footer */
    .post-footer {
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: flex-end;
      border-top: 1px solid var(--border);
    }

    /* Follow Button in Post */
    .post-follow-btn {
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: clamp(0.7rem, 2.5vw, 0.75rem);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease, color 0.2s ease;
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--text-dark);
    }

    .post-follow-btn.follow {
      background: var(--primary-red);
      color: var(--white);
      border: none;
    }

    .post-follow-btn.follow:hover {
      background: #d43f4e;
      transform: scale(1.05);
    }

    .post-follow-btn.following {
      background: var(--white);
      color: var(--primary-red);
    }

    .post-follow-btn.following:hover {
      background: rgba(237, 73, 86, 0.1);
      transform: scale(1.05);
    }

    @media (max-width: 414px) {
      .post-follow-btn {
        padding: 0.4rem 0.8rem;
        font-size: clamp(0.65rem, 2vw, 0.7rem);
      }
    }

    /* Post Image Carousel */
    .post-image-carousel {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      overflow: hidden;
      border-radius: 8px;
    }

    .post-image-container {
      display: flex;
      width: 100%;
      height: 100%;
      transition: transform 0.3s ease;
      touch-action: pan-y;
    }

    .post-image-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      flex-shrink: 0;
    }

    .carousel-indicators {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 6px;
    }

    .carousel-indicator {
      width: 8px;
      height: 8px;
      background: var(--text-light);
      border-radius: 50%;
      opacity: 0.5;
      transition: opacity 0.3s ease, background 0.3s ease;
    }

    .carousel-indicator.active {
      background: var(--primary-red);
      opacity: 1;
    }

    .carousel-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.5);
      color: var(--white);
      border: none;
      padding: 0.5rem;
      cursor: pointer;
      display: none;
      z-index: 10;
    }

    .carousel-arrow.left {
      left: 8px;
    }

    .carousel-arrow.right {
      right: 8px;
    }

    .post-image-carousel:hover .carousel-arrow {
      display: block;
    }

    @media (max-width: 414px) {
      .carousel-indicators {
        bottom: 6px;
        gap: 4px;
      }

      .carousel-indicator {
        width: 6px;
        height: 6px;
      }

      .carousel-arrow {
        padding: 0.4rem;
      }
    }

    /* Friends, Search, Profile Tabs */
    .friend-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s ease;
      justify-content: space-between;
    }

    .friend-item:hover {
      background: rgba(237, 73, 86, 0.1);
    }

    .friend-item img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 1rem;
    }

    .friend-item span {
      font-size: clamp(0.85rem, 3.5vw, 0.9rem);
      color: var(--text-dark);
      font-weight: 600;
    }

    .search-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 9999px;
      font-size: clamp(0.85rem, 3.5vw, 0.9rem);
      margin-bottom: 1rem;
    }

    #search-results {
      padding: 1rem 0;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 0.5rem;
    }

    #search-results .post {
      width: 100%;
      aspect-ratio: 1;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--white);
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s ease;
      margin-bottom: 0;
    }

    #search-results .post:hover {
      transform: scale(1.05);
    }

    #search-results .post img.post-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #search-results .post-header,
    #search-results .post-actions,
    #search-results .post-caption,
    #search-results audio {
      display: none;
    }

    .profile-header {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      text-align: center;
      border-bottom: 1px solid var(--border);
    }

    .profile-username-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 0.5rem;
    }

    .profile-header img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 0.5rem;
    }

    .profile-header h2 {
      font-size: clamp(1rem, 4vw, 1.1rem);
      color: var(--text-dark);
      font-weight: 600;
      margin: 0.5rem 0 0;
    }

    .profile-header p {
      font-size: clamp(0.85rem, 3.5vw, 0.9rem);
      color: var(--text-light);
      margin: 0.25rem 0;
    }

    .profile-action-btn {
      position: absolute;
      top: 0.5rem;
      background: none;
      border: none;
      color: var(--text-dark);
      cursor: pointer;
      padding: 0.5rem;
      transition: transform 0.2s ease, color 0.2s ease;
      z-index: 10;
    }

    .profile-action-btn:hover {
      transform: scale(1.1);
      color: var(--primary-red);
    }

    #notification-btn {
      right: 5.5rem;
    }

    #settings-btn {
      right: 3rem;
    }

    .profile-action-btn svg {
      width: 24px;
      height: 24px;
    }

    .profile-action-btn .unread-badge {
      position: absolute;
      top: -0.2rem;
      right: -0.2rem;
      background: var(--primary-red);
      color: var(--white);
      font-size: clamp(0.65rem, 2vw, 0.7rem);
      font-weight: 600;
      border-radius: 9999px;
      padding: 0.2rem 0.5rem;
      min-width: 1.2rem;
      text-align: center;
      line-height: 1;
    }

    .edit-profile-btn {
      background: var(--white);
      border: 1px solid var(--border);
      color: var(--primary-red);
      font-size: clamp(0.85rem, 3.5vw, 0.9rem);
      font-weight: 600;
      cursor: pointer;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      transition: background 0.2s ease, transform 0.2s ease, color 0.2s ease;
      margin-bottom: 0.5rem;
    }

    .edit-profile-btn:hover {
      background: var(--primary-red);
      color: var(--white);
      transform: scale(1.05);
      border: none;
    }

    .profile-content {
      padding: 1rem 0;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 0.5rem;
    }

    .profile-content .post {
      width: 100%;
      aspect-ratio: 1;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--white);
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s ease;
      margin-bottom: 0;
    }

    .profile-content .post:hover {
      transform: scale(1.05);
    }

    .profile-content .post img.post-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-content .post-header,
    .profile-content .post-actions,
    .profile-content .post-caption,
    .profile-content audio {
      display: none;
    }

    /* Comment Sheet */
    .comment-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--white);
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2);
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      z-index: 50;
    }

    .comment-sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .comment-sheet-close {
      background: none;
      border: none;
      color: var(--text-light);
      cursor: pointer;
    }

    .comment-sheet-close svg {
      width: 24px;
      height: 24px;
    }

    .comments-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .comment-item {
      display: flex;
      gap: 0.5rem;
      align-items: flex-start;
    }

    .comment-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .comment-content {
      flex: 1;
      text-align: left;
    }

    .comment-username {
      font-weight: 600;
      font-size: clamp(0.75rem, 3vw, 0.8rem);
      color: var(--text-dark);
    }

    .comment-text {
      font-size: clamp(0.75rem, 3vw, 0.8rem);
      color: var(--text-dark);
    }

    .comment-time {
      font-size: clamp(0.7rem, 2.5vw, 0.75rem);
      color: var(--text-light);
    }

    .comment-input-container {
      padding: 1rem;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .comment-input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 9999px;
      font-size: clamp(0.75rem, 1vw, 0.85rem);
    }

    .comment-submit {
      padding: 0.5rem 1.5rem;
      border-radius: 9999px;
      background: var(--primary-red);
      color: var(--white);
      font-weight: 600;
      font-size: clamp(0.75rem, 1vw, 0.85rem);
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .comment-submit:hover {
      background: #d43f4e;
      transform: scale(1.05);
    }

    /* Edit Profile Modal */
    .edit-profile-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 60;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .edit-profile-modal.open {
      opacity: 1;
      pointer-events: auto;
    }

    .edit-profile-modal-content {
      background: var(--white);
      border-radius: 16px;
      padding: 1.5rem;
      max-width: 90%;
      width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .edit-profile-modal-content h3 {
      font-size: clamp(1rem, 4vw, 1.1rem);
      color: var(--text-dark);
      margin-bottom: 1rem;
    }

    .edit-profile-modal-content input,
    .edit-profile-modal-content textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: clamp(0.85rem, 3.5vw, 0.9rem);
      margin-bottom: 1rem;
    }

    .edit-profile-modal-content textarea {
      resize: vertical;
      min-height: 80px;
    }

    .edit-profile-modal-content input[type="file"] {
      padding: 0.5rem;
    }

    .edit-profile-modal-content button {
      padding: 0.5rem 1.5rem;
      border-radius: 9999px;
      background: var(--primary-red);
      color: var(--white);
      font-weight: 600;
      font-size: clamp(0.85rem, 3.5vw, 0.9rem);
      transition: background 0.2s ease, transform 0.2s ease;
      border: none;
      cursor: pointer;
    }

    .edit-profile-modal-content button:hover {
      background: #d43f4e;
      transform: scale(1.05);
    }

    .edit-profile-modal-content .close-modal {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: none;
      border: none;
      color: var(--text-light);
      cursor: pointer;
    }

    .edit-profile-modal-content .close-modal svg {
      width: 24px;
      height: 24px;
    }

    .edit-profile-modal-content .error {
      color: var(--primary-red);
      font-size: clamp(0.75rem, 3vw, 0.8rem);
      margin-bottom: 1rem;
      display: none;
    }

    /* Loading and Error States */
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-dark);
      font-size: 1rem;
    }

    .placeholder {
      padding: 2rem;
      text-align: center;
      color: var(--text-light);
      font-size: 1rem;
    }

    .error {
      text-align: center;
      padding: 2rem;
      color: var(--primary-red);
      font-size: 1rem;
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .loading-overlay:not(.hidden) {
      opacity: 1;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(255, 255, 255, 0.2);
      border-top-color: var(--primary-red);
      border-radius: 50%;
      animation: spin 1s ease-in-out infinite, pulse 2s ease-in-out infinite;
      position: relative;
    }

    .spinner::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 12px;
      height: 12px;
      background: var(--primary-red);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: pulseDot 2s ease-in-out infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(var(--primary-red-rgb, 237, 73, 86), 0.4); }
      50% { box-shadow: 0 0 0 20px rgba(var(--primary-red-rgb, 237, 73, 86), 0); }
    }

    @keyframes pulseDot {
      0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
      50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
    }

    /* Floating Action Button */
    .fab {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: var(--primary-red);
      color: var(--white);
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(237, 73, 86, 0.3);
      z-index: 20;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(237, 73, 86, 0.4);
    }

    .fab svg {
      width: 28px;
      height: 28px;
      stroke-width: 2.5;
    }

    /* Responsive Design */
    @media (max-width: 414px) {
      .container {
        padding: 0 0.5rem;
      }

      .post-header img {
        width: 36px;
        height: 36px;
      }

      .post-header span {
        font-size: clamp(0.8rem, 2.5vw, 0.85rem);
      }

      .post-caption {
        font-size: clamp(0.8rem, 2.5vw, 0.85rem);
      }

      .post-caption .song-display {
        font-size: clamp(0.75rem, 2vw, 0.8rem);
      }

      .friend-item img {
        width: 32px;
        height: 32px;
      }

      .friend-item span {
        font-size: clamp(0.75rem, 3vw, 0.8rem);
      }

      #search-results {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.3rem;
      }

      .profile-header {
        padding: 0.5rem;
      }

      .profile-username-container {
        margin-top: 0.3rem;
      }

      .profile-header img {
        width: 60px;
        height: 60px;
      }

      .profile-header h2 {
        font-size: clamp(0.9rem, 3.5vw, 1rem);
        margin: 0.3rem 0 0;
      }

      .profile-header p {
        font-size: clamp(0.75rem, 3vw, 0.8rem);
      }

      .profile-action-btn {
        padding: 0.4rem;
        top: 0.4rem;
      }

      .profile-action-btn svg {
        width: 20px;
        height: 20px;
      }

      #notification-btn {
        right: 5rem;
      }

      #settings-btn {
        right: 2.7rem;
      }

      .profile-action-btn .unread-badge {
        font-size: clamp(0.6rem, 1.8vw, 0.65rem);
        padding: 0.15rem 0.4rem;
        min-width: 1rem;
        top: -0.15rem;
        right: -0.15rem;
      }

      .edit-profile-btn {
        font-size: clamp(0.75rem, 3vw, 0.8rem);
        padding: 0.4rem 0.8rem;
        margin-bottom: 0.3rem;
      }

      .fab {
        width: 48px;
        height: 48px;
      }

      .fab svg {
        width: 24px;
        height: 24px;
      }

      .spinner {
        width: 48px;
        height: 48px;
        border-width: 4px;
      }

      .spinner::before {
        width: 10px;
        height: 10px;
      }
    }

    /* Sub-Tab Navigation */
    .sub-tab-nav {
      display: flex;
      justify-content: space-around;
      background: var(--white);
      border-bottom: 1px solid var(--border);
      padding: 0.5rem 0;
      margin-bottom: 1rem;
    }

    .sub-tab-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-dark);
      font-size: clamp(0.85rem, 3vw, 0.9rem);
      font-weight: 500;
      padding: 0.5rem 1rem;
      transition: color 0.2s ease, transform 0.2s ease;
      position: relative;
    }

    .sub-tab-btn:hover {
      color: var(--primary-red);
      transform: scale(1.05);
    }

    .sub-tab-btn.active {
      color: var(--primary-red);
    }

    .sub-tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 50%;
      transform: translateX(-50%);
      width: 50%;
      height: 2px;
      background: var(--primary-red);
    }

    .sub-tab-content {
      display: none;
    }

    .sub-tab-content.active {
      display: block;
      animation: fadeIn 0.5s ease-out;
    }

    @media (max-width: 414px) {
      .sub-tab-btn {
        font-size: clamp(0.75rem, 2.5vw, 0.8rem);
        padding: 0.5rem 0.75rem;
      }
    }

    /* Friend Item Button */
    .friend-item-btn {
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: clamp(0.7rem, 2.5vw, 0.75rem);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease, color 0.2s ease;
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--text-dark);
      margin-left: auto;
    }

    .friend-item-btn.follow {
      background: var(--primary-red);
      color: var(--white);
      border: none;
    }

    .friend-item-btn.follow:hover {
      background: #d43f4e;
      transform: scale(1.05);
    }

    .friend-item-btn.following,
    .friend-item-btn.message {
      background: var(--white);
      color: var(--primary-red);
    }

    .friend-item-btn.following:hover,
    .friend-item-btn.message:hover {
      background: rgba(237, 73, 86, 0.1);
      transform: scale(1.05);
    }

    @media (max-width: 414px) {
      .friend-item-btn {
        padding: 0.4rem 0.8rem;
        font-size: clamp(0.65rem, 2vw, 0.7rem);
      }
    }

    .tab-btn[data-tab="reels"] {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      background: var(--white);
      border: 1px solid var(--border);
      transition: background 0.2s ease, transform 0.2s ease, color 0.2s ease;
    }

    .tab-btn[data-tab="reels"]:hover {
      background: rgba(237, 73, 86, 0.1);
      transform: scale(1.05);
    }

    .tab-btn[data-tab="reels"].active {
      background: var(--primary-red);
      color: var(--white);
      border: none;
    }

    .tab-btn[data-tab="reels"].active::after {
      display: none;
    }

    /* Delete Post Modal */
    .delete-post-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 60;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .delete-post-modal.open {
      opacity: 1;
      pointer-events: auto;
    }

    .delete-post-modal-content {
      background: var(--white);
      border-radius: 16px;
      padding: 1.5rem;
      max-width: 90%;
      width: 400px;
      position: relative;
      text-align: center;
    }

    .delete-post-modal-content h3 {
      font-size: clamp(1rem, 4vw, 1.1rem);
      color: var(--text-dark);
      margin-bottom: 0.5rem;
    }

    .delete-post-modal-content p {
      font-size: clamp(0.85rem, 3.5vw, 0.9rem);
      color: var(--text-light);
      margin-bottom: 1rem;
    }

    .delete-post-modal-content .close-modal {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: none;
      border: none;
      color: var(--text-light);
      cursor: pointer;
    }

    .delete-post-modal-content .close-modal svg {
      width: 24px;
      height: 24px;
    }

    @media (max-width: 414px) {
      .delete-post-modal-content {
        width: 90%;
        padding: 1rem;
      }
    }

    /* Friend Item Layout */
    .friend-item .last-message-timestamp {
      font-size: clamp(0.7rem, 2.5vw, 0.75rem);
      color: var(--text-light);
      margin-top: 0.2rem;
    }

    .friend-item .friend-info {
      display: flex;
      flex-direction: column;
      flex: 1;
      margin-left: 1rem;
      position: relative;
    }

    .friend-item .unread-badge {
      position: absolute;
      top: 0;
      left: -1.5rem;
      background: var(--primary-red);
      color: var(--white);
      font-size: clamp(0.65rem, 2vw, 0.7rem);
      font-weight: 600;
      border-radius: 9999px;
      padding: 0.2rem 0.5rem;
      min-width: 1.2rem;
      text-align: center;
      line-height: 1;
    }

    @media (max-width: 414px) {
      .friend-item .unread-badge {
        font-size: clamp(0.6rem, 1.8vw, 0.65rem);
        padding: 0.15rem 0.4rem;
        min-width: 1rem;
        left: -1.2rem;
      }
    }

    /* Verified Icon */
    .verified-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      background: #0095f6;
      border-radius: 50%;
      margin-left: 0.3rem;
      vertical-align: middle;
      position: relative;
      animation: verifiedBounce 0.6s ease-out forwards;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .verified-icon:hover {
      transform: scale(1.15);
      box-shadow: 0 0 8px rgba(0, 149, 246, 0.5);
    }

    .verified-icon svg {
      width: 12px;
      height: 12px;
      fill: var(--white);
      animation: checkmarkFade 0.6s ease-out 0.2s forwards;
      opacity: 0;
    }

    @keyframes verifiedBounce {
      0% { opacity: 0; transform: scale(0.5); }
      60% { opacity: 1; transform: scale(1.2); }
      100% { opacity: 1; transform: scale(1); }
    }

    @keyframes checkmarkFade {
      0% { opacity: 0; transform: scale(0.8); }
      100% { opacity: 1; transform: scale(1); }
    }

    @media (max-width: 414px) {
      .verified-icon {
        width: 14px;
        height: 14px;
      }

      .verified-icon svg {
        width: 10px;
        height: 10px;
      }
    }

    .stories-container {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }
    .stories-container::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }
    .story-card {
      transition: transform 0.2s;
    }
    .story-card:hover {
      transform: scale(1.05);
    }
    .story-card img {
      border: 2px solid transparent;
    }
    .story-card.unviewed img {
      border-color: #3b82f6;
    }
    .story-card.viewed img {
      border-color: #6b7280;
    }
    .story-content img, .story-content video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <div class="tab-nav">
    <button class="tab-btn active" data-tab="home" aria-label="Home">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
      </svg>
    </button>
    <button class="tab-btn" data-tab="friends" aria-label="Friends">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 00-4-4H7a4 4 0 00-4 4v2m11-10a2 2 0 11-4 0 2 2 0 014 0zm7 7v-2a4 4 0 00-3-3.87m-4-12a4 4 0 014 4"/>
      </svg>
    </button>
    <button class="tab-btn" data-tab="search" aria-label="Search">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <path d="M21 21l-4.35-4.35"/>
      </svg>
    </button>
    <button class="tab-btn" data-tab="reels" aria-label="Reels">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="4" y="4" width="16" height="16" rx="2"/>
        <path d="M10 8v8l6-4-6-4z"/>
      </svg>
      <span class="text-sm font-semibold">Watch Reels</span>
    </button>
    <button class="tab-btn" data-tab="profile" aria-label="Profile">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 4a6 6 0 110 12 6 6 0 010-12zm0 2a4 4 0 100 8 4 4 0 000-8z"/>
      </svg>
    </button>
  </div>

  <div class="container">
    <div id="home" class="tab-content active">
      <div id="stories-container" class="flex overflow-x-auto space-x-4 p-4 bg-gray-100 stories-container">
        <div id="add-story-card" class="story-card flex-shrink-0 w-20 text-center cursor-pointer">
          <div class="relative w-16 h-16 mx-auto rounded-full border-2 border-gray-300 bg-gray-200 flex items-center justify-center">
            <svg viewBox="0 0 24 24" class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14m-7-7h14"/>
            </svg>
            <img id="add-story-img" src="https://www.gravatar.com/avatar?d=mp" alt="Your avatar" class="absolute inset-0 w-full h-full rounded-full object-cover opacity-50">
          </div>
          <p class="text-sm mt-1 truncate text-gray-800">Your Story</p>
        </div>
      </div>
      <input type="file" id="story-file-input" accept="image/*,video/mp4" class="hidden">
      <div id="story-viewer" class="hidden fixed inset-0 bg-black z-50 flex items-center justify-center">
        <div class="relative w-full max-w-md">
          <button id="story-close" class="absolute top-4 right-4 text-white">
            <svg viewBox="0 0 24 24" class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
          <div id="story-content" class="w-full h-screen max-h-[80vh] bg-black story-content"></div>
          <button id="story-prev" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white">
            <svg viewBox="0 0 24 24" class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18l-6-6 6-6"/>
            </svg>
          </button>
          <button id="story-next" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white">
            <svg viewBox="0 0 24 24" class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 18l6-6-6-6"/>
            </svg>
          </button>
        </div>
      </div>
      <div id="posts-container">
        <div class="loading">Loading posts...</div>
      </div>
    </div>
    <div id="friends" class="tab-content">
      <div class="sub-tab-nav">
        <button class="sub-tab-btn active" data-sub-tab="friends-list" aria-label="Friends">Friends</button>
        <button class="sub-tab-btn" data-sub-tab="followers-list" aria-label="Followers">Followers</button>
        <button class="sub-tab-btn" data-sub-tab="following-list" aria-label="Following">Following</button>
      </div>
      <div id="friends-container" class="sub-tab-content active" data-sub-tab="friends-list">
        <div class="loading">Loading friends...</div>
      </div>
      <div id="followers-container" class="sub-tab-content" data-sub-tab="followers-list">
        <div class="loading">Loading followers...</div>
      </div>
      <div id="following-container" class="sub-tab-content" data-sub-tab="following-list">
        <div class="loading">Loading following...</div>
      </div>
    </div>
    <div id="search" class="tab-content">
      <div id="search-container" class="p-4 bg-white">
        <div class="category-buttons flex space-x-4 mb-4 overflow-x-auto">
          <a href="books.html" class="bg-gradient-to-r from-[#f09433] to-[#bc1888] text-white px-4 py-2 rounded-full hover:from-[#e08423] hover:to-[#ac0878] transition flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"></path>
            </svg>
            Books
          </a>
        </div>
        <div class="flex items-center border border-[var(--border)] rounded-full p-2">
          <input type="text" id="search-input" class="search-input bg-transparent w-full text-[var(--text-dark)] focus:outline-none placeholder-[var(--text-light)]" placeholder="Search posts by username or caption..." aria-label="Search posts" />
          <button id="search-btn" class="p-2">
            <svg class="w-6 h-6 text-[var(--text-light)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </button>
        </div>
        <div id="search-results" class="mt-4" aria-live="polite"></div>
      </div>
    </div>
    <div id="reels" class="tab-content">
      <div id="reels-container">
        <div class="loading">Loading reels...</div>
      </div>
    </div>
    <div id="profile" class="tab-content">
      <div id="profile-container" class="loading">Loading profile...</div>
    </div>
  </div>

  <a href="upload.html" class="fab" aria-label="Upload new media">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <path d="M12 5v14m7-7H5"/>
    </svg>
  </a>

  <div id="comment-sheet" class="comment-sheet hidden">
    <div class="comment-sheet-header">
      <h3 class="text-base font-semibold">Comments</h3>
      <button id="comment-sheet-close" class="comment-sheet-close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div id="comments-list" class="comments-list" aria-live="polite" aria-relevant="additions"></div>
    <div class="comment-input-container">
      <input id="comment-input" type="text" class="comment-input" placeholder="Add a comment..."/>
      <button id="comment-submit" class="comment-submit">Post</button>
    </div>
  </div>

  <div id="edit-profile-modal" class="edit-profile-modal hidden">
    <div class="edit-profile-modal-content">
      <button class="close-modal" aria-label="Close edit profile modal">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      <h3>Edit Profile</h3>
      <div class="error edit-profile-error" id="edit-profile-error"></div>
      <input type="text" id="edit-username" placeholder="Username" aria-label="Edit username"/>
      <textarea id="edit-bio" placeholder="Bio" aria-label="Edit bio"></textarea>
      <input type="file" id="edit-photo" accept="image/*" aria-label="Upload profile photo"/>
      <button id="edit-profile-save-btn">Save</button>
    </div>
  </div>
  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="spinner"></div>
  </div>

  <div id="delete-post-modal" class="edit-profile-modal hidden">
    <div class="edit-profile-modal-content">
      <button id="delete-post-close" class="close-modal">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      <h3>Delete Post</h3>
      <p>Are you sure you want to delete this post? This action cannot be undone.</p>
      <div class="flex justify-end gap-2 mt-4">
        <button id="delete-post-cancel" class="post-follow-btn">Cancel</button>
        <button id="delete-post-confirm" class="post-follow-btn follow">Delete</button>
      </div>
    </div>
  </div>

  <script type="module"> 
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
    import { getDatabase, ref, onValue, query, orderByChild, limitToLast, set, get, push, update } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    let currentUserUid = null;
    const commentSheet = document.getElementById("comment-sheet");
    const commentSheetClose = document.getElementById("comment-sheet-close");
    const commentsList = document.getElementById("comments-list");
    const commentInput = document.getElementById("comment-input");
    const commentSubmit = document.getElementById("comment-submit");
    const loadingOverlay = document.getElementById("loading-overlay");
    const editProfileModal = document.getElementById("edit-profile-modal");
    const editProfileSaveBtn = document.getElementById("edit-profile-save-btn");
    const editProfileCloseBtn = document.querySelector("#edit-profile-modal .close-modal");
    const editUsername = document.getElementById("edit-username");
    const editBio = document.getElementById("edit-bio");
    const editPhoto = document.getElementById("edit-photo");
    const editProfileError = document.getElementById("edit-profile-error");
    let currentPostId = null;
    let currentPlayingAudio = null;

    const CLOUDINARY_UPLOAD_PRESET = "banter_box";
    const CLOUDINARY_CLOUD_NAME = "dqkujefxj";
    const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

    function showLoading() { loadingOverlay.classList.remove("hidden"); }
    function hideLoading() { loadingOverlay.classList.add("hidden"); }

    function showError(element, message) {
      element.textContent = message;
      element.style.display = "block";
    }

    function hideError(element) {
      element.textContent = "";
      element.style.display = "none";
    }

    function pauseAllMedia(exceptAudioId = null) {
      const allMedia = document.querySelectorAll('audio');
      allMedia.forEach(media => {
        if (media.id !== exceptAudioId && !media.paused) {
          media.pause();
          media.currentTime = 0;
        }
      });
      if (exceptAudioId) {
        currentPlayingAudio = document.getElementById(exceptAudioId);
      } else {
        currentPlayingAudio = null;
      }
    }

    // Save button event listener
    editProfileSaveBtn.addEventListener("click", async () => {
      const newUsername = editUsername.value.trim();
      const newBio = editBio.value.trim();
      const newPhoto = editPhoto.files[0];

      if (!newUsername) {
        showError(editProfileError, "Username cannot be empty.");
        editUsername.focus();
        return;
      }

      showLoading();
      try {
        const user = auth.currentUser;
        if (!user) {
          showError(editProfileError, "User not authenticated.");
          return;
        }

        const profileUpdates = {
          displayName: newUsername,
        };

        let photoURL = user.photoURL;
        if (newPhoto) {
          const maxFileSize = 5 * 1024 * 1024; // 5MB
          if (newPhoto.size > maxFileSize) {
            showError(editProfileError, "Photo must be under 5MB.");
            return;
          }

          const formData = new FormData();
          formData.append("file", newPhoto);
          formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

          const response = await fetch(CLOUDINARY_UPLOAD_URL, {
            method: "POST",
            body: formData,
          });
          const data = await response.json();
          if (data.secure_url) {
            photoURL = data.secure_url;
            profileUpdates.photoURL = photoURL;
          } else {
            throw new Error("Failed to upload photo to Cloudinary.");
          }
        }

        await updateProfile(user, profileUpdates);

        const userRef = ref(db, `users/${user.uid}`);
        await update(userRef, {
          username: newUsername,
          bio: newBio || "",
          photoURL: photoURL || user.photoURL || "https://www.gravatar.com/avatar?d=mp",
          updatedAt: Date.now(),
        });

        editProfileModal.classList.remove("open");
        editProfileModal.classList.add("hidden");
        hideError(editProfileError);

        loadProfile();
      } catch (error) {
        console.error("Error updating profile:", error.code, error.message);
        let errorMessage = "Failed to update profile. Please try again.";
        if (error.code === "auth/requires-recent-login") {
          errorMessage = "Please log in again to update your profile.";
        } else if (error.message.includes("Cloudinary")) {
          errorMessage = "Failed to upload photo. Please try again.";
        }
        showError(editProfileError, errorMessage);
      } finally {
        hideLoading();
      }
    });

    editProfileCloseBtn.addEventListener("click", () => {
      editProfileModal.classList.remove("open");
      editProfileModal.classList.add("hidden");
      hideError(editProfileError);
    });

    function toggleLike(postId, button) {
      const userId = currentUserUid;
      const postRef = ref(db, `posts/${postId}`);
      const likeCountSpan = button.querySelector(".like-count");
      const likeIcon = button.querySelector("svg");

      showLoading();
      get(postRef).then((snapshot) => {
        const post = snapshot.val() || {};
        const currentLikes = post.likes || 0;
        const likedBy = post.likedBy || [];
        const isLiked = likedBy.includes(userId);

        if (isLiked) {
          update(postRef, {
            likes: currentLikes - 1,
            likedBy: likedBy.filter(id => id !== userId)
          }).then(() => {
            likeCountSpan.textContent = currentLikes - 1;
            likeIcon.classList.remove("text-red-500");
            likeIcon.classList.add("text-gray-500");
          });
        } else {
          update(postRef, {
            likes: currentLikes + 1,
            likedBy: [...likedBy, userId]
          }).then(() => {
            likeCountSpan.textContent = currentLikes + 1;
            likeIcon.classList.remove("text-gray-500");
            likeIcon.classList.add("text-red-500");
            if (post.userId !== userId) {
              const notifRef = push(ref(db, `notifications/${post.userId}/${postId}/likes`));
              set(notifRef, { type: 'like', userId: currentUserUid, timestamp: Date.now(), read: false });
            }
          });
        }
      }).catch((error) => {
        console.error("Error updating like:", error.message);
      }).finally(() => {
        hideLoading();
      });
    }

    async function toggleFollow(targetUid, button, containerId) {
      if (targetUid === currentUserUid) return;
      showLoading();
      try {
        const followingRef = ref(db, `users/${currentUserUid}/following/${targetUid}`);
        const followerRef = ref(db, `users/${targetUid}/followers/${currentUserUid}`);
        const followingSnap = await get(followingRef);
        const isFollowing = followingSnap.exists();

        if (isFollowing) {
          await set(followingRef, null);
          await set(followerRef, null);
          const isMutual = await get(ref(db, `users/${currentUserUid}/followers/${targetUid}`));
          if (isMutual.exists()) {
            await set(ref(db, `users/${currentUserUid}/friends/${targetUid}`), null);
            await set(ref(db, `users/${targetUid}/friends/${currentUserUid}`), null);
          }
          button.textContent = "Follow";
          button.classList.remove("following");
          button.classList.add("follow");
        } else {
          await set(followingRef, true);
          await set(followerRef, true);
          const isMutual = await get(ref(db, `users/${currentUserUid}/followers/${targetUid}`));
          if (isMutual.exists()) {
            await set(ref(db, `users/${currentUserUid}/friends/${targetUid}`), true);
            await set(ref(db, `users/${targetUid}/friends/${currentUserUid}`), true);
          }
          const notifRef = push(ref(db, `notifications/${targetUid}/system/follows`));
          await set(notifRef, { type: 'follow', userId: currentUserUid, timestamp: Date.now(), read: false });
          button.textContent = "Following";
          button.classList.remove("follow");
          button.classList.add("following");
        }

        if (['friends-container', 'followers-container', 'following-container'].includes(containerId)) {
          const containerRef = {
            'friends-container': ref(db, `users/${currentUserUid}/friends`),
            'followers-container': ref(db, `users/${currentUserUid}/followers`),
            'following-container': ref(db, `users/${currentUserUid}/following`)
          }[containerId];

          const snapshot = await get(containerRef);
          const data = snapshot.val() || {};
          const container = document.getElementById(containerId);
          container.innerHTML = "";
          if (Object.keys(data).length === 0) {
            container.innerHTML = `<div class="placeholder">No ${containerId.replace('-container', '')} found.</div>`;
          } else {
            const usersSnap = await get(ref(db, "users"));
            const users = usersSnap.val() || {};
            for (const uid in data) {
              const userData = users[uid] || { username: "Unknown", photoURL: null };
              const item = document.createElement("div");
              item.className = "friend-item";
              item.innerHTML = `
                <img src="${userData.photoURL || 'https://www.gravatar.com/avatar?d=mp'}" alt="${userData.username} avatar"/>
                <span>${userData.username}</span>
                <button class="friend-item-btn ${containerId === 'friends-container' ? 'message' : containerId === 'followers-container' ? (await get(ref(db, `users/${currentUserUid}/following/${uid}`)).exists() ? 'following' : 'follow') : 'following'}">
                  ${containerId === 'friends-container' ? 'Message' : containerId === 'followers-container' ? (await get(ref(db, `users/${currentUserUid}/following/${uid}`)).exists() ? 'Following' : 'Follow') : 'Following'}
                </button>
              `;
              item.querySelector(".friend-item-btn").addEventListener("click", (e) => {
                e.stopPropagation();
                if (containerId === 'friends-container') {
                  console.log(`Initiate message to user: ${uid}`);
                  location.href = `chat.html?uid=${uid}`;
                } else {
                  toggleFollow(uid, e.target, containerId);
                }
              });
              item.addEventListener("click", (e) => {
                if (e.target.classList.contains("friend-item-btn")) return;
                console.log("Navigating to profile:", uid);
                location.href = `profile.html?uid=${uid}`;
                pauseAllMedia();
              });
              container.appendChild(item);
            }
          }
        } else if (containerId === 'posts-container') {
          await loadPosts();
        }
      } catch (error) {
        console.error("Error toggling follow:", error.message);
        if (['friends-container', 'followers-container', 'following-container'].includes(containerId)) {
          document.getElementById(containerId).innerHTML = `<p class="error">Failed to load ${containerId.replace('-container', '')}: ${error.message}</p>`;
        } else {
          console.error("Error in posts-container follow action:", error.message);
        }
      } finally {
        hideLoading();
      }
    }

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        location.href = "index.html";
      } else {
        currentUserUid = user.uid;
        loadStories();
        loadPosts();
        loadFriends();
        loadSearch();
        loadProfile();
      }
    });

    const tabBtns = document.querySelectorAll(".tab-btn");
    const tabs = document.querySelectorAll(".tab-content");

    tabBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        tabBtns.forEach(b => {
          b.classList.remove("active");
          b.setAttribute("aria-selected", "false");
        });
        tabs.forEach(t => t.classList.remove("active"));
        btn.classList.add("active");
        btn.setAttribute("aria-selected", "true");

        const tabId = btn.dataset.tab;
        if (tabId === "reels") {
          console.log("Navigating to reels.html");
          location.href = "reels.html";
        } else {
          document.getElementById(tabId).classList.add("active");
        }
        pauseAllMedia();
      });
    });

    function timeAgo(timestamp) {
      if (!timestamp) return "";
      const now = Date.now();
      const diff = now - timestamp;
      if (diff < 60000) return "just now";
      if (diff < 3600000) return Math.floor(diff / 60000) + "m ago";
      if (diff < 86400000) return Math.floor(diff / 3600000) + "h ago";
      return Math.floor(diff / 86400000) + "d ago";
    }

    async function showCommentSheet(postId) {
      currentPostId = postId;
      commentSheet.classList.remove("hidden");
      commentSheet.classList.add("open");
      commentsList.innerHTML = '<div class="loading">Loading comments...</div>';
      showLoading();
      pauseAllMedia();
      try {
        const postSnap = await Promise.race([
          get(ref(db, `posts/${postId}`)),
          new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout loading comments")), 10000))
        ]);
        const post = postSnap.val();
        const comments = post.comments || {};
        const usersSnap = await Promise.race([
          get(ref(db, "users")),
          new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout loading users")), 10000))
        ]);
        const users = usersSnap.val() || {};
        commentsList.innerHTML = "";
        for (const cid in comments) {
          const comment = comments[cid];
          const userData = users[comment.userId] || { username: "Unknown", photoURL: null };
          const commentItem = document.createElement("div");
          commentItem.className = "comment-item";
          commentItem.innerHTML = `
            <img src="${userData.photoURL || 'https://www.gravatar.com/avatar?d=mp'}" alt="${userData.username} avatar" class="comment-avatar"/>
            <div class="comment-content">
              <p class="comment-username">${userData.username}</p>
              <p class="comment-text">${comment.text}</p>
              <p class="comment-time">${timeAgo(comment.timestamp)}</p>
            </div>
          `;
          commentsList.appendChild(commentItem);
        }
        if (Object.keys(comments).length === 0) {
          commentsList.innerHTML = `<p class="text-center text-gray-500">No comments yet.</p>`;
        }
        commentInput.value = "";
        commentInput.focus();
      } catch (error) {
        console.error("Error loading comments:", error.code, error.message);
        commentsList.innerHTML = `<p class="error">Failed to load comments: ${error.message}</p>`;
      } finally {
        hideLoading();
      }
    }

    commentSheetClose.addEventListener("click", () => {
      commentSheet.classList.remove("open");
      setTimeout(() => commentSheet.classList.add("hidden"), 300);
      currentPostId = null;
    });

    commentSubmit.addEventListener("click", async () => {
      if (!currentPostId || !commentInput.value.trim()) return;
      showLoading();
      try {
        const commentRef = push(ref(db, `posts/${currentPostId}/comments`));
        const postSnap = await Promise.race([
          get(ref(db, `posts/${currentPostId}`)),
          new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout fetching post")), 10000))
        ]);
        const post = postSnap.val();
        await set(commentRef, {
          userId: currentUserUid,
          text: commentInput.value.trim(),
          timestamp: Date.now(),
        });
        if (post.userId !== currentUserUid) {
          const notifRef = push(ref(db, `notifications/${post.userId}/${currentPostId}/comments`));
          await set(notifRef, { type: 'comment', userId: currentUserUid, timestamp: Date.now(), read: false });
        }
        commentInput.value = "";
        await showCommentSheet(currentPostId);
      } catch (error) {
        console.error("Error adding comment:", error.code, error.message);
        showError(commentsList, `Failed to add comment: ${error.message}`);
      } finally {
        hideLoading();
      }
    });

    commentInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        commentSubmit.click();
      }
    });

    async function loadStories() {
      const storiesContainer = document.getElementById("stories-container");
      const addStoryCard = document.getElementById("add-story-card");
      const addStoryImg = document.getElementById("add-story-img");
      const storyFileInput = document.getElementById("story-file-input");
      showLoading();
      try {
        const userSnap = await get(ref(db, `users/${currentUserUid}`));
        const user = userSnap.val() || {};
        addStoryImg.src = user.photoURL || "https://www.gravatar.com/avatar?d=mp";

        addStoryCard.addEventListener("click", () => {
          storyFileInput.click();
          pauseAllMedia();
        });

        storyFileInput.addEventListener("change", () => {
          if (storyFileInput.files[0]) {
            createStory(storyFileInput.files[0]);
          }
        });

        const followingSnap = await get(ref(db, `users/${currentUserUid}/following`));
        const following = followingSnap.val() || {};
        const userIds = [currentUserUid, ...Object.keys(following)];
        const storiesSnap = await get(query(ref(db, "stories"), orderByChild("timestamp")));
        const storiesData = storiesSnap.val() || {};
        const now = Date.now();
        const validStories = [];

        for (const storyId in storiesData) {
          const story = storiesData[storyId];
          if (userIds.includes(story.userId) && story.timestamp && (now - story.timestamp < 24 * 60 * 60 * 1000)) {
            validStories.push({ id: storyId, ...story });
          }
        }

        const userStories = {};
        validStories.forEach(story => {
          if (!userStories[story.userId]) userStories[story.userId] = [];
          userStories[story.userId].push(story);
        });

        const usersSnap = await get(ref(db, "users"));
        const users = usersSnap.val() || {};

        storiesContainer.innerHTML = "";
        storiesContainer.appendChild(addStoryCard);

        for (const userId of userIds) {
          if (userStories[userId]) {
            const user = users[userId] || { username: "Unknown", photoURL: null };
            const hasUnviewed = userStories[userId].some(story => !story.viewedBy?.includes(currentUserUid));
            const storyCard = document.createElement("div");
            storyCard.className = `story-card flex-shrink-0 w-20 text-center cursor-pointer ${hasUnviewed ? "unviewed" : "viewed"}`;
            storyCard.dataset.userId = userId;
            storyCard.innerHTML = `
              <img src="${user.photoURL || 'https://www.gravatar.com/avatar?d=mp'}" alt="${user.username} avatar" class="w-16 h-16 mx-auto rounded-full              object-fit-cover"/>
              <p class="text-sm mt-1 truncate text-gray-800">${user.username}</p>
            `;
            storyCard.addEventListener("click", () => {
              viewStory(userId, userStories[userId]);
              pauseAllMedia();
            });
            storiesContainer.appendChild(storyCard);
          }
        }

        if (validStories.length === 0) {
          storiesContainer.innerHTML = addStoryCard.outerHTML + `<p class="text-center text-gray-500 w-full">No stories available.</p>`;
        }
      } catch (error) {
        console.error("Error loading stories:", error.message);
        storiesContainer.innerHTML = addStoryCard.outerHTML + `<p class="error">Failed to load stories: ${error.message}</p>`;
      } finally {
        hideLoading();
      }
    }

    async function viewStory(userId, stories) {
      const storyViewer = document.getElementById("story-viewer");
      const storyContent = document.getElementById("story-content");
      const storyClose = document.getElementById("story-close");
      const storyPrev = document.getElementById("story-prev");
      const storyNext = document.getElementById("story-next");
      let currentIndex = 0;

      async function displayStory(index) {
        const story = stories[index];
        if (!story) return;

        const isVideo = story.url.endsWith(".mp4");
        storyContent.innerHTML = isVideo
          ? `<video src="${story.url}" autoplay controls class="w-full h-full object-contain"></video>`
          : `<img src="${story.url}" alt="Story content" class="w-full h-full object-contain"/>`;

        if (!story.viewedBy?.includes(currentUserUid)) {
          const storyRef = ref(db, `stories/${story.id}`);
          await update(storyRef, {
            viewedBy: [...(story.viewedBy || []), currentUserUid],
          });
          const storyCard = document.querySelector(`.story-card[data-user-id="${userId}"]`);
          if (storyCard) {
            const allViewed = stories.every(s => s.viewedBy?.includes(currentUserUid));
            storyCard.classList.toggle("unviewed", !allViewed);
            storyCard.classList.toggle("viewed", allViewed);
          }
        }

        storyPrev.style.display = index === 0 ? "none" : "block";
        storyNext.style.display = index === stories.length - 1 ? "none" : "block";
      }

      storyViewer.classList.remove("hidden");
      await displayStory(currentIndex);

      storyClose.addEventListener("click", () => {
        storyViewer.classList.add("hidden");
        storyContent.innerHTML = "";
        pauseAllMedia();
      }, { once: true });

      storyPrev.addEventListener("click", () => {
        if (currentIndex > 0) {
          currentIndex--;
          displayStory(currentIndex);
        }
      }, { once: true });

      storyNext.addEventListener("click", () => {
        if (currentIndex < stories.length - 1) {
          currentIndex++;
          displayStory(currentIndex);
        }
      }, { once: true });
    }

    async function createStory(file) {
      if (!file) return;
      showLoading();
      try {
        const maxFileSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxFileSize) {
          alert("File must be under 10MB.");
          return;
        }

        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

        const response = await fetch(CLOUDINARY_UPLOAD_URL, {
          method: "POST",
          body: formData,
        });
        const data = await response.json();
        if (!data.secure_url) {
          throw new Error("Failed to upload story to Cloudinary.");
        }

        const storyRef = push(ref(db, "stories"));
        await set(storyRef, {
          userId: currentUserUid,
          url: data.secure_url,
          timestamp: Date.now(),
          viewedBy: [],
        });

        document.getElementById("story-file-input").value = "";
        await loadStories();
      } catch (error) {
        console.error("Error creating story:", error.message);
        alert(`Failed to create story: ${error.message}`);
      } finally {
        hideLoading();
      }
    }

    async function loadPosts() {
      const postsContainer = document.getElementById("posts-container");
      showLoading();
      try {
        const postsQuery = query(ref(db, "posts"), orderByChild("timestamp"), limitToLast(10));
        onValue(postsQuery, async (snapshot) => {
          const posts = snapshot.val() || {};
          const usersSnap = await get(ref(db, "users"));
          const users = usersSnap.val() || {};
          const followingSnap = await get(ref(db, `users/${currentUserUid}/following`));
          const following = followingSnap.val() || {};
          postsContainer.innerHTML = "";

          const postArray = Object.entries(posts)
            .map(([id, post]) => ({ id, ...post }))
            .filter(post => post.userId === currentUserUid || Object.keys(following).includes(post.userId))
            .sort((a, b) => b.timestamp - a.timestamp);

          if (postArray.length === 0) {
            postsContainer.innerHTML = '<p class="placeholder">No posts found. Follow some users!</p>';
            return;
          }

          for (const post of postArray) {
            const user = users[post.userId] || { username: "Unknown", photoURL: null };
            const isLiked = post.likedBy?.includes(currentUserUid);
            const isFollowing = post.userId === currentUserUid || following[post.userId];
            const isOwnPost = post.userId === currentUserUid;
            const postElement = document.createElement("div");
            postElement.className = "post";
            postElement.innerHTML = `
              <div class="post-header">
                <img src="${user.photoURL || 'https://www.gravatar.com/avatar?d=mp'}" alt="${user.username} avatar"/>
                <div class="user-info">
                  <span>${user.username}${user.isVerified ? '<span class="verified-icon"><svg viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></span>' : ''}</span>
                  <span class="timestamp">${timeAgo(post.timestamp)}</span>
                </div>
                ${!isOwnPost ? `
                  <button class="post-follow-btn ${isFollowing ? 'following' : 'follow'}">
                    ${isFollowing ? 'Following' : 'Follow'}
                  </button>
                ` : `
                  <button class="post-action-btn delete-post-btn" data-post-id="${post.id}">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-4h4M9 7v12m6-12v12"/>
                    </svg>
                  </button>
                `}
              </div>
              <div class="post-image-carousel">
                <div class="post-image-container">
                  ${post.imageURLs.map(url => `<img src="${url}" class="post-image" alt="Post image"/>`).join('')}
                </div>
                ${post.imageURLs.length > 1 ? `
                  <div class="carousel-indicators">
                    ${post.imageURLs.map((_, i) => `<span class="carousel-indicator ${i === 0 ? 'active' : ''}"></span>`).join('')}
                  </div>
                  <button class="carousel-arrow left">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                    </svg>
                  </button>
                  <button class="carousel-arrow right">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                    </svg>
                  </button>
                ` : ''}
              </div>
              <div class="post-actions">
                <button class="like-btn">
                  <svg viewBox="0 0 24 24" fill="none" stroke="${isLiked ? 'var(--primary-red)' : 'currentColor'}" stroke-width="2" class="${isLiked ? 'text-red-500' : 'text-gray-500'}">
                    <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                  </svg>
                  <span class="like-count">${post.likes || 0}</span>
                </button>
                <button class="comment-btn">Comment</button>
              </div>
              <div class="post-caption">
                <strong>${user.username}</strong> ${post.caption || ''}
                ${post.audioURL ? `
                  <div class="song-display">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                      <path d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 11-.99-3.467l2.31-.66a2.25 2.25 0 001.632-2.163zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 01-.99-3.467l2.31-.66A2.25 2.25 0 009 15.553z"/>
                    </svg>
                    Playing: ${post.audioName || 'Unknown Song'}
                    <audio id="audio-${post.id}" src="${post.audioURL}"></audio>
                  </div>
                ` : ''}
              </div>
            `;

            const imageContainer = postElement.querySelector(".post-image-container");
            if (post.imageURLs.length > 1) {
              let currentIndex = 0;
              const indicators = postElement.querySelectorAll(".carousel-indicator");
              const updateCarousel = (index) => {
                imageContainer.style.transform = `translateX(-${index * 100}%)`;
                indicators.forEach((ind, i) => ind.classList.toggle("active", i === index));
              };
              postElement.querySelector(".carousel-arrow.left").addEventListener("click", () => {
                if (currentIndex > 0) {
                  currentIndex--;
                  updateCarousel(currentIndex);
                }
              });
              postElement.querySelector(".carousel-arrow.right").addEventListener("click", () => {
                if (currentIndex < post.imageURLs.length - 1) {
                  currentIndex++;
                  updateCarousel(currentIndex);
                }
              });
            }

            postElement.querySelector(".like-btn").addEventListener("click", () => toggleLike(post.id, postElement.querySelector(".like-btn")));
            postElement.querySelector(".comment-btn").addEventListener("click", () => showCommentSheet(post.id));

            if (!isOwnPost) {
              postElement.querySelector(".post-follow-btn").addEventListener("click", (e) => {
                e.stopPropagation();
                toggleFollow(post.userId, e.target, "posts-container");
              });
            } else {
              postElement.querySelector(".delete-post-btn").addEventListener("click", () => showDeletePostModal(post.id));
            }

            postElement.querySelector(".post-header img").addEventListener("click", () => {
              console.log("Navigating to profile:", post.userId);
              location.href = `profile.html?uid=${post.userId}`;
              pauseAllMedia();
            });
            postElement.querySelector(".post-header span").addEventListener("click", () => {
              console.log("Navigating to profile:", post.userId);
              location.href = `profile.html?uid=${post.userId}`;
              pauseAllMedia();
            });

            if (post.audioURL) {
              const songDisplay = postElement.querySelector(".song-display");
              songDisplay.addEventListener("click", () => {
                const audio = postElement.querySelector(`#audio-${post.id}`);
                if (audio.paused) {
                  pauseAllMedia(`audio-${post.id}`);
                  audio.play();
                } else {
                  audio.pause();
                  audio.currentTime = 0;
                  currentPlayingAudio = null;
                }
              });
            }

            postsContainer.appendChild(postElement);
          }
        }, { onlyOnce: false });
      } catch (error) {
        console.error("Error loading posts:", error.message);
        postsContainer.innerHTML = `<p class="error">Failed to load posts: ${error.message}</p>`;
      } finally {
        hideLoading();
      }
    }

    async function loadFriends() {
      const friendsContainer = document.getElementById("friends-container");
      const followersContainer = document.getElementById("followers-container");
      const followingContainer = document.getElementById("following-container");
      showLoading();
      try {
        const subTabBtns = document.querySelectorAll(".sub-tab-btn");
        const subTabs = document.querySelectorAll(".sub-tab-content");

        subTabBtns.forEach(btn => {
          btn.addEventListener("click", () => {
            subTabBtns.forEach(b => {
              b.classList.remove("active");
              b.setAttribute("aria-selected", "false");
            });
            subTabs.forEach(t => t.classList.remove("active"));
            btn.classList.add("active");
            btn.setAttribute("aria-selected", "true");
            document.querySelector(`.sub-tab-content[data-sub-tab="${btn.dataset.subTab}"]`).classList.add("active");
            pauseAllMedia();
          });
        });

        const containers = [
          { id: "friends-container", path: "friends", emptyMsg: "No friends found." },
          { id: "followers-container", path: "followers", emptyMsg: "No followers found." },
          { id: "following-container", path: "following", emptyMsg: "No following found." }
        ];

        for (const { id, path, emptyMsg } of containers) {
          const container = document.getElementById(id);
          const dataRef = ref(db, `users/${currentUserUid}/${path}`);
          onValue(dataRef, async (snapshot) => {
            const data = snapshot.val() || {};
            container.innerHTML = "";
            if (Object.keys(data).length === 0) {
              container.innerHTML = `<div class="placeholder">${emptyMsg}</div>`;
              return;
            }
            const usersSnap = await get(ref(db, "users"));
            const users = usersSnap.val() || {};
            for (const uid in data) {
              const userData = users[uid] || { username: "Unknown", photoURL: null };
              const item = document.createElement("div");
              item.className = "friend-item";
              const isFriend = id === "friends-container";
              const isFollowing = id === "followers-container" ? await get(ref(db, `users/${currentUserUid}/following/${uid}`)).exists() : true;
              item.innerHTML = `
                <img src="${userData.photoURL || 'https://www.gravatar.com/avatar?d=mp'}" alt="${userData.username} avatar"/>
                <div class="friend-info">
                  <span>${userData.username}${userData.isVerified ? '<span class="verified-icon"><svg viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></span>' : ''}</span>
                  ${isFriend ? `<span class="last-message-timestamp">${timeAgo(data[uid].lastMessage)}</span>` : ''}
                  ${data[uid].unreadCount ? `<span class="unread-badge">${data[uid].unreadCount}</span>` : ''}
                </div>
                <button class="friend-item-btn ${isFriend ? 'message' : isFollowing ? 'following' : 'follow'}">
                  ${isFriend ? 'Message' : isFollowing ? 'Following' : 'Follow'}
                </button>
              `;
              item.querySelector(".friend-item-btn").addEventListener("click", (e) => {
                e.stopPropagation();
                if (isFriend) {
                  console.log(`Initiate message to user: ${uid}`);
                  location.href = `chat.html?uid=${uid}`;
                } else {
                  toggleFollow(uid, e.target, id);
                }
              });
              item.addEventListener("click", (e) => {
                if (e.target.classList.contains("friend-item-btn")) return;
                console.log("Navigating to profile:", uid);
                location.href = `profile.html?uid=${uid}`;
                pauseAllMedia();
              });
              container.appendChild(item);
            }
          }, { onlyOnce: false });
        }
      } catch (error) {
        console.error("Error loading friends:", error.message);
        friendsContainer.innerHTML = `<p class="error">Failed to load friends: ${error.message}</p>`;
        followersContainer.innerHTML = `<p class="error">Failed to load followers: ${error.message}</p>`;
        followingContainer.innerHTML = `<p class="error">Failed to load following: ${error.message}</p>`;
      } finally {
        hideLoading();
      }
    }

    async function loadSearch() {
      const searchInput = document.getElementById("search-input");
      const searchBtn = document.getElementById("search-btn");
      const searchResults = document.getElementById("search-results");

      async function performSearch() {
        const query = searchInput.value.trim().toLowerCase();
        if (!query) {
          searchResults.innerHTML = '<p class="placeholder">Enter a search term.</p>';
          return;
        }
        showLoading();
        try {
          const postsSnap = await get(ref(db, "posts"));
          const posts = postsSnap.val() || {};
          const usersSnap = await get(ref(db, "users"));
          const users = usersSnap.val() || {};
          searchResults.innerHTML = "";
          const matchingPosts = [];

          for (const postId in posts) {
            const post = posts[postId];
            const user = users[post.userId] || { username: "Unknown" };
            if (user.username.toLowerCase().includes(query) || (post.caption && post.caption.toLowerCase().includes(query))) {
              matchingPosts.push({ id: postId, ...post });
            }
          }

          if (matchingPosts.length === 0) {
            searchResults.innerHTML = '<p class="placeholder">No results found.</p>';
            return;
          }

          for (const post of matchingPosts) {
            const postElement = document.createElement("div");
            postElement.className = "post";
            postElement.innerHTML = `<img src="${post.imageURLs[0]}" class="post-image" alt="Post image"/>`;
            postElement.addEventListener("click", () => {
              console.log("Navigating to post:", post.id);
              location.href = `post.html?postId=${post.id}`;
              pauseAllMedia();
            });
            searchResults.appendChild(postElement);
          }
        } catch (error) {
          console.error("Error searching posts:", error.message);
          searchResults.innerHTML = `<p class="error">Failed to search posts: ${error.message}</p>`;
        } finally {
          hideLoading();
        }
      }

      searchBtn.addEventListener("click", performSearch);
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          performSearch();
        }
      });
    }

    async function loadProfile() {
      const profileContainer = document.getElementById("profile-container");
      showLoading();
      try {
        const userRef = ref(db, `users/${currentUserUid}`);
        const userSnap = await get(userRef);
        const user = userSnap.val() || {};
        const postsSnap = await get(query(ref(db, "posts"), orderByChild("userId"), limitToLast(10)));
        const posts = postsSnap.val() || {};
        const followersSnap = await get(ref(db, `users/${currentUserUid}/followers`));
        const followingSnap = await get(ref(db, `users/${currentUserUid}/following`));
        const notificationsSnap = await get(ref(db, `notifications/${currentUserUid}`));
        const followers = followersSnap.val() || {};
        const following = followingSnap.val() || {};
        const notifications = notificationsSnap.val() || {};
        let unreadCount = 0;

        for (const postId in notifications) {
          for (const type in notifications[postId]) {
            for (const notifId in notifications[postId][type]) {
              if (!notifications[postId][type][notifId].read) {
                unreadCount++;
              }
            }
          }
        }

        profileContainer.innerHTML = `
          <div class="profile-header">
            <img src="${user.photoURL || 'https://www.gravatar.com/avatar?d=mp'}" alt="${user.username} avatar"/>
            <div class="profile-username-container">
              <h2>${user.username || 'Anonymous'}${user.isVerified ? '<span class="verified-icon"><svg viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></span>' : ''}</h2>
              <p>${user.bio || 'No bio available.'}</p>
            </div>
            <p>${Object.keys(posts).filter(id => posts[id].userId === currentUserUid).length} posts  ${Object.keys(followers).length} followers  ${Object.keys(following).length} following</p>
            <button class="edit-profile-btn">Edit Profile</button>
            <button id="notification-btn" class="profile-action-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
              </svg>
              ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
            </button>
            <button id="settings-btn" class="profile-action-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </button>
          </div>
          <div class="profile-content">
            ${Object.entries(posts)
              .filter(([id, post]) => post.userId === currentUserUid)
              .map(([id, post]) => `
                <div class="post">
                  <img src="${post.imageURLs[0]}" class="post-image" alt="Post image"/>
                </div>
              `).join('')}
          </div>
        `;

        profileContainer.querySelector(".edit-profile-btn").addEventListener("click", () => {
          editUsername.value = user.username || "";
          editBio.value = user.bio || "";
          editPhoto.value = "";
          editProfileModal.classList.remove("hidden");
          editProfileModal.classList.add("open");
          hideError(editProfileError);
        });

        profileContainer.querySelector("#notification-btn").addEventListener("click", () => {
          console.log("Navigating to notifications");
          location.href = "notifications.html";
          pauseAllMedia();
        });

        profileContainer.querySelector("#settings-btn").addEventListener("click", () => {
          console.log("Navigating to settings");
          location.href = "settings.html";
          pauseAllMedia();
        });

        profileContainer.querySelectorAll(".post").forEach(postElement => {
          postElement.addEventListener("click", () => {
            const postId = Object.keys(posts).find(id => posts[id].imageURLs[0] === postElement.querySelector("img").src && posts[id].userId === currentUserUid);
            console.log("Navigating to post:", postId);
            location.href = `post.html?postId=${postId}`;
            pauseAllMedia();
          });
        });
      } catch (error) {
        console.error("Error loading profile:", error.message);
        profileContainer.innerHTML = `<p class="error">Failed to load profile: ${error.message}</p>`;
      } finally {
        hideLoading();
      }
    }

    async function showDeletePostModal(postId) {
      const deletePostModal = document.getElementById("delete-post-modal");
      const deletePostConfirm = document.getElementById("delete-post-confirm");
      const deletePostCancel = document.getElementById("delete-post-cancel");
      const deletePostClose = document.getElementById("delete-post-close");

      deletePostModal.classList.remove("hidden");
      deletePostModal.classList.add("open");

      deletePostConfirm.onclick = async () => {
        showLoading();
        try {
          await set(ref(db, `posts/${postId}`), null);
          deletePostModal.classList.remove("open");
          deletePostModal.classList.add("hidden");
          await loadPosts();
        } catch (error) {
          console.error("Error deleting post:", error.message);
          alert(`Failed to delete post: ${error.message}`);
        } finally {
          hideLoading();
        }
      };

      deletePostCancel.onclick = () => {
        deletePostModal.classList.remove("open");
        deletePostModal.classList.add("hidden");
      };

      deletePostClose.onclick = () => {
        deletePostModal.classList.remove("open");
        deletePostModal.classList.add("hidden");
      };
    }
  </script>
</body>
</html>
