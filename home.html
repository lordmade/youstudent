<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>BanterBox - Home</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
:root {
  --primary-red: #e0245e;
  --text-dark: #1a1a1a;
  --text-light: #657786;
  --border: #e1e8ed;
  --background: #ffffff;
  --background-secondary: #f7f9fa;
  --hover: #f5f5f5;
  --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.15);
  --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: var(--font-family);
  background-color: var(--background);
  color: var(--text-dark);
  line-height: 1.5;
  max-width: 100%;
  overflow-x: hidden;
}

/* Tab Navigation */
.tab-nav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-around;
  align-items: center;
  background-color: var(--background);
  border-bottom: 1px solid var(--border);
  padding: 12px 0;
  z-index: 1000;
  box-shadow: var(--shadow);
}

.tab-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: none;
  border: none;
  color: var(--text-light);
  cursor: pointer;
  padding: 8px;
  transition: color 0.2s ease, background-color 0.2s ease;
}

.tab-btn svg {
  width: 24px;
  height: 24px;
}

.tab-btn.active {
  color: var(--primary-red);
  font-weight: 600;
}

.tab-btn:hover {
  color: var(--primary-red);
  background-color: var(--hover);
  border-radius: 50%;
}

.tab-btn span {
  font-size: 12px;
  margin-top: 4px;
}

/* Container and Tabs */
.container {
  max-width: 600px;
  margin: 0 auto;
  padding: 16px;
  padding-top: 60px; /* Space for top nav */
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* Home Tab */
#home {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.stories-container {
  display: flex;
  overflow-x: auto;
  padding: 12px;
  background-color: var(--background-secondary);
  gap: 12px;
  border-radius: 12px;
  margin-bottom: 12px;
}

.story-card {
  flex: 0 0 auto;
  width: 80px;
  text-align: center;
  cursor: pointer;
  position: relative;
}

.story-card img {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid var(--primary-red);
}

.story-card.viewed img {
  border-color: var(--text-light);
}

.story-card .username,
.story-card p {
  font-size: 12px;
  color: var(--text-dark);
  margin-top: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

#add-story-card {
  position: relative;
}

#add-story-card .relative {
  background-color: var(--background);
  border: 2px dashed var(--text-light);
}

#add-story-card svg {
  width: 24px;
  height: 24px;
}

#story-viewer {
  background: rgba(0, 0, 0, 0.95);
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 2000;
}

#story-progress {
  height: 4px;
  background: var(--primary-red);
}

.story-content img,
.story-content video {
  width: 100%;
  height: 100%;
  max-height: 80vh;
  object-fit: contain;
}

#story-username {
  font-size: 14px;
  font-weight: 600;
  color: white;
}

#story-close,
#story-prev,
#story-next {
  transition: opacity 0.2s ease;
}

#story-close:hover,
#story-prev:hover,
#story-next:hover {
  opacity: 0.8;
}

/* Post Cards */
.post {
  background: var(--background);
  border: 1px solid var(--border);
  border-radius: 16px;
  margin-bottom: 12px;
  padding: 12px;
  box-shadow: var(--shadow);
  transition: transform 0.2s ease;
}

.post:hover {
  transform: translateY(-2px);
}

.post-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.post-header img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
}

.user-info {
  flex-grow: 1;
}

.user-info span {
  display: block;
  font-size: 15px;
  font-weight: 600;
}

.user-info .timestamp {
  font-size: 13px;
  color: var(--text-light);
}

.verified-icon {
  display: inline-block;
  width: 16px;
  height: 16px;
  margin-left: 4px;
  vertical-align: middle;
}

.verified-icon svg {
  fill: var(--primary-red);
}

.post-image-container img {
  width: 100%;
  border-radius: 12px;
  object-fit: cover;
  max-height: 400px;
  margin-top: 8px;
}

.post-image-carousel {
  position: relative;
}

.carousel-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0, 0, 0, 0.5);
  border: none;
  border-radius: 50%;
  padding: 8px;
  cursor: pointer;
  color: white;
}

.carousel-arrow.left {
  left: 8px;
}

.carousel-arrow.right {
  right: 8px;
}

.carousel-indicators {
  position: absolute;
  bottom: 8px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 4px;
}

.carousel-indicator {
  width: 8px;
  height: 8px;
  background: var(--text-light);
  border-radius: 50%;
}

.carousel-indicator.active {
  background: var(--primary-red);
}

.post-actions {
  display: flex;
  gap: 24px;
  margin: 12px 0;
  justify-content: space-between;
}

.post-actions button {
  display: flex;
  align-items: center;
  gap: 4px;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-light);
  font-size: 14px;
  transition: color 0.2s ease, transform 0.2s ease;
}

.post-actions button:hover {
  color: var(--primary-red);
  transform: scale(1.1);
}

.post-actions svg {
  width: 20px;
  height: 20px;
}

.like-count,
.comment-count {
  font-size: 13px;
}

.emoji-group {
  display: inline-flex;
  gap: 2px;
}

.post-caption {
  font-size: 15px;
  margin: 8px 0;
  line-height: 1.4;
}

.post-caption strong {
  font-weight: 600;
}

.song-display {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--text-light);
  margin-top: 8px;
}

.post-footer {
  margin-top: 8px;
}

.post-follow-btn {
  background: var(--primary-red);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 6px 12px;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.post-follow-btn.following {
  background: var(--text-light);
  color: var(--text-dark);
}

.post-follow-btn:hover {
  background: #c91e4e;
}

.reaction-popup {
  display: flex;
  gap: 8px;
  padding: 8px;
  background: var(--background);
  border-radius: 24px;
  box-shadow: var(--shadow-lg);
  position: absolute;
  z-index: 1000;
  transform: translateY(-100%);
  opacity: 0;
  transition: opacity 0.2s ease, transform 0.2s ease;
}

.reaction-popup.active {
  opacity: 1;
  transform: translateY(-110%);
}

.reaction-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 20px;
  padding: 4px;
}

.reaction-btn:hover {
  transform: scale(1.2);
}

/* Friends Tab */
.sub-tab-nav {
  display: flex;
  justify-content: space-around;
  border-bottom: 1px solid var(--border);
  margin-bottom: 16px;
}

.sub-tab-btn {
  background: none;
  border: none;
  padding: 12px;
  font-size: 15px;
  color: var(--text-light);
  cursor: pointer;
  position: relative;
  transition: color 0.2s ease;
}

.sub-tab-btn.active {
  color: var(--primary-red);
  font-weight: 600;
}

.sub-tab-btn.active::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  right: 0;
  height: 2px;
  background: var(--primary-red);
}

.friend-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 12px;
  margin-bottom: 12px;
  background: var(--background);
  box-shadow: var(--shadow);
  transition: transform 0.2s ease;
}

.friend-item:hover {
  transform: translateY(-2px);
}

.friend-item img {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  object-fit: cover;
}

.friend-item span {
  flex-grow: 1;
  font-size: 15px;
  font-weight: 600;
}

.friend-item-btn {
  background: var(--primary-red);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 6px 12px;
  font-size: 14px;
  cursor: pointer;
}

.friend-item-btn.following,
.friend-item-btn.message {
  background: var(--text-light);
  color: var(--text-dark);
}

.friend-item-btn:hover {
  background: #c91e4e;
}

.friend-info {
  display: flex;
  flex-direction: column;
}

.status,
.last-message-timestamp {
  font-size: 13px;
  color: var(--text-light);
}

.unread-badge {
  background: var(--primary-red);
  color: white;
  border-radius: 12px;
  padding: 2px 8px;
  font-size: 12px;
}

/* Search Tab */
#search-container {
  background: var(--background);
  border-radius: 12px;
  padding: 16px;
}

.category-buttons {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  overflow-x: auto;
}

.category-buttons a {
  background: var(--background-secondary);
  color: var(--text-dark);
  padding: 8px 16px;
  border-radius: 20px;
  text-decoration: none;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
  border: 1px solid var(--border);
}

.category-buttons a:hover {
  background: var(--primary-red);
  color: white;
}

.search-input-container {
  display: flex;
  align-items: center;
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 8px;
  background: var(--background-secondary);
  margin-bottom: 16px;
}

#search-input {
  flex-grow: 1;
  border: none;
  background: transparent;
  font-size: 15px;
  color: var(--text-dark);
}

#search-input:focus {
  outline: none;
}

#search-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-light);
}

#search-results .post {
  padding: 0;
  border: none;
}

/* Reels Tab */
#reels-container {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

#reels-container .post {
  border-radius: 16px;
  overflow: hidden;
}

#reels-container .post-image-container img {
  max-height: 600px;
  object-fit: cover;
}

#reels-container .loading {
  text-align: center;
  color: var(--text-light);
}

/* Profile Tab */
.profile-container {
  background: var(--background);
  border-radius: 12px;
  box-shadow: var(--shadow);
}

.profile-header {
  position: relative;
}

.cover-image img {
  width: 100%;
  height: 150px;
  object-fit: cover;
  border-radius: 12px 12px 0 0;
}

.profile-details {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  padding: 16px;
}

.profile-pic-container {
  position: relative;
  margin-top: -50px;
}

.profile-pic {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid var(--background);
}

.profile-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.notifications-btn,
.edit-profile-btn {
  background: var(--primary-red);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 6px 12px;
  font-size: 14px;
  cursor: pointer;
  text-decoration: none;
}

.notifications-btn {
  padding: 6px;
}

.notifications-btn svg {
  width: 20px;
  height: 20px;
}

.notification-badge {
  background: var(--primary-red);
  color: white;
  border-radius: 50%;
  padding: 2px 6px;
  font-size: 12px;
  position: absolute;
  top: -4px;
  right: -4px;
}

.profile-info {
  padding: 16px;
}

#profile-username {
  font-size: 18px;
  font-weight: 600;
}

#profile-handle {
  font-size: 14px;
  color: var(--text-light);
}

#profile-bio {
  font-size: 14px;
  margin: 8px 0;
}

.profile-meta {
  display: flex;
  gap: 16px;
  margin: 8px 0;
  font-size: 13px;
  color: var(--text-light);
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 4px;
}

.meta-item svg {
  width: 16px;
  height: 16px;
}

.profile-stats {
  display: flex;
  gap: 16px;
  font-size: 14px;
}

.profile-stats strong {
  font-weight: 600;
}

.profile-sub-tabs {
  display: flex;
  justify-content: space-around;
  border-bottom: 1px solid var(--border);
  padding: 0 16px;
}

.profile-posts-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 2px;
}

.profile-post {
  position: relative;
  aspect-ratio: 1;
}

.profile-post img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 4px;
}

.post-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.profile-post:hover .post-overlay {
  opacity: 1;
}

.delete-post-btn {
  background: var(--primary-red);
  border: none;
  border-radius: 50%;
  padding: 8px;
  cursor: pointer;
  color: white;
}

.delete-post-btn svg {
  width: 20px;
  height: 20px;
}

/* FAB (Floating Action Button) */
.fab {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--primary-red);
  border-radius: 50%;
  padding: 12px;
  box-shadow: var(--shadow-lg);
  transition: transform 0.2s ease;
}

.fab svg {
  width: 24px;
  height: 24px;
  stroke: white;
}

.fab:hover {
  transform: scale(1.1);
}

/* Comment Sheet */
.comment-sheet {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--background);
  border-radius: 12px 12px 0 0;
  box-shadow: var(--shadow-lg);
  transform: translateY(100%);
  transition: transform 0.3s ease;
  max-height: 80vh;
  overflow-y: auto;
}

.comment-sheet.open {
  transform: translateY(0);
}

.comment-sheet-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border-bottom: 1px solid var(--border);
}

.comment-sheet-close {
  background: none;
  border: none;
  cursor: pointer;
}

.comment-sheet-close svg {
  width: 20px;
  height: 20px;
}

.comments-list {
  padding: 16px;
}

.comment-item {
  display: flex;
  gap: 12px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}

.comment-item.reply {
  margin-left: 40px;
}

.comment-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
}

.comment-content {
  flex-grow: 1;
}

.comment-username {
  font-size: 14px;
  font-weight: 600;
}

.comment-text {
  font-size: 14px;
}

.comment-time {
  font-size: 12px;
  color: var(--text-light);
}

.comment-actions {
  display: flex;
  gap: 12px;
  margin-top: 4px;
}

.comment-action-btn {
  display: flex;
  align-items: center;
  gap: 4px;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-light);
  font-size: 13px;
}

.comment-action-btn:hover {
  color: var(--primary-red);
}

.comment-reaction-popup {
  position: absolute;
  background: var(--background);
  border-radius: 24px;
  box-shadow: var(--shadow-lg);
  display: flex;
  gap: 8px;
  padding: 8px;
  z-index: 1000;
  transform: translateY(-100%);
}

.comment-reaction-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 20px;
}

.comment-reaction-btn:hover {
  transform: scale(1.2);
}

.reply-input-container {
  display: none;
  margin-top: 8px;
}

.reply-input-container.active {
  display: flex;
  gap: 8px;
}

.reply-input {
  flex-grow: 1;
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 8px 12px;
  font-size: 14px;
}

.reply-submit {
  background: var(--primary-red);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 8px 12px;
  font-size: 14px;
  cursor: pointer;
}

.comment-input-container {
  display: flex;
  gap: 8px;
  padding: 16px;
  border-top: 1px solid var(--border);
}

.comment-input {
  flex-grow: 1;
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 8px 12px;
  font-size: 14px;
}

.comment-submit {
  background: var(--primary-red);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 8px 12px;
  font-size: 14px;
  cursor: pointer;
}

.comment-submit:hover,
.reply-submit:hover {
  background: #c91e4e;
}

/* Edit Profile Modal */
.edit-profile-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.edit-profile-modal-content {
  background: var(--background);
  border-radius: 12px;
  padding: 16px;
  width: 90%;
  max-width: 400px;
}

.close-modal {
  background: none;
  border: none;
  position: absolute;
  top: 12px;
  right: 12px;
  cursor: pointer;
}

.close-modal svg {
  width: 20px;
  height: 20px;
}

.edit-profile-modal h3 {
  font-size: 18px;
  margin-bottom: 16px;
}

.edit-profile-error {
  color: var(--primary-red);
  font-size: 13px;
  margin-bottom: 8px;
  display: none;
}

.edit-profile-modal input,
.edit-profile-modal textarea {
  width: 100%;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px;
  margin-bottom: 12px;
  font-size: 14px;
}

.edit-profile-modal textarea {
  resize: vertical;
  min-height: 80px;
}

#edit-profile-save-btn {
  background: var(--primary-red);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 8px 16px;
  font-size: 14px;
  cursor: pointer;
  width: 100%;
}

#edit-profile-save-btn:hover {
  background: #c91e4e;
}

/* Delete Post Modal */
.delete-post-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.delete-post-modal .edit-profile-modal-content {
  text-align: center;
}

.delete-post-modal h3 {
  font-size: 18px;
  margin-bottom: 12px;
}

.delete-post-modal p {
  font-size: 14px;
  color: var(--text-light);
  margin-bottom: 16px;
}

#delete-post-cancel,
#delete-post-confirm {
  padding: 8px 16px;
  font-size: 14px;
  border-radius: 20px;
  cursor: pointer;
}

#delete-post-cancel {
  background: var(--text-light);
  color: var(--text-dark);
}

#delete-post-confirm {
  background: var(--primary-red);
  color: white;
}

#delete-post-cancel:hover {
  background: #d3d8dc;
}

#delete-post-confirm:hover {
  background: #c91e4e;
}

/* Loading Overlay */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

.spinner {
  border: 4px solid var(--border);
  border-top: 4px solid var(--primary-red);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (min-width: 768px) {
  .container {
    max-width: 700px;
  }

  .cover-image img {
    height: 200px;
  }

  .profile-pic {
    width: 100px;
    height: 100px;
  }

  .profile-posts-grid {
    gap: 4px;
  }
}

@media (min-width: 1024px) {
  .container {
    max-width: 800px;
    margin-left: 80px;
  }

  .tab-nav {
    width: 80px;
    flex-direction: column;
    left: 0;
    top: 0;
    bottom: 0;
    padding: 16px;
    border-right: 1px solid var(--border);
    border-bottom: none;
  }

  .tab-btn {
    padding: 12px;
  }

  .tab-btn svg {
    width: 28px;
    height: 28px;
  }
}
  </style>
</head>
<body>
  <!-- Previous HTML structure remains the same until the post rendering section -->
  <div class="tab-nav">
    <button class="tab-btn active" data-tab="home" aria-label="Home">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
      </svg>
    </button>
    <button class="tab-btn" data-tab="friends" aria-label="Friends">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 00-4-4H7a4 4 0 00-4 4v2m11-10a2 2 0 11-4 0 2 2 0 014 0zm7 7v-2a4 4 0 00-3-3.87m-4-12a4 4 0 014 4"/>
      </svg>
    </button>
    <button class="tab-btn" data-tab="search" aria-label="Search">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <path d="M21 21l-4.35-4.35"/>
      </svg>
    </button>
    <button class="tab-btn" data-tab="reels" aria-label="Reels">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="4" y="4" width="16" height="16" rx="2"/>
        <path d="M10 8v8l6-4-6-4z"/>
      </svg>
      <span class="text-sm font-semibold">Watch Reels</span>
    </button>
    <button class="tab-btn" data-tab="profile" aria-label="Profile">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 4a6 6 0 110 12 6 6 0 010-12zm0 2a4 4 0 100 8 4 4 0 000-8z"/>
      </svg>
    </button>
  </div>

  <div class="container">
    <div id="home" class="tab-content active">
      <div id="stories-container" class="flex overflow-x-auto space-x-4 p-4 bg-gray-100 stories-container">
        <a href="upload.html" id="add-story-card" class="story-card flex-shrink-0 w-20 text-center cursor-pointer" aria-label="Add new story">
          <div class="relative w-16 h-16 mx-auto rounded-full border-2 border-gray-300 bg-gray-200 flex items-center justify-center">
            <svg viewBox="0 0 24 24" class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14m-7-7h14"/>
            </svg>
            <img id="add-story-img" src="https://www.gravatar.com/avatar?d=mp" alt="Your avatar" class="absolute inset-0 w-full h-full rounded-full object-cover opacity-50">
          </div>
          <p class="text-sm mt-1 truncate text-gray-800">Your Story</p>
        </a>
      </div>
      <div id="story-viewer" class="hidden fixed inset-0 bg-black z-50 flex items-center justify-center">
        <div class="relative w-full max-w-md h-screen">
          <div class="absolute top-0 left-0 right-0 h-1 bg-gray-800 z-10">
            <div id="story-progress" class="h-full bg-[var(--primary-red)]" style="width: 0%; transition: width linear;"></div>
          </div>
          <button id="story-close" class="absolute top-4 right-4 text-white">
            <svg viewBox="0 0 24 24" class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
          <div id="story-content" class="w-full h-full max-h-[80vh] bg-black story-content"></div>
          <div class="absolute bottom-4 left-4 text-white bg-black bg-opacity-50 px-2 py-1 rounded">
            <span id="story-username"></span>
          </div>
          <button id="story-prev" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white">
            <svg viewBox="0 0 24 24" class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18l-6-6 6-6"/>
            </svg>
          </button>
          <button id="story-next" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white">
            <svg viewBox="0 0 24 24" class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 18l6-6-6-6"/>
            </svg>
          </button>
        </div>
      </div>
      <div id="posts-container">
        <div class="loading">Loading posts...</div>
      </div>
    </div>
      
    <div id="friends" class="tab-content">
      <div class="sub-tab-nav">
        <button class="sub-tab-btn active" data-sub-tab="friends-list" aria-label="Friends">Friends</button>
        <button class="sub-tab-btn" data-sub-tab="followers-list" aria-label="Followers">Followers</button>
        <button class="sub-tab-btn" data-sub-tab="following-list" aria-label="Following">Following</button>
      </div>
      <div id="friends-container" class="sub-tab-content active" data-sub-tab="friends-list">
        <div class="loading">Loading friends...</div>
      </div>
      <div id="followers-container" class="sub-tab-content" data-sub-tab="followers-list">
        <div class="loading">Loading followers...</div>
      </div>
      <div id="following-container" class="sub-tab-content" data-sub-tab="following-list">
        <div class="loading">Loading following...</div>
      </div>
    </div>
    <div id="search" class="tab-content">
      <div id="search-container" class="p-4 bg-white">
        <div class="category-buttons flex space-x-4 mb-4 overflow-x-auto">
          <a href="ai.html" class="bg-gradient-to-r from-[#f09433] to-[#bc1888] text-white px-4 py-2 rounded-full hover:from-[#e08423] hover:to-[#ac0878] transition flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            Vynix AI.
          </a>
        </div>
        <div class="flex items-center border border-[var(--border)] rounded-full p-2">
          <input type="text" id="search-input" class="search-input bg-transparent w-full text-[var(--text-dark)] focus:outline-none placeholder-[var(--text-light)]" placeholder="Search posts by username or caption..." aria-label="Search posts" />
          <button id="search-btn" class="p-2">
            <svg class="w-6 h-6 text-[var(--text-light)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </button>
        </div>
        <div id="search-results" class="mt-4" aria-live="polite"></div>
      </div>
    </div>
    <div id="reels" class="tab-content">
      <div id="reels-container">
        <div class="loading">Loading reels...</div>
      </div>
    </div>

    
  <div id="profile" class="tab-content">
  <div id="profile-container" class="profile-container">
    <div class="profile-header">
      <div class="cover-image">
        <img src="https://via.placeholder.com/1500x500?text=Cover+Image" alt="Cover image" id="cover-image">
      </div>
     <div class="profile-details">
  <div class="profile-pic-container">
    <img src="https://www.gravatar.com/avatar?d=mp" alt="User avatar" class="profile-pic" id="profile-pic">
  </div>
  <div class="profile-actions">
    <button id="notifications-btn" class="notifications-btn" aria-label="View notifications">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9m-4 11a2 2 0 01-4 0"/>
      </svg>
    </button>
    <a href="add-profile.html" id="edit-profile-btn" class="edit-profile-btn" aria-label="Edit profile">Edit profile</a>
  </div>
  <!-- Rest of .profile-details -->
</div>
        <div class="profile-info">
          <h1 id="profile-username">Username</h1>
          <span id="profile-handle">@username</span>
          <p id="profile-bio" class="bio">No bio yet.</p>
          <div class="profile-meta">
            <span id="profile-location" class="meta-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2a7 7 0 00-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 00-7-7z"/>
              </svg>
              Location
            </span>
            <span id="profile-joined" class="meta-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 2h12v4H6zM3 6h18v16H3z"/>
              </svg>
              Joined
            </span>
          </div>
          <div class="profile-stats">
            <span><strong id="post-count">0</strong> Posts</span>
            <span><strong id="followers-count">0</strong> Followers</span>
            <span><strong id="following-count">0</strong> Following</span>
          </div>
        </div>
      </div>
      <div class="profile-sub-tabs">
        <button class="sub-tab-btn active" data-sub-tab="profile-posts" aria-label="Posts">Posts</button>
        <button class="sub-tab-btn" data-sub-tab="profile-followers" aria-label="Followers">Followers</button>
        <button class="sub-tab-btn" data-sub-tab="profile-following" aria-label="Following">Following</button>
      </div>
      <div id="profile-posts" class="sub-tab-content active" data-sub-tab="profile-posts">
        <div class="profile-posts-grid"></div>
      </div>
      <div id="profile-followers" class="sub-tab-content" data-sub-tab="profile-followers">
        <div class="loading">Loading followers...</div>
      </div>
      <div id="profile-following" class="sub-tab-content" data-sub-tab="profile-following">
        <div class="loading">Loading following...</div>
      </div>
    </div>
  </div>
</div>

  <a href="upload.html" class="fab" aria-label="Upload new media">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <path d="M12 5v14m7-7H5"/>
    </svg>
  </a>

  <div id="comment-sheet" class="comment-sheet hidden">
    <div class="comment-sheet-header">
      <h3 class="text-base font-semibold">Comments</h3>
      <button id="comment-sheet-close" class="comment-sheet-close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div id="comments-list" class="comments-list" aria-live="polite" aria-relevant="additions"></div>
    <div class="comment-input-container">
      <input id="comment-input" type="text" class="comment-input" placeholder="Add a comment..."/>
      <button id="comment-submit" class="comment-submit">Post</button>
    </div>
  </div>

 <div id="edit-profile-modal" class="edit-profile-modal hidden">
  <div class="edit-profile-modal-content">
    <button class="close-modal" aria-label="Close edit profile modal">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>Edit Profile</h3>
    <div class="error edit-profile-error" id="edit-profile-error"></div>
    <input type="text" id="edit-username" placeholder="Username" aria-label="Edit username"/>
    <textarea id="edit-bio" placeholder="Bio" aria-label="Edit bio"></textarea>
    <input type="text" id="edit-location" placeholder="Location" aria-label="Edit location"/>
    <input type="file" id="edit-photo" accept="image/*" aria-label="Upload profile photo"/>
    <input type="file" id="edit-cover-photo" accept="image/*" aria-label="Upload cover photo"/>
    <button id="edit-profile-save-btn">Save</button>
  </div>
</div>
  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="spinner"></div>
  </div>

  <div id="delete-post-modal" class="edit-profile-modal hidden">
    <div class="edit-profile-modal-content">
      <button id="delete-post-close" class="close-modal">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      <h3>Delete Post</h3>
      <p>Are you sure you want to delete this post? This action cannot be undone.</p>
      <div class="flex justify-end gap-2 mt-4">
        <button id="delete-post-cancel" class="post-follow-btn">Cancel</button>
        <button id="delete-post-confirm" class="post-follow-btn follow">Delete</button>
      </div>
    </div>
  </div>

<script type="module">  
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
import { getDatabase, ref, onValue, query, orderByChild, limitToLast, set, get, push, update } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.appspot.com",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getDatabase();

let currentUserUid = null;
const commentSheet = document.getElementById("comment-sheet");
const commentSheetClose = document.getElementById("comment-sheet-close");
const commentsList = document.getElementById("comments-list");
const commentInput = document.getElementById("comment-input");
const commentSubmit = document.getElementById("comment-submit");
const loadingOverlay = document.getElementById("loading-overlay");
const editProfileModal = document.getElementById("edit-profile-modal");
const editProfileSaveBtn = document.getElementById("edit-profile-save-btn");
const editProfileCloseBtn = document.querySelector("#edit-profile-modal .close-modal");
const editUsername = document.getElementById("edit-username");
const editBio = document.getElementById("edit-bio");
const editPhoto = document.getElementById("edit-photo");
const editProfileError = document.getElementById("edit-profile-error");
const deletePostModal = document.getElementById("delete-post-modal");
const deletePostClose = document.getElementById("delete-post-close");
const deletePostCancel = document.getElementById("delete-post-cancel");
const deletePostConfirm = document.getElementById("delete-post-confirm");
let currentPostId = null;
let currentPlayingAudio = null;
let currentDeletePostId = null;
let currentDeletePostElement = null;
let currentReplyCommentId = null;
const REACTION_TYPES = ['like', 'love', 'haha', 'wow', 'sad', 'angry'];
const CLOUDINARY_UPLOAD_PRESET = "banter_box";
const CLOUDINARY_CLOUD_NAME = "dqkujefxj";
const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

// Utility Functions
function showLoading() { loadingOverlay.classList.remove("hidden"); }
function hideLoading() { loadingOverlay.classList.add("hidden"); }

function showError(element, message) {
  element.textContent = message;
  element.style.display = "block";
}

function hideError(element) {
  element.textContent = "";
  element.style.display = "none";
}

function pauseAllMedia(exceptAudioId = null) {
  document.querySelectorAll('audio, video').forEach(media => {
    if (media.id !== exceptAudioId && !media.paused) {
      media.pause();
      media.currentTime = 0;
    }
  });
  currentPlayingAudio = exceptAudioId ? document.getElementById(exceptAudioId) : null;
}

function timeAgo(timestamp) {
  if (!timestamp) return "";
  const now = Date.now();
  const diff = now - timestamp;
  if (diff < 60000) return "just now";
  if (diff < 3600000) return Math.floor(diff / 60000) + "m ago";
  if (diff < 86400000) return Math.floor(diff / 3600000) + "h ago";
  return Math.floor(diff / 86400000) + "d ago";
}

// Tab Navigation
let activeTab = 'home';
const tabBtns = document.querySelectorAll(".tab-btn");
const tabs = document.querySelectorAll(".tab-content");
const fab = document.querySelector('.fab');
let debounceTimeout;

function switchTab(tabId) {
  if (activeTab === tabId || debounceTimeout) return;
  
  // Debounce to prevent rapid clicks
  debounceTimeout = setTimeout(() => { debounceTimeout = null; }, 300);
  showLoading();

  // Update tab states with smooth transition
  tabBtns.forEach(btn => {
    const isActive = btn.dataset.tab === tabId;
    btn.classList.toggle("active", isActive);
    btn.setAttribute("aria-selected", isActive);
    btn.tabIndex = isActive ? 0 : -1;
  });

  tabs.forEach(tab => {
    const isActive = tab.id === tabId;
    tab.classList.toggle("active", isActive);
    tab.style.opacity = isActive ? '1' : '0';
    tab.style.transform = isActive ? 'translateY(0)' : 'translateY(20px)';
    tab.setAttribute('aria-hidden', !isActive);
  });

  // Update FAB behavior
  if (tabId === 'profile') {
    fab.setAttribute('href', 'add-profile.html');
    fab.setAttribute('aria-label', 'Edit Profile');
  } else if (tabId === 'home' || tabId === 'reels') {
    fab.setAttribute('href', 'upload.html');
    fab.setAttribute('aria-label', 'Create Post');
  } else {
    fab.removeAttribute('href');
    fab.setAttribute('aria-label', 'Create Post');
    fab.onclick = () => {
      // Placeholder for post creation modal
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <h3>Create a Post</h3>
          <textarea placeholder="What's on your mind?"></textarea>
          <button class="modal-close">Close</button>
        </div>
      `;
      document.body.appendChild(modal);
      modal.querySelector('.modal-close').onclick = () => modal.remove();
    };
  }

  activeTab = tabId;
  pauseAllMedia();

  // Load content for active tab
  switch (tabId) {
    case 'home':
      loadStories();
      loadPosts();
      break;
    case 'friends':
      loadFriends();
      break;
    case 'search':
      loadSearch();
      break;
    case 'reels':
      loadReels();
      break;
    case 'profile':
      loadProfile();
      break;
  }
}

// Setup tab navigation with keyboard support
tabBtns.forEach(btn => {
  btn.addEventListener("click", (e) => {
    e.preventDefault();
    switchTab(btn.dataset.tab);
    btn.focus();
  });
  btn.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      switchTab(btn.dataset.tab);
      btn.focus();
    }
  });
});

// Initialize tabs
document.addEventListener('DOMContentLoaded', () => {
  const defaultTab = document.querySelector('.tab-btn.active')?.dataset.tab || 'home';
  switchTab(defaultTab);
});

// Reels Tab Content
async function loadReels() {
  const reelsContainer = document.getElementById("reels-container");
  reelsContainer.innerHTML = '<div class="loading">Loading reels...</div>';
  showLoading();

  try {
    const postsSnap = await Promise.race([
      get(query(ref(db, "posts"), orderByChild("timestamp"), limitToLast(50))),
      new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout loading reels")), 10000))
    ]);
    const usersSnap = await get(ref(db, "users"));
    const posts = postsSnap.val() || {};
    const users = usersSnap.val() || {};

    reelsContainer.innerHTML = "";
    const videoPosts = Object.entries(posts)
      .filter(([_, post]) => post.videoUrl || (post.imageUrls && post.imageUrls.some(url => url.includes('.mp4'))))
      .map(([id, post]) => ({ id, ...post }))
      .sort((a, b) => b.timestamp - a.timestamp);

    if (videoPosts.length === 0) {
      reelsContainer.innerHTML = '<div class="placeholder">No reels available.</div>';
      hideLoading();
      return;
    }

    videoPosts.forEach(post => {
      const userData = users[post.userId] || { username: "Unknown", photoURL: "https://www.gravatar.com/avatar?d=mp" };
      const mediaUrl = post.videoUrl || post.imageUrls.find(url => url.includes('.mp4'));
      const postElement = document.createElement("div");
      postElement.className = "post reel";
      postElement.id = `reel-${post.id}`;
      postElement.innerHTML = `
        <div class="post-header">
          <img src="${userData.photoURL}" alt="${userData.username} avatar">
          <div class="user-info">
            <span>${userData.username}</span>
            <span class="timestamp">${timeAgo(post.timestamp)}</span>
          </div>
        </div>
        <div class="post-image-container">
          <video src="${mediaUrl}" controls autoplay muted loop class="reel-video"></video>
        </div>
        <div class="post-actions">
          <button class="like-btn" data-post-id="${post.id}">
            <span class="reaction-display">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-500">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
              </svg>
            </span>
            <span class="like-count">${post.likes || 0}</span>
          </button>
          <button class="comment-btn" aria-label="Comment on reel">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 11.5a8.5 8.5 0 01-11.4 7.9l-4.6 1.5 1.5-4.6A8.5 8.5 0 1121 11.5z"/>
            </svg>
            <span class="comment-count">${Object.keys(post.comments || {}).length}</span>
          </button>
        </div>
        ${post.caption ? `<div class="post-caption">${post.caption}</div>` : ''}
      `;
      reelsContainer.appendChild(postElement);

      postElement.querySelector(".like-btn").addEventListener("click", (e) => {
        e.stopPropagation();
        toggleReaction(post.id, 'like', e.target);
      });

      postElement.querySelector(".comment-btn").addEventListener("click", (e) => {
        e.stopPropagation();
        showCommentSheet(post.id);
      });

      postElement.querySelector(".reel-video").addEventListener("play", () => {
        pauseAllMedia(`reel-${post.id}`);
      });
    });
  } catch (error) {
    console.error("Error loading reels:", error.message);
    reelsContainer.innerHTML = `<p class="error">Failed to load reels: ${error.message}</p>`;
  } finally {
    hideLoading();
  }
}

// Reaction Handling (unchanged for brevity)
function createReactionPopup(postId) {
  const reactionEmojis = { like: '👍', love: '❤️', haha: '😂', wow: '😮', sad: '😢', angry: '😣' };
  return `
    <div class="reaction-popup hidden absolute bottom-16 left-1/2 transform -translate-x-1/2 bg-white dark:bg-gray-800 rounded-full shadow-lg flex p-2 space-x-2 z-50" data-post-id="${postId}">
      ${REACTION_TYPES.map(type => `
        <button class="reaction-btn" data-reaction="${type}" title="${type.charAt(0).toUpperCase() + type.slice(1)}">
          <span class="text-2xl">${reactionEmojis[type]}</span>
        </button>
      `).join('')}
    </div>
  `;
}

async function toggleReaction(postId, reactionType, button) {
  const userId = currentUserUid;
  const postRef = ref(db, `posts/${postId}`);
  const likeCountSpan = button.closest('.post-actions').querySelector(".like-count");
  const reactionDisplay = button.closest('.post-actions').querySelector(".reaction-display");

  showLoading();
  try {
    const snapshot = await get(postRef);
    const post = snapshot.val() || {};
    const reactions = post.reactions || {};
    let userReactions = Array.isArray(reactions[userId]) ? reactions[userId] : [];
    const currentLikes = post.likes || 0;

    let updatedReactions, updatedLikes, updatedLikedBy;
    if (userReactions.includes(reactionType)) {
      updatedReactions = { ...reactions, [userId]: userReactions.filter(r => r !== reactionType) };
      if (updatedReactions[userId].length === 0) delete updatedReactions[userId];
      updatedLikes = currentLikes - 1;
      updatedLikedBy = (post.likedBy || []).filter(id => id !== userId);
    } else {
      updatedReactions = { ...reactions, [userId]: [reactionType] };
      updatedLikes = post.likedBy?.includes(userId) ? currentLikes : currentLikes + 1;
      updatedLikedBy = post.likedBy?.includes(userId) ? post.likedBy : [...(post.likedBy || []), userId];
    }

    await update(postRef, { reactions: updatedReactions, likes: updatedLikes, likedBy: updatedLikedBy });

    const reactionCounts = {};
    REACTION_TYPES.forEach(type => {
      reactionCounts[type] = Object.values(updatedReactions).filter(r => Array.isArray(r) && r.includes(type)).length;
    });
    const totalReactions = Object.values(reactionCounts).reduce((sum, count) => sum + count, 0);
    const activeReactions = REACTION_TYPES.filter(type => reactionCounts[type] > 0);
    const reactionEmojis = { like: '👍', love: '❤️', haha: '😂', wow: '😮', sad: '😢', angry: '😣' };
    likeCountSpan.innerHTML = `
      <span class="emoji-group">
        ${activeReactions.map(type => `<span>${reactionEmojis[type]}</span>`).join('')}
      </span>
      ${totalReactions || ''}
    `;
    reactionDisplay.innerHTML = userReactions.includes(reactionType) ?
      `<span class="text-2xl">${reactionEmojis[reactionType]}</span>` :
      `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="${updatedLikes > 0 && updatedLikedBy.includes(userId) ? 'text-red-500' : 'text-gray-500'}">
          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
        </svg>
      `;

    if (post.userId !== userId && !userReactions.includes(reactionType)) {
      const notifRef = push(ref(db, `notifications/${post.userId}/${postId}/reactions`));
      await set(notifRef, { type: 'reaction', reactionType, userId: currentUserUid, timestamp: Date.now(), read: false });
    }
  } catch (error) {
    console.error("Error updating reaction:", error.message);
    showError(document.getElementById(`post-${postId}`), "Failed to update reaction.");
  } finally {
    hideLoading();
  }
}

function setupReactionClick(button, postId) {
  button.addEventListener('click', (e) => {
    e.stopPropagation();
    const existingPopup = document.querySelector(`.reaction-popup[data-post-id="${postId}"]`);
    if (existingPopup && existingPopup.classList.contains('open')) {
      existingPopup.classList.remove('open');
      setTimeout(() => existingPopup.remove(), 300);
    } else {
      const postElement = document.getElementById(`post-${postId}`);
      postElement.insertAdjacentHTML('beforeend', createReactionPopup(postId));
      const popup = postElement.querySelector(`.reaction-popup[data-post-id="${postId}"]`);
      popup.classList.remove('hidden');
      popup.classList.add('open');
      popup.querySelectorAll('.reaction-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleReaction(postId, btn.dataset.reaction, button);
          popup.classList.remove('open');
          setTimeout(() => popup.remove(), 300);
        });
      });
    }
  });
}

// Other functions (unchanged for brevity but included for context)
async function loadStories() {
  const storiesContainer = document.getElementById("stories-container");
  const storiesRef = query(ref(db, "stories"), orderByChild("timestamp"), limitToLast(20));

  showLoading();
  try {
    const [storiesSnap, usersSnap] = await Promise.all([
      get(storiesRef),
      get(ref(db, "users"))
    ]);

    const storiesData = storiesSnap.val() || {};
    const users = usersSnap.val() || {};

    const storiesByUser = {};
    Object.entries(storiesData).forEach(([id, story]) => {
      if (story.userId && (story.imageUrl || story.videoUrl) && story.timestamp && (!story.expiresAt || story.expiresAt > Date.now())) {
        if (!storiesByUser[story.userId]) {
          storiesByUser[story.userId] = [];
        }
        storiesByUser[story.userId].push({
          id,
          ...story,
          mediaUrl: story.imageUrl || story.videoUrl,
          thumbnailUrl: story.thumbnailUrl || story.imageUrl || story.videoUrl,
          mediaType: story.videoUrl ? "video" : "image"
        });
      }
    });

    Object.values(storiesByUser).forEach(userStories => {
      userStories.sort((a, b) => b.timestamp - a.timestamp);
    });

    storiesContainer.innerHTML = `
      <a href="upload.html" id="add-story-card" class="story-card" aria-label="Add new story">
        <img src="${users[currentUserUid]?.photoURL || 'https://www.gravatar.com/avatar?d=mp'}" alt="Your avatar" />
        <span class="username">Your Story</span>
      </a>
    `;

    if (Object.keys(storiesByUser).length === 0) {
      storiesContainer.insertAdjacentHTML("beforeend", '<div class="placeholder">No stories available.</div>');
      hideLoading();
      return;
    }

    for (const userId in storiesByUser) {
      const userStories = storiesByUser[userId];
      const userData = users[userId] || { username: "Unknown", photoURL: "https://www.gravatar.com/avatar?d=mp", uid: userId };
      const thumbnailStory = userStories[0];
      const isAllViewed = userStories.every(story => story.viewedBy?.includes(currentUserUid));
      const storyCard = document.createElement("div");
      storyCard.className = `story-card ${thumbnailStory.mediaType === "video" ? "video" : ""} ${isAllViewed ? "viewed" : "unviewed"}`;
      storyCard.dataset.userId = userId;
      storyCard.setAttribute("aria-label", `View ${userData.username}'s ${thumbnailStory.mediaType} story`);
      storyCard.innerHTML = `
        <img src="${thumbnailStory.thumbnailUrl || thumbnailStory.mediaUrl || userData.photoURL}" alt="${userData.username}'s story" />
        <span class="username">${userData.username}</span>
        <span class="story-count-badge">${userStories.length}</span>
      `;
      storyCard.addEventListener("click", () => showStoryViewer(userStories, userData));
      storiesContainer.appendChild(storyCard);
    }
  } catch (error) {
    console.error("Error loading stories:", error.message);
    storiesContainer.innerHTML = `<div class="error">Failed to load stories: ${error.message}</div>`;
  } finally {
    hideLoading();
  }
}

// Other functions like loadPosts, loadFriends, loadSearch, loadProfile, etc., remain unchanged for brevity

onAuthStateChanged(auth, (user) => {
  if (!user) {
    location.href = "index.html";
  } else {
    currentUserUid = user.uid;
    switchTab(activeTab); // Load content for the active tab
  }
});
</script>
      
</body>
</html>
