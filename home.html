<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>BanterBox - Home</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    
:root {
  --primary-red: #ed4956;
  --background: #fafafa;
  --border: #dbdbdb;
  --text-dark: #262626;
  --text-light: #8e8e8e;
  --white: #ffffff;
  --gradient: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
}

* {
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  touch-action: manipulation;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  background: var(--background);
  min-height: 100vh;
  margin: 0;
  overflow-x: hidden;
}

.container {
  max-width: 614px;
  margin: 0 auto;
  padding: 0 1rem;
}

/* Tab Navigation */
.tab-nav {
  position: sticky;
  top: 0;
  background: var(--white);
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-around;
  padding: 0.75rem 0;
  z-index: 10;
}

.tab-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-dark);
  padding: 0.5rem;
  transition: transform 0.2s ease, color 0.2s ease;
}

.tab-btn:hover {
  transform: scale(1.1);
}

.tab-btn.active {
  color: var(--primary-red);
}

.tab-btn.active::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 50%;
  transform: translateX(-50%);
  width: 24px;
  height: 2px;
  background: var(--primary-red);
}

.tab-btn svg {
  width: 24px;
  height: 24px;
}

.tab-content {
  display: none;
  animation: fadeIn 0.5s ease-out;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Post Styling */
.post {
  border: 1px solid var(--border);
  border-radius: 12px;
  margin-bottom: 1.5rem;
  background: var(--white);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  animation: slideUp 0.5s ease-out forwards;
}

.post:nth-child(1) { animation-delay: 0.1s; }
.post:nth-child(2) { animation-delay: 0.2s; }
.post:nth-child(3) { animation-delay: 0.3s; }

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.post-header {
  display: flex;
  align-items: center;
  padding: 0.75rem 1rem;
  gap: 0.75rem;
  flex-direction: row;
}

.post-header .user-info {
  display: flex;
  flex-direction: column;
}

.post-header .timestamp {
  font-size: clamp(0.7rem, 2.5vw, 0.75rem);
  color: var(--text-light);
  margin-top: 0.2rem;
}

.post-header img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  cursor: pointer;
  border: 2px solid var(--white);
  background: var(--gradient);
  padding: 2px;
}

.post-header span {
  font-size: clamp(0.85rem, 3vw, 0.9rem);
  color: var(--text-dark);
  font-weight: 600;
  cursor: pointer;
}

.post-image {
  width: 100%;
  aspect-ratio: 1;
  object-fit: cover;
  border-radius: 8px;
  transition: transform 0.3s ease;
}

.post-image:hover {
  transform: scale(1.02);
}

.post-actions {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem 1rem;
}

.post-actions button {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-dark);
  padding: 0.5rem;
  transition: transform 0.2s ease, color 0.2s ease;
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.post-actions .like-count {
  font-size: clamp(0.75rem, 2.5vw, 0.8rem);
  color: var(--text-dark);
}

.post-actions button:hover {
  color: var(--primary-red);
  transform: scale(1.1);
}

.post-actions .comment-btn {
  font-size: clamp(0.75rem, 2.5vw, 0.8rem);
  color: var(--text-dark);
}

.post-caption .song-display audio,
.post-caption audio {
  display: none !important;
  visibility: hidden !important;
  height: 0 !important;
  width: 0 !important;
}

.post-actions svg {
  width: 24px;
  height: 24px;
}

.like-btn .text-red-500 {
  fill: var(--primary-red);
}

.post-caption {
  padding: 0.75rem 1rem;
  font-size: clamp(0.85rem, 3vw, 0.9rem);
  color: var(--text-dark);
  line-height: 1.4;
}

.post-caption strong {
  font-weight: 600;
}

.post-caption .song-display {
  font-size: clamp(0.8rem, 2.5vw, 0.85rem);
  color: var(--text-light);
  margin-top: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
}

.post-caption .song-display audio {
  display: none;
}

.post-caption audio {
  width: 100%;
  height: 30px;
  margin-top: 0.5rem;
  border-radius: 8px;
}

/* Post Footer */
.post-footer {
  padding: 0.75rem 1rem;
  display: flex;
  justify-content: flex-end;
  border-top: 1px solid var(--border);
}

/* Follow Button in Post */
.post-follow-btn {
  padding: 0.5rem 1rem;
  border-radius: 9999px;
  font-size: clamp(0.7rem, 2.5vw, 0.75rem);
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.2s ease, color 0.2s ease;
  border: 1px solid var(--border);
  background: var(--white);
  color: var(--text-dark);
}

.post-follow-btn.follow {
  background: var(--primary-red);
  color: var(--white);
  border: none;
}

.post-follow-btn.follow:hover {
  background: #d43f4e;
  transform: scale(1.05);
}

.post-follow-btn.following {
  background: var(--white);
  color: var(--primary-red);
}

.post-follow-btn.following:hover {
  background: rgba(237, 73, 86, 0.1);
  transform: scale(1.05);
}

@media (max-width: 414px) {
  .post-follow-btn {
    padding: 0.4rem 0.8rem;
    font-size: clamp(0.65rem, 2vw, 0.7rem);
  }
}

/* Post Image Carousel */
.post-image-carousel {
  position: relative;
  width: 100%;
  aspect-ratio: 1;
  overflow: hidden;
  border-radius: 8px;
}

.post-image-container {
  display: flex;
  width: 100%;
  height: 100%;
  transition: transform 0.3s ease;
  touch-action: pan-y;
}

.post-image-container img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  flex-shrink: 0;
}

.carousel-indicators {
  position: absolute;
  bottom: 8px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 6px;
}

.carousel-indicator {
  width: 8px;
  height: 8px;
  background: var(--text-light);
  border-radius: 50%;
  opacity: 0.5;
  transition: opacity 0.3s ease, background 0.3s ease;
}

.carousel-indicator.active {
  background: var(--primary-red);
  opacity: 1;
}

.carousel-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0, 0, 0, 0.5);
  color: var(--white);
  border: none;
  padding: 0.5rem;
  cursor: pointer;
  display: none;
  z-index: 10;
}

.carousel-arrow.left {
  left: 8px;
}

.carousel-arrow.right {
  right: 8px;
}

.post-image-carousel:hover .carousel-arrow {
  display: block;
}

@media (max-width: 414px) {
  .carousel-indicators {
    bottom: 6px;
    gap: 4px;
  }

  .carousel-indicator {
    width: 6px;
    height: 6px;
  }

  .carousel-arrow {
    padding: 0.4rem;
  }
}

/* Friends, Search, Profile Tabs */
.friend-item {
  display: flex;
  align-items: center;
  padding: 0.75rem;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.2s ease;
  justify-content: space-between;
}

.friend-item:hover {
  background: rgba(237, 73, 86, 0.1);
}

.friend-item img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  margin-right: 1rem;
}

.friend-item span {
  font-size: clamp(0.85rem, 3.5vw, 0.9rem);
  color: var(--text-dark);
  font-weight: 600;
}

.search-input {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 9999px;
  font-size: clamp(0.85rem, 3.5vw, 0.9rem);
  margin-bottom: 1rem;
}

#search-results {
  padding: 1rem 0;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 0.5rem;
}

#search-results .post {
  width: 100%;
  aspect-ratio: 1;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--white);
  overflow: hidden;
  position: relative;
  cursor: pointer;
  transition: transform 0.2s ease;
  margin-bottom: 0;
}

#search-results .post:hover {
  transform: scale(1.05);
}

#search-results .post img.post-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#search-results .post-header,
#search-results .post-actions,
#search-results .post-caption,
#search-results audio {
  display: none;
}

.profile-header {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 1rem;
  text-align: center;
  border-bottom: 1px solid var(--border);
}

.profile-username-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-top: 0.5rem;
}

.profile-header img {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  margin-bottom: 0.5rem;
}

.profile-header h2 {
  font-size: clamp(1rem, 4vw, 1.1rem);
  color: var(--text-dark);
  font-weight: 600;
  margin: 0.5rem 0 0;
}

.profile-header p {
  font-size: clamp(0.85rem, 3.5vw, 0.9rem);
  color: var(--text-light);
  margin: 0.25rem 0;
}

.profile-action-btn {
  position: absolute;
  top: 0.5rem;
  background: none;
  border: none;
  color: var(--text-dark);
  cursor: pointer;
  padding: 0.5rem;
  transition: transform 0.2s ease, color 0.2s ease;
  z-index: 10;
}

.profile-action-btn:hover {
  transform: scale(1.1);
  color: var(--primary-red);
}

#notification-btn {
  right: 5.5rem;
}

#settings-btn {
  right: 3rem;
}

.profile-action-btn svg {
  width: 24px;
  height: 24px;
}

.profile-action-btn .unread-badge {
  position: absolute;
  top: -0.2rem;
  right: -0.2rem;
  background: var(--primary-red);
  color: var(--white);
  font-size: clamp(0.65rem, 2vw, 0.7rem);
  font-weight: 600;
  border-radius: 9999px;
  padding: 0.2rem 0.5rem;
  min-width: 1.2rem;
  text-align: center;
  line-height: 1;
}

.edit-profile-btn {
  background: var(--white);
  border: 1px solid var(--border);
  color: var(--primary-red);
  font-size: clamp(0.85rem, 3.5vw, 0.9rem);
  font-weight: 600;
  cursor: pointer;
  padding: 0.5rem 1rem;
  border-radius: 9999px;
  transition: background 0.2s ease, transform 0.2s ease, color 0.2s ease;
  margin-bottom: 0.5rem;
}

.edit-profile-btn:hover {
  background: var(--primary-red);
  color: var(--white);
  transform: scale(1.05);
  border: none;
}

.profile-content {
  padding: 1rem 0;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 0.5rem;
}

.profile-content .post {
  width: 100%;
  aspect-ratio: 1;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--white);
  overflow: hidden;
  position: relative;
  cursor: pointer;
  transition: transform 0.2s ease;
  margin-bottom: 0;
}

.profile-content .post:hover {
  transform: scale(1.05);
}

.profile-content .post img.post-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.profile-content .post-header,
.profile-content .post-actions,
.profile-content .post-caption,
.profile-content audio {
  display: none;
}

/* Comment Sheet */
.comment-sheet {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--white);
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
  box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2);
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  z-index: 50;
}

.comment-sheet-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  border-bottom: 1px solid var(--border);
}

.comment-sheet-close {
  background: none;
  border: none;
  color: var(--text-light);
  cursor: pointer;
}

.comment-sheet-close svg {
  width: 24px;
  height: 24px;
}

.comments-list {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.comment-item {
  display: flex;
  gap: 0.5rem;
  align-items: flex-start;
}

.comment-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
}

.comment-content {
  flex: 1;
  text-align: left;
}

.comment-username {
  font-weight: 600;
  font-size: clamp(0.75rem, 3vw, 0.8rem);
  color: var(--text-dark);
}

.comment-text {
  font-size: clamp(0.75rem, 3vw, 0.8rem);
  color: var(--text-dark);
}

.comment-time {
  font-size: clamp(0.7rem, 2.5vw, 0.75rem);
  color: var(--text-light);
}

.comment-input-container {
  padding: 1rem;
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.comment-input {
  flex: 1;
  padding: 0.5rem;
  border: 1px solid var(--border);
  border-radius: 9999px;
  font-size: clamp(0.75rem, 1vw, 0.85rem);
}

.comment-submit {
  padding: 0.5rem 1.5rem;
  border-radius: 9999px;
  background: var(--primary-red);
  color: var(--white);
  font-weight: 600;
  font-size: clamp(0.75rem, 1vw, 0.85rem);
  transition: background 0.2s ease, transform 0.2s ease;
}

.comment-submit:hover {
  background: #d43f4e;
  transform: scale(1.05);
}

/* Edit Profile Modal */
.edit-profile-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 60;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.edit-profile-modal.open {
  opacity: 1;
  pointer-events: auto;
}

.edit-profile-modal-content {
  background: var(--white);
  border-radius: 16px;
  padding: 1.5rem;
  max-width: 90%;
  width: 400px;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
}

.edit-profile-modal-content h3 {
  font-size: clamp(1rem, 4vw, 1.1rem);
  color: var(--text-dark);
  margin-bottom: 1rem;
}

.edit-profile-modal-content input,
.edit-profile-modal-content textarea {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: clamp(0.85rem, 3.5vw, 0.9rem);
  margin-bottom: 1rem;
}

.edit-profile-modal-content textarea {
  resize: vertical;
  min-height: 80px;
}

.edit-profile-modal-content input[type="file"] {
  padding: 0.5rem;
}

.edit-profile-modal-content button {
  padding: 0.5rem 1.5rem;
  border-radius: 9999px;
  background: var(--primary-red);
  color: var(--white);
  font-weight: 600;
  font-size: clamp(0.85rem, 3.5vw, 0.9rem);
  transition: background 0.2s ease, transform 0.2s ease;
  border: none;
  cursor: pointer;
}

.edit-profile-modal-content button:hover {
  background: #d43f4e;
  transform: scale(1.05);
}

.edit-profile-modal-content .close-modal {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  background: none;
  border: none;
  color: var(--text-light);
  cursor: pointer;
}

.edit-profile-modal-content .close-modal svg {
  width: 24px;
  height: 24px;
}

.edit-profile-modal-content .error {
  color: var(--primary-red);
  font-size: clamp(0.75rem, 3vw, 0.8rem);
  margin-bottom: 1rem;
  display: none;
}

/* Loading and Error States */
.loading {
  text-align: center;
  padding: 2rem;
  color: var(--text-dark);
  font-size: 1rem;
}

.placeholder {
  padding: 2rem;
  text-align: center;
  color: var(--text-light);
  font-size: 1rem;
}

.error {
  text-align: center;
  padding: 2rem;
  color: var(--primary-red);
  font-size: 1rem;
}

.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.loading-overlay:not(.hidden) {
  opacity: 1;
}

.spinner {
  width: 60px;
  height: 60px;
  border: 6px solid rgba(255, 255, 255, 0.2);
  border-top-color: var(--primary-red);
  border-radius: 50%;
  animation: spin 1s ease-in-out infinite, pulse 2s ease-in-out infinite;
  position: relative;
}

.spinner::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 12px;
  height: 12px;
  background: var(--primary-red);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  animation: pulseDot 2s ease-in-out infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(var(--primary-red-rgb, 237, 73, 86), 0.4); }
  50% { box-shadow: 0 0 0 20px rgba(var(--primary-red-rgb, 237, 73, 86), 0); }
}

@keyframes pulseDot {
  0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
  50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
}

/* Floating Action Button */
.fab {
  position: fixed;
  bottom: 1.5rem;
  right: 1.5rem;
  background: var(--primary-red);
  color: var(--white);
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(237, 73, 86, 0.3);
  z-index: 20;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.fab:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 16px rgba(237, 73, 86, 0.4);
}

.fab svg {
  width: 28px;
  height: 28px;
  stroke-width: 2.5;
}

/* Responsive Design */
@media (max-width: 414px) {
  .container {
    padding: 0 0.5rem;
  }

  .post-header img {
    width: 36px;
    height: 36px;
  }

  .post-header span {
    font-size: clamp(0.8rem, 2.5vw, 0.85rem);
  }

  .post-caption {
    font-size: clamp(0.8rem, 2.5vw, 0.85rem);
  }

  .post-caption .song-display {
    font-size: clamp(0.75rem, 2vw, 0.8rem);
  }

  .friend-item img {
    width: 32px;
    height: 32px;
  }

  .friend-item span {
    font-size: clamp(0.75rem, 3vw, 0.8rem);
  }

  #search-results {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 0.3rem;
  }

  .profile-header {
    padding: 0.5rem;
  }

  .profile-username-container {
    margin-top: 0.3rem;
  }

  .profile-header img {
    width: 60px;
    height: 60px;
  }

  .profile-header h2 {
    font-size: clamp(0.9rem, 3.5vw, 1rem);
    margin: 0.3rem 0 0;
  }

  .profile-header p {
    font-size: clamp(0.75rem, 3vw, 0.8rem);
  }

  .profile-action-btn {
    padding: 0.4rem;
    top: 0.4rem;
  }

  .profile-action-btn svg {
    width: 20px;
    height: 20px;
  }

  #notification-btn {
    right: 5rem;
  }

  #settings-btn {
    right: 2.7rem;
  }

  .profile-action-btn .unread-badge {
    font-size: clamp(0.6rem, 1.8vw, 0.65rem);
    padding: 0.15rem 0.4rem;
    min-width: 1rem;
    top: -0.15rem;
    right: -0.15rem;
  }

  .edit-profile-btn {
    font-size: clamp(0.75rem, 3vw, 0.8rem);
    padding: 0.4rem 0.8rem;
    margin-bottom: 0.3rem;
  }

  .fab {
    width: 48px;
    height: 48px;
  }

  .fab svg {
    width: 24px;
    height: 24px;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border-width: 4px;
  }

  .spinner::before {
    width: 10px;
    height: 10px;
  }
}

/* Sub-Tab Navigation */
.sub-tab-nav {
  display: flex;
  justify-content: space-around;
  background: var(--white);
  border-bottom: 1px solid var(--border);
  padding: 0.5rem 0;
  margin-bottom: 1rem;
}

.sub-tab-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-dark);
  font-size: clamp(0.85rem, 3vw, 0.9rem);
  font-weight: 500;
  padding: 0.5rem 1rem;
  transition: color 0.2s ease, transform 0.2s ease;
  position: relative;
}

.sub-tab-btn:hover {
  color: var(--primary-red);
  transform: scale(1.05);
}

.sub-tab-btn.active {
  color: var(--primary-red);
}

.sub-tab-btn.active::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 50%;
  transform: translateX(-50%);
  width: 50%;
  height: 2px;
  background: var(--primary-red);
}

.sub-tab-content {
  display: none;
}

.sub-tab-content.active {
  display: block;
  animation: fadeIn 0.5s ease-out;
}

@media (max-width: 414px) {
  .sub-tab-btn {
    font-size: clamp(0.75rem, 2.5vw, 0.8rem);
    padding: 0.5rem 0.75rem;
  }
}

/* Friend Item Button */
.friend-item-btn {
  padding: 0.5rem 1rem;
  border-radius: 9999px;
  font-size: clamp(0.7rem, 2.5vw, 0.75rem);
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.2s ease, color 0.2s ease;
  border: 1px solid var(--border);
  background: var(--white);
  color: var(--text-dark);
  margin-left: auto;
}

.friend-item-btn.follow {
  background: var(--primary-red);
  color: var(--white);
  border: none;
}

.friend-item-btn.follow:hover {
  background: #d43f4e;
  transform: scale(1.05);
}

.friend-item-btn.following,
.friend-item-btn.message {
  background: var(--white);
  color: var(--primary-red);
}

.friend-item-btn.following:hover,
.friend-item-btn.message:hover {
  background: rgba(237, 73, 86, 0.1);
  transform: scale(1.05);
}

@media (max-width: 414px) {
  .friend-item-btn {
    padding: 0.4rem 0.8rem;
    font-size: clamp(0.65rem, 2vw, 0.7rem);
  }
}

.tab-btn[data-tab="reels"] {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 9999px;
  background: var(--white);
  border: 1px solid var(--border);
  transition: background 0.2s ease, transform 0.2s ease, color 0.2s ease;
}

.tab-btn[data-tab="reels"]:hover {
  background: rgba(237, 73, 86, 0.1);
  transform: scale(1.05);
}

.tab-btn[data-tab="reels"].active {
  background: var(--primary-red);
  color: var(--white);
  border: none;
}

.tab-btn[data-tab="reels"].active::after {
  display: none;
}

/* Delete Post Modal */
.delete-post-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 60;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.delete-post-modal.open {
  opacity: 1;
  pointer-events: auto;
}

.delete-post-modal-content {
  background: var(--white);
  border-radius: 16px;
  padding: 1.5rem;
  max-width: 90%;
  width: 400px;
  position: relative;
  text-align: center;
}

.delete-post-modal-content h3 {
  font-size: clamp(1rem, 4vw, 1.1rem);
  color: var(--text-dark);
  margin-bottom: 0.5rem;
}

.delete-post-modal-content p {
  font-size: clamp(0.85rem, 3.5vw, 0.9rem);
  color: var(--text-light);
  margin-bottom: 1rem;
}

.delete-post-modal-content .close-modal {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  background: none;
  border: none;
  color: var(--text-light);
  cursor: pointer;
}

.delete-post-modal-content .close-modal svg {
  width: 24px;
  height: 24px;
}

@media (max-width: 414px) {
  .delete-post-modal-content {
    width: 90%;
    padding: 1rem;
  }
}

/* Friend Item Layout */
.friend-item .last-message-timestamp {
  font-size: clamp(0.7rem, 2.5vw, 0.75rem);
  color: var(--text-light);
  margin-top: 0.2rem;
}

.friend-item .friend-info {
  display: flex;
  flex-direction: column;
  flex: 1;
  margin-left: 1rem;
  position: relative;
}

.friend-item .unread-badge {
  position: absolute;
  top: 0;
  left: -1.5rem;
  background: var(--primary-red);
  color: var(--white);
  font-size: clamp(0.65rem, 2vw, 0.7rem);
  font-weight: 600;
  border-radius: 9999px;
  padding: 0.2rem 0.5rem;
  min-width: 1.2rem;
  text-align: center;
  line-height: 1;
}

@media (max-width: 414px) {
  .friend-item .unread-badge {
    font-size: clamp(0.6rem, 1.8vw, 0.65rem);
    padding: 0.15rem 0.4rem;
    min-width: 1rem;
    left: -1.2rem;
  }
}

/* Verified Icon */
.verified-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  background: #0095f6;
  border-radius: 50%;
  margin-left: 0.3rem;
  vertical-align: middle;
  position: relative;
  animation: verifiedBounce 0.6s ease-out forwards;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.verified-icon:hover {
  transform: scale(1.15);
  box-shadow: 0 0 8px rgba(0, 149, 246, 0.5);
}

.verified-icon svg {
  width: 12px;
  height: 12px;
  fill: var(--white);
  animation: checkmarkFade 0.6s ease-out 0.2s forwards;
  opacity: 0;
}

@keyframes verifiedBounce {
  0% { opacity: 0; transform: scale(0.5); }
  60% { opacity: 1; transform: scale(1.2); }
  100% { opacity: 1; transform: scale(1); }
}

@keyframes checkmarkFade {
  0% { opacity: 0; transform: scale(0.8); }
  100% { opacity: 1; transform: scale(1); }
}

@media (max-width: 414px) {
  .verified-icon {
    width: 14px;
    height: 14px;
  }

  .verified-icon svg {
    width: 10px;
    height: 10px;
  }
}

/* Stories Container */
.stories-container {
  padding: 0.75rem 0;
  margin-bottom: 1rem;
  overflow-x: hidden;
  position: relative;
  border-bottom: 1px solid var(--border);
  background: var(--white);
}

.stories-scroll {
  display: flex;
  gap: 0.75rem;
  overflow-x: auto;
  scroll-behavior: smooth;
  padding: 0.5rem 1rem;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none; /* Firefox */
}

.stories-scroll::-webkit-scrollbar {
  display: none; /* Chrome, Safari */
}

.story-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 70px;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.story-item:hover {
  transform: scale(1.05);
}

.story-avatar {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--white);
  padding: 2px;
  background: var(--gradient); /* Gradient border for unviewed stories */
  transition: background 0.3s ease;
}

.story-item.viewed .story-avatar {
  background: var(--border); /* Grey border for viewed stories */
}

.story-username {
  font-size: clamp(0.65rem, 2vw, 0.7rem);
  color: var(--text-dark);
  margin-top: 0.25rem;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

.story-add-btn {
  position: relative;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--white);
  border: 2px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
}

.story-add-btn svg {
  width: 24px;
  height: 24px;
  stroke: var(--primary-red);
}

.story-add-btn::after {
  content: '+';
  position: absolute;
  bottom: -2px;
  right: -2px;
  width: 16px;
  height: 16px;
  background: var(--primary-red);
  color: var(--white);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 600;
}

@media (max-width: 414px) {
  .story-item {
    width: 60px;
  }

  .story-avatar {
    width: 48px;
    height: 48px;
  }

  .story-username {
    font-size: clamp(0.6rem, 1.8vw, 0.65rem);
  }

  .story-add-btn {
    width: 48px;
    height: 48px;
  }

  .story-add-btn svg {
    width: 20px;
    height: 20px;
  }

  .story-add-btn::after {
    width: 14px;
    height: 14px;
    font-size: 0.65rem;
  }
}
  

    
  </style>
</head>
<body>
  <div class="tab-nav">
    <button class="tab-btn active" data-tab="home" aria-label="Home">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
      </svg>
    </button>
    <button class="tab-btn" data-tab="friends" aria-label="Friends">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 00-4-4H7a4 4 0 00-4 4v2m11-10a2 2 0 11-4 0 2 2 0 014 0zm7 7v-2a4 4 0 00-3-3.87m-4-12a4 4 0 014 4"/>
      </svg>
    </button>
    <button class="tab-btn" data-tab="search" aria-label="Search">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <path d="M21 21l-4.35-4.35"/>
      </svg>
    </button>
    <button class="tab-btn" data-tab="reels" aria-label="Reels">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <rect x="4" y="4" width="16" height="16" rx="2"/>
    <path d="M10 8v8l6-4-6-4z"/>
  </svg>
  <span class="text-sm font-semibold">Watch Reels</span>
</button>
    <button class="tab-btn" data-tab="profile" aria-label="Profile">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 4a6 6 0 110 12 6 6 0 010-12zm0 2a4 4 0 100 8 4 4 0 000-8z"/>
      </svg>
    </button>
  </div>

  <div class="container">
    <div id="home" class="tab-content active">
  <div id="stories-container" class="stories-container">
    <div class="stories-scroll" aria-label="User stories">
      <!-- Stories will be dynamically inserted here -->
    </div>
    <input type="file" id="story-file-input" accept="image/*,video/*" style="display: none;" />
  </div>
  <div id="posts-container">
    <div class="loading">Loading posts...</div>
  </div>
</div>
    <div id="friends" class="tab-content">
      <div class="sub-tab-nav">
        <button class="sub-tab-btn active" data-sub-tab="friends-list" aria-label="Friends">Friends</button>
        <button class="sub-tab-btn" data-sub-tab="followers-list" aria-label="Followers">Followers</button>
        <button class="sub-tab-btn" data-sub-tab="following-list" aria-label="Following">Following</button>
      </div>
      <div id="friends-container" class="sub-tab-content active" data-sub-tab="friends-list">
        <div class="loading">Loading friends...</div>
      </div>
      <div id="followers-container" class="sub-tab-content" data-sub-tab="followers-list">
        <div class="loading">Loading followers...</div>
      </div>
      <div id="following-container" class="sub-tab-content" data-sub-tab="following-list">
        <div class="loading">Loading following...</div>
      </div>
    </div>
    
    <div id="search" class="tab-content">
  <div id="search-container" class="p-4 bg-white">
    <!-- Category Buttons -->
    <div class="category-buttons flex space-x-4 mb-4 overflow-x-auto">
      <a href="books.html" class="bg-gradient-to-r from-[#f09433] to-[#bc1888] text-white px-4 py-2 rounded-full hover:from-[#e08423] hover:to-[#ac0878] transition flex items-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"></path>
        </svg>
        Books
      </a>
      <!-- Future categories can be added here -->
    </div>
    <!-- Search Bar -->
    <div class="flex items-center border border-[var(--border)] rounded-full p-2">
      <input type="text" id="search-input" class="search-input bg-transparent w-full text-[var(--text-dark)] focus:outline-none placeholder-[var(--text-light)]" placeholder="Search posts by username or caption..." aria-label="Search posts" />
      <button id="search-btn" class="p-2">
        <svg class="w-6 h-6 text-[var(--text-light)]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </button>
    </div>
    <!-- Search Results -->
    <div id="search-results" class="mt-4" aria-live="polite"></div>
  </div>
</div>
    
    <div id="reels" class="tab-content">
    <div id="reels-container">
      <div class="loading">Loading reels...</div>
    </div>
  </div>
    <div id="profile" class="tab-content">
      <div id="profile-container" class="loading">Loading profile...</div>
    </div>
  </div>

  <a href="upload.html" class="fab" aria-label="Upload new media">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <path d="M12 5v14m7-7H5"/>
    </svg>
  </a>

  <div id="comment-sheet" class="comment-sheet hidden">
    <div class="comment-sheet-header">
      <h3 class="text-base font-semibold">Comments</h3>
      <button id="comment-sheet-close" class="comment-sheet-close">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div id="comments-list" class="comments-list" aria-live="polite" aria-relevant="additions"></div>
    <div class="comment-input-container">
      <input id="comment-input" type="text" class="comment-input" placeholder="Add a comment..."/>
      <button id="comment-submit" class="comment-submit">Post</button>
    </div>
  </div>

  <div id="edit-profile-modal" class="edit-profile-modal hidden">
  <div class="edit-profile-modal-content">
    <button class="close-modal" aria-label="Close edit profile modal">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>Edit Profile</h3>
    <div class="error edit-profile-error" id="edit-profile-error"></div>
    <input type="text" id="edit-username" placeholder="Username" aria-label="Edit username"/>
    <textarea id="edit-bio" placeholder="Bio" aria-label="Edit bio"></textarea>
    <input type="file" id="edit-photo" accept="image/*" aria-label="Upload profile photo"/>
    <button id="edit-profile-save-btn">Save</button>
  </div>
</div>
  <div id="loading-overlay" class="loading-overlay hidden">
  <div class="spinner"></div>
</div>

  <div id="delete-post-modal" class="edit-profile-modal hidden">
  <div class="edit-profile-modal-content">
    <button id="delete-post-close" class="close-modal">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
    <h3>Delete Post</h3>
    <p>Are you sure you want to delete this post? This action cannot be undone.</p>
    <div class="flex justify-end gap-2 mt-4">
      <button id="delete-post-cancel" class="post-follow-btn">Cancel</button>
      <button id="delete-post-confirm" class="post-follow-btn follow">Delete</button>
    </div>
  </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
import {
  getDatabase,
  ref,
  onValue,
  get,
  set,
  push,
  remove,
  update,
} from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDR6y1qJ8p7gZ3lX1a3iJ0r0u3M0v0v0v0",
  authDomain: "banter-box.firebaseapp.com",
  databaseURL: "https://banter-box-default-rtdb.firebaseio.com",
  projectId: "banter-box",
  storageBucket: "banter-box.appspot.com",
  messagingSenderId: "123456789012",
  appId: "1:123456789012:web:abcdef1234567890abcdef"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getDatabase();
let currentUserUid = null;

// Cloudinary configuration
const CLOUDINARY_UPLOAD_PRESET = "banter_box";
const CLOUDINARY_CLOUD_NAME = "dqkujefxj";
const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;

// DOM Elements
const postsContainer = document.getElementById("posts-container");
const friendsContainer = document.getElementById("friends-container");
const searchInput = document.getElementById("search-input");
const searchResults = document.getElementById("search-results");
const profilePosts = document.getElementById("profile-posts");
const profileReels = document.getElementById("profile-reels");
const profileUsername = document.getElementById("profile-username");
const profileBio = document.getElementById("profile-bio");
const profilePhoto = document.getElementById("profile-photo");
const notificationBtn = document.getElementById("notification-btn");
const settingsBtn = document.getElementById("settings-btn");
const editProfileBtn = document.getElementById("edit-profile-btn");
const editProfileModal = document.getElementById("edit-profile-modal");
const editProfileForm = document.getElementById("edit-profile-form");
const editUsername = document.getElementById("edit-username");
const editBio = document.getElementById("edit-bio");
const editPhoto = document.getElementById("edit-photo");
const editProfileError = document.getElementById("edit-profile-error");
const closeEditModal = document.querySelector(".close-modal");
const loadingOverlay = document.querySelector(".loading-overlay");
const tabButtons = document.querySelectorAll(".tab-btn");
const subTabButtons = document.querySelectorAll(".sub-tab-btn");
const commentSheet = document.getElementById("comment-sheet");
const commentsList = document.getElementById("comments-list");
const commentInput = document.getElementById("comment-input");
const commentSubmit = document.getElementById("comment-submit");
const closeCommentSheet = document.getElementById("close-comment-sheet");
const deletePostModal = document.getElementById("delete-post-modal");
const deletePostBtn = document.getElementById("delete-post-btn");
const cancelDeleteBtn = document.getElementById("cancel-delete-btn");
const closeDeleteModal = document.querySelector(".delete-post-modal .close-modal");
let currentPostId = null;

// Utility Functions
function showLoading() {
  loadingOverlay.classList.remove("hidden");
}

function hideLoading() {
  loadingOverlay.classList.add("hidden");
}

function pauseAllMedia() {
  document.querySelectorAll("audio, video").forEach((media) => media.pause());
}

function formatTimeAgo(timestamp) {
  const now = Date.now();
  const diff = now - timestamp;
  const seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);

  if (seconds < 60) return `${seconds}s ago`;
  if (minutes < 60) return `${minutes}m ago`;
  if (hours < 24) return `${hours}h ago`;
  return `${days}d ago`;
}

function showError(container, message) {
  container.innerHTML = `<p class="error">${message}</p>`;
}

// Authentication Check
onAuthStateChanged(auth, (user) => {
  if (!user) {
    location.href = "index.html";
  } else {
    currentUserUid = user.uid;
    loadPosts();
    loadFriends();
    loadSearch();
    loadStories();
    loadProfile();
  }
});

// Tab Navigation
tabButtons.forEach((button) => {
  button.addEventListener("click", () => {
    tabButtons.forEach((btn) => btn.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach((content) => content.classList.remove("active"));
    button.classList.add("active");
    document.getElementById(button.dataset.tab).classList.add("active");
    pauseAllMedia();
  });
});

// Sub-Tab Navigation
subTabButtons.forEach((button) => {
  button.addEventListener("click", () => {
    subTabButtons.forEach((btn) => btn.classList.remove("active"));
    document.querySelectorAll(".sub-tab-content").forEach((content) => content.classList.remove("active"));
    button.classList.add("active");
    document.getElementById(button.dataset.subTab).classList.add("active");
    pauseAllMedia();
  });
});

// Load Posts
async function loadPosts() {
  postsContainer.innerHTML = '<div class="loading">Loading posts...</div>';
  showLoading();

  try {
    const postsRef = ref(db, "posts");
    onValue(postsRef, async (snapshot) => {
      postsContainer.innerHTML = "";
      const posts = snapshot.val() || {};
      const usersSnap = await get(ref(db, "users"));
      const users = usersSnap.val() || {};
      const friendshipsSnap = await get(ref(db, `friendships/${currentUserUid}`));
      const friendships = friendshipsSnap.val() || {};

      const postArray = [];
      for (const postId in posts) {
        const post = posts[postId];
        postArray.push({ id: postId, ...post });
      }

      postArray.sort((a, b) => b.timestamp - a.timestamp);

      if (postArray.length === 0) {
        postsContainer.innerHTML = '<div class="placeholder">No posts available.</div>';
        return;
      }

      for (const post of postArray) {
        const user = users[post.userId] || { username: "Anonymous", photoURL: "https://www.gravatar.com/avatar?d=mp" };
        const isFriend = friendships[post.userId]?.status === "accepted";
        const isOwnPost = post.userId === currentUserUid;
        const postElement = document.createElement("div");
        postElement.className = "post";
        postElement.dataset.postId = post.id;

        const images = Array.isArray(post.imageUrl) ? post.imageUrl : [post.imageUrl];
        const carouselItems = images.map((url, index) => `
          <img src="${url}" alt="Post image ${index + 1}" class="post-image"/>
        `).join("");
        const indicators = images.length > 1 ? images.map((_, index) => `
          <span class="carousel-indicator ${index === 0 ? "active" : ""}"></span>
        `).join("") : "";

        postElement.innerHTML = `
          <div class="post-header">
            <img src="${user.photoURL}" alt="${user.username}" />
            <div class="user-info">
              <span>${user.username}${user.verified ? '<span class="verified-icon"><svg viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></span>' : ""}</span>
              <span class="timestamp">${formatTimeAgo(post.timestamp)}</span>
            </div>
            ${isOwnPost ? `
              <button class="post-action-btn delete-post-btn" aria-label="Delete post">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            ` : ""}
            ${!isOwnPost && !isFriend ? `
              <button class="post-follow-btn follow" data-user-id="${post.userId}">Follow</button>
            ` : !isOwnPost && isFriend ? `
              <button class="post-follow-btn following" data-user-id="${post.userId}">Following</button>
            ` : ""}
          </div>
          <div class="post-image-carousel">
            <div class="post-image-container" style="transform: translateX(0%)">${carouselItems}</div>
            ${images.length > 1 ? `
              <button class="carousel-arrow left" aria-label="Previous image">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 18l-6-6 6-6"/>
                </svg>
              </button>
              <button class="carousel-arrow right" aria-label="Next image">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"/>
                </svg>
              </button>
              <div class="carousel-indicators">${indicators}</div>
            ` : ""}
          </div>
          <div class="post-actions">
            <button class="like-btn" data-liked="${post.likes && post.likes[currentUserUid] ? "true" : "false"}" data-post-id="${post.id}">
              <svg viewBox="0 0 24 24" fill="${post.likes && post.likes[currentUserUid] ? "var(--primary-red)" : "none"}" stroke="currentColor" stroke-width="2">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
              </svg>
              <span class="like-count">${post.likes ? Object.keys(post.likes).length : 0}</span>
            </button>
            <button class="comment-btn" data-post-id="${post.id}">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
              </svg>
              <span class="comment-count">${post.comments ? Object.keys(post.comments).length : 0}</span>
            </button>
          </div>
          <div class="post-caption">
            <strong>${user.username}</strong> ${post.caption || ""}
            ${post.song ? `
              <div class="song-display">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18V5l12-2v13"></path>
                  <circle cx="6" cy="18" r="3"></circle>
                  <circle cx="18" cy="16" r="3"></circle>
                </svg>
                ${post.song}
                <audio src="${post.songUrl}" preload="none"></audio>
              </div>
            ` : ""}
          </div>
          ${post.comments && Object.keys(post.comments).length > 0 ? `
            <div class="post-footer">
              <button class="comment-btn" data-post-id="${post.id}">View all ${Object.keys(post.comments).length} comments</button>
            </div>
          ` : ""}
        `;

        postsContainer.appendChild(postElement);

        if (images.length > 1) {
          let currentIndex = 0;
          const container = postElement.querySelector(".post-image-container");
          const indicators = postElement.querySelectorAll(".carousel-indicator");
          const leftArrow = postElement.querySelector(".carousel-arrow.left");
          const rightArrow = postElement.querySelector(".carousel-arrow.right");

          function updateCarousel() {
            container.style.transform = `translateX(-${currentIndex * 100}%)`;
            indicators.forEach((ind, i) => ind.classList.toggle("active", i === currentIndex));
            leftArrow.style.display = currentIndex === 0 ? "none" : "block";
            rightArrow.style.display = currentIndex === images.length - 1 ? "none" : "block";
          }

          leftArrow.addEventListener("click", () => {
            if (currentIndex > 0) {
              currentIndex--;
              updateCarousel();
            }
          });

          rightArrow.addEventListener("click", () => {
            if (currentIndex < images.length - 1) {
              currentIndex++;
              updateCarousel();
            }
          });

          let startX = 0;
          let isDragging = false;

          container.addEventListener("touchstart", (e) => {
            startX = e.touches[0].clientX;
            isDragging = true;
          });

          container.addEventListener("touchmove", (e) => {
            if (!isDragging) return;
            const currentX = e.touches[0].clientX;
            const diff = startX - currentX;
            if (Math.abs(diff) > 50) {
              if (diff > 0 && currentIndex < images.length - 1) {
                currentIndex++;
              } else if (diff < 0 && currentIndex > 0) {
                currentIndex--;
              }
              updateCarousel();
              isDragging = false;
            }
          });

          container.addEventListener("touchend", () => {
            isDragging = false;
          });
        }
      }

      // Follow/Unfollow buttons
      document.querySelectorAll(".post-follow-btn").forEach((button) => {
        button.addEventListener("click", async () => {
          const userId = button.dataset.userId;
          const isFollowing = button.classList.contains("following");
          try {
            if (isFollowing) {
              await remove(ref(db, `friendships/${currentUserUid}/${userId}`));
              await remove(ref(db, `friendships/${userId}/${currentUserUid}`));
              button.classList.remove("following");
              button.classList.add("follow");
              button.textContent = "Follow";
            } else {
              await set(ref(db, `friendships/${currentUserUid}/${userId}`), { status: "pending" });
              await set(ref(db, `friendships/${userId}/${currentUserUid}`), { status: "pending" });
              button.classList.remove("follow");
              button.classList.add("following");
              button.textContent = "Following";
            }
          } catch (error) {
            console.error("Error updating friendship:", error.message);
            alert("Failed to update friendship: " + error.message);
          }
        });
      });

      // Like buttons
      document.querySelectorAll(".like-btn").forEach((button) => {
        button.addEventListener("click", async () => {
          const postId = button.dataset.postId;
          const liked = button.dataset.liked === "true";
          try {
            if (liked) {
              await remove(ref(db, `posts/${postId}/likes/${currentUserUid}`));
              button.dataset.liked = "false";
              button.querySelector("svg").setAttribute("fill", "none");
              const likeCount = button.querySelector(".like-count");
              likeCount.textContent = parseInt(likeCount.textContent) - 1;
            } else {
              await set(ref(db, `posts/${postId}/likes/${currentUserUid}`), true);
              button.dataset.liked = "true";
              button.querySelector("svg").setAttribute("fill", "var(--primary-red)");
              const likeCount = button.querySelector(".like-count");
              likeCount.textContent = parseInt(likeCount.textContent) + 1;
            }
          } catch (error) {
            console.error("Error updating like:", error.message);
            alert("Failed to update like: " + error.message);
          }
        });
      });

      // Comment buttons
      document.querySelectorAll(".comment-btn").forEach((button) => {
        button.addEventListener("click", () => {
          currentPostId = button.dataset.postId;
          loadComments(currentPostId);
          commentSheet.classList.add("open");
          pauseAllMedia();
        });
      });

      // Delete post buttons
      document.querySelectorAll(".delete-post-btn").forEach((button) => {
        button.addEventListener("click", () => {
          currentPostId = button.closest(".post").dataset.postId;
          deletePostModal.classList.add("open");
          pauseAllMedia();
        });
      });
    }, { onlyOnce: false });
  } catch (error) {
    console.error("Error loading posts:", error.code, error.message);
    showError(postsContainer, `Failed to load posts: ${error.message}`);
  } finally {
    hideLoading();
  }
}

// Load Stories
async function loadStories() {
  const storiesContainer = document.querySelector("#stories-container .stories-scroll");
  const storyFileInput = document.querySelector("#story-file-input");
  storiesContainer.innerHTML = '<div class="loading">Loading stories...</div>';
  showLoading();

  try {
    // Fetch all stories
    const storiesRef = ref(db, "stories");
    const storiesSnap = await Promise.race([
      get(storiesRef),
      new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout fetching stories")), 10000))
    ]);

    const usersSnap = await Promise.race([
      get(ref(db, "users")),
      new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout fetching users")), 10000))
    ]);

    storiesContainer.innerHTML = "";
    const storiesData = storiesSnap.val() || {};
    const users = usersSnap.val() || {};
    const currentTime = Date.now();
    const twentyFourHours = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
    const storyItems = [];

    // Add user's own story button first
    const user = users[currentUserUid] || { username: "Anonymous", photoURL: "https://www.gravatar.com/avatar?d=mp" };
    const addStoryItem = document.createElement("div");
    addStoryItem.className = "story-item story-add";
    addStoryItem.innerHTML = `
      <div class="story-add-btn" aria-label="Add a story">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14m7-7H5"/>
        </svg>
      </div>
      <span class="story-username">Your Story</span>
    `;
    addStoryItem.addEventListener("click", () => {
      storyFileInput.click(); // Trigger file input
      pauseAllMedia();
    });
    storiesContainer.appendChild(addStoryItem);

    // Handle file selection and upload
    storyFileInput.addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file) {
        alert("No file selected.");
        return;
      }

      // Validate file type
      const validTypes = ["image/jpeg", "image/png", "image/gif", "video/mp4", "video/webm"];
      if (!validTypes.includes(file.type)) {
        alert("Please select a valid image (JPEG, PNG, GIF) or video (MP4, WebM).");
        event.target.value = ""; // Clear input
        return;
      }

      showLoading();
      try {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

        const response = await fetch(CLOUDINARY_UPLOAD_URL, {
          method: "POST",
          body: formData,
        });
        const data = await response.json();
        if (!data.secure_url) throw new Error("Failed to upload story.");

        const storyRef = push(ref(db, `stories/${currentUserUid}`));
        await set(storyRef, {
          mediaUrl: data.secure_url,
          mediaType: file.type.startsWith("image") ? "image" : "video",
          timestamp: Date.now(),
          userId: currentUserUid,
          viewedBy: {},
        });

        // Reload stories to reflect the new story
        await loadStories();
      } catch (error) {
        console.error("Error uploading story:", error.message);
        alert(`Failed to upload story: ${error.message}`);
      } finally {
        hideLoading();
        event.target.value = ""; // Clear input
      }
    });

    // Process stories for other users
    for (const userId in storiesData) {
      const userStories = storiesData[userId];
      const userData = users[userId] || { username: "Unknown", photoURL: "https://www.gravatar.com/avatar?d=mp" };
      let latestStory = null;

      // Find the latest unexpired story for the user
      for (const storyId in userStories) {
        const story = userStories[storyId];
        if (currentTime - story.timestamp <= twentyFourHours) {
          if (!latestStory || story.timestamp > latestStory.timestamp) {
            latestStory = { id: storyId, ...story };
          }
        } else {
          // Remove expired story
          await remove(ref(db, `stories/${userId}/${storyId}`));
        }
      }

      if (latestStory && userId !== currentUserUid) {
        const isViewed = latestStory.viewedBy && latestStory.viewedBy[currentUserUid];
        const storyItem = document.createElement("div");
        storyItem.className = `story-item ${isViewed ? "viewed" : ""}`;
        storyItem.dataset.userId = userId;
        storyItem.dataset.storyId = latestStory.id;
        storyItem.innerHTML = `
          <img src="${userData.photoURL}" alt="${userData.username} story" class="story-avatar"/>
          <span class="story-username">${userData.username}</span>
        `;
        storyItem.addEventListener("click", async () => {
          if (!isViewed) {
            // Mark story as viewed
            await set(ref(db, `stories/${userId}/${latestStory.id}/viewedBy/${currentUserUid}`), true);
          }
          console.log(`Navigating to story viewer for user: ${userId}`);
          location.href = `story-view.html?uid=${userId}`;
          pauseAllMedia();
        });
        storyItems.push({ element: storyItem, timestamp: latestStory.timestamp });
      }
    }

    // Sort stories by timestamp (newest first)
    storyItems.sort((a, b) => b.timestamp - a.timestamp);
    storyItems.forEach(item => storiesContainer.appendChild(item.element));

    if (storyItems.length === 0 && storiesContainer.children.length === 1) {
      storiesContainer.innerHTML = '<div class="placeholder">No stories available.</div>';
      // Re-append the add story button
      storiesContainer.appendChild(addStoryItem);
    }
  } catch (error) {
    console.error("Error loading stories:", error.code, error.message);
    storiesContainer.innerHTML = `<p class="error">Failed to load stories: ${error.message}</p>`;
    // Re-append the add story button on error
    storiesContainer.appendChild(addStoryItem);
  } finally {
    hideLoading();
  }
}

// Load Friends
async function loadFriends() {
  friendsContainer.innerHTML = '<div class="loading">Loading friends...</div>';
  showLoading();

  try {
    const friendshipsRef = ref(db, `friendships/${currentUserUid}`);
    onValue(friendshipsRef, async (snapshot) => {
      friendsContainer.innerHTML = "";
      const friendships = snapshot.val() || {};
      const usersSnap = await get(ref(db, "users"));
      const users = usersSnap.val() || {};
      const messagesSnap = await get(ref(db, `messages/${currentUserUid}`));
      const messages = messagesSnap.val() || {};

      const friendItems = [];
      for (const friendId in friendships) {
        if (friendships[friendId].status === "accepted") {
          const user = users[friendId] || { username: "Unknown", photoURL: "https://www.gravatar.com/avatar?d=mp" };
          const lastMessage = messages[friendId] ? Object.values(messages[friendId]).sort((a, b) => b.timestamp - a.timestamp)[0] : null;
          const unreadCount = lastMessage && !lastMessage.readBy?.[currentUserUid] ? 1 : 0;

          const friendItem = document.createElement("div");
          friendItem.className = "friend-item";
          friendItem.innerHTML = `
            <img src="${user.photoURL}" alt="${user.username}" />
            <div class="friend-info">
              <span>${user.username}${user.verified ? '<span class="verified-icon"><svg viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></span>' : ""}</span>
              ${lastMessage ? `
                <span class="last-message-timestamp">${formatTimeAgo(lastMessage.timestamp)}</span>
                ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ""}
              ` : ""}
            </div>
            <button class="friend-item-btn message" data-user-id="${friendId}">Message</button>
          `;
          friendItem.addEventListener("click", () => {
            console.log(`Navigating to chat with ${friendId}`);
            pauseAllMedia();
          });
          friendItems.push(friendItem);
        }
      }

      if (friendItems.length === 0) {
        friendsContainer.innerHTML = '<div class="placeholder">No friends found.</div>';
      } else {
        friendItems.forEach((item) => friendsContainer.appendChild(item));
      }
    }, { onlyOnce: false });
  } catch (error) {
    console.error("Error loading friends:", error.code, error.message);
    showError(friendsContainer, `Failed to load friends: ${error.message}`);
  } finally {
    hideLoading();
  }
}

// Load Search
async function loadSearch() {
  searchInput.addEventListener("input", async () => {
    const query = searchInput.value.trim().toLowerCase();
    searchResults.innerHTML = '<div class="loading">Searching...</div>';
    showLoading();

    try {
      const postsRef = ref(db, "posts");
      const postsSnap = await get(postsRef);
      const posts = postsSnap.val() || {};
      const usersSnap = await get(ref(db, "users"));
      const users = usersSnap.val() || {};

      searchResults.innerHTML = "";
      const postArray = [];
      for (const postId in posts) {
        const post = posts[postId];
        const user = users[post.userId] || { username: "Anonymous" };
        if (
          user.username.toLowerCase().includes(query) ||
          (post.caption && post.caption.toLowerCase().includes(query)) ||
          (post.song && post.song.toLowerCase().includes(query))
        ) {
          postArray.push({ id: postId, ...post });
        }
      }

      if (postArray.length === 0) {
        searchResults.innerHTML = '<div class="placeholder">No results found.</div>';
        hideLoading();
        return;
      }

      postArray.sort((a, b) => b.timestamp - a.timestamp);

      for (const post of postArray) {
        const postElement = document.createElement("div");
        postElement.className = "post";
        postElement.dataset.postId = post.id;
        const images = Array.isArray(post.imageUrl) ? post.imageUrl : [post.imageUrl];
        postElement.innerHTML = `<img src="${images[0]}" alt="Post image" class="post-image"/>`;
        postElement.addEventListener("click", () => {
          currentPostId = post.id;
          loadComments(currentPostId);
          commentSheet.classList.add("open");
          pauseAllMedia();
        });
        searchResults.appendChild(postElement);
      }
    } catch (error) {
      console.error("Error searching posts:", error.code, error.message);
      showError(searchResults, `Failed to search posts: ${error.message}`);
    } finally {
      hideLoading();
    }
  });
}

// Load Profile
async function loadProfile() {
  try {
    const userRef = ref(db, `users/${currentUserUid}`);
    const userSnap = await get(userRef);
    const user = userSnap.val() || { username: "Anonymous", photoURL: "https://www.gravatar.com/avatar?d=mp", bio: "" };

    profileUsername.innerHTML = `${user.username}${user.verified ? '<span class="verified-icon"><svg viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></span>' : ""}`;
    profileBio.textContent = user.bio || "No bio yet.";
    profilePhoto.src = user.photoURL;

    const postsRef = ref(db, "posts");
    onValue(postsRef, (snapshot) => {
      profilePosts.innerHTML = "";
      profileReels.innerHTML = "";
      const posts = snapshot.val() || {};
      const postArray = [];

      for (const postId in posts) {
        if (posts[postId].userId === currentUserUid) {
          postArray.push({ id: postId, ...posts[postId] });
        }
      }

      if (postArray.length === 0) {
        profilePosts.innerHTML = '<div class="placeholder">No posts yet.</div>';
        profileReels.innerHTML = '<div class="placeholder">No reels yet.</div>';
        return;
      }

      postArray.sort((a, b) => b.timestamp - a.timestamp);

      for (const post of postArray) {
        const postElement = document.createElement("div");
        postElement.className = "post";
        postElement.dataset.postId = post.id;
        const images = Array.isArray(post.imageUrl) ? post.imageUrl : [post.imageUrl];
        postElement.innerHTML = `<img src="${images[0]}" alt="Post image" class="post-image"/>`;
        postElement.addEventListener("click", () => {
          currentPostId = post.id;
          loadComments(currentPostId);
          commentSheet.classList.add("open");
          pauseAllMedia();
        });
        profilePosts.appendChild(postElement);
        if (post.song) {
          profileReels.appendChild(postElement.cloneNode(true));
        }
      }
    }, { onlyOnce: false });
  } catch (error) {
    console.error("Error loading profile:", error.code, error.message);
    profilePosts.innerHTML = `<p class="error">Failed to load profile: ${error.message}</p>`;
  }
}

// Load Comments
async function loadComments(postId) {
  commentsList.innerHTML = '<div class="loading">Loading comments...</div>';
  showLoading();

  try {
    const commentsRef = ref(db, `posts/${postId}/comments`);
    const commentsSnap = await get(commentsRef);
    const comments = commentsSnap.val() || {};
    const usersSnap = await get(ref(db, "users"));
    const users = usersSnap.val() || {};

    commentsList.innerHTML = "";
    const commentArray = [];
    for (const commentId in comments) {
      commentArray.push({ id: commentId, ...comments[commentId] });
    }

    commentArray.sort((a, b) => b.timestamp - a.timestamp);

    if (commentArray.length === 0) {
      commentsList.innerHTML = '<div class="placeholder">No comments yet.</div>';
    } else {
      for (const comment of commentArray) {
        const user = users[comment.userId] || { username: "Anonymous", photoURL: "https://www.gravatar.com/avatar?d=mp" };
        const commentElement = document.createElement("div");
        commentElement.className = "comment-item";
        commentElement.innerHTML = `
          <img src="${user.photoURL}" alt="${user.username}" class="comment-avatar"/>
          <div class="comment-content">
            <span class="comment-username">${user.username}${user.verified ? '<span class="verified-icon"><svg viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></span>' : ""}</span>
            <p class="comment-text">${comment.text}</p>
            <span class="comment-time">${formatTimeAgo(comment.timestamp)}</span>
          </div>
        `;
        commentsList.appendChild(commentElement);
      }
    }
  } catch (error) {
    console.error("Error loading comments:", error.code, error.message);
    commentsList.innerHTML = `<p class="error">Failed to load comments: ${error.message}</p>`;
  } finally {
    hideLoading();
  }
}

// Comment Submission
commentSubmit.addEventListener("click", async () => {
  const text = commentInput.value.trim();
  if (!text || !currentPostId) return;

  showLoading();
  try {
    const commentRef = push(ref(db, `posts/${currentPostId}/comments`));
    await set(commentRef, {
      text,
      userId: currentUserUid,
      timestamp: Date.now(),
    });
    commentInput.value = "";
    loadComments(currentPostId);
  } catch (error) {
    console.error("Error adding comment:", error.code, error.message);
    alert("Failed to add comment: " + error.message);
  } finally {
    hideLoading();
  }
});

closeCommentSheet.addEventListener("click", () => {
  commentSheet.classList.remove("open");
  pauseAllMedia();
});

// Edit Profile
editProfileBtn.addEventListener("click", () => {
  editProfileModal.classList.add("open");
  pauseAllMedia();

  const userRef = ref(db, `users/${currentUserUid}`);
  get(userRef).then((snapshot) => {
    const user = snapshot.val() || { username: "", bio: "" };
    editUsername.value = user.username || "";
    editBio.value = user.bio || "";
  }).catch((error) => {
    console.error("Error fetching user data:", error.message);
    editProfileError.textContent = `Failed to fetch user data: ${error.message}`;
    editProfileError.style.display = "block";
  });
});

editProfileForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const username = editUsername.value.trim();
  const bio = editBio.value.trim();
  const file = editPhoto.files[0];

  if (!username) {
    editProfileError.textContent = "Username is required.";
    editProfileError.style.display = "block";
    return;
  }

  showLoading();
  try {
    let photoURL = profilePhoto.src;
    if (file) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

      const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
        method: "POST",
        body: formData,
      });
      const data = await response.json();
      if (data.secure_url) {
        photoURL = data.secure_url;
      } else {
        throw new Error("Failed to upload profile photo.");
      }
    }

    await set(ref(db, `users/${currentUserUid}`), {
      username,
      bio,
      photoURL,
      verified: false,
    });

    editProfileModal.classList.remove("open");
    loadProfile();
  } catch (error) {
    console.error("Error updating profile:", error.message);
    editProfileError.textContent = `Failed to update profile: ${error.message}`;
    editProfileError.style.display = "block";
  } finally {
    hideLoading();
  }
});

closeEditModal.addEventListener("click", () => {
  editProfileModal.classList.remove("open");
  editProfileError.style.display = "none";
  pauseAllMedia();
});

// Delete Post
deletePostBtn.addEventListener("click", async () => {
  if (!currentPostId) return;

  showLoading();
  try {
    await remove(ref(db, `posts/${currentPostId}`));
    deletePostModal.classList.remove("open");
    loadPosts();
    loadProfile();
  } catch (error) {
    console.error("Error deleting post:", error.code, error.message);
    alert("Failed to delete post: " + error.message);
  } finally {
    hideLoading();
  }
});

cancelDeleteBtn.addEventListener("click", () => {
  deletePostModal.classList.remove("open");
  pauseAllMedia();
});

closeDeleteModal.addEventListener("click", () => {
  deletePostModal.classList.remove("open");
  pauseAllMedia();
});

// Notification and Settings
notificationBtn.addEventListener("click", () => {
  console.log("Navigating to notifications");
  pauseAllMedia();
});

settingsBtn.addEventListener("click", () => {
  console.log("Navigating to settings");
  pauseAllMedia();
});
</script>             

        
          
        
</body>
</html> 
