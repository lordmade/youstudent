<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mini Twitter Clone â€“ Firebase + Cloudinary</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    window.firebaseModules = { 
      initializeApp, getAuth, onAuthStateChanged, 
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
      getFirestore, collection, addDoc, serverTimestamp 
    };
  </script>
  <style>
    textarea { resize: none; }
    .progress-bar { transition: width 0.3s ease; }
    .page { display: none; }
    .page.active { display: block; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- â”€â”€ LOGIN PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="page-login" class="page min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8">
      <h1 class="text-3xl font-bold text-center mb-2">Welcome</h1>
      <p class="text-center text-gray-600 mb-8">Sign in to start posting</p>

      <div id="loginError" class="text-red-600 text-center mb-6 min-h-[1.5rem]"></div>

      <form id="loginForm">
        <div class="mb-5">
          <label class="block text-gray-700 mb-2 font-medium">Email</label>
          <input type="email" id="loginEmail" required autocomplete="email"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                 placeholder="you@example.com"/>
        </div>
        <div class="mb-8">
          <label class="block text-gray-700 mb-2 font-medium">Password</label>
          <input type="password" id="loginPassword" required autocomplete="current-password"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                 placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
        </div>
        <button type="submit" id="loginBtn"
                class="w-full bg-blue-600 text-white py-3 rounded-full font-bold hover:bg-blue-700 transition disabled:opacity-50">
          Sign In
        </button>
      </form>

      <p class="text-center mt-6 text-gray-600">
        Don't have an account? 
        <button id="goToSignup" class="text-blue-600 font-medium hover:underline">Sign Up</button>
      </p>
    </div>
  </div>

  <!-- â”€â”€ SIGNUP PAGE (same style, hidden initially) â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="page-signup" class="page min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8">
      <h1 class="text-3xl font-bold text-center mb-2">Create Account</h1>
      <p class="text-center text-gray-600 mb-8">Join the conversation</p>

      <div id="signupError" class="text-red-600 text-center mb-6 min-h-[1.5rem]"></div>

      <form id="signupForm">
        <div class="mb-5">
          <label class="block text-gray-700 mb-2 font-medium">Email</label>
          <input type="email" id="signupEmail" required autocomplete="email"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                 placeholder="you@example.com"/>
        </div>
        <div class="mb-8">
          <label class="block text-gray-700 mb-2 font-medium">Password</label>
          <input type="password" id="signupPassword" required autocomplete="new-password" minlength="6"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                 placeholder="At least 6 characters"/>
        </div>
        <button type="submit" id="signupBtn"
                class="w-full bg-blue-600 text-white py-3 rounded-full font-bold hover:bg-blue-700 transition disabled:opacity-50">
          Create Account
        </button>
      </form>

      <p class="text-center mt-6 text-gray-600">
        Already have an account? 
        <button id="goToLogin" class="text-blue-600 font-medium hover:underline">Sign In</button>
      </p>
    </div>
  </div>

  <!-- â”€â”€ COMPOSER PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="page-composer" class="page max-w-lg mx-auto p-4 pt-6">

    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">

      <div class="px-5 py-4 border-b border-gray-200 flex justify-between items-center">
        <h1 class="text-xl font-bold">Post</h1>
        <div>
          <span id="userDisplay" class="text-sm text-gray-600 mr-4"></span>
          <button id="logoutBtn" class="text-sm text-red-600 hover:underline">Logout</button>
        </div>
      </div>

      <div class="p-5">

        <div class="flex gap-4 mb-4">
          <div class="w-12 h-12 bg-blue-500 rounded-full flex-shrink-0"></div>
          <div class="flex-1">
            <textarea
              id="tweetText"
              rows="4"
              placeholder="What is happening?!"
              maxlength="280"
              class="w-full border-0 focus:ring-0 text-xl placeholder-gray-500 outline-none"
              disabled
            ></textarea>
            <div class="text-right text-sm text-gray-500 mt-1">
              <span id="charCount">0</span>/280
            </div>
          </div>
        </div>

        <div id="previewContainer" class="hidden mb-4 rounded-xl overflow-hidden border border-gray-200 bg-gray-50 relative">
          <img id="previewImage" class="hidden w-full max-h-80 object-contain" alt="Preview"/>
          <video id="previewVideo" class="hidden w-full max-h-80" controls></video>
          <button id="removeMediaBtn" class="absolute top-2 right-2 bg-black bg-opacity-60 text-white rounded-full w-9 h-9 flex items-center justify-center text-xl hover:bg-opacity-80">Ã—</button>
        </div>

        <div id="progressSection" class="hidden mb-5">
          <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
            <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
          </div>
          <p class="text-center text-sm text-gray-600 mt-2">
            Uploading... <span id="progressPercent">0</span>%
          </p>
        </div>

        <div id="message" class="text-center mb-5 min-h-[1.25rem] text-sm"></div>

        <div class="flex items-center justify-between">
          <label class="cursor-pointer hover:opacity-80 transition">
            <input type="file" id="mediaInput" accept="image/jpeg,image/png,image/gif,video/mp4,video/quicktime,video/webm" class="hidden" disabled/>
            <span class="text-blue-600 text-3xl">ðŸ“·</span>
          </label>

          <button id="postBtn" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-full hover:bg-blue-700 disabled:bg-blue-300 disabled:cursor-not-allowed transition text-lg" disabled>
            Post
          </button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    const { initializeApp, getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, getFirestore, collection, addDoc, serverTimestamp } = window.firebaseModules;

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com/",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Cloudinary config â€“ CHANGE THESE
    const CLOUD_NAME    = "YOUR_CLOUDINARY_CLOUD_NAME_HERE";
    const UPLOAD_PRESET = "YOUR_UNSIGNED_UPLOAD_PRESET_HERE";

    // DOM elements
    const pages = {
      login: document.getElementById("page-login"),
      signup: document.getElementById("page-signup"),
      composer: document.getElementById("page-composer")
    };

    const tweetText      = document.getElementById("tweetText");
    const charCount      = document.getElementById("charCount");
    const mediaInput     = document.getElementById("mediaInput");
    const previewImage   = document.getElementById("previewImage");
    const previewVideo   = document.getElementById("previewVideo");
    const previewCont    = document.getElementById("previewContainer");
    const removeBtn      = document.getElementById("removeMediaBtn");
    const progressSect   = document.getElementById("progressSection");
    const progressBar    = document.getElementById("progressBar");
    const progressText   = document.getElementById("progressPercent");
    const messageEl      = document.getElementById("message");
    const postBtn        = document.getElementById("postBtn");
    const userDisplay    = document.getElementById("userDisplay");
    const logoutBtn      = document.getElementById("logoutBtn");

    let selectedFile = null;
    let currentUser  = null;

    // â”€â”€ Simple hash-based routing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showPage(pageName) {
      Object.values(pages).forEach(p => p.classList.remove("active"));
      pages[pageName].classList.add("active");
    }

    function navigate(to) {
      window.location.hash = to;
    }

    window.addEventListener("hashchange", () => {
      const hash = window.location.hash.slice(1) || "login";
      if (["login", "signup", "composer"].includes(hash)) {
        showPage(hash);
      }
    });

    // Initial navigation
    if (window.location.hash) {
      const initial = window.location.hash.slice(1);
      if (["login", "signup", "composer"].includes(initial)) {
        showPage(initial);
      }
    } else {
      showPage("login");
    }

    // â”€â”€ Auth listener â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    onAuthStateChanged(auth, (user) => {
      currentUser = user;

      if (user) {
        userDisplay.textContent = user.email.split('@')[0];
        tweetText.disabled = false;
        mediaInput.disabled = false;
        postBtn.disabled = !(tweetText.value.trim() || selectedFile);
        navigate("composer");
      } else {
        userDisplay.textContent = "";
        tweetText.disabled = true;
        mediaInput.disabled = true;
        postBtn.disabled = true;
        navigate("login");
      }
      updateUI();
    });

    // â”€â”€ Login form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;
      const errorEl = document.getElementById("loginError");
      const btn = document.getElementById("loginBtn");

      errorEl.textContent = "";
      btn.disabled = true;
      btn.textContent = "Signing in...";

      try {
        await signInWithEmailAndPassword(auth, email, password);
        // onAuthStateChanged will handle redirect
      } catch (err) {
        errorEl.textContent = err.code === "auth/wrong-password" ? "Incorrect password" :
                              err.code === "auth/user-not-found" ? "No account found" :
                              err.message || "Login failed";
      } finally {
        btn.disabled = false;
        btn.textContent = "Sign In";
      }
    });

    // â”€â”€ Signup form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("signupForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("signupEmail").value.trim();
      const password = document.getElementById("signupPassword").value;
      const errorEl = document.getElementById("signupError");
      const btn = document.getElementById("signupBtn");

      errorEl.textContent = "";
      btn.disabled = true;
      btn.textContent = "Creating...";

      try {
        await createUserWithEmailAndPassword(auth, email, password);
        // onAuthStateChanged will handle redirect
      } catch (err) {
        errorEl.textContent = err.code === "auth/email-already-in-use" ? "Email already in use" :
                              err.code === "auth/weak-password" ? "Password too weak (min 6 chars)" :
                              err.message || "Signup failed";
      } finally {
        btn.disabled = false;
        btn.textContent = "Create Account";
      }
    });

    // â”€â”€ Toggle between login & signup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("goToSignup").addEventListener("click", () => navigate("signup"));
    document.getElementById("goToLogin").addEventListener("click", () => navigate("login"));

    // â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      navigate("login");
    });

    // â”€â”€ Composer logic (same as before) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateUI() {
      const len = tweetText.value.trim().length;
      charCount.textContent = len;
      const hasContent = len > 0 || !!selectedFile;
      postBtn.disabled = !hasContent || !currentUser;
    }

    tweetText.addEventListener("input", updateUI);

    mediaInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      selectedFile = file;
      const url = URL.createObjectURL(file);
      if (file.type.startsWith("image/")) {
        previewImage.src = url; previewImage.classList.remove("hidden"); previewVideo.classList.add("hidden");
      } else if (file.type.startsWith("video/")) {
        previewVideo.src = url; previewVideo.classList.remove("hidden"); previewImage.classList.add("hidden");
      }
      previewCont.classList.remove("hidden");
      messageEl.textContent = "";
      updateUI();
    });

    removeBtn.addEventListener("click", () => {
      selectedFile = null;
      previewCont.classList.add("hidden");
      previewImage.src = ""; previewVideo.src = "";
      mediaInput.value = "";
      updateUI();
    });

    async function uploadToCloudinary(file) {
      if (!CLOUD_NAME || !UPLOAD_PRESET) throw new Error("Cloudinary config missing");
      const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", UPLOAD_PRESET);

      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", url, true);
        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            progressBar.style.width = percent + "%";
            progressText.textContent = percent;
          }
        };
        xhr.onload = () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            resolve(JSON.parse(xhr.responseText));
          } else {
            reject(new Error("Upload failed"));
          }
        };
        xhr.onerror = () => reject(new Error("Network error"));
        xhr.send(formData);
      });
    }

    async function saveTweet(text, media = null) {
      const tweetData = {
        text,
        authorId: currentUser.uid,
        authorEmail: currentUser.email,
        createdAt: serverTimestamp(),
        likesCount: 0,
        retweetsCount: 0,
        repliesCount: 0
      };
      if (media) {
        tweetData.media = [{ url: media.secure_url, public_id: media.public_id, resource_type: media.resource_type }];
      }
      await addDoc(collection(db, "tweets"), tweetData);
    }

    postBtn.addEventListener("click", async () => {
      if (!currentUser) {
        navigate("login");
        return;
      }

      const text = tweetText.value.trim();
      if (!text && !selectedFile) return;

      messageEl.textContent = "";
      postBtn.disabled = true;

      try {
        let mediaResult = null;
        if (selectedFile) {
          progressSect.classList.remove("hidden");
          progressBar.style.width = "0%";
          progressText.textContent = "0";
          mediaResult = await uploadToCloudinary(selectedFile);
        }

        await saveTweet(text, mediaResult);

        messageEl.className = "text-green-600";
        messageEl.textContent = "Posted successfully!";
        tweetText.value = "";
        selectedFile = null;
        previewCont.classList.add("hidden");
        mediaInput.value = "";
        progressSect.classList.add("hidden");
        updateUI();

        setTimeout(() => { messageEl.textContent = ""; }, 3000);
      } catch (err) {
        messageEl.className = "text-red-600";
        messageEl.textContent = err.message || "Failed to post";
      } finally {
        postBtn.disabled = false;
      }
    });

    updateUI();
  </script>
</body>
</html>
