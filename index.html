<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home / Twitter Clone</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    :root {
      --twitter-blue: #1DA1F2;
      --border: #EFF3F4;
      --hover-bg: #F7F9F9;
      --text-dark: #0F1419;
      --text-light: #536471;
    }

    body {
      background: white;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: var(--text-dark);
      overflow-y: scroll;
    }

    /* Layout Grid */
    .layout-grid {
      display: grid;
      grid-template-columns: 80px 1fr;
      max-width: 1265px;
      margin: 0 auto;
      min-height: 100vh;
    }

    @media (min-width: 640px) {
      .layout-grid { grid-template-columns: 275px 1fr; }
    }
    
    @media (min-width: 1024px) {
      .layout-grid { grid-template-columns: 275px 600px 1fr; }
    }

    /* Sidebar Navigation */
    .sidebar {
      position: sticky;
      top: 0;
      height: 100vh;
      padding: 0.5rem 1rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border-right: 1px solid var(--border);
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      padding: 0.75rem;
      border-radius: 9999px;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 1.25rem;
      color: var(--text-dark);
      width: fit-content;
    }

    .nav-item:hover { background-color: var(--hover-bg); }
    .nav-item.active { font-weight: 700; }
    
    .nav-text { display: none; }
    @media (min-width: 640px) { .nav-text { display: block; } }

    /* Main Feed Area */
    .main-feed {
      border-right: 1px solid var(--border);
      max-width: 600px;
      width: 100%;
    }

    .feed-header {
      position: sticky;
      top: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      font-weight: 700;
      font-size: 1.25rem;
      z-index: 10;
      cursor: pointer;
    }

    /* Tweet Creator Box */
    .tweet-box {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 1rem;
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #ccc;
      object-fit: cover;
      flex-shrink: 0;
    }

    .tweet-input-area { width: 100%; }

    .tweet-textarea {
      width: 100%;
      border: none;
      outline: none;
      font-size: 1.25rem;
      resize: none;
      margin-top: 0.5rem;
      min-height: 50px;
    }

    .image-preview {
      margin-top: 1rem;
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 16px;
      display: none;
      border: 1px solid var(--border);
    }

    .tweet-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
      border-top: 1px solid var(--border);
      padding-top: 0.75rem;
    }

    .icon-btn {
      color: var(--twitter-blue);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: background 0.2s;
    }
    .icon-btn:hover { background: rgba(29, 161, 242, 0.1); }

    .tweet-btn {
      background: var(--twitter-blue);
      color: white;
      border: none;
      padding: 0.5rem 1.25rem;
      border-radius: 9999px;
      font-weight: 700;
      cursor: pointer;
      opacity: 0.5;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .tweet-btn.active {
      opacity: 1;
      pointer-events: auto;
    }

    /* Feed Posts */
    .post {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 1rem;
      cursor: pointer;
      transition: background 0.2s;
      animation: fadeIn 0.4s ease-out;
    }
    .post:hover { background-color: rgba(0,0,0,0.02); }

    .post-content { width: 100%; }
    
    .post-header {
      display: flex;
      gap: 0.5rem;
      font-size: 0.95rem;
    }
    .post-name { font-weight: 700; color: var(--text-dark); }
    .post-username { color: var(--text-light); }
    .post-time { color: var(--text-light); }

    .post-text {
      margin-top: 0.25rem;
      font-size: 1rem;
      line-height: 1.5;
      color: var(--text-dark);
      white-space: pre-wrap;
    }

    .post-image {
      margin-top: 0.75rem;
      border-radius: 16px;
      border: 1px solid var(--border);
      max-width: 100%;
      max-height: 500px;
      object-fit: cover;
    }

    .post-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 0.75rem;
      max-width: 80%;
      color: var(--text-light);
    }
    
    .action-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85rem;
      transition: color 0.2s;
    }
    .action-item:hover { color: var(--twitter-blue); }

    /* Right Sidebar (Hidden on mobile) */
    .right-sidebar {
      display: none;
      padding: 1rem;
    }
    @media (min-width: 1024px) { .right-sidebar { display: block; } }

    .search-bar {
      background: #EFF3F4;
      padding: 0.75rem 1.5rem;
      border-radius: 9999px;
      color: var(--text-light);
      margin-bottom: 1rem;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Loading Overlay */
    #loading-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      display: none;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--twitter-blue);
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <div id="loading-overlay">
    <div class="spinner"></div>
  </div>

  <div class="layout-grid">
    
    <aside class="sidebar">
      <div>
        <div class="nav-item">
          <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 30px; fill: var(--twitter-blue);"><g><path d="M23.643 4.937c-.835.37-1.732.62-2.675.733.962-.576 1.7-1.49 2.048-2.578-.9.534-1.897.922-2.958 1.13-.85-.904-2.06-1.47-3.4-1.47-2.572 0-4.658 2.086-4.658 4.66 0 .364.042.718.12 1.06-3.873-.195-7.304-2.05-9.602-4.868-.4.69-.63 1.49-.63 2.342 0 1.616.823 3.043 2.072 3.878-.764-.025-1.482-.234-2.11-.583v.06c0 2.257 1.605 4.14 3.737 4.568-.392.106-.803.162-1.227.162-.3 0-.593-.028-.877-.082.593 1.85 2.313 3.198 4.352 3.234-1.595 1.25-3.604 1.995-5.786 1.995-.376 0-.747-.022-1.112-.065 2.062 1.323 4.51 2.093 7.14 2.093 8.57 0 13.255-7.098 13.255-13.254 0-.2-.005-.402-.014-.602.91-.658 1.7-1.477 2.323-2.41z"></path></g></svg>
        </div>
        
        <div class="nav-item active">
          <i data-feather="home"></i>
          <span class="nav-text">Home</span>
        </div>
        <div class="nav-item">
          <i data-feather="hash"></i>
          <span class="nav-text">Explore</span>
        </div>
        <div class="nav-item">
          <i data-feather="user"></i>
          <span class="nav-text">Profile</span>
        </div>
      </div>
      
      <div class="nav-item" id="logout-btn">
        <i data-feather="log-out"></i>
        <span class="nav-text">Logout</span>
      </div>
    </aside>

    <main class="main-feed">
      <div class="feed-header">Home</div>

      <div class="tweet-box">
        <img src="https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png" class="user-avatar" id="current-user-avatar">
        <div class="tweet-input-area">
          <textarea id="tweet-text" class="tweet-textarea" placeholder="What is happening?!"></textarea>
          
          <img id="image-preview" class="image-preview" src="" alt="Preview">

          <div class="tweet-actions">
            <div>
              <label for="file-upload" class="icon-btn">
                <i data-feather="image"></i>
              </label>
              <input type="file" id="file-upload" accept="image/*" style="display: none;">
            </div>
            <button id="tweet-btn" class="tweet-btn">Post</button>
          </div>
        </div>
      </div>

      <div id="feed-stream">
        </div>
    </main>

    <aside class="right-sidebar">
      <div class="search-bar">Search Twitter</div>
      <div style="background: #F7F9F9; border-radius: 16px; padding: 1rem; margin-top: 1rem;">
        <h3 style="font-weight: 800; font-size: 1.25rem; margin-bottom: 1rem;">Trends for you</h3>
        <p style="color: var(--text-light); font-size: 0.9rem;">Technology · Trending</p>
        <p style="font-weight: 700;">#WebDevelopment</p>
        <p style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 1rem;">25.4K Posts</p>
        
        <p style="color: var(--text-light); font-size: 0.9rem;">Coding · Trending</p>
        <p style="font-weight: 700;">#Firebase</p>
        <p style="color: var(--text-light); font-size: 0.85rem;">12.1K Posts</p>
      </div>
    </aside>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
    import { getDatabase, ref, push, onChildAdded, get } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

    // --- CONFIGURATION ---
    // 1. Firebase Config (Same as login page)
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    // 2. Cloudinary Config (Fill these in!)
    const CLOUD_NAME = "YOUR_CLOUD_NAME"; // e.g., 'democloud'
    const UPLOAD_PRESET = "YOUR_UPLOAD_PRESET"; // e.g., 'ml_default'

    // --- INITIALIZATION ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let currentUsername = "Guest";

    // DOM Elements
    const tweetText = document.getElementById('tweet-text');
    const fileUpload = document.getElementById('file-upload');
    const imagePreview = document.getElementById('image-preview');
    const tweetBtn = document.getElementById('tweet-btn');
    const feedStream = document.getElementById('feed-stream');
    const logoutBtn = document.getElementById('logout-btn');
    const loadingOverlay = document.getElementById('loading-overlay');

    // Initialize Icons
    feather.replace();

    // --- AUTHENTICATION CHECK ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        // Fetch username from DB
        const userRef = ref(db, `users/${user.uid}`);
        const snapshot = await get(userRef);
        if (snapshot.exists()) {
          currentUsername = snapshot.val().username || "User";
        }
        console.log("Logged in as:", currentUsername);
      } else {
        // Redirect to login if not authenticated
        window.location.href = "index.html";
      }
    });

    // --- LOGOUT LOGIC ---
    logoutBtn.addEventListener('click', () => {
      signOut(auth).then(() => {
        window.location.href = "index.html";
      });
    });

    // --- POST CREATION LOGIC ---
    let selectedFile = null;

    // 1. Handle File Selection
    fileUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          imagePreview.src = e.target.result;
          imagePreview.style.display = 'block';
          checkInput();
        };
        reader.readAsDataURL(file);
      }
    });

    // 2. Enable/Disable Post Button
    tweetText.addEventListener('input', checkInput);
    function checkInput() {
      if (tweetText.value.trim().length > 0 || selectedFile) {
        tweetBtn.classList.add('active');
      } else {
        tweetBtn.classList.remove('active');
      }
    }

    // 3. Upload to Cloudinary (API)
    async function uploadImageToCloudinary(file) {
      const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", UPLOAD_PRESET);

      try {
        const response = await fetch(url, {
          method: "POST",
          body: formData
        });
        const data = await response.json();
        return data.secure_url; // Return the hosted image URL
      } catch (error) {
        console.error("Cloudinary Error:", error);
        alert("Image upload failed");
        return null;
      }
    }

    // 4. Submit Post
    tweetBtn.addEventListener('click', async () => {
      if (!tweetBtn.classList.contains('active')) return;

      loadingOverlay.style.display = 'flex'; // Show spinner

      const content = tweetText.value;
      let imageUrl = "";

      // Upload Image if exists
      if (selectedFile) {
        imageUrl = await uploadImageToCloudinary(selectedFile);
        if (!imageUrl) {
          loadingOverlay.style.display = 'none';
          return; // Stop if upload failed
        }
      }

      // Save to Firebase
      try {
        await push(ref(db, 'posts'), {
          uid: currentUser.uid,
          username: currentUsername,
          text: content,
          imageUrl: imageUrl,
          timestamp: Date.now(),
          likes: 0
        });

        // Reset Form
        tweetText.value = '';
        selectedFile = null;
        imagePreview.style.display = 'none';
        imagePreview.src = '';
        checkInput();
        
      } catch (error) {
        console.error("Database Error:", error);
        alert("Could not post tweet.");
      } finally {
        loadingOverlay.style.display = 'none'; // Hide spinner
      }
    });

    // --- FEED LOGIC (READ POSTS) ---
    const postsRef = ref(db, 'posts');
    
    // Listen for new posts
    onChildAdded(postsRef, (snapshot) => {
      const post = snapshot.val();
      renderPost(post);
    });

    function renderPost(post) {
      const date = new Date(post.timestamp).toLocaleDateString();
      
      const postEl = document.createElement('div');
      postEl.className = 'post';
      
      // Conditional Image HTML
      const imageHtml = post.imageUrl 
        ? `<img src="${post.imageUrl}" class="post-image" loading="lazy" />` 
        : '';

      postEl.innerHTML = `
        <img src="https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png" class="user-avatar">
        <div class="post-content">
          <div class="post-header">
            <span class="post-name">${post.username}</span>
            <span class="post-username">@${post.username.toLowerCase().replace(/\s/g, '')}</span>
            <span class="post-time">· ${date}</span>
          </div>
          <div class="post-text">${post.text}</div>
          ${imageHtml}
          <div class="post-actions">
            <div class="action-item"><i data-feather="message-circle" style="width:18px"></i> 0</div>
            <div class="action-item"><i data-feather="repeat" style="width:18px"></i> 0</div>
            <div class="action-item"><i data-feather="heart" style="width:18px"></i> ${post.likes}</div>
            <div class="action-item"><i data-feather="share" style="width:18px"></i></div>
          </div>
        </div>
      `;

      // Prepend to feed (newest first strategy in UI, though Firebase sends oldest first by default. 
      // To truly order by time, simple prepend works for live updates)
      feedStream.prepend(postEl);
      feather.replace(); // Refresh icons
    }

  </script>
</body>
</html>
