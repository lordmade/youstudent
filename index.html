<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <title>Nexus</title>
  <style>
    :root {
      --primary: #6366F1;
      --red: #F91880;
      --grey: #536471;
      --bg: #ffffff;
      --line: #EFF3F4;
      --max-width: 600px;
      --safe-bottom: env(safe-area-inset-bottom);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: #000; }
    /* ---------- skeleton ---------- */
    .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; border-radius: 8px; animation: shine 1.5s infinite; }
    @keyframes shine { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    .s-avatar { width: 48px; height: 48px; border-radius: 50%; }
    .s-line { height: 16px; margin: 6px 0; }
    .s-line.short { width: 40%; }
    .s-line.medium { width: 70%; }
    /* ---------- header ---------- */
    .top-bar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--line);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo {
      width: 32px;
      height: 32px;
      background: var(--primary);
      border-radius: 8px;
      display: grid;
      place-items: center;
      color: white;
      font-weight: 700;
      font-size: 18px;
    }
    .search {
      flex: 1;
      height: 36px;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 0 14px;
      font-size: 15px;
      outline: none;
    }
    /* ---------- post box ---------- */
    .post-box {
      display: flex;
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      gap: 12px;
    }
    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #e1e8ed;
      object-fit: cover;
      flex-shrink: 0;
      cursor: pointer;
    }
    textarea {
      width: 100%;
      border: none;
      outline: none;
      resize: none;
      font-size: 18px;
      font-family: inherit;
      line-height: 1.35;
      min-height: 56px;
      background: transparent;
    }
    .media-slot {
      display: none;
      max-height: 280px;
      border-radius: 16px;
      overflow: hidden;
      margin-top: 8px;
    }
    .media-slot img, .media-slot video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--line);
    }
    .attach {
      width: 28px;
      height: 28px;
      cursor: pointer;
      color: var(--primary);
    }
    .post-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 8px 20px;
      font-size: 15px;
      font-weight: 600;
      opacity: 0.5;
      pointer-events: none;
    }
    .post-btn.active {
      opacity: 1;
      pointer-events: auto;
    }
    /* ---------- feed ---------- */
    .feed {
      padding-bottom: calc(72px + var(--safe-bottom));
    }
    .card {
      display: flex;
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      gap: 12px;
    }
    .card:active {
      background: #fafafa;
    }
    .body {
      flex: 1;
    }
    .name {
      font-weight: 700;
      font-size: 15px;
    }
    .handle {
      color: var(--grey);
      font-size: 14px;
      margin-left: 4px;
    }
    .time {
      color: var(--grey);
      font-size: 14px;
      margin-left: auto;
    }
    .text {
      font-size: 15px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
      margin: 4px 0 8px;
    }
    .text a, .text .hashtag {
      color: var(--primary);
      text-decoration: none;
    }
    .media {
      max-height: 280px;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 8px;
    }
    .media img, .media video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .bar {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      font-size: 14px;
      color: var(--grey);
    }
    .bar svg {
      width: 18px;
      height: 18px;
      stroke-width: 2;
    }
    .bar .liked {
      color: var(--red);
      fill: var(--red);
    }
    /* ---------- bottom nav ---------- */
    .bot-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: calc(56px + var(--safe-bottom));
      padding-bottom: var(--safe-bottom);
      background: white;
      border-top: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-around;
      z-index: 50;
    }
    .bot-nav a {
      flex: 1;
      display: grid;
      place-items: center;
      height: 56px;
      color: #000;
    }
    .bot-nav a.active {
      color: var(--primary);
    }
    .fab {
      position: fixed;
      bottom: calc(76px + var(--safe-bottom));
      right: 16px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      display: grid;
      place-items: center;
      z-index: 60;
    }
    /* ---------- utils ---------- */
    #toast {
      position: fixed;
      bottom: calc(90px + var(--safe-bottom));
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      color: white;
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 14px;
      z-index: 200;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    #toast.show {
      opacity: 1;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- top bar -->
  <header class="top-bar">
    <div class="logo">N</div>
    <input class="search" id="search" type="search" placeholder="Search posts, users, #hashtags">
  </header>

  <!-- post box -->
  <section class="post-box">
    <img id="my-avatar" class="avatar" src="https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png">
    <div style="flex:1">
      <textarea id="post-text" placeholder="What's on your mind?"></textarea>
      <div id="media-slot" class="media-slot"></div>
      <div class="actions">
        <label for="media-picker">
          <svg class="attach" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20"/></svg>
        </label>
        <input id="media-picker" type="file" accept="image/*,video/mp4,video/webm,video/ogg" style="display:none">
        <button id="post-btn" class="post-btn">Post</button>
      </div>
    </div>
  </section>

  <!-- feed -->
  <main id="feed" class="feed"></main>

  <!-- bottom nav -->
  <nav class="bot-nav">
    <a href="index.html" class="active">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    </a>
    <a href="explore.html">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    </a>
    <a href="messages.html">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/></svg>
    </a>
    <a href="profile.html">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
    </a>
  </nav>
  <button id="fab" class="fab">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
  </button>

  <div id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
    import { getDatabase, ref, push, set, onValue, get, runTransaction, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const CLOUD_NAME = "dqkujefxj";
    const UPLOAD_PRESET = "banter_box";

    let currentUser = null;
    let currentUsername = null;
    let selectedFile = null;
    let selectedType = null;

    const MAX_VIDEO = 10 * 1024 * 1024;

    const feed = document.getElementById('feed');
    const mediaSlot = document.getElementById('media-slot');
    const postText = document.getElementById('post-text');
    const postBtn = document.getElementById('post-btn');
    const search = document.getElementById('search');
    const toast = document.getElementById('toast');
    const fab = document.getElementById('fab');
    const mediaPicker = document.getElementById('media-picker');
    const myAvatar = document.getElementById('my-avatar');

    const avatarCache = new Map();
    const defaultAvatar = "https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png";

    function showToast(msg, err = false) {
      toast.textContent = msg;
      toast.className = err ? 'show error' : 'show';
      setTimeout(() => toast.className = '', 2500);
    }

    onAuthStateChanged(auth, async u => {
      if (!u) return window.location.href = "signup.html";
      currentUser = u;
      const snap = await get(ref(db, `users/${u.uid}`));
      currentUsername = snap.exists() ? (snap.val().username || u.email.split('@')[0]) : u.email.split('@')[0];
      const av = u.photoURL || defaultAvatar;
      myAvatar.src = av;
      avatarCache.set(u.uid, av);
    });

    function escapeHtml(t) {
      const d = document.createElement('div');
      d.textContent = t;
      return d.innerHTML;
    }

    function parseText(t) {
      return escapeHtml(t)
        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>')
        .replace(/#[\w]+/g, '<span class="hashtag">$&</span>')
        .replace(/@[\w]+/g, '<span style="color:var(--primary)">$&</span>');
    }

    function timeAgo(ts) {
      const s = (Date.now() - ts) / 1000;
      if (s < 60) return 'now';
      if (s < 3600) return Math.floor(s / 60) + 'm';
      if (s < 86400) return Math.floor(s / 3600) + 'h';
      return Math.floor(s / 86400) + 'd';
    }

    async function getAvatar(uid) {
      if (avatarCache.has(uid)) return avatarCache.get(uid);
      const snap = await get(ref(db, `users/${uid}`));
      const url = snap.exists() ? (snap.val().photoURL || defaultAvatar) : defaultAvatar;
      avatarCache.set(uid, url);
      return url;
    }

    /* ---------- POSTING ---------- */
    function updateBtn() {
      const ok = (postText.value.trim() || selectedFile) && currentUsername;
      postBtn.classList.toggle('active', ok);
    }
    postText.addEventListener('input', updateBtn);

    mediaPicker.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > MAX_VIDEO) {
        showToast('Video must be ≤ 10 MB', true);
        mediaPicker.value = '';
        return;
      }
      selectedFile = file;
      selectedType = file.type.startsWith('video/') ? 'video' : 'image';
      const url = URL.createObjectURL(file);
      mediaSlot.innerHTML = '';
      const el = document.createElement(selectedType === 'video' ? 'video' : 'img');
      el.src = url;
      el.className = 'media';
      if (selectedType === 'video') {
        el.controls = true;
        el.muted = true;
        el.setAttribute('playsinline', '');
      }
      mediaSlot.appendChild(el);
      mediaSlot.style.display = 'block';
      updateBtn();
    };

    postBtn.onclick = async () => {
      if (!currentUser || !currentUsername) return showToast('Not ready', true);
      if (!postText.value.trim() && !selectedFile) return;

      postBtn.disabled = true;
      let mediaUrl = '', mediaType = '';
      if (selectedFile) {
        const isVid = selectedType === 'video';
        const endpoint = isVid ? 'video/upload' : 'image/upload';
        const fd = new FormData();
        fd.append('file', selectedFile);
        fd.append('upload_preset', UPLOAD_PRESET);
        try {
          const res = await fetch(`https://api.cloudinary.com/v1_1/ \( {CLOUD_NAME}/ \){endpoint}`, { method: 'POST', body: fd });
          const data = await res.json();
          mediaUrl = data.secure_url;
          mediaType = isVid ? 'video' : 'image';
        } catch (e) {
          showToast('Media upload failed', true);
          postBtn.disabled = false;
          return;
        }
      }

      try {
        await push(ref(db, 'posts'), {
          uid: currentUser.uid,
          username: currentUsername,
          text: postText.value.trim(),
          mediaUrl,
          mediaType,
          timestamp: Date.now(),
          likes: 0,
          commentCount: 0
        });
        postText.value = '';
        selectedFile = null;
        selectedType = null;
        mediaSlot.innerHTML = '';
        mediaSlot.style.display = 'none';
        updateBtn();
        showToast('Posted!');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (e) {
        showToast('Post error', true);
      } finally {
        postBtn.disabled = false;
      }
    };

    /* ---------- FEED ---------- */
    function renderCard(key, data) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <img class="avatar" src="" onerror="this.src=' \){defaultAvatar}'">
        <div class="body">
          <div style="display:flex;align-items:center">
            <span class="name"></span>
            <span class="handle"></span>
            <span class="time"></span>
          </div>
          <div class="text"></div>
          <div class="media"></div>
          <div class="bar">
            <span class="comment" data-id="\( {key}"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/></svg> <span id="cc- \){key}">0</span></span>
            <span class="like" data-id="\( {key}"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg> <span id="lc- \){key}">0</span></span>
            <span class="share" data-id="\( {key}"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8M16 6l-4-4-4 4M12 2v13"/></svg></span>
          </div>
        </div>`;

      getAvatar(data.uid).then(url => card.querySelector('.avatar').src = url);
      card.querySelector('.name').textContent = data.username;
      card.querySelector('.handle').textContent = '@' + data.username.toLowerCase().replace(/\s/g, '');
      card.querySelector('.time').textContent = timeAgo(data.timestamp);
      card.querySelector('.text').innerHTML = parseText(data.text);

      const mediaSlot = card.querySelector('.media');
      if (data.mediaUrl) {
        const isVid = data.mediaType === 'video';
        const el = document.createElement(isVid ? 'video' : 'img');
        el.src = data.mediaUrl;
        el.className = 'media';
        el.setAttribute('loading', 'lazy');
        if (isVid) {
          el.controls = true;
          el.muted = true;
          el.setAttribute('playsinline', '');
          el.poster = getVideoPosterUrl(data.mediaUrl, { width: 600, height: 338, crop: 'fill', gravity: 'auto' });
        }
        mediaSlot.appendChild(el);
      }

      // like
      const likeBtn = card.querySelector('.like');
      likeBtn.onclick = () => toggleLike(key);
      checkLike(key, likeBtn);

      // comment
      card.querySelector('.comment').onclick = () => openComments(key);

      // share
      card.querySelector('.share').onclick = () => {
        if (navigator.share) navigator.share({ title: 'Nexus Post', text: data.text, url: location.origin + '/post/' + key });
      };

      feed.appendChild(card);
    }

    onChildAdded(ref(db, 'posts'), snap => renderCard(snap.key, snap.val()));

    /* ---------- LIKE ---------- */
    async function toggleLike(id) {
      if (!currentUser) return;
      const likeRef = ref(db, `postLikes/\( {id}/ \){currentUser.uid}`);
      const postRef = ref(db, `posts/${id}`);
      const exists = (await get(likeRef)).exists();
      await set(likeRef, exists ? null : true);
      await runTransaction(postRef, p => {
        if (p) p.likes = (p.likes || 0) + (exists ? -1 : 1);
        return p;
      });
      document.getElementById(`lc-${id}`).textContent = (parseInt(document.getElementById(`lc-${id}`).textContent) + (exists ? -1 : 1));
      document.querySelector(`.like[data-id="${id}"]`).classList.toggle('liked', !exists);
    }
    async function checkLike(id, btn) {
      if (!currentUser) return;
      const liked = (await get(ref(db, `postLikes/\( {id}/ \){currentUser.uid}`))).exists();
      btn.classList.toggle('liked', liked);
    }

    /* ---------- COMMENTS ---------- */
    let activePost = null;
    function openComments(id) {
      activePost = id;
      sheetOverlay.classList.add('active');
      commentSheet.classList.add('active');
      commentsList.innerHTML = '<div style="text-align:center;padding:1rem">Loading...</div>';
      onValue(ref(db, `postComments/${id}`), async snap => {
        commentsList.innerHTML = '';
        if (!snap.exists()) {
          commentsList.innerHTML = '<div style="text-align:center;color:#888;padding:2rem 1rem">No comments yet</div>';
          return;
        }
        const arr = [];
        snap.forEach(c => arr.push({key:c.key, val:c.val()}));
        for (const c of arr) {
          const av = await getAvatar(c.val.uid);
          const div = document.createElement('div');
          div.className = 'comment-item';
          div.innerHTML = `
            <img class="comment-avatar" src="\( {av}" onerror="this.src=' \){defaultAvatar}'">
            <div class="comment-content">
              <div style="font-weight:700;font-size:0.85rem">${c.val.username}</div>
              <div>${parseText(c.val.text)}</div>
            </div>`;
          commentsList.appendChild(div);
        }
        commentsList.scrollTop = commentsList.scrollHeight;
      }, { onlyOnce: false });
    }
    function closeComments() {
      sheetOverlay.classList.remove('active');
      commentSheet.classList.remove('active');
      activePost = null;
    }
    closeSheetBtn.onclick = closeComments;
    sheetOverlay.onclick = closeComments;
    commentForm.onsubmit = async e => {
      e.preventDefault();
      const text = commentInput.value.trim();
      if (!text || !activePost) return;
      await push(ref(db, `postComments/${activePost}`), { uid: currentUser.uid, username: currentUsername, text, timestamp: Date.now() });
      await runTransaction(ref(db, `posts/${activePost}/commentCount`), c => (c || 0) + 1);
      commentInput.value = '';
    };

    /* ---------- SEARCH ---------- */
    search.oninput = e => {
      const q = e.target.value.toLowerCase().trim();
      [...feed.children].forEach(card => {
        const txt = (card.querySelector('.text').textContent + card.querySelector('.handle').textContent).toLowerCase();
        card.style.display = txt.includes(q) ? 'flex' : 'none';
      });
    };

    /* ---------- INIT ---------- */
    fab.onclick = () => {
      postText.focus();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    /* ---------- skeleton while loading ---------- */
    for (let i = 0; i < 3; i++) {
      feed.innerHTML += `
        <div class="card">
          <div class="s-avatar skeleton"></div>
          <div style="flex:1">
            <div class="s-line short skeleton"></div>
            <div class="s-line medium skeleton"></div>
            <div class="s-line skeleton"></div>
          </div>
        </div>`;
    }
  </script>

  <!-- sheets (comments / delete) same HTML as before – shortened for brevity -->
  <div id="sheet-overlay" class="sheet-overlay"></div>
  <div id="comment-sheet" class="bottom-sheet">
    <div class="sheet-header"><span>Comments</span><button id="close-sheet">✕</button></div>
    <div id="comments-list" class="sheet-body"></div>
    <form id="comment-form" class="sheet-footer"><input id="comment-input" class="comment-input" placeholder="Post your reply..." autocomplete="off"><button type="submit">Post</button></form>
  </div>

  <div id="toast"></div>
</body>
</html>
