<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Vynix Lingua Community - African Language Learning Hub</title>
  
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;700&family=Poppins:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
  
  <style>
    /* Design Tokens - Same as AI page */
    :root{
      --bg-color:#ffffff;
      --surface-color:#f3f6fc;
      --text-primary:#1e1e1e;
      --text-secondary:#444746;
      --text-muted:#9aa0a6;
      --accent-blue:#2563eb;
      --accent-purple:#d946ef;
      --accent-green:#10b981;
      --logo-gradient:linear-gradient(135deg,var(--accent-blue) 0%,var(--accent-purple) 50%,var(--accent-green) 100%);
      --radius-lg:32px;
      --radius-md:24px;
      --radius-sm:16px;
      --shadow-soft:0 8px 32px rgba(0,0,0,.06);
      --font-main: 'Noto Sans', sans-serif;
      --font-head: 'Poppins', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }
    
    /* Reset & Base Styles - Same as AI page with highlight prevention */
    *,*::before,*::after{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:var(--font-main);background:var(--bg-color);color:var(--text-primary);
         height:100vh;display:flex;flex-direction:column;overflow:hidden;-webkit-font-smoothing:antialiased;
         -webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
    
    /* Rain Canvas - Same as AI page */
    #rainCanvas{position:fixed;inset:0;z-index:-1;background:#ffffff}
    
    /* Header - Same glass-morphism as AI page */
    .community-header {
      height:64px;padding:0 20px;display:flex;align-items:center;justify-content:space-between;
      flex-shrink:0;background:rgba(255,255,255,.85);backdrop-filter:blur(12px);
      border-bottom:1px solid rgba(0,0,0,.05);z-index:10;
    }
    
    .header-left {
      display:flex;align-items:center;gap:12px;
    }
    
    .back-btn {
      background:none;border:none;width:40px;height:40px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;cursor:pointer;
      color:var(--text-primary);transition:background .2s;
    }
    
    .back-btn:hover{background:var(--surface-color)}
    .back-btn:active{transform:scale(.96)}
    
    .community-logo {
      display:flex;align-items:center;gap:8px;
    }
    
    .logo-icon {
      font-size:26px;background:var(--logo-gradient);-webkit-background-clip:text;
      -webkit-text-fill-color:transparent;font-variation-settings:'FILL' 1,'wght' 600;
    }
    
    .logo-text {
      font-family:var(--font-head);font-size:22px;font-weight:700;letter-spacing:-.5px;
    }
    
    .online-indicator {
      display:flex;align-items:center;gap:8px;font-size:14px;
      color:var(--text-secondary);font-weight:500;
    }
    
    .online-dot {
      width:8px;height:8px;background:var(--accent-green);border-radius:50%;
      animation:pulse 2s infinite;
    }
    
    /* Messages Container - Same as AI page chat container */
    .community-messages {
      flex:1;overflow-y:auto;padding:20px 0 160px;display:flex;flex-direction:column;
      scroll-behavior:smooth;
    }
    
    .message-item {
      display:flex;margin-bottom:20px;max-width:80%;position:relative;
      animation:fadeIn .5s ease;
    }
    
    .message-item.own{margin-left:auto;text-align:right;flex-direction:column;align-items:flex-end}
    .message-item:not(.own){margin-right:auto;padding-left:50px;flex-direction:column;align-items:flex-start}
    
    .message-content {
      padding:14px 18px;border-radius:20px;line-height:1.6;text-align:left;font-size:15px;
      white-space:pre-wrap;overflow-wrap:break-word;word-wrap:break-word;max-width:100%;
      display:inline-block;box-shadow:var(--shadow-soft);
    }
    
    .message-item:not(.own) .message-content {
      background:rgba(255,255,255,.95);border-top-left-radius:4px;
    }
    
    .message-item.own .message-content {
      background:var(--logo-gradient);color:#fff;border-bottom-right-radius:4px;
    }
    
    .user-avatar {
      width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      flex-shrink:0;position:absolute;left:0;top:-10px;background:var(--logo-gradient);color:#fff;font-size:22px;
    }
    
    .message-item.own .user-avatar{display:none} /* Hide avatar for own messages */
    
    .message-header {
      display:flex;align-items:center;gap:8px;margin-bottom:4px;
    }
    
    .message-author {
      font-weight:600;font-size:14px;
    }
    
    .message-time {
      font-size:10px;color:var(--text-muted);position:absolute;bottom:-15px;
    }
    
    .message-item.own .message-time{right:0}
    .message-item:not(.own) .message-time{left:50px}
    
    .message-item.own .message-time{color:rgba(255,255,255,.8)}
    
    /* Input Area - Same as AI page input wrapper */
    .input-area {
      position:fixed;left:0;right:0;bottom:0;z-index:30;
      background:var(--bg-color);padding:12px max(20px,env(safe-area-inset-left)) max(20px,env(safe-area-inset-bottom)) max(20px,env(safe-area-inset-right));
      box-shadow:0 -2px 10px rgba(0,0,0,.04);
    }
    
    .input-area .input-wrapper {
      width:100%;background:rgba(255,255,255,.95);backdrop-filter:blur(8px);
      border-radius:28px;padding:6px;display:flex;align-items:center;
      transition:background .2s,box-shadow .2s;border:1px solid rgba(0,0,0,.06);
    }
    
    .input-area .input-wrapper:focus-within{background:#fff;box-shadow:var(--shadow-soft);border-color:var(--accent-blue)}
    
    .message-input {
      flex:1;border:none;background:none;outline:none;font-size:16px;font-family:var(--font-main);
      color:var(--text-primary);padding:12px 14px;user-select:text;
    }
    
    .send-button {
      width:44px;height:44px;border-radius:50%;border:none;background:transparent;
      color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;
      transition:all .2s;flex-shrink:0;
    }
    
    .send-button.active{background:#1e1e1e;color:#fff}
    .send-button span{font-size:22px}
    
    /* Auth Prompt - Same as AI page bottom sheet */
    .auth-overlay {
      position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);
      z-index:40;opacity:0;pointer-events:none;transition:opacity .3s;
    }
    
    .auth-overlay.open{opacity:1;pointer-events:all}
    
    .auth-sheet {
      position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.98);
      backdrop-filter:blur(20px);border-top:1px solid rgba(0,0,0,.05);
      border-top-left-radius:20px;border-top-right-radius:20px;padding:20px;
      z-index:50;box-shadow:0 -5px 20px rgba(0,0,0,.1);transform:translateY(100%);
      transition:transform .3s ease-out;max-height:90vh;overflow-y:auto;
    }
    
    .auth-sheet.open{transform:translateY(0)}
    
    .sheet-header {
      font-size:20px;font-weight:700;margin-bottom:20px;text-align:center;position:relative;
    }
    
    .sheet-close-btn {
      position:absolute;right:0;top:0;background:none;border:none;cursor:pointer;
      color:var(--text-muted);padding:4px;
    }
    
    .sheet-tab-bar {
      display:flex;border-bottom:1px solid var(--surface-color);margin-bottom:20px;
    }
    
    .sheet-tab {
      flex:1;text-align:center;padding:10px 0;cursor:pointer;font-weight:500;
      color:var(--text-muted);border-bottom:2px solid transparent;
      transition:color .2s,border-color .2s;
    }
    
    .sheet-tab.active{color:var(--accent-blue);border-bottom-color:var(--accent-blue)}
    
    .sheet-tab-content{padding:10px 0}
    
    .sheet-input {
      width:100%;padding:12px;margin-bottom:15px;border:1px solid var(--surface-color);
      border-radius:10px;font-family:var(--font-main);font-size:16px;background:var(--input-bg);
    }
    
    .sheet-btn {
      width:100%;padding:14px;border:none;border-radius:50px;font-weight:700;font-size:16px;
      cursor:pointer;transition:opacity .2s,transform .2s;margin-top:10px;
      display:flex;align-items:center;justify-content:center;gap:10px;
    }
    
    .sheet-btn:active{transform:scale(.98)}
    
    .sheet-btn-primary {
      background:var(--logo-gradient);color:#fff;box-shadow:0 4px 15px rgba(37,99,235,.3);
    }
    
    .sheet-btn-google {
      background:#fff;color:var(--text-primary);border:1px solid #ccc;margin-bottom:15px;
    }
    
    .sheet-btn-google img{width:20px;height:20px}
    
    /* Welcome State */
    .welcome-state {
      text-align:center;padding:60px 20px;color:var(--text-muted);flex:1;display:flex;
      flex-direction:column;justify-content:center;align-items:center;
    }
    
    .welcome-icon {
      font-size:64px;background:var(--logo-gradient);-webkit-background-clip:text;
      -webkit-text-fill-color:transparent;margin-bottom:24px;font-variation-settings:'wght' 200;
    }
    
    .welcome-title {
      font-family:var(--font-head);font-size:32px;font-weight:600;margin-bottom:12px;
    }
    
    .welcome-text {
      color:var(--text-muted);font-size:16px;max-width:400px;line-height:1.5;margin-bottom:20px;
    }
    
    /* Loading */
    .loading-state {
      text-align:center;padding:40px;color:var(--text-muted);
    }
    
    .loading-spinner {
      display:inline-block;width:40px;height:40px;border:3px solid var(--surface-color);
      border-top:3px solid var(--accent-blue);border-radius:50%;animation:spin 1s linear infinite;
      margin-bottom:16px;
    }
    
    /* Animations */
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{to{opacity:.3;transform:translateY(-2px)}}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    
    /* Desktop Layout - Same as AI page */
    @media (min-width: 768px) {
      .input-area {
        left:50%;transform:translateX(-50%);width:90%;max-width:800px;border-radius:24px;
        margin-bottom:20px;background:rgba(255,255,255,.95);backdrop-filter:blur(12px);
        box-shadow:0 -4px 20px rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.08);
      }
      
      .input-area .input-wrapper {
        border-radius:20px;background:transparent;backdrop-filter:none;border:none;box-shadow:none;
      }
      
      .community-messages {
        padding:20px 0 180px;
      }
      
      .message-item {
        max-width:70%;
      }
      
      .message-item.user {
        margin-left:auto;margin-right:auto;
      }
      
      .message-item:not(.own) {
        margin-left:auto;margin-right:auto;
      }
      
      /* Center welcome state */
      .welcome-state {
        max-width:800px;margin:0 auto;padding:40px 20px;
      }
    }
    
    /* Mobile adjustments */
    @media (max-width: 767px) {
      .input-area {
        left:0;right:0;width:100%;transform:none;border-radius:0;margin-bottom:0;
      }
    }
  </style>
</head>
<body>
  <!-- Rain Canvas -->
  <canvas id="rainCanvas"></canvas>
  
  <!-- Auth Sheet Overlay -->
  <div class="auth-overlay" id="authOverlay"></div>
  
  <!-- Auth Sheet - Same as AI page -->
  <div class="auth-sheet" id="authSheet">
    <div class="sheet-header">
      Welcome to Vynix Community
      <button class="sheet-close-btn" onclick="closeAuthSheet()">
        <span class="material-symbols-rounded">close</span>
      </button>
    </div>
    
    <div class="sheet-tab-bar">
      <div class="sheet-tab active" data-tab="signin">Sign In</div>
      <div class="sheet-tab" data-tab="signup">Sign Up</div>
    </div>
    
    <div id="signin-content" class="sheet-tab-content">
      <input type="email" placeholder="Email Address" class="sheet-input" id="signInEmail">
      <input type="password" placeholder="Password" class="sheet-input" id="signInPassword">
      <button class="sheet-btn sheet-btn-primary" onclick="handleSignIn()">Sign In</button>
      
      <button class="sheet-btn sheet-btn-google" onclick="signInWithGoogle()">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M9 18c3.24 0 5.97-1.075 7.956-2.92l-2.908-2.26c-1.075.72-2.456 1.155-4.048 1.155-3.097 0-5.716-2.092-6.655-4.906H.89v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M2.345 10.064A5.367 5.367 0 0 1 2.345 7.94V5.608H.89a8.997 8.997 0 0 0 0 8.088l1.455-1.332z" fill="#FBBC05"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M9 3.58c1.592 0 3.022.546 4.14 1.61l3.067-3.067C14.97.84 12.24 0 9 0 5.49 0 2.276 1.917.89 4.876l2.455 1.884C3.748 4.67 6.167 3.58 9 3.58z" fill="#EA4335"/>
        </svg>
        <span style="font-family:'Roboto',sans-serif;font-weight:500;font-size:14px;color:#1F1F1F">Sign in with Google</span>
      </button>
    </div>
    
    <div id="signup-content" class="sheet-tab-content" style="display:none">
      <input type="text" placeholder="Display Name" class="sheet-input" id="signUpName">
      <input type="email" placeholder="Email Address" class="sheet-input" id="signUpEmail">
      <input type="password" placeholder="Password (min 6 chars)" class="sheet-input" id="signUpPassword">
      <button class="sheet-btn sheet-btn-primary" onclick="handleSignUp()">Sign Up</button>
    </div>
  </div>
  
  <!-- Header - Same as AI page header -->
  <header class="community-header">
    <div class="header-left">
      <button class="back-btn" onclick="goBack()">
        <span class="material-symbols-rounded">arrow_back</span>
      </button>
      <div class="community-logo">
        <span class="material-symbols-rounded logo-icon">groups</span>
        <span class="logo-text">Vynix Community</span>
      </div>
    </div>
    <div class="online-indicator">
      <span class="online-dot"></span>
      <span id="onlineCount">0 online</span>
    </div>
  </header>
  
  <!-- Messages Container - Same as AI page chat container -->
  <main class="community-messages" id="messagesContainer">
    <div class="loading-state" id="loadingState">
      <div class="loading-spinner"></div>
      <p>Loading community messages...</p>
    </div>
  </main>
  
  <!-- Input Area - Same as AI page input wrapper -->
  <div class="input-area">
    <div class="input-wrapper">
      <input 
        type="text" 
        id="messageInput" 
        class="message-input" 
        placeholder="Share with the community..."
        autocomplete="off"
      >
      <button class="send-button" id="sendButton">
        <span class="material-symbols-rounded">send</span>
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { 
      getAuth, 
      onAuthStateChanged, 
      GoogleAuthProvider, 
      signInWithPopup,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      updateProfile
    } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { 
      getFirestore, 
      collection, 
      query, 
      orderBy, 
      limit, 
      addDoc, 
      onSnapshot, 
      serverTimestamp,
      where,
      getDocs,
      doc,
      setDoc
    } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
    
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // DOM Elements
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const loadingState = document.getElementById('loadingState');
    const authOverlay = document.getElementById('authOverlay');
    const authSheet = document.getElementById('authSheet');
    const onlineCount = document.getElementById('onlineCount');
    
    let currentUser = null;
    let messagesUnsubscribe = null;
    let onlineUsersUnsubscribe = null;
    
    // Same auth functions as AI page
    window.openAuthSheet = () => {
      authOverlay.classList.add('open');
      authSheet.classList.add('open');
    };
    
    window.closeAuthSheet = () => {
      authOverlay.classList.remove('open');
      authSheet.classList.remove('open');
    };
    
    authOverlay.addEventListener('click', closeAuthSheet);
    
    // Tab switching
    document.getElementById('authSheet').addEventListener('click', (e) => {
      const tab = e.target.closest('.sheet-tab');
      if (!tab) return;
      const target = tab.dataset.tab;
      document.querySelectorAll('.sheet-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.sheet-tab-content').forEach(c => c.style.display = 'none');
      tab.classList.add('active');
      document.getElementById(`${target}-content`).style.display = 'block';
    });
    
    // Auth functions - Same as AI page
    window.signInWithGoogle = async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
        closeAuthSheet();
      } catch (e) {
        alert('Google Sign-In failed: ' + e.message);
      }
    };
    
    window.handleSignIn = async () => {
      const email = document.getElementById('signInEmail').value.trim();
      const password = document.getElementById('signInPassword').value;
      if (!email || !password) return alert('Please enter both email and password.');
      try {
        await signInWithEmailAndPassword(auth, email, password);
        closeAuthSheet();
      } catch (e) {
        let msg = 'Sign-In failed.';
        if (e.code === 'auth/user-not-found') msg = 'No user found with this email.';
        else if (e.code === 'auth/wrong-password') msg = 'Incorrect password.';
        alert(msg);
      }
    };
    
    window.handleSignUp = async () => {
      const name = document.getElementById('signUpName').value.trim();
      const email = document.getElementById('signUpEmail').value.trim();
      const password = document.getElementById('signUpPassword').value;
      if (!name || !email || password.length < 6) return alert('Please enter valid details (password min 6 chars).');
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(cred.user, { displayName: name });
        closeAuthSheet();
      } catch (e) {
        let msg = 'Sign-Up failed.';
        if (e.code === 'auth/email-already-in-use') msg = 'Email already in use.';
        alert(msg);
      }
    };
    
    // Authentication State
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.placeholder = "Share with the community...";
        loadMessages();
        updateUserPresence();
      } else {
        messageInput.disabled = true;
        sendButton.disabled = true;
        messageInput.placeholder = "Sign in to join the conversation";
        loadingState.style.display = 'none';
        showWelcomeState();
      }
    });
    
    // Load Messages
    function loadMessages() {
      loadingState.style.display = 'block';
      
      const q = query(
        collection(db, 'communityMessages'),
        orderBy('createdAt', 'asc'),
        limit(100)
      );
      
      messagesUnsubscribe = onSnapshot(q, (snapshot) => {
        loadingState.style.display = 'none';
        const messages = [];
        snapshot.forEach((doc) => {
          messages.push({ id: doc.id, ...doc.data() });
        });
        renderMessages(messages);
        scrollToBottom();
      }, (error) => {
        console.error('Error loading messages:', error);
        loadingState.innerHTML = '<p>Error loading messages. Please refresh.</p>';
      });
    }
    
    // Render Messages
    function renderMessages(messages) {
      messagesContainer.innerHTML = '';
      
      if (messages.length === 0) {
        showWelcomeState();
        return;
      }
      
      messages.forEach(message => {
        const messageElement = createMessageElement(message);
        messagesContainer.appendChild(messageElement);
      });
    }
    
    // Create Message Element
    function createMessageElement(message) {
      const isOwn = currentUser && message.userId === currentUser.uid;
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message-item ${isOwn ? 'own' : ''}`;
      
      const avatar = message.userName?.charAt(0).toUpperCase() || '?';
      const time = formatTime(message.createdAt?.toDate?.() || new Date());
      
      messageDiv.innerHTML = `
        ${!isOwn ? `<div class="user-avatar">${avatar}</div>` : ''}
        <div class="message-content">
          <div class="message-header">
            <span class="message-author">${message.userName || 'Anonymous'}</span>
            <span class="message-time">${time}</span>
          </div>
          <div class="message-text">${escapeHtml(message.text)}</div>
        </div>
      `;
      
      return messageDiv;
    }
    
    // Show Welcome State
    function showWelcomeState() {
      messagesContainer.innerHTML = `
        <div class="welcome-state">
          <span class="material-symbols-rounded welcome-icon">groups</span>
          <h2 class="welcome-title">Welcome to Vynix Community!</h2>
          <p class="welcome-text">
            This is your space to connect with fellow African language learners. 
            Share tips, ask questions, and celebrate language learning together!
          </p>
        </div>
      `;
    }
    
    // Send Message
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      
      if (!currentUser) {
        openAuthSheet();
        return;
      }
      
      try {
        await addDoc(collection(db, 'communityMessages'), {
          text,
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email.split('@')[0],
          userEmail: currentUser.email,
          createdAt: serverTimestamp()
        });
        
        messageInput.value = '';
        scrollToBottom();
        
        // Update user presence
        await setDoc(doc(db, 'communityUsers', currentUser.uid), {
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email.split('@')[0],
          lastSeen: serverTimestamp(),
          isOnline: true
        }, { merge: true });
        
      } catch (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message. Please try again.');
      }
    }
    
    // Update User Presence and Online Count
    async function updateUserPresence() {
      if (!currentUser) return;
      
      try {
        // Update user's online status
        await setDoc(doc(db, 'communityUsers', currentUser.uid), {
          userId: currentUser.uid,
          userName: currentUser.displayName || currentUser.email.split('@')[0],
          lastSeen: serverTimestamp(),
          isOnline: true
        }, { merge: true });
        
        // Subscribe to online users count
        const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
        const q = query(
          collection(db, 'communityUsers'),
          where('lastSeen', '>', fiveMinutesAgo),
          where('isOnline', '==', true)
        );
        
        onlineUsersUnsubscribe = onSnapshot(q, (snapshot) => {
          onlineCount.textContent = `${snapshot.size} online`;
        });
        
      } catch (error) {
        console.error('Error updating user presence:', error);
      }
    }
    
    // Utility Functions
    function formatTime(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      
      return date.toLocaleDateString();
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function goBack() {
      window.location.href = '/';
    }
    
    // Event Listeners
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    messageInput.addEventListener('input', () => {
      sendButton.classList.toggle('active', messageInput.value.trim().length > 0);
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', async () => {
      if (messagesUnsubscribe) messagesUnsubscribe();
      if (onlineUsersUnsubscribe) onlineUsersUnsubscribe();
      
      if (currentUser) {
        try {
          await setDoc(doc(db, 'communityUsers', currentUser.uid), {
            isOnline: false,
            lastSeen: serverTimestamp()
          }, { merge: true });
        } catch (error) {
          console.error('Error updating user status:', error);
        }
      }
    });
    
    // Rain animation - Same as AI page
    const canvas = document.createElement('canvas');
    canvas.id = 'rainCanvas';
    document.body.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    let w, h, drops = [];
    const colors = ['#2563eb', '#d946ef', '#10b981', '#cbd5e1'];
    
    function resize() {
      w = innerWidth;
      h = innerHeight;
      canvas.width = w;
      canvas.height = h;
      drops = [];
      const count = Math.floor(w / 15);
      for (let i = 0; i < count; i++) drops.push({ x: Math.random() * w, y: Math.random() * h, len: Math.random() * 20 + 10, speed: Math.random() * 3 + 2, color: colors[Math.floor(Math.random() * colors.length)], opacity: Math.random() * 0.5 + 0.1 });
    }
    
    addEventListener('resize', resize);
    resize();
    
    function draw() {
      ctx.clearRect(0, 0, w, h);
      for (const d of drops) {
        ctx.beginPath();
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(d.x, d.y + d.len);
        ctx.strokeStyle = d.color;
        ctx.lineWidth = 1;
        ctx.globalAlpha = d.opacity;
        ctx.stroke();
        d.y += d.speed;
        if (d.y > h) {
          d.y = -d.len;
          d.x = Math.random() * w;
        }
      }
      requestAnimationFrame(draw);
    }
    draw();
  </script>
</body>
</html>
