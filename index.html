<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Post â€“ Mini Twitter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    // Firebase SDK â€“ modular imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    window.firebaseModules = {
      initializeApp, getAuth, onAuthStateChanged, signOut,
      getFirestore, collection, addDoc, serverTimestamp
    };
  </script>
  <style>
    textarea { resize: none; }
    .progress-bar { transition: width 0.3s ease; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 px-4 py-3 flex justify-between items-center sticky top-0 z-10">
    <h1 class="text-xl font-bold">Post</h1>
    <div>
      <span id="userDisplay" class="text-sm text-gray-600 mr-4 hidden"></span>
      <button id="logoutBtn" class="text-sm text-red-600 hover:underline hidden">Logout</button>
    </div>
  </header>

  <!-- Main content -->
  <main class="flex-1 p-4 max-w-lg mx-auto w-full">

    <div class="bg-white rounded-2xl shadow border border-gray-200 overflow-hidden">

      <div class="p-5">

        <div class="flex gap-4 mb-4">
          <div class="w-12 h-12 bg-blue-500 rounded-full flex-shrink-0"></div>
          <div class="flex-1">
            <textarea
              id="tweetText"
              rows="5"
              placeholder="What is happening?!"
              maxlength="280"
              class="w-full border-0 focus:ring-0 text-xl placeholder-gray-500 outline-none"
              disabled
            ></textarea>
            <div class="text-right text-sm text-gray-500 mt-1">
              <span id="charCount">0</span>/280
            </div>
          </div>
        </div>

        <!-- Media Preview -->
        <div id="previewContainer" class="hidden mb-4 rounded-xl overflow-hidden border border-gray-200 relative bg-gray-50">
          <img id="previewImage" class="hidden w-full max-h-80 object-contain" alt="Preview"/>
          <video id="previewVideo" class="hidden w-full max-h-80" controls></video>
          <button id="removeMediaBtn" class="absolute top-2 right-2 bg-black/70 text-white rounded-full w-9 h-9 flex items-center justify-center text-2xl hover:bg-black/90 transition">Ã—</button>
        </div>

        <!-- Upload Progress -->
        <div id="progressSection" class="hidden mb-5">
          <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
            <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
          </div>
          <p class="text-center text-sm text-gray-600 mt-2">
            Uploadingâ€¦ <span id="progressPercent">0</span>%
          </p>
        </div>

        <!-- Feedback message -->
        <div id="message" class="text-center mb-5 min-h-[1.5rem] text-sm"></div>

        <!-- Controls -->
        <div class="flex items-center justify-between">
          <label class="cursor-pointer hover:opacity-80 transition">
            <input type="file" id="mediaInput" accept="image/jpeg,image/png,image/gif,video/mp4,video/quicktime,video/webm" class="hidden" disabled/>
            <span class="text-blue-600 text-3xl font-bold">ðŸ“·</span>
          </label>

          <button id="postBtn" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-full hover:bg-blue-700 disabled:bg-blue-300 disabled:cursor-not-allowed transition text-lg" disabled>
            Post
          </button>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    const { initializeApp, getAuth, onAuthStateChanged, signOut, getFirestore, collection, addDoc, serverTimestamp } = window.firebaseModules;

    // â”€â”€ Your Firebase config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com/",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // â”€â”€ Cloudinary config â€“ replace these â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const CLOUD_NAME    = "YOUR_CLOUD_NAME_HERE";
    const UPLOAD_PRESET = "YOUR_UNSIGNED_PRESET_HERE";

    // â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const tweetText      = document.getElementById("tweetText");
    const charCount      = document.getElementById("charCount");
    const mediaInput     = document.getElementById("mediaInput");
    const previewImage   = document.getElementById("previewImage");
    const previewVideo   = document.getElementById("previewVideo");
    const previewCont    = document.getElementById("previewContainer");
    const removeBtn      = document.getElementById("removeMediaBtn");
    const progressSect   = document.getElementById("progressSection");
    const progressBar    = document.getElementById("progressBar");
    const progressText   = document.getElementById("progressPercent");
    const messageEl      = document.getElementById("message");
    const postBtn        = document.getElementById("postBtn");
    const userDisplay    = document.getElementById("userDisplay");
    const logoutBtn      = document.getElementById("logoutBtn");

    let selectedFile = null;
    let currentUser  = null;

    // â”€â”€ Auth check & redirect if not logged in â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    onAuthStateChanged(auth, (user) => {
      currentUser = user;

      if (!user) {
        // Redirect to your existing login page
        window.location.href = "login.html";  // â† change to your actual login filename/path
        return;
      }

      // User is authenticated â†’ show content
      userDisplay.textContent = user.email?.split('@')[0] || "User";
      userDisplay.classList.remove("hidden");
      logoutBtn.classList.remove("hidden");

      tweetText.disabled = false;
      mediaInput.disabled = false;
      postBtn.disabled = true; // will enable when there's content
      updateUI();
    });

    // â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      // Redirect happens automatically via onAuthStateChanged
    });

    // â”€â”€ UI logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateUI() {
      const len = tweetText.value.trim().length;
      charCount.textContent = len;
      postBtn.disabled = !currentUser || (!len && !selectedFile);
    }

    tweetText.addEventListener("input", updateUI);

    mediaInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      selectedFile = file;
      const url = URL.createObjectURL(file);

      if (file.type.startsWith("image/")) {
        previewImage.src = url;
        previewImage.classList.remove("hidden");
        previewVideo.classList.add("hidden");
      } else if (file.type.startsWith("video/")) {
        previewVideo.src = url;
        previewVideo.classList.remove("hidden");
        previewImage.classList.add("hidden");
      }

      previewCont.classList.remove("hidden");
      messageEl.textContent = "";
      updateUI();
    });

    removeBtn.addEventListener("click", () => {
      selectedFile = null;
      previewCont.classList.add("hidden");
      previewImage.src = "";
      previewVideo.src = "";
      mediaInput.value = "";
      updateUI();
    });

    // â”€â”€ Upload to Cloudinary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function uploadToCloudinary(file) {
      if (!CLOUD_NAME || !UPLOAD_PRESET) {
        throw new Error("Cloudinary configuration missing");
      }

      const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", UPLOAD_PRESET);

      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", url, true);

        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            progressBar.style.width = percent + "%";
            progressText.textContent = percent;
          }
        };

        xhr.onload = () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            resolve(JSON.parse(xhr.responseText));
          } else {
            reject(new Error("Upload failed"));
          }
        };

        xhr.onerror = () => reject(new Error("Network error"));
        xhr.send(formData);
      });
    }

    // â”€â”€ Save to Firestore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function saveTweet(text, media = null) {
      if (!currentUser) throw new Error("Not authenticated");

      const tweetData = {
        text,
        authorId: currentUser.uid,
        authorEmail: currentUser.email,
        createdAt: serverTimestamp(),
        likesCount: 0,
        retweetsCount: 0,
        repliesCount: 0
      };

      if (media) {
        tweetData.media = [{
          url: media.secure_url,
          public_id: media.public_id,
          resource_type: media.resource_type
        }];
      }

      await addDoc(collection(db, "tweets"), tweetData);
    }

    // â”€â”€ Post handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    postBtn.addEventListener("click", async () => {
      if (!currentUser) {
        window.location.href = "login.html";
        return;
      }

      const text = tweetText.value.trim();
      if (!text && !selectedFile) return;

      messageEl.textContent = "";
      postBtn.disabled = true;

      try {
        let mediaResult = null;
        if (selectedFile) {
          progressSect.classList.remove("hidden");
          progressBar.style.width = "0%";
          progressText.textContent = "0";
          mediaResult = await uploadToCloudinary(selectedFile);
        }

        await saveTweet(text, mediaResult);

        messageEl.className = "text-green-600";
        messageEl.textContent = "Posted successfully!";
        tweetText.value = "";
        selectedFile = null;
        previewCont.classList.add("hidden");
        mediaInput.value = "";
        progressSect.classList.add("hidden");
        updateUI();

        setTimeout(() => { messageEl.textContent = ""; }, 3000);
      } catch (err) {
        messageEl.className = "text-red-600";
        messageEl.textContent = err.message || "Failed to post tweet";
      } finally {
        postBtn.disabled = false;
      }
    });

    updateUI();
  </script>
</body>
</html>
