<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Vynix Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --primary: #3a76f0;
            --primary-dark: #2563eb;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --border-light: #e5e7eb;
            --chat-sent: #3a76f0;
            --chat-received: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --online: #10b981;
            --danger: #ef4444;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #4f86f7;
                --bg-body: #000000;
                --bg-card: #1c1c1e;
                --text-main: #f9fafb;
                --text-muted: #9ca3af;
                --border-light: #27272a;
                --chat-sent: #3a76f0;
                --chat-received: #2c2c2e;
            }
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        body {
            background: var(--bg-body);
            color: var(--text-main);
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        /* --- Main List View --- */
        #mainView {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        header {
            height: 60px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-light);
            flex-shrink: 0;
            z-index: 10;
        }
        .app-title { font-size: 20px; font-weight: 700; color: var(--primary); }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .header-actions span {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-main);
        }
        .search-container {
            padding: 10px 15px;
            background: var(--bg-card);
            flex-shrink: 0;
        }
        .search-input {
            width: 100%;
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid var(--border-light);
            background: var(--bg-body);
            color: var(--text-main);
            font-size: 14px;
        }
        .search-input:focus { outline: none; border-color: var(--primary); }
        /* Pill-shaped Sub Tabs - Centered + Swipeable */
        .sub-tabs-wrapper {
            overflow: hidden;
            background: var(--bg-card);
            flex-shrink: 0;
        }
        .sub-tabs {
            display: flex;
            justify-content: flex-start;
            gap: 12px;
            padding: 12px 15px;
            overflow-x: auto;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            transition: transform 0.3s ease;
        }
        .sub-tabs::-webkit-scrollbar { display: none; }
        .sub-tab {
            position: relative;
            padding: 8px 20px;
            border-radius: 20px;
            background: var(--bg-body);
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .sub-tab.active {
            background: var(--primary);
            color: white;
        }
        .sub-tab.unread-dot::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 12px;
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
        }
        #chatList {
            flex: 1;
            overflow-y: auto;
            background: var(--bg-card);
        }
        .chat-card {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid transparent;
            background: var(--bg-card);
        }
        .chat-card:active { background: var(--bg-body); }
        .avatar-container { position: relative; margin-right: 15px; }
        .avatar { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            object-fit: cover; 
            background: var(--border-light);
            pointer-events: none; 
        }
        .online-indicator {
            position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px;
            background: var(--online); border: 2px solid var(--bg-card); border-radius: 50%;
        }
        .chat-info { flex: 1; min-width: 0; }
        .chat-header-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .chat-name { font-weight: 600; font-size: 16px; }
        .chat-time { font-size: 12px; color: var(--text-muted); }
        .chat-msg-row { display: flex; justify-content: space-between; align-items: center; }
        .chat-msg { font-size: 14px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 85%; }
        .unread-badge {
            background: var(--primary); color: white; min-width: 18px; height: 18px;
            border-radius: 9px; padding: 0 5px; font-size: 11px; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
        }
        /* --- Full Chat View --- */
        #fullChatView {
            position: fixed; top: 0; left: 0; width: 100%; height: 100dvh;
            background: var(--bg-body);
            display: none;
            flex-direction: column;
            z-index: 2000;
        }
        .chat-bg-pattern {
            position: absolute; inset: 0; z-index: -1; opacity: 0.05;
            background-image: radial-gradient(#000 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
        }
        @media (prefers-color-scheme: dark) { .chat-bg-pattern { background-image: radial-gradient(#fff 1px, transparent 1px); opacity: 0.08; } }
        #chatHeader {
            flex-shrink: 0;
            height: 65px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-light);
            display: flex; align-items: center; padding: 0 10px;
            z-index: 20;
        }
        @media (prefers-color-scheme: dark) { #chatHeader { background: rgba(28,28,30,0.95); } }
        #chatBackBtn { padding: 10px; cursor: pointer; color: var(--text-main); margin-right: 5px; }
        #chatFriendInfo { display: flex; align-items: center; flex: 1; overflow: hidden; }
        #chatFriendAvatar { 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            margin-right: 10px;
            pointer-events: none; 
        }
        #chatFriendName { font-weight: 600; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #chatStatusInfo { font-size: 12px; color: var(--text-muted); }
        #messageList {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            overscroll-behavior-y: contain;
        }
        .message {
            max-width: 75%;
            padding: 8px 14px;
            font-size: 15px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
            touch-action: pan-y;
        }
        .message.received {
            align-self: flex-start;
            background: var(--chat-received);
            color: var(--text-main);
            border-radius: 16px 16px 16px 4px;
        }
        .message.sent {
            align-self: flex-end;
            background: var(--primary);
            color: #fff;
            border-radius: 16px 16px 4px 16px;
        }
        .message.pending {
            opacity: 0.7;
        }
        .message.swiping {
            transform: translateX(-20px);
            transition: transform 0.2s ease;
        }
        .message-time {
            font-size: 10px;
            margin-top: 4px;
            text-align: right;
            opacity: 0.7;
        }
        .pending-indicator {
            font-size: 12px;
            opacity: 0.6;
            margin-top: 4px;
            text-align: right;
        }
        /* Message Actions Popup */
        .message-actions-popup {
            position: fixed;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            padding: 8px 0;
            z-index: 3000;
            display: none;
            min-width: 160px;
        }
        .message-action-item {
            padding: 12px 20px;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }
        .message-action-item:active {
            background: var(--bg-body);
        }
        .message-action-item .material-symbols-rounded {
            font-size: 20px;
        }
        .message-action-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            z-index: 2999;
            display: none;
        }
        /* Reaction Styles */
        .reaction-picker {
            position: fixed;
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            padding: 12px;
            z-index: 3500;
            display: none;
            gap: 8px;
            flex-wrap: wrap;
            max-width: 280px;
        }
        .reaction-emoji {
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .reaction-emoji:hover {
            background: var(--bg-body);
        }
        .reaction-emoji:active {
            transform: scale(0.9);
        }
        .message-reactions {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            flex-wrap: wrap;
        }
        .reaction-badge {
            background: rgba(0,0,0,0.1);
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 2px;
            cursor: pointer;
        }
        .reaction-badge .emoji {
            font-size: 14px;
        }
        .reaction-badge .count {
            font-size: 10px;
            font-weight: 600;
        }
        .reaction-badge.user-reacted {
            background: var(--primary) !important;
            color: white !important;
        }
        @media (prefers-color-scheme: dark) {
            .reaction-badge {
                background: rgba(255,255,255,0.1);
            }
        }
        #chatInputArea {
            flex-shrink: 0;
            background: var(--bg-card);
            padding: 8px 10px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            border-top: 1px solid var(--border-light);
            z-index: 20;
        }
        .input-wrapper {
            flex: 1;
            background: var(--bg-body);
            border-radius: 20px;
            padding: 8px 14px;
            display: flex;
            align-items: center;
        }
        #messageInput {
            flex: 1;
            background: transparent;
            border: none;
            font-size: 15px;
            max-height: 120px;
            resize: none;
            color: var(--text-main);
            padding: 0;
            line-height: 1.3;
        }
        #messageInput:focus { outline: none; }
        #sendBtn {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            display: none;
        }
        #sendBtn.visible { display: flex; }
        #fabAddFriend {
            position: fixed; bottom: 25px; right: 25px;
            width: 56px; height: 56px;
            background: var(--primary); color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(58, 118, 240, 0.4);
            cursor: pointer; z-index: 100;
        }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2500; display: none; }
        .overlay.active { display: block; }
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-card);
            border-radius: 24px 24px 0 0;
            padding: 24px;
            z-index: 2600;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            max-height: 80vh;
            overflow-y: auto;
        }
        .bottom-sheet.active { transform: translateY(0); }
        .v-input { width: 100%; padding: 14px; border: 1px solid var(--border-light); border-radius: 12px; margin-bottom: 12px; font-size: 15px; background: var(--bg-body); color: var(--text-main); }
        .btn-primary { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 15px; cursor: pointer; }
        .btn-danger { background: var(--danger); }
        .btn-secondary {
            background: var(--bg-body);
            color: var(--text-main);
            border: 1px solid var(--border-light);
        }
        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 30px; z-index: 3000; font-size: 13px; display: none; }
        #pageLoader { position: fixed; inset: 0; background: var(--bg-body); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .shimmer { background: linear-gradient(90deg, var(--bg-body) 25%, var(--border-light) 50%, var(--bg-body) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        /* Friends list in sheet */
        .friend-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            cursor: pointer;
        }
        .friend-item .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-right: 15px;
            pointer-events: none;
        }
        .friend-item .chat-name {
            font-size: 16px;
        }
        /* Confirmation Dialog */
        .confirm-dialog {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        .confirm-dialog.active {
            display: flex;
        }
        .confirm-box {
            background: var(--bg-card);
            width: 90%;
            max-width: 320px;
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .confirm-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .confirm-message {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 24px;
        }
        .confirm-buttons {
            display: flex;
            gap: 12px;
        }
        .confirm-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .confirm-cancel {
            background: var(--bg-body);
            color: var(--text-main);
        }
        .confirm-delete {
            background: var(--danger);
            color: white;
        }
        /* Context Menu on Long Press */
        #contextMenu {
            position: fixed;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            padding: 8px 0;
            z-index: 4000;
            display: none;
            min-width: 160px;
        }
        .menu-item {
            padding: 12px 20px;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .menu-item:active {
            background: var(--bg-body);
        }
        /* Ensure no long-press on any image/avatar */
        img, .avatar {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            pointer-events: none;
        }
        .message-ticks {
            font-size: 16px;
            color: var(--text-muted);
            margin-left: 4px;
            vertical-align: middle;
        }
        .message-ticks.read {
            color: var(--primary);
        }
        /* Forward selector styles */
        .forward-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 4000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .forward-selector {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            max-width: 400px;
            max-height: 70vh;
            overflow-y: auto;
            width: 90%;
        }
        .forward-friend-item {
            display: flex;
            align-items: center;
            padding: 12px;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background 0.2s;
        }
        .forward-friend-item:hover {
            background: var(--bg-body);
        }
        .forward-friend-item.selected {
            background: var(--primary);
            color: white;
        }
        .message-edit-input {
            width: 100%;
            min-height: 40px;
            padding: 8px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background: var(--bg-body);
            color: var(--text-main);
            font-size: 14px;
            resize: vertical;
        }

        @keyframes splashPulse {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
    }
    50% {
        transform: scale(1.05);
        box-shadow: 0 0 0 20px rgba(255, 255, 255, 0);
    }
}

#pageLoader {
    background: var(--primary) !important;
    color: white;
    transition: opacity 0.6s ease;
    opacity: 1;
}

.splash-container {
    text-align: center;
}

.logo-circle {
    width: 160px;
    height: 160px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 40px;
    animation: splashPulse 2.2s ease-in-out infinite;
}

.logo-circle .material-symbols-rounded {
    font-size: 96px;
    color: var(--primary);
}

.app-name {
    font-size: 36px;
    font-weight: 700;
    letter-spacing: 1px;
}
        .header-actions span:hover {
    color: var(--danger);
    transition: color .2s;
}
        /* keep sheet below friends sheet z-index */
#profileOverlay { z-index: 2600; }
#profileSheet   { z-index: 2610; }
    </style>
</head>
<body>
    <div id="pageLoader">
    <div class="splash-container">
        <div class="logo-circle">
            <span class="material-symbols-rounded">chat_bubble_outline</span>
        </div>
        <div class="app-name">Vynix Chat</div>
        <div style="margin-top: 20px; opacity: 0.8; font-size: 16px;">Connecting...</div>
    </div>
</div>
    <div id="toast"></div>
    <div id="mainView">
  <header>
    <div style="display:flex;align-items:center;">
        <img id="myAvatar" class="avatar shimmer" src="" style="width:34px;height:34px;margin-right:12px;border:none;">
        <div>
            <div class="app-title">Vynix Chat</div>
            <div id="myVynixId" style="font-size:12px;color:var(--text-muted);margin-top:2px;">Loading...</div>
        </div>
    </div>
    <div class="header-actions">
        <!-- NEW: settings gear -->
        <span class="material-symbols-rounded" onclick="openProfileSheet()" title="Profile settings">settings</span>
        <span class="material-symbols-rounded" onclick="confirmClearAllChats()" title="Clear all chats">delete_sweep</span>
    </div>
</header>
        <div class="search-container">
            <input type="text" class="search-input" id="friendSearch" placeholder="Search chats..." onkeyup="searchFriends()">
        </div>
        <div class="sub-tabs-wrapper">
            <div class="sub-tabs" id="subTabs">
                <div class="sub-tab active" data-tab="all">All</div>
                <div class="sub-tab" data-tab="favourite">Favourite</div>
                <div class="sub-tab" data-tab="unread">Unread</div>
                <div class="sub-tab" data-tab="archived">Archived</div>
            </div>
        </div>
        <div id="chatList"></div>
    </div>
    <div id="fullChatView">
        <div class="chat-bg-pattern"></div>
        <div id="chatHeader">
            <span class="material-symbols-rounded" id="chatBackBtn" onclick="closeFullChat()">arrow_back</span>
            <div id="chatFriendInfo">
                <img id="chatFriendAvatar" src="">
                <div>
                    <div id="chatFriendName"></div>
                    <div id="chatStatusInfo">Loading...</div>
                </div>
            </div>
        </div>
        <div id="messageList"></div>
        <div id="chatInputArea">
            <div class="input-wrapper">
                <textarea id="messageInput" rows="1" placeholder="Type a message..." oninput="autoResizeInput(this)" onkeypress="handleEnter(event)"></textarea>
            </div>
            <div id="sendBtn"><span class="material-symbols-rounded">arrow_upward</span></div>
        </div>
    </div>
    <div class="overlay" id="overlay" onclick="closeAll()"></div>
 <div class="bottom-sheet" id="friendsSheet">
     <div style="margin-top:20px;">
        <input type="text" id="friendVynixId" class="v-input" placeholder="Enter Vynix ID (e.g. vnx_...)">
        <button class="btn-primary" onclick="addFriendLogic()">Add Friend</button>
    </div>
    <h3 style="margin-bottom:15px; font-weight:700;">All Users</h3>
    <div id="friendsList"></div>
    
</div>
    <div id="fabAddFriend" onclick="openFriendsSheet()">
        <span class="material-symbols-rounded">person_add</span>
    </div>

    <!-- Confirmation Dialog -->
    <div class="confirm-dialog" id="clearAllConfirm">
        <div class="confirm-box">
            <div class="confirm-title">Clear All Chats?</div>
            <div class="confirm-message">This will permanently delete all your conversations from both sides. This action cannot be undone.</div>
            <div class="confirm-buttons">
                <button class="confirm-cancel" onclick="closeConfirm()">Cancel</button>
                <button class="confirm-delete" onclick="executeClearAllChats()">Delete All</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu">
        <div class="menu-item" onclick="markAsFavourite(currentContextUid)">
            <span class="material-symbols-rounded">star</span> Favourite
        </div>
        <div class="menu-item" onclick="archiveChat(currentContextUid)">
            <span class="material-symbols-rounded">archive</span> Archive
        </div>
    </div>

    <!-- Reaction Picker -->
    <div class="reaction-picker" id="reactionPicker">
        <div class="reaction-emoji" data-emoji="üëç">üëç</div>
        <div class="reaction-emoji" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</div>
        <div class="reaction-emoji" data-emoji="üòÇ">üòÇ</div>
        <div class="reaction-emoji" data-emoji="üòÆ">üòÆ</div>
        <div class="reaction-emoji" data-emoji="üò¢">üò¢</div>
        <div class="reaction-emoji" data-emoji="üî•">üî•</div>
        <div class="reaction-emoji" data-emoji="üëè">üëè</div>
        <div class="reaction-emoji" data-emoji="üéâ">üéâ</div>
    </div>

    <!-- Message Actions Popup -->
    <div class="message-action-overlay" id="messageActionOverlay" onclick="hideMessageActions()"></div>
    <div class="message-actions-popup" id="messageActionsPopup">
        <div class="message-action-item" onclick="deleteMessage()">
            <span class="material-symbols-rounded">delete</span> Delete
        </div>
        <div class="message-action-item" onclick="editMessage()">
            <span class="material-symbols-rounded">edit</span> Edit
        </div>
        <div class="message-action-item" onclick="forwardMessage()">
            <span class="material-symbols-rounded">forward</span> Forward
        </div>
    </div>

    <!-- =====  PROFILE SHEET  ===== -->
<div class="overlay" id="profileOverlay" onclick="closeProfileSheet()"></div>
<div class="bottom-sheet" id="profileSheet">
    <h3 style="margin-bottom:20px;font-weight:700;">Profile Settings</h3>

    <!-- Avatar -->
    <div style="text-align:center;margin-bottom:20px;">
        <img id="profileAvatar" class="avatar" src="" style="width:90px;height:90px;">
        <br>
        <label class="btn-secondary" style="display:inline-block;margin-top:10px;padding:8px 16px;cursor:pointer;">
            <input type="file" accept="image/*" id="avatarInput" style="display:none;" onchange="uploadAvatar(this.files)">
            Change photo
        </label>
    </div>

    <!-- Username -->
    <input type="text" id="profileNameInput" class="v-input" placeholder="Your name" maxlength="30">
    <div style="text-align:center;font-size:12px;color:var(--text-muted);margin-top:6px;">Tap outside to save</div>
</div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
/* ==========  CONFIG  ========== */
const CLOUD_NAME    = 'YOUR_CLOUD_NAME';        // <‚Äî your Cloudinary cloud
const UPLOAD_PRESET = 'YOUR_UNSIGNED_PRESET';   // <‚Äî unsigned-upload preset
const CL_URL        = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;

/* ==========  FIREBASE  ========== */
const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.firebasestorage.app",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();

/* ==========  GLOBALS  ========== */
let currentUser = null;
let myProfile   = { name:'', photo:'' };
let myVId       = '';
let currentFriendUid = null;
let currentRoomId    = null;
let chatsListener= null;
let messagesListener= null;
let sharedKeys  = JSON.parse(localStorage.getItem('sharedKeys')||'{}');
let currentSubTab = 'all';
let currentContextUid = null;
let cachedChats = JSON.parse(localStorage.getItem('cached_chats')||'{}');
let idb = null;
const DB_NAME = 'vynix_messages';
const DB_VERSION = 1;
const STORE_NAME = 'messages';

/* ==========  INDEXEDDB  ========== */
function openIndexedDB() {
  return new Promise((res,rej)=>{
    const req = indexedDB.open(DB_NAME,DB_VERSION);
    req.onerror=()=>rej(req.error);
    req.onsuccess=()=>{ idb=req.result; res(idb); };
    req.onupgradeneeded=e=>{
      const store = e.target.result.createObjectStore(STORE_NAME,{keyPath:'localId',autoIncrement:true});
      store.createIndex('roomId','roomId',{unique:false});
      store.createIndex('ts','ts',{unique:false});
    };
  });
}
async function cacheMessage(roomId,msg){
  if(!idb)return;
  const tx = idb.transaction(STORE_NAME,'readwrite');
  tx.objectStore(STORE_NAME).put({roomId,...msg});
  await tx.done;
}
async function getCachedMessages(roomId){
  if(!idb)return[];
  const tx = idb.transaction(STORE_NAME,'readonly');
  const idx = tx.objectStore(STORE_NAME).index('roomId');
  return new Promise(res=>{ const r=idx.getAll(roomId); r.onsuccess=()=>res(r.result); });
}
async function clearCachedMessages(roomId){
  if(!idb)return;
  const tx = idb.transaction(STORE_NAME,'readwrite');
  const idx = tx.objectStore(STORE_NAME).index('roomId');
  const r = idx.openCursor(IDBKeyRange.only(roomId));
  r.onsuccess=()=>{const c=r.result;if(c){c.delete();c.continue();}};
  await tx.done;
}
async function clearAllCachedMessages(){
  if(!idb)return;
  const tx = idb.transaction(STORE_NAME,'readwrite');
  tx.objectStore(STORE_NAME).clear();
  await tx.done;
}

/* ==========  UTILS  ========== */
function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.display='block';
  setTimeout(()=>t.style.display='none',3000);
}
function generateLetterAvatar(name){
  if(!name)name='U';
  const initials=name.trim().split(/\s+/).map(w=>w[0]).slice(0,2).join('').toUpperCase();
  const colors=['#3a76f0','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899'];
  const hash=name.split('').reduce((a,b)=>a+b.charCodeAt(0),0);
  const bg=colors[hash%colors.length];
  const c=document.createElement('canvas');
  c.width=c.height=100;
  const ctx=c.getContext('2d');
  ctx.fillStyle=bg; ctx.fillRect(0,0,100,100);
  ctx.fillStyle='#fff'; ctx.font='bold 40px "Plus Jakarta Sans",sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(initials,50,50);
  return c.toDataURL();
}
async function generateKeyPair(){
  const kp=await crypto.subtle.generateKey({name:'ECDH',namedCurve:'P-256'},true,['deriveBits']);
  const pub=await crypto.subtle.exportKey('jwk',kp.publicKey);
  const priv=await crypto.subtle.exportKey('jwk',kp.privateKey);
  localStorage.setItem('privateKey',JSON.stringify(priv));
  return pub;
}
async function deriveSharedSecret(friendPublicJwk){
  const privJwk=JSON.parse(localStorage.getItem('privateKey'));
  const priv=await crypto.subtle.importKey('jwk',privJwk,{name:'ECDH',namedCurve:'P-256'},false,['deriveBits']);
  const friendPub=await crypto.subtle.importKey('jwk',friendPublicJwk,{name:'ECDH',namedCurve:'P-256'},false,[]);
  const secret=await crypto.subtle.deriveBits({name:'ECDH',public:friendPub},priv,256);
  return [...new Uint8Array(secret)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
function decrypt(ciphertext,friendUid){
  if(!ciphertext)return'[Message]';
  try{
    const key=sharedKeys[friendUid];
    if(!key)return'üîí Encrypted';
    const bytes=CryptoJS.AES.decrypt(ciphertext,key);
    return bytes.toString(CryptoJS.enc.Utf8)||'üîí Message';
  }catch{return'üîí Message';}
}

/* ==========  AUTH  ========== */
auth.onAuthStateChanged(async user=>{
  if(user){currentUser=user; await openIndexedDB(); initApp();}
  else{window.location.href='login.html';}
});

/* ==========  INIT  ========== */
async function initApp(){
  listenToMyProfile();
  const snap=await db.ref(`users/${currentUser.uid}/profile`).once('value');
  const data=snap.val()||{};

  if(!data.vynixId){
    myVId=await generateAndAssignVynixId();
    if(myVId){
      await db.ref(`users/${currentUser.uid}/profile`).update({vynixId:myVId});
      await db.ref(`vynix_ids/${myVId}`).set(currentUser.uid);
      document.getElementById('myVynixId').textContent=`@${myVId}`;
    }
  }else{myVId=data.vynixId; document.getElementById('myVynixId').textContent=`@${myVId}`;}

  if(!localStorage.getItem('privateKey')){
    const pubJwk=await generateKeyPair();
    await db.ref(`users/${currentUser.uid}/profile`).update({publicKey:JSON.stringify(pubJwk)});
  }

  loadChats();
  setTimeout(()=>{
    const loader=document.getElementById('pageLoader');
    loader.style.opacity='0';
    setTimeout(()=>loader.style.display='none',600);
  },800);

  window.addEventListener('online',syncPendingMessages);
  setupSubTabHandlers();
}

function listenToMyProfile(){
  db.ref(`users/${currentUser.uid}/profile`).on('value',snap=>{
    const d=snap.val()||{};
    myProfile.name=d.name||'You';
    myProfile.photo=d.photo||generateLetterAvatar(myProfile.name);
    document.getElementById('myAvatar').src=myProfile.photo;
    document.getElementById('myAvatar').classList.remove('shimmer');
    const sheetImg=document.getElementById('profileAvatar');
    if(sheetImg) sheetImg.src=myProfile.photo;
  });
}

async function generateAndAssignVynixId(){
  const chars='abcdefghijklmnopqrstuvwxyz0123456789';
  for(let i=0;i<10;i++){
    const id='vnx_'+Array.from(crypto.getRandomValues(new Uint32Array(4))).map(n=>chars[n%chars.length]).join('');
    const snap=await db.ref(`vynix_ids/${id}`).once('value');
    if(!snap.exists())return id;
  }
  return null;
}

/* ==========  SUB-TABS  ========== */
function switchSubTab(tab){
  currentSubTab=tab;
  document.querySelectorAll('.sub-tab').forEach(t=>t.classList.remove('active'));
  document.querySelector(`.sub-tab[data-tab="${tab}"]`).classList.add('active');
  if(tab==='unread')updateUnreadDot(); else document.querySelector('.sub-tab[data-tab="unread"]').classList.remove('unread-dot');
  const list=document.getElementById('chatList');
  list.innerHTML='<div style="text-align:center;padding:50px;color:var(--text-muted);">Loading...</div>';
  loadChats();
}
async function updateUnreadDot(){
  const snap=await db.ref(`users/${currentUser.uid}/chats`).once('value');
  let hasUnread=false;
  snap.forEach(child=>{if((child.val().unreadCount||0)>0)hasUnread=true;});
  const unreadTab=document.querySelector('.sub-tab[data-tab="unread"]');
  unreadTab.classList.toggle('unread-dot',hasUnread);
}
function setupSubTabHandlers(){
  document.querySelectorAll('.sub-tab').forEach(tab=>{
    tab.addEventListener('click',()=>{if(tab.dataset.tab!==currentSubTab)switchSubTab(tab.dataset.tab);});
  });
  const subTabs=document.getElementById('subTabs');
  let isDown=false,startX,scrollLeft;
  ['touchstart','mousedown'].forEach(ev=>subTabs.addEventListener(ev,e=>{
    isDown=true;startX=(e.touches?e.touches[0].pageX:e.pageX)-subTabs.offsetLeft;scrollLeft=subTabs.scrollLeft;
  }));
  ['touchmove','mousemove'].forEach(ev=>subTabs.addEventListener(ev,e=>{
    if(!isDown)return;e.preventDefault();
    const x=(e.touches?e.touches[0].pageX:e.pageX)-subTabs.offsetLeft;
    subTabs.scrollLeft=scrollLeft-(x-startX)*2;
  }));
  ['touchend','mouseup','mouseleave'].forEach(ev=>subTabs.addEventListener(ev,()=>{
    if(!isDown)return;isDown=false;
    const tabs=subTabs.querySelectorAll('.sub-tab');
    let closestTab=null,closestDist=Infinity;
    tabs.forEach(tab=>{
      const rect=tab.getBoundingClientRect(),tabCenter=rect.left+rect.width/2,containerCenter=subTabs.getBoundingClientRect().left+subTabs.clientWidth/2;
      const dist=Math.abs(tabCenter-containerCenter);
      if(dist<closestDist){closestDist=dist;closestTab=tab;}
    });
    if(closestTab){const newTab=closestTab.dataset.tab;if(newTab!==currentSubTab)switchSubTab(newTab);}
  }));
}

/* ==========  CHAT LIST  ========== */
async function loadChats(){
  if(chatsListener)chatsListener.off();
  chatsListener=db.ref(`users/${currentUser.uid}/chats`);
  let firstLoad=true;
  chatsListener.on('value',async snap=>{
    const list=document.getElementById('chatList');
    if(!snap.exists()){
      list.innerHTML='<p style="text-align:center;padding:50px;color:var(--text-muted);">No chats yet.</p>';
      updateUnreadDot();return;
    }
    if(firstLoad){
      firstLoad=false;
      const chats=[];snap.forEach(child=>{const d=child.val();if(d.lastMsg){d.uid=child.key;chats.push(d);}});
      chats.sort((a,b)=>(b.ts||0)-(a.ts||0));
      let filtered=chats;
      if(currentSubTab==='favourite')filtered=chats.filter(c=>c.isFavourite);
      else if(currentSubTab==='unread')filtered=chats.filter(c=>c.unreadCount>0);
      else if(currentSubTab==='archived')filtered=chats.filter(c=>c.isArchived);
      if(filtered.length===0){
        let msg='';switch(currentSubTab){case'all':msg='No chats yet.';break;case'favourite':msg='No favourite chats.';break;case'unread':msg='No unread chats.';break;case'archived':msg='No archived chats.';break;}
        list.innerHTML=`<p style="text-align:center;padding:50px;color:var(--text-muted);">${msg}</p>`;updateUnreadDot();return;
      }
      list.innerHTML='';
      for(const chat of filtered){
        const pSnap=await db.ref(`users/${chat.uid}/profile`).once('value');
        const profile=pSnap.val()||{name:'User',photo:''};
        const lastText=decrypt(chat.lastMsg,chat.uid);
        let readStatus='';if(chat.lastMsgSender===currentUser.uid){
          const roomId=currentUser.uid<chat.uid?`${currentUser.uid}_${chat.uid}`:`${chat.uid}_${currentUser.uid}`;
          const lastMsgSnap=await db.ref(`messages/${roomId}`).orderByChild('ts').limitToLast(1).once('value');
          lastMsgSnap.forEach(child=>{const msg=child.val();if(msg.read&&msg.sender===currentUser.uid)readStatus='<span style="color:var(--primary);margin-left:4px;">‚úì‚úì</span>';else if(msg.sender===currentUser.uid)readStatus='<span style="color:var(--text-muted);margin-left:4px;">‚úì‚úì</span>';});
        }
        const card=document.createElement('div');card.className='chat-card';card.dataset.uid=chat.uid;card.onclick=()=>openFullChat(chat.uid);
        card.innerHTML=`<div class="avatar-container"><img class="avatar" src="${profile.photo||generateLetterAvatar(profile.name)}"><div class="online-indicator" id="online_${chat.uid}" style="display:none"></div></div><div class="chat-info"><div class="chat-header-row"><div class="chat-name">${profile.name}</div><div class="chat-time" data-ts="${chat.ts}">${formatTimeAgo(chat.ts)}</div></div><div class="chat-msg-row"><div class="chat-msg">${lastText}${readStatus}</div>${chat.unreadCount>0?`<div class="unread-badge">${chat.unreadCount>99?'99+':chat.unreadCount}</div>`:''}</div></div>`;
        list.appendChild(card);db.ref(`users/${chat.uid}/online`).on('value',s=>{const el=document.getElementById(`online_${chat.uid}`);if(el)el.style.display=s.val()===true?'block':'none';});
        let longPressTimer;card.addEventListener('touchstart',e=>{longPressTimer=setTimeout(()=>showContextMenu(e,chat.uid),500);});card.addEventListener('touchend',()=>clearTimeout(longPressTimer));card.addEventListener('touchmove',()=>clearTimeout(longPressTimer));card.addEventListener('contextmenu',e=>{e.preventDefault();showContextMenu(e,chat.uid);});
        cachedChats[chat.uid]={uid:chat.uid,name:profile.name,photo:profile.photo,lastMsgText:lastText,ts:chat.ts,unreadCount:chat.unreadCount||0};
      }localStorage.setItem('cached_chats',JSON.stringify(cachedChats));updateUnreadDot();return;
    }
    snap.forEach(async child=>{const uid=child.key,data=child.val();if(!data.lastMsg)return;const card=list.querySelector(`.chat-card[data-uid="${uid}"]`);if(!card)return;
      const pSnap=await db.ref(`users/${uid}/profile`).once('value');const profile=pSnap.val()||{name:'User',photo:''};const lastText=decrypt(data.lastMsg,uid);
      let readStatus='';if(data.lastMsgSender===currentUser.uid){const roomId=currentUser.uid<uid?`${currentUser.uid}_${uid}`:`${uid}_${currentUser.uid}`;const lastMsgSnap=await db.ref(`messages/${roomId}`).orderByChild('ts').limitToLast(1).once('value');lastMsgSnap.forEach(ch=>{const msg=ch.val();if(msg.read&&msg.sender===currentUser.uid)readStatus='<span style="color:var(--primary);margin-left:4px;">‚úì‚úì</span>';else if(msg.sender===currentUser.uid)readStatus='<span style="color:var(--text-muted);margin-left:4px;">‚úì‚úì</span>';});}
      card.querySelector('.chat-name').textContent=profile.name;card.querySelector('.chat-msg').innerHTML=`${lastText}${readStatus}`;const timeEl=card.querySelector('.chat-time');timeEl.textContent=formatTimeAgo(data.ts);timeEl.dataset.ts=data.ts;
      const badgeEl=card.querySelector('.unread-badge');if(data.unreadCount>0){if(badgeEl){badgeEl.textContent=data.unreadCount>99?'99+':data.unreadCount;badgeEl.style.display='flex';}else{card.querySelector('.chat-msg-row').insertAdjacentHTML('beforeend',`<div class="unread-badge">${data.unreadCount>99?'99+':data.unreadCount}</div>`);}}else if(badgeEl)badgeEl.style.display='none';
      cachedChats[uid]={uid,name:profile.name,photo:profile.photo,lastMsgText:lastText,ts:data.ts,unreadCount:data.unreadCount||0};});localStorage.setItem('cached_chats',JSON.stringify(cachedChats));updateUnreadDot();
  });
}

/* ==========  CONTEXT MENU  ========== */
function showContextMenu(e,uid){
  e.preventDefault();currentContextUid=uid;
  const menu=document.getElementById('contextMenu');
  menu.style.display='block';menu.style.left=`${e.pageX}px`;menu.style.top=`${e.pageY}px`;
  document.addEventListener('click',hideContextMenu,{once:true});
}
function hideContextMenu(){document.getElementById('contextMenu').style.display='none';}
async function markAsFavourite(uid){
  hideContextMenu();const snap=await db.ref(`users/${currentUser.uid}/chats/${uid}/isFavourite`).once('value');const cur=snap.val()||false;
  await db.ref(`users/${currentUser.uid}/chats/${uid}`).update({isFavourite:!cur});toast(!cur?'Added to favourites':'Removed from favourites');
}
async function archiveChat(uid){
  hideContextMenu();const snap=await db.ref(`users/${currentUser.uid}/chats/${uid}/isArchived`).once('value');const cur=snap.val()||false;
  await db.ref(`users/${currentUser.uid}/chats/${uid}`).update({isArchived:!cur});toast(!cur?'Chat archived':'Chat unarchived');
}

/* ==========  CLEAR ALL CHATS  ========== */
function confirmClearAllChats(){
  const box=document.getElementById('clearAllConfirm');
  box.querySelector('.confirm-title').textContent='Clear All Chats?';
  box.querySelector('.confirm-message').textContent='This will permanently delete every conversation from both sides. Your friend list will NOT be affected.';
  box.classList.add('active');
}
function closeConfirm(){document.getElementById('clearAllConfirm').classList.remove('active');}
async function executeClearAllChats(){
  closeConfirm();
  try{
    const myChatsSnap=await db.ref(`users/${currentUser.uid}/chats`).once('value');
    if(!myChatsSnap.exists()){toast('No chats to delete');return;}
    const jobs=[];
    myChatsSnap.forEach(child=>{
      const friendUid=child.key;
      const roomId=currentUser.uid<friendUid?`${currentUser.uid}_${friendUid}`:`${friendUid}_${currentUser.uid}`;
      jobs.push(db.ref(`messages/${roomId}`).remove());
      jobs.push(db.ref(`users/${currentUser.uid}/chats/${friendUid}`).remove());
      jobs.push(db.ref(`users/${friendUid}/chats/${currentUser.uid}`).remove());
    });
    await Promise.all(jobs);
    await clearAllCachedMessages();localStorage.removeItem('cached_chats');
    toast('All chats cleared ‚úì');
  }catch(e){console.error(e);toast('Failed to delete some chats');}
}

/* ==========  PROFILE SHEET  ========== */
function openProfileSheet(){
  document.getElementById('profileAvatar').src=myProfile.photo||generateLetterAvatar(myProfile.name);
  document.getElementById('profileNameInput').value=myProfile.name;
  document.getElementById('profileOverlay').classList.add('active');
  document.getElementById('profileSheet').classList.add('active');
}
function closeProfileSheet(){
  document.getElementById('profileOverlay').classList.remove('active');
  document.getElementById('profileSheet').classList.remove('active');
}
document.getElementById('profileNameInput').addEventListener('change',async e=>{
  const newName=e.target.value.trim();if(!newName)return;
  await db.ref(`users/${currentUser.uid}/profile`).update({name:newName});
  toast('Name saved ‚úì');
});
async function uploadAvatar(files){
  if(!files.length)return;
  const file=files[0];if(!file.type.startsWith('image/')){toast('Please choose an image');return;}
  toast('Uploading‚Ä¶');
  try{
    const fd=new FormData();fd.append('file',file);fd.append('upload_preset',UPLOAD_PRESET);
    const res=await fetch(CL_URL,{method:'POST',body:fd});if(!res.ok)throw new Error('Upload failed');
    const data=await res.json();const url=data.secure_url;
    await db.ref(`users/${currentUser.uid}/profile`).update({photo:url});
    toast('Photo updated ‚úì');
  }catch(e){console.error(e);toast('Upload failed');}
}

/* ==========  FRIENDS SHEET  ========== */
async function loadFriendsList(){
  const list=document.getElementById('friendsList');
  list.innerHTML='<div style="text-align:center;padding:20px;">Loading all users...</div>';
  try{
    const usersSnap=await db.ref('users').once('value');
    if(!usersSnap.exists()){list.innerHTML='<p style="text-align:center;color:var(--text-muted);">No users found</p>';return;}
    list.innerHTML='';const users=[];
    usersSnap.forEach(child=>{
      const uid=child.key;if(uid===currentUser.uid)return;
      const prof=child.val().profile||{};
      users.push({uid,name:prof.name||'User',photo:prof.photo||'',vynixId:prof.vynixId||''});
    });
    users.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
    if(users.length===0){list.innerHTML='<p style="text-align:center;color:var(--text-muted);">No other users found</p>';return;}
    for(const u of users){
      const el=document.createElement('div');el.className='friend-item';el.style.cssText='display:flex;align-items:center;padding:12px 0;cursor:pointer;border-bottom:1px solid var(--border-light);';
      el.innerHTML=`<img class="avatar" src="${u.photo||generateLetterAvatar(u.name)}" style="width:48px;height:48px;margin-right:15px;"><div style="flex:1;"><div class="chat-name">${u.name}</div>${u.vynixId?`<div style="font-size:12px;color:var(--text-muted);">@${u.vynixId}</div>`:''}</div><span class="material-symbols-rounded" style="color:var(--primary);">chat_bubble</span>`;
      el.addEventListener('click',()=>{closeAll();openFullChat(u.uid);});
      list.appendChild(el);
    }
  }catch(e){console.error(e);list.innerHTML='<p style="text-align:center;color:var(--text-muted);">Error loading users</p>';}
}
function openFriendsSheet(){loadFriendsList();document.getElementById('overlay').classList.add('active');document.getElementById('friendsSheet').classList.add('active');}
function closeAll(){document.getElementById('overlay').classList.remove('active');document.getElementById('friendsSheet').classList.remove('active');}

/* ==========  FULL CHAT  ========== */
async function openFullChat(friendUid){
  currentFriendUid=friendUid;
  currentRoomId=currentUser.uid<friendUid?`${currentUser.uid}_${friendUid}`:`${friendUid}_${currentUser.uid}`;
  const snap=await db.ref(`users/${friendUid}/profile`).once('value');
  const profile=snap.val()||{name:'User',photo:''};
  document.getElementById('chatFriendName').textContent=profile.name;
  document.getElementById('chatFriendAvatar').src=profile.photo||generateLetterAvatar(profile.name);
  if(!sharedKeys[friendUid]&&profile.publicKey){
    const secret=await deriveSharedSecret(JSON.parse(profile.publicKey));
    sharedKeys[friendUid]=secret;localStorage.setItem('sharedKeys',JSON.stringify(sharedKeys));
  }
  document.getElementById('fullChatView').style.display='flex';
  loadMessages();markAsRead(friendUid);
  db.ref(`users/${friendUid}/online`).on('value',s=>{
    const st=document.getElementById('chatStatusInfo');st.textContent=s.val()===true?'Online':'Offline';st.style.color=s.val()===true?'var(--online)':'var(--text-muted)';
  });
  history.pushState({chatOpen:true},'');
}
function closeFullChat(){
  document.getElementById('fullChatView').style.display='none';
  if(messagesListener){messagesListener.off();messagesListener=null;}
  currentFriendUid=null;history.back();
}

/* ==========  MESSAGES  ========== */
function createMessageElement(text,isSent,ts,localId='',msgKey='',isRead=false,reactions={}){
  const el=document.createElement('div');el.className=`message ${isSent?'sent':'received'} ${localId?'pending':''}`;
  if(localId)el.dataset.localId=localId;if(msgKey)el.dataset.msgKey=msgKey;
  let reactionsHtml='';if(reactions&&Object.keys(reactions).length>0){
    reactionsHtml='<div class="message-reactions">';
    Object.entries(reactions).forEach(([emoji,users])=>{if(users&&users.length>0){const count=users.length;const userReacted=users.includes(currentUser.uid);reactionsHtml+=`<div class="reaction-badge ${userReacted?'user-reacted':''}" data-emoji="${emoji}" data-key="${msgKey}" onclick="toggleReaction('${msgKey}','${emoji}')"><span class="emoji">${emoji}</span>${count>1?`<span class="count">${count}</span>`:''}</div>`;}});
    reactionsHtml+='</div>';
  }
  const ticks=isSent?`<span class="message-ticks ${isRead?'read':''}">‚úì‚úì</span>`:'';
  el.innerHTML=`<div class="message-content">${text}</div><div class="message-time">${formatMessageTime(ts)}${ticks}</div>${reactionsHtml}`;
  let longPressTimer;el.addEventListener('touchstart',e=>{longPressTimer=setTimeout(()=>showReactionPicker(e,el,msgKey),500);});el.addEventListener('touchend',()=>clearTimeout(longPressTimer));el.addEventListener('touchmove',()=>clearTimeout(longPressTimer));el.addEventListener('contextmenu',e=>{e.preventDefault();showReactionPicker(e,el,msgKey);});
  addSwipeListeners(el);return el;
}
async function loadMessages(){
  if(messagesListener)messagesListener.off();
  const list=document.getElementById('messageList');
  list.innerHTML='';const processed=new Set();
  if(navigator.onLine){
    try{
      const snap=await db.ref(`messages/${currentRoomId}`).limitToLast(100).once('value');
      if(snap.exists()){
        const msgs=[];snap.forEach(child=>{const m=child.val();m.key=child.key;msgs.push(m);});msgs.sort((a,b)=>a.ts-b.ts);
        msgs.forEach(msg=>{processed.add(msg.key);const isSent=msg.sender===currentUser.uid;const text=decrypt(msg.text,currentFriendUid);const el=createMessageElement(text,isSent,msg.ts,'',msg.key,msg.read||false,msg.reactions||{});list.appendChild(el);});
        list.scrollTop=list.scrollHeight;
      }
    }catch(e){console.error(e);}
  }else{
    const cached=await getCachedMessages(currentRoomId);if(cached.length){cached.sort((a,b)=>a.ts-b.ts);cached.forEach(m=>{if(m.key)processed.add(m.key);const isSent=m.sender===currentUser.uid;const text=decrypt(m.text,currentFriendUid);const el=createMessageElement(text,isSent,m.ts,m.localId||'',m.key||'',m.read||false,m.reactions||{});list.appendChild(el);});list.scrollTop=list.scrollHeight;}
  }
  messagesListener=db.ref(`messages/${currentRoomId}`).limitToLast(100);
  messagesListener.on('child_added',async snap=>{
    const msg=snap.val();msg.key=snap.key;if(processed.has(msg.key))return;processed.add(msg.key);await cacheMessage(currentRoomId,msg);
    if(msg.localId){const pending=list.querySelector(`[data-local-id="${msg.localId}"]`);if(pending)pending.remove();}
    const isSent=msg.sender===currentUser.uid;const text=decrypt(msg.text,currentFriendUid);const el=createMessageElement(text,isSent,msg.ts,'',msg.key,msg.read||false,msg.reactions||{});list.appendChild(el);list.scrollTop=list.scrollHeight;
    if(!isSent&&currentFriendUid)await db.ref(`messages/${currentRoomId}/${msg.key}`).update({read:true});
  });
  db.ref(`messages/${currentRoomId}`).on('child_changed',snap=>{
    const msg=snap.val();const existing=list.querySelector(`[data-msg-key="${snap.key}"]`);if(!existing)return;
    const reactionsContainer=existing.querySelector('.message-reactions');if(reactionsContainer)reactionsContainer.remove();
    if(msg.reactions&&Object.keys(msg.reactions).length>0){
      let html='<div class="message-reactions">';Object.entries(msg.reactions).forEach(([emoji,users])=>{if(users&&users.length>0){const count=users.length;const userReacted=users.includes(currentUser.uid);html+=`<div class="reaction-badge ${userReacted?'user-reacted':''}" data-emoji="${emoji}" data-key="${snap.key}" onclick="toggleReaction('${snap.key}','${emoji}')"><span class="emoji">${emoji}</span>${count>1?`<span class="count">${count}</span>`:''}</div>`;}});html+='</div>';
      existing.querySelector('.message-time').insertAdjacentHTML('afterend',html);
    }
    const ticks=existing.querySelector('.message-ticks');if(ticks&&msg.read){ticks.classList.add('read');ticks.textContent='‚úì‚úì';}
  });
}
async function syncPendingMessages(){
  if(!navigator.onLine)return;
  const cached=await getCachedMessages(currentRoomId);const pending=cached.filter(m=>m.pending);
  for(const msg of pending){
    try{
      await db.ref(`messages/${currentRoomId}`).push({text:msg.text,sender:currentUser.uid,ts:msg.ts,read:false});
      const updates={};updates[`users/${currentUser.uid}/chats/${currentFriendUid}/lastMsg`]=msg.text;updates[`users/${currentUser.uid}/chats/${currentFriendUid}/ts`]=msg.ts;
      updates[`users/${currentFriendUid}/chats/${currentUser.uid}/lastMsg`]=msg.text;updates[`users/${currentFriendUid}/chats/${currentUser.uid}/ts`]=msg.ts;
      updates[`users/${currentFriendUid}/chats/${currentUser.uid}/unreadCount`]=firebase.database.ServerValue.increment(1);
      await db.ref().update(updates);
      const tx=idb.transaction(STORE_NAME,'readwrite');const store=tx.objectStore(STORE_NAME);const getReq=store.get(msg.localId);getReq.onsuccess=()=>{const rec=getReq.result;if(rec){delete rec.pending;store.put(rec);}};
    }catch(e){console.error('sync failed',e);}
  }
}
window.addEventListener('online',syncPendingMessages);

/* ==========  SEND  ========== */
function autoResizeInput(field){
  field.style.height='auto';field.style.height=field.scrollHeight+'px';
  const btn=document.getElementById('sendBtn');field.value.trim()?btn.classList.add('visible'):btn.classList.remove('visible');
}
async function sendMessage(){
  const input=document.getElementById('messageInput');const text=input.value.trim();if(!text||!currentFriendUid)return;
  const key=sharedKeys[currentFriendUid];if(!key){toast('Security key missing');return;}
  const encrypted=CryptoJS.AES.encrypt(text,key).toString();const tempTs=Date.now();const localId=tempTs+Math.random();
  const list=document.getElementById('messageList');const el=createMessageElement(text,true,tempTs,localId,'',false);list.appendChild(el);list.scrollTop=list.scrollHeight;
  input.value='';input.style.height='auto';document.getElementById('sendBtn').classList.remove('visible');
  await cacheMessage(currentRoomId,{text:encrypted,sender:currentUser.uid,ts:tempTs,pending:true,localId:localId,read:false});
  if(navigator.onLine){
    try{
      const msgRef=await db.ref(`messages/${currentRoomId}`).push({text:encrypted,sender:currentUser.uid,ts:tempTs,read:false,localId:localId});
      const updates={};updates[`users/${currentUser.uid}/chats/${currentFriendUid}/lastMsg`]=encrypted;updates[`users/${currentUser.uid}/chats/${currentFriendUid}/lastMsgSender`]=currentUser.uid;updates[`users/${currentUser.uid}/chats/${currentFriendUid}/ts`]=tempTs;
      updates[`users/${currentFriendUid}/chats/${currentUser.uid}/lastMsg`]=encrypted;updates[`users/${currentFriendUid}/chats/${currentUser.uid}/lastMsgSender`]=currentUser.uid;updates[`users/${currentFriendUid}/chats/${currentUser.uid}/ts`]=tempTs;
      updates[`users/${currentFriendUid}/chats/${currentUser.uid}/unreadCount`]=firebase.database.ServerValue.increment(1);
      await db.ref().update(updates);
    }catch(e){console.error(e);toast('Message will be sent when online');}
  }else{toast('Message will be sent when online');}
}
document.getElementById('sendBtn').addEventListener('click',sendMessage);
function handleEnter(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}}

/* ==========  REACTIONS  ========== */
function showReactionPicker(e,messageEl,msgKey){
  e.preventDefault();const picker=document.getElementById('reactionPicker');
  const rect=messageEl.getBoundingClientRect();picker.style.left=`${rect.left+window.scrollX}px`;picker.style.top=`${rect.bottom+window.scrollY+5}px`;picker.style.display='flex';
  picker.dataset.currentMsgKey=msgKey;picker.dataset.currentMsgEl=messageEl;
  setTimeout(()=>document.addEventListener('click',hideReactionPicker,{once:true}),100);
}
function hideReactionPicker(){document.getElementById('reactionPicker').style.display='none';}
document.querySelectorAll('.reaction-emoji').forEach(emoji=>{
  emoji.addEventListener('click',function(){
    const selectedEmoji=this.dataset.emoji;const msgKey=document.getElementById('reactionPicker').dataset.currentMsgKey;
    if(msgKey)toggleReaction(msgKey,selectedEmoji);hideReactionPicker();
  });
});
async function toggleReaction(msgKey,emoji){
  if(!msgKey||!currentRoomId)return;
  try{
    const ref=db.ref(`messages/${currentRoomId}/${msgKey}/reactions/${emoji}`);
    const snap=await ref.once('value');const users=snap.val()||[];
    if(users.includes(currentUser.uid)){
      const updated=users.filter(u=>u!==currentUser.uid);
      if(updated.length)await ref.set(updated);else await ref.remove();
    }else{await ref.set([...users,currentUser.uid]);}
  }catch(e){console.error(e);}
}

/* ==========  MESSAGE ACTIONS  ========== */
function hideMessageActions(){
  document.getElementById('messageActionsPopup').style.display='none';
  document.getElementById('messageActionOverlay').style.display='none';
  document.querySelectorAll('.message.swiping').forEach(m=>{m.style.transform='';m.classList.remove('swiping');});
}
function showMessageActions(e,messageEl,msgKey,msgText){
  e.preventDefault();document.querySelectorAll('.message.swiping').forEach(m=>{m.style.transform='';m.classList.remove('swiping');});
  const popup=document.getElementById('messageActionsPopup');const overlay=document.getElementById('messageActionOverlay');
  const rect=messageEl.getBoundingClientRect();popup.style.left=`${rect.right+10}px`;popup.style.top=`${rect.top+window.scrollY}px`;
  const popupRect=popup.getBoundingClientRect();if(popupRect.right>window.innerWidth)popup.style.left=`${rect.left-popup.offsetWidth-10}px`;
  overlay.style.display='block';popup.style.display='block';popup.dataset.currentMsgKey=msgKey;popup.dataset.currentMsgText=msgText;popup.dataset.currentMsgEl=messageEl;
  setTimeout(()=>hideMessageActions(),3000);
}
function addSwipeListeners(el){
  let startX=0,currentX=0,isSwiping=false,swipeThreshold=100;
  const start=e=>{startX=e.touches?e.touches[0].clientX:e.clientX;currentX=startX;isSwiping=true;};
  const move=e=>{if(!isSwiping)return;e.preventDefault();currentX=e.touches?e.touches[0].clientX:e.clientX;const dx=currentX-startX;if(dx<0){el.style.transform=`translateX(${Math.max(dx,-100)}px)`;el.classList.add('swiping');}};
  const end=e=>{
    if(!isSwiping)return;const dx=currentX-startX;
    if(Math.abs(dx)>swipeThreshold){showMessageActions(e,el,el.dataset.msgKey,el.textContent);}else{el.style.transform='';el.classList.remove('swiping');}
    isSwiping=false;el.style.transform='';el.classList.remove('swiping');
  };
  el.addEventListener('touchstart',start,{passive:false});el.addEventListener('touchmove',move,{passive:false});el.addEventListener('touchend',end,{passive:false});
  el.addEventListener('mousedown',start);el.addEventListener('mousemove',move);el.addEventListener('mouseup',end);el.addEventListener('mouseleave',end);
}
async function deleteMessage(){
  const popup=document.getElementById('messageActionsPopup');const msgKey=popup.dataset.currentMsgKey;const msgEl=popup.dataset.currentMsgEl;
  if(!msgKey||!msgEl)return;
  try{await db.ref(`messages/${currentRoomId}/${msgKey}`).remove();msgEl.remove();toast('Message deleted');}catch(e){console.error(e);toast('Failed to delete message');}
  hideMessageActions();
}
async function editMessage(){
  const popup=document.getElementById('messageActionsPopup');const msgKey=popup.dataset.currentMsgKey;const msgText=popup.dataset.currentMsgText;const msgEl=popup.dataset.currentMsgEl;
  if(!msgKey||!msgText||!msgEl)return;
  const messageContent=msgEl.querySelector('.message-content')||msgEl;const originalHtml=messageContent.innerHTML;
  const input=document.createElement('textarea');input.className='message-edit-input';input.value=msgText;input.style.cssText='width:100%;min-height:40px;padding:8px;border:1px solid var(--border-light);border-radius:8px;background:var(--bg-body);color:var(--text-main);font-size:14px;resize:vertical;';
  messageContent.innerHTML='';messageContent.appendChild(input);input.focus();
  const save=async()=>{
    const newText=input.value.trim();if(newText&&newText!==msgText){
      const key=sharedKeys[currentFriendUid];if(!key){toast('Security key missing');return;}
      const encrypted=CryptoJS.AES.encrypt(newText,key).toString();
      await db.ref(`messages/${currentRoomId}/${msgKey}/text`).set(encrypted);
      const lastMsgSnap=await db.ref(`messages/${currentRoomId}`).orderByChild('ts').limitToLast(1).once('value');let isLast=false;
      lastMsgSnap.forEach(ch=>{if(ch.key===msgKey)isLast=true;});
      if(isLast){const up={};up[`users/${currentUser.uid}/chats/${currentFriendUid}/lastMsg`]=encrypted;up[`users/${currentFriendUid}/chats/${currentUser.uid}/lastMsg`]=encrypted;await db.ref().update(up);}
      toast('Message edited');
    }messageContent.innerHTML=originalHtml;hideMessageActions();
  };
  input.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();save();}else if(e.key==='Escape'){messageContent.innerHTML=originalHtml;hideMessageActions();}});
  input.addEventListener('blur',()=>setTimeout(save,100));hideMessageActions();
}
function forwardMessage(){
  const popup=document.getElementById('messageActionsPopup');const msgText=popup.dataset.currentMsgText;
  if(!msgText)return;openForwardSelector(msgText);hideMessageActions();
}
function openForwardSelector(msgText){
  const overlay=document.createElement('div');overlay.className='forward-overlay';overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:4000;display:flex;align-items:center;justify-content:center;';
  const selector=document.createElement('div');selector.className='forward-selector';selector.style.cssText='background:var(--bg-card);border-radius:16px;padding:20px;max-width:400px;max-height:70vh;overflow-y:auto;width:90%;';
  selector.innerHTML=`<h3 style="margin-bottom:15px;font-weight:700;">Forward Message</h3><div style="margin-bottom:15px;padding:10px;background:var(--bg-body);border-radius:8px;font-size:14px;">${msgText}</div><div id="forwardFriendsList"></div><div style="display:flex;gap:10px;margin-top:15px;"><button class="btn-secondary" onclick="closeForwardSelector()" style="flex:1;padding:10px;border:none;border-radius:8px;background:var(--bg-body);">Cancel</button><button class="btn-primary" onclick="sendForwardedMessage()" style="flex:1;padding:10px;border:none;border-radius:8px;">Send</button></div>`;
  overlay.appendChild(selector);document.body.appendChild(overlay);loadFriendsForForwarding();selector.dataset.messageText=msgText;
}
function closeForwardSelector(){const o=document.querySelector('.forward-overlay');if(o)o.remove();}
async function loadFriendsForForwarding(){
  const list=document.getElementById('forwardFriendsList');list.innerHTML='<div style="text-align:center;padding:20px;">Loading friends...</div>';
  try{
    const snap=await db.ref(`users/${currentUser.uid}/chats`).once('value');
    if(!snap.exists()){list.innerHTML='<p style="text-align:center;color:var(--text-muted);">No friends to forward to</p>';return;}
    list.innerHTML='';const friends=[];snap.forEach(child=>friends.push(child.key));
    for(const uid of friends){
      if(uid===currentFriendUid)continue;
      const profSnap=await db.ref(`users/${uid}/profile`).once('value');const prof=profSnap.val()||{name:'User',photo:''};
      const el=document.createElement('div');el.className='forward-friend-item';el.style.cssText='display:flex;align-items:center;padding:12px;cursor:pointer;border-radius:8px;margin-bottom:8px;transition:background 0.2s;';
      el.innerHTML=`<img class="avatar" src="${prof.photo||generateLetterAvatar(prof.name)}" style="width:40px;height:40px;margin-right:12px;"><div class="chat-name">${prof.name}</div>`;
      el.addEventListener('click',()=>{document.querySelectorAll('.forward-friend-item.selected').forEach(x=>x.classList.remove('selected'));el.classList.add('selected');el.dataset.friendUid=uid;});
      list.appendChild(el);
    }
    if(list.children.length===0)list.innerHTML='<p style="text-align:center;color:var(--text-muted);">No other friends to forward to</p>';
  }catch(e){console.error(e);list.innerHTML='<p style="text-align:center;color:var(--text-muted);">Error loading friends</p>';}
}
async function sendForwardedMessage(){
  const selector=document.querySelector('.forward-selector');const selected=selector.querySelector('.forward-friend-item.selected');
  if(!selected){toast('Please select a friend to forward to');return;}
  const msgText=selector.dataset.messageText;const targetUid=selected.dataset.friendUid;
  if(!targetUid){toast('Please select a friend');return;}
  try{
    const forwardedText=`Forwarded: ${msgText}`;
    const profSnap=await db.ref(`users/${targetUid}/profile`).once('value');const prof=profSnap.val()||{};
    if(!sharedKeys[targetUid]&&prof.publicKey){const secret=await deriveSharedSecret(JSON.parse(prof.publicKey));sharedKeys[targetUid]=secret;localStorage.setItem('sharedKeys',JSON.stringify(sharedKeys));}
    const key=sharedKeys[targetUid];if(!key){toast('Security key missing for forwarding');return;}
    const encrypted=CryptoJS.AES.encrypt(forwardedText,key).toString();const timestamp=Date.now();
    const targetRoomId=currentUser.uid<targetUid?`${currentUser.uid}_${targetUid}`:`${targetUid}_${currentUser.uid}`;
    await db.ref(`messages/${targetRoomId}`).push({text:encrypted,sender:currentUser.uid,ts:timestamp,read:false});
    const updates={};updates[`users/${currentUser.uid}/chats/${targetUid}/lastMsg`]=encrypted;updates[`users/${currentUser.uid}/chats/${targetUid}/ts`]=timestamp;
    updates[`users/${targetUid}/chats/${currentUser.uid}/lastMsg`]=encrypted;updates[`users/${targetUid}/chats/${currentUser.uid}/ts`]=timestamp;
    updates[`users/${targetUid}/chats/${currentUser.uid}/unreadCount`]=firebase.database.ServerValue.increment(1);
    await db.ref().update(updates);toast('Message forwarded');closeForwardSelector();
  }catch(e){console.error(e);toast('Failed to forward message');}
}

/* ==========  SEARCH  ========== */
function searchFriends(){
  const term=document.getElementById('friendSearch').value.toLowerCase();
  document.querySelectorAll('.chat-card').forEach(c=>{
    const name=c.querySelector('.chat-name')?.textContent.toLowerCase()||'';
    c.style.display=name.includes(term)?'flex':'none';
  });
}

/* ==========  TIME  ========== */
function formatTimeAgo(ts){if(!ts)return'';const diff=Date.now()-ts;if(diff<86400000)return new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});return new Date(ts).toLocaleDateString();}
function formatMessageTime(ts){return new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}

/* ==========  MISC  ========== */
async function markAsRead(friendUid){await db.ref(`users/${currentUser.uid}/chats/${friendUid}`).update({unreadCount:0});updateUnreadDot();}
async function addFriendLogic(){
  const raw=document.getElementById('friendVynixId').value.trim().toLowerCase();
  const vid=raw.startsWith('@')?raw.substring(1):raw;if(!vid)return;
  const snap=await db.ref(`vynix_ids/${vid}`).once('value');if(!snap.exists()){toast('User ID not found');return;}
  const targetUid=snap.val();if(targetUid===currentUser.uid){toast("That's you!");return;}
  const existing=await db.ref(`users/${currentUser.uid}/chats/${targetUid}`).once('value');if(existing.exists()){toast('Already added!');closeAll();openFullChat(targetUid);return;}
  await db.ref(`users/${currentUser.uid}/chats/${targetUid}`).set({lastMsg:null,ts:Date.now(),unreadCount:0,isFavourite:false,isArchived:false});
  toast('Friend added! Tap their name to start chatting.');closeAll();document.getElementById('friendVynixId').value='';
}

/* ==========  POP-STATE  ========== */
window.addEventListener('popstate',e=>{
  if(document.getElementById('fullChatView').style.display==='flex'){closeFullChat();e.preventDefault();}
});
</script>
</body>
</html>
