<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Nexus â€“ Messages</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <style>
    :root {
      --primary: #6366f1;
      --primary-soft: #e0e7ff;
      --bg: #f3f4f6;
      --surface: #ffffff;
      --text: #0f172a;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --online: #10b981;
      --encrypted: #10b981;
      --error: #ef4444;
      --shimmer-base: #e2e8f0;
      --shimmer-highlight: #f1f5f9;
      --chat-sent: #6366f1;
      --chat-received: #ffffff;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f172a;
        --surface: #1e293b;
        --text: #f1f5f9;
        --text-secondary: #94a3b8;
        --border: #334155;
        --chat-received: #1e293b;
      }
    }

    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      min-height: 100vh;
      -webkit-text-size-adjust: 100%;
      overscroll-behavior: none;
    }

    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }

    .shimmer {
      background: linear-gradient(90deg, var(--shimmer-base) 25%, var(--shimmer-highlight) 50%, var(--shimmer-base) 75%);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite linear;
      border-radius: 4px;
    }

    .shimmer-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .shimmer-text {
      height: 16px;
      width: 120px;
      margin-bottom: 8px;
    }

    .shimmer-text-short {
      width: 80px;
      height: 12px;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr;
      max-width: 720px;
      margin: 0 auto;
      padding-bottom: 80px;
    }

    @media (min-width: 768px) {
      .layout {
        grid-template-columns: 280px 1fr;
        max-width: 1100px;
        padding-bottom: 0;
      }
    }

    .sidebar {
      display: none;
      position: sticky;
      top: 0;
      height: 100vh;
      padding: 1.5rem 1rem;
      border-right: 1px solid var(--border);
      background: var(--surface);
    }

    @media (min-width: 768px) {
      .sidebar { display: flex; flex-direction: column; }
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.85rem 1.25rem;
      border-radius: 9999px;
      font-size: 1.125rem;
      font-weight: 500;
      color: var(--text);
      transition: all 0.2s;
      width: fit-content;
      cursor: pointer;
    }

    .nav-item:hover { background: rgba(99, 102, 241, 0.08); color: var(--primary); }
    .nav-item.active { background: rgba(99, 102, 241, 0.12); color: var(--primary); font-weight: 600; }

    .main-content {
      background: var(--surface);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      position: sticky;
      top: 0;
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 1rem;
      z-index: 10;
    }

    @media (prefers-color-scheme: dark) {
      .chat-header { background: rgba(30, 41, 59, 0.92); }
    }

    .header-title {
      font-size: 1.5rem;
      font-weight: 800;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .encryption-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: var(--primary-soft);
      color: var(--encrypted);
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 9999px;
    }

    .tab-container {
      display: flex;
      gap: 0.5rem;
      background: var(--bg);
      padding: 4px;
      border-radius: 12px;
    }

    .tab {
      flex: 1;
      padding: 0.6rem 1rem;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      color: var(--text-secondary);
      border: none;
      background: transparent;
    }

    .tab.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    @media (prefers-color-scheme: dark) {
      .tab.active { background: var(--surface); }
    }

    .search-box {
      margin-top: 1rem;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 1rem;
      outline: none;
      transition: all 0.2s;
      background: var(--bg);
      color: var(--text);
    }

    .search-input:focus {
      border-color: var(--primary);
      background: white;
    }

    @media (prefers-color-scheme: dark) {
      .search-input:focus { background: var(--surface); }
    }

    .search-icon {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
    }

    .friend-card {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
      text-decoration: none;
      color: inherit;
      position: relative;
    }

    .friend-card:hover {
      background: var(--bg);
    }

    .friend-card:active {
      background: rgba(99, 102, 241, 0.1);
    }

    .friend-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid var(--border);
      position: relative;
      flex-shrink: 0;
    }

    .avatar-container {
      position: relative;
      flex-shrink: 0;
    }

    .online-indicator {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 12px;
      height: 12px;
      background: var(--online);
      border: 2px solid var(--surface);
      border-radius: 50%;
      display: none;
    }

    .online-indicator.show {
      display: block;
    }

    .encrypted-indicator {
      position: absolute;
      bottom: -2px;
      left: -2px;
      background: var(--encrypted);
      border: 2px solid var(--surface);
      border-radius: 50%;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      display: none;
    }

    .encrypted-indicator.show {
      display: flex;
    }

    .friend-info {
      flex: 1;
      min-width: 0;
    }

    .friend-name-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.25rem;
    }

    .friend-name {
      font-weight: 700;
      color: var(--text);
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .friend-meta {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .start-chat-hint {
      font-size: 0.8rem;
      color: var(--primary);
      font-weight: 500;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }

    .empty-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      opacity: 0.3;
      color: var(--text-secondary);
    }

    .error-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }

    .error-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      color: var(--error);
      opacity: 0.5;
    }

    .retry-btn {
      margin-top: 1rem;
      padding: 0.5rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 9999px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .retry-btn:hover {
      opacity: 0.9;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      z-index: 50;
      padding-bottom: env(safe-area-inset-bottom);
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 56px;
    }

    @media (min-width: 768px) {
      .bottom-nav { display: none; }
    }

    .nav-bottom-item {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 56px;
      color: var(--text-secondary);
      position: relative;
      transition: color 0.2s;
    }

    .nav-bottom-item.active {
      color: var(--primary);
    }

    .nav-bottom-item.active::after {
      content: '';
      position: absolute;
      bottom: 6px;
      width: 24px;
      height: 3px;
      background: var(--primary);
      border-radius: 9999px;
    }

    #toast {
      visibility: hidden;
      min-width: 250px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 50px;
      padding: 16px;
      position: fixed;
      z-index: 2000;
      left: 50%;
      bottom: 100px;
      transform: translateX(-50%);
      font-size: 14px;
      pointer-events: none;
    }

    #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    #toast.success { background-color: #10b981; }
    #toast.error { background-color: #ef4444; }

    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 100px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 100px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    .hidden { display: none !important; }

    /* Full Chat View (Vynix Style merged with Nexus colors) */
    #fullChatView {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100dvh;
      background: var(--bg);
      display: none;
      flex-direction: column;
      z-index: 2000;
    }

    #fullChatView.active {
      display: flex;
    }

    .chat-view-header {
      flex-shrink: 0;
      height: 65px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 1rem;
      z-index: 20;
    }

    @media (prefers-color-scheme: dark) {
      .chat-view-header { background: rgba(30, 41, 59, 0.95); }
    }

    .back-btn {
      padding: 0.5rem;
      margin-right: 0.75rem;
      cursor: pointer;
      color: var(--text);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .back-btn:hover {
      background: var(--bg);
    }

    .chat-friend-info {
      display: flex;
      align-items: center;
      flex: 1;
      overflow: hidden;
    }

    .chat-friend-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 0.75rem;
      object-fit: cover;
    }

    .chat-friend-name {
      font-weight: 700;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text);
    }

    .chat-status {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    #messageList {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .message {
      max-width: 75%;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
      line-height: 1.4;
      position: relative;
      word-wrap: break-word;
      border-radius: 1.125rem;
      animation: messageSlide 0.3s ease;
    }

    @keyframes messageSlide {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.received {
      align-self: flex-start;
      background: var(--chat-received);
      color: var(--text);
      border-bottom-left-radius: 0.25rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .message.sent {
      align-self: flex-end;
      background: var(--chat-sent);
      color: white;
      border-bottom-right-radius: 0.25rem;
    }

    .message-time {
      font-size: 0.7rem;
      margin-top: 0.25rem;
      text-align: right;
      opacity: 0.7;
    }

    .chat-input-area {
      flex-shrink: 0;
      background: var(--surface);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: flex-end;
      gap: 0.5rem;
      border-top: 1px solid var(--border);
      z-index: 20;
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
    }

    .input-wrapper {
      flex: 1;
      background: var(--bg);
      border-radius: 1.5rem;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      border: 1px solid var(--border);
    }

    .input-wrapper:focus-within {
      border-color: var(--primary);
    }

    #messageInput {
      flex: 1;
      background: transparent;
      border: none;
      font-size: 0.95rem;
      max-height: 120px;
      resize: none;
      color: var(--text);
      padding: 0;
      line-height: 1.3;
      font-family: inherit;
    }

    #messageInput:focus { outline: none; }

    #sendBtn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      border: none;
      opacity: 0.5;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    #sendBtn.active {
      opacity: 1;
      pointer-events: auto;
    }

    #sendBtn:hover {
      transform: scale(1.05);
    }

    .typing-indicator {
      display: flex;
      gap: 0.25rem;
      padding: 1rem;
      align-self: flex-start;
      opacity: 0.6;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--text-secondary);
      border-radius: 50%;
      animation: typingBounce 1.4s infinite ease-in-out both;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typingBounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
  </style>
</head>
<body>

  <div id="toast"></div>

  <div class="layout">
    <!-- Sidebar (Desktop) -->
    <aside class="sidebar">
      <div>
        <div class="logo-box" style="padding: 0.75rem 0 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
          <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 20px;">N</div>
          <div style="font-weight: 800; font-size: 1.25rem;">Nexus</div>
        </div>

        <div class="nav-item" onclick="window.location.href='index.html'">
          <i data-feather="home"></i>
          <span class="nav-text">Home</span>
        </div>
        <div class="nav-item" onclick="window.location.href='explore.html'">
          <i data-feather="hash"></i>
          <span class="nav-text">Explore</span>
        </div>
        <div class="nav-item" onclick="window.location.href='notifications.html'">
          <i data-feather="bell"></i>
          <span class="nav-text">Notifications</span>
        </div>
        <div class="nav-item active">
          <i data-feather="message-circle"></i>
          <span class="nav-text">Messages</span>
        </div>
        <div class="nav-item" onclick="window.location.href='profile.html'">
          <i data-feather="user"></i>
          <span class="nav-text">Profile</span>
        </div>
      </div>

      <div class="nav-item" onclick="handleLogout()" style="margin-top: auto; color: var(--error);">
        <i data-feather="log-out"></i>
        <span class="nav-text">Sign out</span>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="chat-header">
        <h1 class="header-title">
          Messages
          <span class="encryption-badge" id="global-encrypt-badge" style="display:none;">
            <i data-feather="lock" style="width:12px;height:12px;"></i> E2EE
          </span>
        </h1>
        
        <div class="tab-container">
          <button class="tab active" onclick="switchTab('following')" id="tab-following">
            Following
          </button>
          <button class="tab" onclick="switchTab('followers')" id="tab-followers">
            Followers
          </button>
        </div>

        <div class="search-box">
          <i data-feather="search" class="search-icon" style="width:18px;height:18px;"></i>
          <input type="text" class="search-input" placeholder="Search friends..." id="search-input" oninput="searchFriends()">
        </div>
      </div>

      <div class="chat-list" id="friend-list">
        <!-- Loading skeletons -->
        <div class="friend-card" style="pointer-events:none;">
          <div class="shimmer shimmer-avatar"></div>
          <div class="friend-info" style="flex:1;">
            <div class="shimmer shimmer-text" style="width:40%;"></div>
            <div class="shimmer shimmer-text-short"></div>
          </div>
        </div>
        <div class="friend-card" style="pointer-events:none;">
          <div class="shimmer shimmer-avatar"></div>
          <div class="friend-info" style="flex:1;">
            <div class="shimmer shimmer-text" style="width:60%;"></div>
            <div class="shimmer shimmer-text-short"></div>
          </div>
        </div>
        <div class="friend-card" style="pointer-events:none;">
          <div class="shimmer shimmer-avatar"></div>
          <div class="friend-info" style="flex:1;">
            <div class="shimmer shimmer-text" style="width:35%;"></div>
            <div class="shimmer shimmer-text-short"></div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-state hidden" id="empty-state">
        <i data-feather="users" class="empty-icon"></i>
        <h3 style="margin-bottom:0.5rem;color:var(--text); font-weight: 600;">No users found</h3>
        <p>Follow people to start chatting with them!</p>
      </div>

      <!-- Error State -->
      <div class="error-state hidden" id="error-state">
        <i data-feather="alert-circle" class="error-icon"></i>
        <h3 style="margin-bottom:0.5rem;color:var(--text); font-weight: 600;">Unable to load</h3>
        <p id="error-message">Check your connection and try again.</p>
        <button class="retry-btn" onclick="retryLoad()">
          <i data-feather="refresh-cw" style="width:16px;height:16px;"></i>
          Retry
        </button>
      </div>
    </main>
  </div>

  <!-- Mobile Bottom Nav -->
  <nav class="bottom-nav">
    <a href="index.html" class="nav-bottom-item">
      <i data-feather="home" style="width:24px;height:24px;"></i>
    </a>
    <a href="explore.html" class="nav-bottom-item">
      <i data-feather="hash" style="width:24px;height:24px;"></i>
    </a>
    <a href="messages.html" class="nav-bottom-item active">
      <i data-feather="message-circle" style="width:24px;height:24px;"></i>
    </a>
    <a href="profile.html" class="nav-bottom-item">
      <i data-feather="user" style="width:24px;height:24px;"></i>
    </a>
  </nav>

  <!-- Full Chat View (Hidden by default) -->
  <div id="fullChatView">
    <div class="chat-view-header">
      <div class="back-btn" onclick="closeFullChat()">
        <i data-feather="arrow-left" style="width:24px;height:24px;"></i>
      </div>
      <div class="chat-friend-info">
        <img id="chatFriendAvatar" src="" class="chat-friend-avatar">
        <div>
          <div id="chatFriendName" class="chat-friend-name"></div>
          <div id="chatStatus" class="chat-status">Tap to view info</div>
        </div>
      </div>
    </div>

    <div id="messageList"></div>

    <div class="chat-input-area">
      <div class="input-wrapper">
        <textarea id="messageInput" rows="1" placeholder="Type a message..." oninput="autoResize(this)" onkeypress="handleEnter(event)"></textarea>
      </div>
      <button id="sendBtn" onclick="sendMessage()">
        <i data-feather="arrow-up" style="width:20px;height:20px;"></i>
      </button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    let currentTab = 'following';
    let usersList = [];
    let unsubscribeListeners = [];
    let loadTimeout = null;
    let sharedKeys = JSON.parse(localStorage.getItem('sharedKeys') || '{}');
    
    // Chat view state
    let currentFriendUid = null;
    let currentRoomId = null;
    let messagesListener = null;

    // ==================== CRYPTO MODULE (Vynix Style) ====================
    
    async function generateKeyPair() {
      const keyPair = await crypto.subtle.generateKey(
        { name: "ECDH", namedCurve: "P-256" },
        true,
        ["deriveBits"]
      );
      const pub = await crypto.subtle.exportKey("jwk", keyPair.publicKey);
      const priv = await crypto.subtle.exportKey("jwk", keyPair.privateKey);
      localStorage.setItem('privateKey', JSON.stringify(priv));
      return pub;
    }

    async function deriveSharedSecret(friendPublicJwk) {
      try {
        const privateKeyJwk = JSON.parse(localStorage.getItem('privateKey'));
        if (!privateKeyJwk) throw new Error('No private key');
        
        const privateKey = await crypto.subtle.importKey(
          "jwk", 
          privateKeyJwk, 
          { name: "ECDH", namedCurve: "P-256" }, 
          false, 
          ["deriveBits"]
        );
        
        const friendPublicKey = await crypto.subtle.importKey(
          "jwk", 
          friendPublicJwk, 
          { name: "ECDH", namedCurve: "P-256" }, 
          false, 
          []
        );
        
        const sharedSecret = await crypto.subtle.deriveBits(
          { name: "ECDH", public: friendPublicKey },
          privateKey,
          256
        );
        
        return Array.from(new Uint8Array(sharedSecret))
          .map(b => b.toString(16).padStart(2, '0'))
          .join('');
      } catch (err) {
        console.error('Key derivation failed:', err);
        return null;
      }
    }

    function encrypt(text, key) {
      if (!key) return null;
      return CryptoJS.AES.encrypt(text, key).toString();
    }

    function decrypt(ciphertext, key) {
      if (!ciphertext || !key) return "[Encrypted]";
      try {
        const bytes = CryptoJS.AES.decrypt(ciphertext, key);
        return bytes.toString(CryptoJS.enc.Utf8) || "[Encrypted]";
      } catch (e) {
        return "[Encrypted]";
      }
    }

    // ==================== UI FUNCTIONS ====================

    function showToast(msg, type = 'success') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = `show ${type}`;
      setTimeout(() => t.className = '', 2800);
    }

    function showLoadingSkeleton() {
      const list = document.getElementById('friend-list');
      const emptyState = document.getElementById('empty-state');
      const errorState = document.getElementById('error-state');
      
      emptyState.classList.add('hidden');
      errorState.classList.add('hidden');
      
      list.innerHTML = `
        <div class="friend-card" style="pointer-events:none;">
          <div class="shimmer shimmer-avatar"></div>
          <div class="friend-info" style="flex:1;">
            <div class="shimmer shimmer-text" style="width:40%;"></div>
            <div class="shimmer shimmer-text-short"></div>
          </div>
        </div>
        <div class="friend-card" style="pointer-events:none;">
          <div class="shimmer shimmer-avatar"></div>
          <div class="friend-info" style="flex:1;">
            <div class="shimmer shimmer-text" style="width:60%;"></div>
            <div class="shimmer shimmer-text-short"></div>
          </div>
        </div>
        <div class="friend-card" style="pointer-events:none;">
          <div class="shimmer shimmer-avatar"></div>
          <div class="friend-info" style="flex:1;">
            <div class="shimmer shimmer-text" style="width:35%;"></div>
            <div class="shimmer shimmer-text-short"></div>
          </div>
        </div>
      `;
    }

    function showError(message) {
      const list = document.getElementById('friend-list');
      const emptyState = document.getElementById('empty-state');
      const errorState = document.getElementById('error-state');
      const errorMessage = document.getElementById('error-message');
      
      list.innerHTML = '';
      emptyState.classList.add('hidden');
      errorState.classList.remove('hidden');
      errorMessage.textContent = message;
    }

    function cleanupListeners() {
      unsubscribeListeners.forEach(unsub => unsub && unsub());
      unsubscribeListeners = [];
      if (loadTimeout) {
        clearTimeout(loadTimeout);
        loadTimeout = null;
      }
      if (messagesListener) {
        messagesListener.off();
        messagesListener = null;
      }
    }

    // ==================== LOAD USERS ====================

    async function loadUsers(listType) {
      cleanupListeners();
      showLoadingSkeleton();
      
      // Safety timeout - if Firebase doesn't respond in 8 seconds, show error
      loadTimeout = setTimeout(() => {
        showError('Connection timed out. Please check your internet and try again.');
      }, 8000);

      if (!currentUser) {
        clearTimeout(loadTimeout);
        showError('Not authenticated');
        return;
      }

      const listRef = db.ref(`${listType}/${currentUser.uid}`);
      
      try {
        const unsubscribe = listRef.on('value', async (snapshot) => {
          clearTimeout(loadTimeout);
          const listContainer = document.getElementById('friend-list');
          const emptyState = document.getElementById('empty-state');
          const errorState = document.getElementById('error-state');
          
          errorState.classList.add('hidden');
          listContainer.innerHTML = '';
          usersList = [];

          if (!snapshot.exists()) {
            emptyState.classList.remove('hidden');
            feather.replace();
            return;
          }

          const userIds = Object.keys(snapshot.val());
          
          if (userIds.length === 0) {
            emptyState.classList.remove('hidden');
            feather.replace();
            return;
          }

          // Fetch user details
          const userPromises = userIds.map(async (userId) => {
            try {
              const userSnap = await db.ref(`users/${userId}/profile`).once('value');
              if (userSnap.exists()) {
                return { uid: userId, ...userSnap.val() };
              }
              return null;
            } catch (err) {
              console.warn(`Failed to load user ${userId}:`, err);
              return null;
            }
          });

          const users = (await Promise.all(userPromises)).filter(u => u !== null);
          usersList = users;

          // Render friend cards
          users.forEach(user => {
            const card = document.createElement('div');
            card.className = 'friend-card';
            card.onclick = () => openFullChat(user.uid);
            
            const avatarUrl = user.photo || generateLetterAvatar(user.name || user.displayName || 'User');
            const hasEncryption = !!user.publicKey;
            
            card.innerHTML = `
              <div class="avatar-container">
                <img src="${avatarUrl}" class="friend-avatar" onerror="this.src='${generateLetterAvatar(user.name || 'User')}'">
                <div class="online-indicator" id="online_${user.uid}"></div>
                ${hasEncryption ? `<div class="encrypted-indicator show"><i data-feather="lock" style="width:10px;height:10px;"></i></div>` : ''}
              </div>
              <div class="friend-info">
                <div class="friend-name-row">
                  <div class="friend-name">
                    ${user.name || user.displayName || 'User'}
                    ${hasEncryption ? '<i data-feather="lock" style="width:12px;height:12px;color:var(--encrypted);"></i>' : ''}
                  </div>
                </div>
                <div class="friend-meta">
                  <span class="start-chat-hint">Tap to chat</span>
                </div>
              </div>
            `;
            
            listContainer.appendChild(card);
            
            // Listen to online status
            const onlineRef = db.ref(`users/${user.uid}/online`);
            const unsub = onlineRef.on('value', (s) => {
              const indicator = document.getElementById(`online_${user.uid}`);
              if (indicator) {
                if (s.val() === true) {
                  indicator.classList.add('show');
                } else {
                  indicator.classList.remove('show');
                }
              }
            });
            unsubscribeListeners.push(unsub);
          });

          feather.replace();
        }, (error) => {
          clearTimeout(loadTimeout);
          console.error('Firebase error:', error);
          
          if (error.code === 'PERMISSION_DENIED') {
            showError('Permission denied. Please check your Firebase rules.');
          } else {
            showError(`Error: ${error.message}`);
          }
        });

        unsubscribeListeners.push(() => listRef.off('value', unsubscribe));
      } catch (err) {
        clearTimeout(loadTimeout);
        showError(`Error: ${err.message}`);
      }
    }

    function generateLetterAvatar(name) {
      if (!name) name = 'U';
      const initials = name.trim().split(/\s+/).map(w => w[0]).slice(0,2).join('').toUpperCase();
      const colors = ['#6366f1','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899'];
      const hash = name.split('').reduce((a,b) => a + b.charCodeAt(0), 0);
      const bg = colors[hash % colors.length];
      
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = 100;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = bg;
      ctx.fillRect(0,0,100,100);
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 40px system-ui, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(initials, 50, 50);
      return canvas.toDataURL();
    }

    // ==================== CHAT VIEW ====================

    async function openFullChat(friendUid) {
      currentFriendUid = friendUid;
      currentRoomId = currentUser.uid < friendUid ? 
        currentUser.uid + "_" + friendUid : 
        friendUid + "_" + currentUser.uid;
      
      // Get friend profile
      const snap = await db.ref(`users/${friendUid}/profile`).once('value');
      const profile = snap.val() || { name: "User", photo: "" };
      
      document.getElementById('chatFriendName').textContent = profile.name || profile.displayName || 'User';
      document.getElementById('chatFriendAvatar').src = profile.photo || generateLetterAvatar(profile.name);
      
      // Init encryption if needed
      if (!sharedKeys[friendUid] && profile.publicKey) {
        const secret = await deriveSharedSecret(JSON.parse(profile.publicKey));
        if (secret) {
          sharedKeys[friendUid] = secret;
          localStorage.setItem('sharedKeys', JSON.stringify(sharedKeys));
        }
      }
      
      // Show encryption badge
      if (sharedKeys[friendUid]) {
        document.getElementById('global-encrypt-badge').style.display = 'inline-flex';
      }
      
      // Show chat view
      document.getElementById('fullChatView').classList.add('active');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
      
      // Load messages
      loadMessages();
      
      // Listen to online status
      db.ref(`users/${friendUid}/online`).on('value', (s) => {
        const statusEl = document.getElementById('chatStatus');
        if (s.val() === true) {
          statusEl.textContent = 'Online';
          statusEl.style.color = 'var(--online)';
        } else {
          statusEl.textContent = 'Offline';
          statusEl.style.color = 'var(--text-secondary)';
        }
      });
      
      // Update read status
      markAsRead(friendUid);
    }

    function closeFullChat() {
      document.getElementById('fullChatView').classList.remove('active');
      document.body.style.overflow = '';
      
      if (messagesListener) {
        messagesListener.off();
        messagesListener = null;
      }
      
      currentFriendUid = null;
      document.getElementById('messageList').innerHTML = '';
      document.getElementById('global-encrypt-badge').style.display = 'none';
    }

    function loadMessages() {
      const list = document.getElementById('messageList');
      list.innerHTML = '';
      
      messagesListener = db.ref(`messages/${currentRoomId}`).limitToLast(50);
      
      messagesListener.on('child_added', (snap) => {
        const msg = snap.val();
        if (!msg) return;
        
        const isSent = msg.sender === currentUser.uid;
        const key = sharedKeys[currentFriendUid];
        const text = key ? decrypt(msg.text, key) : (isSent ? '[Encrypted]' : 'ðŸ”’ Encrypted');
        
        const el = document.createElement('div');
        el.className = `message ${isSent ? 'sent' : 'received'}`;
        el.innerHTML = `
          <div>${escapeHtml(text)}</div>
          <div class="message-time">${formatTime(msg.ts)}</div>
        `;
        
        list.appendChild(el);
        list.scrollTop = list.scrollHeight;
      });
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text || !currentFriendUid) return;
      
      const key = sharedKeys[currentFriendUid];
      if (!key) {
        showToast('Encryption key not available', 'error');
        return;
      }
      
      const encrypted = encrypt(text, key);
      if (!encrypted) {
        showToast('Encryption failed', 'error');
        return;
      }
      
      const timestamp = Date.now();
      
      // Add to UI immediately (optimistic)
      const list = document.getElementById('messageList');
      const el = document.createElement('div');
      el.className = 'message sent';
      el.innerHTML = `
        <div>${escapeHtml(text)}</div>
        <div class="message-time">${formatTime(timestamp)}</div>
      `;
      list.appendChild(el);
      list.scrollTop = list.scrollHeight;
      
      input.value = '';
      input.style.height = 'auto';
      document.getElementById('sendBtn').classList.remove('active');
      
      try {
        // Send to Firebase
        await db.ref(`messages/${currentRoomId}`).push({
          text: encrypted,
          sender: currentUser.uid,
          ts: timestamp,
          read: false
        });
        
        // Update chat metadata for both users
        const updates = {};
        updates[`users/${currentUser.uid}/chats/${currentFriendUid}/lastMsg`] = encrypted;
        updates[`users/${currentUser.uid}/chats/${currentFriendUid}/lastMsgSender`] = currentUser.uid;
        updates[`users/${currentUser.uid}/chats/${currentFriendUid}/ts`] = timestamp;
        updates[`users/${currentFriendUid}/chats/${currentUser.uid}/lastMsg`] = encrypted;
        updates[`users/${currentFriendUid}/chats/${currentUser.uid}/lastMsgSender`] = currentUser.uid;
        updates[`users/${currentFriendUid}/chats/${currentUser.uid}/ts`] = timestamp;
        updates[`users/${currentFriendUid}/chats/${currentUser.uid}/unreadCount`] = firebase.database.ServerValue.increment(1);
        
        await db.ref().update(updates);
      } catch (err) {
        console.error('Send failed:', err);
        showToast('Failed to send', 'error');
      }
    }

    function markAsRead(friendUid) {
      db.ref(`users/${currentUser.uid}/chats/${friendUid}`).update({ unreadCount: 0 });
    }

    // ==================== INPUT HANDLING ====================

    function autoResize(field) {
      field.style.height = 'auto';
      field.style.height = field.scrollHeight + 'px';
      
      const btn = document.getElementById('sendBtn');
      if (field.value.trim().length > 0) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    }

    function handleEnter(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // ==================== NAVIGATION ====================

    function switchTab(tab) {
      currentTab = tab;
      document.getElementById('tab-following').classList.remove('active');
      document.getElementById('tab-followers').classList.remove('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
      loadUsers(tab);
    }

    function searchFriends() {
      const query = document.getElementById('search-input').value.toLowerCase();
      const cards = document.querySelectorAll('.friend-card');
      
      cards.forEach(card => {
        const name = card.querySelector('.friend-name')?.textContent.toLowerCase() || '';
        if (name.includes(query)) {
          card.style.display = 'flex';
        } else {
          card.style.display = 'none';
        }
      });
    }

    function retryLoad() {
      loadUsers(currentTab);
    }

    function handleLogout() {
      auth.signOut().then(() => {
        showToast("Signed out");
        setTimeout(() => window.location.href = "login.html", 1000);
      });
    }

    // ==================== INIT ====================

    async function initEncryption() {
      if (!localStorage.getItem('privateKey')) {
        try {
          const publicJwk = await generateKeyPair();
          await db.ref(`users/${currentUser.uid}/profile`).update({ 
            publicKey: JSON.stringify(publicJwk) 
          });
          console.log('Encryption keys generated');
        } catch (err) {
          console.error('Key generation failed:', err);
        }
      }
    }

    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      
      currentUser = user;
      initEncryption();
      loadUsers('following');
    });

    // Handle back button on mobile
    window.addEventListener('popstate', (e) => {
      if (document.getElementById('fullChatView').classList.contains('active')) {
        closeFullChat();
        e.preventDefault();
      }
    });

    feather.replace();
  </script>
</body>
</html>
