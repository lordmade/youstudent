<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chaxo - Group</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f9f9f9; }
    .chat-bubble { max-width: 70%; padding: 10px 14px; border-radius: 16px; margin: 5px 0; }
    .me { background-color: #ef4444; color: white; align-self: flex-end; border-bottom-right-radius: 0; }
    .other { background-color: #e5e7eb; color: #111; align-self: flex-start; border-bottom-left-radius: 0; }
  </style>
</head>
<body class="flex flex-col min-h-screen">

<!-- Header -->
<header class="p-4 bg-white shadow flex items-center justify-between">
  <div class="flex items-center gap-3">
    <img id="group-avatar" src="https://www.gravatar.com/avatar?d=mp" class="w-10 h-10 rounded-full" alt="Group Avatar" />
    <h1 id="group-name" class="text-lg font-bold text-red-500">Group</h1>
  </div>
  <div class="flex gap-2">
    <button id="chat-scroll-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm">Chat</button>
    <button id="add-member-btn" class="hidden bg-red-500 text-white px-3 py-1 rounded text-sm">Add Members</button>
  </div>
</header>

<!-- Members List -->
<div id="members-list" class="px-4 py-2 grid grid-cols-1 gap-3 sm:grid-cols-2 md:grid-cols-3"></div>

<!-- Chat Messages -->
<div id="chat-box" class="flex-1 overflow-y-auto px-4 py-2 flex flex-col gap-2"></div>

<!-- Message Input -->
<form id="chat-form" class="flex items-center border-t p-2 bg-white">
  <input id="message-input" type="text" placeholder="Type a message..." required class="flex-1 p-2 border rounded-full outline-none"/>
  <button type="submit" class="ml-2 px-4 py-2 bg-red-500 text-white rounded-full">Send</button>
</form>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
  import { getDatabase, ref, onValue, push, set, remove, get } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
    authDomain: "fire-b-a8878.firebaseapp.com",
    databaseURL: "https://fire-b-a8878.firebaseio.com",
    projectId: "fire-b-a8878",
    storageBucket: "fire-b-a8878.appspot.com",
    messagingSenderId: "658673187627",
    appId: "1:658673187627:web:6e4c29af661785f0afa36e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getDatabase();

  const gid = new URLSearchParams(location.search).get('gid');
  const chatBox = document.getElementById('chat-box');
  const chatForm = document.getElementById('chat-form');
  const messageInput = document.getElementById('message-input');
  const groupName = document.getElementById('group-name');
  const groupAvatar = document.getElementById('group-avatar');
  const addBtn = document.getElementById('add-member-btn');
  const membersList = document.getElementById('members-list');
  const chatScrollBtn = document.getElementById('chat-scroll-btn');

  let currentUser = null;
  let groupData = null;

  onAuthStateChanged(auth, async user => {
    if (!user) return (location.href = "login.html");
    currentUser = user;

    const groupRef = ref(db, `groups/${gid}`);
    onValue(groupRef, snapshot => {
      if (!snapshot.exists()) return;
      groupData = snapshot.val();

      groupName.textContent = groupData.name || "Group";
      if (groupData.avatarURL) groupAvatar.src = groupData.avatarURL;

      if (groupData.createdBy === currentUser.uid) {
        addBtn.classList.remove("hidden");
        addBtn.onclick = () => {
          const email = prompt("Enter email to invite:");
          if (email) addMemberByEmail(email);
        };
      }

      // Render Members
      membersList.innerHTML = "";
      if (groupData.members) {
        for (const uid in groupData.members) {
          const m = groupData.members[uid];
          const card = document.createElement('div');
          card.className = "bg-white p-3 shadow rounded flex items-center justify-between gap-4";
          card.innerHTML = `
            <div class="flex items-center gap-3">
              <img src="${m.avatarURL || 'https://www.gravatar.com/avatar?d=mp'}" class="w-10 h-10 rounded-full" />
              <div>
                <p class="font-semibold">${m.name || 'Member'}</p>
              </div>
            </div>
            ${uid === currentUser.uid ? `<button class="text-sm bg-gray-200 px-2 py-1 rounded" onclick="exitGroup('${uid}')">Exit</button>` : ""}
          `;
          membersList.appendChild(card);
        }
      }
    });

    // Chat Messages
    const messagesRef = ref(db, `groupMessages/${gid}`);
    onValue(messagesRef, snapshot => {
      chatBox.innerHTML = "";
      const messages = snapshot.val();
      for (let mid in messages) {
        const msg = messages[mid];
        const bubble = document.createElement("div");
        bubble.className = `chat-bubble ${msg.sender === currentUser.uid ? "me self-end" : "other self-start"}`;
        bubble.textContent = msg.text;
        chatBox.appendChild(bubble);
      }
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  });

  chatForm.onsubmit = async (e) => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text || !currentUser) return;
    const msgRef = push(ref(db, `groupMessages/${gid}`));
    await set(msgRef, {
      sender: currentUser.uid,
      text,
      timestamp: Date.now()
    });
    messageInput.value = "";
  };

  window.exitGroup = async (uid) => {
    if (confirm("Are you sure you want to exit this group?")) {
      await remove(ref(db, `groups/${gid}/members/${uid}`));
      alert("You have left the group.");
      location.href = "index.html";
    }
  };

  async function addMemberByEmail(email) {
    const usersSnap = await get(ref(db, "users"));
    const users = usersSnap.val();
    for (let uid in users) {
      if (users[uid].email?.toLowerCase() === email.toLowerCase()) {
        await set(ref(db, `groups/${gid}/members/${uid}`), {
          name: users[uid].name || email,
          avatarURL: users[uid].photoURL || ''
        });
        alert("Member added!");
        return;
      }
    }
    alert("User not found.");
  }

  chatScrollBtn.onclick = () => {
    chatBox.scrollIntoView({ behavior: 'smooth' });
  };
</script>
</body>
</html>
