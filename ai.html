<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Chat - Vynix</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
  <style>
    :root {
      --banter-blue: #1DA1F2;
      --banter-purple: #8A3FFC;
      --banter-accent: #FF2D55;
      --text-dark: #1A202C;
      --text-light: #718096;
      --border: #E2E8F0;
      --white: #FFFFFF;
      --background: #F7FAFC;
      --dark-bg: #1A202C;
      --dark-border: #2D3748;
      --dark-text: #E2E8F0;
    }

    [data-theme="dark"] {
      --text-dark: var(--dark-text);
      --border: var(--dark-border);
      --white: var(--dark-bg);
      --background: #2D3748;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--background);
      color: var(--text-dark);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      transition: background 0.3s ease, color 0.3s ease;
    }

    body.fade-out {
      opacity: 0;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      position: relative;
    }

    .top-buttons {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
      z-index: 1000;
    }

    .settings-btn, .delete-chat-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
    }

    .settings-btn svg, .delete-chat-btn svg {
      width: 24px;
      height: 24px;
      stroke: var(--text-light);
      transition: stroke 0.2s ease;
    }

    .settings-btn:hover svg {
      stroke: var(--banter-purple);
    }

    .delete-chat-btn:hover svg {
      stroke: var(--banter-accent);
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .loading-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid transparent;
      border-top-color: var(--banter-blue);
      border-right-color: var(--banter-purple);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .spinner-text {
      color: var(--white);
      font-size: 0.9rem;
      font-weight: 500;
      margin-top: 0.75rem;
      letter-spacing: 0.05em;
    }

    .ai-chat {
      flex: 1;
      display: flex;
      flex-direction: column-reverse;
      gap: 1rem;
      padding-bottom: 1.5rem;
    }

    .chat-message {
      display: flex;
      flex-direction: column;
      max-width: 85%;
      padding: 1rem 1.25rem;
      border-radius: 20px;
      background: var(--white);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.4s ease-out;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .chat-message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--banter-blue) 0%, #4da8f7 100%);
      color: var(--white);
    }

    .chat-message.ai {
      align-self: flex-start;
      background: linear-gradient(135deg, var(--banter-purple) 0%, #a675fc 100%);
      color: var(--white);
    }

    .chat-message:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    .chat-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .chat-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--text-light);
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 600;
    }

    .chat-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .chat-username {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .chat-timestamp {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .chat-content {
      font-size: 1rem;
      line-height: 1.5;
      word-break: break-word;
    }

    .ai-compose {
      position: sticky;
      bottom: 1.5rem;
      margin: 0 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--white);
      border-radius: 30px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      transition: box-shadow 0.3s ease, transform 0.3s ease;
      padding: 0.25rem;
    }

    .ai-compose:hover {
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      transform: translateY(-2px);
    }

    .ai-input {
      flex: 1;
      width: 100%;
      padding: 0;
      border: none;
      border-radius: 30px;
      font-size: 1rem;
      color: var(--text-dark);
      background: transparent;
      resize: none;
      outline: none;
      box-sizing: border-box;
    }

    .ai-input:focus {
      border: none;
      outline: none;
      box-shadow: none;
    }

    .ai-input:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .ai-input::placeholder {
      color: var(--text-light);
      font-style: italic;
      padding-left: 0.75rem; /* Placeholder padding for visual alignment */
    }

    .send-btn {
      background: linear-gradient(135deg, var(--banter-blue) 0%, var(--banter-purple) 100%);
      border: none;
      padding: 0.75rem;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.2s ease;
      border-radius: 50%;
      display: flex;
      align-items: center;
      margin-left: 0.25rem;
    }

    .send-btn.active {
      opacity: 1;
      transform: scale(1.1);
    }

    .send-btn svg {
      width: 24px;
      height: 24px;
      stroke: var(--white);
      stroke-width: 2;
    }

    .send-btn:hover {
      transform: scale(1.15);
    }

    .send-btn:disabled {
      cursor: not-allowed;
      opacity: 0.5;
      transform: scale(1);
    }

    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding: 0 1rem;
    }

    .suggestion-btn {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      color: var(--text-dark);
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .suggestion-btn:hover {
      background: var(--banter-blue);
      color: var(--white);
      transform: translateY(-2px);
    }

    .custom-alert {
      display: none;
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--white);
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1001;
      color: var(--text-dark);
      font-weight: 500;
      text-align: center;
      max-width: 90%;
      width: 320px;
      animation: fadeIn 0.3s ease-out forwards;
    }

    .custom-alert.active {
      display: block;
    }

    .custom-alert .close-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      width: 20px;
      height: 20px;
      background: none;
      border: none;
      cursor: pointer;
    }

    .custom-alert .close-btn svg {
      width: 100%;
      height: 100%;
      stroke: var(--text-dark);
      stroke-width: 2;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    @media (max-width: 640px) {
      .container {
        padding: 0.75rem;
      }

      .chat-message {
        max-width: 90%;
        padding: 0.75rem 1rem;
      }

      .chat-avatar {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
      }

      .chat-username {
        font-size: 0.9rem;
      }

      .chat-timestamp {
        font-size: 0.75rem;
      }

      .chat-content {
        font-size: 0.95rem;
      }

      .ai-compose {
        margin: 0 0.75rem;
        padding: 0.25rem;
      }

      .ai-input {
        font-size: 0.95rem;
        padding: 0;
      }

      .ai-input::placeholder {
        padding-left: 0.5rem;
      }

      .send-btn {
        margin-left: 0.25rem;
      }

      .send-btn svg {
        width: 20px;
        height: 20px;
      }

      .suggestion-btn {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-buttons">
      <button class="delete-chat-btn" aria-label="Delete chat history" onclick="deleteChat()">
        <svg viewBox="0 0 24 24">
          <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
        </svg>
      </button>
      <button class="settings-btn" aria-label="Toggle settings" onclick="toggleTheme()">
        <svg viewBox="0 0 24 24">
          <path d="M19.14 12.94c.04-.3.06-.61.06-.94s-.02-.64-.06-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.49.49 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.49.49 0 0 0-.48-.41h-3.84a.49.49 0 0 0-.48.41l-.36 2.54c-.59.24-1.13.56-1.62.94l-2.39-.96a.49.49 0 0 0-.59.22L2.86 9.41a.49.49 0 0 0 .12.61l2.03 1.58a2.66 2.66 0 0 0 0 1.88l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32a.49.49 0 0 0 .59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54a.49.49 0 0 0 .48.41h3.84a.49.49 0 0 0 .48-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96a.49.49 0 0 0 .59-.22l1.92-3.32a.49.49 0 0 0-.12-.61l-2.03-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
        </svg>
      </button>
    </div>
    <div class="custom-alert" id="alert">
      <span id="alert-message"></span>
      <button class="close-btn" aria-label="Close alert">
        <svg viewBox="0 0 24 24">
          <path d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="loading-overlay" id="loading-overlay">
      <div class="spinner"></div>
      <span class="spinner-text">Vynix is thinking...</span>
    </div>
    <div class="suggestions" id="suggestions">
      <button class="suggestion-btn" onclick="setPrompt('Tell me a joke!')">Tell me a joke!</button>
      <button class="suggestion-btn" onclick="setPrompt('What’s a fun fact?')">What’s a fun fact?</button>
      <button class="suggestion-btn" onclick="setPrompt('Why is Vynix awesome?')">Why is Vynix awesome?</button>
    </div>
    <div class="ai-chat" id="ai-chat"></div>
    <div class="ai-compose">
      <textarea id="ai-input" rows="1" placeholder="Ask Vynix something spicy..." aria-label="Compose AI prompt"></textarea>
      <button class="send-btn" id="send-btn" disabled aria-label="Send message">
        <svg viewBox="0 0 24 24">
          <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
        </svg>
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getDatabase, ref, push, get, set } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
    import * as tf from 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const aiInput = document.getElementById("ai-input");
    const sendBtn = document.getElementById("send-btn");
    const aiChat = document.getElementById("ai-chat");
    const alert = document.getElementById("alert");
    const alertMessage = document.getElementById("alert-message");
    const loadingOverlay = document.getElementById("loading-overlay");
    let currentUser = null;

    // Bigram model state
    let bigramModel = {};
    let vocabulary = new Set();
    let wordToIndex = {};
    let indexToWord = {};

    // Expanded initial corpus for better response variety
    const initialCorpus = [
      "Hey there! I'm Vynix, your go-to AI for witty banter and spicy answers!",
      "What's the vibe today? Ask me something fun, and I'll keep it lively!",
      "Why did the computer go to art school? It wanted to draw a better 'byte'!",
      "Got a question? I'm all code and no nonsense, with a dash of humor!",
      "Life’s too short for dull chats. Hit me with your spiciest question!",
      "Why is Vynix awesome? Because I mix brains with a pinch of sass!",
      "Fun fact: The shortest war in history lasted 38 minutes. Bet I can answer faster!",
      "Want a joke? Why did the scarecrow become a motivational speaker? He was outstanding in his field!",
      "Vynix here, ready to serve answers with a side of wit. What's up?",
      "Ask me anything, and I’ll make sure it’s a conversation worth screenshotting!"
    ];

    // Tokenize text into words
    function tokenize(text) {
      return text.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/).filter(word => word.length > 0);
    }

    // Build bigram model from text
    function buildBigramModel(texts) {
      console.log("Building bigram model...");
      bigramModel = {};
      vocabulary.clear();

      texts.forEach(text => {
        const words = tokenize(text);
        words.forEach(word => vocabulary.add(word));
        for (let i = 0; i < words.length - 1; i++) {
          const currentWord = words[i];
          const nextWord = words[i + 1];
          if (!bigramModel[currentWord]) {
            bigramModel[currentWord] = {};
          }
          bigramModel[currentWord][nextWord] = (bigramModel[currentWord][nextWord] || 0) + 1;
        }
      });

      // Create word-to-index mapping
      wordToIndex = {};
      indexToWord = {};
      Array.from(vocabulary).forEach((word, index) => {
        wordToIndex[word] = index;
        indexToWord[index] = word;
      });

      console.log("Bigram model built:", bigramModel);
    }

    // Generate response using bigram model
    function generateResponse(prompt) {
      console.log("Generating response for prompt:", prompt);
      const words = tokenize(prompt);
      const lastWord = words[words.length - 1] || Object.keys(bigramModel)[Math.floor(Math.random() * Object.keys(bigramModel).length)];
      let response = [lastWord];

      for (let i = 0; i < 12; i++) {
        const nextWords = bigramModel[lastWord];
        if (!nextWords) break;

        const totalCount = Object.values(nextWords).reduce((sum, count) => sum + count, 0);
        let rand = Math.random() * totalCount;
        let nextWord = null;

        for (const [word, count] of Object.entries(nextWords)) {
          rand -= count;
          if (rand <= 0) {
            nextWord = word;
            break;
          }
        }

        if (!nextWord) break;
        response.push(nextWord);
        lastWord = nextWord;
      }

      const generated = response.join(" ") || "Vynix says: Let's spice things up!";
      console.log("Generated response:", generated);
      return generated.charAt(0).toUpperCase() + generated.slice(1) + "!";
    }

    // Initialize model with Firebase data or initial corpus
    async function initializeModel() {
      if (!currentUser) return;
      showLoading();
      try {
        const chatRef = ref(db, `users/${currentUser.uid}/ai_chat`);
        const snapshot = await get(chatRef);
        const messages = snapshot.val();
        let texts = initialCorpus;

        if (messages) {
          texts = texts.concat(Object.values(messages).map(msg => msg.text));
        }

        buildBigramModel(texts);
        showAlert("Vynix is ready to chat!", true);
      } catch (error) {
        console.error("Error initializing model:", error);
        showAlert("Failed to initialize Vynix. Using default responses.", false);
        buildBigramModel(initialCorpus);
      } finally {
        hideLoading();
      }
    }

    // Delete chat history
    async function deleteChat() {
      if (!currentUser || currentUser.isGuest) {
        showAlert("Guests can't delete chat history.", false);
        return;
      }

      showLoading();
      try {
        const chatRef = ref(db, `users/${currentUser.uid}/ai_chat`);
        await set(chatRef, null); // Clear chat history
        aiChat.innerHTML = ""; // Clear UI
        buildBigramModel(initialCorpus); // Rebuild model with initial corpus
        showAlert("Chat history deleted!", true);
      } catch (error) {
        console.error("Error deleting chat history:", error);
        showAlert("Failed to delete chat history. Try again.", false);
      } finally {
        hideLoading();
      }
    }

    function showLoading() {
      console.log("Showing loading overlay");
      loadingOverlay.classList.add("active");
    }

    function hideLoading() {
      console.log("Hiding loading overlay");
      loadingOverlay.classList.remove("active");
    }

    function showAlert(message, isSuccess) {
      console.log("Showing alert:", message);
      alertMessage.textContent = message;
      alert.style.background = isSuccess ? "rgba(29, 161, 242, 0.1)" : "rgba(255, 0, 0, 0.1)";
      alert.classList.add("active");
      setTimeout(() => alert.classList.remove("active"), 3000);
    }

    function formatTimestamp(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      if (days > 0) return `${days}d`;
      if (hours > 0) return `${hours}h`;
      if (minutes > 0) return `${minutes}m`;
      return `${seconds}s`;
    }

    function getAvatarInitials(username) {
      return username ? username.charAt(0).toUpperCase() : "V";
    }

    function renderMessage(messageData, isUser, userData = null) {
      console.log("Rendering message:", messageData);
      const messageDiv = document.createElement("div");
      messageDiv.className = `chat-message ${isUser ? "user" : "ai"}`;
      messageDiv.tabIndex = 0;
      const username = isUser ? (userData?.username || "Anonymous") : "Vynix";
      const profilePicture = isUser ? userData?.profilePicture : null;
      messageDiv.innerHTML = `
        <div class="chat-header">
          <div class="chat-avatar">${profilePicture ? `<img src="${profilePicture}" alt="${username}'s profile picture" />` : getAvatarInitials(username)}</div>
          <div class="chat-username">${username}</div>
          <span class="chat-timestamp">${formatTimestamp(messageData.createdAt)}</span>
        </div>
        <div class="chat-content">${messageData.text}</div>
      `;
      aiChat.prepend(messageDiv);
    }

    function adjustTextareaHeight() {
      aiInput.style.height = "auto";
      aiInput.style.height = `${Math.min(aiInput.scrollHeight, 120)}px`;
    }

    async function sendMessage() {
      if (!aiInput.value.trim()) {
        console.log("No input text, skipping send");
        return;
      }
      if (currentUser && currentUser.isGuest) {
        showAlert("Guests can't chat with Vynix.", false);
        return;
      }

      showLoading();
      try {
        const userRef = ref(db, `users/${auth.currentUser.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val() || {};

        const userMessage = {
          text: aiInput.value,
          createdAt: Date.now(),
          isUser: true
        };
        console.log("Saving user message to Firebase:", userMessage);
        await push(ref(db, `users/${auth.currentUser.uid}/ai_chat`), userMessage);
        renderMessage(userMessage, true, userData);

        // Generate AI response
        const aiResponseText = generateResponse(aiInput.value);
        const aiMessage = {
          text: aiResponseText,
          createdAt: Date.now(),
          isUser: false
        };
        console.log("Saving AI message to Firebase:", aiMessage);
        await push(ref(db, `users/${auth.currentUser.uid}/ai_chat`), aiMessage);
        renderMessage(aiMessage, false);

        // Update bigram model with new messages
        buildBigramModel([aiInput.value, aiResponseText]);

        aiInput.value = "";
        adjustTextareaHeight();
        sendBtn.classList.remove("active");
        sendBtn.disabled = true;
        showAlert("Vynix has spoken!", true);
      } catch (error) {
        console.error("Send message error:", error);
        showAlert("Failed to process message. Try again!", false);
      } finally {
        hideLoading();
      }
    }

    function toggleTheme() {
      const isDark = document.documentElement.getAttribute("data-theme") === "dark";
      document.documentElement.setAttribute("data-theme", isDark ? "light" : "dark");
      console.log("Toggled theme to:", isDark ? "light" : "dark");
    }

    function setPrompt(prompt) {
      aiInput.value = prompt;
      adjustTextareaHeight();
      sendBtn.disabled = !prompt.trim() || (currentUser && currentUser.isGuest);
      sendBtn.classList.toggle("active", prompt.trim() && !(currentUser && currentUser.isGuest));
      aiInput.focus();
    }

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        console.log("No user authenticated, redirecting to signup");
        document.body.classList.add("fade-out");
        setTimeout(() => {
          window.location.href = "signup.html";
        }, 1500);
        return;
      }

      currentUser = user;
      showLoading();
      const userRef = ref(db, `users/${user.uid}`);
      get(userRef).then((snapshot) => {
        const userData = snapshot.val() || {};
        const isGuest = userData.isGuest || false;
        user.isGuest = isGuest;
        aiInput.disabled = isGuest;
        sendBtn.disabled = isGuest || !aiInput.value.trim();
        aiInput.placeholder = isGuest ? "Guests can't chat with Vynix." : "Ask Vynix something spicy...";
        console.log("User data loaded:", userData, "Is guest:", isGuest);

        // Load chat history and initialize model
        const chatRef = ref(db, `users/${user.uid}/ai_chat`);
        get(chatRef).then((snapshot) => {
          aiChat.innerHTML = "";
          const messages = snapshot.val();
          if (messages) {
            Object.values(messages).sort((a, b) => a.createdAt - b.createdAt).forEach((message) => {
              renderMessage(message, message.isUser, userData);
            });
          }
          initializeModel();
        }).catch((error) => {
          console.error("Error loading chat history:", error);
          showAlert("Failed to load chat history. Try again.", false);
          initializeModel();
        });
      }).catch((error) => {
        console.error("Error loading user data:", error);
        showAlert("Failed to load user data. Try again.", false);
        initializeModel();
      });
    });

    aiInput.addEventListener("input", () => {
      console.log("Input event triggered, text:", aiInput.value);
      adjustTextareaHeight();
      sendBtn.disabled = !aiInput.value.trim() || (currentUser && currentUser.isGuest);
      sendBtn.classList.toggle("active", aiInput.value.trim() && !(currentUser && currentUser.isGuest));
    });

    aiInput.addEventListener("keypress", async (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        console.log("Enter key pressed");
        e.preventDefault();
        await sendMessage();
      }
    });

    sendBtn.addEventListener("click", async () => {
      console.log("Send button clicked");
      await sendMessage();
    });

    // Initial textarea height adjustment
    adjustTextareaHeight();
  </script>
</body>
</html>
