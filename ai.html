<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Vynix AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script>
    MathJax = {
      loader: { load: ['[tex]/mhchem'] },
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        packages: {'[+]': ['mhchem']}
      },
      chtml: { linebreaks: { automatic: true } }
    };
  </script>
  <script id="MathJax-script" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    :root {
      --primary-color: #6366F1;
      --primary-light: #818CF8;
      --primary-dark: #4F46E5;
      --border: #E2E8F0;
      --hover-bg: #F8FAFC;
      --text-dark: #0F172A;
      --text-light: #64748B;
      --text-muted: #94A3B8;
      --bg-body: #F8FAFC;
      --bg-surface: #FFFFFF;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    * {
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: var(--text-dark);
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: 80px 1fr;
      max-width: 1265px;
      margin: 0 auto;
      min-height: 100vh;
      gap: 2rem;
    }

    @media (min-width: 640px) { 
      .layout-grid { grid-template-columns: 280px 1fr; gap: 2rem; } 
    }

    .sidebar {
      position: sticky;
      top: 0;
      height: 100vh;
      padding: 1.5rem 1rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border-right: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .logo-box { 
      padding: 0.5rem; 
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .logo-box span {
      font-size: 1.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: none;
    }
    
    @media (min-width: 640px) { 
      .logo-box span { display: block; } 
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.875rem 1.25rem;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-light);
      width: 100%;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      margin-bottom: 0.25rem;
      text-decoration: none;
    }
    
    .nav-item:hover { 
      background: rgba(99, 102, 241, 0.08); 
      color: var(--primary-color);
      transform: translateX(4px);
    }
    
    .nav-item.active { 
      color: var(--primary-color);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.12), rgba(99, 102, 241, 0.05));
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.1);
    }
    
    .nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 60%;
      background: var(--primary-color);
      border-radius: 0 4px 4px 0;
      display: none;
    }
    
    @media (min-width: 640px) { 
      .nav-item.active::before { display: block; } 
    }

    .nav-item i {
      stroke-width: 2;
      width: 24px;
      height: 24px;
    }
    
    .nav-text { display: none; }
    @media (min-width: 640px) { 
      .nav-text { display: block; } 
    }

    .new-chat-btn {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.875rem 1.25rem;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: all 0.2s;
      box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3);
    }
    
    .new-chat-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 12px -2px rgba(99, 102, 241, 0.4);
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
      background: white;
      border-radius: 24px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      margin: 1rem 1rem 1rem 0;
    }

    @media (max-width: 639px) {
      .sidebar { display: none; }
      .layout-grid { 
        grid-template-columns: 1fr; 
        padding: 0;
        gap: 0;
      }
      .main-content { 
        border-radius: 0; 
        border: none;
        margin: 0;
        height: 100vh;
      }
    }

    .chat-header {
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
      border-bottom: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      z-index: 10;
    }

    .chat-scroll {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 1.5rem;
      scroll-behavior: smooth;
    }

    .message-row {
      display: flex;
      justify-content: center;
      padding: 1rem 0;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(15px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    .message-content {
      width: 100%;
      max-width: 800px;
      display: flex;
      gap: 12px;
      padding: 0 8px;
    }

    .message-row.user .message-content { 
      justify-content: flex-end; 
      flex-direction: row-reverse;
    }

    .msg-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      flex-shrink: 0;
      background-size: cover;
      background-position: center;
      border: 2px solid white;
      box-shadow: var(--shadow-sm);
    }

    .ai-bubble-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 100%;
      width: 100%;
      min-width: 0;
    }

    .msg-text {
      font-size: 1rem;
      line-height: 1.6;
      color: var(--text-dark);
      word-break: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
      width: fit-content;
      overflow-x: hidden;
    }

    .message-row.user .msg-text {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
      color: white;
      padding: 12px 20px;
      border-radius: 24px 24px 4px 24px;
      box-shadow: var(--shadow-md);
    }

    .message-row.ai .msg-text { 
      padding-top: 6px; 
      color: var(--text-dark);
    }

    .thinking-indicator {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: rgba(99, 102, 241, 0.08);
      border-radius: 20px;
      max-width: 200px;
    }

    .thinking-dots {
      display: flex;
      gap: 4px;
    }

    .thinking-dot {
      width: 8px;
      height: 8px;
      background: var(--primary-color);
      border-radius: 50%;
      animation: thinking-bounce 1.4s infinite ease-in-out both;
    }

    .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
    .thinking-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes thinking-bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    .input-container {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1rem 1.5rem calc(1rem + env(safe-area-inset-bottom));
      background: linear-gradient(to top, white 60%, transparent);
      display: flex;
      justify-content: center;
      z-index: 20;
    }

    .input-wrapper {
      width: 100%;
      max-width: 800px;
      background: #F1F5F9;
      border-radius: 28px;
      padding: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
      transition: all 0.2s ease;
    }

    .input-wrapper:focus-within {
      background: white;
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
      border-color: rgba(99, 102, 241, 0.3);
    }

    .chat-input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 1rem;
      color: var(--text-dark);
      outline: none;
      padding: 12px 8px;
      font-family: inherit;
    }

    .chat-input::placeholder {
      color: var(--text-muted);
    }

    .input-tool-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-light);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .input-tool-btn:hover { 
      background: var(--hover-bg); 
      color: var(--primary-color);
    }

    .send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-light);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .send-btn.active { 
      background: var(--primary-color); 
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .send-btn.active:hover {
      transform: scale(1.05);
    }

    .welcome-screen {
      position: absolute;
      inset: 64px 0 0 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 5;
      background: white;
      padding: 2rem;
    }

    .welcome-screen.hidden { 
      display: none; 
      opacity: 0; 
      pointer-events: none; 
    }

    .brand-gradient-text {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
      -webkit-background-clip: text;
      color: transparent;
      font-weight: 800;
      font-size: 3rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .welcome-sub {
      color: var(--text-muted);
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 3rem;
      text-align: center;
    }

    .suggestions-grid {
      display: flex;
      gap: 12px;
      width: 100%;
      max-width: 600px;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .suggestion-card {
      flex: 1;
      min-width: 160px;
      background: #F8FAFC;
      padding: 20px;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 140px;
      border: 1px solid var(--border);
      font-weight: 600;
      color: var(--text-dark);
    }

    .suggestion-card:hover { 
      background: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: var(--primary-light);
    }

    .msg-toolbar {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .message-row.ai:hover .msg-toolbar { 
      opacity: 1; 
    }

    .tool-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 6px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .tool-btn:hover { 
      background: var(--hover-bg); 
      color: var(--primary-color); 
    }

    .tool-btn.active { 
      color: var(--primary-color); 
      background: rgba(99, 102, 241, 0.1); 
    }

    code {
      background: #1e293b;
      color: #e2e8f0;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Fira Code', monospace;
      font-size: 0.9em;
    }

    pre {
      background: #1e293b;
      padding: 1rem;
      border-radius: 12px;
      overflow-x: auto;
      margin: 0.5rem 0;
    }

    pre code {
      background: transparent;
      padding: 0;
    }

    .typing-cursor::after {
      content: '|';
      animation: blink 1s infinite;
      color: var(--primary-color);
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    @media (max-width: 639px) {
      .brand-gradient-text { font-size: 2rem; }
      .welcome-sub { font-size: 1rem; }
      .suggestion-card { min-width: 140px; height: 120px; }
    }
  </style>
</head>
<body>
  <div class="layout-grid">
    <aside class="sidebar">
      <div>
        <div class="logo-box">
          <svg width="36" height="36" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="40" height="40" rx="12" fill="url(#gradient)"/>
            <path d="M12 20L18 26L28 14" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="28" cy="26" r="4" fill="white"/>
            <defs>
              <linearGradient id="gradient" x1="0" y1="0" x2="40" y2="40" gradientUnits="userSpaceOnUse">
                <stop stop-color="#6366F1"/>
                <stop offset="1" stop-color="#818CF8"/>
              </linearGradient>
            </defs>
          </svg>
          <span>Vynix</span>
        </div>
        
        <button class="new-chat-btn" onclick="resetChat()">
          <i data-feather="plus"></i>
          <span class="nav-text">New Chat</span>
        </button>
        
        <nav style="display:flex; flex-direction:column; gap:0.25rem;">
          <a href="index.html" class="nav-item">
            <i data-feather="home"></i>
            <span class="nav-text">Home</span>
          </a>
          <div class="nav-item active">
            <i data-feather="cpu"></i>
            <span class="nav-text">AI Assistant</span>
          </div>
          <a href="profile.html" class="nav-item">
            <i data-feather="user"></i>
            <span class="nav-text">Profile</span>
          </a>
        </nav>
      </div>
      
      <div style="margin-top: auto;">
        <div class="nav-item" onclick="handleSignOut()" style="color: var(--text-light);">
          <i data-feather="log-out"></i>
          <span class="nav-text">Logout</span>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <div class="chat-header">
        <div style="display:flex; align-items:center; gap:12px;">
          <span style="font-weight:700; font-size:1.1rem; color:var(--text-dark)">Vynix AI</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
          <div id="userAvatar" style="width:32px; height:32px; border-radius:50%; background:linear-gradient(135deg, var(--primary-color), var(--primary-light)); display:flex; align-items:center; justify-content:center; color:white; font-weight:600; font-size:0.9rem;">G</div>
        </div>
      </div>

      <div class="welcome-screen" id="welcomeScreen">
        <h1 class="brand-gradient-text">Hello, Student</h1>
        <p class="welcome-sub">How can I help you learn today?</p>
        <div class="suggestions-grid">
          <div class="suggestion-card" onclick="setInput('Solve this equation: 2xÂ² + 5x - 3 = 0')">
            <span>Solve Math<br>Equation</span>
            <i data-feather="calculator" style="align-self:flex-end; color:var(--primary-color);"></i>
          </div>
          <div class="suggestion-card" onclick="setInput('Explain photosynthesis with diagrams')">
            <span>Science<br>Concepts</span>
            <i data-feather="activity" style="align-self:flex-end; color:var(--primary-color);"></i>
          </div>
          <div class="suggestion-card" onclick="setInput('Help me write an essay introduction')">
            <span>Essay<br>Writing</span>
            <i data-feather="edit-3" style="align-self:flex-end; color:var(--primary-color);"></i>
          </div>
        </div>
      </div>

      <div class="chat-scroll" id="chatContainer" style="display:none;"></div>

      <div class="input-container">
        <div class="input-wrapper">
          <input type="text" class="chat-input" id="userInput" placeholder="Ask anything..." autocomplete="off">
          <button class="input-tool-btn" onclick="document.getElementById('imageInput').click()" title="Upload image">
            <i data-feather="image"></i>
          </button>
          <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="handleImageSelect(event)">
          <button class="send-btn" id="sendBtn" onclick="handleSend()">
            <i data-feather="arrow-up"></i>
          </button>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    let XAI_API_KEY = "xai-api-key-here";
    const MODEL_ID = "grok-4-1-fast-reasoning";
    let currentUser = null;
    let messageIdCounter = 0;
    let pendingImage = null;

    const els = {
      welcome: document.getElementById('welcomeScreen'),
      chat: document.getElementById('chatContainer'),
      input: document.getElementById('userInput'),
      sendBtn: document.getElementById('sendBtn'),
      userAvatar: document.getElementById('userAvatar')
    };

    // Auth
    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) {
        els.userAvatar.textContent = user.displayName?.[0] || 'U';
        els.userAvatar.style.background = `url(${user.photoURL}) center/cover`;
      }
    });

    function handleSignOut() {
      auth.signOut().then(() => window.location.href = 'index.html');
    }

    function setInput(text) {
      els.input.value = text;
      els.input.focus();
      checkInput();
    }

    function checkInput() {
      const hasText = els.input.value.trim().length > 0;
      els.sendBtn.classList.toggle('active', hasText || pendingImage);
    }

    els.input.addEventListener('input', checkInput);

    function resetChat() {
      els.chat.innerHTML = '';
      els.chat.style.display = 'none';
      els.welcome.style.display = 'flex';
      els.welcome.classList.remove('hidden');
      els.input.value = '';
      pendingImage = null;
      checkInput();
    }

    function activateChatMode() {
      els.welcome.classList.add('hidden');
      setTimeout(() => els.welcome.style.display = 'none', 300);
      els.chat.style.display = 'block';
    }

    function handleImageSelect(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 10 * 1024 * 1024) {
        alert('Image too large. Max 10MB.');
        return;
      }
      pendingImage = file;
      els.input.placeholder = "Add a message about this image...";
      checkInput();
    }

    async function handleSend() {
      const text = els.input.value.trim();
      if (!text && !pendingImage) return;

      activateChatMode();
      
      if (pendingImage) {
        await sendImageMessage(text);
      } else {
        await sendTextMessage(text);
      }
    }

    async function sendImageMessage(text) {
      const thinkingId = showThinking();
      const tempUrl = URL.createObjectURL(pendingImage);
      
      appendMessage('user', text || 'Image', { type: 'image', url: tempUrl });
      els.input.value = '';
      
      // Simulate upload and analysis
      setTimeout(() => {
        removeThinking(thinkingId);
        appendMessage('ai', 'I can see the image you uploaded. ' + (text ? 'Regarding your question: ' + text : 'How can I help you with this?'));
        pendingImage = null;
        els.input.placeholder = "Ask anything...";
        checkInput();
      }, 2000);
    }

    async function sendTextMessage(text) {
      const thinkingId = showThinking();
      appendMessage('user', text);
      els.input.value = '';
      checkInput();

      try {
        const response = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${XAI_API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: MODEL_ID,
            messages: [
              { role: "system", content: "You are Vynix AI, a helpful educational tutor. Use LaTeX for math." },
              { role: "user", content: text }
            ]
          })
        });

        const data = await response.json();
        removeThinking(thinkingId);
        
        if (data.choices?.[0]?.message?.content) {
          appendMessage('ai', data.choices[0].message.content, {}, true);
        }
      } catch (err) {
        removeThinking(thinkingId);
        appendMessage('ai', 'Sorry, I encountered an error. Please try again.');
      }
    }

    function showThinking() {
      const id = `thinking-${Date.now()}`;
      const row = document.createElement('div');
      row.className = 'message-row ai';
      row.id = id;
      row.innerHTML = `
        <div class="message-content">
          <div class="msg-avatar" style="background: linear-gradient(135deg, #6366F1, #818CF8);"></div>
          <div class="ai-bubble-container">
            <div class="thinking-indicator">
              <div class="thinking-dots">
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
              </div>
              <span style="font-size:0.95rem; color:var(--primary-color); font-weight:500;">Thinking...</span>
            </div>
          </div>
        </div>
      `;
      els.chat.appendChild(row);
      els.chat.scrollTop = els.chat.scrollHeight;
      return id;
    }

    function removeThinking(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    function appendMessage(role, text, extra = null, isStreaming = false) {
      const row = document.createElement('div');
      row.className = `message-row ${role}`;
      
      const content = document.createElement('div');
      content.className = 'message-content';
      
      const avatar = document.createElement('div');
      avatar.className = 'msg-avatar';
      
      if (role === 'ai') {
        avatar.style.background = 'linear-gradient(135deg, #6366F1, #818CF8)';
        const container = document.createElement('div');
        container.className = 'ai-bubble-container';
        
        const bubble = document.createElement('div');
        bubble.className = 'msg-text';
        
        if (isStreaming) {
          bubble.classList.add('typing-cursor');
          let i = 0;
          function typeWriter() {
            if (i < text.length) {
              bubble.innerHTML = formatText(text.substring(0, i + 1));
              i++;
              els.chat.scrollTop = els.chat.scrollHeight;
              setTimeout(typeWriter, 15);
            } else {
              bubble.classList.remove('typing-cursor');
              MathJax.typesetPromise([bubble]);
              hljs.highlightAll();
            }
          }
          typeWriter();
        } else {
          bubble.innerHTML = formatText(text);
          setTimeout(() => {
            MathJax.typesetPromise([bubble]);
            hljs.highlightAll();
          }, 100);
        }
        
        container.appendChild(bubble);
        
        const toolbar = document.createElement('div');
        toolbar.className = 'msg-toolbar';
        toolbar.innerHTML = `
          <button class="tool-btn" onclick="copyText(this)" title="Copy">
            <i data-feather="copy" style="width:16px;height:16px;"></i>
          </button>
        `;
        container.appendChild(toolbar);
        content.append(avatar, container);
      } else {
        avatar.style.background = currentUser?.photoURL || 'linear-gradient(135deg, #6366F1, #818CF8)';
        
        if (extra?.type === 'image') {
          const wrapper = document.createElement('div');
          wrapper.style.maxWidth = '70%';
          wrapper.style.borderRadius = '20px';
          wrapper.style.overflow = 'hidden';
          wrapper.style.background = '#F1F5F9';
          
          const img = document.createElement('img');
          img.src = extra.url;
          img.style.width = '100%';
          img.style.display = 'block';
          wrapper.appendChild(img);
          
          if (text) {
            const caption = document.createElement('div');
            caption.className = 'msg-text';
            caption.style.padding = '12px 16px';
            caption.textContent = text;
            wrapper.appendChild(caption);
          }
          content.append(wrapper, avatar);
        } else {
          const bubble = document.createElement('div');
          bubble.className = 'msg-text';
          bubble.textContent = text;
          content.append(bubble, avatar);
        }
      }
      
      row.appendChild(content);
      els.chat.appendChild(row);
      els.chat.scrollTop = els.chat.scrollHeight;
    }

    function formatText(text) {
      let formatted = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      
      formatted = formatted.replace(
        /(https?:\/\/[^\s<]+)/g,
        '<a href="$1" target="_blank" style="color:#6366F1;text-decoration:underline;">$1</a>'
      );
      
      formatted = formatted
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/\n/g, '<br>');
      
      return formatted;
    }

    function copyText(btn) {
      const text = btn.closest('.ai-bubble-container').querySelector('.msg-text').innerText;
      navigator.clipboard.writeText(text).then(() => {
        btn.innerHTML = '<i data-feather="check" style="width:16px;height:16px;"></i>';
        feather.replace();
        setTimeout(() => {
          btn.innerHTML = '<i data-feather="copy" style="width:16px;height:16px;"></i>';
          feather.replace();
        }, 2000);
      });
    }

    els.input.onkeypress = e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    };

    feather.replace();
  </script>
</body>
</html>
