<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Ona AI â€¢ Art & Vision</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-remote-config-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg-body: #F7F7F7;
      --bg-surface: #FFFFFF;
      --primary: #C5A059; 
      --accent: #1A1A1A;
      --primary-gradient: linear-gradient(135deg, #C5A059, #8E6E37);
      --text-main: #1A1A1A;
      --text-secondary: #707070;
      --border-color: #EAEAEA;
      --success: #10B981;
      --danger: #E11D48;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      height: 100svh; 
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .app-header {
      background: var(--bg-surface);
      height: 64px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-color);
      z-index: 10;
    }
    
    .app-title {
      font-weight: 700;
      letter-spacing: 1px;
      font-size: 1.2rem;
      text-transform: uppercase;
    }

    .icon-btn {
      background: none; border: none; color: var(--accent);
      display: flex; align-items: center; justify-content: center;
      width: 44px; height: 44px; border-radius: 50%; cursor: pointer;
      transition: all 0.2s;
    }

    .icon-btn:hover { background: rgba(0,0,0,0.05); }

    .main-content { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }

    .welcome-screen {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 30px 20px; text-align: center;
    }

    .ona-logo {
      width: 80px; height: 80px;
      background: var(--primary-gradient);
      border-radius: 22px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 20px;
      box-shadow: 0 10px 20px rgba(197, 160, 89, 0.3);
    }

    .brand-title {
      font-size: 2.2rem; font-weight: 700; margin-bottom: 8px;
    }

    .suggestions-container {
      width: 100%; max-width: 400px; margin-top: 30px;
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }

    .suggestion-chip {
      background: white; border: 1px solid var(--border-color);
      padding: 12px; border-radius: 12px; font-size: 0.85rem;
      text-align: left; cursor: pointer; transition: 0.2s;
    }
    
    .suggestion-chip:active { background: #f0f0f0; transform: scale(0.96); }

    .chat-container { padding: 20px; display: none; flex-direction: column; gap: 20px; }

    .msg-bubble {
      max-width: 85%; padding: 14px 18px; border-radius: 18px;
      font-size: 0.95rem; line-height: 1.5;
    }

    .message-row.user { display: flex; justify-content: flex-end; }
    .msg-bubble.user { background: var(--accent); color: white; border-radius: 18px 18px 4px 18px; }

    .message-row.ai { display: flex; flex-direction: column; align-items: flex-start; }
    .msg-bubble.ai { 
      background: white; border: 1px solid var(--border-color); 
      border-radius: 18px 18px 18px 4px;
      max-width: 90%;
    }

    .generated-img {
      width: 100%; border-radius: 12px; margin-top: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .generated-img:hover { transform: scale(1.02); }

    .image-actions {
      display: flex; gap: 10px; margin-top: 12px; padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }

    .action-btn {
      flex: 1; display: flex; align-items: center; justify-content: center;
      gap: 6px; padding: 10px; border-radius: 10px; border: none;
      font-size: 0.85rem; font-weight: 600; cursor: pointer;
      transition: all 0.2s; font-family: inherit;
    }

    .action-btn.upload {
      background: linear-gradient(135deg, #6366F1, #818CF8);
      color: white;
    }

    .action-btn.upload:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .action-btn.upload:disabled {
      opacity: 0.6; cursor: not-allowed; transform: none;
    }

    .action-btn.download {
      background: var(--bg-body); color: var(--text-main);
      border: 1px solid var(--border-color);
    }

    .action-btn.download:hover { background: #e5e5e5; }

    .upload-progress {
      position: fixed; top: 20px; right: 20px;
      background: white; border-radius: 12px; padding: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 5000;
      display: none; min-width: 280px; border: 1px solid var(--border-color);
    }

    .upload-progress.show { display: block; animation: slideIn 0.3s ease; }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .progress-bar {
      height: 6px; background: var(--border-color); border-radius: 3px;
      overflow: hidden; margin-top: 12px;
    }

    .progress-fill {
      height: 100%; background: linear-gradient(90deg, #6366F1, #818CF8);
      border-radius: 3px; transition: width 0.3s ease; width: 0%;
    }

    .input-bar {
      background: white; padding: 15px 20px;
      padding-bottom: calc(15px + env(safe-area-inset-bottom));
      border-top: 1px solid var(--border-color);
    }

    .input-box {
      display: flex; align-items: center; gap: 10px;
      background: #F0F0F0; border-radius: 30px; padding: 6px 6px 6px 20px;
    }

    .chat-input {
      flex: 1; border: none; background: transparent;
      font-size: 1rem; outline: none; padding: 10px 0;
    }

    .send-btn {
      width: 44px; height: 44px; border-radius: 50%;
      background: var(--accent); color: white; border: none;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }

    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .loader { display: flex; gap: 4px; padding: 15px; }
    .dot { width: 6px; height: 6px; background: var(--primary); border-radius: 50%; animation: pulse 1.2s infinite; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

    .toast {
      position: fixed; bottom: 100px; left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #1e293b; color: white; padding: 12px 24px;
      border-radius: 9999px; z-index: 2000; opacity: 0;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      pointer-events: none; font-weight: 600; font-size: 0.95rem;
      display: flex; align-items: center; gap: 8px;
    }

    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }

    .login-prompt {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      backdrop-filter: blur(8px); z-index: 3000; display: none;
      align-items: center; justify-content: center; padding: 20px;
    }

    .login-prompt.show { display: flex; }

    .login-box {
      background: white; border-radius: 20px; padding: 32px;
      max-width: 360px; width: 100%; text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .login-box h3 { font-size: 1.5rem; margin-bottom: 12px; }
    .login-box p { color: var(--text-secondary); margin-bottom: 24px; }
    
    .login-btn {
      width: 100%; padding: 14px; border-radius: 12px;
      background: linear-gradient(135deg, #6366F1, #818CF8);
      color: white; border: none; font-size: 1rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }

    .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4); }
  </style>
</head>
<body>

  <header class="app-header">
    <button class="icon-btn" onclick="resetChat()"><span class="material-symbols-rounded">refresh</span></button>
    <div class="app-title">Ona AI</div>
    <button class="icon-btn" onclick="toggleProfile()"><span class="material-symbols-rounded">account_circle</span></button>
  </header>

  <main class="main-content" id="mainScroll">
    <div class="welcome-screen" id="welcomeScreen">
      <div class="ona-logo">
        <span class="material-symbols-rounded" style="color:white; font-size:40px;">auto_awesome</span>
      </div>
      <h1 class="brand-title">Ona AI</h1>
      <p style="color: var(--text-secondary);">Bring your African visions to life through art.</p>
      
      <div class="suggestions-container">
        <div class="suggestion-chip" onclick="setPrompt('African futuristic city with baobab shaped skyscrapers')">
          <strong>Futurism</strong><br>Baobab City
        </div>
        <div class="suggestion-chip" onclick="setPrompt('Portrait of a warrior in glowing tribal neon armor')">
          <strong>Portrait</strong><br>Neon Warrior
        </div>
        <div class="suggestion-chip" onclick="setPrompt('Oil painting of a busy Lagos market in sunset colors')">
          <strong>Painting</strong><br>Lagos Market
        </div>
        <div class="suggestion-chip" onclick="setPrompt('Abstract patterns inspired by Kente cloth textures')">
          <strong>Pattern</strong><br>Modern Kente
        </div>
      </div>
    </div>

    <div class="chat-container" id="chatContainer"></div>
  </main>

  <footer class="input-bar">
    <div class="input-box">
      <input type="text" class="chat-input" id="userInput" placeholder="What do you see?..." />
      <button class="send-btn" id="sendBtn">
        <span class="material-symbols-rounded">arrow_upward</span>
      </button>
    </div>
  </footer>

  <!-- Upload Progress Indicator -->
  <div class="upload-progress" id="uploadProgress">
    <div style="display:flex; align-items:center; gap:12px;">
      <span class="material-symbols-rounded" style="color:#6366F1;">cloud_upload</span>
      <div style="flex:1;">
        <div style="font-weight:600; font-size:0.95rem;">Posting to Vynix...</div>
        <div style="font-size:0.85rem; color:var(--text-secondary);" id="uploadStatus">Uploading image</div>
      </div>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <!-- Login Prompt -->
  <div class="login-prompt" id="loginPrompt">
    <div class="login-box">
      <span class="material-symbols-rounded" style="font-size:48px; color:#6366F1; margin-bottom:16px;">login</span>
      <h3>Sign in Required</h3>
      <p>Please sign in to Vynix to post your AI-generated artwork to your feed.</p>
      <button class="login-btn" onclick="redirectToLogin()">Go to Vynix Login</button>
      <button onclick="closeLoginPrompt()" style="margin-top:12px; background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:0.9rem;">Cancel</button>
    </div>
  </div>

  <script>
    // --- CORE CONFIGURATION ---
    const API_BASE = "https://api.x.ai/v1";
    let XAI_API_KEY = "";
    
    // Firebase Config (Same as Vynix)
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    // Cloudinary Config (Same as Vynix)
    const CLOUD_NAME = "dqkujefxj";
    const UPLOAD_PRESET = "banter_box";

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const remoteConfig = firebase.remoteConfig();
    const auth = firebase.auth();
    const db = firebase.database();
    
    remoteConfig.settings.minimumFetchIntervalMillis = 0;

    let currentUser = null;
    let currentUsername = null;
    let generatedImages = new Map(); // Store generated images by message ID

    async function loadKey() {
      try {
        await remoteConfig.fetchAndActivate();
        XAI_API_KEY = remoteConfig.getValue('xai_api_key').asString();
      } catch (e) { console.error("Key Load Error", e); }
    }
    loadKey();

    // Auth State Listener
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        // Load user info from database
        const userRef = db.ref(`users/${user.uid}`);
        const snapshot = await userRef.once('value');
        if (snapshot.exists()) {
          const userData = snapshot.val();
          currentUsername = userData.username || userData.displayName || user.email?.split('@')[0];
        }
      } else {
        currentUser = null;
        currentUsername = null;
      }
    });

    const els = {
      welcome: document.getElementById('welcomeScreen'),
      chat: document.getElementById('chatContainer'),
      input: document.getElementById('userInput'),
      send: document.getElementById('sendBtn'),
      scroll: document.getElementById('mainScroll'),
      uploadProgress: document.getElementById('uploadProgress'),
      progressFill: document.getElementById('progressFill'),
      uploadStatus: document.getElementById('uploadStatus'),
      toast: document.getElementById('toast'),
      loginPrompt: document.getElementById('loginPrompt')
    };

    function resetChat() { location.reload(); }
    
    function activateChat() { 
      els.welcome.style.display = 'none'; 
      els.chat.style.display = 'flex'; 
    }
    
    function setPrompt(t) { 
      els.input.value = t; 
      handleSend(); 
    }

    function showToast(message, type = 'success') {
      els.toast.innerHTML = type === 'success' 
        ? `<span class="material-symbols-rounded">check_circle</span> ${message}`
        : `<span class="material-symbols-rounded">error</span> ${message}`;
      els.toast.className = `toast show ${type}`;
      setTimeout(() => els.toast.classList.remove('show'), 3000);
    }

    function updateProgress(percent, status) {
      els.progressFill.style.width = `${percent}%`;
      if (status) els.uploadStatus.textContent = status;
    }

    function showLoginPrompt() {
      els.loginPrompt.classList.add('show');
    }

    function closeLoginPrompt() {
      els.loginPrompt.classList.remove('show');
    }

    function redirectToLogin() {
      // Store current URL to return after login
      localStorage.setItem('ona_return_url', window.location.href);
      window.location.href = 'index.html'; // Vynix login page
    }

    function toggleProfile() {
      if (currentUser) {
        window.location.href = 'profile.html';
      } else {
        showLoginPrompt();
      }
    }

    // Convert data URL to Blob
    function dataURLtoBlob(dataurl) {
      const arr = dataurl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8arr], { type: mime });
    }

    // Fetch image as blob from URL
    async function fetchImageAsBlob(url) {
      const response = await fetch(url);
      return await response.blob();
    }

    // Upload image to Cloudinary
    async function uploadToCloudinary(blob, onProgress) {
      const formData = new FormData();
      formData.append('file', blob, 'ona-ai-generated.png');
      formData.append('upload_preset', UPLOAD_PRESET);

      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            onProgress(Math.round(percentComplete));
          }
        });

        xhr.addEventListener('load', () => {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            resolve(data.secure_url);
          } else {
            reject(new Error('Upload failed'));
          }
        });

        xhr.addEventListener('error', () => reject(new Error('Upload failed')));
        
        xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`);
        xhr.send(formData);
      });
    }

    // Post to Vynix Firebase
    async function postToVynix(imageUrl, prompt) {
      if (!currentUser) throw new Error('Not authenticated');

      const postData = {
        uid: currentUser.uid,
        username: currentUsername || 'Ona AI User',
        text: `ðŸŽ¨ Generated with Ona AI\n\n"${prompt}"\n\n#OnaAI #AIArt #AfricanArt`,
        mediaUrls: [imageUrl],
        mediaType: 'images',
        timestamp: Date.now(),
        likes: 0,
        commentCount: 0,
        reachCount: 0,
        repostCount: 0,
        isAIGenerated: true,
        aiPrompt: prompt
      };

      const newPostRef = db.ref('posts').push();
      await newPostRef.set(postData);
      
      return newPostRef.key;
    }

    // Handle Upload to Vynix
    async function handleUploadToVynix(messageId) {
      if (!currentUser) {
        showLoginPrompt();
        return;
      }

      const imageData = generatedImages.get(messageId);
      if (!imageData) {
        showToast('Image not found', 'error');
        return;
      }

      const uploadBtn = document.getElementById(`upload-btn-${messageId}`);
      if (uploadBtn) {
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = `<span class="material-symbols-rounded" style="font-size:18px;">hourglass_top</span> Uploading...`;
      }

      try {
        els.uploadProgress.classList.add('show');
        updateProgress(10, 'Preparing image...');

        // Fetch image as blob
        const blob = await fetchImageAsBlob(imageData.url);
        updateProgress(30, 'Uploading to cloud...');

        // Upload to Cloudinary with progress
        const imageUrl = await uploadToCloudinary(blob, (progress) => {
          updateProgress(30 + (progress * 0.5), 'Uploading to cloud...');
        });

        updateProgress(80, 'Posting to Vynix...');

        // Post to Vynix
        const postId = await postToVynix(imageUrl, imageData.prompt);
        
        updateProgress(100, 'Complete!');
        
        setTimeout(() => {
          els.uploadProgress.classList.remove('show');
          showToast('Posted to Vynix successfully!');
          
          // Update button state
          if (uploadBtn) {
            uploadBtn.innerHTML = `<span class="material-symbols-rounded" style="font-size:18px;">check</span> Posted`;
            uploadBtn.style.background = 'var(--success)';
          }
          
          // Option to view post
          setTimeout(() => {
            if (confirm('View your post on Vynix?')) {
              window.location.href = `index.html#post-${postId}`;
            }
          }, 500);
          
        }, 500);

      } catch (err) {
        console.error('Upload error:', err);
        els.uploadProgress.classList.remove('show');
        showToast('Failed to post: ' + err.message, 'error');
        
        if (uploadBtn) {
          uploadBtn.disabled = false;
          uploadBtn.innerHTML = `<span class="material-symbols-rounded" style="font-size:18px;">upload</span> Post to Vynix`;
        }
      }
    }

    // Download image
    async function handleDownload(url) {
      try {
        const response = await fetch(url);
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = `ona-ai-${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(downloadUrl);
        showToast('Image downloaded!');
      } catch (err) {
        showToast('Download failed', 'error');
      }
    }

    async function handleSend() {
      const prompt = els.input.value.trim();
      if (!prompt || !XAI_API_KEY) return;

      const messageId = Date.now().toString();
      
      activateChat();
      
      // Add user message
      const userBubble = document.createElement('div');
      userBubble.className = 'message-row user';
      userBubble.innerHTML = `<div class="msg-bubble user">${escapeHtml(prompt)}</div>`;
      els.chat.appendChild(userBubble);
      
      // Add loading indicator
      const loader = document.createElement('div');
      loader.className = 'message-row ai';
      loader.id = `loader-${messageId}`;
      loader.innerHTML = `
        <div class="msg-bubble ai" style="display:flex; align-items:center; gap:12px;">
          <div class="loader" style="padding:0;"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
          <span style="color:var(--text-secondary); font-size:0.9rem;">Creating your vision...</span>
        </div>
      `;
      els.chat.appendChild(loader);
      
      els.input.value = '';
      els.scroll.scrollTop = els.scroll.scrollHeight;
      els.send.disabled = true;

      try {
        const res = await fetch(`${API_BASE}/images/generations`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${XAI_API_KEY}`, 
            'Content-Type': 'application/json' 
          },
          body: JSON.stringify({
            model: "grok-imagine-image",
            prompt: prompt
          })
        });

        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        
        // Remove loader
        loader.remove();

        if (data.data && data.data[0].url) {
          const url = data.data[0].url;
          
          // Store image data
          generatedImages.set(messageId, { url, prompt });
          
          // Add AI response with image and actions
          const aiBubble = document.createElement('div');
          aiBubble.className = 'message-row ai';
          aiBubble.innerHTML = `
            <div class="msg-bubble ai">
              <div style="font-weight:600; margin-bottom:8px; color:var(--primary);">
                <span class="material-symbols-rounded" style="vertical-align:middle; margin-right:4px;">palette</span>
                Your vision is ready
              </div>
              <img src="${url}" class="generated-img" alt="Generated artwork" onclick="window.open('${url}')">
              <div class="image-actions">
                <button class="action-btn upload" id="upload-btn-${messageId}" onclick="handleUploadToVynix('${messageId}')">
                  <span class="material-symbols-rounded" style="font-size:18px;">upload</span>
                  Post to Vynix
                </button>
                <button class="action-btn download" onclick="handleDownload('${url}')">
                  <span class="material-symbols-rounded" style="font-size:18px;">download</span>
                  Download
                </button>
              </div>
            </div>
          `;
          els.chat.appendChild(aiBubble);
        }
      } catch (err) {
        loader.remove();
        const errorBubble = document.createElement('div');
        errorBubble.className = 'message-row ai';
        errorBubble.innerHTML = `
          <div class="msg-bubble ai" style="color:var(--danger); border-color:var(--danger);">
            <span class="material-symbols-rounded" style="vertical-align:middle; margin-right:4px;">error</span>
            Error: ${escapeHtml(err.message)}
          </div>
        `;
        els.chat.appendChild(errorBubble);
      } finally {
        els.send.disabled = false;
        els.scroll.scrollTop = els.scroll.scrollHeight;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    els.send.onclick = handleSend;
    els.input.onkeypress = e => { if(e.key==='Enter') handleSend(); };

    // Check for return from login
    if (localStorage.getItem('ona_return_url')) {
      localStorage.removeItem('ona_return_url');
      showToast('Welcome back! You can now post to Vynix.', 'success');
    }
  </script>
</body>
</html>
