<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Chat - Vynix</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
  <style>
    :root {
      --banter-blue: #1DA1F2;
      --banter-purple: #8A3FFC;
      --banter-accent: #FF2D55;
      --text-dark: #1A202C;
      --text-light: #718096;
      --border: #E2E8F0;
      --white: #FFFFFF;
      --background: #F7FAFC;
      --dark-bg: #1A202C;
      --dark-border: #2D3748;
      --dark-text: #E2E8F0;
      --input-bg-light: linear-gradient(180deg, #FFFFFF 0%, #F1F5F9 100%);
      --input-bg-dark: linear-gradient(180deg, #2D3748 0%, #1A202C 100%);
    }

    [data-theme="dark"] {
      --text-dark: var(--dark-text);
      --border: var(--dark-border);
      --white: var(--dark-bg);
      --background: #2D3748;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--background);
      color: var(--text-dark);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      transition: background 0.3s ease, color 0.3s ease;
    }

    body.fade-out {
      opacity: 0;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      position: relative;
    }

    .top-buttons {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
      z-index: 1000;
    }

    .settings-btn, .delete-chat-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
    }

    .settings-btn svg, .delete-chat-btn svg {
      width: 24px;
      height: 24px;
      stroke: var(--text-light);
      transition: stroke 0.2s ease;
    }

    .settings-btn:hover svg {
      stroke: var(--banter-purple);
    }

    .delete-chat-btn:hover svg {
      stroke: var(--banter-accent);
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .loading-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid transparent;
      border-top-color: var(--banter-blue);
      border-right-color: var(--banter-purple);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .spinner-text {
      color: var(--white);
      font-size: 0.9rem;
      font-weight: 500;
      margin-top: 0.75rem;
      letter-spacing: 0.05em;
    }

    .ai-chat {
      flex: 1;
      display: flex;
      flex-direction: column-reverse;
      gap: 1rem;
      padding-bottom: 1.5rem;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .chat-message {
      display: flex;
      flex-direction: column;
      max-width: 85%;
      padding: 1rem 1.25rem;
      border-radius: 20px;
      background: var(--white);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.4s ease-out;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .chat-message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--banter-blue) 0%, #4da8f7 100%);
      color: var(--white);
    }

    .chat-message.ai {
      align-self: flex-start;
      background: linear-gradient(135deg, var(--banter-purple) 0%, #a675fc 100%);
      color: var(--white);
    }

    .chat-message:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    .chat-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .chat-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--text-light);
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 600;
    }

    .chat-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .chat-username {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .chat-timestamp {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .chat-content {
      font-size: 1rem;
      line-height: 1.5;
      word-break: break-word;
    }

    .ai-compose {
      position: sticky;
      bottom: 1.5rem;
      margin: 0 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--input-bg-light);
      border-radius: 30px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      transition: box-shadow 0.3s ease, transform 0.3s ease;
      padding: 0.5rem 0.25rem;
    }

    [data-theme="dark"] .ai-compose {
      background: var(--input-bg-dark);
    }

    .ai-compose:hover {
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      transform: translateY(-2px);
    }

    .message-input {
      flex: 1;
      width: 100%;
      padding: 0.75rem 0;
      border: none;
      border-radius: 30px;
      font-size: 1.05rem;
      line-height: 1.4;
      color: var(--text-dark);
      background: transparent;
      outline: none;
      box-sizing: border-box;
    }

    .message-input:focus {
      border: none;
      outline: none;
      box-shadow: inset 0 0 8px rgba(29, 161, 242, 0.2);
    }

    .message-input:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .message-input::placeholder {
      color: var(--text-light);
      font-style: italic;
      padding-left: 0.75rem;
    }

    .send-button {
      background: linear-gradient(135deg, var(--banter-blue) 0%, var(--banter-purple) 100%);
      border: none;
      padding: 0.85rem;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.2s ease;
      border-radius: 50%;
      display: flex;
      align-items: center;
      margin-left: 0.25rem;
    }

    .send-button.active {
      opacity: 1;
      transform: scale(1.1);
    }

    .send-button svg {
      width: 26px;
      height: 26px;
      stroke: var(--white);
      stroke-width: 2;
    }

    .send-button:hover {
      transform: scale(1.15) rotate(5deg);
    }

    .send-button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
      transform: scale(1);
    }

    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding: 0 1rem;
    }

    .suggestion-btn {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      color: var(--text-dark);
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .suggestion-btn:hover {
      background: var(--banter-blue);
      color: var(--white);
      transform: translateY(-2px);
    }

    .custom-alert {
      display: none;
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--white);
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1001;
      color: var(--text-dark);
      font-weight: 500;
      text-align: center;
      max-width: 90%;
      width: 320px;
      animation: fadeIn 0.3s ease-out forwards;
    }

    .custom-alert.active {
      display: block;
    }

    .custom-alert .close-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      width: 20px;
      height: 20px;
      background: none;
      border: none;
      cursor: pointer;
    }

    .custom-alert .close-btn svg {
      width: 100%;
      height: 100%;
      stroke: var(--text-dark);
      stroke-width: 2;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    @media (max-width: 640px) {
      .container {
        padding: 0.75rem;
      }

      .chat-message {
        max-width: 90%;
        padding: 0.75rem 1rem;
      }

      .chat-avatar {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
      }

      .chat-username {
        font-size: 0.9rem;
      }

      .chat-timestamp {
        font-size: 0.75rem;
      }

      .chat-content {
        font-size: 0.95rem;
      }

      .ai-compose {
        margin: 0 0.75rem;
        padding: 0.25rem;
      }

      .message-input {
        font-size: 0.95rem;
        padding: 0.5rem 0;
      }

      .message-input::placeholder {
        padding-left: 0.5rem;
      }

      .send-button {
        padding: 0.65rem;
        margin-left: 0.25rem;
      }

      .send-button svg {
        width: 22px;
        height: 22px;
      }

      .suggestion-btn {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-buttons">
      <button class="delete-chat-btn" aria-label="Delete chat history" onclick="deleteChat()">
        <svg viewBox="0 0 24 24">
          <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
        </svg>
      </button>
      <button class="settings-btn" aria-label="Toggle settings" onclick="toggleTheme()">
        <svg viewBox="0 0 24 24">
          <path d="M19.14 12.94c.04-.3.06-.61.06-.94s-.02-.64-.06-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.49.49 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.49.49 0 0 0-.48-.41h-3.84a.49.49 0 0 0-.48.41l-.36 2.54c-.59.24-1.13-.56-1.62.94l-2.39-.96a.49.49 0 0 0-.59.22L2.86 9.41a.49.49 0 0 0 .12.61l2.03 1.58a2.66 2.66 0 0 0 0 1.88l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32a.49.49 0 0 0 .59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54a.49.49 0 0 0 .48.41h3.84a.49.49 0 0 0 .48-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96a.49.49 0 0 0 .59-.22l1.92-3.32a.49.49 0 0 0-.12-.61l-2.03-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
        </svg>
      </button>
    </div>
    <div class="custom-alert" id="alert">
      <span id="alert-message"></span>
      <button class="close-btn" aria-label="Close alert">
        <svg viewBox="0 0 24 24">
          <path d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="loading-overlay" id="loading-overlay">
      <div class="spinner"></div>
      <span class="spinner-text">Vynix is thinking...</span>
    </div>
    <div class="suggestions" id="suggestions">
      <button class="suggestion-btn" onclick="setPrompt('Tell me a joke!')">Tell me a joke!</button>
      <button class="suggestion-btn" onclick="setPrompt('What’s a fun fact?')">What’s a fun fact?</button>
      <button class="suggestion-btn" onclick="setPrompt('Why is Vynix awesome?')">Why is Vynix awesome?</button>
    </div>
    <div class="ai-chat" id="ai-chat"></div>
    <div class="ai-compose">
      <input type="text" class="message-input" id="message-input" placeholder="Type a message..." aria-label="Type a message" />
      <button type="submit" class="send-button" id="send-button">
        <svg viewBox="0 0 24 24">
          <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
        </svg>
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getDatabase, ref, push, get, set } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
    import * as tf from 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.firebasestorage.app",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const messageInput = document.getElementById("message-input");
    const sendButton = document.getElementById("send-button");
    const aiChat = document.getElementById("ai-chat");
    const alert = document.getElementById("alert");
    const alertMessage = document.getElementById("alert-message");
    const loadingOverlay = document.getElementById("loading-overlay");
    let currentUser = null;

    // LSTM model parameters
    let model = null;
    const vocab = "abcdefghijklmnopqrstuvwxyz .,!?";
    const vocabSize = vocab.length;
    const charToIndex = Object.fromEntries([...vocab].map((char, i) => [char, i]));
    const indexToChar = Object.fromEntries([...vocab].map((char, i) => [i, char]));
    const sequenceLength = 40;
    const hiddenSize = 128;
    let chatHistory = [];

    // Initial corpus for pre-training
    const initialCorpus = [
      "Hey there! I'm Vynix, your go-to AI for witty banter and spicy answers!",
      "What's the vibe today? Ask me something fun, and I'll keep it lively!",
      "Why did the computer go to art school? It wanted to draw a better 'byte'!",
      "Got a question? I'm all code and no nonsense, with a dash of humor!",
      "Life’s too short for dull chats. Hit me with your spiciest question!",
      "Why is Vynix awesome? Because I mix brains with a pinch of sass!",
      "Fun fact: The shortest war in history lasted 38 minutes. Bet I can answer faster!",
      "Want a joke? Why did the scarecrow become a motivational speaker? He was outstanding in his field!",
      "Vynix here, ready to serve answers with a side of wit. What's up?",
      "Ask me anything, and I’ll make sure it’s a conversation worth screenshotting!"
    ];

    // Scroll to the bottom of the chat
    function scrollToBottom() {
      console.log("Scrolling to bottom of ai-chat");
      aiChat.scrollTo({ top: aiChat.scrollHeight, behavior: 'smooth' });
    }

    // Create LSTM model
    function createModel() {
      const model = tf.sequential();
      model.add(tf.layers.lstm({
        units: hiddenSize,
        inputShape: [sequenceLength, vocabSize],
        returnSequences: false
      }));
      model.add(tf.layers.dense({ units: vocabSize, activation: 'softmax' }));
      model.compile({
        optimizer: tf.train.adam(0.01),
        loss: 'categoricalCrossentropy'
      });
      console.log("LSTM model created");
      return model;
    }

    // Convert text to sequences for training
    function textToSequences(text) {
      const sequences = [];
      const nextChars = [];
      text = text.toLowerCase();
      for (let i = 0; i < text.length - sequenceLength; i++) {
        const seq = text.slice(i, i + sequenceLength);
        const nextChar = text[i + sequenceLength] || ' ';
        if (seq.length === sequenceLength && vocab.includes(nextChar)) {
          const inputSeq = Array(sequenceLength).fill(0).map((_, j) => {
            const char = seq[j] || ' ';
            return charToIndex[char] !== undefined ? charToIndex[char] : charToIndex[' '];
          });
          const outputChar = charToIndex[nextChar] !== undefined ? charToIndex[nextChar] : charToIndex[' '];
          sequences.push(inputSeq);
          nextChars.push(outputChar);
        }
      }
      return [sequences, nextChars];
    }

    // One-hot encode sequences
    function oneHotEncode(sequences, nextChars) {
      const xs = tf.tensor3d(sequences.map(seq =>
        seq.map(idx => Array(vocabSize).fill(0).map((_, i) => i === idx ? 1 : 0))
      ), [sequences.length, sequenceLength, vocabSize]);
      const ys = tf.tensor2d(nextChars.map(idx =>
        Array(vocabSize).fill(0).map((_, i) => i === idx ? 1 : 0)
      ), [nextChars.length, vocabSize]);
      return [xs, ys];
    }

    // Train LSTM model
    async function trainModel(texts) {
      console.log("Training LSTM model...");
      showLoading();
      try {
        const allText = texts.join(' ');
        const [sequences, nextChars] = textToSequences(allText);
        if (sequences.length === 0) {
          console.log("No valid sequences for training");
          return;
        }
        const [xs, ys] = oneHotEncode(sequences, nextChars);
        await model.fit(xs, ys, {
          epochs: 10,
          batchSize: 32,
          callbacks: {
            onEpochEnd: (epoch, logs) => console.log(`Epoch ${epoch + 1}: loss = ${logs.loss}`)
          }
        });
        xs.dispose();
        ys.dispose();
        console.log("Model training complete");
      } catch (error) {
        console.error("Training error:", error);
        showAlert(`Failed to train Vynix: ${error.message}`, false);
      } finally {
        hideLoading();
      }
    }

    // Generate response using LSTM
    async function generateResponse(prompt) {
      console.log("Generating response for prompt:", prompt);
      if (!model) {
        return "Vynix says: I'm still warming up! Try again soon.";
      }
      let inputText = prompt.toLowerCase().slice(-sequenceLength);
      let response = [];
      const temperature = 0.7; // Controls randomness

      for (let i = 0; i < 50; i++) {
        const inputSeq = Array(sequenceLength).fill(0).map((_, j) => {
          const char = inputText[j] || ' ';
          return charToIndex[char] !== undefined ? charToIndex[char] : charToIndex[' '];
        });
        const inputTensor = tf.tensor3d([inputSeq.map(idx =>
          Array(vocabSize).fill(0).map((_, i) => i === idx ? 1 : 0)
        )], [1, sequenceLength, vocabSize]);
        const prediction = model.predict(inputTensor);
        const probs = prediction.dataSync();
        prediction.dispose();
        inputTensor.dispose();

        // Sample next character with temperature
        let sum = 0;
        const scaledProbs = probs.map(p => Math.exp(Math.log(p) / temperature));
        const probSum = scaledProbs.reduce((a, b) => a + b, 0);
        const normalizedProbs = scaledProbs.map(p => p / probSum);
        const rand = Math.random();
        let nextCharIndex = 0;
        for (let j = 0; j < normalizedProbs.length; j++) {
          sum += normalizedProbs[j];
          if (rand <= sum) {
            nextCharIndex = j;
            break;
          }
        }

        const nextChar = indexToChar[nextCharIndex];
        response.push(nextChar);
        inputText = inputText.slice(1) + nextChar;

        if (nextChar === '.' || nextChar === '!') break;
      }

      const generated = response.join('').trim() || "Vynix says: Let's spice things up!";
      return generated.charAt(0).toUpperCase() + generated.slice(1) + "!";
    }

    // Initialize model with Firebase data or initial corpus
    async function initializeModel() {
      if (!currentUser) return;
      showLoading();
      try {
        model = createModel();
        const chatRef = ref(db, `users/${currentUser.uid}/ai_chat`);
        const snapshot = await get(chatRef);
        const messages = snapshot.val();
        let texts = initialCorpus;
        chatHistory = [];

        if (messages) {
          const sortedMessages = Object.values(messages).sort((a, b) => a.createdAt - b.createdAt);
          texts = texts.concat(sortedMessages.map(msg => msg.text));
          chatHistory = sortedMessages;
        }

        await trainModel(texts);
        showAlert("Vynix is ready to chat!", true);
      } catch (error) {
        console.error("Error initializing model:", error);
        showAlert(`Failed to initialize Vynix: ${error.message}`, false);
        await trainModel(initialCorpus);
      } finally {
        hideLoading();
      }
    }

    // Delete chat history from Firebase
    async function deleteChat() {
      if (!currentUser || currentUser.isGuest) {
        showAlert("Guests can't delete chat history.", false);
        console.log("Delete attempt blocked: User is guest or not authenticated");
        return;
      }

      if (!confirm("Are you sure you want to delete your chat history? This cannot be undone.")) {
        console.log("Chat deletion cancelled by user");
        showAlert("Chat deletion cancelled.", false);
        return;
      }

      showLoading();
      try {
        const chatRef = ref(db, `users/${currentUser.uid}/ai_chat`);
        const snapshot = await get(chatRef);
        if (!snapshot.exists()) {
          showAlert("No chat history to delete.", false);
          console.log("No chat history found in Firebase");
          aiChat.innerHTML = "";
          chatHistory = [];
          await trainModel(initialCorpus);
          hideLoading();
          return;
        }

        console.log("Deleting chat history from Firebase at:", chatRef.toString());
        await set(chatRef, null); // Clear chat history in Firebase
        aiChat.innerHTML = ""; // Clear UI
        chatHistory = []; // Clear local chat history
        model = createModel(); // Reset model
        await trainModel(initialCorpus); // Retrain with initial corpus
        showAlert("Chat history deleted!", true);
        console.log("Chat history deleted successfully from Firebase");
      } catch (error) {
        console.error("Error deleting chat history from Firebase:", error);
        showAlert(`Failed to delete chat history: ${error.message}`, false);
      } finally {
        hideLoading();
      }
    }

    function showLoading() {
      console.log("Showing loading overlay");
      loadingOverlay.classList.add("active");
    }

    function hideLoading() {
      console.log("Hiding loading overlay");
      loadingOverlay.classList.remove("active");
    }

    function showAlert(message, isSuccess) {
      console.log("Showing alert:", message);
      alertMessage.textContent = message;
      alert.style.background = isSuccess ? "rgba(29, 161, 242, 0.1)" : "rgba(255, 0, 0, 0.1)";
      alert.classList.add("active");
      setTimeout(() => alert.classList.remove("active"), 3000);
    }

    function formatTimestamp(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      if (days > 0) return `${days}d`;
      if (hours > 0) return `${hours}h`;
      if (minutes > 0) return `${minutes}m`;
      return `${seconds}s`;
    }

    function getAvatarInitials(username) {
      return username ? username.charAt(0).toUpperCase() : "V";
    }

    function renderMessage(messageData, isUser, userData = null) {
      console.log("Rendering message:", messageData);
      const messageDiv = document.createElement("div");
      messageDiv.className = `chat-message ${isUser ? "user" : "ai"}`;
      messageDiv.tabIndex = 0;
      const username = isUser ? (userData?.username || "Anonymous") : "Vynix";
      const profilePicture = isUser ? userData?.profilePicture : null;
      messageDiv.innerHTML = `
        <div class="chat-header">
          <div class="chat-avatar">${profilePicture ? `<img src="${profilePicture}" alt="${username}'s profile picture" />` : getAvatarInitials(username)}</div>
          <div class="chat-username">${username}</div>
          <span class="chat-timestamp">${formatTimestamp(messageData.createdAt)}</span>
        </div>
        <div class="chat-content">${messageData.text}</div>
      `;
      aiChat.prepend(messageDiv);
      scrollToBottom(); // Scroll to bottom after rendering
    }

    async function sendMessage() {
      const inputText = messageInput.value.trim();
      if (!inputText) {
        console.log("No input text, skipping send");
        return;
      }
      if (currentUser && currentUser.isGuest) {
        showAlert("Guests can't chat with Vynix.", false);
        return;
      }

      showLoading();
      try {
        const userRef = ref(db, `users/${auth.currentUser.uid}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val() || {};

        const userMessage = {
          text: inputText,
          createdAt: Date.now(),
          isUser: true
        };
        console.log("Saving user message to Firebase:", userMessage);
        await push(ref(db, `users/${auth.currentUser.uid}/ai_chat`), userMessage);
        renderMessage(userMessage, true, userData);
        chatHistory.push(userMessage);

        // Generate AI response
        const aiResponseText = await generateResponse(inputText);
        const aiMessage = {
          text: aiResponseText,
          createdAt: Date.now(),
          isUser: false
        };
        console.log("Saving AI message to Firebase:", aiMessage);
        await push(ref(db, `users/${auth.currentUser.uid}/ai_chat`), aiMessage);
        renderMessage(aiMessage, false);
        chatHistory.push(aiMessage);

        // Retrain model with new messages (limited to last 5 for performance)
        const recentMessages = chatHistory.slice(-5).map(msg => msg.text);
        await trainModel(recentMessages);

        messageInput.value = "";
        sendButton.classList.remove("active");
        sendButton.disabled = true;
        showAlert("Vynix has spoken!", true);
      } catch (error) {
        console.error("Send message error:", error);
        showAlert(`Failed to process message: ${error.message}`, false);
      } finally {
        hideLoading();
      }
    }

    function toggleTheme() {
      const isDark = document.documentElement.getAttribute("data-theme") === "dark";
      document.documentElement.setAttribute("data-theme", isDark ? "light" : "dark");
      console.log("Toggled theme to:", isDark ? "light" : "dark");
    }

    function setPrompt(prompt) {
      messageInput.value = prompt;
      sendButton.disabled = !prompt.trim() || (currentUser && currentUser.isGuest);
      sendButton.classList.toggle("active", prompt.trim() && !(currentUser && currentUser.isGuest));
      messageInput.focus();
    }

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        console.log("No user authenticated, redirecting to signup");
        document.body.classList.add("fade-out");
        setTimeout(() => {
          window.location.href = "signup.html";
        }, 1500);
        return;
      }

      currentUser = user;
      showLoading();
      const userRef = ref(db, `users/${user.uid}`);
      get(userRef).then((snapshot) => {
        const userData = snapshot.val() || {};
        const isGuest = userData.isGuest || false;
        user.isGuest = isGuest;
        messageInput.disabled = isGuest;
        sendButton.disabled = isGuest || !messageInput.value.trim();
        messageInput.placeholder = isGuest ? "Guests can't chat with Vynix." : "Type a message...";
        console.log("User data loaded:", userData, "Is guest:", isGuest);

        // Load chat history and initialize model
        const chatRef = ref(db, `users/${user.uid}/ai_chat`);
        get(chatRef).then((snapshot) => {
          aiChat.innerHTML = "";
          const messages = snapshot.val();
          if (messages) {
            const sortedMessages = Object.values(messages).sort((a, b) => a.createdAt - b.createdAt);
            sortedMessages.forEach((message) => {
              renderMessage(message, message.isUser, userData);
            });
            chatHistory = sortedMessages;
            scrollToBottom(); // Scroll to bottom after loading history
          }
          initializeModel();
        }).catch((error) => {
          console.error("Error loading chat history:", error);
          showAlert(`Failed to load chat history: ${error.message}`, false);
          initializeModel();
        });
      }).catch((error) => {
        console.error("Error loading user data:", error);
        showAlert(`Failed to load user data: ${error.message}`, false);
        initializeModel();
      });
    });

    messageInput.addEventListener("input", () => {
      console.log("Input event triggered, text:", messageInput.value);
      sendButton.disabled = !messageInput.value.trim() || (currentUser && currentUser.isGuest);
      sendButton.classList.toggle("active", messageInput.value.trim() && !(currentUser && currentUser.isGuest));
    });

    messageInput.addEventListener("keypress", async (e) => {
      if (e.key === "Enter") {
        console.log("Enter key pressed");
        e.preventDefault();
        await sendMessage();
      }
    });

    sendButton.addEventListener("click", async () => {
      console.log("Send button clicked");
      await sendMessage();
    });
  </script>
</body>
</html>
