<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BanterBox - Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      touch-action: manipulation;
    }
    body {
      font-family: 'Inter', 'Segoe UI', sans-serif;
      background: #f3f2ef;
      transition: background 0.3s ease;
      margin: 0;
      padding-bottom: 80px;
    }
    body.dark {
      background: #0b141a;
    }
    .header {
      background: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
    }
    .header.dark {
      background: #1f2a44;
      border-bottom: 1px solid #2a3b47;
      color: #e5e7eb;
    }
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 64px);
      max-width: 800px;
      margin: 64px auto 0;
    }
    .chat-header {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      background: white;
    }
    .chat-header.dark {
      background: #1f2a44;
      color: #e5e7eb;
    }
    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 9999px;
      object-fit: cover;
      border: 2px solid transparent;
      background: linear-gradient(to right, #ef4444, #f97316);
      padding: 2px;
      margin-right: 0.75rem;
    }
    .chat-info {
      flex-grow: 1;
    }
    .chat-info h4 {
      font-weight: 700;
      font-size: 1rem;
      color: #111827;
    }
    .chat-info.dark h4 {
      color: #e5e7eb;
    }
    .chat-status {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .chat-status.dark {
      color: #9ca3af;
    }
    .status-dot {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid white;
      background: #6b7280;
    }
    .status-dot.online {
      background: #22c55e;
    }
    .status-dot.dark {
      border-color: #1f2a44;
    }
    .chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAFUlEQVR4AWP4z8Dwn4E5DAwMDOoBAM6uAYvD2MppAAAAAElFTkSuQmCC') repeat;
    }
    .chat-messages.dark {
      background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAFUlEQVR4AWPo5+fg/38G5jAwMDAwEQA6uwZpfO9k8QAAAABJRU5ErkJggg==') repeat;
    }
    .message {
      max-width: 70%;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      font-size: 0.9rem;
      line-height: 1.4;
      position: relative;
      margin-bottom: 1rem;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    .message.sent {
      background: #ef4444;
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 2px;
    }
    .message.received {
      background: #ffffff;
      color: #111827;
      margin-right: auto;
      border-bottom-left-radius: 2px;
    }
    .message.dark.sent {
      background: #dc2626;
    }
    .message.dark.received {
      background: #2a3b47;
      color: #e5e7eb;
    }
    .message-time {
      font-size: 0.65rem;
      color: #d1d5db;
      position: absolute;
      bottom: -1rem;
      right: 0.5rem;
      opacity: 0.8;
    }
    .message.received .message-time {
      color: #6b7280;
      left: 0.5rem;
    }
    .message.dark.received .message-time {
      color: #9ca3af;
    }
    .chat-input-container {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      background: white;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-width: 800px;
      margin: 0 auto;
      border-top: 1px solid #e5e7eb;
    }
    .chat-input-container.dark {
      background: #1f2a44;
      border-top: 1px solid #2a3b47;
    }
    .chat-input {
      flex-grow: 1;
      padding: 0.5rem 0.75rem;
      border: none;
      border-radius: 9999px;
      font-size: 0.9rem;
      background: #e5e7eb;
      outline: none;
      transition: background 0.2s ease;
    }
    .chat-input:focus {
      background: #d1d5db;
    }
    .chat-input.dark {
      background: #2a3b47;
      color: #e5e7eb;
    }
    .chat-input.dark:focus {
      background: #3b4b5c;
    }
    .send-btn {
      margin-left: 0.5rem;
      width: 40px;
      height: 40px;
      background: #ef4444;
      color: white;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .send-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }
    .send-btn.dark {
      background: #dc2626;
    }
    .send-btn.dark:hover {
      background: #b91c1c;
    }
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .back-btn {
      color: #6b7280;
      cursor: pointer;
      transition: color 0.2s ease;
      margin-right: 0.75rem;
    }
    .back-btn:hover {
      color: #ef4444;
    }
    .back-btn.dark {
      color: #9ca3af;
    }
    .back-btn.dark:hover {
      color: #dc2626;
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading-overlay">
    <svg class="animate-spin h-8 w-8 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 00-8 8h4z"/>
    </svg>
  </div>

  <header class="header dark:header">
    <div class="chat-header dark:chat-header">
      <svg class="back-btn dark:back-btn" id="back-btn" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      <div class="relative">
        <img id="chat-avatar" src="https://www.gravatar.com/avatar?d=mp" alt="User avatar" class="chat-avatar" />
        <span id="status-dot" class="status-dot"></span>
      </div>
      <div class="chat-info dark:chat-info">
        <h4 id="chat-username">User</h4>
        <p id="chat-status" class="chat-status dark:chat-status">Offline</p>
      </div>
    </div>
  </header>

  <div class="chat-container">
    <div id="messages-list" class="chat-messages dark:chat-messages" aria-live="polite" aria-relevant="additions"></div>
    <div class="chat-input-container dark:chat-input-container">
      <input id="chat-input" type="text" placeholder="Type a message..." class="chat-input dark:chat-input" />
      <button id="send-btn" class="send-btn dark:send-btn" aria-label="Send message">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
        </svg>
      </button>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  import { getDatabase, ref, onValue, set, push, get, update, onDisconnect } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
    authDomain: "fire-b-a8878.firebaseapp.com",
    databaseURL: "https://fire-b-a8878.firebaseio.com",
    projectId: "fire-b-a8878",
    storageBucket: "fire-b-a8878.appspot.com",
    messagingSenderId: "658673187627",
    appId: "1:658673187627:web:6e4c29af661785f0afa36e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getDatabase();

  const loadingOverlay = document.getElementById("loading-overlay");
  const backBtn = document.getElementById("back-btn");
  const chatAvatar = document.getElementById("chat-avatar");
  const statusDot = document.getElementById("status-dot");
  const chatUsername = document.getElementById("chat-username");
  const chatStatus = document.getElementById("chat-status");
  const messagesList = document.getElementById("messages-list");
  const chatInput = document.getElementById("chat-input");
  const sendBtn = document.getElementById("send-btn");

  let currentUserUid = null;
  let otherUserUid = null;
  let chatId = null;

  function showLoading() { loadingOverlay.classList.remove("hidden"); }
  function hideLoading() { loadingOverlay.classList.add("hidden"); }

  function applyTheme(themeValue) {
    const isDark = themeValue === 'dark';
    document.body.classList.toggle('dark', isDark);
    document.querySelector('.header').classList.toggle('dark', isDark);
    document.querySelector('.chat-header').classList.toggle('dark', isDark);
    document.querySelector('.chat-input-container').classList.toggle('dark', isDark);
    document.querySelector('.chat-messages').classList.toggle('dark', isDark);
    document.querySelectorAll('.chat-info, .chat-status, .message, .status-dot, .send-btn, .chat-input, .back-btn').forEach(el => el.classList.toggle('dark', isDark));
  }

  function timeAgo(timestamp) {
    if (!timestamp) return "";
    const now = Date.now();
    const diff = now - timestamp;
    if (diff < 60000) return "just now";
    if (diff < 3600000) return Math.floor(diff / 60000) + "m ago";
    if (diff < 86400000) return Math.floor(diff / 3600000) + "h ago";
    return Math.floor(diff / 86400000) + "d ago";
  }

  onAuthStateChanged(auth, async user => {
    if (!user) {
      location.href = "signup.html";
      return;
    }
    currentUserUid = user.uid;
    showLoading();

    try {
      const userRef = ref(db, `users/${user.uid}`);
      await onDisconnect(userRef).update({
        presence: 'offline',
        lastSeen: Date.now()
      });
      await update(userRef, {
        presence: 'online',
        lastSeen: Date.now()
      });

      const snap = await get(ref(db, `users/${user.uid}/settings`));
      const settings = snap.val() || {};
      applyTheme(settings.theme || 'light');

      const urlParams = new URLSearchParams(window.location.search);
      otherUserUid = urlParams.get('uid');
      if (!otherUserUid) {
        alert("No user selected for chat.");
        location.href = "friends.html";
        return;
      }

      await loadChat(user.uid, otherUserUid);
    } catch (error) {
      console.error('Error initializing chat:', error);
      hideLoading();
    }
  });

  async function loadChat(currentUid, otherUid) {
    try {
      chatId = currentUid < otherUid ? `${currentUid}_${otherUid}` : `${otherUid}_${currentUid}`;
      const userRef = ref(db, `users/${otherUid}`);
      const userSnap = await get(userRef);
      if (!userSnap.exists()) {
        alert("User not found.");
        location.href = "friends.html";
        return;
      }

      const userData = userSnap.val();
      chatAvatar.src = userData.photoURL || 'https://www.gravatar.com/avatar?d=mp';
      chatUsername.textContent = userData.name || 'User';
      const isOnline = userData.presence === 'online';
      chatStatus.textContent = isOnline ? 'Online' : `Last seen ${timeAgo(userData.lastSeen)}`;
      statusDot.classList.toggle('online', isOnline);

      onValue(userRef, (snap) => {
        if (snap.exists()) {
          const data = snap.val();
          const isOnline = data.presence === 'online';
          chatStatus.textContent = isOnline ? 'Online' : `Last seen ${timeAgo(data.lastSeen)}`;
          statusDot.classList.toggle('online', isDark);
        }
      });

      const chatRef = ref(db, `chats/${chatId}`);
      const chatSnap = await get(chatRef);
      if (!chatSnap.exists()) {
        await set(chatRef, {
          participants: {
            [currentUid]: true,
            [otherUid]: true
          },
          createdAt: Date.now()
        });
      }

      const messagesRef = ref(db, `messages/${chatId}`);
      onValue(messagesRef, (messagesSnap) => {
        messagesList.innerHTML = '';
        if (!messagesSnap.exists()) {
          hideLoading();
          return;
        }

        const messages = messagesSnap.val();
        const sortedMessages = Object.entries(messages).sort((a, b) => (a[1].timestamp || 0) - (b[1].timestamp || 0));

        sortedMessages.forEach(([mid, message]) => {
          const messageElement = renderMessage(mid, message, currentUid);
          messagesList.appendChild(messageElement);

          if (message.sender !== currentUid && !message.read) {
            update(ref(db, `messages/${chatId}/${mid}`), { read: true });
          }
        });

        messagesList.scrollTop = messagesList.scrollHeight;
        hideLoading();
      }, (error) => {
        console.error('Error loading messages:', error);
        hideLoading();
      });
    } catch (error) {
      console.error('Error loading chat:', error);
      hideLoading();
    }
  }

  function renderMessage(mid, message, currentUid) {
    const isSent = message.sender === currentUid;
    const div = document.createElement('div');
    div.className = `message ${isSent ? 'sent' : 'received'} dark:${isSent ? 'sent' : 'received'}`;
    div.dataset.mid = mid;
    div.innerHTML = `
      <p>${message.text}</p>
      <span class="message-time dark:${isSent ? '' : 'received'}">${timeAgo(message.timestamp)}</span>
    `;
    return div;
  }

  sendBtn.addEventListener('click', async () => {
    if (!chatInput.value.trim() || !chatId) return;
    try {
      const messageRef = push(ref(db, `messages/${chatId}`));
      await set(messageRef, {
        sender: currentUserUid,
        text: chatInput.value.trim(),
        timestamp: Date.now(),
        read: false
      });
      chatInput.value = '';
      messagesList.scrollTop = messagesList.scrollHeight;
    } catch (error) {
      console.error('Error sending message:', error);
    }
  });

  chatInput.addEventListener('keypress', async (e) => {
    if (e.key === 'Enter' && chatInput.value.trim() && chatId) {
      e.preventDefault();
      try {
        const messageRef = push(ref(db, `messages/${chatId}`));
        await set(messageRef, {
          sender: currentUserUid,
          text: chatInput.value.trim(),
          timestamp: Date.now(),
          read: false
        });
        chatInput.value = '';
        messagesList.scrollTop = messagesList.scrollHeight;
      } catch (error) {
        console.error('Error sending message:', error);
      }
    }
  });

  backBtn.addEventListener('click', () => {
    window.location.href = 'friends.html';
  });

</script>
</body>
</html>
