<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BanterBox - Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary: #ef4444;
      --primary-dark: #dc2626;
      --bg-light: #f9f9f9;
      --bg-dark: #1f2937;
      --card-light: #ffffff;
      --card-dark: #374151;
      --text-light: #111827;
      --text-dark: #e5e7eb;
      --muted-light: #6b7280;
      --muted-dark: #9ca3af;
      --border-light: #d1d5db;
      --border-dark: #4b5563;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-light);
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    body.dark {
      background: var(--bg-dark);
    }
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--card-light);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
      height: 56px;
    }
    header.dark {
      background: var(--card-dark);
    }
    #friend-profile-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
    }
    #notification {
      position: fixed;
      top: 64px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary);
      color: var(--text-dark);
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      z-index: 20;
      display: none;
      max-width: 90%;
      font-size: 0.875rem;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 72px 1rem 80px;
      background: var(--card-light);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    #messages.dark {
      background: var(--bg-dark);
    }
    #no-messages {
      text-align: center;
      color: var(--muted-light);
      font-size: 0.875rem;
      padding: 1rem;
    }
    #no-messages.dark {
      color: var(--muted-dark);
    }
    .message-container {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      margin-bottom: 0.5rem;
    }
    .message-container.friend {
      align-items: flex-start;
    }
    .message {
      max-width: 80%;
      padding: 0.5rem 1rem;
      border-radius: 12px;
      font-size: 0.9375rem;
      -webkit-user-select: text;
      user-select: text;
      color: var(--text-light);
    }
    .message.dark {
      color: var(--text-dark);
    }
    .message.self {
      background: #fee2e2;
      border-bottom-right-radius: 4px;
    }
    .message.friend {
      background: #e5e7eb;
      border-bottom-left-radius: 4px;
    }
    .message.self.dark {
      background: #7f1d1d;
    }
    .message.friend.dark {
      background: var(--border-dark);
    }
    .message small {
      font-size: 0.6875rem;
      margin-top: 0.25rem;
      text-align: right;
      color: var(--muted-light);
    }
    .message.friend small {
      text-align: left;
    }
    .message.dark small {
      color: var(--muted-dark);
    }
    .message img {
      height: 48px;
      width: 48px;
      object-fit: contain;
    }
    .reaction {
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    .reply-preview {
      background: #f3f4f6;
      border-left: 4px solid var(--primary);
      padding: 0.5rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 8px;
      font-size: 0.8125rem;
      color: var(--text-light);
    }
    .reply-preview.dark {
      background: var(--border-dark);
      color: var(--text-dark);
    }
    #input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-light);
      padding: 0.75rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      z-index: 10;
    }
    #input-area.dark {
      background: var(--card-dark);
    }
    #input-form {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    #message-input {
      flex: 1;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      border: 1px solid var(--border-light);
      font-size: 0.9375rem;
      background: var(--card-light);
      color: var(--text-light);
    }
    #message-input.dark {
      border-color: var(--border-dark);
      background: var(--border-dark);
      color: var(--text-dark);
    }
    #message-input:focus {
      outline: 2px solid var(--primary);
    }
    #emoji-btn {
      background: var(--border-light);
      border-radius: 9999px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      font-size: 1.25rem;
    }
    #emoji-btn.dark {
      background: var(--border-dark);
      color: var(--muted-dark);
    }
    #send-btn {
      background: var(--primary);
      color: var(--text-dark);
      padding: 0 1rem;
      border-radius: 9999px;
      font-weight: 600;
      border: none;
      height: 40px;
      font-size: 0.875rem;
    }
    #send-btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
    }
    .cancel-reply {
      position: absolute;
      top: 0.5rem;
      right: 0.75rem;
      color: var(--primary);
      cursor: pointer;
    }
    .emoji-picker {
      position: absolute;
      background: var(--card-light);
      border-radius: 12px;
      padding: 0.5rem;
      z-index: 999;
      display: none;
    }
    .emoji-picker.dark {
      background: var(--card-dark);
    }
    .emoji-picker span {
      cursor: pointer;
      padding: 0.25rem;
      font-size: 1.25rem;
    }
    #picker-panel {
      position: absolute;
      bottom: 5rem;
      left: 1rem;
      background: var(--card-light);
      border-radius: 12px;
      width: 280px;
      max-height: 50vh;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    #picker-panel.open {
      display: block;
    }
    #picker-panel.dark {
      background: var(--card-dark);
    }
    .picker-tabs {
      display: flex;
      gap: 1rem;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-light);
    }
    .picker-tabs.dark {
      border-bottom: 1px solid var(--border-dark);
    }
    .picker-tab {
      padding: 0.5rem 1rem;
      color: var(--muted-light);
      cursor: pointer;
    }
    .picker-tab.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
    }
    .picker-content {
      padding: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .picker-content span, .picker-content img {
      cursor: pointer;
      padding: 0.25rem;
      font-size: 1.5rem;
    }
    .picker-content img {
      height: 48px;
      width: 48px;
    }
    .close-btn {
      color: var(--primary);
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.75rem;
    }
    @media (max-width: 640px) {
      #picker-panel {
        width: calc(100% - 2rem);
      }
      .message {
        max-width: 85%;
      }
    }
  </style>
</head>
<body>
  <header>
    <button onclick="location.href='index.html'" class="text-[var(--primary)] font-semibold" aria-label="Back to home">‚Üê</button>
    <div id="friend-profile-link" aria-label="View friend's profile">
      <img id="friend-photo" src="https://www.gravatar.com/avatar?d=mp" class="w-10 h-10 rounded-full" alt="Friend's profile photo" />
      <div>
        <h1 id="friend-name" class="font-semibold text-lg text-[var(--text-light)]">Friend</h1>
        <span id="friend-presence" class="text-sm text-[var(--muted-light)]">Offline</span>
      </div>
    </div>
  </header>

  <div id="notification" aria-live="polite"></div>

  <div id="messages">
    <div id="no-messages">Loading...</div>
  </div>

  <form id="input-area" onsubmit="return false;">
    <div id="reply-box" class="reply-preview hidden">
      <span id="reply-text"></span>
      <span class="cancel-reply" onclick="cancelReply()">√ó</span>
    </div>
    <div id="input-form" class="flex gap-2 items-center">
      <button id="emoji-btn" type="button" aria-label="Open emojis and stickers">üòä</button>
      <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" aria-label="Message input" />
      <button id="send-btn" type="button" aria-label="Send message">Send</button>
    </div>
  </form>

  <div id="emoji-picker" class="emoji-picker">
    <span>üëç</span><span>üòÇ</span><span>üî•</span><span>‚ù§Ô∏è</span>
  </div>

  <div id="picker-panel" class="picker-panel">
    <div class="picker-tabs">
      <button class="picker-tab active" data-tab="emojis">Emojis</button>
      <button class="picker-tab" data-tab="stickers">Stickers</button>
      <span class="close-btn" onclick="togglePickerPanel()">√ó</span>
    </div>
    <div id="emoji-content" class="picker-content">
      <span>üëç</span><span>üòÇ</span><span>üî•</span><span>‚ù§Ô∏è</span>
    </div>
    <div id="sticker-content" class="picker-content hidden">
      <img src="https://cdn-icons-png.flaticon.com/128/616/616430.png" alt="Cat Sticker">
      <img src="https://cdn-icons-png.flaticon.com/128/616/616498.png" alt="Dog Sticker">
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, onValue, push, update, get, onChildAdded, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878-default-rtdb.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    const messagesEl = document.getElementById("messages");
    const noMessagesEl = document.getElementById("no-messages");
    const messageInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const replyBox = document.getElementById("reply-box");
    const replyText = document.getElementById("reply-text");
    const emojiPicker = document.getElementById("emoji-picker");
    const friendProfileLink = document.getElementById("friend-profile-link");
    const pickerPanel = document.getElementById("picker-panel");
    const emojiContent = document.getElementById("emoji-content");
    const stickerContent = document.getElementById("sticker-content");
    const emojiBtn = document.getElementById("emoji-btn");
    const friendNameEl = document.getElementById("friend-name");
    const friendPresenceEl = document.getElementById("friend-presence");
    const friendPhotoEl = document.getElementById("friend-photo");

    let currentUser, friendUid, chatId, friendName;
    let replyingTo = null;
    let reactingKey = null;
    let theme = 'light';

    function getParam(name) {
      return new URLSearchParams(location.search).get(name);
    }

    function formatTime(ms) {
      const d = new Date(ms);
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function showError(message) {
      console.error("Error:", message);
      noMessagesEl.textContent = message;
      noMessagesEl.classList.remove("hidden");
      setTimeout(() => {
        noMessagesEl.textContent = "No messages yet";
        noMessagesEl.classList.add("hidden");
      }, 5000);
    }

    function cancelReply() {
      replyingTo = null;
      replyBox.classList.add("hidden");
      replyText.textContent = "";
      messageInput.focus();
    }

    function togglePickerPanel() {
      console.log("Toggling picker panel");
      pickerPanel.classList.toggle("open");
      pickerPanel.style.display = pickerPanel.classList.contains("open") ? "block" : "none";
      emojiBtn.setAttribute("aria-expanded", pickerPanel.classList.contains("open"));
    }

    function renderMessages(messages) {
      console.log("Rendering messages:", messages);
      messagesEl.innerHTML = "";
      noMessagesEl.classList.add("hidden");
      if (!messages || messages.length === 0) {
        console.log("No messages to render");
        noMessagesEl.textContent = "No messages yet";
        noMessagesEl.classList.remove("hidden");
        return;
      }
      const fragment = document.createDocumentFragment();
      messages.forEach(([key, m]) => {
        console.log("Message:", key, m);
        const isSelf = m.sender === currentUser.uid;
        const container = document.createElement("div");
        container.className = `message-container ${isSelf ? "self" : "friend"}`;

        const div = document.createElement("div");
        div.className = `message ${isSelf ? "self" : "friend"} ${theme === 'dark' ? 'dark' : ''}`;

        let startX = null;
        div.addEventListener("touchstart", (e) => {
          startX = e.touches[0].clientX;
          setTimeout(() => {
            if (startX !== null && !isSelf) {
              showEmojiPicker(div, key);
            }
          }, 600);
        });

        div.addEventListener("touchend", (e) => {
          if (startX !== null) {
            const endX = e.changedTouches[0].clientX;
            if (endX - startX > 60) {
              replyingTo = m.text;
              replyText.textContent = m.text.length > 50 ? m.text.substring(0, 50) + '...' : m.text;
              replyBox.classList.remove("hidden");
              messageInput.focus();
            }
            startX = null;
          }
        });

        if (m.replyTo) {
          const quote = document.createElement("div");
          quote.className = `reply-preview ${theme === 'dark' ? 'dark' : ''}`;
          quote.textContent = m.replyTo.length > 50 ? m.replyTo.substring(0, 50) + '...' : m.replyTo;
          div.appendChild(quote);
        }

        if (m.text.match(/\.(png|jpg|jpeg|gif)$/i)) {
          const img = document.createElement("img");
          img.src = m.text;
          img.alt = "Sticker";
          div.appendChild(img);
        } else {
          div.appendChild(document.createTextNode(m.text));
        }

        const time = document.createElement("small");
        time.textContent = isSelf ? `${formatTime(m.timestamp)} ‚Ä¢ ${m.read ? "Delivered" : "Sent"}` : formatTime(m.timestamp);
        div.appendChild(time);

        if (m.reaction) {
          const reaction = document.createElement("div");
          reaction.className = "reaction";
          reaction.textContent = m.reaction;
          container.appendChild(reaction);
        }

        container.appendChild(div);
        fragment.appendChild(container);
      });
      messagesEl.appendChild(fragment);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      console.log("Messages rendered:", messages.length);
    }

    function showEmojiPicker(target, key) {
      const rect = target.getBoundingClientRect();
      emojiPicker.style.top = `${rect.top - 40 + window.scrollY}px`;
      emojiPicker.style.left = `${rect.left}px`;
      emojiPicker.style.display = "flex";
      reactingKey = key;
    }

    function applyTheme(themeValue) {
      console.log("Applying theme:", themeValue);
      theme = themeValue;
      document.body.classList.toggle('dark', theme === 'dark');
      document.querySelector('header').classList.toggle('dark', theme === 'dark');
      messagesEl.classList.toggle('dark', theme === 'dark');
      noMessagesEl.classList.toggle('dark', theme === 'dark');
      document.querySelectorAll('.message').forEach(el => el.classList.toggle('dark', theme === 'dark'));
      replyBox.classList.toggle('dark', theme === 'dark');
      document.querySelector('#input-area').classList.toggle('dark', theme === 'dark');
      messageInput.classList.toggle('dark', theme === 'dark');
      sendBtn.classList.toggle('dark', theme === 'dark');
      emojiPicker.classList.toggle('dark', theme === 'dark');
      emojiBtn.classList.toggle('dark', theme === 'dark');
      pickerPanel.classList.toggle('dark', theme === 'dark');
      document.querySelectorAll('.picker-tabs').forEach(el => el.classList.toggle('dark', theme === 'dark'));
      document.querySelectorAll('.picker-tab').forEach(el => el.classList.toggle('dark', theme === 'dark'));
    }

    document.addEventListener("click", (e) => {
      if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
        emojiPicker.style.display = "none";
        reactingKey = null;
      }
      if (!pickerPanel.contains(e.target) && e.target !== emojiBtn) {
        pickerPanel.classList.remove("open");
        pickerPanel.style.display = "none";
      }
    });

    emojiBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      togglePickerPanel();
    });

    onAuthStateChanged(auth, async (user) => {
      console.log("Auth state:", user ? `User: ${user.uid}` : "No user");
      if (!user) {
        showError("Please log in to view chats");
        return location.href = "login.html";
      }
      currentUser = user;
      friendUid = getParam("uid");
      if (!friendUid) {
        console.error("No friendUid in URL");
        showError("Friend UID not provided");
        return location.href = "index.html";
      }
      chatId = currentUser.uid < friendUid ? `${currentUser.uid}_${friendUid}` : `${friendUid}_${currentUser.uid}`;
      console.log("Chat ID:", chatId);

      noMessagesEl.textContent = "Loading...";
      noMessagesEl.classList.remove("hidden");

      try {
        console.log("Fetching friend data for UID:", friendUid);
        const userSnap = await get(ref(db, `users/${friendUid}`));
        if (!userSnap.exists()) {
          console.error("Friend not found:", friendUid);
          showError("Friend not found");
          return location.href = "index.html";
        }
        const userData = userSnap.val();
        friendName = userData.name || "Friend";
        friendNameEl.textContent = friendName;
        friendPhotoEl.src = userData.photoURL || "https://www.gravatar.com/avatar?d=mp";
        console.log("Friend data:", userData);

        const presenceSnap = await get(ref(db, `users/${friendUid}/presence`));
        const lastSeenSnap = await get(ref(db, `users/${friendUid}/lastSeen`));
        if (presenceSnap.val() === "online") {
          friendPresenceEl.textContent = "Online";
        } else if (lastSeenSnap.val()) {
          friendPresenceEl.textContent = `Last seen at ${formatTime(lastSeenSnap.val())}`;
        } else {
          friendPresenceEl.textContent = "Offline";
        }
        console.log("Presence:", presenceSnap.val(), "Last seen:", lastSeenSnap.val());

        const settingsSnap = await get(ref(db, `users/${currentUser.uid}/settings`));
        theme = settingsSnap.val()?.theme || 'light';
        applyTheme(theme);

        friendProfileLink.onclick = () => location.href = `profile.html?uid=${friendUid}`;

        console.log("Setting up messages listener for:", `messages/${chatId}`);
        const messagesQuery = query(ref(db, `messages/${chatId}`), limitToLast(50));
        onValue(messagesQuery, (snap) => {
          console.log("Messages snapshot:", snap.val());
          if (!snap.exists()) {
            console.log("No messages for chatId:", chatId);
            noMessagesEl.textContent = "No messages yet";
            noMessagesEl.classList.remove("hidden");
            return;
          }
          const messages = Object.entries(snap.val() || {}).sort((a, b) => a[1].timestamp - b[1].timestamp);
          renderMessages(messages);
        }, (error) => {
          console.error("Messages listener error:", error);
          showError(`Failed to load messages: ${error.message}`);
        });

        onChildAdded(ref(db, `messages/${chatId}`), (snap) => {
          console.log("New message:", snap.key, snap.val());
          const msg = snap.val();
          if (msg.sender !== currentUser.uid) {
            document.getElementById("notification").textContent = `${friendName}: ${msg.text.length > 30 ? msg.text.substring(0, 30) + '...' : msg.text}`;
            document.getElementById("notification").style.display = "block";
            setTimeout(() => document.getElementById("notification").style.display = "none", 3000);
            renderMessages([[snap.key, msg]]);
          }
        });

        await update(ref(db, `users/${currentUser.uid}`), { presence: "online" });
      } catch (error) {
        console.error("Error loading chat:", error);
        showError(`Failed to load chat: ${error.message}`);
      }
    });

    sendBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      console.log("Send button clicked, text:", messageInput.value);
      const text = messageInput.value.trim();
      if (!text) {
        console.log("No text to send");
        return;
      }
      if (!currentUser || !chatId) {
        console.error("Cannot send: currentUser or chatId missing", { currentUser, chatId });
        showError("Cannot send message: User or chat not initialized");
        return;
      }
      try {
        console.log("Sending message:", text);
        const msg = {
          sender: currentUser.uid,
          text,
          timestamp: Date.now(),
          read: false,
          ...(replyingTo && { replyTo: replyingTo })
        };
        await push(ref(db, `messages/${chatId}`), msg);
        console.log("Message sent successfully");
        messageInput.value = "";
        cancelReply();
        sendBtn.disabled = true;
      } catch (error) {
        console.error("Error sending message:", error);
        showError(`Failed to send message: ${error.message}`);
      }
    });

    messageInput.addEventListener("input", () => {
      sendBtn.disabled = !messageInput.value.trim();
    });

    document.querySelectorAll(".picker-tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".picker-tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        emojiContent.style.display = tab.dataset.tab === "emojis" ? "flex" : "none";
        stickerContent.style.display = tab.dataset.tab === "stickers" ? "flex" : "none";
      });
    });

    [emojiContent, stickerContent].forEach(content => {
      content.querySelectorAll("span, img").forEach(item => {
        item.onclick = () => {
          messageInput.value += item.tagName === "IMG" ? item.src : item.textContent;
          messageInput.focus();
          sendBtn.disabled = false;
          togglePickerPanel();
        };
      });
    });

    emojiPicker.querySelectorAll("span").forEach(span => {
      span.onclick = () => {
        if (reactingKey) {
          update(ref(db, `messages/${chatId}/${reactingKey}`), { reaction: span.textContent });
          emojiPicker.style.display = "none";
          reactingKey = null;
        }
      };
    });
  </script>
</body>
</html>
