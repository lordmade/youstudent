<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Chaxo</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      background: #f5f5f5;
      overscroll-behavior: none;
      user-select: none;
    }
    header {
      background: #fff;
      padding: 10px 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }
    header div {
      flex: 1;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    header small {
      font-size: 12px;
      color: #888;
    }
    #messages {
      padding: 10px;
      margin-bottom: 60px;
      overscroll-behavior: none;
      overflow-y: auto;
      max-height: calc(100vh - 140px);
    }
    .message-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .message-container.self {
      align-items: flex-end;
    }
    .message {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 15px;
      font-size: 16px;
      line-height: 1.4;
      position: relative;
      background: #fff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      word-wrap: break-word;
    }
    .message.friend {
      background: #e0f7fa;
      color: #000;
    }
    .message small {
      font-size: 11px;
      color: #888;
      margin-top: 4px;
      display: block;
      text-align: right;
    }
    .message img {
      border-radius: 10px;
    }
    .quoted-text {
      background: rgba(0, 0, 0, 0.1);
      padding: 8px;
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 8px;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .reaction {
      font-size: 20px;
      margin-top: 4px;
      align-self: flex-end;
    }
    #input-area {
      position: fixed;
      bottom: 0;
      width: 100%;
      padding: 10px;
      background: #fff;
      box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
    }
    #message-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 16px;
      margin-right: 10px;
      outline: none;
    }
    #send-btn {
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #send-btn.mic-anim {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    #emoji-picker {
      position: absolute;
      bottom: 70px;
      display: none;
      background: #fff;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 20;
    }
    #emoji-picker span {
      font-size: 24px;
      margin: 0 5px;
      cursor: pointer;
    }
    #reply-box {
      display: none;
      background: #fff;
      padding: 10px;
      border-top: 1px solid #ddd;
      position: fixed;
      bottom: 60px;
      width: 100%;
      z-index: 10;
    }
    #reply-box div {
      max-width: 90%;
      font-size: 14px;
      color: #888;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .cancel-reply {
      cursor: pointer;
      font-size: 14px;
      color: #007bff;
      margin-left: auto;
    }
    #bottom-sheet {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #fff;
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2);
      transform: translateY(100%);
      transition: transform 0.3s ease-in-out;
      z-index: 30;
      max-height: 50vh;
      display: flex;
      flex-direction: column;
    }
    #bottom-sheet.open {
      transform: translateY(0);
    }
    .bottom-sheet-header {
      display: flex;
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    .bottom-sheet-tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
    }
    .bottom-sheet-tab.active {
      border-bottom: 2px solid #007bff;
      color: #007bff;
    }
    #emoji-content, #sticker-content {
      display: none;
      padding: 10px;
      overflow-y: auto;
      flex: 1;
    }
    #emoji-content span, #sticker-content img {
      font-size: 30px;
      margin: 5px;
      cursor: pointer;
    }
    #sticker-content img {
      width: 50px;
      height: 50px;
    }
    .close-btn {
      position: absolute;
      right: 10px;
      top: 10px;
      font-size: 24px;
      cursor: pointer;
      color: #888;
    }
    #delete-message-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 40;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      width: 80%;
      max-width: 300px;
    }
    .modal-content p {
      margin: 0 0 20px;
      font-size: 16px;
    }
    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 0 5px;
    }
    .modal-btn-confirm {
      background: #007bff;
      color: #fff;
    }
    .modal-btn-cancel {
      background: #ccc;
    }
    #notification {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 10px 20px;
      border-radius: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      font-size: 14px;
      display: none;
      z-index: 20;
      max-width: 80%;
      text-align: center;
    }
    body.dark {
      background: #121212;
    }
    header.dark {
      background: #1e1e1e;
      color: #fff;
    }
    header.dark small {
      color: #aaa;
    }
    #messages.dark {
      background: #121212;
    }
    .message.dark {
      background: #1e1e1e;
      color: #fff;
      box-shadow: 0 1px 2px rgba(255, 255, 255, 0.1);
    }
    .message.friend.dark {
      background: #263238;
      color: #fff;
    }
    .message.dark small {
      color: #aaa;
    }
    .quoted-text.dark {
      background: rgba(255, 255, 255, 0.1);
    }
    #input-area.dark {
      background: #1e1e1e;
      box-shadow: 0 -2px 4px rgba(255, 255, 255, 0.1);
    }
    #message-input.dark {
      background: #2c2c2c;
      border-color: #444;
      color: #fff;
    }
    #send-btn.dark {
      background: #0288d1;
    }
    #send-btn.dark:disabled {
      background: #555;
    }
    #emoji-picker.dark {
      background: #1e1e1e;
      box-shadow: 0 2px 8px rgba(255, 255, 255, 0.2);
    }
    #emoji-btn.dark {
      color: #fff;
    }
    #reply-box.dark {
      background: #1e1e1e;
      border-top: 1px solid #444;
      color: #fff;
    }
    .cancel-reply.dark {
      color: #0288d1;
    }
    #bottom-sheet.dark {
      background: #1e1e1e;
      box-shadow: 0 -2px 8px rgba(255, 255, 255, 0.2);
    }
    .bottom-sheet-header.dark {
      border-bottom: 1px solid #444;
    }
    .bottom-sheet-tab.dark {
      color: #fff;
    }
    .bottom-sheet-tab.active.dark {
      border-bottom: 2px solid #0288d1;
      color: #0288d1;
    }
    .close-btn.dark {
      color: #aaa;
    }
    #delete-message-modal.dark .modal-content {
      background: #1e1e1e;
      color: #fff;
    }
    .modal-btn-cancel.dark {
      background: #444;
      color: #fff;
    }
    #notification.dark {
      background: #1e1e1e;
      color: #fff;
      box-shadow: 0 2px 8px rgba(255, 255, 255, 0.2);
    }
    .long-press-disable-select {
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <header>
    <img id="friend-photo" src="https://www.gravatar.com/avatar?d=mp" alt="Friend">
    <div>
      <h1 id="friend-name">Friend</h1>
      <small id="friend-presence">Offline</small>
    </div>
    <a id="friend-profile-link">View Profile</a>
  </header>
  <div id="messages"></div>
  <div id="notification"></div>
  <div id="reply-box" class="hidden">
    <div id="reply-text"></div>
    <span class="cancel-reply">Cancel</span>
  </div>
  <div id="input-area">
    <input type="text" id="message-input" placeholder="Type a message...">
    <button id="emoji-btn">üòä</button>
    <button id="send-btn" disabled>Voice</button>
  </div>
  <div id="emoji-picker" class="hidden">
    <span>üëç</span>
    <span>‚ù§Ô∏è</span>
    <span>üòÇ</span>
    <span>üò¢</span>
    <span>üòÆ</span>
    <span>üôè</span>
  </div>
  <div id="bottom-sheet">
    <div class="bottom-sheet-header">
      <div class="bottom-sheet-tab active" data-tab="emojis">Emojis</div>
      <div class="bottom-sheet-tab" data-tab="stickers">Stickers</div>
      <span class="close-btn" onclick="document.getElementById('bottom-sheet').classList.remove('open')">√ó</span>
    </div>
    <div id="emoji-content" style="display: flex;">
      <span>üòä</span>
      <span>üòÇ</span>
      <span>üòç</span>
      <span>üò¢</span>
      <span>üëç</span>
      <span>üôè</span>
      <span>üéâ</span>
      <span>üòé</span>
    </div>
    <div id="sticker-content">
      <img src="https://cdn-icons-png.flaticon.com/128/616/616430.png" alt="Sticker">
      <img src="https://cdn-icons-png.flaticon.com/128/2589/2589175.png" alt="Sticker">
      <img src="https://cdn-icons-png.flaticon.com/128/3106/3106726.png" alt="Sticker">
      <img src="https://cdn-icons-png.flaticon.com/128/3076/3076535.png" alt="Sticker">
    </div>
  </div>
  <div id="delete-message-modal" class="hidden">
    <div class="modal-content">
      <p>Delete this message?</p>
      <button id="modal-confirm" class="modal-btn modal-btn-confirm">Delete</button>
      <button id="modal-cancel" class="modal-btn modal-btn-cancel">Cancel</button>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
    import { getDatabase, ref, onValue, push, update, get, remove, onChildAdded, query, limitToLast, set } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    const messagesEl = document.getElementById("messages");
    const messageInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const replyBox = document.getElementById("reply-box");
    const replyText = document.getElementById("reply-text");
    const emojiPicker = document.getElementById("emoji-picker");
    const friendProfileLink = document.getElementById("friend-profile-link");
    const deleteMessageModal = document.getElementById("delete-message-modal");
    const modalConfirm = document.getElementById("modal-confirm");
    const modalCancel = document.getElementById("modal-cancel");
    const notificationEl = document.getElementById("notification");
    const bottomSheet = document.getElementById("bottom-sheet");
    const emojiContent = document.getElementById("emoji-content");
    const stickerContent = document.getElementById("sticker-content");
    const emojiBtn = document.getElementById("emoji-btn");

    let currentUser, friendUid, chatId, friendName;
    let replyingTo = null;
    let reactingKey = null;
    let deletingKey = null;
    let theme = 'light';
    let lastMessageKey = null;

    function getParam(name) {
      return new URLSearchParams(location.search).get(name);
    }

    function formatTime(ms) {
      const d = new Date(ms);
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function cancelReply() {
      replyingTo = null;
      replyBox.classList.add("hidden");
      replyText.textContent = "";
      messageInput.focus();
    }

    function showDeleteMessageModal(key) {
      deletingKey = key;
      deleteMessageModal.classList.remove("hidden");
      modalConfirm.onclick = async () => {
        try {
          await remove(ref(db, `messages/${chatId}/${key}`));
          deleteMessageModal.classList.add("hidden");
          deletingKey = null;
        } catch (error) {
          console.error("Error deleting message:", error);
          showNotification("System", "Failed to delete message.");
        }
      };
      modalCancel.onclick = () => {
        deleteMessageModal.classList.add("hidden");
        deletingKey = null;
      };
    }

    function showNotification(senderName, text) {
      if (messagesEl.scrollTop + messagesEl.clientHeight < messagesEl.scrollHeight - 50) {
        notificationEl.textContent = `${senderName}: ${text.length > 30 ? text.substring(0, 30) + '...' : text}`;
        notificationEl.classList.add(theme === 'dark' ? 'dark' : '');
        notificationEl.style.display = 'block';
        setTimeout(() => {
          notificationEl.style.display = 'none';
          notificationEl.classList.remove('dark');
        }, 3000);
        notificationEl.onclick = () => {
          notificationEl.style.display = 'none';
          messagesEl.scrollTop = messagesEl.scrollHeight;
        };
      }
    }

    function toggleBottomSheet() {
      bottomSheet.classList.toggle("open");
      if (bottomSheet.classList.contains("open")) {
        emojiContent.style.display = "flex";
        stickerContent.style.display = "none";
        document.querySelector(".bottom-sheet-tab[data-tab='emojis']").classList.add("active");
        document.querySelector(".bottom-sheet-tab[data-tab='stickers']").classList.remove("active");
      }
    }

    async function renderMessages(messages) {
      const fragment = document.createDocumentFragment();
      for (const [key, m] of messages) {
        const isSelf = m.sender === currentUser.uid;
        const displayText = m.text;
        const replyText = m.replyTo;

        const container = document.createElement("div");
        container.className = `message-container ${isSelf ? "self" : "friend"}`;

        const div = document.createElement("div");
        div.className = `message ${isSelf ? "self" : "friend"} ${theme === 'dark' ? 'dark' : ''}`;

        let pressTimer = null;
        let startX = null;
        let longPressActive = false;

        div.addEventListener("touchstart", (e) => {
          div.classList.add("long-press-disable-select");
          startX = e.touches[0].clientX;
          pressTimer = setTimeout(() => {
            longPressActive = true;
            if (isSelf) {
              showDeleteMessageModal(key);
            } else {
              showEmojiPicker(div, key);
            }
          }, 600);
        });

        div.addEventListener("touchend", (e) => {
          if (pressTimer) clearTimeout(pressTimer);
          div.classList.remove("long-press-disable-select");

          if (!longPressActive) {
            const endX = e.changedTouches[0].clientX;
            const deltaX = endX - startX;
            if (deltaX > 60) {
              replyingTo = m.text;
              replyText.textContent = displayText;
              replyBox.classList.remove("hidden");
              messageInput.focus();
            } else if (deltaX < -60 && isSelf) {
              showDeleteMessageModal(key);
            }
          }
          longPressActive = false;
          startX = null;
        });

        div.addEventListener("touchmove", () => {
          if (pressTimer) clearTimeout(pressTimer);
          div.classList.remove("long-press-disable-select");
          longPressActive = false;
        });

        if (replyText) {
          const quote = document.createElement("div");
          quote.className = `quoted-text ${theme === 'dark' ? 'dark' : ''}`;
          quote.textContent = replyText;
          div.appendChild(quote);
        }

        if (displayText.match(/\.(png|jpg|jpeg|gif)$/i)) {
          const img = document.createElement("img");
          img.src = displayText;
          img.className = "h-16 w-16 object-contain";
          img.alt = "Sticker";
          div.appendChild(img);
        } else {
          div.append(displayText);
        }

        const time = document.createElement("small");
        time.textContent = isSelf
          ? `${formatTime(m.timestamp)} ‚Ä¢ ${m.read ? "Delivered" : "Sent"}`
          : formatTime(m.timestamp);
        div.appendChild(time);

        container.appendChild(div);

        if (m.reaction) {
          const reaction = document.createElement("div");
          reaction.className = "reaction";
          reaction.textContent = m.reaction;
          container.appendChild(reaction);
        }

        fragment.appendChild(container);
        if (!lastMessageKey || key > lastMessageKey) lastMessageKey = key;
      }
      messagesEl.appendChild(fragment);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function showEmojiPicker(target, key) {
      const rect = target.getBoundingClientRect();
      emojiPicker.style.top = (rect.top - 50 + window.scrollY) + "px";
      emojiPicker.style.left = rect.left + "px";
      emojiPicker.style.display = "flex";
      reactingKey = key;
    }

    function applyTheme(themeValue) {
      theme = themeValue;
      document.body.classList.toggle('dark', theme === 'dark');
      document.querySelector('header').classList.toggle('dark', theme === 'dark');
      messagesEl.classList.toggle('dark', theme === 'dark');
      document.querySelectorAll('.message').forEach(el => el.classList.toggle('dark', theme === 'dark'));
      document.querySelectorAll('.message.friend').forEach(el => el.classList.toggle('dark', theme === 'dark'));
      document.querySelectorAll('.message small').forEach(el => el.classList.toggle('dark', theme === 'dark'));
      document.querySelectorAll('.quoted-text').forEach(el => el.classList.toggle('dark', theme === 'dark'));
      replyBox.classList.toggle('dark', theme === 'dark');
      document.querySelector('.cancel-reply').classList.toggle('dark', theme === 'dark');
      document.querySelector('#input-area').classList.toggle('dark', theme === 'dark');
      document.querySelector('#message-input').classList.toggle('dark', theme === 'dark');
      sendBtn.classList.toggle('dark', theme === 'dark');
      emojiPicker.classList.toggle('dark', theme === 'dark');
      emojiBtn.classList.toggle('dark', theme === 'dark');
      bottomSheet.classList.toggle('dark', theme === 'dark');
      document.querySelector('.bottom-sheet-header').classList.toggle('dark', theme === 'dark');
      document.querySelectorAll('.bottom-sheet-tab').forEach(el => el.classList.toggle('dark', theme === 'dark'));
      document.querySelectorAll('.bottom-sheet-tab.active').forEach(el => el.classList.toggle('dark', theme === 'dark'));
      document.querySelector('.close-btn').classList.toggle('dark', theme === 'dark');
      deleteMessageModal.classList.toggle('dark', theme === 'dark');
      document.querySelectorAll('.modal-btn-cancel').forEach(el => el.classList.toggle('dark', theme === 'dark'));
    }

    document.addEventListener("click", (e) => {
      if (!emojiPicker.contains(e.target) && e.target !== emojiBtn && !emojiBtn.contains(e.target)) {
        emojiPicker.style.display = "none";
      }
      if (!bottomSheet.contains(e.target) && e.target !== emojiBtn && !emojiBtn.contains(e.target) && bottomSheet.classList.contains("open")) {
        bottomSheet.classList.remove("open");
      }
      if (!deleteMessageModal.contains(e.target) && e.target !== modalConfirm && e.target !== modalCancel) {
        deleteMessageModal.classList.add("hidden");
        deletingKey = null;
      }
    });

    async function checkBlockedStatus() {
      if (!currentUser || !friendUid) return;
      try {
        const [blockedByMe, blockedByFriend] = await Promise.all([
          get(ref(db, `users/${currentUser.uid}/blockedUsers/${friendUid}`)),
          get(ref(db, `users/${friendUid}/blockedUsers/${currentUser.uid}`))
        ]);
        if (blockedByMe.exists() || blockedByFriend.exists()) {
          document.getElementById("input-area").style.display = "none";
        } else {
          document.getElementById("input-area").style.display = "flex";
        }
      } catch (error) {
        console.error("Error checking blocked status:", error);
        showNotification("System", "Error checking blocked status.");
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "login.html";
      currentUser = user;
      friendUid = getParam("uid");
      if (!friendUid) {
        showNotification("System", "Friend UID not provided.");
        return location.href = "index.html";
      }
      chatId = currentUser.uid < friendUid ? `${currentUser.uid}_${friendUid}` : `${friendUid}_${currentUser.uid}`;

      try {
        const [settingsSnap, userSnap, presenceSnap, lastSeenSnap] = await Promise.all([
          get(ref(db, `users/${user.uid}/settings`)),
          get(ref(db, `users/${friendUid}`)),
          get(ref(db, `users/${friendUid}/presence`)),
          get(ref(db, `users/${friendUid}/lastSeen`))
        ]);

        theme = settingsSnap.val()?.theme || 'light';
        applyTheme(theme);

        if (!userSnap.exists()) {
          showNotification("System", "Friend not found.");
          return location.href = "index.html";
        }
        const data = userSnap.val();
        friendName = data.name || "Friend";
        document.getElementById("friend-name").textContent = friendName;
        document.getElementById("friend-photo").src = data.photoURL || "https://www.gravatar.com/avatar?d=mp";

        if (presenceSnap.val() === "online") {
          document.getElementById("friend-presence").textContent = "Online";
        } else if (lastSeenSnap.val()) {
          const lastSeenDate = new Date(lastSeenSnap.val());
          document.getElementById("friend-presence").textContent = `Last seen at ${lastSeenDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
        }
      } catch (error) {
        console.error("Error loading initial data:", error);
        showNotification("System", "Failed to load chat data.");
        return location.href = "index.html";
      }

      friendProfileLink.onclick = () => {
        location.href = `profile.html?uid=${friendUid}`;
      };

      checkBlockedStatus();
      onValue(ref(db, `users/${currentUser.uid}/blockedUsers/${friendUid}`), () => checkBlockedStatus());
      onValue(ref(db, `users/${friendUid}/blockedUsers/${currentUser.uid}`), () => checkBlockedStatus());

      const messagesQuery = query(ref(db, `messages/${chatId}`), limitToLast(50));
      onValue(messagesQuery, snap => {
        messagesEl.innerHTML = "";
        if (!snap.exists()) return;
        const messages = Object.entries(snap.val()).sort((a, b) => a[1].timestamp - b[1].timestamp);
        renderMessages(messages);
        messages.forEach(([key, m]) => {
          if (m.sender !== currentUser.uid && !m.read) {
            update(ref(db, `messages/${chatId}/${key}`), { read: true }).catch(error => {
              console.error("Error marking message as read:", error);
            });
          }
        });
      });

      onChildAdded(ref(db, `messages/${chatId}`), async snap => {
        const msg = snap.val();
        const isSelf = msg.sender === currentUser.uid;
        if (!isSelf) {
          showNotification(friendName, msg.text);
          renderMessages([[snap.key, msg]]);
        }
      });

      try {
        await update(ref(db, `users/${currentUser.uid}`), {
          presence: "online",
          lastSeen: Date.now()
        });
      } catch (error) {
        console.error("Error updating presence:", error);
      }
      window.addEventListener("beforeunload", () => {
        update(ref(db, `users/${currentUser.uid}`), {
          presence: "offline",
          lastSeen: Date.now()
        }).catch(error => {
          console.error("Error updating presence on unload:", error);
        });
      });
    });

    function updateSendButton() {
      const hasText = messageInput.value.trim() !== "";
      sendBtn.textContent = hasText ? "Send" : "Voice";
      sendBtn.classList.remove("mic-anim");
      sendBtn.disabled = false;
    }

    messageInput.addEventListener("input", updateSendButton);
    messageInput.addEventListener("focus", updateSendButton);
    messageInput.addEventListener("blur", () => {
      if (!messageInput.value.trim()) {
        sendBtn.textContent = "Voice";
        sendBtn.classList.remove("mic-anim");
        sendBtn.disabled = false;
      }
    });

    let recognition;
    let isRecording = false;
    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';

      recognition.onstart = () => {
        isRecording = true;
        sendBtn.textContent = "Listening...";
        sendBtn.classList.add("mic-anim");
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        messageInput.value = transcript;
        messageInput.focus();
        updateSendButton();
      };

      recognition.onerror = (event) => {
        console.error("Speech recognition error:", event.error);
        showNotification("System", `Speech recognition error: ${event.error}`);
        resetVoiceButton();
      };

      recognition.onend = () => {
        isRecording = false;
        if (messageInput.value.trim()) {
          sendBtn.textContent = "Send";
        } else {
          resetVoiceButton();
        }
        sendBtn.classList.remove("mic-anim");
      };
    } else {
      sendBtn.textContent = "Send";
      sendBtn.disabled = false;
      sendBtn.title = "Voice input not supported";
    }

    function resetVoiceButton() {
      isRecording = false;
      sendBtn.textContent = "Voice";
      sendBtn.classList.remove("mic-anim");
      sendBtn.disabled = false;
    }

    sendBtn.onclick = async () => {
      console.log("Send button clicked, isRecording:", isRecording, "friendUid:", friendUid, "chatId:", chatId);
      if (isRecording) {
        console.log("Stopping voice recognition");
        recognition.stop();
        return;
      }

      const text = messageInput.value.trim();
      console.log("Text to send:", text);
      if (text) {
        const msg = {
          sender: currentUser.uid,
          text: text,
          timestamp: Date.now(),
          read: false
        };
        try {
          console.log("Pushing message to Firebase:", msg);
          if (replyingTo) {
            msg.replyTo = replyingTo;
          }
          await push(ref(db, `messages/${chatId}`), msg);
          messageInput.value = "";
          updateSendButton();
          cancelReply();
          console.log("Message sent successfully");
        } catch (error) {
          console.error("Error sending message:", error);
          showNotification("System", `Failed to send message: ${error.message}`);
        }
      } else if (recognition && !messageInput.value.trim()) {
        console.log("Starting voice recognition");
        recognition.start();
      } else {
        console.log("No text or voice support");
        showNotification("System", "Please enter a message or use voice input.");
      }
    };

    document.querySelector('.cancel-reply').addEventListener('click', cancelReply);

    emojiBtn.addEventListener("click", (e) => {
      e.preventDefault();
      toggleBottomSheet();
    });

    let isLoadingMore = false;
    messagesEl.addEventListener('scroll', async () => {
      if (messagesEl.scrollTop < 50 && !isLoadingMore) {
        isLoadingMore = true;
        try {
          const olderMessagesQuery = query(ref(db, `messages/${chatId}`), limitToLast(50));
          const snap = await get(olderMessagesQuery);
          if (snap.exists()) {
            const messages = Object.entries(snap.val()).sort((a, b) => a[1].timestamp - b[1].timestamp);
            const fragment = document.createDocumentFragment();
            for (const [key, m] of messages) {
              const isSelf = m.sender === currentUser.uid;
              const displayText = m.text;
              const replyText = m.replyTo;

              const container = document.createElement("div");
              container.className = `message-container ${isSelf ? "self" : "friend"}`;

              const div = document.createElement("div");
              div.className = `message ${isSelf ? "self" : "friend"} ${theme === 'dark' ? 'dark' : ''}`;

              let pressTimer = null;
              let startX = null;
              let longPressActive = false;

              div.addEventListener("touchstart", (e) => {
                div.classList.add("long-press-disable-select");
                startX = e.touches[0].clientX;
                pressTimer = setTimeout(() => {
                  longPressActive = true;
                  if (isSelf) {
                    showDeleteMessageModal(key);
                  } else {
                    showEmojiPicker(div, key);
                  }
                }, 600);
              });

              div.addEventListener("touchend", (e) => {
                if (pressTimer) clearTimeout(pressTimer);
                div.classList.remove("long-press-disable-select");

                if (!longPressActive) {
                  const endX = e.changedTouches[0].clientX;
                  const deltaX = endX - startX;
                  if (deltaX > 60) {
                    replyingTo = m.text;
                    replyText.textContent = displayText;
                    replyBox.classList.remove("hidden");
                    messageInput.focus();
                  } else if (deltaX < -60 && isSelf) {
                    showDeleteMessageModal(key);
                  }
                }
                longPressActive = false;
                startX = null;
              });

              div.addEventListener("touchmove", () => {
                if (pressTimer) clearTimeout(pressTimer);
                div.classList.remove("long-press-disable-select");
                longPressActive = false;
              });

              if (replyText) {
                const quote = document.createElement("div");
                quote.className = `quoted-text ${theme === 'dark' ? 'dark' : ''}`;
                quote.textContent = replyText;
                div.appendChild(quote);
              }

              if (displayText.match(/\.(png|jpg|jpeg|gif)$/i)) {
                const img = document.createElement("img");
                img.src = displayText;
                img.className = "h-16 w-16 object-contain";
                img.alt = "Sticker";
                div.appendChild(img);
              } else {
                div.append(displayText);
              }

              const time = document.createElement("small");
              time.textContent = isSelf
                ? `${formatTime(m.timestamp)} ‚Ä¢ ${m.read ? "Delivered" : "Sent"}`
                : formatTime(m.timestamp);
              div.appendChild(time);

              container.appendChild(div);

              if (m.reaction) {
                const reaction = document.createElement("div");
                reaction.className = "reaction";
                reaction.textContent = m.reaction;
                container.appendChild(reaction);
              }

              fragment.appendChild(container);
              if (!lastMessageKey || key < lastMessageKey) lastMessageKey = key;
            }
            messagesEl.prepend(fragment);
          }
        } catch (error) {
          console.error("Error loading more messages:", error);
          showNotification("System", "Error loading more messages.");
        } finally {
          isLoadingMore = false;
        }
      }
    });

    emojiPicker.querySelectorAll("span").forEach(span => {
      span.onclick = () => {
        if (reactingKey) {
          update(ref(db, `messages/${chatId}/${reactingKey}`), {
            reaction: span.textContent
          }).catch(error => {
            console.error("Error adding reaction:", error);
            showNotification("System", "Failed to add reaction.");
          });
          emojiPicker.style.display = "none";
          reactingKey = null;
        }
      };
    });

    document.querySelectorAll(".bottom-sheet-tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".bottom-sheet-tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        emojiContent.style.display = tab.dataset.tab === "emojis" ? "flex" : "none";
        stickerContent.style.display = tab.dataset.tab === "stickers" ? "flex" : "none";
      });
    });

    [emojiContent, stickerContent].forEach(content => {
      content.querySelectorAll("span, img").forEach(item => {
        item.addEventListener("click", () => {
          messageInput.value += item.tagName === "IMG" ? item.src : item.textContent;
          messageInput.focus();
          updateSendButton();
          toggleBottomSheet();
        });
      });
    });
  </script>
</body>
</html>
