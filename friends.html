<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chaxo - Friends</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f9f9f9;
      color: #1a1a1a;
      margin: 0;
      padding-bottom: 64px; /* space for bottom nav */
    }
    .sidebar {
      width: 240px;
      position: fixed;
      top: 0;
      left: -240px;
      height: 100%;
      background-color: #ffffff;
      transition: left 0.3s ease;
      z-index: 1000;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
      padding: 1rem;
    }
    .sidebar.open {
      left: 0;
    }
    .loader-container {
      display: none;
      justify-content: center;
      align-items: center;
      height: 100vh;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(255,255,255,0.8);
      z-index: 9999;
    }
    /* Tab Nav styles */
    .tab-nav {
      display: flex;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background-color: #fff;
      border-top: 1px solid #e5e5e5;
      z-index: 1000;
      font-size: 0.9rem;
      font-weight: 600;
      height: 56px;
    }
    .tab-nav button {
      flex-grow: 1;
      background: none;
      border: none;
      color: #444;
      padding: 8px 0 6px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: color 0.3s ease;
      font-weight: 600;
    }
    .tab-nav button svg {
      height: 22px;
      width: 22px;
      margin-bottom: 2px;
      stroke-width: 2;
      stroke: currentColor;
      fill: none;
    }
    .tab-nav button.active {
      color: #ef4444;
      border-top: 3px solid #ef4444;
    }
    .tab-content {
      max-width: 3xl;
      margin: 1rem auto 72px auto;
      padding: 0 1rem;
    }
    /* Friend card styles */
    .friend-card {
      background-color: #fff;
      padding: 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      position: relative;
    }
    .friend-card:hover {
      background-color: #f3f4f6;
    }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      position: absolute;
      bottom: 12px;
      left: 52px;
      border: 2px solid white;
    }
    .status-online {
      background-color: #22c55e;
    }
    .status-offline {
      background-color: #9ca3af;
    }
    .unread-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #ef4444;
      color: white;
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 9999px;
    }
    /* Notification */
    .notification {
      position: fixed;
      top: 80px;
      right: 20px;
      background-color: #fff;
      color: #1a1a1a;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 10000;
      display: none;
      max-width: 300px;
    }
    .notification.show {
      display: block;
      animation: fadeOut 5s forwards;
    }
    @keyframes fadeOut {
      0% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }
    /* Floating Add Friend Pill Button */
    #add-friend-btn {
      position: fixed;
      bottom: 60px; /* above tab nav */
      right: 16px;
      background-color: #ef4444;
      color: white;
      height: 48px;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 16px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      cursor: pointer;
      z-index: 1100;
      border: none;
      font-weight: 700;
      font-size: 1rem;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #add-friend-btn:hover {
      background-color: #dc2626;
    }
    #add-friend-btn svg {
      height: 20px;
      width: 20px;
      stroke-width: 3;
      stroke: white;
      fill: none;
    }
    /* Modal Styles */
    #add-friend-modal {
      display: none;
      position: fixed;
      z-index: 1200;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }
    #add-friend-modal.show {
      display: flex;
    }
    #add-friend-modal .modal-content {
      background: white;
      border-radius: 8px;
      max-width: 400px;
      width: 100%;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      position: relative;
    }
    #add-friend-modal .modal-header {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }
    #add-friend-modal label {
      font-weight: 600;
      display: block;
      margin-bottom: 0.25rem;
    }
    #add-friend-modal input[type="email"] {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    #add-friend-modal button {
      background-color: #ef4444;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #add-friend-modal button:hover {
      background-color: #dc2626;
    }
    #add-friend-modal .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 1.5rem;
      font-weight: 700;
      background: none;
      border: none;
      cursor: pointer;
      color: #555;
    }
    #add-friend-result {
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

  <!-- Loader -->
  <div id="loader-overlay" class="loader-container" role="alert" aria-live="assertive">
    <div class="animate-spin h-10 w-10 border-4 border-red-500 border-t-transparent rounded-full" aria-label="Loading"></div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification" role="alert" aria-live="polite">
    <p id="notification-message"></p>
  </div>

  <!-- Header -->
  <header class="fixed top-0 w-full bg-white shadow z-10 p-4 flex justify-between items-center">
    <div class="flex items-center gap-2">
      <button id="menu-btn" aria-label="Toggle Menu">
        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" >
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/>
        </svg>
      </button>
      <h1 class="text-xl font-bold text-red-500">Chaxo</h1>
    </div>
    <input type="text" placeholder="Search..." class="border px-3 py-1 rounded-full text-sm bg-gray-100 w-40 sm:w-64 focus:outline-none" aria-label="Search friends"/>
    <img id="user-pic" class="w-8 h-8 rounded-full border" src="https://www.gravatar.com/avatar?d=mp" alt="User Profile Picture" />
  </header>

  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar" aria-label="Sidebar Navigation">
    <a href="home.html" class="block py-2 text-gray-700 hover:text-red-500" tabindex="0">Home</a>
    <a href="friends.html" class="block py-2 text-red-500 font-bold" tabindex="0" aria-current="page">Friends</a>
    <a href="groups.html" class="block py-2 text-gray-700 hover:text-red-500" tabindex="0">Groups</a>
    <a href="statuses.html" class="block py-2 text-gray-700 hover:text-red-500" tabindex="0">Statuses</a>
    <a href="calls.html" class="block py-2 text-gray-700 hover:text-red-500" tabindex="0">Calls</a>
    <a href="#" id="sign-out" class="block py-2 text-gray-700 hover:text-red-500" tabindex="0">Sign Out</a>
  </aside>

  <!-- Main content area where tab content will show -->
  <main class="tab-content" id="tab-content" tabindex="0" aria-live="polite" aria-atomic="true">
    <!-- Default to Friends tab content -->
    <section id="friends-tab" class="tab-panel">
      <h2 class="text-2xl font-semibold mb-4">Your Friends</h2>
      <section id="friends-list" class="space-y-4" aria-label="Friends List"></section>
      <p id="no-friends-message" class="text-center text-gray-500 mt-4 hidden">No friends to show yet.</p>
    </section>
    <section id="groups-tab" class="tab-panel hidden">
      <h2 class="text-2xl font-semibold mb-4">Groups</h2>
      <p>Groups content goes here.</p>
    </section>
    <section id="statuses-tab" class="tab-panel hidden">
      <h2 class="text-2xl font-semibold mb-4">Statuses</h2>
      <p>Statuses content goes here.</p>
    </section>
    <section id="calls-tab" class="tab-panel hidden">
      <h2 class="text-2xl font-semibold mb-4">Calls</h2>
      <p>Calls content goes here.</p>
    </section>
  </main>

  <!-- Floating Add Friend Pill Button -->
  <button id="add-friend-btn" aria-label="Add Friend">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" >
      <path d="M12 5v14m-7-7h14" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    Add Friend
  </button>

  <!-- Add Friend Modal -->
  <div id="add-friend-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="-1">
    <div class="modal-content">
      <button class="close-btn" id="modal-close-btn" aria-label="Close Modal">&times;</button>
      <h3 id="modal-title" class="modal-header">Add Friend</h3>
      <form id="add-friend-form">
        <label for="friend-email">Friend's Registered Email</label>
        <input type="email" id="friend-email" name="friend-email" required placeholder="email@example.com" autocomplete="email" />
        <button type="submit">Add</button>
      </form>
      <p id="add-friend-result" role="alert" aria-live="assertive"></p>
    </div>
  </div>

  <!-- Firebase scripts and main script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
    import { getDatabase, ref, get, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97YHMSHL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    // Elements
    const loader = document.getElementById("loader-overlay");
    const friendsList = document.getElementById("friends-list");
    const userPic = document.getElementById("user-pic");
    const noFriendsMessage = document.getElementById("no-friends-message");
    const notification = document.getElementById("notification");
    const notificationMsg = document.getElementById("notification-message");

    const sidebar = document.getElementById("sidebar");
    const menuBtn = document.getElementById("menu-btn");
    const signOutBtn = document.getElementById("sign-out");

    const addFriendBtn = document.getElementById("add-friend-btn");
    const addFriendModal = document.getElementById("add-friend-modal");
    const modalCloseBtn = document.getElementById("modal-close-btn");
    const addFriendForm = document.getElementById("add-friend-form");
    const addFriendResult = document.getElementById("add-friend-result");

    const tabButtons = document.querySelectorAll(".tab-nav button");
    const tabPanels = document.querySelectorAll(".tab-panel");

    // Loader control
    function showLoader(show) {
      loader.style.display = show ? "flex" : "none";
    }

    // Notification
    function showNotification(text) {
      notificationMsg.textContent = text;
      notification.classList.add("show");
      setTimeout(() => notification.classList.remove("show"), 5000);
    }

    // Render friend card
    function renderFriend(uid, data, online, unreadCount, lastMessage) {
      const div = document.createElement("div");
      div.className = "friend-card";
      div.tabIndex = 0;
      div.setAttribute("role", "button");
      div.setAttribute("aria-pressed", "false");
      div.innerHTML = `
        <img src="${data.photoURL || 'https://www.gravatar.com/avatar?d=mp'}" class="w-12 h-12 rounded-full mr-4" alt="${data.name || 'Friend'} profile picture" />
        <div>
          <h3 class="font-semibold">${data.name || 'Friend'}</h3>
          <p class="text-sm text-gray-600">${lastMessage || 'No messages yet'}</p>
        </div>
        <div class="status-indicator ${online ? 'status-online' : 'status-offline'}" aria-label="${online ? 'Online' : 'Offline'}"></div>
        ${unreadCount > 0 ? `<span class="unread-badge" aria-label="${unreadCount} unread messages">${unreadCount}</span>` : ""}
      `;
      div.addEventListener("click", () => {
        window.location.href = `chat.html?uid=${uid}`;
      });
      div.addEventListener("keypress", e => {
        if(e.key === "Enter" || e.key === " ") {
          div.click();
        }
      });
      friendsList.appendChild(div);
    }

    // Presence tracking
    function setupPresence(uid) {
      const connectedRef = ref(db, ".info/connected");
      const presenceRef = ref(db, `users/${uid}/presence`);
      onValue(connectedRef, snap => {
        if (snap.val() === true) {
          set(presenceRef, "online");
          onDisconnect(presenceRef).set("offline");
        }
      });
    }

    // Load friends from chats and render
    async function loadFriends(uid) {
      showLoader(true);
      const chatsRef = ref(db, "chats");
      onValue(chatsRef, async (snapshot) => {
        friendsList.innerHTML = "";
        const chats = snapshot.val();
        if (!chats) {
          noFriendsMessage.classList.remove("hidden");
          showLoader(false);
          return;
        }
        let hasFriends = false;
        for (const chatId in chats) {
          const chat = chats[chatId];
          if (!chat.participants?.[uid]) continue;
          for (const friendUid in chat.participants) {
            if (friendUid === uid) continue;
            hasFriends = true;
            const userRef = ref(db, `users/${friendUid}`);
            const userSnap = await get(userRef);
            const userData = userSnap.exists() ? userSnap.val() : {};
            const presenceRef = ref(db, `users/${friendUid}/presence`);
            onValue(presenceRef, (presenceSnap) => {
              const online = presenceSnap.val() === "online";
              renderFriend(friendUid, userData, online, 0, "Let's chat!");
            });
          }
        }
        noFriendsMessage.classList.toggle("hidden", hasFriends);
        showLoader(false);
      });
    }

    // Sign out handler
    function handleSignOut() {
      showLoader(true);
      signOut(auth).then(() => {
        window.location.href = "login.html";
      }).catch(() => {
        showNotification("Sign out failed.");
      }).finally(() => showLoader(false));
    }

    // Sidebar toggle
    menuBtn.addEventListener("click", () => {
      sidebar.classList.toggle("open");
    });
    signOutBtn.addEventListener("click", handleSignOut);

    // Tab switching logic
    function activateTab(tabName) {
      tabPanels.forEach(panel => {
        panel.classList.toggle("hidden", panel.id !== tabName + "-tab");
      });
      tabButtons.forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tabName);
      });
    }

    // Create the tab buttons dynamically in JS to keep html clean
    // We'll create the tab nav here:
    const tabNav = document.createElement("nav");
    tabNav.className = "tab-nav";
    tabNav.setAttribute("role", "tablist");
    const tabs = [
      {name: "chat", label: "Chat", icon: `<path d="M21 11.5a8.38 8.38 0 0 1-1.9 5.4L21 21l-4.1-1.9a8.38 8.38 0 0 1-5.4 1.9A8.5 8.5 0 1 1 21 11.5z"/>`},
      {name: "groups", label: "Groups", icon: `<circle cx="12" cy="12" r="3" /><path d="M17.5 6.5L22 11l-4.5 4.5"/>`},
      {name: "statuses", label: "Statuses", icon: `<circle cx="12" cy="12" r="3" /><path d="M6.5 17.5L11 22l4.5-4.5"/>`},
      {name: "calls", label: "Calls", icon: `<path d="M2 3h20v18H2z"/>`},
    ];
    tabs.forEach(tab => {
      const btn = document.createElement("button");
      btn.setAttribute("role", "tab");
      btn.setAttribute("aria-selected", "false");
      btn.setAttribute("tabindex", "-1");
      btn.dataset.tab = tab.name;
      btn.innerHTML = `
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">${tab.icon}</svg>
        ${tab.label}
      `;
      btn.addEventListener("click", () => {
        activateTab(tab.name);
        btn.setAttribute("aria-selected", "true");
        btn.tabIndex = 0;
        // Focus tab content main
        document.getElementById("tab-content").focus();
      });
      tabNav.appendChild(btn);
    });
    document.body.appendChild(tabNav);

    // Activate default tab chat
    activateTab("chat");
    tabNav.querySelector("button").setAttribute("aria-selected", "true");
    tabNav.querySelector("button").tabIndex = 0;

    // Add Friend Modal Controls
    addFriendBtn.addEventListener("click", () => {
      addFriendModal.classList.add("show");
      addFriendResult.textContent = "";
      addFriendForm.reset();
      document.getElementById("friend-email").focus();
    });
    modalCloseBtn.addEventListener("click", () => {
      addFriendModal.classList.remove("show");
    });
    addFriendModal.addEventListener("click", e => {
      if (e.target === addFriendModal) addFriendModal.classList.remove("show");
    });
    window.addEventListener("keydown", e => {
      if (e.key === "Escape") addFriendModal.classList.remove("show");
    });

    // Add Friend form submission
    addFriendForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = e.target["friend-email"].value.trim().toLowerCase();
      addFriendResult.style.color = "inherit";
      addFriendResult.textContent = "";
      if (!email) {
        addFriendResult.textContent = "Please enter a valid email.";
        return;
      }
      showLoader(true);
      try {
        const usersRef = ref(db, "users");
        const snapshot = await get(usersRef);
        if (!snapshot.exists()) {
          addFriendResult.textContent = "No users found in database.";
          showLoader(false);
          return;
        }
        const users = snapshot.val();
        let foundUid = null;
        for (const uid in users) {
          if (users[uid].email && users[uid].email.toLowerCase() === email) {
            foundUid = uid;
            break;
          }
        }
        if (!foundUid) {
          addFriendResult.textContent = "User with that email not found.";
          showLoader(false);
          return;
        }
        const currentUser = auth.currentUser;
        if (!currentUser) {
          addFriendResult.textContent = "User not authenticated.";
          showLoader(false);
          return;
        }
        if (foundUid === currentUser.uid) {
          addFriendResult.textContent = "You cannot add yourself.";
          showLoader(false);
          return;
        }
        // Add to current user's friends list
        const friendsRef = ref(db, `friends/${currentUser.uid}/${foundUid}`);
        await set(friendsRef, true);
        // Reciprocal friend
        const reciprocalRef = ref(db, `friends/${foundUid}/${currentUser.uid}`);
        await set(reciprocalRef, true);

        addFriendResult.style.color = "green";
        addFriendResult.textContent = "Friend added successfully!";
        addFriendForm.reset();
        loadFriends(currentUser.uid);
      } catch (err) {
        console.error(err);
        addFriendResult.style.color = "red";
        addFriendResult.textContent = "Error adding friend. Try again.";
      } finally {
        showLoader(false);
      }
    });

    // Auth check
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      showLoader(true);
      const userRef = ref(db, `users/${user.uid}`);
      const userSnap = await get(userRef);
      if (userSnap.exists()) {
        const userData = userSnap.val();
        userPic.src = userData.photoURL || "https://www.gravatar.com/avatar?d=mp";
        setupPresence(user.uid);
        loadFriends(user.uid);
      } else {
        showNotification("User data not found.");
      }
      showLoader(false);
    });

  </script>

</body>
</html>
