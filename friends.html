<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chaxo - Friends</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f9f9f9;
      color: #1a1a1a;
    }
    .sidebar {
      width: 240px;
      position: fixed;
      top: 0;
      left: -240px;
      height: 100%;
      background-color: #ffffff;
      transition: left 0.3s ease;
      z-index: 1000;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    }
    .sidebar.open {
      left: 0;
    }
    .loader-container {
      display: none;
      justify-content: center;
      align-items: center;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255,255,255,0.8);
      z-index: 9999;
    }
    .bottom-nav {
      display: flex;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #ffffff;
      border-top: 1px solid #e5e5e5;
      z-index: 1000;
      padding: 8px 0;
    }
    .bottom-nav a {
      flex: 1;
      text-align: center;
      color: #444;
      padding: 8px;
      font-size: 0.8rem;
    }
    .bottom-nav a.active {
      color: #ef4444;
    }
    .friend-card {
      background-color: #ffffff;
      padding: 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      position: relative;
    }
    .friend-card:hover {
      background-color: #f3f4f6;
    }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      position: absolute;
      bottom: 10px;
      left: 50px;
      border: 2px solid white;
    }
    .status-online {
      background-color: #22c55e;
    }
    .status-offline {
      background-color: #9ca3af;
    }
    .unread-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #ef4444;
      color: white;
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 9999px;
    }
    .notification {
      position: fixed;
      top: 80px;
      right: 20px;
      background-color: #ffffff;
      color: #1a1a1a;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 10000;
      display: none;
      max-width: 300px;
    }
    .notification.show {
      display: block;
      animation: fadeOut 5s forwards;
    }
    @keyframes fadeOut {
      0% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader-overlay" class="loader-container">
    <div class="animate-spin h-10 w-10 border-4 border-red-500 border-t-transparent rounded-full"></div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification">
    <p id="notification-message"></p>
  </div>

  <!-- Header -->
  <header class="fixed top-0 w-full bg-white shadow z-10 p-4 flex justify-between items-center">
    <div class="flex items-center gap-2">
      <button id="menu-btn">
        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/>
        </svg>
      </button>
      <h1 class="text-xl font-bold text-red-500">Chaxo</h1>
    </div>
    <input type="text" placeholder="Search..." class="border px-3 py-1 rounded-full text-sm bg-gray-100 w-40 sm:w-64 focus:outline-none" />
    <img id="user-pic" class="w-8 h-8 rounded-full border" src="https://www.gravatar.com/avatar?d=mp" />
  </header>

  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar p-4">
    <a href="home.html" class="block py-2 text-gray-700 hover:text-red-500">Home</a>
    <a href="friends.html" class="block py-2 text-red-500 font-bold">Friends</a>
    <a href="tutors.html" class="block py-2 text-gray-700 hover:text-red-500">Tutors</a>
    <a href="admin-login.php" class="block py-2 text-gray-700 hover:text-red-500">Admin</a>
    <a href="#" id="sign-out" class="block py-2 text-gray-700 hover:text-red-500">Sign Out</a>
  </aside>

  <!-- Main -->
  <main class="pt-20 pb-20 px-4 max-w-3xl mx-auto">
    <h2 class="text-2xl font-semibold mb-4">Your Friends</h2>
    <section id="friends-list" class="space-y-4"></section>
    <p id="no-friends-message" class="text-center text-gray-500 mt-4 hidden">No friends to show yet.</p>
  </main>

  <!-- Bottom Nav -->
  <!-- Bottom Nav -->
<nav class="bottom-nav">
  <a href="chat.html" class="active">
    <svg class="mx-auto w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 16V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2h4l4 4 4-4h4a2 2 0 002-2z"/>
    </svg>
    <span>Chat</span>
  </a>
  <a href="groups.html">
    <svg class="mx-auto w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5V9a2 2 0 00-2-2h-4a2 2 0 00-2 2v11zM9 20h5V11a2 2 0 00-2-2H8a2 2 0 00-2 2v9h3zM2 20h3v-6a2 2 0 00-2-2H2v8z"/>
    </svg>
    <span>Groups</span>
  </a>
  <a href="statuses.html">
    <svg class="mx-auto w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3M12 2a10 10 0 1010 10A10 10 0 0012 2z"/>
    </svg>
    <span>Status</span>
  </a>
  <a href="calls.html">
    <svg class="mx-auto w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0020 7.764v8.472a1 1 0 00-1.447.91L15 15M4 4h16a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2z"/>
    </svg>
    <span>Calls</span>
  </a>
</nav>


  <!-- Firebase Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
    import { getDatabase, ref, get, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97YHMSHL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    const loader = document.getElementById("loader-overlay");
    const friendsList = document.getElementById("friends-list");
    const userPic = document.getElementById("user-pic");
    const noFriendsMessage = document.getElementById("no-friends-message");
    const notification = document.getElementById("notification");
    const notificationMsg = document.getElementById("notification-message");

    function showLoader(show) {
      loader.style.display = show ? "flex" : "none";
    }

    function showNotification(text) {
      notificationMsg.textContent = text;
      notification.classList.add("show");
      setTimeout(() => notification.classList.remove("show"), 5000);
    }

    function renderFriend(uid, data, online, unreadCount, lastMessage) {
      const div = document.createElement("div");
      div.className = "friend-card";
      div.innerHTML = `
        <img src="${data.photoURL || 'https://www.gravatar.com/avatar?d=mp'}" class="w-12 h-12 rounded-full mr-4">
        <div>
          <h3 class="font-semibold">${data.name || 'Friend'}</h3>
          <p class="text-sm text-gray-600">${lastMessage || 'No messages yet'}</p>
        </div>
        <div class="status-indicator ${online ? 'status-online' : 'status-offline'}"></div>
        ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ""}
      `;
      div.addEventListener("click", () => {
        window.location.href = `chat.html?uid=${uid}`;
      });
      friendsList.appendChild(div);
    }

    function setupPresence(uid) {
      const connectedRef = ref(db, ".info/connected");
      const presenceRef = ref(db, `users/${uid}/presence`);
      onValue(connectedRef, snap => {
        if (snap.val() === true) {
          set(presenceRef, "online");
          onDisconnect(presenceRef).set("offline");
        }
      });
    }

    async function loadFriends(uid) {
      const chatsRef = ref(db, "chats");
      onValue(chatsRef, async (snapshot) => {
        friendsList.innerHTML = "";
        const chats = snapshot.val();
        if (!chats) {
          noFriendsMessage.classList.remove("hidden");
          return;
        }
        let hasFriends = false;
        for (const chatId in chats) {
          const chat = chats[chatId];
          if (!chat.participants?.[uid]) continue;
          for (const friendUid in chat.participants) {
            if (friendUid === uid) continue;
            hasFriends = true;
            const userRef = ref(db, `users/${friendUid}`);
            const userSnap = await get(userRef);
            const userData = userSnap.exists() ? userSnap.val() : {};
            const presenceRef = ref(db, `users/${friendUid}/presence`);
            onValue(presenceRef, (presenceSnap) => {
              const online = presenceSnap.val() === "online";
              renderFriend(friendUid, userData, online, 0, "Let's chat!");
            });
          }
        }
        noFriendsMessage.classList.toggle("hidden", hasFriends);
      });
    }

    function handleSignOut() {
      showLoader(true);
      signOut(auth).then(() => {
        window.location.href = "login.html";
      }).catch(err => {
        showNotification("Sign out failed.");
      }).finally(() => showLoader(false));
    }

    // Sidebar toggle
    document.getElementById("menu-btn").addEventListener("click", () => {
      document.getElementById("sidebar").classList.toggle("open");
    });
    document.getElementById("sign-out").addEventListener("click", handleSignOut);
    document.getElementById("sign-out-bottom").addEventListener("click", handleSignOut);

    onAuthStateChanged(auth, async (user) => {
      if (!user) return (window.location.href = "login.html");
      showLoader(true);
      const userRef = ref(db, `users/${user.uid}`);
      const userSnap = await get(userRef);
      if (userSnap.exists()) {
        const userData = userSnap.val();
        userPic.src = userData.photoURL || "https://www.gravatar.com/avatar?d=mp";
        setupPresence(user.uid);
        loadFriends(user.uid);
      }
      showLoader(false);
    });
  </script>
</body>
</html>
