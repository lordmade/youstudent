<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Nexus - Explore</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    :root {
      --primary-color: #6366F1;
      --border: #EFF3F4;
      --hover-bg: #F7F9F9;
      --text-dark: #0F1419;
      --text-light: #536471;
      --like-red: #F91880;
      --danger: #e0245e;
      --success: #10b981;
    }
    
    body {
      background: white;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: var(--text-dark);
      overflow-y: scroll;
    }

    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }
    
    .search-input, .post-text, .trend-text {
      -webkit-user-select: text;
      user-select: text;
    }
    
    html { touch-action: pan-x pan-y; }

    img, video, .user-avatar, .post-image, .trend-avatar {
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      user-select: none !important;
      -webkit-touch-callout: none !important;
      -webkit-tap-highlight-color: transparent;
      pointer-events: auto;
      -webkit-user-drag: none;
      user-drag: none;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: 80px 1fr;
      max-width: 1265px;
      margin: 0 auto;
      min-height: 100vh;
    }
    
    @media (min-width: 640px) { .layout-grid { grid-template-columns: 275px 1fr; } }
    @media (min-width: 1024px) { .layout-grid { grid-template-columns: 275px 600px 1fr; } }

    .sidebar {
      position: sticky;
      top: 0;
      height: 100vh;
      padding: 0.5rem 1rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border-right: 1px solid var(--border);
    }
    
    .logo-box { padding: 10px; margin-bottom: 10px; }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      padding: 0.9rem;
      border-radius: 9999px;
      cursor: pointer;
      font-size: 1.25rem;
      color: var(--text-dark);
      width: fit-content;
      transition: 0.2s;
    }
    
    .nav-item:hover { background-color: var(--hover-bg); color: var(--primary-color); }
    .nav-item.active { color: var(--primary-color); font-weight: 600; }
    .nav-text { display: none; }
    
    @media (min-width: 640px) { .nav-text { display: block; } }

    .explore-header {
      position: sticky;
      top: 0;
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(12px);
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      z-index: 10;
    }

    .search-container {
      position: relative;
      width: 100%;
    }
    
    .search-box {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      background: #f7f9f9;
      border: 1px solid var(--border);
      border-radius: 9999px;
      font-size: 1rem;
      outline: none;
      transition: all 0.2s;
    }
    
    .search-box:focus {
      background: white;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .search-icon {
      position: absolute;
      left: 0.875rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
      pointer-events: none;
    }

    .search-filters {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      overflow-x: auto;
      scrollbar-width: none;
    }
    
    .search-filters::-webkit-scrollbar { display: none; }
    
    .filter-chip {
      padding: 0.4rem 1rem;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 9999px;
      font-size: 0.9rem;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      color: var(--text-light);
    }
    
    .filter-chip:hover { background: var(--hover-bg); }
    .filter-chip.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .main-content { 
      border-right: 1px solid var(--border); 
      max-width: 600px; 
      width: 100%; 
      min-height: 100vh;
    }

    /* Trending Section */
    .section-header {
      padding: 1rem;
      font-size: 1.25rem;
      font-weight: 800;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .trend-card {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .trend-card:hover { background: var(--hover-bg); }
    
    .trend-rank {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-light);
      min-width: 1.5rem;
    }
    
    .trend-info { flex: 1; }
    
    .trend-category {
      font-size: 0.8rem;
      color: var(--text-light);
      margin-bottom: 0.25rem;
    }
    
    .trend-title {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 0.25rem;
      color: var(--text-dark);
    }
    
    .trend-posts {
      font-size: 0.8rem;
      color: var(--text-light);
    }
    
    .trend-image {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      object-fit: cover;
      background: #e1e8ed;
    }

    /* Users to Follow */
    .user-card {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .user-card:hover { background: var(--hover-bg); }
    
    .user-info { flex: 1; min-width: 0; }
    
    .user-name {
      font-weight: 700;
      font-size: 1rem;
      color: var(--text-dark);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .user-handle {
      font-size: 0.9rem;
      color: var(--text-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .follow-btn {
      padding: 0.4rem 1rem;
      background: var(--text-dark);
      color: white;
      border: none;
      border-radius: 9999px;
      font-weight: 700;
      font-size: 0.9rem;
      cursor: pointer;
      transition: 0.2s;
      white-space: nowrap;
    }
    
    .follow-btn:hover { background: rgba(0,0,0,0.8); }
    
    .follow-btn.following {
      background: transparent;
      color: var(--text-dark);
      border: 1px solid var(--border);
    }
    
    .follow-btn.following:hover {
      background: rgba(255,0,0,0.1);
      color: var(--danger);
      border-color: var(--danger);
    }

    /* Search Results */
    .search-results {
      display: none;
    }
    
    .search-results.active { display: block; }
    
    .result-section {
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    
    .result-section-title {
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .search-result-item {
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .search-result-item:hover { background: var(--hover-bg); }
    
    .result-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .result-content { flex: 1; }
    
    .result-title { font-weight: 700; }
    
    .result-subtitle { font-size: 0.9rem; color: var(--text-light); }
    
    .result-meta { font-size: 0.8rem; color: var(--text-light); margin-top: 0.25rem; }

    .right-sidebar { 
      display: none; 
      padding: 1rem;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }
    
    @media (min-width: 1024px) { .right-sidebar { display: block; } }

    .sidebar-card {
      background: #f7f9f9;
      border-radius: 16px;
      margin-bottom: 1rem;
      overflow: hidden;
    }
    
    .sidebar-card-header {
      padding: 1rem;
      font-size: 1.25rem;
      font-weight: 800;
      border-bottom: 1px solid var(--border);
    }
    
    .sidebar-card-item {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .sidebar-card-item:hover { background: rgba(0,0,0,0.03); }
    
    .sidebar-card-item:last-child { border-bottom: none; }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid var(--border);
      z-index: 50;
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    .bottom-nav-inner {
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 56px;
      max-width: 500px;
      margin: 0 auto;
    }
    
    .nav-bottom-item {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 56px;
      height: 56px;
      color: var(--text-dark);
      position: relative;
      transition: color 0.2s;
    }
    
    .nav-bottom-item:hover, .nav-bottom-item:focus { color: var(--primary-color); }
    .nav-bottom-item.active { color: var(--primary-color); }
    .nav-bottom-item.active::after {
      content: '';
      position: absolute;
      bottom: 6px;
      width: 24px;
      height: 3px;
      background: var(--primary-color);
      border-radius: 9999px;
    }

    @media (max-width: 639px) {
      .sidebar { display: none; }
      .layout-grid { grid-template-columns: 1fr; }
      .main-content { padding-bottom: calc(5.5rem + env(safe-area-inset-bottom)); }
    }

    #toast {
      position: fixed;
      bottom: calc(80px + env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 12px 24px;
      border-radius: 9999px;
      z-index: 200;
      opacity: 0;
      transition: opacity 0.4s;
      pointer-events: none;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    #toast.show { opacity: 1; }
    #toast.success { background: var(--success); }
    #toast.error { background: var(--danger); }

    .loading-spinner {
      display: flex;
      justify-content: center;
      padding: 2rem;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .empty-state {
      text-align: center;
      padding: 4rem 1rem;
      color: var(--text-light);
    }
    
    .empty-state-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      color: var(--border);
    }

    .show-more {
      padding: 1rem;
      color: var(--primary-color);
      cursor: pointer;
      text-align: center;
      font-size: 0.9rem;
    }
    
    .show-more:hover { background: var(--hover-bg); }
  </style>
</head>
<body>
  <div id="toast"></div>

  <div class="layout-grid">
    <!-- Left Sidebar -->
    <aside class="sidebar">
      <div>
        <div class="logo-box">
          <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="40" height="40" rx="12" fill="#6366F1"/>
            <path d="M12 20L18 26L28 14" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="28" cy="26" r="4" fill="white"/>
          </svg>
        </div>
        <div class="nav-item" onclick="window.location.href='index.html'">
          <i data-feather="home"></i> <span class="nav-text">Home</span>
        </div>
        <div class="nav-item active" onclick="window.location.href='explore.html'">
          <i data-feather="hash"></i> <span class="nav-text">Explore</span>
        </div>
        <div class="nav-item" onclick="window.location.href='messages.html'">
          <i data-feather="message-circle"></i> <span class="nav-text">Messages</span>
        </div>
        <div class="nav-item" onclick="window.location.href='profile.html'">
          <i data-feather="user"></i> <span class="nav-text">Profile</span>
        </div>
      </div>
      <div class="nav-item" id="logout-btn">
        <i data-feather="log-out"></i> <span class="nav-text">Logout</span>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="explore-header">
        <div class="search-container">
          <i data-feather="search" class="search-icon" style="width:18px;height:18px;"></i>
          <input type="text" class="search-box" id="search-input" placeholder="Search Nexus">
        </div>
        <div class="search-filters">
          <button class="filter-chip active" data-filter="top">Top</button>
          <button class="filter-chip" data-filter="latest">Latest</button>
          <button class="filter-chip" data-filter="people">People</button>
          <button class="filter-chip" data-filter="media">Media</button>
        </div>
      </div>

      <!-- Default Explore Content -->
      <div id="explore-content">
        <!-- Trending Section -->
        <div class="section-header">
          <span>Trends for you</span>
          <i data-feather="settings" style="width:20px;height:20px;color:var(--primary-color);cursor:pointer;"></i>
        </div>
        <div id="trends-list">
          <div class="loading-spinner">
            <div class="spinner"></div>
          </div>
        </div>
        <div class="show-more" onclick="loadMoreTrends()">Show more</div>

        <!-- Who to Follow Section -->
        <div class="section-header" style="margin-top:1rem;">
          <span>Who to follow</span>
        </div>
        <div id="suggested-users">
          <div class="loading-spinner">
            <div class="spinner"></div>
          </div>
        </div>
        <div class="show-more" onclick="window.location.href='connect.html'">Show more</div>
      </div>

      <!-- Search Results -->
      <div id="search-results" class="search-results">
        <div class="result-section" id="results-people" style="display:none;">
          <div class="result-section-title">People</div>
          <div id="people-list"></div>
        </div>
        <div class="result-section" id="results-posts" style="display:none;">
          <div class="result-section-title">Posts</div>
          <div id="posts-list"></div>
        </div>
        <div id="no-results" class="empty-state" style="display:none;">
          <i data-feather="search" class="empty-state-icon"></i>
          <h3 style="font-size:1.25rem;font-weight:700;margin-bottom:0.5rem;color:var(--text-dark);">No results found</h3>
          <p>Try searching for something else</p>
        </div>
      </div>
    </main>

    <!-- Right Sidebar -->
    <aside class="right-sidebar">
      <div class="sidebar-card">
        <div class="sidebar-card-header">What's happening</div>
        <div id="sidebar-trends">
          <div class="sidebar-card-item">
            <div style="font-size:0.8rem;color:var(--text-light);">Technology · Trending</div>
            <div style="font-weight:700;margin:0.25rem 0;">#WebDevelopment</div>
            <div style="font-size:0.8rem;color:var(--text-light);">54.2K posts</div>
          </div>
          <div class="sidebar-card-item">
            <div style="font-size:0.8rem;color:var(--text-light);">Entertainment · Trending</div>
            <div style="font-weight:700;margin:0.25rem 0;">New Release</div>
            <div style="font-size:0.8rem;color:var(--text-light);">125K posts</div>
          </div>
          <div class="sidebar-card-item">
            <div style="font-size:0.8rem;color:var(--text-light);">Sports · Trending</div>
            <div style="font-weight:700;margin:0.25rem 0;"> Champions League</div>
            <div style="font-size:0.8rem;color:var(--text-light);">892K posts</div>
          </div>
        </div>
      </div>

      <div class="sidebar-card">
        <div class="sidebar-card-header">Topics to follow</div>
        <div class="sidebar-card-item" style="display:flex;align-items:center;justify-content:space-between;">
          <div>
            <div style="font-weight:700;">Technology</div>
            <div style="font-size:0.8rem;color:var(--text-light);">All about tech</div>
          </div>
          <button class="follow-btn">Follow</button>
        </div>
        <div class="sidebar-card-item" style="display:flex;align-items:center;justify-content:space-between;">
          <div>
            <div style="font-weight:700;">Design</div>
            <div style="font-size:0.8rem;color:var(--text-light);">UI/UX, Graphics</div>
          </div>
          <button class="follow-btn">Follow</button>
        </div>
        <div class="sidebar-card-item" style="display:flex;align-items:center;justify-content:space-between;">
          <div>
            <div style="font-weight:700;">Science</div>
            <div style="font-size:0.8rem;color:var(--text-light);">Discoveries & Research</div>
          </div>
          <button class="follow-btn">Follow</button>
        </div>
      </div>

      <div style="padding:1rem;font-size:0.8rem;color:var(--text-light);">
        © 2024 Nexus · Privacy · Terms · Cookies
      </div>
    </aside>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav md:hidden">
    <div class="bottom-nav-inner">
      <a href="index.html" class="nav-bottom-item" id="bottom-home">
        <i data-feather="home" class="w-7 h-7"></i>
      </a>
      <a href="explore.html" class="nav-bottom-item active" id="bottom-explore">
        <i data-feather="hash" class="w-7 h-7"></i>
      </a>
      <a href="messages.html" class="nav-bottom-item" id="bottom-messages">
        <i data-feather="message-circle" style="width:28px;height:28px;"></i>
      </a>
      <a href="profile.html" class="nav-bottom-item" id="bottom-profile">
        <i data-feather="user" class="w-7 h-7"></i>
      </a>
    </div>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
    import { getDatabase, ref, onValue, get, query, orderByChild, limitToLast, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let searchFilter = 'top';
    let allPosts = [];
    let allUsers = [];

    // DOM Elements
    const searchInput = document.getElementById('search-input');
    const exploreContent = document.getElementById('explore-content');
    const searchResults = document.getElementById('search-results');
    const trendsList = document.getElementById('trends-list');
    const suggestedUsers = document.getElementById('suggested-users');

    // Auth State
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "signup.html";
        return;
      }
      currentUser = user;
      loadTrends();
      loadSuggestedUsers();
      loadAllData();
    });

    document.getElementById('logout-btn')?.addEventListener('click', () => signOut(auth));

    // Load all posts and users for search
    async function loadAllData() {
      // Load posts
      const postsRef = ref(db, 'posts');
      onValue(postsRef, (snapshot) => {
        allPosts = [];
        snapshot.forEach(child => {
          allPosts.push({ key: child.key, ...child.val() });
        });
      });

      // Load users
      const usersRef = ref(db, 'users');
      onValue(usersRef, (snapshot) => {
        allUsers = [];
        snapshot.forEach(child => {
          if (child.key !== currentUser?.uid) {
            allUsers.push({ uid: child.key, ...child.val() });
          }
        });
      });
    }

    // Generate trending topics from actual posts
    async function loadTrends() {
      const postsRef = query(ref(db, 'posts'), limitToLast(100));
      const snapshot = await get(postsRef);
      
      const hashtagCounts = {};
      const trends = [];

      snapshot.forEach(child => {
        const post = child.val();
        if (post.text) {
          const hashtags = post.text.match(/#[\w]+/g) || [];
          hashtags.forEach(tag => {
            hashtagCounts[tag.toLowerCase()] = (hashtagCounts[tag.toLowerCase()] || 0) + 1;
          });
        }
      });

      // Convert to array and sort
      const sortedTrends = Object.entries(hashtagCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([tag, count], index) => ({
          rank: index + 1,
          category: 'Trending in Nexus',
          title: tag,
          posts: `${(count / 1000).toFixed(1)}K`
        }));

      // Fallback trends if no hashtags found
      if (sortedTrends.length === 0) {
        sortedTrends.push(
          { rank: 1, category: 'Technology', title: '#Programming', posts: '12.5K' },
          { rank: 2, category: 'General', title: '#NexusApp', posts: '8.2K' },
          { rank: 3, category: 'Lifestyle', title: '#MorningVibes', posts: '5.1K' },
          { rank: 4, category: 'News', title: '#WorldNews', posts: '45K' },
          { rank: 5, category: 'Entertainment', title: '#Weekend', posts: '3.2K' }
        );
      }

      renderTrends(sortedTrends);
    }

    function renderTrends(trends) {
      trendsList.innerHTML = trends.map(trend => `
        <div class="trend-card" onclick="window.location.href='index.html?search=${encodeURIComponent(trend.title)}'">
          <div class="trend-rank">${trend.rank}</div>
          <div class="trend-info">
            <div class="trend-category">${trend.category}</div>
            <div class="trend-title">${trend.title}</div>
            <div class="trend-posts">${trend.posts} posts</div>
          </div>
          <div style="margin-left:auto;">
            <i data-feather="more-horizontal" style="width:18px;height:18px;color:var(--text-light);"></i>
          </div>
        </div>
      `).join('');
      feather.replace();
    }

    // Load suggested users
    async function loadSuggestedUsers() {
      const usersRef = query(ref(db, 'users'), limitToLast(10));
      const snapshot = await get(usersRef);
      
      const users = [];
      snapshot.forEach(child => {
        if (child.key !== currentUser?.uid) {
          users.push({ uid: child.key, ...child.val() });
        }
      });

      // Shuffle and take 3
      const shuffled = users.sort(() => 0.5 - Math.random()).slice(0, 3);
      renderSuggestedUsers(shuffled);
    }

    function renderSuggestedUsers(users) {
      if (users.length === 0) {
        suggestedUsers.innerHTML = '<div class="empty-state">No suggestions available</div>';
        return;
      }

      suggestedUsers.innerHTML = users.map(user => `
        <div class="user-card" onclick="window.location.href='profile.html?id=${user.uid}'">
          <img src="${user.photoURL || user.avatarUrl || 'https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png'}" 
               class="user-avatar" 
               style="width:48px;height:48px;border-radius:50%;object-fit:cover;"
               onerror="this.src='https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png'">
          <div class="user-info">
            <div class="user-name">${user.username || user.displayName || 'Anonymous'}</div>
            <div class="user-handle">@${(user.username || user.email?.split('@')[0] || 'user').toLowerCase()}</div>
          </div>
          <button class="follow-btn" onclick="event.stopPropagation(); toggleFollow(this, '${user.uid}')">Follow</button>
        </div>
      `).join('');
      feather.replace();
    }

    // Follow functionality
    window.toggleFollow = async function(btn, userId) {
      if (!currentUser) return;
      
      const followRef = ref(db, `following/${currentUser.uid}/${userId}`);
      const snapshot = await get(followRef);
      
      if (snapshot.exists()) {
        // Unfollow
        await set(followRef, null);
        btn.textContent = 'Follow';
        btn.classList.remove('following');
        showToast('Unfollowed user', 'success');
      } else {
        // Follow
        await set(followRef, { timestamp: Date.now() });
        btn.textContent = 'Following';
        btn.classList.add('following');
        showToast('Now following user', 'success');
      }
    };

    // Search functionality
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.trim().toLowerCase();
      
      if (query.length === 0) {
        exploreContent.style.display = 'block';
        searchResults.classList.remove('active');
        return;
      }

      exploreContent.style.display = 'none';
      searchResults.classList.add('active');
      performSearch(query);
    });

    function performSearch(query) {
      // Search users
      const matchedUsers = allUsers.filter(user => {
        const username = (user.username || '').toLowerCase();
        const displayName = (user.displayName || '').toLowerCase();
        const email = (user.email || '').toLowerCase();
        return username.includes(query) || displayName.includes(query) || email.includes(query);
      });

      // Search posts
      const matchedPosts = allPosts.filter(post => {
        const text = (post.text || '').toLowerCase();
        return text.includes(query);
      });

      // Render results
      const peopleSection = document.getElementById('results-people');
      const postsSection = document.getElementById('results-posts');
      const noResults = document.getElementById('no-results');

      if (matchedUsers.length === 0 && matchedPosts.length === 0) {
        peopleSection.style.display = 'none';
        postsSection.style.display = 'none';
        noResults.style.display = 'block';
      } else {
        noResults.style.display = 'none';
        
        if (matchedUsers.length > 0 && (searchFilter === 'top' || searchFilter === 'people')) {
          peopleSection.style.display = 'block';
          document.getElementById('people-list').innerHTML = matchedUsers.slice(0, 5).map(user => `
            <div class="search-result-item" onclick="window.location.href='profile.html?id=${user.uid}'">
              <img src="${user.photoURL || user.avatarUrl || 'https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png'}" 
                   class="result-avatar" 
                   onerror="this.src='https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png'">
              <div class="result-content">
                <div class="result-title">${user.username || user.displayName || 'Anonymous'}</div>
                <div class="result-subtitle">@${(user.username || user.email?.split('@')[0] || 'user').toLowerCase()}</div>
                ${user.bio ? `<div class="result-meta">${user.bio}</div>` : ''}
              </div>
            </div>
          `).join('');
        } else {
          peopleSection.style.display = 'none';
        }

        if (matchedPosts.length > 0 && (searchFilter === 'top' || searchFilter === 'latest' || searchFilter === 'media')) {
          postsSection.style.display = 'block';
          document.getElementById('posts-list').innerHTML = matchedPosts.slice(0, 5).map(post => `
            <div class="search-result-item" onclick="window.location.href='index.html?post=${post.key}'" style="align-items:flex-start;">
              <img src="${post.mediaUrl || 'https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png'}" 
                   class="result-avatar" 
                   style="${post.mediaUrl ? 'object-fit:cover;' : 'display:none;'}"
                   onerror="this.style.display='none'">
              <div class="result-content" style="flex:1;">
                <div class="result-title" style="font-size:0.9rem;font-weight:400;color:var(--text-dark);line-height:1.4;">
                  ${highlightText(post.text, query)}
                </div>
                <div class="result-meta" style="margin-top:0.5rem;display:flex;align-items:center;gap:1rem;">
                  <span><i data-feather="heart" style="width:14px;height:14px;vertical-align:middle;"></i> ${post.likes || 0}</span>
                  <span><i data-feather="message-circle" style="width:14px;height:14px;vertical-align:middle;"></i> ${post.commentCount || 0}</span>
                  <span>${new Date(post.timestamp).toLocaleDateString()}</span>
                </div>
              </div>
            </div>
          `).join('');
          feather.replace();
        } else {
          postsSection.style.display = 'none';
        }
      }
    }

    function highlightText(text, query) {
      if (!text) return '';
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<mark style="background:rgba(99,102,241,0.2);color:inherit;padding:0 2px;border-radius:2px;">$1</mark>');
    }

    // Filter chips
    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        searchFilter = chip.dataset.filter;
        
        if (searchInput.value.trim()) {
          performSearch(searchInput.value.trim().toLowerCase());
        }
      });
    });

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `show ${type}`;
      setTimeout(() => toast.classList.remove('show'), 2800);
    }

    window.loadMoreTrends = function() {
      showToast('More trends coming soon!', 'success');
    };

    // Initialize
    feather.replace();
  </script>
</body>
</html>
