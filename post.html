<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BanterBox Reels</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js"></script>
  <!-- Heroicons CDN -->
  <script src="https://unpkg.com/heroicons@2.1.5/dist/heroicons.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100vh; width: 100vw; background: black; overflow: hidden;
      font-family: 'Inter', 'Segoe UI', sans-serif;
    }
    body.dark {
      background: #111827;
    }
    .reel-container {
      height: 100vh; width: 100vw; scroll-snap-type: y mandatory; overflow-y: scroll; scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    .reel {
      height: 100vh; width: 100vw; position: relative; scroll-snap-align: start; display: flex;
      align-items: center; justify-content: center; background: #000;
    }
    .reel video {
      height: 100vh; width: 100vw; object-fit: cover; cursor: pointer; background: #000;
      position: absolute; top: 0; left: 0; z-index: 1;
    }
    .reel video[poster]:not(.playing) {
      opacity: 0.8; /* Slightly dim the poster for visual distinction */
    }
    .reel video.playing {
      opacity: 1;
    }
    .reel-overlay {
      position: absolute; bottom: 4rem; left: 1rem; color: white;
      text-shadow: 0 0 8px rgba(0, 0, 0, 0.8); max-width: 65%; z-index: 10;
    }
    .reel-user-info {
      display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;
    }
    .reel-user-info img {
      height: 40px; width: 40px; border-radius: 50%;
      border: 2px solid white; object-fit: cover;
    }
    .reel-user-info a {
      color: white; font-weight: 600; text-decoration: none;
    }
    .reel-user-info a:hover {
      color: #f87171;
    }
    .reel-caption {
      font-size: 0.9rem; line-height: 1.4;
      display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;
      overflow: hidden; text-overflow: ellipsis;
    }
    .reel-actions {
      position: absolute; right: 1rem; bottom: 4rem;
      display: flex; flex-direction: column; gap: 1.25rem; align-items: center; z-index: 10;
    }
    .reel-action-btn {
      background: rgba(255, 255, 255, 0.2); border: none; padding: 0.8rem;
      border-radius: 9999px; color: white; font-size: 1.5rem; cursor: pointer;
      transition: transform 0.2s, background 0.2s;
    }
    .reel-action-btn:hover {
      background: rgba(255, 255, 255, 0.3); transform: scale(1.1);
    }
    .reel-action-btn.reacted {
      color: #ef4444;
    }
    .reel-action-btn svg {
      width: 24px; height: 24px; stroke-width: 2;
    }
    .reel-action-btn.reacted svg {
      fill: #ef4444; stroke: #ef4444;
    }
    .reel-action-count {
      color: white; font-size: 0.85rem; font-weight: 500;
      text-align: center; text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
    }
    .reel-mute-toggle {
      position: absolute; bottom: 1rem; right: 1rem;
      background: rgba(0, 0, 0, 0.6); border-radius: 50%; padding: 0.5rem;
      color: white; cursor: pointer; z-index: 10;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .reel-mute-toggle:hover {
      background: rgba(0, 0, 0, 0.8); transform: scale(1.1);
    }
    .reel-mute-toggle svg {
      width: 24px; height: 24px; stroke-width: 2;
    }
    .home-btn {
      position: fixed; top: 1rem; left: 1rem; z-index: 50;
      background: rgba(255, 255, 255, 0.1); color: white;
      padding: 0.5rem 1rem; border-radius: 9999px;
      font-weight: bold; border: 1px solid white;
      text-decoration: none; transition: background 0.2s ease, transform 0.2s ease;
    }
    .home-btn:hover {
      background: rgba(255, 255, 255, 0.2); transform: translateY(-2px);
    }
    .home-btn svg {
      width: 20px; height: 20px; stroke-width: 2; display: inline-block; vertical-align: middle;
    }
    .modal {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center;
      z-index: 100;
    }
    .modal-content {
      background: white; border-radius: 12px; padding: 1rem; width: 90%; max-width: 400px;
      max-height: 80vh; overflow-y: auto;
    }
    .modal-content.dark {
      background: #374151; color: #e5e7eb;
    }
    .modal-content h2 {
      margin-top: 0; font-weight: bold; color: #111827;
    }
    .modal-content.dark h2 {
      color: #e5e7eb;
    }
    .comment {
      border-bottom: 1px solid #e5e7eb; padding: 0.5rem 0;
      display: flex; align-items: flex-start; gap: 0.75rem;
    }
    .modal-content.dark .comment {
      border-bottom: 1px solid #4b5563;
    }
    .comment img {
      width: 32px; height: 32px; border-radius: 9999px; object-fit: cover;
      border: 2px solid transparent; background: linear-gradient(to right, #ef4444, #f97316);
      padding: 2px;
    }
    .comment-content {
      flex-grow: 1;
    }
    .comment-username {
      font-weight: 600; font-size: 0.85rem; color: #111827;
    }
    .comment-username.dark {
      color: #e5e7eb;
    }
    .comment-text {
      font-size: 0.9rem; color: #374151;
    }
    .comment-text.dark {
      color: #d1d5db;
    }
    .comment-timestamp {
      font-size: 0.75rem; color: #6b7280;
    }
    .comment-timestamp.dark {
      color: #9ca3af;
    }
    textarea {
      width: 100%; border: 1px solid #e5e7eb; margin-top: 0.5rem; padding: 0.5rem;
      border-radius: 8px; resize: none; font-size: 0.9rem;
    }
    textarea.dark {
      background: #374151; color: #e5e7eb; border-color: #4b5563;
    }
    .modal-buttons {
      display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1rem;
    }
    .modal-btn {
      padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .modal-btn-confirm {
      background: #ef4444; color: white;
    }
    .modal-btn-confirm:hover {
      background: #dc2626; transform: translateY(-1px);
    }
    .modal-btn-cancel {
      background: #e5e7eb; color: #374151;
    }
    .modal-btn-cancel:hover {
      background: #d1d5db; transform: translateY(-1px);
    }
    .modal-btn-cancel.dark {
      background: #4b5563; color: #e5e7eb;
    }
    .modal-btn-cancel.dark:hover {
      background: #6b7280;
    }
    .loading-spinner {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      z-index: 20; border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #ef4444; border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .error-message {
      color: #ef4444; text-align: center; padding: 1rem; font-size: 0.9rem;
    }
  </style>
</head>
<body>
<a href="friends.html" class="home-btn">
  <svg data-heroicons="home" fill="none" stroke="currentColor" class="inline-block mr-1"></svg>
  Home
</a>
<div class="reel-container" id="reelContainer"></div>

<!-- Comment Modal -->
<div id="commentModal" class="modal">
  <div class="modal-content dark:modal-content">
    <h2>Comments</h2>
    <div id="commentList"></div>
    <textarea id="commentInput" class="dark:textarea" rows="2" placeholder="Add a comment..."></textarea>
    <div class="modal-buttons">
      <button id="postCommentBtn" class="modal-btn modal-btn-confirm">Post</button>
      <button id="closeModalBtn" class="modal-btn modal-btn-cancel dark:modal-btn-cancel">Close</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, onValue, set, push, get, update, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.appspot.com",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

try {
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const reelContainer = document.getElementById('reelContainer');
  const commentModal = document.getElementById('commentModal');
  const commentList = document.getElementById('commentList');
  const commentInput = document.getElementById('commentInput');
  const postCommentBtn = document.getElementById('postCommentBtn');
  const closeModalBtn = document.getElementById('closeModalBtn');
  let currentUser = null;
  let activeReelId = null;

  onAuthStateChanged(auth, async user => {
    if (user) {
      currentUser = user;
      try {
        const userRef = ref(db, `users/${user.uid}/settings`);
        const snap = await get(userRef);
        const settings = snap.exists() ? snap.val() : {};
        applyTheme(settings.theme || 'light');
        const urlParams = new URLSearchParams(window.location.search);
        const statusId = urlParams.get('sid');
        await loadReels(statusId);
      } catch (error) {
        console.error("Error initializing user settings:", error);
        reelContainer.innerHTML = '<p class="error-message">Failed to load settings.</p>';
      }
    } else {
      window.location.href = 'signup.html';
    }
  });

  function applyTheme(themeValue) {
    try {
      const isDark = themeValue === 'dark';
      document.body.classList.toggle('dark', isDark);
      if (commentModal) commentModal.querySelector('.modal-content')?.classList.toggle('dark', isDark);
      if (closeModalBtn) closeModalBtn.classList.toggle('dark', isDark);
      if (commentInput) commentInput.classList.toggle('dark', isDark);
    } catch (error) {
      console.error("Error applying theme:", error);
    }
  }

  async function loadReels(targetStatusId = null) {
    try {
      const statusesRef = ref(db, 'statuses');
      const statusesSnap = await get(statusesRef);
      const statuses = statusesSnap.exists() ? statusesSnap.val() : {};
      
      if (!Object.keys(statuses).length) {
        reelContainer.innerHTML = '<p class="text-center text-white">No reels available.</p>';
        return;
      }

      const statusEntries = Object.entries(statuses)
        .filter(([_, status]) => status.media && status.media.some(media => media.type === 'video'))
        .sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0));
      let targetReelElement = null;

      reelContainer.innerHTML = '';

      for (const [statusId, status] of statusEntries) {
        const userSnap = await get(ref(db, `users/${status.userId}`));
        const userInfo = userSnap.exists() ? userSnap.val() : { name: "Anonymous", photoURL: "https://www.gravatar.com/avatar?d=mp" };

        status.media.forEach((media, idx) => {
          if (media.type !== 'video') return;

          const reel = document.createElement('div');
          reel.className = 'reel';
          reel.dataset.sid = statusId;
          reel.dataset.videoIndex = idx;

          const video = document.createElement('video');
          video.src = media.url || '';
          video.loop = true;
          video.muted = media.muted !== false;
          video.playsInline = true;
          video.dataset.publicId = media.publicId || '';
          video.className = 'reel-video';
          video.poster = media.thumbnail || 'https://via.placeholder.com/640x360?text=Video+Thumbnail';

          const loadingSpinner = document.createElement('div');
          loadingSpinner.className = 'loading-spinner';
          loadingSpinner.style.display = 'none';

          const overlay = document.createElement('div');
          overlay.className = 'reel-overlay';
          overlay.innerHTML = `
            <div class="reel-user-info">
              <a href="profile.html?uid=${status.userId}&owner=${status.userId === currentUser.uid}">
                <img src="${userInfo.photoURL || 'https://www.gravatar.com/avatar?d=mp'}" alt="${userInfo.name} avatar" />
              </a>
              <a href="profile.html?uid=${status.userId}&owner=${status.userId === currentUser.uid}" class="hover:underline">${userInfo.name || 'Anonymous'}</a>
            </div>
            <p class="reel-caption">${status.text || ''}</p>
          `;

          const actions = document.createElement('div');
          actions.className = 'reel-actions';

          const likeBtn = document.createElement('button');
          likeBtn.className = `reel-action-btn ${status.reactions?.[currentUser.uid] ? 'reacted' : ''}`;
          likeBtn.innerHTML = `<svg data-heroicons="heart" fill="${status.reactions?.[currentUser.uid] ? '#ef4444' : 'none'}" stroke="currentColor" class="inline-block"></svg>`;
          likeBtn.setAttribute('aria-label', status.reactions?.[currentUser.uid] ? 'Unlike reel' : 'Like reel');
          likeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleLike(statusId, likeBtn);
          });

          const likeCount = document.createElement('span');
          likeCount.className = 'reel-action-count';
          likeCount.textContent = status.reactions ? Object.keys(status.reactions).length : 0;

          const commentBtn = document.createElement('button');
          commentBtn.className = 'reel-action-btn';
          commentBtn.innerHTML = '<svg data-heroicons="chat-bubble-left" fill="none" stroke="currentColor" class="inline-block"></svg>';
          commentBtn.setAttribute('aria-label', 'View comments');
          commentBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openComments(statusId);
          });

          const commentCount = document.createElement('span');
          commentCount.className = 'reel-action-count';
          commentCount.textContent = status.comments ? Object.keys(status.comments).length : 0;

          const shareBtn = document.createElement('button');
          shareBtn.className = 'reel-action-btn';
          shareBtn.innerHTML = '<svg data-heroicons="share" fill="none" stroke="currentColor" class="inline-block"></svg>';
          shareBtn.setAttribute('aria-label', 'Share reel');
          shareBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            navigator.clipboard.writeText(`${window.location.origin}/reels.html?sid=${statusId}`)
              .then(() => alert("Reel link copied!"))
              .catch(error => console.error("Error copying link:", error));
          });

          const muteToggle = document.createElement('svg');
          muteToggle.className = 'reel-mute-toggle';
          muteToggle.setAttribute('data-heroicons', video.muted ? 'speaker-x-mark' : 'speaker-wave');
          muteToggle.innerHTML = `<svg data-heroicons="${video.muted ? 'speaker-x-mark' : 'speaker-wave'}" fill="none" stroke="currentColor" class="inline-block"></svg>`;
          muteToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            video.muted = !video.muted;
            muteToggle.setAttribute('data-heroicons', video.muted ? 'speaker-x-mark' : 'speaker-wave');
            muteToggle.innerHTML = `<svg data-heroicons="${video.muted ? 'speaker-x-mark' : 'speaker-wave'}" fill="none" stroke="currentColor" class="inline-block"></svg>`;
            try {
              update(ref(db, `statuses/${statusId}/media/${idx}`), { muted: video.muted });
            } catch (error) {
              console.error("Error updating mute status:", error);
            }
          });

          actions.append(likeBtn, likeCount, commentBtn, commentCount, shareBtn);
          reel.append(video, loadingSpinner, overlay, actions, muteToggle);
          reelContainer.appendChild(reel);

          // Video event listeners for loading/buffering and playback state
          video.addEventListener('click', (e) => {
            e.stopPropagation();
            try {
              if (video.paused) {
                loadingSpinner.style.display = 'block';
                video.play()
                  .then(() => {
                    video.classList.add('playing');
                    loadingSpinner.style.display = 'none';
                  })
                  .catch(error => {
                    console.error("Error playing video:", error);
                    loadingSpinner.style.display = 'none';
                  });
              } else {
                video.pause();
                video.classList.remove('playing');
              }
            } catch (error) {
              console.error("Error handling video click:", error);
            }
          });

          video.addEventListener('waiting', () => {
            loadingSpinner.style.display = 'block';
          });
          video.addEventListener('stalled', () => {
            loadingSpinner.style.display = 'block';
          });
          video.addEventListener('canplay', () => {
            loadingSpinner.style.display = 'none';
          });
          video.addEventListener('playing', () => {
            video.classList.add('playing');
            loadingSpinner.style.display = 'none';
          });
          video.addEventListener('pause', () => {
            video.classList.remove('playing');
          });

          if (statusId === targetStatusId) {
            targetReelElement = reel;
            try {
              loadingSpinner.style.display = 'block';
              video.play()
                .then(() => {
                  video.classList.add('playing');
                  loadingSpinner.style.display = 'none';
                })
                .catch(error => {
                  console.error("Error auto-playing video:", error);
                  loadingSpinner.style.display = 'none';
                });
            } catch (error) {
              console.error("Error auto-playing target video:", error);
            }
          }
        });
      }

      if (reelContainer.children.length === 0) {
        reelContainer.innerHTML = '<p class="text-center text-white">No reels available.</p>';
      }

      observeVideos();

      if (targetReelElement) {
        try {
          targetReelElement.scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
          console.error("Error scrolling to target reel:", error);
        }
      }

      // Real-time updates for reactions and comments
      onValue(ref(db, 'statuses'), (snapshot) => {
        try {
          const statuses = snapshot.val() || {};
          document.querySelectorAll('.reel').forEach(reel => {
            const sid = reel.dataset.sid;
            const status = statuses[sid];
            if (status) {
              const likeBtn = reel.querySelector('.reel-action-btn[aria-label*="Like"]');
              if (likeBtn) {
                const isLiked = status.reactions?.[currentUser.uid];
                likeBtn.innerHTML = `<svg data-heroicons="heart" fill="${isLiked ? '#ef4444' : 'none'}" stroke="currentColor" class="inline-block"></svg>`;
                likeBtn.setAttribute('aria-label', isLiked ? 'Unlike reel' : 'Like reel');
                likeBtn.classList.toggle('reacted', !!isLiked);
              }
              const likeCount = reel.querySelector('.reel-action-count:nth-child(2)');
              if (likeCount) {
                likeCount.textContent = status.reactions ? Object.keys(status.reactions).length : 0;
              }
              const commentCount = reel.querySelector('.reel-action-count:nth-child(4)');
              if (commentCount) {
                commentCount.textContent = status.comments ? Object.keys(status.comments).length : 0;
              }
            }
          });
        } catch (error) {
          console.error("Error updating reactions/comments:", error);
        }
      }, (error) => {
        console.error("Error in real-time status listener:", error);
      });
    } catch (error) {
      console.error("Error loading reels:", error);
      reelContainer.innerHTML = '<p class="error-message">Error loading reels.</p>';
    }
  }

  function toggleLike(statusId, likeBtn) {
    try {
      const likeRef = ref(db, `statuses/${statusId}/reactions/${currentUser.uid}`);
      const isLiked = likeBtn.classList.contains('reacted');
      set(likeRef, isLiked ? null : { timestamp: Date.now() })
        .then(() => {
          likeBtn.innerHTML = `<svg data-heroicons="heart" fill="${isLiked ? 'none' : '#ef4444'}" stroke="currentColor" class="inline-block"></svg>`;
          likeBtn.setAttribute('aria-label', isLiked ? 'Like reel' : 'Unlike reel');
          likeBtn.classList.toggle('reacted', !isLiked);
        })
        .catch(error => console.error("Error toggling like:", error));
    } catch (error) {
      console.error("Error in toggleLike:", error);
    }
  }

  function observeVideos() {
    try {
      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          const video = entry.target;
          const spinner = video.parentElement.querySelector('.loading-spinner');
          try {
            if (entry.isIntersecting) {
              if (spinner) spinner.style.display = 'block';
              video.play()
                .then(() => {
                  video.classList.add('playing');
                  if (spinner) spinner.style.display = 'none';
                })
                .catch(error => {
                  console.error("Error auto-playing video:", error);
                  if (spinner) spinner.style.display = 'none';
                });
            } else {
              video.pause();
              video.classList.remove('playing');
              if (spinner) spinner.style.display = 'none';
            }
          } catch (error) {
            console.error("Error in IntersectionObserver:", error);
          }
        });
      }, { threshold: 0.6 });

      const videos = document.querySelectorAll('.reel video');
      if (videos.length === 0) {
        console.warn("No videos found for observation");
      } else {
        videos.forEach(video => observer.observe(video));
      }
    } catch (error) {
      console.error("Error setting up video observer:", error);
    }
  }

  function openComments(statusId) {
    try {
      activeReelId = statusId;
      if (!commentModal) throw new Error("Comment modal not found");
      commentModal.style.display = 'flex';
      commentList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Loading...</p>';

      const commentsRef = ref(db, `statuses/${statusId}/comments`);
      onValue(commentsRef, async (snapshot) => {
        try {
          commentList.innerHTML = '';
          const comments = snapshot.val() || {};
          const entries = Object.entries(comments).sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0));

          if (entries.length === 0) {
            commentList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">No comments yet.</p>';
            return;
          }

          for (const [commentId, comment] of entries) {
            const userSnap = await get(ref(db, `users/${comment.userId}`));
            const user = userSnap.exists() ? userSnap.val() : { name: 'User', photoURL: 'https://www.gravatar.com/avatar?d=mp' };
            const div = document.createElement('div');
            div.className = 'comment';
            div.innerHTML = `
              <img src="${user.photoURL}" alt="${user.name} avatar" />
              <div class="comment-content">
                <p class="comment-username dark:comment-username">${user.name}</p>
                <p class="comment-text dark:comment-text">${comment.text}</p>
                <p class="comment-timestamp dark:comment-timestamp">${timeAgo(comment.timestamp)}</p>
              </div>
            `;
            commentList.appendChild(div);
          }
        } catch (error) {
          console.error("Error loading comments:", error);
          commentList.innerHTML = '<p class="error-message">Error loading comments.</p>';
        }
      }, (error) => {
        console.error("Error in comments listener:", error);
        commentList.innerHTML = '<p class="error-message">Error loading comments.</p>';
      });
    } catch (error) {
      console.error("Error opening comments:", error);
      if (commentList) commentList.innerHTML = '<p class="error-message">Error opening comments.</p>';
    }
  }

  function timeAgo(timestamp) {
    try {
      if (!timestamp) return "just now";
      const now = Date.now();
      const diff = now - timestamp;
      if (diff < 60000) return "just now";
      if (diff < 3600000) return Math.floor(diff / 60000) + "m ago";
      if (diff < 86400000) return Math.floor(diff / 3600000) + "h ago";
      return Math.floor(diff / 86400000) + "d ago";
    } catch (error) {
      console.error("Error in timeAgo:", error);
      return "just now";
    }
  }

  if (postCommentBtn) {
    postCommentBtn.addEventListener('click', () => {
      try {
        const text = commentInput.value.trim();
        if (!text || !activeReelId) return;
        const newRef = push(ref(db, `statuses/${activeReelId}/comments`));
        set(newRef, {
          userId: currentUser.uid,
          text,
          timestamp: Date.now()
        }).then(() => {
          commentInput.value = '';
        }).catch(error => console.error("Error posting comment:", error));
      } catch (error) {
        console.error("Error in postCommentBtn click:", error);
      }
    });
  }

  if (commentInput) {
    commentInput.addEventListener('keypress', (e) => {
      try {
        if (e.key === 'Enter' && !e.shiftKey && commentInput.value.trim() && activeReelId) {
          e.preventDefault();
          const newRef = push(ref(db, `statuses/${activeReelId}/comments`));
          set(newRef, {
            userId: currentUser.uid,
            text: commentInput.value.trim(),
            timestamp: Date.now()
          }).then(() => {
            commentInput.value = '';
          }).catch(error => console.error("Error posting comment:", error));
        }
      } catch (error) {
        console.error("Error in commentInput keypress:", error);
      }
    });
  }

  if (closeModalBtn) {
    closeModalBtn.addEventListener('click', () => {
      try {
        commentModal.style.display = 'none';
        activeReelId = null;
      } catch (error) {
        console.error("Error closing modal:", error);
      }
    });
  }

  window.closeModal = () => {
    try {
      commentModal.style.display = 'none';
      activeReelId = null;
    } catch (error) {
      console.error("Error in closeModal:", error);
    }
  };
} catch (error) {
  console.error("Error initializing Firebase:", error);
  document.getElementById('reelContainer').innerHTML = '<p class="error-message">Failed to initialize application.</p>';
}
</script>
</body>
</html>
