<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Reels - BanterBox</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary-red: #ED4956;
      --text-dark: #262626;
      --text-light: #8e8e8e;
      --border: #dbdbdb;
      --white: #ffffff;
      --background: #fafafa;
      --gradient: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      touch-action: manipulation;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--background);
      color: var(--text-dark);
      line-height: 1.5;
      min-height: 100vh;
      overflow: hidden;
    }

    .container {
      max-width: 414px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    header {
      padding: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      background: var(--white);
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: var(--shadow);
    }

    .back-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }

    .back-btn:hover {
      transform: scale(1.1);
      opacity: 0.8;
    }

    .back-btn svg {
      width: 24px;
      height: 24px;
      stroke: var(--text-dark);
    }

    .selected-image {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--white);
      background: var(--gradient);
      padding: 2px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .selected-image:hover {
      transform: scale(1.05);
    }

    .reels-container {
      flex: 1;
      overflow-y: auto;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
    }

    .reel {
      height: 100vh;
      scroll-snap-align: start;
      position: relative;
      display: flex;
      flex-direction: column;
      background: var(--white);
      opacity: 0;
      animation: fadeIn 0.3s ease forwards;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    .reel img, .reel video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .reel-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.6), transparent);
      color: var(--white);
    }

    .reel-username {
      font-size: clamp(0.9rem, 2.5vw, 1rem);
      font-weight: 600;
      margin-bottom: 0.25rem;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .reel-username:hover {
      opacity: 0.8;
    }

    .reel-caption {
      font-size: clamp(0.8rem, 2vw, 0.9rem);
      margin-bottom: 0.5rem;
      max-width: 70%;
    }

    .reel-actions {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      z-index: 5;
    }

    .reel-action {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      cursor: pointer;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }

    .reel-action:hover {
      transform: scale(1.1);
      opacity: 0.8;
    }

    .reel-action svg {
      width: 32px;
      height: 32px;
      fill: var(--white);
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .reel-action.liked svg {
      fill: var(--primary-red);
      animation: heartPulse 0.3s ease;
    }

    @keyframes heartPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    .reel-action span {
      font-size: clamp(0.8rem, 2vw, 0.9rem);
      color: var(--white);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .reel-profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--white);
      background: var(--gradient);
      padding: 2px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .reel-profile-pic:hover {
      transform: scale(1.05);
    }

    .mute-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(0, 0, 0, 0.5);
      border: none;
      border-radius: 50%;
      padding: 0.5rem;
      cursor: pointer;
      transition: transform 0.2s ease, opacity 0.2s ease;
      display: none;
    }

    .mute-btn.active {
      display: block;
    }

    .mute-btn:hover {
      transform: scale(1.1);
      opacity: 0.8;
    }

    .mute-btn svg {
      width: 20px;
      height: 20px;
      fill: var(--white);
    }

    .fab {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background: var(--primary-red);
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }

    .fab:hover {
      transform: scale(1.05);
      opacity: 0.9;
    }

    .fab svg {
      width: 24px;
      height: 24px;
      fill: var(--white);
    }

    .loading-spinner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .loading-spinner.active {
      visibility: visible;
      opacity: 1;
    }

    .loading-spinner svg {
      width: 48px;
      height: 48px;
      color: var(--primary-red);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      color: var(--white);
      text-align: center;
      padding: 1rem;
      font-size: clamp(0.8rem, 2.5vw, 0.9rem);
      background: rgba(0, 0, 0, 0.7);
      border-radius: 8px;
    }

    .placeholder {
      color: var(--white);
      text-align: center;
      padding: 1rem;
      font-size: clamp(0.8rem, 2.5vw, 0.9rem);
      background: rgba(0, 0, 0, 0.7);
      border-radius: 8px;
    }

    .double-tap-heart {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      fill: var(--white);
      opacity: 0;
      animation: heartFade 0.5s ease;
      pointer-events: none;
    }

    @keyframes heartFade {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.2); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
    }

    @media (max-width: 414px) {
      .container {
        padding: 0;
      }

      .selected-image {
        width: 32px;
        height: 32px;
      }

      .reel-username {
        font-size: clamp(0.8rem, 2vw, 0.9rem);
      }

      .reel-caption {
        font-size: clamp(0.7rem, 1.8vw, 0.8rem);
      }

      .reel-action svg {
        width: 28px;
        height: 28px;
      }

      .reel-action span {
        font-size: clamp(0.7rem, 1.8vw, 0.8rem);
      }

      .reel-profile-pic {
        width: 32px;
        height: 32px;
      }

      .mute-btn {
        padding: 0.4rem;
      }

      .mute-btn svg {
        width: 16px;
        height: 16px;
      }

      .fab {
        width: 48px;
        height: 48px;
      }

      .fab svg {
        width: 20px;
        height: 20px;
      }

      .double-tap-heart {
        width: 60px;
        height: 60px;
      }
    }
  </style>
</head>
<body>
  <div class="loading-spinner" id="loading-spinner">
    <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 00-8 8h4z"/>
    </svg>
  </div>
  <div class="container">
    <header>
      <button class="back-btn" aria-label="Back to home">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      <img class="selected-image" id="selected-image" src="https://www.gravatar.com/avatar?d=mp" alt="Selected profile or post image">
      <span class="font-semibold text-lg">Reels</span>
    </header>
    <div class="reels-container" id="reels-container"></div>
    <button class="fab" aria-label="Upload post">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M12 4v16m8-8H4"/>
      </svg>
    </button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getDatabase, ref, get, query, orderByChild, set, onValue } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let currentUserUid = null;
    let currentReelIndex = 0;
    let posts = [];
    let lastTap = 0;

    function showLoading() {
      document.getElementById("loading-spinner").classList.add("active");
    }

    function hideLoading() {
      document.getElementById("loading-spinner").classList.remove("active");
    }

    function timeAgo(timestamp) {
      const now = Date.now();
      const seconds = Math.floor((now - timestamp) / 1000);
      if (seconds < 60) return "just now";
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h`;
      const days = Math.floor(hours / 24);
      return `${days}d`;
    }

    function pauseAllMedia() {
      document.querySelectorAll("video").forEach(video => {
        video.pause();
        video.currentTime = 0; // Reset to start
      });
    }

    async function toggleLike(postId, likeBtn) {
      if (!currentUserUid) return;
      showLoading();
      try {
        const likeRef = ref(db, `posts/${postId}/likes/${currentUserUid}`);
        const likeSnap = await get(likeRef);
        const isLiked = likeSnap.exists();

        if (!isLiked) {
          await set(likeRef, true);
          likeBtn.classList.add("liked");
        } else {
          await set(likeRef, null);
          likeBtn.classList.remove("liked");
        }
      } catch (error) {
        console.error("Error toggling like:", error.message);
      } finally {
        hideLoading();
      }
    }

    async function loadPosts() {
      const urlParams = new URLSearchParams(window.location.search);
      const targetUid = urlParams.get("uid");
      const postId = urlParams.get("postId");
      showLoading();

      try {
        let selectedImage = "https://www.gravatar.com/avatar?d=mp";
        if (targetUid) {
          const userSnap = await get(ref(db, `users/${targetUid}`));
          if (userSnap.exists()) {
            selectedImage = userSnap.val().photoURL || selectedImage;
          }
        } else if (postId) {
          const postSnap = await get(ref(db, `posts/${postId}`));
          if (postSnap.exists()) {
            const post = postSnap.val();
            selectedImage = post.imageUrls?.[0] || post.videoUrl || selectedImage;
          }
        }
        document.getElementById("selected-image").src = selectedImage;
        document.getElementById("selected-image").addEventListener("click", () => {
          pauseAllMedia();
          location.href = targetUid ? `profile.html?uid=${targetUid}` : postId ? `post.html?id=${postId}` : "home.html";
        });

        const postsSnap = await get(ref(db, "posts"));
        posts = Object.entries(postsSnap.val() || {})
          .map(([id, post]) => ({ id, ...post }))
          .filter(post => post.imageUrls?.length > 0 || post.videoUrl)
          .sort(() => Math.random() - 0.5); // Random shuffle

        if (posts.length === 0) {
          document.getElementById("reels-container").innerHTML = '<div class="placeholder">No posts available.</div>';
          hideLoading();
          return;
        }

        if (postId) {
          currentReelIndex = posts.findIndex(post => post.id === postId);
          if (currentReelIndex === -1) currentReelIndex = 0;
        }

        const reelsContainer = document.getElementById("reels-container");
        reelsContainer.innerHTML = "";
        posts.forEach((post, index) => {
          const userRef = ref(db, `users/${post.userId}`);
          get(userRef).then(userSnap => {
            const user = userSnap.val() || {};
            const isVideo = post.videoUrl && (post.postType === "reel" || !post.imageUrls);
            const reelElement = document.createElement("div");
            reelElement.className = "reel";
            reelElement.setAttribute("aria-label", `Post by ${user.username || 'Unknown'}`);
            reelElement.innerHTML = `
              ${isVideo ? `
                <video src="${post.videoUrl}" loop playsinline ${index === currentReelIndex ? "autoplay" : ""} ${post.isMuted ? "muted" : ""} loading="lazy"></video>
                <button class="mute-btn ${isVideo ? 'active' : ''}" data-post-id="${post.id}" aria-label="Toggle mute">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    ${post.isMuted ? '<path d="M3 9v6h4l5 5V4l-5 5H3zm13 3a4 4 0 0 0-4-4v8a4 4 0 0 0 4-4zm3 0a7 7 0 0 0-7-7v14a7 7 0 0 0 7-7z"/>' : '<path d="M3 9v6h4l5 5V4l-5 5H3zm13.11 3.47l1.54-1.54 1.54 1.54 1.54-1.54-1.54-1.54 1.54-1.54-1.54-1.54-1.54 1.54-1.54-1.54-1.54 1.54 1.54 1.54-1.54 1.54 1.54 1.54z"/>'
                }
                  </svg>
                </button>
              ` : `
                <img src="${post.imageUrls?.[0] || post.imageUrl}" alt="Post image" loading="lazy" onerror="this.src='https://via.placeholder.com/414x736?text=Image+Not+Found';">
              `}
              <div class="reel-overlay">
                <div class="reel-username">${user.username || "Unknown"}</div>
                <div class="reel-caption">${post.caption || ""} • ${timeAgo(post.timestamp)}</div>
              </div>
              <div class="reel-actions">
                <img class="reel-profile-pic" src="${user.photoURL || 'https://www.gravatar.com/avatar?d=mp'}" alt="${user.username || 'Unknown'}'s profile picture" aria-label="View ${user.username || 'Unknown'}'s profile">
                <div class="reel-action like-btn" data-post-id="${post.id}" aria-label="Like post">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                  </svg>
                  <span class="like-count">0</span>
                </div>
                <div class="reel-action comment-btn" data-post-id="${post.id}" aria-label="View comments">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M21 6h-2V4H3v16l4-4h14V6zm-2 8H7.83L5 16.83V4h12v10z"/>
                  </svg>
                  <span class="comment-count">0</span>
                </div>
              </div>
            `;
            reelsContainer.appendChild(reelElement);

            // Real-time like and comment counts
            onValue(ref(db, `posts/${post.id}/likes`), snap => {
              const likes = snap.val() || {};
              const likeCount = Object.keys(likes).length;
              reelElement.querySelector(".like-count").textContent = likeCount;
              reelElement.querySelector(".like-btn").classList.toggle("liked", likes[currentUserUid]);
            });

            onValue(ref(db, `posts/${post.id}/comments`), snap => {
              const comments = snap.val() || {};
              reelElement.querySelector(".comment-count").textContent = Object.keys(comments).length;
            });

            // Event listeners
            if (isVideo) {
              const video = reelElement.querySelector("video");
              video.addEventListener("click", (e) => {
                e.stopPropagation();
                video.paused ? video.play() : video.pause();
              });

              reelElement.querySelector(".mute-btn").addEventListener("click", (e) => {
                e.stopPropagation();
                video.muted = !video.muted;
                set(ref(db, `posts/${post.id}/isMuted`), video.muted);
                e.currentTarget.innerHTML = video.muted
                  ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4l-5 5H3zm13 3a4 4 0 0 0-4-4v8a4 4 0 0 0 4-4zm3 0a7 7 0 0 0-7-7v14a7 7 0 0 0 7-7z"/></svg>`
                  : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4l-5 5H3zm13.11 3.47l1.54-1.54 1.54 1.54 1.54-1.54-1.54-1.54 1.54-1.54-1.54-1.54-1.54 1.54-1.54-1.54-1.54 1.54 1.54 1.54-1.54 1.54 1.54 1.54z"/></svg>`;
              });
            }

            reelElement.querySelector(".reel-username").addEventListener("click", (e) => {
              e.stopPropagation();
              pauseAllMedia();
              location.href = `profile.html?uid=${post.userId}`;
            });

            reelElement.querySelector(".reel-profile-pic").addEventListener("click", (e) => {
              e.stopPropagation();
              pauseAllMedia();
              location.href = `profile.html?uid=${post.userId}`;
            });

            reelElement.querySelector(".like-btn").addEventListener("click", (e) => {
              e.stopPropagation();
              toggleLike(post.id, e.currentTarget);
            });

            reelElement.querySelector(".comment-btn").addEventListener("click", (e) => {
              e.stopPropagation();
              pauseAllMedia();
              location.href = `post.html?id=${post.id}`;
            });

            // Double-tap to like
            reelElement.addEventListener("click", (e) => {
              const now = new Date().getTime();
              const timeSinceLastTap = now - lastTap;
              if (timeSinceLastTap < 300 && timeSinceLastTap > 0) {
                const likeBtn = reelElement.querySelector(".like-btn");
                if (!likeBtn.classList.contains("liked")) {
                  toggleLike(post.id, likeBtn);
                  const heart = document.createElement("svg");
                  heart.className = "double-tap-heart";
                  heart.setAttribute("xmlns", "http://www.w3.org/2000/svg");
                  heart.setAttribute("viewBox", "0 0 24 24");
                  heart.innerHTML = `<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>`;
                  reelElement.appendChild(heart);
                  setTimeout(() => heart.remove(), 500);
                }
              }
              lastTap = now;
            });
          });
        });

        // Autoplay logic for videos
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            const video = entry.target.querySelector("video");
            if (video) {
              if (entry.isIntersecting) {
                pauseAllMedia();
                video.play().catch(() => {});
                currentReelIndex = posts.findIndex(post => post.id === entry.target.querySelector(".like-btn").dataset.postId);
              } else {
                video.pause();
                video.currentTime = 0;
              }
            }
          });
        }, { threshold: 0.6 });

        document.querySelectorAll(".reel").forEach(reel => observer.observe(reel));
      } catch (error) {
        console.error("Error loading posts:", error.message);
        document.getElementById("reels-container").innerHTML = `<div class="error">Failed to load posts: ${error.message}</div>`;
      } finally {
        hideLoading();
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      auth.onAuthStateChanged(user => {
        if (user) {
          currentUserUid = user.uid;
          loadPosts();
        } else {
          console.log("No user logged in, redirecting to login");
          location.href = "index.html";
        }
      });

      document.querySelector(".back-btn").addEventListener("click", () => {
        pauseAllMedia();
        location.href = "home.html";
      });

      document.querySelector(".fab").addEventListener("click", () => {
        pauseAllMedia();
        location.href = "upload.html";
      });
    });
  </script>
</body>
</html>
