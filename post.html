<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BanterBox - Reels</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary: #ff3b3b;
      --primary-dark: #d32f2f;
      --background-light: #f8fafc;
      --background-dark: #0f172a;
      --card-light: #ffffff;
      --card-dark: #1e293b;
      --text-light: #1e293b;
      --text-dark: #e2e8f0;
      --border-light: #e5e7eb;
      --border-dark: #374151;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--background-light);
      min-height: 100vh;
      overscroll-behavior: none;
      transition: background 0.3s ease, color 0.3s ease;
    }

    body.dark {
      background: var(--background-dark);
    }

    .container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .top-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      padding: 1rem;
      z-index: 20;
    }

    .profile-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 9999px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .profile-container:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .profile-container:focus-visible {
      outline: 2px solid var(--primary-dark);
      outline-offset: 2px;
    }

    .profile-avatar {
      width: 32px;
      height: 32px;
      border-radius: 9999px;
      object-fit: cover;
      border: 2px solid #fff;
    }

    .dark .profile-avatar {
      border-color: var(--text-dark);
    }

    .profile-username {
      color: #fff;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .notifications-container {
      position: relative;
      top: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 9999px;
      padding: 0.5rem;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .notifications-container:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .notifications-container:focus-visible {
      outline: 2px solid var(--primary-dark);
      outline-offset: 2px;
    }

    .notifications-icon {
      width: 20px;
      height: 20px;
      color: #fff;
    }

    .notifications-unread-count {
      background: #fff;
      color: var(--primary);
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 9999px;
      padding: 0.15rem 0.5rem;
      min-width: 20px;
      text-align: center;
      position: absolute;
      top: -5px;
      right: -5px;
      animation: pulse 1.5s ease infinite;
    }

    .dark .notifications-unread-count {
      background: var(--text-dark);
      color: var(--primary-dark);
    }

    .media-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      flex-grow: 1;
    }

    .media-container video,
    .media-container img {
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      max-height: 100vh;
      background: #000;
    }

    .carousel {
      display: flex;
      width: 100vw;
      height: 100vh;
      transition: transform 0.3s ease;
    }

    .carousel-item {
      flex: 0 0 100%;
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    .post-text {
      position: absolute;
      bottom: 4rem;
      left: 1rem;
      right: 1rem;
      background: linear-gradient(to right, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.5));
      color: #fff;
      font-size: 1rem;
      font-weight: 500;
      padding: 0.75rem;
      border-radius: 8px;
      z-index: 20;
      word-break: break-word;
      display: none;
      box-shadow: var(--shadow);
      animation: fadeIn 0.3s ease;
    }

    .post-text.show {
      display: block;
    }

    .dark .post-text {
      background: linear-gradient(to right, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
    }

    .action-buttons {
      position: absolute;
      top: 50%;
      right: 1rem;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      z-index: 20;
    }

    .action-btn {
      background: rgba(0, 0, 0, 0.6);
      border-radius: 9999px;
      padding: 0.75rem;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease;
      box-shadow: var(--shadow);
    }

    .action-btn:hover {
      transform: scale(1.1);
      background: rgba(0, 0, 0, 0.8);
    }

    .action-btn:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    .action-btn.liked svg {
      fill: var(--primary);
      stroke: var(--primary);
      animation: pulse 0.3s ease;
    }

    .dark .action-btn.liked svg {
      fill: var(--primary-dark);
      stroke: var(--primary-dark);
    }

    .action-btn svg {
      width: 24px;
      height: 24px;
    }

    .mute-toggle-icon {
      position: absolute;
      bottom: 6rem;
      right: 1rem;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      padding: 6px;
      width: 28px;
      height: 28px;
      cursor: pointer;
      transition: transform 0.2s ease;
      z-index: 20;
      box-shadow: var(--shadow);
    }

    .mute-toggle-icon:hover {
      transform: scale(1.1);
    }

    .play-pause-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      padding: 10px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 20;
      box-shadow: var(--shadow);
    }

    .play-pause-icon.show {
      opacity: 1;
    }

    .double-tap-heart {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      width: 100px;
      height: 100px;
      fill: #fff;
      opacity: 0;
      z-index: 20;
      animation: heartPop 0.5s ease forwards;
    }

    .bottom-nav {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 1rem;
      z-index: 20;
    }

    .nav-btn {
      color: #fff;
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      cursor: pointer;
      transition: transform 0.2s ease, color 0.2s ease;
    }

    .nav-btn:hover {
      transform: scale(1.1);
      color: var(--primary);
    }

    .nav-btn:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    .nav-btn svg {
      width: 24px;
      height: 24px;
    }

    .loading-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 20;
      display: none;
    }

    .loading-spinner.show {
      display: block;
    }

    .loading-spinner svg {
      width: 56px;
      height: 56px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes heartPop {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.3); opacity: 0.9; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @media (max-width: 640px) {
      .profile-container { padding: 0.4rem 0.8rem; }
      .notifications-container { padding: 0.4rem; }
      .action-btn { padding: 0.6rem; }
      .post-text { font-size: 0.9rem; padding: 0.6rem; }
      .bottom-nav { padding: 0.4rem; }
      .nav-btn { font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <div class="profile-container" role="button" tabindex="0" aria-label="View user profile">
        <img id="profile-avatar" src="https://www.gravatar.com/avatar?d=mp" alt="User avatar" class="profile-avatar" loading="lazy" />
        <span id="profile-username" class="profile-username">User</span>
      </div>
      <div class="notifications-container" role="button" tabindex="0" aria-label="View notifications">
        <svg class="notifications-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
        </svg>
        <span id="notifications-unread-count" class="notifications-unread-count hidden">0</span>
      </div>
    </div>
    <div class="media-container" role="region" aria-label="Reels media">
      <div id="media-content" class="carousel"></div>
      <div id="loading-spinner" class="loading-spinner" aria-label="Loading">
        <svg viewBox="0 0 50 50" fill="none" stroke="#fff" stroke-width="4">
          <circle cx="25" cy="25" r="20" stroke-opacity="0.3"/>
          <circle cx="25" cy="25" r="20" stroke-dasharray="90 150" stroke-linecap="round"/>
        </svg>
      </div>
      <div id="post-text" class="post-text" role="status" aria-live="polite"></div>
      <svg id="mute-toggle-icon" class="mute-toggle-icon hidden" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path class="mute-icon hidden" d="M11 5L6 9H2v6h4l5 4V5zM19.07 4.93a10 10 0 010 14.14M15.54 8.46a5 5 0 010 7.07"/>
        <path class="unmute-icon" d="M11 5L6 9H2v6h4l5 4V5z"/>
      </svg>
      <svg id="play-pause-icon" class="play-pause-icon" width="40" height="40" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2">
        <path class="play-icon" d="M5 3v18l15-9z"/>
        <path class="pause-icon hidden" d="M6 4h4v16H6zM14 4h4v16h-4z"/>
      </svg>
      <svg id="double-tap-heart" class="double-tap-heart hidden" viewBox="0 0 24 24" fill="white">
        <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
      </svg>
    </div>
    <div class="action-buttons">
      <button id="like-btn" class="action-btn" aria-label="Like reel">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
        </svg>
        <span id="like-count">0</span>
      </button>
      <button id="comment-btn" class="action-btn" aria-label="View comments">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/>
        </svg>
        <span id="comment-count">0</span>
      </button>
      <button id="share-btn" class="action-btn" aria-label="Share reel">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342c-1.1 0-2 1.001-2 2.218s.9 2.218 2 2.218c1.1 0 2-1.001 2-2.218s-.9-2.218-2-2.218zM18.316 13.342c-1.1 0-2 1.001-2 2.218s.9 2.218 2 2.218c1.1 0 2-1.001 2-2.218s-.9-2.218-2-2.218zM8.684 3c-1.1 0-2 1.001-2 2.218s.9 2.218 2 2.218c1.1 0 2-1.001 2-2.218s-.9-2.218-2-2.218zM18.316 3c-1.1 0-2 1.001-2 2.218s.9 2.218 2 2.218c1.1 0 2-1.001 2-2.218s-.9-2.218-2-2.218zM8.684 8.342c-1.1 0-2 1.001-2 2.218s.9 2.218 2 2.218c1.1 0 2-1.001 2-2.218s-.9-2.218-2-2.218zM12 15.558l5.316-5.316"/>
        </svg>
        <span>0</span>
      </button>
    </div>
    <div class="bottom-nav">
      <div class="nav-btn" role="button" tabindex="0" aria-label="Home">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        <span>Home</span>
      </div>
      <div class="nav-btn" role="button" tabindex="0" aria-label="Reels">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M14.5 10.5c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm7.5 0c0 5.2-3.5 9.5-8 9.5s-8-4.3-8-9.5 3.5-9.5 8-9.5 8 4.3 8 9.5zm-3 0c0-3.5-2-6.5-5-7.5v15c3-.5 5-4 5-7.5z"/></svg>
        <span>Reels</span>
      </div>
      <div class="nav-btn" role="button" tabindex="0" aria-label="Add">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2c5.5 0 10 4.5 10 10s-4.5 10-10 10S2 17.5 2 12 6.5 2 12 2zm0 2c-4.4 0-8 3.6-8 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm4 9h-3v3c0 .6-.4 1-1 1s-1-.4-1-1v-3H8c-.6 0-1-.4-1-1s.4-1 1-1h3V8c0-.6.4-1 1-1s1 .4 1 1v3h3c.6 0 1 .4 1 1s-.4 1-1 1z"/></svg>
        <span>Add</span>
      </div>
      <div class="nav-btn" role="button" tabindex="0" aria-label="Activity">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M17 12h-5v5h-2v-5H7v-2h3V7h2v3h5v2zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
        <span>Activity</span>
      </div>
      <div class="nav-btn" role="button" tabindex="0" aria-label="Profile">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
        <span>Profile</span>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js';
    import { getDatabase, ref, get, set, push, update, onValue, off, runTransaction } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const mediaContainer = document.querySelector('.media-container');
    const mediaContent = document.getElementById('media-content');
    const loadingSpinner = document.getElementById('loading-spinner');
    const muteToggleIcon = document.getElementById('mute-toggle-icon');
    const playPauseIcon = document.getElementById('play-pause-icon');
    const doubleTapHeart = document.getElementById('double-tap-heart');
    const likeBtn = document.getElementById('like-btn');
    const commentBtn = document.getElementById('comment-btn');
    const shareBtn = document.getElementById('share-btn');
    const notificationsContainer = document.querySelector('.notifications-container');
    const notificationsUnreadCount = document.getElementById('notifications-unread-count');
    const likeCount = document.getElementById('like-count');
    const commentCount = document.getElementById('comment-count');
    const profileContainer = document.querySelector('.profile-container');
    const profileAvatar = document.getElementById('profile-avatar');
    const profileUsername = document.getElementById('profile-username');
    const postText = document.getElementById('post-text');

    let currentUser;
    let postUserId;
    let statusId;
    let userCache = {};
    let statusHistory = [];
    let historyIndex = -1;
    let currentMediaIndex = 0;
    let mediaItems = [];
    let commentsListener = null;
    let notificationsListener = null;
    let lastTap = 0;
    let isMuted = false;
    let availableStatusIds = [];
    let viewedStatusIds = [];
    let lastNotificationTimestamp = 0;

    function showSpinner() {
      loadingSpinner.classList.add('show');
    }

    function hideSpinner() {
      loadingSpinner.classList.remove('show');
    }

    function applyTheme(themeValue) {
      const isDark = themeValue === 'dark';
      document.body.classList.toggle('dark', isDark);
    }

    function timeAgo(timestamp) {
      if (!timestamp) return 'just now';
      const diff = Date.now() - timestamp;
      if (diff < 60000) return 'just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h`;
      return new Date(timestamp).toLocaleString();
    }

    async function getUserData(uid) {
      if (userCache[uid]) return userCache[uid];
      const snap = await get(ref(db, `users/${uid}`));
      const data = snap.val() || { username: 'User', profilePicture: 'https://www.gravatar.com/avatar?d=mp' };
      userCache[uid] = data;
      return data;
    }

    function pauseAllVideos() {
      const videoElements = mediaContent.querySelectorAll('.status-video');
      videoElements.forEach(video => {
        video.pause();
        video.currentTime = 0;
      });
    }

    function renderMedia(status) {
      mediaItems = Array.isArray(status.mediaUrls) ? status.mediaUrls : status.imageUrl ? [{ url: status.imageUrl, type: 'image' }] : [];
      currentMediaIndex = 0;
      mediaContent.innerHTML = '';

      if (status.text && status.text.trim()) {
        postText.textContent = status.text;
        postText.classList.add('show');
      } else {
        postText.classList.remove('show');
      }

      if (mediaItems.length === 0) {
        mediaContent.innerHTML = '<div class="carousel-item"><img src="https://via.placeholder.com/1080x1920" alt="Placeholder" /></div>';
        muteToggleIcon.classList.add('hidden');
        playPauseIcon.classList.add('hidden');
        hideSpinner();
        return;
      }

      mediaItems.forEach((media, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'carousel-item';
        if (media.type === 'video') {
          itemDiv.innerHTML = `<video src="${media.url}" class="status-video" playsinline preload="metadata" data-post-id="${statusId}"></video>`;
        } else {
          itemDiv.innerHTML = `<img src="${media.url}?w=1080&h=1920&c=fill" alt="Post" loading="lazy" data-post-id="${statusId}" />`;
        }
        mediaContent.appendChild(itemDiv);
      });

      const videoElements = mediaContent.querySelectorAll('.status-video');
      videoElements.forEach(video => {
        video.addEventListener('waiting', () => showSpinner());
        video.addEventListener('canplay', () => hideSpinner());
        video.addEventListener('error', () => {
          hideSpinner();
          alert('Failed to load video.');
        });
      });

      updateCarousel();
      updateVideoControls();
      setupImpressionTracking();
      hideSpinner();
    }

    function updateVideoControls() {
      const videoElements = mediaContent.querySelectorAll('.status-video');
      if (mediaItems[currentMediaIndex]?.type === 'video') {
        const video = videoElements[currentMediaIndex];
        video.muted = isMuted;
        muteToggleIcon.classList.remove('hidden');
        muteToggleIcon.querySelector('.mute-icon').classList.toggle('hidden', !isMuted);
        muteToggleIcon.querySelector('.unmute-icon').classList.toggle('hidden', isMuted);
        playPauseIcon.classList.remove('hidden');
        playPauseIcon.querySelector('.play-icon').classList.toggle('hidden', !video.paused);
        playPauseIcon.querySelector('.pause-icon').classList.toggle('hidden', video.paused);

        video.addEventListener('play', () => {
          playPauseIcon.querySelector('.play-icon').classList.add('hidden');
          playPauseIcon.querySelector('.pause-icon').classList.remove('hidden');
          hideSpinner();
        });
        video.addEventListener('pause', () => {
          playPauseIcon.querySelector('.play-icon').classList.remove('hidden');
          playPauseIcon.querySelector('.pause-icon').classList.add('hidden');
        });

        if (!document.hidden) video.play().catch(() => {});
      } else {
        muteToggleIcon.classList.add('hidden');
        playPauseIcon.classList.add('hidden');
        hideSpinner();
      }
    }

    function updateCarousel() {
      pauseAllVideos();
      mediaContent.style.transform = `translateY(-${currentMediaIndex * 100}vh)`;
      if (mediaItems[currentMediaIndex]?.type === 'video' && !document.hidden) {
        const video = mediaContent.querySelectorAll('.status-video')[currentMediaIndex];
        video.play().catch(() => {});
      }
      updateVideoControls();
    }

    async function loadStatus(newStatusId, isPrevious = false) {
      showSpinner();
      try {
        const statusRef = ref(db, `statuses/${newStatusId}`);
        const statusSnap = await get(statusRef);
        if (!statusSnap.exists()) {
          alert('Post not found.');
          return;
        }
        const status = statusSnap.val();
        postUserId = status.userId;
        statusId = newStatusId;

        if (!isPrevious) {
          await runTransaction(ref(db, `statuses/${postUserId}/${newStatusId}/impressions`), current => (current || 0) + 1);
          if (historyIndex < statusHistory.length - 1) statusHistory = statusHistory.slice(0, historyIndex + 1);
          statusHistory.push(newStatusId);
          historyIndex++;
          if (!viewedStatusIds.includes(newStatusId)) {
            viewedStatusIds.push(newStatusId);
            availableStatusIds = availableStatusIds.filter(id => id !== newStatusId);
          }
        } else {
          historyIndex--;
        }

        renderMedia(status);
        const reactions = status.reactions || {};
        likeCount.textContent = Object.keys(reactions).length;
        likeBtn.classList.toggle('liked', !!reactions[currentUser.uid]);
        const comments = status.comments || {};
        commentCount.textContent = Object.keys(comments).length;
        const userData = await getUserData(postUserId);
        profileAvatar.src = userData.profilePicture || 'https://www.gravatar.com/avatar?d=mp';
        profileUsername.textContent = userData.username || 'User';
      } catch (error) {
        console.error('Error loading status:', error);
        alert('Failed to load post.');
      } finally {
        hideSpinner();
      }
    }

    async function loadNextRandomStatus() {
      showSpinner();
      try {
        if (availableStatusIds.length === 0) {
          availableStatusIds = await fetchAvailableStatuses();
          availableStatusIds = availableStatusIds.filter(id => !viewedStatusIds.includes(id));
          if (availableStatusIds.length === 0) {
            viewedStatusIds = [];
            availableStatusIds = await fetchAvailableStatuses();
            if (availableStatusIds.length === 0) {
              alert('No media posts available.');
              return;
            }
          }
          availableStatusIds = shuffleArray(availableStatusIds);
        }
        await loadStatus(availableStatusIds[0]);
      } catch (error) {
        console.error('Error loading random status:', error);
        alert('Failed to load next post.');
      } finally {
        hideSpinner();
      }
    }

    async function loadPreviousStatus() {
      if (historyIndex <= 0) {
        alert('No previous post available.');
        return;
      }
      await loadStatus(statusHistory[historyIndex - 1], true);
    }

    async function toggleLike() {
      if (!currentUser || !statusId) return;
      try {
        const reactionRef = ref(db, `statuses/${statusId}/reactions/${currentUser.uid}`);
        const snap = await get(reactionRef);
        if (snap.exists()) {
          await set(reactionRef, null);
          likeBtn.classList.remove('liked');
          likeCount.textContent = parseInt(likeCount.textContent) - 1;
        } else {
          await set(reactionRef, { timestamp: Date.now() });
          likeBtn.classList.add('liked');
          likeCount.textContent = parseInt(likeCount.textContent) + 1;
          doubleTapHeart.classList.remove('hidden');
          setTimeout(() => doubleTapHeart.classList.add('hidden'), 500);
        }
      } catch (error) {
        console.error('Error toggling like:', error);
        alert('Failed to update like.');
      }
    }

    function setupImpressionTracking() {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && statusId && postUserId) {
            runTransaction(ref(db, `statuses/${postUserId}/${entry.target.dataset.postId}/impressions`), current => (current || 0) + 1)
              .catch(error => console.error('Error incrementing impressions:', error));
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.5 });
      mediaContent.queryAll('.carousel-item img, .carousel-item video').forEach(element => observer.observe(element));
    }

    async function fetchAvailableStatuses() {
      try {
        const statusesRef = ref(db, 'statuses');
        const snap = await get(statusesRef);
        const statuses = snap.val();
        return statuses ? Object.keys(statuses).filter(id => {
          const status = statuses[id];
          return (Array.isArray(status.mediaUrls) && status.mediaUrls.length > 0) || status.imageUrl;
        }) : [];
      } catch (error) {
        console.error('Error fetching statuses:', error);
        return [];
      }
    }

    async function setupNotificationsListener() {
      if (!currentUser) return;
      const statusesRef = ref(db, `statuses/${currentUser.uid}`);
      notificationsListener = onValue(statusesRef, (snap) => {
        let unreadCount = 0;
        const statuses = snap.val();
        if (statuses) {
          Object.entries(statuses).forEach(([statusId, status]) => {
            if (status.reactions) Object.entries(status.reactions).forEach(([userId]) => userId !== currentUser.uid && unreadCount++);
            if (status.comments) Object.entries(status.comments).forEach(([commentId, comment]) => comment.userId !== currentUser.uid && unreadCount++);
          });
        }
        notificationsUnreadCount.textContent = unreadCount;
        notificationsUnreadCount.classList.toggle('hidden', unreadCount === 0);
      }, (error) => {
        console.error('Error listening to notifications:', error);
        alert('Failed to load notifications.');
      });
    }

    onAuthStateChanged(auth, async user => {
      if (!user) {
        location.href = 'signup.html';
        return;
      }
      currentUser = user;
      try {
        showSpinner();
        const settingsSnap = await get(ref(db, `users/${user.uid}/settings`));
        applyTheme(settingsSnap.val()?.theme || 'light');
        lastNotificationTimestamp = (await get(ref(db, `users/${user.uid}/lastNotificationTimestamp`))).val() || 0;
        setupNotificationsListener();
        availableStatusIds = await fetchAvailableStatuses();
        if (availableStatusIds.length === 0) {
          alert('No media posts available.');
          hideSpinner();
          return;
        }
        availableStatusIds = shuffleArray(availableStatusIds);
        await loadNextRandomStatus();
      } catch (error) {
        console.error('Error initializing:', error);
        alert('Failed to load posts.');
      } finally {
        hideSpinner();
      }
    });

    notificationsContainer.addEventListener('click', async () => {
      try {
        await set(ref(db, `users/${currentUser.uid}/lastNotificationTimestamp`), Date.now());
        notificationsUnreadCount.textContent = '0';
        notificationsUnreadCount.classList.add('hidden');
        location.href = 'notifications.html';
      } catch (error) {
        console.error('Error updating notification timestamp:', error);
        alert('Failed to process notifications.');
      }
    });

    notificationsContainer.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' || e.key === ' ') e.preventDefault(), notificationsContainer.click();
    });

    profileContainer.addEventListener('click', () => {
      if (postUserId) location.href = `profile.html?uid=${postUserId}${postUserId === currentUser.uid ? '&owner=true' : ''}`;
    });

    profileContainer.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' || e.key === ' ') e.preventDefault(), profileContainer.click();
    });

    likeBtn.addEventListener('click', toggleLike);
    likeBtn.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' || e.key === ' ') e.preventDefault(), toggleLike();
    });

    commentBtn.addEventListener('click', () => location.href = `comments.html?statusId=${statusId}`);
    commentBtn.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' || e.key === ' ') e.preventDefault(), commentBtn.click();
    });

    shareBtn.addEventListener('click', () => {
      if (navigator.share) navigator.share({ title: 'BanterBox Reel', url: window.location.href }).catch(() => alert('Sharing not supported.'));
      else alert('Share not supported on this device.');
    });
    shareBtn.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' || e.key === ' ') e.preventDefault(), shareBtn.click();
    });

    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const action = btn.getAttribute('aria-label').toLowerCase();
        if (action === 'add') location.href = 'add-status.html';
        else if (action === 'home') location.href = 'home.html';
        else if (action === 'activity') location.href = 'activity.html';
        else if (action === 'profile') location.href = 'profile.html?uid=' + currentUser.uid + '&owner=true';
      });
      btn.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' || e.key === ' ') e.preventDefault(), btn.click();
      });
    });

    muteToggleIcon.addEventListener('click', () => {
      if (mediaItems[currentMediaIndex]?.type === 'video') {
        const video = mediaContent.querySelectorAll('.status-video')[currentMediaIndex];
        isMuted = !isMuted;
        video.muted = isMuted;
        muteToggleIcon.querySelector('.mute-icon').classList.toggle('hidden', !isMuted);
        muteToggleIcon.querySelector('.unmute-icon').classList.toggle('hidden', isMuted);
      }
    });

    mediaContainer.addEventListener('click', (e) => {
      if (mediaItems[currentMediaIndex]?.type === 'video') {
        const video = mediaContent.querySelectorAll('.status-video')[currentMediaIndex];
        if (video.paused) video.play().catch(() => {});
        else video.pause();
        playPauseIcon.classList.add('show');
        setTimeout(() => playPauseIcon.classList.remove('show'), 1000);
      }
    });

    mediaContainer.addEventListener('touchstart', (e) => {
      const now = new Date().getTime();
      const timeSinceLastTap = now - lastTap;
      if (timeSinceLastTap < 300 && timeSinceLastTap > 0) toggleLike();
      lastTap = now;
    });

    let touchStartY = 0;
    container.addEventListener('touchstart', (e) => touchStartY = e.changedTouches[0].screenY);
    container.addEventListener('touchend', (e) => {
      const touchEndY = e.changedTouches[0].screenY;
      const deltaY = touchStartY - touchEndY;
      if (Math.abs(deltaY) > 50 && !notificationsContainer.contains(e.target)) {
        if (deltaY < 0) loadPreviousStatus();
        else loadNextRandomStatus();
      }
    });

    document.addEventListener('visibilitychange', () => {
      if (mediaItems[currentMediaIndex]?.type === 'video') {
        const video = mediaContent.querySelectorAll('.status-video')[currentMediaIndex];
        if (document.hidden) video.pause();
        else video.play().catch(() => {});
      }
    });

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
  </script>
</body>
</html>
