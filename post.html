<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BanterBox Reels</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; background: black; overflow: hidden;
    }
    .reel-container {
      height: 100vh; scroll-snap-type: y mandatory; overflow-y: scroll; scroll-behavior: smooth;
    }
    .reel {
      height: 100vh; position: relative; scroll-snap-align: start;
    }
    video {
      height: 100%; width: 100%; object-fit: cover; cursor: pointer;
    }
    .overlay {
      position: absolute; bottom: 4rem; left: 1rem; color: white;
      text-shadow: 1px 1px 4px black; max-width: 65%;
    }
    .user-info {
      display: flex; align-items: center; gap: 0.5rem;
    }
    .user-info img {
      height: 32px; width: 32px; border-radius: 50%;
      border: 2px solid white; object-fit: cover;
    }
    .actions {
      position: absolute; right: 1rem; bottom: 5rem;
      display: flex; flex-direction: column; gap: 1rem;
      align-items: center; z-index: 10;
    }
    .actions button {
      background-color: rgba(255,255,255,0.1);
      border: none; padding: 0.7rem; border-radius: 9999px;
      color: white; font-size: 1.3rem; cursor: pointer;
    }
    .home-btn {
      position: fixed; top: 1rem; left: 1rem; z-index: 50;
      background: rgba(255,255,255,0.1); color: white;
      padding: 0.5rem 1rem; border-radius: 9999px;
      font-weight: bold; border: 1px solid white;
      text-decoration: none;
    }
    /* Modal */
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center;
      z-index: 100;
    }
    .modal-content {
      background: white; border-radius: 12px; padding: 1rem; width: 90%; max-width: 400px;
      max-height: 80vh; overflow-y: auto;
    }
    .modal-content h2 {
      margin-top: 0; font-weight: bold;
    }
    .comment {
      border-bottom: 1px solid #e5e7eb; padding: 0.5rem 0;
    }
  </style>
</head>
<body>
<a href="index.html" class="home-btn">üè† Home</a>
<div class="reel-container" id="reelContainer"></div>

<!-- Comment Modal -->
<div id="commentModal" class="modal">
  <div class="modal-content">
    <h2>Comments</h2>
    <div id="commentList"></div>
    <textarea id="commentInput" class="w-full border mt-2 p-2 rounded" rows="2" placeholder="Add a comment..."></textarea>
    <button id="postCommentBtn" class="mt-2 bg-red-500 text-white px-4 py-2 rounded">Post</button>
    <button onclick="closeModal()" class="mt-4 text-sm text-gray-500 underline">Close</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, onValue, set, push, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
  authDomain: "fire-b-a8878.firebaseapp.com",
  databaseURL: "https://fire-b-a8878.firebaseio.com",
  projectId: "fire-b-a8878",
  storageBucket: "fire-b-a8878.appspot.com",
  messagingSenderId: "658673187627",
  appId: "1:658673187627:web:6e4c29af661785f0afa36e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const reelContainer = document.getElementById('reelContainer');
let currentUser = null;

let activeReelId = null; // For comment modal

onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    loadReels();
  } else {
    window.location.href = 'signup.html';
  }
});

async function loadReels() {
  const statusesRef = ref(db, 'statuses');
  onValue(statusesRef, async (snapshot) => {
    reelContainer.innerHTML = '';
    const statuses = snapshot.val();
    if (!statuses) return;

    const entries = Object.entries(statuses).reverse();
    for (const [statusId, status] of entries) {
      if (!status.media) continue;

      const userSnap = await get(ref(db, `users/${status.userId}`));
      const userInfo = userSnap.exists() ? userSnap.val() : { name: "Anonymous", avatar: "https://i.pravatar.cc/150?u=" + status.userId };

      status.media.forEach((media, idx) => {
        if (media.type !== 'video') return;

        const reel = document.createElement('div');
        reel.className = 'reel';

        const video = document.createElement('video');
        video.src = media.url;
        video.autoplay = idx === 0;
        video.loop = true;
        video.muted = true;
        video.playsInline = true;

        video.addEventListener('click', () => {
          video.muted = !video.muted;
        });

        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        overlay.innerHTML = `
          <div class="user-info">
            <img src="${userInfo.avatar}" alt="avatar" />
            <strong>${userInfo.name}</strong>
          </div>
          <p class="mt-1">${status.text || ''}</p>
        `;

        const actions = document.createElement('div');
        actions.className = 'actions';

        const likeBtn = document.createElement('button');
        likeBtn.innerHTML = status.reactions?.[currentUser.uid] ? '‚ù§Ô∏è' : 'ü§ç';
        likeBtn.addEventListener('click', () => toggleLike(statusId, likeBtn));

        const commentBtn = document.createElement('button');
        commentBtn.innerHTML = 'üí¨';
        commentBtn.addEventListener('click', () => openComments(statusId));

        const shareBtn = document.createElement('button');
        shareBtn.innerHTML = 'üì§';
        shareBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(window.location.href).then(() =>
            alert("Reel link copied!")
          );
        });

        actions.append(likeBtn, commentBtn, shareBtn);
        reel.append(video, overlay, actions);
        reelContainer.appendChild(reel);
      });
    }

    observeVideos();
  });
}

function toggleLike(statusId, likeBtn) {
  const likeRef = ref(db, `statuses/${statusId}/reactions/${currentUser.uid}`);
  const isLiked = likeBtn.innerHTML === '‚ù§Ô∏è';
  set(likeRef, isLiked ? null : true).then(() => {
    likeBtn.innerHTML = isLiked ? 'ü§ç' : '‚ù§Ô∏è';
  });
}

function observeVideos() {
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      const video = entry.target;
      if (entry.isIntersecting) {
        video.play().catch(() => {});
      } else {
        video.pause();
      }
    });
  }, { threshold: 0.6 });

  document.querySelectorAll('video').forEach(video => observer.observe(video));
}

// ---------------------- COMMENTS ----------------------
const commentModal = document.getElementById('commentModal');
const commentList = document.getElementById('commentList');
const commentInput = document.getElementById('commentInput');
const postCommentBtn = document.getElementById('postCommentBtn');

function openComments(statusId) {
  activeReelId = statusId;
  commentModal.style.display = 'flex';
  commentList.innerHTML = 'Loading...';

  const commentsRef = ref(db, `statuses/${statusId}/comments`);
  onValue(commentsRef, async (snapshot) => {
    const comments = snapshot.val() || {};
    const entries = Object.entries(comments);
    commentList.innerHTML = '';

    for (const [commentId, comment] of entries.reverse()) {
      const userSnap = await get(ref(db, `users/${comment.userId}`));
      const user = userSnap.exists() ? userSnap.val() : { name: 'User' };
      const div = document.createElement('div');
      div.className = 'comment';
      div.innerHTML = `<strong>${user.name}</strong><br>${comment.text}`;
      commentList.appendChild(div);
    }
  });
}

postCommentBtn.addEventListener('click', () => {
  const text = commentInput.value.trim();
  if (!text || !activeReelId) return;
  const newRef = push(ref(db, `statuses/${activeReelId}/comments`));
  set(newRef, {
    userId: currentUser.uid,
    text,
    timestamp: Date.now()
  }).then(() => {
    commentInput.value = '';
  });
});

window.closeModal = () => {
  commentModal.style.display = 'none';
};
</script>
</body>
</html>
