<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Privy â€¢ Connect</title>
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      /* Colors */
      --bg: #f2f4f7;
      --surface: #ffffff;
      --border: #e4e7eb;
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --text-main: #111827;
      --text-muted: #6b7280;
      --danger: #ef4444;
      --success: #10b981;
      
      /* Layout */
      --header-h: 60px;
      --tab-h: 48px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main);
      height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
    }

    /* --- Views --- */
    .view {
      position: absolute; inset: 0; background: var(--bg);
      display: flex; flex-direction: column;
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      z-index: 10;
    }
    .view.hidden { transform: translateX(100%); pointer-events: none; }
    .view.active { transform: translateX(0); }
    #loginView { z-index: 50; justify-content: center; align-items: center; padding: 24px; text-align: center; background: var(--surface); }

    /* --- Common UI --- */
    header {
      height: var(--header-h); padding: 0 16px;
      display: flex; align-items: center; justify-content: space-between;
      background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border); z-index: 20;
    }
    .header-title { font-weight: 700; font-size: 18px; }
    .icon-btn {
      background: none; border: none; padding: 8px; border-radius: 50%;
      cursor: pointer; display: flex; color: var(--text-main);
    }
    .icon-btn:active { background: var(--border); }
    .avatar {
      width: 36px; height: 36px; border-radius: 50%; background-color: #ddd;
      background-size: cover; background-position: center; flex-shrink: 0;
    }

    /* --- Tabs --- */
    .tab-bar {
      display: flex; background: var(--surface);
      border-bottom: 1px solid var(--border); height: var(--tab-h);
    }
    .tab-btn {
      flex: 1; border: none; background: none; font-weight: 600; color: var(--text-muted);
      font-size: 14px; position: relative; cursor: pointer;
    }
    .tab-btn.active { color: var(--primary); }
    .tab-btn.active::after {
      content: ''; position: absolute; bottom: 0; left: 25%; right: 25%;
      height: 3px; background: var(--primary); border-radius: 3px 3px 0 0;
    }

    /* --- Lists --- */
    .scroll-area { flex: 1; overflow-y: auto; }
    .list-section { display: none; }
    .list-section.active { display: block; }

    .chat-row, .friend-row {
      display: flex; align-items: center; gap: 12px; padding: 14px 16px;
      background: var(--surface); border-bottom: 1px solid var(--border); cursor: pointer;
    }
    .chat-row:active, .friend-row:active { background: #f9fafb; }
    
    .row-content { flex: 1; min-width: 0; }
    .row-title { font-weight: 600; font-size: 15px; margin-bottom: 2px; }
    .row-sub { font-size: 13px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .row-meta { font-size: 11px; color: var(--text-muted); text-align: right; }
    .badge { 
      background: var(--primary); color: white; font-size: 10px; font-weight: 700;
      padding: 2px 6px; border-radius: 10px; display: inline-block; margin-top: 4px;
    }

    /* --- Profile & Settings --- */
    .profile-hero {
      background: var(--surface); padding: 30px 20px;
      display: flex; flex-direction: column; align-items: center; gap: 16px;
      border-bottom: 1px solid var(--border);
    }
    .big-avatar {
      width: 90px; height: 90px; border-radius: 50%; position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); background-size: cover;
    }
    .edit-badge {
      position: absolute; bottom: 0; right: 0; background: var(--primary); color: white;
      width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      border: 2px solid var(--surface);
    }
    
    .settings-list { padding: 20px; }
    .setting-item {
      display: flex; align-items: center; gap: 16px; padding: 16px;
      background: var(--surface); border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .setting-item:first-child { border-radius: 12px 12px 0 0; }
    .setting-item:last-child { border-radius: 0 0 12px 12px; border-bottom: none; }
    .setting-label { flex: 1; font-weight: 500; font-size: 15px; }
    .setting-icon { color: var(--text-muted); }

    /* --- Chat Room --- */
    .chat-status { font-size: 11px; color: var(--text-muted); }
    .chat-status.online { color: var(--success); font-weight: 600; }
    
    #msgList {
      flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px;
    }
    .msg {
      max-width: 75%; padding: 10px 14px; font-size: 15px; line-height: 1.4;
      border-radius: 18px; word-wrap: break-word; position: relative;
    }
    .msg.sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
    .msg.recv { align-self: flex-start; background: var(--surface); color: var(--text-main); border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .msg-time { font-size: 9px; opacity: 0.7; margin-top: 4px; text-align: right; }

    .input-bar {
      padding: 10px 16px; background: var(--surface); border-top: 1px solid var(--border);
      display: flex; gap: 10px; align-items: flex-end;
    }
    textarea {
      flex: 1; background: var(--bg); border: none; border-radius: 20px;
      padding: 12px 16px; font-family: inherit; font-size: 15px; resize: none; max-height: 100px;
    }
    textarea:focus { outline: 2px solid var(--primary); }

    /* --- Custom Modal --- */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: auto; }
    .modal-box {
      background: var(--surface); width: 85%; max-width: 320px;
      border-radius: 16px; padding: 24px; text-align: center;
      transform: scale(0.9); transition: transform 0.2s; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .modal-overlay.open .modal-box { transform: scale(1); }
    .modal-title { font-weight: 700; font-size: 18px; margin-bottom: 8px; }
    .modal-text { color: var(--text-muted); font-size: 14px; margin-bottom: 24px; }
    .modal-actions { display: flex; gap: 12px; justify-content: center; }
    .modal-btn {
      flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 600; font-size: 14px; cursor: pointer;
    }
    .btn-cancel { background: var(--bg); color: var(--text-main); }
    .btn-confirm { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }

    /* --- Bottom Sheet --- */
    .bottom-sheet {
      position: fixed; left: 0; bottom: 0; width: 100%; background: var(--surface);
      border-radius: 24px 24px 0 0; transform: translateY(100%); transition: transform 0.3s;
      z-index: 100; max-height: 85vh; display: flex; flex-direction: column;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
    }
    .bottom-sheet.active { transform: translateY(0); }
    .sheet-handle { width: 40px; height: 4px; background: #ddd; margin: 12px auto; border-radius: 2px; }
    .sheet-search { padding: 0 16px 16px; }
    .search-input-wrap {
      background: var(--bg); border-radius: 10px; display: flex; align-items: center; padding: 0 12px; height: 44px;
    }
    .search-input-wrap input {
      border: none; background: transparent; flex: 1; margin-left: 8px; outline: none;
    }
    
    .fab {
      position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px;
      background: var(--primary); color: white; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 14px rgba(37,99,235,0.4); cursor: pointer; z-index: 90;
    }
  </style>
</head>
<body>

  <div id="customModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-title" id="mTitle">Alert</div>
      <div class="modal-text" id="mText">Message goes here.</div>
      <div class="modal-actions" id="mActions">
        </div>
    </div>
  </div>

  <div id="loginView" class="view">
    <h1 style="color:var(--primary); font-size:40px; margin-bottom:10px;">Privy.</h1>
    <p style="color:var(--text-muted); margin-bottom:40px;">Simple. Secure. Social.</p>
    <button onclick="handleLogin()" style="background:var(--text-main); color:white; padding:14px 30px; border:none; border-radius:30px; font-weight:600; display:flex; align-items:center; gap:10px;">
      <span class="material-symbols-rounded">login</span> Sign in with Google
    </button>
  </div>

  <div id="listView" class="view hidden">
    <header>
      <div class="header-title">Privy</div>
      <div class="avatar" id="headerAvatar" onclick="openProfile()"></div>
    </header>

    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchTab('chats')" id="tabChats">Chats</button>
      <button class="tab-btn" onclick="switchTab('friends')" id="tabFriends">Friends</button>
    </div>

    <div id="chatsSection" class="scroll-area list-section active">
      <div id="chatListContainer"></div>
    </div>

    <div id="friendsSection" class="scroll-area list-section">
      <div id="friendsListContainer"></div>
    </div>

    <div class="fab" onclick="openSheet()">
      <span class="material-symbols-rounded">person_add</span>
    </div>
  </div>

  <div id="chatView" class="view hidden">
    <header>
      <button class="icon-btn" onclick="navBack()"><span class="material-symbols-rounded">arrow_back</span></button>
      <div style="flex:1; margin-left:8px;">
        <div style="font-weight:600; font-size:16px;" id="roomName">User</div>
        <div class="chat-status" id="roomStatus">offline</div>
      </div>
      <div class="avatar" id="roomAvatar"></div>
    </header>
    <div id="msgList"></div>
    <div class="input-bar">
      <textarea id="msgInput" rows="1" placeholder="Message..."></textarea>
      <button class="icon-btn" style="background:var(--primary); color:white;" onclick="sendMessage()">
        <span class="material-symbols-rounded">send</span>
      </button>
    </div>
  </div>

  <div id="profileView" class="view hidden">
    <header>
      <button class="icon-btn" onclick="navBack()"><span class="material-symbols-rounded">arrow_back</span></button>
      <div class="header-title">Profile</div>
      <div style="width:40px"></div>
    </header>
    
    <div class="profile-hero">
      <div class="big-avatar" id="profileAvatar" onclick="document.getElementById('fileInput').click()">
        <div class="edit-badge"><span class="material-symbols-rounded" style="font-size:16px">edit</span></div>
      </div>
      <input type="file" id="fileInput" hidden accept="image/*" onchange="uploadImage(this)">
      <div style="width:100%">
        <input type="text" id="editUsername" placeholder="Username" 
               style="width:100%; text-align:center; padding:10px; border:1px solid var(--border); border-radius:10px; font-size:18px; font-weight:600; margin-bottom:8px;">
        <button onclick="saveProfile()" style="width:100%; padding:10px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:600;">Save Changes</button>
      </div>
    </div>

    <div style="padding:16px 20px 8px; font-size:12px; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Settings</div>
    <div class="settings-list">
      <div class="setting-item" onclick="showAlert('Account', 'Account management is coming soon.')">
        <span class="material-symbols-rounded setting-icon">person</span>
        <div class="setting-label">Account</div>
        <span class="material-symbols-rounded setting-icon">chevron_right</span>
      </div>
      <div class="setting-item" onclick="showAlert('Privacy', 'End-to-End encryption is active.')">
        <span class="material-symbols-rounded setting-icon">lock</span>
        <div class="setting-label">Privacy</div>
        <span class="material-symbols-rounded setting-icon">chevron_right</span>
      </div>
      <div class="setting-item" onclick="showAlert('Notifications', 'Push notifications enabled.')">
        <span class="material-symbols-rounded setting-icon">notifications</span>
        <div class="setting-label">Notifications</div>
        <span class="material-symbols-rounded setting-icon">toggle_on</span>
      </div>
      <div class="setting-item" onclick="handleLogout()" style="color:var(--danger)">
        <span class="material-symbols-rounded setting-icon" style="color:var(--danger)">logout</span>
        <div class="setting-label">Log Out</div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="sheetOverlay" onclick="closeSheet()"></div>
  <div class="bottom-sheet" id="bottomSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-search">
      <div class="search-input-wrap">
        <span class="material-symbols-rounded" style="color:var(--text-muted)">search</span>
        <input type="text" id="friendSearch" placeholder="Search by Username, ID, or Email..." onkeyup="filterUsers()">
      </div>
    </div>
    <div style="padding:0 16px 8px; font-size:12px; font-weight:700; color:var(--text-muted);">ADDED FRIENDS & USERS</div>
    <div class="scroll-area" id="sheetUserList" style="padding-bottom:20px;"></div>
  </div>

  <script>
    // --- CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // --- STATE ---
    let currentUser = null;
    let currentChatUid = null;
    let currentRoomId = null;
    let allUsersCache = [];
    let sharedKeys = JSON.parse(localStorage.getItem('sharedKeys') || '{}');
    let listeners = [];

    // --- AUTH ---
    auth.onAuthStateChanged(async (u) => {
      if (u) {
        currentUser = u;
        switchView('listView');
        setupPresence(u.uid);
        
        // Ensure Key Pair
        if (!localStorage.getItem('privKey')) await generateKeyPair();
        
        // Ensure Profile exists
        const pRef = db.ref(`users/${u.uid}/profile`);
        const pSnap = await pRef.once('value');
        if (!pSnap.exists()) {
           const pubKey = await exportPublicKey();
           await pRef.set({
             name: u.displayName, email: u.email, photo: u.photoURL, uid: u.uid,
             username: u.displayName, publicKey: JSON.stringify(pubKey)
           });
        }
        
        loadChats();
        loadFriends(); // Load directory for the Friends Tab
        updateAvatarUI(pSnap.val()?.photo || u.photoURL);
      } else {
        switchView('loginView');
      }
    });

    function handleLogin() {
      auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    }
    
    function handleLogout() {
      showConfirm("Log Out", "Are you sure you want to log out?", () => auth.signOut());
    }

    // --- CRYPTO ---
    async function generateKeyPair() {
      const kp = await crypto.subtle.generateKey({ name:"ECDH", namedCurve:"P-256"}, true, ["deriveBits"]);
      const priv = await crypto.subtle.exportKey("jwk", kp.privateKey);
      const pub = await crypto.subtle.exportKey("jwk", kp.publicKey);
      localStorage.setItem('privKey', JSON.stringify(priv));
      localStorage.setItem('pubKey', JSON.stringify(pub));
    }
    async function exportPublicKey() {
      return JSON.parse(localStorage.getItem('pubKey'));
    }
    async function getSecret(friendUid, friendPubKeyStr) {
       if (sharedKeys[friendUid]) return sharedKeys[friendUid];
       if (!friendPubKeyStr) return null;
       try {
         const privJwk = JSON.parse(localStorage.getItem('privKey'));
         const privKey = await crypto.subtle.importKey("jwk", privJwk, {name:"ECDH", namedCurve:"P-256"}, false, ["deriveBits"]);
         const pubKey = await crypto.subtle.importKey("jwk", JSON.parse(friendPubKeyStr), {name:"ECDH", namedCurve:"P-256"}, false, []);
         const bits = await crypto.subtle.deriveBits({name:"ECDH", public:pubKey}, privKey, 256);
         const hex = Array.from(new Uint8Array(bits)).map(b=>b.toString(16).padStart(2,'0')).join('');
         sharedKeys[friendUid] = hex;
         localStorage.setItem('sharedKeys', JSON.stringify(sharedKeys));
         return hex;
       } catch(e) { console.error(e); return null; }
    }

    // --- DATA LOADING ---
    function loadChats() {
      db.ref(`users/${currentUser.uid}/chats`).on('value', async snap => {
        const container = document.getElementById('chatListContainer');
        container.innerHTML = '';
        if(!snap.exists()) { container.innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-muted)">No recent chats.</div>`; return; }
        
        const list = [];
        snap.forEach(c => list.push({key:c.key, ...c.val()}));
        list.sort((a,b) => b.ts - a.ts);

        for(let c of list) {
          const uSnap = await db.ref(`users/${c.key}/profile`).once('value');
          const u = uSnap.val();
          if(!u) continue;
          
          let preview = "Locked Message";
          const secret = await getSecret(c.key, u.publicKey);
          if(secret && c.lastMsg) {
             try { preview = CryptoJS.AES.decrypt(c.lastMsg, secret).toString(CryptoJS.enc.Utf8) || preview; } catch(e){}
          }
          
          const div = document.createElement('div');
          div.className = 'chat-row';
          div.onclick = () => openChat(c.key, u);
          div.innerHTML = `
            <div class="avatar" style="background-image:url(${u.photo})"></div>
            <div class="row-content">
              <div class="row-title">${u.username || u.name}</div>
              <div class="row-sub">${preview}</div>
            </div>
            <div class="row-meta">
              <div>${formatTime(c.ts)}</div>
              ${c.unreadCount ? `<span class="badge">${c.unreadCount}</span>` : ''}
              <div style="margin-top:4px; color:var(--danger)" onclick="event.stopPropagation(); deleteChat('${c.key}')">
                <span class="material-symbols-rounded" style="font-size:16px">delete</span>
              </div>
            </div>
          `;
          container.appendChild(div);
        }
      });
    }

    function loadFriends() {
      // For this demo, Friends Tab shows all users, filtered to act as a directory
      db.ref('users').once('value', snap => {
        allUsersCache = [];
        snap.forEach(s => {
          if(s.key !== currentUser.uid) allUsersCache.push(s.val().profile);
        });
        renderFriendsList();
      });
    }

    function renderFriendsList(filter = "") {
        const container = document.getElementById('friendsListContainer');
        container.innerHTML = '';
        const q = filter.toLowerCase();
        
        const filtered = allUsersCache.filter(u => 
            (u.username||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q)
        );

        filtered.forEach(u => {
            const div = document.createElement('div');
            div.className = 'friend-row';
            div.onclick = () => openChat(u.uid, u); // Clicking friends opens chat
            div.innerHTML = `
                <div class="avatar" style="background-image:url(${u.photo})"></div>
                <div class="row-content">
                    <div class="row-title">${u.username || u.name}</div>
                    <div class="row-sub">${u.email}</div>
                </div>
                <span class="material-symbols-rounded" style="color:var(--primary)">chat</span>
            `;
            container.appendChild(div);
        });
    }

    // --- ACTIONS ---
    function deleteChat(uid) {
        showConfirm("Delete Chat", "Are you sure? This will hide the conversation.", () => {
            db.ref(`users/${currentUser.uid}/chats/${uid}`).remove();
        });
    }

    async function openChat(uid, profile) {
      currentChatUid = uid;
      currentRoomId = [currentUser.uid, uid].sort().join('_');
      
      document.getElementById('roomName').innerText = profile.username || profile.name;
      document.getElementById('roomAvatar').style.backgroundImage = `url(${profile.photo})`;
      switchView('chatView');

      // Header Status Listener
      db.ref(`users/${uid}`).on('value', snap => {
          const s = snap.val();
          const el = document.getElementById('roomStatus');
          if(s?.status === 'online') {
              el.innerText = 'Online'; el.className = 'chat-status online';
          } else {
              el.className = 'chat-status';
              el.innerText = s?.lastSeen ? `Last seen ${formatTime(s.lastSeen)}` : 'Offline';
          }
      });

      // Clear Unread
      db.ref(`users/${currentUser.uid}/chats/${uid}`).update({unreadCount:0});

      // Load Messages
      const list = document.getElementById('msgList');
      list.innerHTML = '';
      db.ref(`messages/${currentRoomId}`).limitToLast(50).on('child_added', async snap => {
         const m = snap.val();
         const isMe = m.sender === currentUser.uid;
         const secret = await getSecret(uid, profile.publicKey);
         let text = "[Encrypted]";
         if(secret) {
             try { text = CryptoJS.AES.decrypt(m.text, secret).toString(CryptoJS.enc.Utf8); } catch(e){}
         }
         
         const div = document.createElement('div');
         div.className = `msg ${isMe?'sent':'recv'}`;
         div.innerHTML = `${text}<div class="msg-time">${formatTime(m.ts)}</div>`;
         list.appendChild(div);
         list.scrollTop = list.scrollHeight;
      });
    }

    async function sendMessage() {
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
        if(!text) return;

        if(!currentChatUid) return showAlert("Error", "Chat context lost.");
        
        // Ensure we have the user profile to get key
        const snap = await db.ref(`users/${currentChatUid}/profile`).once('value');
        const profile = snap.val();
        const secret = await getSecret(currentChatUid, profile.publicKey);
        
        if(!secret) return showAlert("Encryption Error", "Could not establish secure key.");

        const encrypted = CryptoJS.AES.encrypt(text, secret).toString();
        const ts = Date.now();

        input.value = ''; // Clear early

        const updates = {};
        const msgKey = db.ref(`messages/${currentRoomId}`).push().key;
        updates[`messages/${currentRoomId}/${msgKey}`] = { sender: currentUser.uid, text: encrypted, ts: ts };
        
        // Update both user's chat lists
        const chatData = { lastMsg: encrypted, ts: ts };
        updates[`users/${currentUser.uid}/chats/${currentChatUid}`] = { ...chatData, unreadCount: 0 }; // My side
        
        // Transaction for recipient unread count is hard in multi-path, doing simple update for now, ideally separate transaction
        db.ref(`users/${currentChatUid}/chats/${currentUser.uid}`).transaction(d => {
            return { ...d, lastMsg: encrypted, ts: ts, unreadCount: (d?.unreadCount||0) + 1 };
        });

        db.ref().update(updates);
    }

    // --- TABS & UI ---
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.list-section').forEach(s => s.classList.remove('active'));
        
        if(tab === 'chats') {
            document.getElementById('tabChats').classList.add('active');
            document.getElementById('chatsSection').classList.add('active');
        } else {
            document.getElementById('tabFriends').classList.add('active');
            document.getElementById('friendsSection').classList.add('active');
            renderFriendsList(); // Refresh
        }
    }

    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => {
            v.classList.remove('active'); v.classList.add('hidden');
        });
        const t = document.getElementById(id);
        t.classList.remove('hidden'); t.classList.add('active');
    }

    // --- MODAL SYSTEM ---
    function showAlert(title, text) {
        setupModal(title, text, [{ text: "OK", class: "btn-confirm", cb: closeModal }]);
    }
    function showConfirm(title, text, onConfirm) {
        setupModal(title, text, [
            { text: "Cancel", class: "btn-cancel", cb: closeModal },
            { text: "Confirm", class: "btn-confirm", cb: () => { onConfirm(); closeModal(); } }
        ]);
    }
    function setupModal(title, text, buttons) {
        document.getElementById('mTitle').innerText = title;
        document.getElementById('mText').innerText = text;
        const act = document.getElementById('mActions');
        act.innerHTML = '';
        buttons.forEach(b => {
            const btn = document.createElement('button');
            btn.className = `modal-btn ${b.class}`;
            btn.innerText = b.text;
            btn.onclick = b.cb;
            act.appendChild(btn);
        });
        document.getElementById('customModal').classList.add('open');
    }
    function closeModal() { document.getElementById('customModal').classList.remove('open'); }

    // --- PROFILE & UPLOAD ---
    function openProfile() {
        switchView('profileView');
        db.ref(`users/${currentUser.uid}/profile`).once('value', s => {
            const p = s.val();
            document.getElementById('editUsername').value = p.username || p.name;
            updateAvatarUI(p.photo);
        });
    }
    async function saveProfile() {
        const name = document.getElementById('editUsername').value;
        await db.ref(`users/${currentUser.uid}/profile`).update({ username: name, name: name });
        showAlert("Success", "Profile updated successfully.");
    }
    async function uploadImage(input) {
        const file = input.files[0];
        if(!file) return;
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', 'privy_preset'); // *** SET CLOUDINARY PRESET ***
        
        const res = await fetch('https://api.cloudinary.com/v1_1/dtrj5h016/image/upload', { // *** SET CLOUD NAME ***
            method: 'POST', body: formData
        });
        const data = await res.json();
        if(data.secure_url) {
            await db.ref(`users/${currentUser.uid}/profile`).update({ photo: data.secure_url });
            updateAvatarUI(data.secure_url);
            showAlert("Success", "Avatar updated!");
        } else {
            showAlert("Error", "Upload failed.");
        }
    }
    function updateAvatarUI(url) {
        const u = url || 'https://via.placeholder.com/100';
        document.getElementById('headerAvatar').style.backgroundImage = `url(${u})`;
        document.getElementById('profileAvatar').style.backgroundImage = `url(${u})`;
    }

    // --- HELPERS ---
    function formatTime(ts) {
        const d = new Date(ts);
        const now = new Date();
        if (d.toDateString() === now.toDateString()) return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        return d.toLocaleDateString();
    }
    function navBack() { switchView('listView'); db.ref('.info/connected').off(); }
    
    // Bottom Sheet
    function openSheet() { 
        document.getElementById('sheetOverlay').classList.add('open');
        document.getElementById('bottomSheet').classList.add('active');
        // Render sheet with same list as Friends tab initially
        const list = document.getElementById('sheetUserList');
        list.innerHTML = '';
        allUsersCache.forEach(u => {
             const div = document.createElement('div');
             div.className = 'friend-row';
             div.onclick = () => { closeSheet(); openChat(u.uid, u); };
             div.innerHTML = `<div class="avatar" style="background-image:url(${u.photo})"></div><div class="row-content"><div class="row-title">${u.username}</div><div class="row-sub">${u.email}</div></div>`;
             list.appendChild(div);
        });
    }
    function closeSheet() {
        document.getElementById('sheetOverlay').classList.remove('open');
        document.getElementById('bottomSheet').classList.remove('active');
    }
    function filterUsers() {
       const q = document.getElementById('friendSearch').value.toLowerCase();
       const rows = document.querySelectorAll('#sheetUserList .friend-row');
       rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(q) ? 'flex' : 'none');
    }

    // Setup Presence
    function setupPresence(uid) {
        const ref = db.ref(`users/${uid}`);
        db.ref('.info/connected').on('value', snap => {
            if(snap.val()) {
                ref.onDisconnect().update({ status: 'offline', lastSeen: firebase.database.ServerValue.TIMESTAMP });
                ref.update({ status: 'online' });
            }
        });
    }

    // Auto resize text area
    document.getElementById('msgInput').addEventListener('input', function() {
        this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px';
    });
  </script>
</body>
</html>
