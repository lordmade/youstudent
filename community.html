<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vynix</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --accent-purple: #d946ef;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --bg-color: #f8f9fa;
            --glass-white: rgba(255, 255, 255, 0.95);
            --logo-gradient: linear-gradient(135deg, #000000 0%, var(--accent-purple) 50%, #10b981 100%);
            --online-green: #10b981;
        }
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            box-sizing: border-box;
            outline: none;
        }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-primary); overflow-x: hidden; }
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmerEffect 1.5s infinite linear;
        }
        @keyframes shimmerEffect { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        header {
            position: fixed; top: 0; left: 0; right: 0; height: 75px; background: var(--glass-white);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000; backdrop-filter: blur(12px); border-bottom: 1px solid #eee;
        }
        .user-profile {
            width: 42px; height: 42px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--accent-purple); cursor: pointer;
            position: relative;
        }
        .app-title { font-size: 24px; font-weight: 800; background: var(--logo-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1.2px; }
        .pill-nav {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            background: #000; width: 240px; height: 64px; border-radius: 40px;
            display: flex; align-items: center; justify-content: space-around;
            padding: 0 10px; z-index: 2000; box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }
        .nav-item { color: #666; display: flex; flex-direction: column; align-items: center; transition: 0.3s; cursor: pointer; }
        .nav-item.active { color: #fff; }
        .nav-item span { font-size: 26px; }
        main { padding: 90px 16px 120px 16px; min-height: 100vh; }
        #statusTab { display: none; }
        .chat-card {
            display: flex; align-items: center; padding: 15px;
            background: #fff; margin-bottom: 12px; border-radius: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
            position: relative;
        }
        .avatar-box {
            margin-right: 15px;
            flex-shrink: 0;
            position: relative;
        }
        .avatar { width: 58px; height: 58px; border-radius: 18px; object-fit: cover; }
        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: var(--online-green);
            border: 2.5px solid #fff;
            border-radius: 50%;
            z-index: 1;
        }
        .chat-info { flex: 1; overflow: hidden; padding-right: 50px; }
        .chat-name { font-weight: 700; font-size: 15px; display: block; color: #111; }
        .chat-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; margin-top: 2px; }
        .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .status-card {
            position: relative; height: 280px; border-radius: 30px; overflow: hidden;
            background: #eee; cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .status-card:active { transform: scale(0.95); }
        .status-card img, .status-card video { width: 100%; height: 100%; object-fit: cover; }
        .status-info {
            position: absolute; bottom: 0; width: 100%; padding: 15px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: #fff; font-size: 13px;
        }
        .status-online-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            background: var(--online-green);
            border: 2px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.6);
        }
        #storyViewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; display: none; }
        .story-header { position: absolute; top: 30px; left: 15px; display: flex; align-items: center; z-index: 20; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .story-progress { position: absolute; top: 15px; left: 10px; right: 10px; display: flex; gap: 5px; z-index: 10; }
        .progress-segment { height: 3px; background: rgba(255,255,255,0.3); flex: 1; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: #fff; width: 0%; transition: width linear; }
        #storyMedia { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; }
        #storyMedia img, #storyMedia video { max-width: 100%; max-height: 100%; object-fit: contain; }
        .story-sound-btn, .story-delete {
            position: absolute; background: rgba(0,0,0,0.6); color: #fff;
            width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 28px; z-index: 30; cursor: pointer;
        }
        .story-sound-btn { bottom: 80px; right: 20px; }
        .story-delete { top: 80px; right: 20px; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; z-index: 2500; backdrop-filter: blur(8px); }
        .bottom-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: #fff; border-radius: 35px 35px 0 0; padding: 35px 25px; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2600; max-height: 80vh; overflow-y: auto; }
        .bottom-sheet.active { bottom: 0; }
        .v-input { width: 100%; padding: 18px; border: 2px solid #f3f4f6; border-radius: 20px; margin-bottom: 15px; font-family: inherit; font-size: 15px; }
        .btn-primary { width: 100%; background: #000; color: #fff; border: none; padding: 18px; border-radius: 20px; font-weight: 700; cursor: pointer; font-size: 15px; }
        .btn-danger { background: #ff3b30 !important; }
        .btn-secondary { background: #f1f1f1 !important; color: #000 !important; }
        #toast { position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%); background: #111; color: #fff; padding: 12px 25px; border-radius: 50px; font-size: 13px; z-index: 6000; display: none; }
        .profile-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 4000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .profile-card { background: #fff; width: 85%; max-width: 320px; border-radius: 40px; padding: 45px 20px; text-align: center; }
        .search-container { position: relative; margin-bottom: 15px; padding: 0 16px; }
        .search-input {
            width: 100%; padding: 14px 45px 14px 20px; border: 2px solid #f3f4f6;
            border-radius: 25px; font-family: inherit; font-size: 14px;
            background: #fff; transition: border-color 0.3s;
        }
        .search-input:focus { border-color: var(--accent-purple); outline: none; }
        .search-icon { position: absolute; right: 25px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; }
        .clear-search { position: absolute; right: 25px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); cursor: pointer; display: none; }
        .unread-badge {
            position: absolute; top: 15px; right: 15px;
            background: var(--accent-purple); color: white;
            font-size: 11px; font-weight: 700;
            min-width: 20px; height: 20px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            padding: 0 6px;
        }
        .chat-time { position: absolute; bottom: 15px; right: 15px; font-size: 11px; color: var(--text-secondary); font-weight: 500; }
        .notification-toggle {
            display: flex; align-items: center; justify-content: space-between;
            margin: 20px 0; padding: 15px; background: var(--bg-color); border-radius: 15px;
        }
        .notification-label { font-size: 14px; color: var(--text-primary); font-weight: 500; }
        .toggle-switch {
            position: relative; width: 50px; height: 24px; background: #ccc;
            border-radius: 24px; cursor: pointer; transition: background 0.3s;
        }
        .toggle-switch.active { background: var(--accent-purple); }
        .toggle-slider {
            position: absolute; top: 3px; left: 3px; width: 18px; height: 18px;
            background: white; border-radius: 50%; transition: transform 0.3s;
        }
        .toggle-switch.active .toggle-slider { transform: translateX(26px); }
        .profile-pic-upload {
            width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
            margin: 0 auto 20px; display: block; border: 3px solid var(--accent-purple);
            cursor: pointer;
        }
        #offlineIndicator {
            position: fixed; top: 85px; left: 50%; transform: translateX(-50%);
            background: #ff3b30; color: #fff; padding: 8px 16px; border-radius: 20px;
            font-size: 12px; font-weight: 600; z-index: 999; display: none;
            box-shadow: 0 4px 12px rgba(255,59,48,0.3);
        }
        #fullChatView {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 3000; display: none; flex-direction: column;
        }
        #chatHeader {
            position: fixed; top: 0; left: 0; right: 0; height: 75px;
            background: var(--glass-white); display: flex; align-items: center;
            padding: 0 20px; z-index: 3100; backdrop-filter: blur(12px);
            border-bottom: 1px solid #eee;
        }
        #chatBackBtn { font-size: 28px; cursor: pointer; margin-right: 15px; }
        #chatFriendAvatar {
            width: 42px; height: 42px; border-radius: 50%;
            object-fit: cover; margin-right: 12px; position: relative;
        }
        .chat-header-avatar-wrapper {
            position: relative;
            margin-right: 12px;
        }
        .chat-header-online {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: var(--online-green);
            border: 2px solid var(--glass-white);
            border-radius: 50%;
        }
        #chatFriendName { font-weight: 700; font-size: 18px; }
        #chatStatusInfo { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
        .chat-header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .chat-header-icon {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-primary);
        }
        #messageList {
            flex: 1; padding: 90px 16px 100px 16px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 12px;
        }
        .message {
            max-width: 75%; padding: 12px 16px; border-radius: 20px;
            line-height: 1.4; word-wrap: break-word; position: relative; cursor: pointer;
        }
        .message.sent {
            align-self: flex-end; background: #000; color: #fff;
            border-bottom-right-radius: 6px;
        }
        .message.received {
            align-self: flex-start; background: #fff; color: #111;
            border-bottom-left-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        .message-time { font-size: 10px; opacity: 0.7; margin-top: 4px; text-align: right; }
        .message.sent .message-time { color: #ddd; }
        .reactions { display: flex; gap: 4px; margin-top: 6px; flex-wrap: wrap; }
        .reaction {
            background: rgba(255,255,255,0.8); padding: 2px 8px; border-radius: 20px;
            font-size: 12px; display: flex; align-items: center;
            min-width: 24px; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .message.sent .reaction { background: rgba(0,0,0,0.3); color: #fff; }
        .reaction.mine { border: 1px solid var(--accent-purple); }
        #chatInputArea {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--glass-white); padding: 12px 16px;
            display: flex; align-items: center; backdrop-filter: blur(12px);
            border-top: 1px solid #eee;
        }
        #messageInput {
            flex: 1; padding: 14px 18px; border: 2px solid #f0f0f0;
            border-radius: 30px; font-family: inherit; font-size: 15px;
            background: #fff;
        }
        #sendBtn { margin-left: 10px; font-size: 26px; color: var(--accent-purple); cursor: pointer; }
        .reaction-picker {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #fff; border-radius: 25px; padding: 8px 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2); display: none;
            flex-direction: row; gap: 10px; margin-bottom: 8px; z-index: 10;
            max-width: 90vw;
        }
        .reaction-option { font-size: 26px; cursor: pointer; padding: 4px; }
        .reaction-tutorial {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: #000; color: #fff; padding: 14px 20px; border-radius: 50px;
            font-size: 14px; z-index: 5000; box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            display: none; align-items: center; max-width: 90%;
        }
        .reaction-tutorial::after {
            content: ''; position: absolute; top: 100%; left: 50%;
            transform: translateX(-50%); border: 10px solid transparent;
            border-top-color: #000;
        }
        .my-id-display {
            text-align: center; color: var(--accent-purple); font-weight: 700;
            margin: 15px 0; font-size: 16px; padding: 12px;
            background: #f3e8ff; border-radius: 15px;
        }
        .friend-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .friend-actions button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 20px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        .typing-indicator {
            display: none;
            align-items: center;
            padding: 12px 16px;
            background: #fff;
            border-radius: 20px;
            width: fit-content;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
            30% { opacity: 1; transform: scale(1); }
        }
        .message-status {
            display: inline-block;
            margin-left: 4px;
            font-size: 14px;
            vertical-align: middle;
        }
        .double-check {
            color: var(--online-green);
        }
    </style>
</head>
<body>
    <div id="toast"></div>
    <div id="offlineIndicator">Offline â€¢ Using cached data</div>
   
    <header>
        <div onclick="openSheet('settingsSheet')">
            <img id="myAvatar" class="user-profile shimmer" src="">
        </div>
        <div class="app-title">Vynix</div>
        <span class="material-symbols-rounded" style="color:#000; font-size:28px;" onclick="openSheet('addFriendSheet')">add_circle</span>
    </header>
    <main id="chatsTab">
        <div class="search-container">
            <input type="text" class="search-input" id="friendSearch" placeholder="Search friends..." onkeyup="searchFriends()">
            <span class="material-symbols-rounded search-icon">search</span>
            <span class="material-symbols-rounded clear-search" id="clearSearch" onclick="clearSearch()">close</span>
        </div>
        <div id="chatList">
            <div class="chat-card shimmer" style="height: 90px; opacity: 0.5;"></div>
            <div class="chat-card shimmer" style="height: 90px; opacity: 0.5;"></div>
        </div>
    </main>
    <main id="statusTab">
        <div class="btn-primary" onclick="document.getElementById('fileUpload').click()" style="margin-bottom:20px; background:var(--accent-purple);">
            <span class="material-symbols-rounded" style="vertical-align:middle; margin-right:8px;">add_photo_alternate</span> Post a Moment
        </div>
        <div class="status-grid" id="statusGrid"></div>
    </main>
    <input type="file" id="fileUpload" hidden accept="image/*,video/*" onchange="validateAndUpload(this.files[0])">
    <input type="file" id="profilePicUpload" hidden accept="image/*" onchange="uploadProfilePicture(this.files[0])">
    <div id="storyViewer" onclick="handleStoryTap(event)">
        <div class="story-progress" id="storyProgressBars"></div>
        <div class="story-header" id="storyHeaderInfo"></div>
        <div id="storyMedia"></div>
        <div id="storySoundBtn" class="story-sound-btn" onclick="toggleStorySound(event)">
            <span class="material-symbols-rounded" id="soundIcon">volume_off</span>
        </div>
        <div id="storyDeleteBtn" class="story-delete" style="display:none;" onclick="deleteCurrentStory()">delete</div>
    </div>
    <div class="pill-nav">
        <div class="nav-item active" id="navChats" onclick="switchTab('chats')">
            <span class="material-symbols-rounded">chat_bubble</span>
        </div>
        <div class="nav-item" id="navStatus" onclick="switchTab('status')">
            <span class="material-symbols-rounded">explore</span>
        </div>
    </div>
    <div class="overlay" id="overlay" onclick="closeAll()"></div>
    <div class="bottom-sheet" id="addFriendSheet">
        <h2 style="margin-top:0">Add Friend</h2>
        <p style="color:var(--text-secondary); font-size:13px; margin-bottom:20px;">Enter their unique Vynix ID to start chatting.</p>
        <input type="text" id="friendVynixId" class="v-input" placeholder="e.g. vnx_789">
        <button class="btn-primary" id="addSubmitBtn" onclick="addFriendLogic()">Search & Add</button>
    </div>
    <div class="bottom-sheet" id="settingsSheet">
        <h2>Settings</h2>
        <img id="settingsAvatar" class="profile-pic-upload shimmer" src="" onclick="document.getElementById('profilePicUpload').click()">
        <input type="text" id="editDisplayName" class="v-input" placeholder="Display Name">
        <div class="my-id-display" id="myVynixIdDisplay">Loading your Vynix ID...</div>
        <p style="font-size:13px; color:var(--text-secondary); text-align:center; margin:10px 0 20px;">Share your Vynix ID with friends so they can add you.</p>
        <div class="notification-toggle">
            <span class="notification-label">Push Notifications</span>
            <div class="toggle-switch" id="notificationToggle" onclick="toggleNotifications()">
                <div class="toggle-slider"></div>
            </div>
        </div>
        <button class="btn-primary" onclick="updateProfile()">Save Changes</button>
        <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="auth.signOut()">Logout</button>
    </div>
    <div id="profileDetail" class="profile-modal" onclick="this.style.display='none'">
        <div class="profile-card" onclick="event.stopPropagation()">
            <img id="detailImg" src="" style="width:130px; height:130px; border-radius:30px; object-fit:cover; margin-bottom:15px; border:4px solid var(--accent-purple);">
            <h2 id="detailName" style="margin:0"></h2>
            <div id="detailId" style="color:var(--accent-purple); font-weight:700; margin-top:5px;"></div>
            <div id="detailStatus" style="font-size:12px; color:var(--text-secondary); margin-top:8px;"></div>
            <div class="friend-actions">
                <button class="btn-primary" onclick="messageFromProfile()">
                    <span class="material-symbols-rounded" style="vertical-align:middle; font-size:18px;">chat</span>
                    Message
                </button>
                <button class="btn-primary btn-danger" onclick="confirmUnfriend()">
                    <span class="material-symbols-rounded" style="vertical-align:middle; font-size:18px;">person_remove</span>
                    Unfriend
                </button>
            </div>
            <hr style="border:0; border-top:1px solid #f0f0f0; margin:25px 0;">
            <div style="font-size:13px; color:#999; font-weight:700; cursor:pointer;" onclick="document.getElementById('profileDetail').style.display='none'">CLOSE</div>
        </div>
    </div>
    <div id="fullChatView">
        <div id="chatHeader">
            <span class="material-symbols-rounded" id="chatBackBtn" onclick="closeFullChat()">arrow_back</span>
            <div class="chat-header-avatar-wrapper" onclick="showProfileDetailFromChat()">
                <img id="chatFriendAvatar" src="">
                <div class="chat-header-online" id="chatHeaderOnline" style="display:none;"></div>
            </div>
            <div onclick="showProfileDetailFromChat()" style="flex:1; cursor:pointer;">
                <div id="chatFriendName"></div>
                <div id="chatStatusInfo">Loading...</div>
            </div>
            <div class="chat-header-right">
                <span class="material-symbols-rounded chat-header-icon" onclick="clearChatHistory()">delete_sweep</span>
            </div>
        </div>
        <div id="messageList">
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        <div id="chatInputArea">
            <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="handleEnter(event)" oninput="updateTypingStatus()">
            <span class="material-symbols-rounded" id="sendBtn" onclick="sendMessage()">send</span>
        </div>
    </div>
    <div class="bottom-sheet" id="deleteMessageModal">
        <h3>Delete Message?</h3>
        <p style="color:var(--text-secondary); font-size:14px;">This action cannot be undone.</p>
        <button class="btn-primary btn-danger" onclick="confirmDeleteMessage()">Delete</button>
        <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="closeDeleteModal()">Cancel</button>
    </div>
    <div class="bottom-sheet" id="unfriendModal">
        <h3>Remove Friend?</h3>
        <p style="color:var(--text-secondary); font-size:14px;">This will delete all messages and remove <strong id="unfriendName"></strong> from your contacts.</p>
        <button class="btn-primary btn-danger" onclick="executeUnfriend()">Remove Friend</button>
        <button class="btn-primary btn-secondary" style="margin-top:12px;" onclick="closeUnfriendModal()">Cancel</button>
    </div>
    <div id="reactionTutorial" class="reaction-tutorial">
        <span>ðŸ’¡ Tip:</span> Long press any message to react with an emoji!
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        const CLOUD_NAME = "dqkujefxj";
        const UPLOAD_PRESET = "banter_box";
        const secretBase = "Vynix_E2EE_Core_";
        const VAPID_PUBLIC_KEY = 'BEl62iUYgUivxIkv69yViEuiBIa-Ib9-SkvMeAtA3LFgDzkrxZJjSgSnfckjBJuFGkrN1V6Bh5ay3mW3K3arMGo';
       
        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            databaseURL: "https://fire-b-a8878.firebaseio.com",
            projectId: "fire-b-a8878",
            storageBucket: "fire-b-a8878.firebasestorage.app",
            messagingSenderId: "658673187627",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };
       
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let currentUser = null;
        let myVId = "";
        let myProfile = { name: "", photo: "" };
        let friendProfileListeners = {};
        let onlineStatusListeners = {};
        let currentFriendListener = null;
        let storyQueue = [];
        let storyIndex = 0;
        let storyTimer;
        let cachedChats = {};
        let cachedMoments = {};
        let isOnline = navigator.onLine;
        let currentFriendUid = null;
        let currentRoomId = null;
        let messagesListener = null;
        let lastSeenListener = null;
        let onlineListener = null;
        let typingListener = null;
        let messageToDelete = null;
        let hasShownReactionTutorial = false;
        let currentStoryVideo = null;
        let currentStoryKey = null;
        let storyMuted = true;
        let isTransitioning = false;
        let typingTimeout = null;
        let profileDetailFriendUid = null;
        const availableReactions = ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ™'];

        function listenToMyProfile() {
            db.ref(`users/${currentUser.uid}/profile`).on('value', snap => {
                const data = snap.val() || {};
                myProfile.name = data.name || "";
                myProfile.photo = data.photo || "";
                myVId = data.vynixId || myVId;
               
                document.getElementById('myAvatar').src = myProfile.photo;
                document.getElementById('settingsAvatar').src = myProfile.photo;
                document.getElementById('editDisplayName').value = myProfile.name;
                document.getElementById('myAvatar').classList.remove('shimmer');
                document.getElementById('settingsAvatar').classList.remove('shimmer');
               
                updateVisibleMomentsOwnerInfo();
                localStorage.setItem('vynix_profile', JSON.stringify({name: myProfile.name, photo: myProfile.photo, vynixId: myVId}));
                updateMyIdDisplay();
            });
        }

        function updateVisibleMomentsOwnerInfo() {
            if (document.getElementById('storyViewer').style.display === 'block') {
                const header = document.getElementById('storyHeaderInfo');
                if (header.querySelector('b') && header.querySelector('b').textContent === myProfile.name) {
                    header.innerHTML = `<img src="${myProfile.photo}" style="width:32px; height:32px; border-radius:50%; margin-right:10px; border:1px solid #fff;"> <b>${myProfile.name}</b>`;
                }
            }
        }

        function setupFriendProfileListener(friendUid) {
            if (friendProfileListeners[friendUid]) return;
           
            const listener = db.ref(`users/${friendUid}/profile`).on('value', snap => {
                const data = snap.val() || { name: "User", photo: "" };
               
                const chatCards = document.querySelectorAll('#chatList .chat-card');
                chatCards.forEach(card => {
                    const avatarBox = card.querySelector('.avatar-box');
                    if (avatarBox && avatarBox.dataset.friendUid === friendUid) {
                        const avatarImg = card.querySelector('.avatar');
                        const nameSpan = card.querySelector('.chat-name');
                        if (avatarImg) avatarImg.src = data.photo || '';
                        if (nameSpan) nameSpan.textContent = data.name;
                    }
                });
               
                if (currentFriendUid === friendUid) {
                    document.getElementById('chatFriendAvatar').src = data.photo || '';
                    document.getElementById('chatFriendName').textContent = data.name;
                }
               
                if (profileDetailFriendUid === friendUid) {
                    document.getElementById('detailName').textContent = data.name;
                    document.getElementById('detailImg').src = data.photo || '';
                }
               
                if (document.getElementById('storyViewer').style.display === 'block') {
                    const headerName = document.getElementById('storyHeaderInfo').querySelector('b');
                    if (headerName && storyQueue.length > 0 && storyQueue[storyIndex]) {
                        const currentStory = storyQueue[storyIndex];
                        if (currentStory && currentStory.uid === friendUid) {
                            document.getElementById('storyHeaderInfo').innerHTML = `<img src="${data.photo || ''}" style="width:32px; height:32px; border-radius:50%; margin-right:10px; border:1px solid #fff;"> <b>${data.name}</b>`;
                        }
                    }
                }
            });
           
            friendProfileListeners[friendUid] = listener;
        }

        function setupOnlineStatusListener(friendUid) {
            if (onlineStatusListeners[friendUid]) return;
           
            const listener = db.ref(`users/${friendUid}/online`).on('value', snap => {
                const isOnline = snap.val() === true;
               
                const chatCards = document.querySelectorAll('#chatList .chat-card');
                chatCards.forEach(card => {
                    const avatarBox = card.querySelector('.avatar-box');
                    if (avatarBox && avatarBox.dataset.friendUid === friendUid) {
                        let indicator = avatarBox.querySelector('.online-indicator');
                        if (isOnline) {
                            if (!indicator) {
                                indicator = document.createElement('div');
                                indicator.className = 'online-indicator';
                                avatarBox.appendChild(indicator);
                            }
                        } else {
                            if (indicator) indicator.remove();
                        }
                    }
                });
               
                const statusCards = document.querySelectorAll('.status-card');
                statusCards.forEach(card => {
                    if (card.dataset.friendUid === friendUid) {
                        let indicator = card.querySelector('.status-online-indicator');
                        if (isOnline) {
                            if (!indicator) {
                                indicator = document.createElement('div');
                                indicator.className = 'status-online-indicator';
                                card.appendChild(indicator);
                            }
                        } else {
                            if (indicator) indicator.remove();
                        }
                    }
                });
               
                if (currentFriendUid === friendUid) {
                    const headerOnline = document.getElementById('chatHeaderOnline');
                    headerOnline.style.display = isOnline ? 'block' : 'none';
                }

                if (profileDetailFriendUid === friendUid) {
                    updateProfileDetailStatus(friendUid);
                }
            });
           
            onlineStatusListeners[friendUid] = listener;
        }

        function generateVynixId() {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let suffix = '';
            for (let i = 0; i < 6; i++) {
                suffix += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return 'vnx_' + suffix;
        }

        async function generateAndAssignVynixId() {
            let attempts = 0;
            const maxAttempts = 20;
            while (attempts < maxAttempts) {
                const candidate = generateVynixId();
                const snap = await db.ref(`vynix_ids/${candidate}`).once('value');
                if (!snap.exists()) {
                    return candidate;
                }
                attempts++;
            }
            toast('Failed to generate unique ID. Try again later.');
            return null;
        }

        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            document.getElementById('offlineIndicator').style.display = isOnline ? 'none' : 'block';
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        class PushNotificationManager {
            constructor() {
                this.isSupported = 'Notification' in window && 'serviceWorker' in navigator;
                this.isSubscribed = false;
                this.subscription = null;
            }
            async init() {
                if (!this.isSupported) return;
                await this.requestPermission();
                if (this.isSubscribed) await this.getExistingSubscription();
            }
            async requestPermission() {
                if (Notification.permission === 'granted') { this.isSubscribed = true; return true; }
                if (Notification.permission === 'default') {
                    const p = await Notification.requestPermission();
                    if (p === 'granted') { this.isSubscribed = true; return true; }
                }
                return false;
            }
            async subscribeToPush() {
                if (!this.isSupported || !this.isSubscribed) return null;
                try {
                    const registration = await navigator.serviceWorker.ready;
                    const subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: this.urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                    });
                    this.subscription = subscription;
                    await this.saveSubscription(subscription);
                    return subscription;
                } catch (error) {
                    console.log('Failed to subscribe to push:', error);
                    return null;
                }
            }
            async unsubscribeFromPush() {
                if (!this.subscription) return;
                try {
                    await this.subscription.unsubscribe();
                    this.subscription = null;
                    this.isSubscribed = false;
                    if (currentUser) {
                        await db.ref(`users/${currentUser.uid}/pushSubscription`).remove();
                    }
                } catch (error) {
                    console.log('Failed to unsubscribe:', error);
                }
            }
            async getExistingSubscription() {
                if (!this.isSupported) return null;
                try {
                    const registration = await navigator.serviceWorker.ready;
                    const subscription = await registration.pushManager.getSubscription();
                    if (subscription) {
                        this.subscription = subscription;
                        return subscription;
                    }
                } catch (error) {
                    console.log('Failed to get existing subscription:', error);
                }
                return null;
            }
            async saveSubscription(subscription) {
                if (!currentUser) return;
                const subscriptionData = {
                    endpoint: subscription.endpoint,
                    keys: {
                        p256dh: subscription.toJSON().keys.p256dh,
                        auth: subscription.toJSON().keys.auth
                    },
                    timestamp: Date.now()
                };
                await db.ref(`users/${currentUser.uid}/pushSubscription`).set(subscriptionData);
            }
            urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            }
        }
        const pushManager = new PushNotificationManager();

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                initApp();
            } else {
                window.location.href = "login.html";
            }
        });

        async function initApp() {
            const cachedProfile = localStorage.getItem('vynix_profile');
            if (cachedProfile) {
                const data = JSON.parse(cachedProfile);
                myProfile.name = data.name || "";
                myProfile.photo = data.photo || "";
                myVId = data.vynixId || "";
               
                document.getElementById('myAvatar').src = myProfile.photo;
                document.getElementById('settingsAvatar').src = myProfile.photo;
                document.getElementById('editDisplayName').value = myProfile.name;
                document.getElementById('myAvatar').classList.remove('shimmer');
                document.getElementById('settingsAvatar').classList.remove('shimmer');
                updateMyIdDisplay();
            }

            const cachedChatsStr = localStorage.getItem('vynix_chats');
            if (cachedChatsStr) { cachedChats = JSON.parse(cachedChatsStr); renderChatsFromCache(); }
            const cachedMomentsStr = localStorage.getItem('vynix_moments');
            if (cachedMomentsStr) { cachedMoments = JSON.parse(cachedMomentsStr); renderMomentsFromCache(); }

            listenToMyProfile();

            const snap = await db.ref(`users/${currentUser.uid}/profile`).once('value');
            const data = snap.val() || {};
            if (!data.vynixId) {
                toast('Generating your unique Vynix ID...');
                const newId = await generateAndAssignVynixId();
                if (newId) {
                    myVId = newId;
                    await db.ref(`users/${currentUser.uid}/profile`).update({ vynixId: myVId });
                    await db.ref(`vynix_ids/${myVId}`).set(currentUser.uid);
                    toast(`Your Vynix ID is @${myVId}`);
                }
            }

            hasShownReactionTutorial = localStorage.getItem('reaction_tutorial_shown') === 'true';
            await pushManager.init();
            await checkNotificationStatus();
            loadChats();
            loadMoments();

            const myPresenceRef = db.ref(`users/${currentUser.uid}/online`);
            myPresenceRef.set(true);
            myPresenceRef.onDisconnect().set(false);
            db.ref(`users/${currentUser.uid}/lastSeen`).set(firebase.database.ServerValue.TIMESTAMP);
            db.ref(`users/${currentUser.uid}/lastSeen`).onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
        }

        function updateMyIdDisplay() {
            const el = document.getElementById('myVynixIdDisplay');
            if (myVId) {
                el.innerHTML = `Your Vynix ID: <strong>@${myVId}</strong><br><small>Share this to let friends add you</small>`;
            } else {
                el.innerHTML = `<strong>Vynix ID not available</strong><br><small>Check internet or restart app to load your ID</small>`;
            }
        }

        function renderChatsFromCache() {
            const list = document.getElementById('chatList');
            list.innerHTML = "";
            list.innerHTML += `
                <div class="chat-card">
                    <div class="avatar-box">
                        <div class="avatar" style="background:#000; display:flex; align-items:center; justify-content:center; color:#fff; font-size:28px;">
                            <span class="material-symbols-rounded">directions_car</span>
                        </div>
                    </div>
                    <div class="chat-info">
                        <span class="chat-name">My Two Minutes Ride</span>
                        <span class="chat-msg">Book a quick & safe ride in just 2 minutes</span>
                    </div>
                    <span class="chat-time">New</span>
                </div>`;
            Object.keys(cachedChats).sort((a,b) => (cachedChats[b].ts || 0) - (cachedChats[a].ts || 0)).forEach(key => {
                const c = cachedChats[key];
                const roomId = currentUser.uid < key ? currentUser.uid+"_"+key : key+"_"+currentUser.uid;
                const dMsg = decrypt(c.lastMsg || "You are now connected ðŸ”’", roomId);
                const timeAgo = formatTimeAgo(c.ts);
                const unreadCount = c.unreadCount || 0;
                list.innerHTML += `
                    <div class="chat-card">
                        <div class="avatar-box" data-friend-uid="${key}" onclick="showProfileDetail('${key}', event)">
                            <img class="avatar" src="${c.photo || ''}">
                        </div>
                        <div class="chat-info" onclick="openFullChat('${key}', '${c.name}', '${c.photo || ''}')">
                            <span class="chat-name">${c.name}</span>
                            <span class="chat-msg">${dMsg}</span>
                        </div>
                        ${timeAgo ? `<span class="chat-time">${timeAgo}</span>` : ''}
                        ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount > 99 ? '99+' : unreadCount}</span>` : ''}
                    </div>`;
            });
        }

        function renderMomentsFromCache() {
            const grid = document.getElementById('statusGrid');
            grid.innerHTML = "";
            const now = Date.now();
            Object.keys(cachedMoments).forEach(uid => {
                const items = cachedMoments[uid].filter(m => now - m.ts < 86400000);
                if (items.length) {
                    const last = items[items.length - 1];
                    grid.innerHTML += `
                        <div class="status-card" data-friend-uid="${uid}" onclick="openStoriesCached('${uid}')">
                            ${last.type === 'video' ? `<video src="${last.url}" muted loop playsinline></video>` : `<img src="${last.url}">`}
                            <div class="status-info"><b>${last.name}</b></div>
                        </div>`;
                }
            });
        }

        function openStoriesCached(uid) {
            const now = Date.now();
            storyQueue = cachedMoments[uid]?.filter(m => now - m.ts < 86400000).map(m => ({...m, uid})) || [];
            storyIndex = 0;
            document.getElementById('storyViewer').style.display = 'block';
            showStory();
        }

        async function deleteCurrentStory() {
            if (!currentStoryKey || !confirm('Delete this moment?')) return;
            await db.ref(`moments/${currentUser.uid}/${currentStoryKey}`).remove();
            toast('Moment deleted');
            closeStoryViewer();
        }

        function toggleStorySound(e) {
            e.stopPropagation();
            if (currentStoryVideo) {
                currentStoryVideo.muted = !currentStoryVideo.muted;
                storyMuted = currentStoryVideo.muted;
                document.getElementById('soundIcon').textContent = storyMuted ? 'volume_off' : 'volume_up';
            }
        }

        async function uploadProfilePicture(file) {
            if (!file || !file.type.startsWith('image/')) {
                toast("Please select an image file");
                return;
            }
            toast("Uploading profile picture...");
            const form = new FormData();
            form.append('file', file);
            form.append('upload_preset', UPLOAD_PRESET);
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {
                    method: 'POST',
                    body: form
                });
                const data = await res.json();
                if (data.secure_url) {
                    myProfile.photo = data.secure_url;
                    document.getElementById('myAvatar').src = myProfile.photo;
                    document.getElementById('settingsAvatar').src = myProfile.photo;
                    localStorage.setItem('vynix_profile', JSON.stringify({name: myProfile.name, photo: myProfile.photo, vynixId: myVId}));
                    toast("Profile picture updated instantly!");
                    await db.ref(`users/${currentUser.uid}/profile`).update({ photo: data.secure_url });
                } else {
                    toast("Upload failed");
                }
            } catch (e) {
                toast("Upload error (check internet)");
                console.error(e);
            }
        }

        async function updateProfile() {
            const newName = document.getElementById('editDisplayName').value.trim();
            if (!newName) {
                toast("Display name cannot be empty");
                return;
            }
            myProfile.name = newName;
            localStorage.setItem('vynix_profile', JSON.stringify({name: newName, photo: myProfile.photo, vynixId: myVId}));
            updateVisibleMomentsOwnerInfo();
            toast("Profile updated instantly!");
            try {
                await db.ref(`users/${currentUser.uid}/profile`).update({
                    name: newName,
                    photo: myProfile.photo,
                    vynixId: myVId
                });
            } catch (e) {
                toast("No internet - changes saved locally, will sync when online");
            }
            closeAll();
        }

        async function addFriendLogic() {
            const btn = document.getElementById('addSubmitBtn');
            const rawId = document.getElementById('friendVynixId').value.trim().toLowerCase();
            const vid = rawId.startsWith('@') ? rawId.substring(1) : rawId;
            if(!vid || vid === myVId) {
                toast(vid === myVId ? "That's you!" : "Invalid ID");
                return;
            }
            btn.disabled = true;
            btn.innerText = "Searching...";
            try {
                const idSnap = await db.ref(`vynix_ids/${vid}`).once('value');
                if(!idSnap.exists()) {
                    toast("User not found");
                } else {
                    const targetUid = idSnap.val();
                    const existing = await db.ref(`users/${currentUser.uid}/chats/${targetUid}`).once('value');
                    if(existing.exists()) {
                        toast("Friend already added!");
                    } else {
                        const targetProfile = (await db.ref(`users/${targetUid}/profile`).once('value')).val() || {};
                        await db.ref(`users/${currentUser.uid}/chats/${targetUid}`).set({
                            name: targetProfile.name || "User",
                            photo: targetProfile.photo || "",
                            lastMsg: "Connected via Vynix ID",
                            ts: Date.now()
                        });
                        setupFriendProfileListener(targetUid);
                        setupOnlineStatusListener(targetUid);
                        toast("Success! Friend added.");
                        closeAll();
                        document.getElementById('friendVynixId').value = "";
                    }
                }
            } catch(e) {
                toast("No internet - try again when online");
            } finally {
                btn.disabled = false;
                btn.innerText = "Search & Add";
            }
        }

        async function validateAndUpload(file) {
            if(!file) return;
            if(file.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.onloadedmetadata = function() {
                    window.URL.revokeObjectURL(video.src);
                    if(video.duration > 61) {
                        toast("Video too long! (Max 60 seconds)");
                    } else {
                        performUpload(file, video.duration);
                    }
                };
                video.src = URL.createObjectURL(file);
            } else {
                performUpload(file, 0);
            }
        }

        async function performUpload(file, duration = 0) {
            toast("Posting Moment...");
            const form = new FormData();
            form.append('file', file);
            form.append('upload_preset', UPLOAD_PRESET);
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, { method:'POST', body:form });
                const data = await res.json();
                if(data.secure_url) {
                    const pushRef = await db.ref(`moments/${currentUser.uid}`).push();
                    await pushRef.set({
                        url: data.secure_url,
                        type: data.resource_type,
                        ts: Date.now(),
                        name: myProfile.name || "User",
                        photo: myProfile.photo,
                        key: pushRef.key,
                        duration: duration > 0 ? Math.min(duration, 60) : 0
                    });
                    toast("Moment is live!");
                }
            } catch(e) {
                toast("No internet - try again when online");
            }
        }

        function loadMoments() {
            db.ref('moments').on('value', snap => {
                const grid = document.getElementById('statusGrid');
                grid.innerHTML = "";
                cachedMoments = {};
                const now = Date.now();
                snap.forEach(userNode => {
                    let items = [];
                    const uid = userNode.key;
                    userNode.forEach(m => {
                        const val = m.val();
                        val.key = m.key;
                        val.uid = uid;
                        if (uid === currentUser.uid) {
                            val.name = myProfile.name || val.name || "User";
                            val.photo = myProfile.photo || val.photo || "";
                        }
                        if(now - val.ts < 86400000) items.push(val);
                    });
                    if(items.length) {
                        cachedMoments[uid] = items;
                        const last = items[items.length-1];
                        grid.innerHTML += `
                            <div class="status-card" data-friend-uid="${uid}" onclick="openStories('${uid}')">
                                ${last.type === 'video' ? `<video src="${last.url}" muted loop playsinline></video>` : `<img src="${last.url}">`}
                                <div class="status-info"><b>${last.name}</b></div>
                            </div>`;
                        setupFriendProfileListener(uid);
                        setupOnlineStatusListener(uid);
                    }
                });
                localStorage.setItem('vynix_moments', JSON.stringify(cachedMoments));
            }, (error) => {
                console.log('Moments offline, using cache');
                renderMomentsFromCache();
            });
        }

        function openStories(uid) {
            setupFriendProfileListener(uid);
            setupOnlineStatusListener(uid);
            db.ref(`moments/${uid}`).once('value', snap => {
                storyQueue = [];
                const now = Date.now();
                snap.forEach(s => {
                    const val = s.val();
                    val.key = s.key;
                    val.uid = uid;
                    if (uid === currentUser.uid) {
                        val.name = myProfile.name || val.name || "User";
                        val.photo = myProfile.photo || val.photo || "";
                    }
                    if(now - val.ts < 86400000) storyQueue.push(val);
                });
                storyIndex = 0;
                document.getElementById('storyViewer').style.display = 'block';
                showStory();
            });
        }

        function showStory() {
            clearTimeout(storyTimer);
            if (currentStoryVideo) {
                currentStoryVideo.pause();
                currentStoryVideo = null;
            }
            if(storyIndex >= storyQueue.length) return closeStoryViewer();
            if(storyIndex < 0) storyIndex = 0;
            const story = storyQueue[storyIndex];
            currentStoryKey = story.key;
            const media = document.getElementById('storyMedia');
            const progress = document.getElementById('storyProgressBars');
            const header = document.getElementById('storyHeaderInfo');
            const soundBtn = document.getElementById('storySoundBtn');
            const deleteBtn = document.getElementById('storyDeleteBtn');
            header.innerHTML = `<img src="${story.photo || ''}" style="width:32px; height:32px; border-radius:50%; margin-right:10px; border:1px solid #fff;"> <b>${story.name}</b>`;
            if (story.type === 'video') {
                media.innerHTML = `<video src="${story.url}" autoplay playsinline id="currentStoryVideo"></video>`;
                currentStoryVideo = document.getElementById('currentStoryVideo');
                currentStoryVideo.muted = storyMuted;
                soundBtn.style.display = 'flex';
                document.getElementById('soundIcon').textContent = storyMuted ? 'volume_off' : 'volume_up';
            } else {
                media.innerHTML = `<img src="${story.url}">`;
                soundBtn.style.display = 'none';
            }
            deleteBtn.style.display = (story.uid === currentUser.uid) ? 'flex' : 'none';
            progress.innerHTML = storyQueue.map((_, i) => `
                <div class="progress-segment">
                    <div class="progress-fill" style="width: ${i < storyIndex ? '100%' : '0%'}"></div>
                </div>`).join('');
            setTimeout(() => {
                const bar = progress.querySelectorAll('.progress-fill')[storyIndex];
                const duration = story.type === 'video' ? (story.duration || 60) * 1000 : 5000;
                bar.style.transition = `width ${duration}ms linear`;
                bar.style.width = '100%';
            }, 50);
            const duration = story.type === 'video' ? (story.duration || 60) * 1000 : 5000;
            storyTimer = setTimeout(() => { storyIndex++; showStory(); }, duration);
        }

        function handleStoryTap(e) {
            if (e.target.closest('.story-sound-btn') || e.target.closest('.story-delete')) return;
            const screenWidth = window.innerWidth;
            if(e.clientX < screenWidth / 3) {
                storyIndex--;
            } else {
                storyIndex++;
            }
            showStory();
        }

        function closeStoryViewer() {
            clearTimeout(storyTimer);
            if (currentStoryVideo) {
                currentStoryVideo.pause();
                currentStoryVideo = null;
            }
            document.getElementById('storyViewer').style.display = 'none';
            document.getElementById('storySoundBtn').style.display = 'none';
            document.getElementById('storyDeleteBtn').style.display = 'none';
            currentStoryKey = null;
        }

        function loadChats() {
            db.ref(`users/${currentUser.uid}/chats`).on('value', snap => {
                const list = document.getElementById('chatList');
                list.innerHTML = "";
                list.innerHTML += `
                    <div class="chat-card">
                        <div class="avatar-box">
                            <div class="avatar" style="background:#000; display:flex; align-items:center; justify-content:center; color:#fff; font-size:28px;">
                                <span class="material-symbols-rounded">directions_car</span>
                            </div>
                        </div>
                        <div class="chat-info">
                            <span class="chat-name">My Two Minutes Ride</span>
                            <span class="chat-msg">Book a quick & safe ride in just 2 minutes</span>
                        </div>
                        <span class="chat-time">New</span>
                    </div>`;
                cachedChats = {};
                const chatsArray = [];
                snap.forEach(child => {
                    const data = child.val();
                    cachedChats[child.key] = data;
                    chatsArray.push({key: child.key, data: data});
                    setupFriendProfileListener(child.key);
                    setupOnlineStatusListener(child.key);
                });
                localStorage.setItem('vynix_chats', JSON.stringify(cachedChats));
                chatsArray.sort((a, b) => (b.data.ts || 0) - (a.data.ts || 0));
                chatsArray.forEach(chat => {
                    const c = chat.data;
                    const roomId = currentUser.uid < chat.key ? currentUser.uid+"_"+chat.key : chat.key+"_"+currentUser.uid;
                    const dMsg = decrypt(c.lastMsg || "You are now connected ðŸ”’", roomId);
                    const timeAgo = formatTimeAgo(c.ts);
                    const unreadCount = c.unreadCount || 0;
                    list.innerHTML += `
                        <div class="chat-card">
                            <div class="avatar-box" data-friend-uid="${chat.key}" onclick="showProfileDetail('${chat.key}', event)">
                                <img class="avatar" src="${c.photo || ''}">
                            </div>
                            <div class="chat-info" onclick="openFullChat('${chat.key}', '${c.name}', '${c.photo || ''}')">
                                <span class="chat-name">${c.name}</span>
                                <span class="chat-msg">${dMsg}</span>
                            </div>
                            ${timeAgo ? `<span class="chat-time">${timeAgo}</span>` : ''}
                            ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount > 99 ? '99+' : unreadCount}</span>` : ''}
                        </div>`;
                });
            }, (error) => {
                console.log('Chats offline, using cache');
                renderChatsFromCache();
            });
        }

        function updateChatStatus() {
            if (!currentFriendUid) return;

            if (onlineListener) { onlineListener.off(); onlineListener = null; }
            if (lastSeenListener) { lastSeenListener.off(); lastSeenListener = null; }

            const statusEl = document.getElementById('chatStatusInfo');

            onlineListener = db.ref(`users/${currentFriendUid}/online`).on('value', snap => {
                const isOnline = snap.val() === true;

                if (isOnline) {
                    statusEl.innerHTML = '<span class="online-dot"></span>Online';
                    if (lastSeenListener) {
                        lastSeenListener.off();
                        lastSeenListener = null;
                    }
                } else {
                    statusEl.textContent = 'Last seen recently';
                    if (lastSeenListener) lastSeenListener.off();
                    lastSeenListener = db.ref(`users/${currentFriendUid}/lastSeen`).on('value', lsSnap => {
                        const ts = lsSnap.val();
                        if (ts) {
                            statusEl.textContent = 'Last seen ' + formatTimeAgo(ts);
                        } else {
                            statusEl.textContent = 'Last seen recently';
                        }
                    });
                }
            });
        }

        function updateProfileDetailStatus(friendUid) {
            const statusEl = document.getElementById('detailStatus');
            db.ref(`users/${friendUid}/online`).once('value').then(snap => {
                const isOnline = snap.val() === true;
                if (isOnline) {
                    statusEl.innerHTML = '<span style="display:inline-block;width:8px;height:8px;background:#10b981;border-radius:50%;margin-right:4px;"></span>Online';
                } else {
                    db.ref(`users/${friendUid}/lastSeen`).once('value').then(lsSnap => {
                        const ts = lsSnap.val();
                        if (ts) {
                            statusEl.textContent = 'Last seen ' + formatTimeAgo(ts);
                        } else {
                            statusEl.textContent = 'Last seen recently';
                        }
                    });
                }
            });
        }

        function updateTypingStatus() {
            if (!currentRoomId || !currentFriendUid) return;
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            clearTimeout(typingTimeout);
            if (text) {
                db.ref(`typing/${currentRoomId}/${currentUser.uid}`).set(true);
                typingTimeout = setTimeout(() => {
                    db.ref(`typing/${currentRoomId}/${currentUser.uid}`).remove();
                }, 2000);
            } else {
                db.ref(`typing/${currentRoomId}/${currentUser.uid}`).remove();
            }
        }

        function listenForTyping() {
            if (!currentRoomId || !currentFriendUid) return;
            if (typingListener) typingListener.off();
            typingListener = db.ref(`typing/${currentRoomId}/${currentFriendUid}`).on('value', snap => {
                const isTyping = snap.val() === true;
                document.getElementById('typingIndicator').style.display = isTyping ? 'flex' : 'none';
            });
        }

        function openFullChat(friendUid, friendName, friendPhoto) {
            isTransitioning = true;
            markAsRead(friendUid);
            currentFriendUid = friendUid;
            currentRoomId = currentUser.uid < friendUid ? currentUser.uid + "_" + friendUid : friendUid + "_" + currentUser.uid;
            document.getElementById('chatFriendName').textContent = friendName;
            document.getElementById('chatFriendAvatar').src = friendPhoto || '';
            document.getElementById('fullChatView').style.display = 'flex';
            document.getElementById('chatsTab').style.display = 'none';
            document.getElementById('statusTab').style.display = 'none';
            document.querySelector('.pill-nav').style.display = 'none';
            loadMessages();
            updateChatStatus();
            listenForTyping();
            setupFriendProfileListener(friendUid);
            setupOnlineStatusListener(friendUid);
            setTimeout(() => { isTransitioning = false; }, 100);
            if (!hasShownReactionTutorial && document.querySelectorAll('#messageList .message').length > 0) {
                document.getElementById('reactionTutorial').style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('reactionTutorial').style.display = 'none';
                    localStorage.setItem('reaction_tutorial_shown', 'true');
                    hasShownReactionTutorial = true;
                }, 5000);
            }
        }

        function closeFullChat() {
            isTransitioning = true;
            document.getElementById('fullChatView').style.display = 'none';
            document.getElementById('chatsTab').style.display = 'block';
            document.querySelector('.pill-nav').style.display = 'flex';
            currentFriendUid = null;
            currentRoomId = null;
            document.getElementById('messageList').innerHTML = '';
            document.getElementById('chatStatusInfo').textContent = 'Loading...';
            document.getElementById('reactionTutorial').style.display = 'none';
            document.getElementById('typingIndicator').style.display = 'none';
            if (messagesListener) { messagesListener.off(); messagesListener = null; }
            if (onlineListener) { onlineListener.off(); onlineListener = null; }
            if (lastSeenListener) { lastSeenListener.off(); lastSeenListener = null; }
            if (typingListener) { typingListener.off(); typingListener = null; }
            db.ref(`typing/${currentRoomId}/${currentUser.uid}`).remove();
            document.querySelectorAll('.reaction-picker').forEach(p => p.remove());
            setTimeout(() => { isTransitioning = false; }, 100);
        }

        function showDeleteModal(messageKey) {
            messageToDelete = messageKey;
            document.getElementById('deleteMessageModal').classList.add('active');
            document.getElementById('overlay').style.display = 'block';
        }

        function closeDeleteModal() {
            document.getElementById('deleteMessageModal').classList.remove('active');
            document.getElementById('overlay').style.display = 'none';
            messageToDelete = null;
        }

        async function confirmDeleteMessage() {
            if (!messageToDelete || !currentRoomId) return;
            await db.ref(`messages/${currentRoomId}/${messageToDelete}`).remove();
            closeDeleteModal();
            toast('Message deleted');
        }

        function loadMessages() {
            document.getElementById('messageList').innerHTML = '<div style="text-align:center; color:#999; padding:20px;">Loading messages...</div>';
            messagesListener = db.ref(`messages/${currentRoomId}`).limitToLast(50).on('value', snap => {
                const list = document.getElementById('messageList');
                list.innerHTML = '';
                if (!snap.exists()) {
                    list.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">Start the conversation!</div>';
                    return;
                }
                const msgs = [];
                snap.forEach(child => {
                    const val = child.val();
                    val.key = child.key;
                    msgs.push(val);
                });
                msgs.sort((a,b) => a.ts - b.ts);
                msgs.forEach(m => {
                    const decrypted = decrypt(m.text, currentRoomId);
                    const isSent = m.sender === currentUser.uid;
                    const timeStr = formatMessageTime(m.ts);
                    const reactionsHtml = renderReactions(m.reactions || {});
                    const msgEl = document.createElement('div');
                    msgEl.className = `message ${isSent ? 'sent' : 'received'}`;
                    msgEl.innerHTML = `
                        ${decrypted}
                        <div class="message-time">${timeStr}</div>
                        ${reactionsHtml}
                    `;
                    msgEl.oncontextmenu = (e) => {
                        e.preventDefault();
                        showReactionPicker(msgEl, m.key);
                    };
                    if (isSent) {
                        msgEl.onclick = (e) => {
                            e.stopPropagation();
                            showDeleteModal(m.key);
                        };
                    }
                    msgEl.querySelectorAll('.reaction').forEach(reac => {
                        reac.onclick = (e) => {
                            e.stopPropagation();
                            const emoji = reac.textContent.trim().split(' ')[0];
                            addReaction(m.key, emoji);
                        };
                    });
                    list.appendChild(msgEl);
                });
                list.scrollTop = list.scrollHeight;
                if (!hasShownReactionTutorial && msgs.length > 0) {
                    document.getElementById('reactionTutorial').style.display = 'flex';
                    setTimeout(() => {
                        document.getElementById('reactionTutorial').style.display = 'none';
                        localStorage.setItem('reaction_tutorial_shown', 'true');
                        hasShownReactionTutorial = true;
                    }, 5000);
                }
            });
        }

        function formatMessageTime(ts) {
            const date = new Date(ts);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function renderReactions(reactions = {}) {
            if (Object.keys(reactions).length === 0) return '';
            let html = '<div class="reactions">';
            Object.keys(reactions).forEach(emoji => {
                const count = reactions[emoji].count || 1;
                const users = reactions[emoji].users || {};
                const isMine = users[currentUser.uid] || false;
                html += `<div class="reaction ${isMine ? 'mine' : ''}">${emoji} ${count > 1 ? count : ''}</div>`;
            });
            html += '</div>';
            return html;
        }

        function showReactionPicker(messageElement, messageKey) {
            document.querySelectorAll('.reaction-picker').forEach(p => p.remove());
            const picker = document.createElement('div');
            picker.className = 'reaction-picker';
            availableReactions.forEach(emoji => {
                const opt = document.createElement('div');
                opt.className = 'reaction-option';
                opt.textContent = emoji;
                opt.onclick = (e) => {
                    e.stopPropagation();
                    addReaction(messageKey, emoji);
                    picker.remove();
                };
                picker.appendChild(opt);
            });
            messageElement.style.position = 'relative';
            messageElement.appendChild(picker);
            picker.style.display = 'flex';
        }

        async function addReaction(messageKey, emoji) {
            const reactionRef = db.ref(`messages/${currentRoomId}/${messageKey}/reactions/${emoji}`);
            const snap = await reactionRef.once('value');
            let current = snap.val() || { count: 0, users: {} };
            if (current.users[currentUser.uid]) {
                delete current.users[currentUser.uid];
                current.count--;
                if (current.count <= 0) {
                    await reactionRef.remove();
                } else {
                    await reactionRef.set({ count: current.count, users: current.users });
                }
            } else {
                current.users[currentUser.uid] = true;
                current.count++;
                await reactionRef.set({ count: current.count, users: current.users });
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !currentRoomId) return;
            const encrypted = CryptoJS.AES.encrypt(text, secretBase + currentRoomId).toString();
            const msgRef = db.ref(`messages/${currentRoomId}`).push();
            msgRef.set({
                text: encrypted,
                sender: currentUser.uid,
                ts: Date.now(),
                reactions: {}
            }).then(() => {
                const updates = {};
                updates[`users/${currentUser.uid}/chats/${currentFriendUid}/lastMsg`] = encrypted;
                updates[`users/${currentUser.uid}/chats/${currentFriendUid}/ts`] = Date.now();
                updates[`users/${currentFriendUid}/chats/${currentUser.uid}/lastMsg`] = encrypted;
                updates[`users/${currentFriendUid}/chats/${currentUser.uid}/ts`] = Date.now();
                updates[`users/${currentFriendUid}/chats/${currentUser.uid}/unreadCount`] = firebase.database.ServerValue.increment(1);
                db.ref().update(updates);
                input.value = '';
            }).catch(err => {
                toast("Failed to send (check internet)");
            });
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function switchTab(tab) {
            document.getElementById('chatsTab').style.display = tab === 'chats' ? 'block' : 'none';
            document.getElementById('statusTab').style.display = tab === 'status' ? 'block' : 'none';
            document.getElementById('navChats').classList.toggle('active', tab === 'chats');
            document.getElementById('navStatus').classList.toggle('active', tab === 'status');
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return '';
            const now = Date.now();
            const diff = now - timestamp;
            if (diff < 60000) return 'now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)}d`;
            const date = new Date(timestamp);
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        }

        function searchFriends() {
            const searchTerm = document.getElementById('friendSearch').value.toLowerCase();
            const clearBtn = document.getElementById('clearSearch');
            const chatCards = document.querySelectorAll('#chatList .chat-card');
            clearBtn.style.display = searchTerm ? 'block' : 'none';
            chatCards.forEach(card => {
                const friendName = card.querySelector('.chat-name')?.textContent.toLowerCase() || '';
                const lastMsg = card.querySelector('.chat-msg')?.textContent.toLowerCase() || '';
                card.style.display = (friendName.includes(searchTerm) || lastMsg.includes(searchTerm)) ? 'flex' : 'none';
            });
        }

        function clearSearch() {
            document.getElementById('friendSearch').value = '';
            searchFriends();
        }

        async function showProfileDetail(uid, e) {
            if (e) e.stopPropagation();
            profileDetailFriendUid = uid;
            setupFriendProfileListener(uid);
            setupOnlineStatusListener(uid);
            try {
                const snap = await db.ref(`users/${uid}/profile`).once('value');
                const data = snap.val() || {};
                document.getElementById('detailName').innerText = data.name || "User";
                document.getElementById('detailId').innerText = "@" + (data.vynixId || "unknown");
                document.getElementById('detailImg').src = data.photo || "";
                updateProfileDetailStatus(uid);
            } catch (err) {
                toast("Offline - profile details unavailable");
            }
            document.getElementById('profileDetail').style.display = 'flex';
        }

        function showProfileDetailFromChat() {
            showProfileDetail(currentFriendUid);
        }

        function messageFromProfile() {
            document.getElementById('profileDetail').style.display = 'none';
            openFullChat(profileDetailFriendUid, document.getElementById('detailName').textContent, document.getElementById('detailImg').src);
        }

        function confirmUnfriend() {
            document.getElementById('unfriendName').textContent = document.getElementById('detailName').textContent;
            document.getElementById('unfriendModal').classList.add('active');
            document.getElementById('overlay').style.display = 'block';
        }

        function closeUnfriendModal() {
            document.getElementById('unfriendModal').classList.remove('active');
            document.getElementById('overlay').style.display = 'none';
        }

        async function executeUnfriend() {
            const uid = profileDetailFriendUid;
            if (!uid) return;
            try {
                await db.ref(`users/${currentUser.uid}/chats/${uid}`).remove();
                await db.ref(`users/${uid}/chats/${currentUser.uid}`).remove();
                await db.ref(`messages/${currentUser.uid < uid ? currentUser.uid + "_" + uid : uid + "_" + currentUser.uid}`).remove();
                toast("Friend removed");
            } catch (e) {
                toast("Failed to remove friend");
            }
            document.getElementById('profileDetail').style.display = 'none';
            closeUnfriendModal();
            loadChats();
            if (currentFriendUid === uid) closeFullChat();
            if (friendProfileListeners[uid]) db.ref(`users/${uid}/profile`).off('value', friendProfileListeners[uid]);
            if (onlineStatusListeners[uid]) db.ref(`users/${uid}/online`).off('value', onlineStatusListeners[uid]);
            delete friendProfileListeners[uid];
            delete onlineStatusListeners[uid];
        }

        async function clearChatHistory() {
            if (!currentRoomId || !confirm('Clear all messages in this chat?')) return;
            try {
                await db.ref(`messages/${currentRoomId}`).remove();
                toast('Chat history cleared');
            } catch (e) {
                toast('Failed to clear chat');
            }
        }

        async function toggleNotifications() {
            const toggle = document.getElementById('notificationToggle');
            const enabled = toggle.classList.contains('active');
            if (!enabled) {
                const permission = await pushManager.requestPermission();
                if (permission) {
                    await pushManager.subscribeToPush();
                    toggle.classList.add('active');
                    toast('Notifications enabled!');
                } else {
                    toast('Notification permission denied');
                }
            } else {
                await pushManager.unsubscribeFromPush();
                toggle.classList.remove('active');
                toast('Notifications disabled');
            }
        }

        async function checkNotificationStatus() {
            if (pushManager.isSupported && Notification.permission === 'granted') {
                const subscription = await pushManager.getExistingSubscription();
                if (subscription) {
                    document.getElementById('notificationToggle').classList.add('active');
                }
            }
        }

        async function markAsRead(friendUid) {
            try {
                if (currentUser && friendUid) {
                    await db.ref(`users/${currentUser.uid}/chats/${friendUid}`).update({
                        unreadCount: 0
                    });
                }
            } catch (error) {
                console.log("Error marking as read:", error);
            }
        }

        function decrypt(t, r) {
            if (!t || !t.startsWith('U2FsdGVkX')) return t || "Message";
            try {
                return CryptoJS.AES.decrypt(t, secretBase + r).toString(CryptoJS.enc.Utf8) || "ðŸ”’ Message";
            } catch(e) {
                return "ðŸ”’ Message";
            }
        }

        function openSheet(id) {
            document.getElementById('overlay').style.display='block';
            document.getElementById(id).classList.add('active');
            if (id === 'settingsSheet') {
                updateMyIdDisplay();
            }
        }

        function closeAll() {
            document.querySelectorAll('.bottom-sheet').forEach(s=>s.classList.remove('active'));
            document.getElementById('overlay').style.display='none';
        }

        function toast(m) {
            const t=document.getElementById('toast');
            t.innerText=m;
            t.style.display='block';
            setTimeout(()=>t.style.display='none',2800);
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.message')) {
                document.querySelectorAll('.reaction-picker').forEach(p => p.remove());
            }
        });

        function exitApp() {
            if (window.navigator && window.navigator.app && window.navigator.app.exitApp) {
                window.navigator.app.exitApp();
            } else {
                try { window.close(); } catch (e) {}
            }
        }

        function handleBackButton() {
            if (isTransitioning) return;
            if (document.getElementById('fullChatView').style.display === 'flex') {
                closeFullChat();
            } else if (document.getElementById('statusTab').style.display === 'block') {
                switchTab('chats');
            } else if (document.getElementById('overlay').style.display === 'block') {
                closeAll();
            } else if (document.getElementById('chatsTab').style.display === 'block') {
                exitApp();
            } else {
                switchTab('chats');
            }
        }

        if (window.cordova) {
            document.addEventListener('deviceready', () => {
                document.addEventListener('backbutton', (e) => {
                    e.preventDefault();
                    handleBackButton();
                }, false);
            }, false);
        } else {
            window.addEventListener('popstate', (e) => {
                e.preventDefault();
                handleBackButton();
                history.pushState(null, null, location.href);
            });
            history.pushState(null, null, location.href);
        }
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed:', err));
        }
    </script>
</body>
</html>
