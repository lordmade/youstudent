<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Vynix Chat • Realtime</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root { --bg-dark: #111b21; --text-dark: #e9edef; }
    body { font-family: 'Inter', sans-serif; background: #000; color: var(--text-dark); margin:0; }
    .app-container { width: 100vw; height: 100vh; background: var(--bg-dark); display: flex; flex-direction: column; overflow: hidden; }
    @media (min-width: 768px) {
      .app-container { width: 420px; height: 900px; margin: 20px auto; border-radius: 36px; border: 12px solid #000; box-shadow: 0 30px 80px rgba(0,0,0,0.5); }
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .modal-enter { animation: modalFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  </style>
</head>
<body>

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ─── FIREBASE CONFIGURATION ───
    // TODO: Replace with your actual Firebase config
    const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            databaseURL: "https://fire-b-a8878.firebaseio.com",
            projectId: "fire-b-a8878",
            storageBucket: "fire-b-a8878.firebasestorage.app",
            messagingSenderId: "658673187627",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.database();

    // ─── HELPER COMPONENTS ───
    
    const Modal = ({ isOpen, onClose, title, children }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm modal-enter p-4">
          <div className="bg-[#1f2c34] rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden border border-gray-700">
            <div className="px-6 py-4 border-b border-gray-700 flex justify-between items-center bg-[#202c33]">
              <h3 className="text-lg font-semibold text-white">{title}</h3>
              <button onClick={onClose} className="text-gray-400 hover:text-white"><span className="material-symbols-rounded">close</span></button>
            </div>
            <div className="p-6">{children}</div>
          </div>
        </div>
      );
    };

    const ChatItem = ({ chat, onClick }) => (
      <div onClick={onClick} className="flex items-center px-4 py-3 bg-[#111b21] border-b border-gray-800 active:bg-[#202c33] cursor-pointer transition-colors">
        <div className="relative flex-shrink-0">
          <img src={`https://ui-avatars.com/api/?name=${encodeURIComponent(chat.name)}&background=random&color=fff&size=128`} className="w-12 h-12 rounded-full object-cover" />
        </div>
        <div className="ml-4 flex-1 min-w-0">
          <div className="flex justify-between items-baseline">
            <h3 className="text-base font-medium truncate text-white">{chat.name}</h3>
            <span className="text-xs text-gray-500">{chat.lastTime || ''}</span>
          </div>
          <p className="text-sm truncate text-gray-400 mt-0.5">{chat.lastMessage || 'Start a conversation'}</p>
        </div>
      </div>
    );

    // ─── AUTH SCREEN ───
    const AuthScreen = ({ onLogin }) => {
      const [name, setName] = useState("");
      const [loading, setLoading] = useState(false);

      const handleLogin = async (e) => {
        e.preventDefault();
        if (!name.trim()) return;
        setLoading(true);

        try {
          // Anonymous sign in for demo simplicity
          const userCredential = await auth.signInAnonymously();
          const uid = userCredential.user.uid;
          
          // Generate unique Vynix ID
          const randomCode = Math.floor(1000 + Math.random() * 9000);
          const vynixId = `${name.replace(/\s/g, '').toLowerCase()}#${randomCode}`;

          // Save user profile
          await db.ref(`users/${uid}`).update({
            name: name,
            vynixId: vynixId,
            uid: uid,
            createdAt: firebase.database.ServerValue.TIMESTAMP
          });
          
          // Map Vynix ID for searching
          await db.ref(`vynix_lookup/${vynixId.replace('#', '_')}`).set(uid);

        } catch (error) {
          console.error("Login failed", error);
          alert(error.message);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="h-full flex flex-col items-center justify-center p-6 text-center bg-[#111b21]">
          <div className="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mb-6 shadow-lg shadow-green-500/20">
            <span className="material-symbols-rounded text-4xl text-black">chat</span>
          </div>
          <h1 className="text-3xl font-bold text-white mb-2">Welcome to Vynix</h1>
          <p className="text-gray-400 mb-8">Enter your name to generate your unique Vynix ID.</p>
          
          <form onSubmit={handleLogin} className="w-full max-w-xs space-y-4">
            <input 
              type="text" 
              placeholder="Your Name" 
              className="w-full bg-[#202c33] text-white px-4 py-3 rounded-xl border border-gray-700 focus:border-green-500 focus:outline-none transition-colors"
              value={name}
              onChange={e => setName(e.target.value)}
            />
            <button disabled={loading} className="w-full bg-green-500 text-black font-bold py-3 rounded-xl hover:bg-green-400 transition-all active:scale-95 disabled:opacity-50">
              {loading ? "Creating Account..." : "Get Started"}
            </button>
          </form>
        </div>
      );
    };

    // ─── MAIN APP ───
    const MainApp = ({ user }) => {
      const [chats, setChats] = useState([]);
      const [userData, setUserData] = useState(null);
      const [modalState, setModalState] = useState({ open: false, type: '' });
      const [addIdInput, setAddIdInput] = useState("");
      const [addLoading, setAddLoading] = useState(false);
      const [activeTab, setActiveTab] = useState(0);

      // Fetch User Data & Chats
      useEffect(() => {
        const userRef = db.ref(`users/${user.uid}`);
        userRef.on('value', (snapshot) => {
          setUserData(snapshot.val());
        });

        // Listen for chats (Contacts list for now)
        const contactsRef = db.ref(`users/${user.uid}/contacts`);
        contactsRef.on('value', async (snapshot) => {
          const contacts = snapshot.val() || {};
          const loadedChats = [];
          
          for (let [uid, info] of Object.entries(contacts)) {
            loadedChats.push({
              id: uid,
              ...info,
              lastMessage: "Tap to chat", 
              lastTime: "" 
            });
          }
          setChats(loadedChats);
        });

        return () => {
          userRef.off();
          contactsRef.off();
        };
      }, [user]);

      // Add Friend Logic
      const handleAddFriend = async () => {
        if (!addIdInput.trim()) return;
        setAddLoading(true);
        const searchKey = addIdInput.trim().replace('#', '_');

        try {
          const snapshot = await db.ref(`vynix_lookup/${searchKey}`).get();
          if (snapshot.exists()) {
            const friendUid = snapshot.val();
            if (friendUid === user.uid) throw new Error("You cannot add yourself.");

            // Get Friend Info
            const friendInfoSnap = await db.ref(`users/${friendUid}`).get();
            const friendInfo = friendInfoSnap.val();

            // Add to My Contacts
            await db.ref(`users/${user.uid}/contacts/${friendUid}`).set({
              name: friendInfo.name,
              vynixId: friendInfo.vynixId
            });

            // Add Me to Their Contacts (Optional, auto-friend)
            await db.ref(`users/${friendUid}/contacts/${user.uid}`).set({
              name: userData.name,
              vynixId: userData.vynixId
            });

            alert(`Added ${friendInfo.name}!`);
            setModalState({ open: false, type: '' });
            setAddIdInput("");
          } else {
            alert("User not found. Check the Vynix ID.");
          }
        } catch (err) {
          alert(err.message);
        }
        setAddLoading(false);
      };

      const copyId = () => {
        if (userData) {
          navigator.clipboard.writeText(userData.vynixId);
          alert("ID Copied: " + userData.vynixId);
        }
      };

      return (
        <div className="app-container relative">
          
          {/* Header */}
          <div className="px-4 pt-8 pb-3 bg-[#202c33] shadow-md z-10">
            <div className="flex justify-between items-center mb-4">
              <h1 className="text-xl font-bold text-gray-100">Vynix Chat</h1>
              <div className="flex gap-4">
                <span className="material-symbols-rounded text-gray-400 cursor-pointer">search</span>
                <span className="material-symbols-rounded text-gray-400 cursor-pointer" onClick={() => auth.signOut()}>logout</span>
              </div>
            </div>
            
            {/* User ID Display */}
            <div className="bg-[#111b21] rounded-lg p-2 flex justify-between items-center border border-gray-700/50 mb-2">
              <div className="flex flex-col">
                <span className="text-[10px] uppercase tracking-wider text-gray-500 font-bold">My Vynix ID</span>
                <span className="text-sm font-mono text-green-400">{userData ? userData.vynixId : 'Loading...'}</span>
              </div>
              <button onClick={copyId} className="p-2 hover:bg-white/5 rounded-full">
                <span className="material-symbols-rounded text-sm text-gray-400">content_copy</span>
              </button>
            </div>

            <div className="flex justify-between text-gray-400 text-sm font-medium pt-2">
              {['Chats', 'Status', 'Calls'].map((t, i) => (
                <button 
                  key={t} 
                  onClick={() => setActiveTab(i)}
                  className={`pb-2 px-4 relative ${activeTab === i ? 'text-green-400 after:absolute after:bottom-0 after:left-0 after:w-full after:h-0.5 after:bg-green-400' : ''}`}
                >
                  {t}
                </button>
              ))}
            </div>
          </div>

          {/* List Area */}
          <div className="flex-1 overflow-y-auto scrollbar-hide bg-[#111b21]">
            {chats.length === 0 ? (
              <div className="flex flex-col items-center justify-center h-64 text-gray-500 opacity-60">
                <span className="material-symbols-rounded text-5xl mb-2">group_off</span>
                <p>No friends yet</p>
              </div>
            ) : (
              chats.map(chat => <ChatItem key={chat.id} chat={chat} />)
            )}
          </div>

          {/* Floating Action Button */}
          <button 
            onClick={() => setModalState({ open: true, type: 'fab_menu' })}
            className="fixed bottom-6 right-6 bg-green-500 w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg shadow-green-900/50 text-black z-20 active:scale-95 transition-transform"
          >
            <span className="material-symbols-rounded text-2xl">chat</span>
          </button>

          {/* FAB Modal (Contacts List) */}
          <Modal 
            isOpen={modalState.open && modalState.type === 'fab_menu'} 
            onClose={() => setModalState({ open: false, type: '' })}
            title="Start Chat"
          >
            <button 
              onClick={() => setModalState({ open: true, type: 'add_friend' })}
              className="w-full flex items-center gap-4 p-3 mb-4 rounded-xl bg-[#111b21] border border-gray-700 hover:bg-[#2a3942] transition-colors"
            >
              <div className="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center text-black">
                <span className="material-symbols-rounded">person_add</span>
              </div>
              <span className="font-medium text-white">Add New Contact</span>
            </button>
            
            <div className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3">Your Contacts</div>
            <div className="max-h-[300px] overflow-y-auto space-y-2">
              {chats.map(chat => (
                 <div key={chat.id} className="flex items-center gap-3 p-2 hover:bg-[#2a3942] rounded-lg cursor-pointer">
                   <img src={`https://ui-avatars.com/api/?name=${chat.name}&background=random`} className="w-10 h-10 rounded-full"/>
                   <div>
                     <div className="text-white text-sm font-medium">{chat.name}</div>
                     <div className="text-gray-500 text-xs font-mono">{chat.vynixId}</div>
                   </div>
                 </div>
              ))}
            </div>
          </Modal>

          {/* Add Friend Modal */}
          <Modal
            isOpen={modalState.open && modalState.type === 'add_friend'}
            onClose={() => setModalState({ open: true, type: 'fab_menu' })} // Go back to list
            title="Add Contact"
          >
             <p className="text-sm text-gray-400 mb-4">Enter their unique Vynix ID (e.g. alex#1234) to add them.</p>
             <div className="space-y-4">
               <input
                 className="w-full bg-[#111b21] border border-gray-700 text-white rounded-lg px-4 py-3 outline-none focus:border-green-500 font-mono"
                 placeholder="username#0000"
                 value={addIdInput}
                 onChange={(e) => setAddIdInput(e.target.value)}
               />
               <button 
                onClick={handleAddFriend}
                disabled={addLoading}
                className="w-full bg-green-500 text-black font-bold py-3 rounded-lg hover:bg-green-400 disabled:opacity-50"
               >
                 {addLoading ? 'Searching...' : 'Add Friend'}
               </button>
             </div>
          </Modal>

        </div>
      );
    };

    // ─── ROOT COMPONENT ───
    const App = () => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged((u) => {
          setUser(u);
          setLoading(false);
        });
        return unsubscribe;
      }, []);

      if (loading) return <div className="h-screen w-screen bg-[#111b21] flex items-center justify-center text-green-500">Loading Vynix...</div>;

      return user ? <MainApp user={user} /> : <AuthScreen />;
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
