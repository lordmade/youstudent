<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Privy â€¢ Connect</title>
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      /* --- Light Theme Variables --- */
      --bg: #f3f4f6;
      --surface: #ffffff;
      --surface-hover: #f9fafb;
      --border: #e5e7eb;
      --primary: #3b82f6;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --sent-bg: #3b82f6;
      --sent-text: #ffffff;
      --recv-bg: #e5e7eb;
      --recv-text: #1f2937;
      --danger: #ef4444;
      --success: #10b981;
      
      --header-h: 64px;
      --radius: 16px;
    }

    [data-theme="dark"] {
      --bg: #1a1a1a;
      --surface: #2a2a2a;
      --surface-hover: #3a3a3a;
      --border: #3a3a3a;
      --primary: #3b82f6;
      --text-main: #f3f4f6;
      --text-muted: #a0a0a0;
      --sent-bg: #3b82f6;
      --sent-text: #ffffff;
      --recv-bg: #3a3a3a;
      --recv-text: #f3f4f6;
      --danger: #ef4444;
      --success: #10b981;
    }

    * { 
      margin: 0; padding: 0; box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
      -webkit-user-select: none; user-select: none;
      -webkit-touch-callout: none;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text-main);
      height: 100dvh;
      display: flex; flex-direction: column;
      overflow: hidden;
      touch-action: pan-x pan-y; 
    }

    /* --- Views --- */
    .view {
      position: absolute; inset: 0;
      display: flex; flex-direction: column;
      background: var(--bg);
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      z-index: 10;
    }
    .view.hidden { transform: translateX(100%); z-index: 5; pointer-events: none; }
    .view.active { transform: translateX(0); z-index: 10; pointer-events: auto; }
    
    #loginView { z-index: 50; justify-content: center; align-items: center; padding: 24px; text-align: center; background: var(--surface); }

    /* --- Headers --- */
    header {
      height: var(--header-h);
      padding: 0 16px;
      display: flex; align-items: center; justify-content: space-between;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      z-index: 20;
    }
    .header-title { font-weight: 700; font-size: 20px; }

    .icon-btn {
      background: none; border: none; color: var(--text-main);
      padding: 8px; border-radius: 50%; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .icon-btn:active { background: var(--border); }

    .avatar {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--border);
      background-size: cover; background-position: center;
      flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      position: relative;
    }

    /* --- Profile View --- */
    .profile-container {
      padding: 24px;
      display: flex; flex-direction: column; align-items: center; gap: 20px;
    }
    .profile-avatar-large {
      width: 100px; height: 100px; border-radius: 50%;
      background-size: cover; background-position: center;
      background-color: var(--border);
      position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .edit-badge {
      position: absolute; bottom: 0; right: 0;
      background: var(--primary); color: white;
      width: 32px; height: 32px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      border: 3px solid var(--surface);
    }
    .input-group { width: 100%; margin-bottom: 16px; }
    .input-label { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; display: block; font-weight: 500; }
    .text-input {
      width: 100%; padding: 14px; border-radius: 12px;
      border: 1px solid var(--border); background: var(--surface);
      font-size: 16px; color: var(--text-main); outline: none;
      -webkit-user-select: text; user-select: text;
    }
    .text-input:focus { border-color: var(--primary); }
    
    .btn-primary {
      width: 100%; padding: 14px; border-radius: 12px;
      background: var(--primary); color: white;
      border: none; font-weight: 600; font-size: 16px;
    }
    .btn-primary:disabled { opacity: 0.6; }

    /* --- Settings Section --- */
    .settings-section {
      width: 100%;
      margin-top: 24px;
      padding: 16px;
      background: var(--surface);
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .settings-header {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
    }
    .toggle-group {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .toggle-group:last-child { border-bottom: none; }
    .toggle-label {
      font-size: 15px;
      color: var(--text-main);
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--border);
      transition: .4s;
      border-radius: 28px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background: var(--primary);
    }
    input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }
    .btn-danger {
      width: 100%; padding: 14px; border-radius: 12px;
      background: var(--danger); color: white;
      border: none; font-weight: 600; font-size: 16px;
      margin-top: 24px;
    }

    /* --- Chat List & Search --- */
    .search-container {
      padding: 12px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    .search-box {
      background: var(--bg);
      border-radius: 12px;
      display: flex; align-items: center;
      padding: 0 12px;
      height: 44px;
    }
    .search-box input {
      border: none; background: transparent;
      flex: 1; margin-left: 8px;
      font-size: 15px; color: var(--text-main);
      outline: none; font-family: inherit;
      -webkit-user-select: text; user-select: text;
    }

    #chatList { flex: 1; overflow-y: auto; overflow-x: hidden; }
    
    .swipe-wrapper { position: relative; overflow: hidden; border-bottom: 1px solid var(--border); }
    .swipe-actions {
      position: absolute; top: 0; bottom: 0; right: 0; width: 80px;
      background: var(--danger);
      display: flex; align-items: center; justify-content: center; color: white;
      z-index: 1;
    }

    .chat-row {
      position: relative; background: var(--surface);
      display: flex; align-items: center; gap: 14px;
      padding: 16px; cursor: pointer; z-index: 2;
      transition: transform 0.2s ease-out;
      touch-action: pan-y; 
    }
    .chat-row:active { background: var(--surface-hover); }
    .chat-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
    .chat-preview { font-size: 14px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-meta { font-size: 11px; color: var(--text-muted); text-align: right; }
    .badge { 
      background: var(--primary); color: white; 
      font-size: 10px; font-weight: 700; 
      padding: 2px 8px; border-radius: 10px; 
      margin-top: 4px; display: inline-block;
    }

    /* --- Chat Room Header & Messages --- */
    .header-info { margin-left: 10px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .status-text { font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
    .status-text.online { color: var(--success); font-weight: 500; }

    #msgList {
      flex: 1; overflow-y: auto; padding: 16px;
      display: flex; flex-direction: column; gap: 8px;
      background: #eef1f5;
    }
    [data-theme="dark"] #msgList {
      background: #1a1a1a;
    }
    .msg {
      max-width: 75%; padding: 10px 14px;
      font-size: 15px; line-height: 1.4;
      position: relative; word-wrap: break-word;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      -webkit-user-select: text; user-select: text;
    }
    .msg.sent { align-self: flex-end; background: var(--sent-bg); color: var(--sent-text); border-radius: 16px 16px 4px 16px; }
    .msg.recv { align-self: flex-start; background: var(--surface); color: var(--recv-text); border-radius: 16px 16px 16px 4px; }
    .msg-time { font-size: 10px; margin-top: 4px; opacity: 0.7; text-align: right; }

    /* --- Input Area --- */
    .input-bar {
      padding: 10px 16px; background: var(--surface);
      display: flex; align-items: flex-end; gap: 10px;
      border-top: 1px solid var(--border);
    }
    textarea {
      flex: 1; background: var(--bg); color: var(--text-main);
      border: none; border-radius: 20px; padding: 12px 16px;
      font-family: inherit; font-size: 15px;
      resize: none; max-height: 120px; min-height: 44px;
      -webkit-user-select: text; user-select: text;
    }
    textarea:focus { outline: 2px solid var(--primary); }

    .send-btn {
      width: 44px; height: 44px; border-radius: 50%;
      background: var(--primary); color: white; border: none;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; flex-shrink: 0;
    }

    /* --- Bottom Sheet --- */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4);
      z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .overlay.active { opacity: 1; pointer-events: auto; }

    .bottom-sheet {
      position: fixed; left: 0; bottom: 0; width: 100%;
      background: var(--surface);
      border-radius: 24px 24px 0 0;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      z-index: 101; max-height: 85vh;
      display: flex; flex-direction: column;
    }
    .bottom-sheet.active { transform: translateY(0); }

    .sheet-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 12px auto; }
    .sheet-header { padding: 0 24px 16px; font-weight: 700; font-size: 18px; }
    .sheet-content { overflow-y: auto; padding: 0 16px 32px; }
    
    .user-card {
      display: flex; align-items: center; gap: 12px;
      padding: 12px; border-radius: 12px; margin-bottom: 4px;
    }
    .user-card:active { background: var(--bg); }

    /* --- FAB & Toast --- */
    .fab {
      position: fixed; bottom: 24px; right: 24px;
      width: 56px; height: 56px; background: var(--primary); color: white;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4); cursor: pointer; z-index: 30;
      transition: transform 0.2s;
    }
    .fab:active { transform: scale(0.95); }

    #toast {
      position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
      background: #1f2937; color: white; padding: 10px 20px;
      border-radius: 30px; font-size: 13px; pointer-events: none;
      opacity: 0; transition: opacity 0.3s; z-index: 200; white-space: nowrap;
    }

    /* --- Notification Banner --- */
    .msg-notification {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 150;
      transform: translateY(-100%);
      transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
      pointer-events: none;
    }

    .msg-notification.active {
      transform: translateY(0);
      pointer-events: auto;
    }

    .msg-notification.hidden {
      display: none;
    }

    .notification-content {
      margin: 12px 16px;
      padding: 14px 16px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.18);
      display: flex;
      align-items: center;
      gap: 14px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0,0,0,0.06);
    }

    [data-theme="dark"] .notification-content {
      background: #2a2a2a;
    }

    .notification-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
    }

    .notification-text {
      flex: 1;
      min-width: 0;
    }

    .notification-name {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 3px;
    }

    .notification-preview {
      font-size: 14px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* --- Custom Delete Modal --- */
    .delete-modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200;
      display: flex; align-items: center; justify-content: center;
    }
    .delete-content {
      background: var(--surface); border-radius: 16px; padding: 24px; width: 90%; max-width: 360px; text-align: center;
    }
    .delete-title {
      margin-bottom: 16px; font-size: 18px; font-weight: 600;
    }
    .delete-text {
      color: var(--text-muted); margin-bottom: 24px;
    }
    .delete-buttons {
      display: flex; gap: 12px;
    }
    .btn-cancel {
      flex: 1; padding: 12px; border-radius: 12px; background: var(--border); border: none; font-weight: 600; color: var(--text-main);
    }
    .btn-delete {
      flex: 1; padding: 12px; border-radius: 12px; background: var(--danger); color: white; border: none; font-weight: 600;
    }
  </style>
</head>
<body>

  <div id="loginView" class="view">
    <div style="width:100%; max-width:340px;">
      <div style="font-size:32px; font-weight:800; color:var(--primary); margin-bottom:8px;">Privy.</div>
      <div style="color:var(--text-muted); margin-bottom:32px;">Secure. Connected. Private.</div>
      <button class="btn-primary" onclick="handleLogin()">Sign in with Google</button>
    </div>
  </div>

  <div id="listView" class="view hidden">
    <header>
      <div class="header-title">Chats</div>
      <div class="avatar" id="myAvatar" onclick="openProfile()"></div>
    </header>

    <div class="search-container">
      <div class="search-box">
        <span class="material-symbols-rounded" style="color:var(--text-muted)">search</span>
        <input type="text" id="mainSearch" placeholder="Search conversations..." onkeyup="filterChats()">
      </div>
    </div>

    <div id="chatList"></div>
    
    <div class="fab" onclick="openBottomSheet()">
      <span class="material-symbols-rounded">person_add</span>
    </div>
  </div>

  <div id="profileView" class="view hidden">
    <header>
      <button class="icon-btn" onclick="navBack()">
        <span class="material-symbols-rounded">arrow_back</span>
      </button>
      <div class="header-title">Profile & Settings</div>
      <div style="width:40px"></div>
    </header>

    <div class="profile-container">
      <div class="profile-avatar-large" id="editAvatar" onclick="document.getElementById('fileInput').click()">
        <div class="edit-badge"><span class="material-symbols-rounded" style="font-size:18px">edit</span></div>
      </div>
      <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleImageUpload(this)">

      <div class="input-group">
        <label class="input-label">Username</label>
        <input type="text" class="text-input" id="editUsername" placeholder="Enter username">
      </div>
      
      <div class="input-group">
         <label class="input-label">My User ID (Read Only)</label>
         <input type="text" class="text-input" id="readOnlyUid" readonly style="color:var(--text-muted); background:var(--bg)">
      </div>

      <button class="btn-primary" id="saveProfileBtn" onclick="saveProfile()">Save Changes</button>
      <div style="font-size:11px; color:var(--text-muted); text-align:center">
          Tap avatar to upload new picture.
      </div>

      <!-- Settings Section -->
      <div class="settings-section">
        <div class="settings-header">App Settings</div>
        
        <div class="toggle-group">
          <label class="toggle-label">Sound Notifications</label>
          <label class="toggle-switch">
            <input type="checkbox" id="soundToggle" checked onchange="saveSettings()">
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <div class="toggle-group">
          <label class="toggle-label">Vibration on Mobile</label>
          <label class="toggle-switch">
            <input type="checkbox" id="vibrationToggle" checked onchange="saveSettings()">
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <div class="toggle-group">
          <label class="toggle-label">Dark Mode</label>
          <label class="toggle-switch">
            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode(this.checked); saveSettings()">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <button class="btn-danger" onclick="handleLogout()">Logout</button>
    </div>
  </div>

  <div id="chatView" class="view hidden">
    <header>
      <button class="icon-btn" onclick="navBack()">
        <span class="material-symbols-rounded">arrow_back</span>
      </button>
      <div class="header-info">
        <div class="chat-name" id="roomName" style="font-size:16px; margin:0;">User</div>
        <div class="status-text" id="roomStatus">offline</div>
      </div>
      <div class="avatar" id="roomAvatar" style="width:36px; height:36px;"></div>
    </header>

    <div id="msgList"></div>

    <div class="input-bar">
      <textarea id="msgInput" rows="1" placeholder="Message..."></textarea>
      <button class="send-btn" id="sendBtn">
        <span class="material-symbols-rounded">send</span>
      </button>
    </div>
  </div>

  <div class="overlay" id="sheetOverlay" onclick="closeBottomSheet()"></div>
  <div class="bottom-sheet" id="bottomSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">New Chat</div>
    <div style="padding: 0 16px 16px;">
        <div class="search-box" style="background:var(--bg)">
            <span class="material-symbols-rounded" style="color:var(--text-muted)">search</span>
            <input type="text" id="userSearch" placeholder="Username, ID, or Email..." onkeyup="searchUsers()">
        </div>
    </div>
    <div style="padding:0 24px 8px; font-size:12px; font-weight:700; color:var(--text-muted); text-transform:uppercase">
        Available Users
    </div>
    <div class="sheet-content" id="sheetList">
        <div style="text-align:center; padding:20px; color:var(--text-muted)">Loading...</div>
    </div>
  </div>

  <div id="toast"></div>
  <div id="msgNotification" class="msg-notification hidden">
    <div class="notification-content">
      <div class="notification-avatar"></div>
      <div class="notification-text">
        <div class="notification-name">Someone</div>
        <div class="notification-preview">New message...</div>
      </div>
    </div>
  </div>

  <script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // --- STATE ---
    let currentUser = null;
    let currentChatUid = null;
    let currentRoomId = null;
    let messagesListener = null;
    let statusListener = null;
    let sharedKeys = JSON.parse(localStorage.getItem('sharedKeys') || '{}');
    let allUsersCache = [];
    let tempUploadedImageUrl = null;
    let userSettings = { sound: true, vibration: true, darkMode: false };
    let notificationQueue = [];
    let isShowingNotification = false;

    // --- Notification Sound ---
    const notificationSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-soft-notification-bell-588.mp3');
    notificationSound.volume = 0.6;

    // --- CRYPTO (ECDH + AES) ---
    async function generateAndStoreKeyPair() {
      const keyPair = await crypto.subtle.generateKey(
        { name: "ECDH", namedCurve: "P-256" }, true, ["deriveBits"]
      );
      const pubJwk = await crypto.subtle.exportKey("jwk", keyPair.publicKey);
      const privJwk = await crypto.subtle.exportKey("jwk", keyPair.privateKey);
      localStorage.setItem('privKey', JSON.stringify(privJwk));
      return pubJwk;
    }

    async function deriveSharedSecret(friendPublicJwk) {
      try {
        const privJwk = JSON.parse(localStorage.getItem('privKey'));
        if (!privJwk) return null;
        const privateKey = await crypto.subtle.importKey("jwk", privJwk, { name: "ECDH", namedCurve: "P-256" }, false, ["deriveBits"]);
        const friendPublicKey = await crypto.subtle.importKey("jwk", friendPublicJwk, { name: "ECDH", namedCurve: "P-256" }, false, []);
        const sharedBits = await crypto.subtle.deriveBits({ name: "ECDH", public: friendPublicKey }, privateKey, 256);
        return Array.from(new Uint8Array(sharedBits)).map(b => b.toString(16).padStart(2,'0')).join('');
      } catch (e) { return null; }
    }

    function encrypt(text, secretHex) {
      if(!secretHex) return text; 
      return CryptoJS.AES.encrypt(text, secretHex).toString();
    }

    function decrypt(ciphertext, secretHex) {
      if(!secretHex) return "Waiting for key...";
      try {
        const bytes = CryptoJS.AES.decrypt(ciphertext, secretHex);
        return bytes.toString(CryptoJS.enc.Utf8) || "[Decryption Error]";
      } catch(e) { return "[Locked Message]"; }
    }

    // --- AUTH & PRESENCE ---
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        setupPresence(user.uid);
        switchView('listView');
        
        // Load Profile Data
        const pSnap = await db.ref(`users/${user.uid}/profile`).once('value');
        const p = pSnap.val() || {};
        
        // Init Key if missing
        if (!localStorage.getItem('privKey')) {
          const pubKey = await generateAndStoreKeyPair();
          await db.ref(`users/${user.uid}/profile`).update({
            name: user.displayName, email: user.email, photo: user.photoURL, publicKey: JSON.stringify(pubKey), uid: user.uid, username: user.displayName
          });
        }
        
        updateMyAvatarUI(p.photo || user.photoURL);
        loadChatList();
        fetchAllUsers();

        // Load Settings
        const sSnap = await db.ref(`users/${user.uid}/settings`).once('value');
        userSettings = { ...userSettings, ...sSnap.val() };
        applySettings();

        // Global Notification Listener
        db.ref(`users/${currentUser.uid}/chats`).on('child_changed', async (snap) => {
          const chat = snap.val();
          const friendUid = snap.key;

          if (!chat.lastMsg || currentChatUid === friendUid) return;

          const profileSnap = await db.ref(`users/${friendUid}/profile`).once('value');
          const profile = profileSnap.val() || {};

          let preview = decrypt(chat.lastMsg, sharedKeys[friendUid] || "");
          if (!preview || preview.includes("Error")) preview = "New message";

          showMessageNotification(friendUid, preview, profile);
        });
      } else {
        switchView('loginView');
      }
    });

    function handleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(e => showToast("Login Error: " + e.message));
    }

    function handleLogout() {
      auth.signOut().then(() => showToast("Logged out"));
    }

    function setupPresence(uid) {
        const connectedRef = db.ref('.info/connected');
        const myStatusRef = db.ref(`users/${uid}/status`);
        const myLastSeenRef = db.ref(`users/${uid}/lastSeen`);

        connectedRef.on('value', (snap) => {
            if (snap.val() === true) {
                myStatusRef.onDisconnect().set('offline');
                myLastSeenRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
                myStatusRef.set('online');
            }
        });
    }

    function updateMyAvatarUI(url) {
        document.getElementById('myAvatar').style.backgroundImage = `url(${url})`;
        document.getElementById('editAvatar').style.backgroundImage = `url(${url})`;
    }

    // --- SETTINGS ---
    function applySettings() {
      document.getElementById('soundToggle').checked = userSettings.sound;
      document.getElementById('vibrationToggle').checked = userSettings.vibration;
      document.getElementById('darkModeToggle').checked = userSettings.darkMode;
      toggleDarkMode(userSettings.darkMode);
    }

    async function saveSettings() {
      userSettings.sound = document.getElementById('soundToggle').checked;
      userSettings.vibration = document.getElementById('vibrationToggle').checked;
      userSettings.darkMode = document.getElementById('darkModeToggle').checked;
      await db.ref(`users/${currentUser.uid}/settings`).set(userSettings);
    }

    function toggleDarkMode(enabled) {
      document.documentElement.setAttribute('data-theme', enabled ? 'dark' : 'light');
    }

    // --- PROFILE & CLOUDINARY ---
    async function openProfile() {
        switchView('profileView');
        const snap = await db.ref(`users/${currentUser.uid}/profile`).once('value');
        const p = snap.val();
        document.getElementById('editUsername').value = p.username || p.name;
        document.getElementById('readOnlyUid').value = currentUser.uid;
        applySettings(); // Ensure toggles are set
        tempUploadedImageUrl = null; 
    }

    async function handleImageUpload(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        
        showToast("Uploading image...");
        const formData = new FormData();
        formData.append('file', file);
        
        // *** IMPORTANT: REPLACE THESE WITH YOUR CLOUDINARY DETAILS ***
        // Create an UNSIGNED upload preset in Cloudinary Settings -> Upload
        const UPLOAD_PRESET = "privy_preset"; 
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dtrj5h016/image/upload";

        try {
            const res = await fetch(CLOUDINARY_URL, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            
            if(data.secure_url) {
                tempUploadedImageUrl = data.secure_url;
                document.getElementById('editAvatar').style.backgroundImage = `url(${tempUploadedImageUrl})`;
                showToast("Image uploaded. Click Save.");
            } else {
                showToast("Upload failed. Check settings.");
                console.error(data);
            }
        } catch(e) {
            showToast("Upload Error: " + e.message);
        }
    }

    async function saveProfile() {
        const newName = document.getElementById('editUsername').value.trim();
        if(!newName) return showToast("Username cannot be empty");

        const updates = { username: newName, name: newName }; // Sync display name
        if(tempUploadedImageUrl) updates.photo = tempUploadedImageUrl;

        await db.ref(`users/${currentUser.uid}/profile`).update(updates);
        
        // Update local UI
        if(tempUploadedImageUrl) updateMyAvatarUI(tempUploadedImageUrl);
        showToast("Profile Saved!");
        navBack();
    }

    // --- CHAT LIST ---
    function loadChatList() {
      const listEl = document.getElementById('chatList');
      const chatsRef = db.ref(`users/${currentUser.uid}/chats`);

      chatsRef.on('value', async (snap) => {
        listEl.innerHTML = '';
        if (!snap.exists()) {
          listEl.innerHTML = '<div style="padding:40px; text-align:center; color:var(--text-muted)">No chats yet. Tap + to start one!</div>';
          return;
        }

        const chats = [];
        snap.forEach(c => {
          chats.push({ uid: c.key, ...c.val() });
        });
        chats.sort((a,b) => b.ts - a.ts); // newest first

        for (const chat of chats) {
          const friendUid = chat.uid;
          const pSnap = await db.ref(`users/${friendUid}/profile`).once('value');
          const p = pSnap.val() || {};

          let preview = chat.lastMsg ? decrypt(chat.lastMsg, sharedKeys[friendUid] || "") : "Started a chat";
          if (!preview || preview.includes("Error")) preview = "New chat";

          const wrapper = document.createElement('div');
          wrapper.className = 'swipe-wrapper';
          wrapper.dataset.searchKey = (p.username || p.name || '').toLowerCase();

          const deleteBtn = document.createElement('div');
          deleteBtn.className = 'swipe-actions';
          deleteBtn.innerHTML = '<span class="material-symbols-rounded">delete</span>';
          deleteBtn.onclick = (e) => { e.stopPropagation(); deleteChat(friendUid); };

          const row = document.createElement('div');
          row.className = 'chat-row';
          row.innerHTML = `
            <div class="avatar" style="background-image: url(${p.photo || 'https://i.pravatar.cc/100'})"></div>
            <div style="flex:1; min-width:0">
              <div class="chat-name">${p.username || p.name || 'User'}</div>
              <div class="chat-preview">${preview}</div>
            </div>
            <div class="chat-meta" style="display:flex; flex-direction:column; align-items:flex-end;">
              <div>${formatTime(chat.ts)}</div>
              \( {chat.unreadCount > 0 ? `<div class="badge"> \){chat.unreadCount > 99 ? '99+' : chat.unreadCount}</div>` : ''}
            </div>
          `;

          row.onclick = () => {
            if (row.style.transform?.includes('-80px')) {
              resetSwipes();
            } else {
              openChat(friendUid, p);
            }
          };

          enableSwipe(row);
          wrapper.append(deleteBtn, row);
          listEl.appendChild(wrapper);
        }
      });
    }

    function deleteChat(uid) {
      const modal = document.createElement('div');
      modal.className = 'delete-modal';
      modal.innerHTML = `
        <div class="delete-content">
          <h3 class="delete-title">Delete chat?</h3>
          <p class="delete-text">This will hide the chat from your list.</p>
          <div class="delete-buttons">
            <button class="btn-cancel" onclick="this.closest('.delete-modal').remove()">Cancel</button>
            <button class="btn-delete" onclick="confirmDelete('${uid}')">Delete</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function confirmDelete(uid) {
      db.ref(`users/\( {currentUser.uid}/chats/ \){uid}`).remove();
      document.querySelector('.delete-modal').remove();
      showToast("Chat removed");
    }

    // --- CHAT ROOM & PRESENCE HEADER ---
    async function openChat(friendUid, profile) {
      currentChatUid = friendUid;
      currentRoomId = [currentUser.uid, friendUid].sort().join('_');
      
      const nameEl = document.getElementById('roomName');
      const statusEl = document.getElementById('roomStatus');
      const avatarEl = document.getElementById('roomAvatar');

      nameEl.innerText = profile.username || profile.name || "Chat";
      avatarEl.style.backgroundImage = `url(${profile.photo || 'https://i.pravatar.cc/100'})`;
      
      switchView('chatView');

      // Key Exchange Check
      if (!sharedKeys[friendUid] && profile.publicKey) {
         const secret = await deriveSharedSecret(JSON.parse(profile.publicKey));
         if(secret) {
             sharedKeys[friendUid] = secret;
             localStorage.setItem('sharedKeys', JSON.stringify(sharedKeys));
         }
      }

      // Mark as read
      await db.ref(`users/\( {currentUser.uid}/chats/ \){friendUid}`).update({
        unreadCount: 0,
        lastRead: firebase.database.ServerValue.TIMESTAMP
      });

      // Live Presence Listener
      if(statusListener) statusListener.off();
      statusListener = db.ref(`users/${friendUid}`).on('value', (snap) => {
          const u = snap.val();
          if(!u) return;
          if(u.status === 'online') {
              statusEl.innerHTML = "Online";
              statusEl.className = "status-text online";
          } else {
              statusEl.className = "status-text";
              statusEl.innerHTML = u.lastSeen ? `Last seen ${formatLastSeen(u.lastSeen)}` : 'Offline';
          }
      });

      loadMessages();
    }

    function loadMessages() {
      const msgList = document.getElementById('msgList');
      msgList.innerHTML = '';
      if(messagesListener) messagesListener.off();
      
      messagesListener = db.ref(`messages/${currentRoomId}`).limitToLast(50);
      messagesListener.on('child_added', (snap) => {
        const data = snap.val();
        const isMe = data.sender === currentUser.uid;
        const text = decrypt(data.text, sharedKeys[currentChatUid]);

        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'sent' : 'recv'}`;
        div.innerHTML = `\( {text}<div class="msg-time"> \){new Date(data.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>`;
        msgList.appendChild(div);
        msgList.scrollTop = msgList.scrollHeight;
      });
    }

    async function sendMessage() {
      const input = document.getElementById('msgInput');
      const text = input.value.trim();
      if (!text || !currentChatUid) return;

      const secret = sharedKeys[currentChatUid];
      if (!secret) {
        showToast("Still establishing secure connection...");
        return;
      }

      const encrypted = encrypt(text, secret);
      const ts = Date.now();
      input.value = '';
      
      await db.ref(`messages/${currentRoomId}`).push({ text: encrypted, sender: currentUser.uid, ts: ts });
      const updates = {
        [`users/\( {currentUser.uid}/chats/ \){currentChatUid}/lastMsg`]: encrypted,
        [`users/\( {currentUser.uid}/chats/ \){currentChatUid}/ts`]: ts,
        [`users/\( {currentChatUid}/chats/ \){currentUser.uid}/lastMsg`]: encrypted,
        [`users/\( {currentChatUid}/chats/ \){currentUser.uid}/ts`]: ts
      };
      await db.ref().update(updates);

      // Increment unread if not viewed recently
      db.ref(`users/\( {currentChatUid}/chats/ \){currentUser.uid}/lastRead`).once('value', snap => {
        const lastRead = snap.val() || 0;
        if (ts > lastRead) {
          db.ref(`users/\( {currentChatUid}/chats/ \){currentUser.uid}/unreadCount`).transaction(c => (c||0)+1);
        }
      });
    }
    document.getElementById('sendBtn').onclick = sendMessage;

    // --- SEARCH & FRIENDS SHEET ---
    async function fetchAllUsers() {
        const snap = await db.ref('users').once('value');
        allUsersCache = [];
        snap.forEach(child => {
            const p = child.val().profile;
            if (p && p.uid !== currentUser.uid) allUsersCache.push(p);
        });
    }

    function populateUserList(filterText = "") {
        const list = document.getElementById('sheetList');
        list.innerHTML = '';
        
        // Filter by Username, ID, or Email
        const q = filterText.toLowerCase();
        const filtered = allUsersCache.filter(u => {
            const name = (u.username || u.name || '').toLowerCase();
            const email = (u.email || '').toLowerCase();
            const uid = (u.uid || '').toLowerCase();
            return name.includes(q) || email.includes(q) || uid.includes(q);
        });

        if(filtered.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">No users found</div>';
            return;
        }

        filtered.forEach(u => {
            const el = document.createElement('div');
            el.className = 'user-card';
            el.onclick = async () => {
              closeBottomSheet();

              // Create chat placeholder if not exists
              const friendUid = u.uid;
              const myUid = currentUser.uid;
              const roomId = [myUid, friendUid].sort().join('_');

              const myChatSnap = await db.ref(`users/\( {myUid}/chats/ \){friendUid}`).once('value');

              if (!myChatSnap.exists()) {
                  const now = Date.now();
                  const chatData = {
                      ts: now,
                      lastMsg: "",           
                      unreadCount: 0
                  };

                  const batch = {};
                  batch[`users/\( {myUid}/chats/ \){friendUid}`] = chatData;
                  batch[`users/\( {friendUid}/chats/ \){myUid}`] = chatData;
                  await db.ref().update(batch);
                  showToast("Chat started");

                  // Key exchange
                  const friendSnap = await db.ref(`users/${friendUid}/profile/publicKey`).once('value');
                  const friendPubJwk = friendSnap.val();

                  if (friendPubJwk) {
                      const secret = await deriveSharedSecret(JSON.parse(friendPubJwk));
                      if (secret) {
                          sharedKeys[friendUid] = secret;
                          localStorage.setItem('sharedKeys', JSON.stringify(sharedKeys));
                      }
                  }
              }

              openChat(friendUid, u);
          };
            el.innerHTML = `
                <div class="avatar" style="background-image:url(${u.photo || 'https://i.pravatar.cc/100'})"></div>
                <div>
                    <div style="font-weight:600; font-size:15px">${u.username || u.name}</div>
                    <div style="font-size:12px; color:var(--text-muted)">${u.email}</div>
                </div>
            `;
            list.appendChild(el);
        });
    }

    function searchUsers() {
        populateUserList(document.getElementById('userSearch').value);
    }
    
    function filterChats() {
        const query = document.getElementById('mainSearch').value.toLowerCase();
        document.querySelectorAll('.swipe-wrapper').forEach(row => {
            row.style.display = row.dataset.searchKey.includes(query) ? 'block' : 'none';
        });
    }

    // --- NOTIFICATIONS ---
    function showMessageNotification(senderUid, previewText, senderProfile) {
      if (currentChatUid === senderUid) return;

      notificationQueue.push({ senderUid, previewText, senderProfile });

      if (!isShowingNotification) {
        processNotificationQueue();
      }
    }

    async function processNotificationQueue() {
      if (notificationQueue.length === 0) {
        isShowingNotification = false;
        return;
      }

      isShowingNotification = true;

      const { senderUid, previewText, senderProfile } = notificationQueue.shift();

      const notif = document.getElementById('msgNotification');
      const avatar = notif.querySelector('.notification-avatar');
      const nameEl = notif.querySelector('.notification-name');
      const prevEl = notif.querySelector('.notification-preview');

      avatar.style.backgroundImage = `url(${senderProfile.photo || 'https://i.pravatar.cc/100'})`;
      nameEl.textContent = senderProfile.username || senderProfile.name || "New message";
      prevEl.textContent = previewText || "Sent you a message";

      notif.classList.remove('hidden');
      setTimeout(() => notif.classList.add('active'), 10);

      // Play sound + vibrate if enabled
      if (userSettings.sound) {
        notificationSound.currentTime = 0;
        notificationSound.play().catch(() => {});
      }
      if (userSettings.vibration && navigator.vibrate) {
        navigator.vibrate([200]);
      }

      notif.onclick = () => {
        hideMessageNotification();
        openChat(senderUid, senderProfile);
        notificationQueue = [];
      };

      setTimeout(() => {
        hideMessageNotification();
        setTimeout(processNotificationQueue, 800);
      }, 4500);
    }

    function hideMessageNotification() {
      const notif = document.getElementById('msgNotification');
      notif.classList.remove('active');
      setTimeout(() => {
        notif.classList.add('hidden');
        notif.onclick = null;
      }, 400);
    }

    // --- UI HELPERS ---
    function openBottomSheet() {
        document.getElementById('sheetOverlay').classList.add('active');
        document.getElementById('bottomSheet').classList.add('active');
        populateUserList(); // Show all initially
    }
    function closeBottomSheet() {
        document.getElementById('sheetOverlay').classList.remove('active');
        document.getElementById('bottomSheet').classList.remove('active');
    }
    function switchView(id) {
      document.querySelectorAll('.view').forEach(el => { el.classList.add('hidden'); el.classList.remove('active'); });
      const t = document.getElementById(id); t.classList.remove('hidden'); t.classList.add('active');
    }
    function navBack() { 
        switchView('listView'); 
        currentChatUid = null; 
        if(messagesListener) messagesListener.off();
        if(statusListener) statusListener.off();
    }
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg; t.style.opacity = '1';
      setTimeout(() => t.style.opacity = '0', 3000);
    }
    function formatTime(ts) {
      const d = new Date(ts);
      if (Date.now() - ts < 86400000) return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      return d.toLocaleDateString();
    }
    function formatLastSeen(ts) {
        const d = new Date(ts);
        const today = new Date();
        const isToday = d.getDate() === today.getDate() && d.getMonth() === today.getMonth();
        const timeStr = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        return isToday ? `today at \( {timeStr}` : ` \){d.toLocaleDateString()} at ${timeStr}`;
    }

    // Swipe Logic
    function enableSwipe(el) {
        let startX, currentX;
        el.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; resetSwipes(el); }, {passive: true});
        el.addEventListener('touchmove', (e) => {
            currentX = e.touches[0].clientX;
            let diff = currentX - startX;
            if (diff < -80) diff = -80; if (diff > 0) diff = 0;
            el.style.transform = `translateX(${diff}px)`;
        }, {passive: true});
        el.addEventListener('touchend', () => {
            if ((currentX - startX) < -40) el.style.transform = `translateX(-80px)`;
            else el.style.transform = `translateX(0)`;
        });
    }
    function resetSwipes(except) {
        document.querySelectorAll('.chat-row').forEach(row => { if(row!==except) row.style.transform = 'translateX(0)'; });
    }
    // Auto-resize
    document.getElementById('msgInput').addEventListener("input", function(){
      this.style.height = 'auto'; this.style.height = (this.scrollHeight) + "px";
    });
  </script>
</body>
</html>
