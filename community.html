<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Privy â€¢ Secure Chat</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --primary: #6366f1;
      --primary-grad: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      --bg: #f8fafc;
      --surface: #ffffff;
      --surface-translucent: rgba(255, 255, 255, 0.85);
      --border: #e2e8f0;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --sent-bg: var(--primary-grad);
      --sent-text: #ffffff;
      --recv-bg: #ffffff;
      --recv-text: #1e293b;
      --online: #10b981;
      --danger: #ef4444;
      --header-h: 60px;
      --shadow-float: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; -webkit-user-select: none; user-select: none; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
    input, textarea, button { font-family: inherit; outline: none; }

    /* --- Views --- */
    .view { position: absolute; inset: 0; display: flex; flex-direction: column; background: var(--bg); transition: transform 0.3s ease; z-index: 10; }
    .view.hidden { transform: translateX(100%); z-index: 5; pointer-events: none; }
    .view.active { transform: translateX(0); z-index: 10; pointer-events: auto; }
    
    #loginView { z-index: 50; justify-content: center; align-items: center; padding: 32px; text-align: center; background: radial-gradient(circle at top right, #e0e7ff, #f8fafc); }
    .brand-logo { font-family: 'Outfit', sans-serif; font-size: 48px; font-weight: 800; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }

    /* --- Header --- */
    header { height: var(--header-h); padding: 0 20px; display: flex; align-items: center; justify-content: space-between; background: var(--surface-translucent); backdrop-filter: blur(16px); border-bottom: 1px solid var(--border); z-index: 20; }
    .header-title { font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 22px; }
    .icon-btn { background: transparent; border: none; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: var(--text-main); cursor: pointer; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #e2e8f0; background-size: cover; background-position: center; flex-shrink: 0; }

    /* --- Chat List --- */
    .search-box { margin: 12px 20px; background: var(--surface); border-radius: 12px; display: flex; align-items: center; padding: 0 12px; height: 44px; border: 1px solid var(--border); }
    .search-box input { border: none; background: transparent; flex: 1; margin-left: 8px; font-size: 15px; -webkit-user-select: text; user-select: text; }
    #chatList { flex: 1; overflow-y: auto; padding-bottom: 80px; }
    
    .chat-row { display: flex; align-items: center; gap: 16px; padding: 16px 20px; background: var(--surface); border-bottom: 1px solid var(--border); cursor: pointer; }
    .chat-row:active { background: #f1f5f9; }
    .chat-info { flex: 1; overflow: hidden; }
    .chat-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
    .chat-preview { font-size: 14px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* --- Chat Room --- */
    .status-text { font-size: 12px; color: var(--text-muted); }
    .status-text.online { color: var(--online); font-weight: 600; }
    #msgList { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background: #f1f5f9; }
    
    .msg { max-width: 75%; padding: 10px 16px; font-size: 15px; border-radius: 18px; word-wrap: break-word; -webkit-user-select: text; user-select: text; }
    .msg.sent { align-self: flex-end; background: var(--sent-bg); color: white; border-bottom-right-radius: 4px; }
    .msg.recv { align-self: flex-start; background: var(--recv-bg); color: var(--recv-text); border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

    .input-bar { padding: 12px 16px; background: var(--surface); border-top: 1px solid var(--border); display: flex; align-items: flex-end; gap: 8px; }
    textarea { flex: 1; background: var(--bg); border: none; border-radius: 20px; padding: 10px 16px; font-size: 15px; resize: none; max-height: 100px; min-height: 40px; -webkit-user-select: text; user-select: text; }
    .send-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: white; border: none; display: flex; align-items: center; justify-content: center; }

    /* --- FAB & Sheet --- */
    .fab { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background: var(--text-main); color: white; border-radius: 18px; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-float); cursor: pointer; z-index: 30; }
    
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .overlay.active { opacity: 1; pointer-events: auto; }
    .bottom-sheet { position: fixed; left: 0; bottom: 0; width: 100%; background: var(--surface); border-radius: 24px 24px 0 0; transform: translateY(100%); transition: transform 0.3s; z-index: 101; max-height: 85vh; display: flex; flex-direction: column; }
    .bottom-sheet.active { transform: translateY(0); }
    
    .user-card { display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border); }
    
    /* --- Profile View --- */
    .profile-container { padding: 32px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
    .profile-avatar-large { width: 100px; height: 100px; border-radius: 50%; background-color: #e2e8f0; background-size: cover; background-position: center; position: relative; }
    .text-input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border); background: var(--surface); margin-bottom: 10px; -webkit-user-select: text; user-select: text; }
    .btn-primary { width: 100%; padding: 14px; border-radius: 12px; background: var(--primary); color: white; border: none; font-weight: 600; }

  </style>
</head>
<body>

  <div id="loginView" class="view">
    <div style="background:white; padding:32px; border-radius:24px; width:100%; max-width:340px; box-shadow:0 10px 25px rgba(0,0,0,0.1);">
      <div class="brand-logo">Privy.</div>
      <p style="color:var(--text-muted); margin-bottom:24px;">Simple. Secure. Private.</p>
      <button class="btn-primary" onclick="handleLogin()">Sign in with Google</button>
    </div>
  </div>

  <div id="listView" class="view hidden">
    <header>
      <div class="header-title">Chats</div>
      <div class="avatar" id="myAvatar" onclick="openProfile()"></div>
    </header>
    <div class="search-box">
      <span class="material-symbols-rounded" style="color:var(--text-muted)">search</span>
      <input type="text" id="mainSearch" placeholder="Search..." onkeyup="filterChats()">
    </div>
    <div id="chatList"></div>
    <div class="fab" onclick="openBottomSheet()"><span class="material-symbols-rounded">add</span></div>
  </div>

  <div id="chatView" class="view hidden">
    <header>
      <button class="icon-btn" onclick="navBack()"><span class="material-symbols-rounded">arrow_back</span></button>
      <div style="flex:1; margin-left:10px;">
        <div id="roomName" style="font-weight:600">User</div>
        <div id="roomStatus" class="status-text">Offline</div>
      </div>
      <div class="avatar" id="roomAvatar"></div>
    </header>
    <div id="msgList"></div>
    <div class="input-bar">
      <textarea id="msgInput" rows="1" placeholder="Message..."></textarea>
      <button class="send-btn" id="sendBtn"><span class="material-symbols-rounded">send</span></button>
    </div>
  </div>

  <div id="profileView" class="view hidden">
    <header>
      <button class="icon-btn" onclick="navBack()"><span class="material-symbols-rounded">arrow_back</span></button>
      <div class="header-title">Profile</div>
      <div style="width:40px"></div>
    </header>
    <div class="profile-container">
      <div class="profile-avatar-large" id="editAvatar" onclick="document.getElementById('fileInput').click()"></div>
      <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleImageUpload(this)">
      <input type="text" class="text-input" id="editUsername" placeholder="Username">
      <input type="text" class="text-input" id="readOnlyUid" readonly style="opacity:0.6">
      <button class="btn-primary" onclick="saveProfile()">Save Changes</button>
    </div>
  </div>

  <div class="overlay" id="sheetOverlay" onclick="closeBottomSheet()"></div>
  <div class="bottom-sheet" id="bottomSheet">
    <div style="padding:20px; font-weight:700; font-size:18px;">New Chat</div>
    <div class="search-box" style="margin:0 20px 10px;">
       <input type="text" id="userSearch" placeholder="Search all users..." onkeyup="searchUsers()">
    </div>
    <div id="sheetList" style="flex:1; overflow-y:auto; padding-bottom:30px;"></div>
  </div>

  <script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // --- GLOBALS ---
    let currentUser = null;
    let currentChatUid = null;
    let currentRoomId = null;
    let messagesListener = null;
    let statusListener = null;
    let sharedKeys = JSON.parse(localStorage.getItem('sharedKeys') || '{}');
    let allUsersCache = [];
    let tempUploadedImageUrl = null;

    // Default Avatar (SVG Data URI) to prevent "undefined" images
    const DEFAULT_AVATAR = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23cbd5e1'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E";

    // --- CRYPTO ---
    async function generateAndStoreKeyPair() {
      const keyPair = await crypto.subtle.generateKey({ name: "ECDH", namedCurve: "P-256" }, true, ["deriveBits"]);
      const pubJwk = await crypto.subtle.exportKey("jwk", keyPair.publicKey);
      const privJwk = await crypto.subtle.exportKey("jwk", keyPair.privateKey);
      localStorage.setItem('privKey', JSON.stringify(privJwk));
      return pubJwk;
    }

    async function deriveSharedSecret(friendPublicJwk) {
      try {
        const privJwk = JSON.parse(localStorage.getItem('privKey'));
        if (!privJwk) return null;
        const privateKey = await crypto.subtle.importKey("jwk", privJwk, { name: "ECDH", namedCurve: "P-256" }, false, ["deriveBits"]);
        const friendPublicKey = await crypto.subtle.importKey("jwk", friendPublicJwk, { name: "ECDH", namedCurve: "P-256" }, false, []);
        const sharedBits = await crypto.subtle.deriveBits({ name: "ECDH", public: friendPublicKey }, privateKey, 256);
        return Array.from(new Uint8Array(sharedBits)).map(b => b.toString(16).padStart(2,'0')).join('');
      } catch (e) { return null; }
    }

    function encrypt(text, secretHex) {
      if(!secretHex) return text;
      return CryptoJS.AES.encrypt(text, secretHex).toString();
    }
    function decrypt(ciphertext, secretHex) {
      if(!secretHex) return "Waiting for key...";
      try {
        const bytes = CryptoJS.AES.decrypt(ciphertext, secretHex);
        return bytes.toString(CryptoJS.enc.Utf8) || "[Decryption Error]";
      } catch(e) { return "[Locked Message]"; }
    }

    // --- AUTH ---
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        setupPresence(user.uid);
        switchView('listView');

        // Check for Keys
        if (!localStorage.getItem('privKey')) {
          const pubKey = await generateAndStoreKeyPair();
          await db.ref(`users/${user.uid}/profile`).update({
            name: user.displayName, 
            email: user.email, 
            photo: user.photoURL, 
            publicKey: JSON.stringify(pubKey), 
            uid: user.uid, 
            username: user.displayName
          });
        }
        
        // Update Local Avatar
        const pSnap = await db.ref(`users/${user.uid}/profile`).once('value');
        const p = pSnap.val() || {};
        updateMyAvatarUI(p.photo || DEFAULT_AVATAR);
        
        loadChatList();
        fetchAllUsers();
      } else {
        switchView('loginView');
      }
    });

    function handleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(alert);
    }

    function setupPresence(uid) {
      const connectedRef = db.ref('.info/connected');
      const myStatusRef = db.ref(`users/${uid}/status`);
      const myLastSeenRef = db.ref(`users/${uid}/lastSeen`);
      connectedRef.on('value', (snap) => {
        if (snap.val() === true) {
          myStatusRef.onDisconnect().set('offline');
          myLastSeenRef.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
          myStatusRef.set('online');
        }
      });
    }

    // --- CHAT LIST ---
    function loadChatList() {
      const listEl = document.getElementById('chatList');
      db.ref(`users/${currentUser.uid}/chats`).on('value', async (snap) => {
        listEl.innerHTML = '';
        if (!snap.exists()) return;

        const chats = [];
        snap.forEach(c => chats.push({ uid: c.key, ...c.val() }));
        chats.sort((a,b) => b.ts - a.ts);

        for (const chat of chats) {
          // Fetch profile to get name and photo
          const pSnap = await db.ref(`users/${chat.uid}/profile`).once('value');
          let p = pSnap.val();
          
          // --- FIX 1: Handle Missing Profile gracefully ---
          if (!p) {
             p = { name: "Unknown User", photo: DEFAULT_AVATAR, username: "Unknown" };
          }

          // Handle Encryption
          let preview = "Message";
          if (sharedKeys[chat.uid]) {
            preview = decrypt(chat.lastMsg, sharedKeys[chat.uid]);
          } else if (p.publicKey) {
             const secret = await deriveSharedSecret(JSON.parse(p.publicKey));
             if (secret) {
               sharedKeys[chat.uid] = secret;
               localStorage.setItem('sharedKeys', JSON.stringify(sharedKeys));
               preview = decrypt(chat.lastMsg, secret);
             }
          }

          const row = document.createElement('div');
          row.className = 'chat-row';
          row.onclick = () => openChat(chat.uid, p);
          
          // --- FIX 2: Use Default Avatar ---
          const avatarUrl = p.photo || DEFAULT_AVATAR;

          row.innerHTML = `
            <div class="avatar" style="background-image: url('${avatarUrl}')"></div>
            <div class="chat-info">
              <div class="chat-name">${p.username || p.name || 'User'}</div>
              <div class="chat-preview">${preview}</div>
            </div>
            ${chat.unreadCount ? `<div style="background:var(--primary); color:white; font-size:10px; padding:2px 6px; border-radius:10px;">${chat.unreadCount}</div>` : ''}
          `;
          listEl.appendChild(row);
        }
      });
    }

    // --- OPEN CHAT (The Fix for Undefined Names) ---
    async function openChat(friendUid, profileData = null) {
      currentChatUid = friendUid;
      // Ensure Room ID is consistent regardless of who clicked
      currentRoomId = [currentUser.uid, friendUid].sort().join('_');
      
      switchView('chatView');

      // --- FIX 3: Fetch profile if not provided (fixes "User" name) ---
      let p = profileData;
      if (!p) {
         document.getElementById('roomName').innerText = "Loading...";
         const snap = await db.ref(`users/${friendUid}/profile`).once('value');
         p = snap.val();
      }

      // Update Header UI
      const safeName = p ? (p.username || p.name || "User") : "User";
      const safePhoto = (p && p.photo) ? p.photo : DEFAULT_AVATAR;

      document.getElementById('roomName').innerText = safeName;
      document.getElementById('roomAvatar').style.backgroundImage = `url('${safePhoto}')`;

      // Handle Keys
      if (p && p.publicKey && !sharedKeys[friendUid]) {
          const secret = await deriveSharedSecret(JSON.parse(p.publicKey));
          if(secret) {
              sharedKeys[friendUid] = secret;
              localStorage.setItem('sharedKeys', JSON.stringify(sharedKeys));
          }
      }

      // Presence
      if(statusListener) statusListener.off();
      statusListener = db.ref(`users/${friendUid}`).on('value', (snap) => {
          const u = snap.val();
          const st = document.getElementById('roomStatus');
          if(u && u.status === 'online') {
            st.innerText = "Online";
            st.classList.add('online');
          } else {
            st.innerText = "Offline";
            st.classList.remove('online');
          }
      });

      // Clear unread
      db.ref(`users/${currentUser.uid}/chats/${friendUid}`).update({ unreadCount: 0 });
      loadMessages();
    }

    // --- MESSAGING ---
    function loadMessages() {
      const list = document.getElementById('msgList');
      list.innerHTML = '';
      if(messagesListener) messagesListener.off();

      messagesListener = db.ref(`messages/${currentRoomId}`).limitToLast(50);
      messagesListener.on('child_added', (snap) => {
        const data = snap.val();
        const isMe = data.sender === currentUser.uid;
        const text = decrypt(data.text, sharedKeys[currentChatUid]);
        
        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'sent' : 'recv'}`;
        div.innerText = text;
        list.appendChild(div);
        list.scrollTop = list.scrollHeight;
      });
    }

    async function sendMessage() {
      const input = document.getElementById('msgInput');
      const text = input.value.trim();
      if (!text || !currentChatUid) return;

      const secret = sharedKeys[currentChatUid];
      if (!secret) return alert("Security Handshake failed. Try refreshing.");

      const encrypted = encrypt(text, secret);
      const ts = Date.now();
      input.value = '';
      input.style.height = 'auto'; // reset height

      // 1. Push Message
      await db.ref(`messages/${currentRoomId}`).push({ text: encrypted, sender: currentUser.uid, ts });

      // 2. Update Chat Lists for Both Users
      const updates = {};
      // My list
      updates[`users/${currentUser.uid}/chats/${currentChatUid}/lastMsg`] = encrypted;
      updates[`users/${currentUser.uid}/chats/${currentChatUid}/ts`] = ts;
      // Their list
      updates[`users/${currentChatUid}/chats/${currentUser.uid}/lastMsg`] = encrypted;
      updates[`users/${currentChatUid}/chats/${currentUser.uid}/ts`] = ts;

      await db.ref().update(updates);
      
      // Increment unread for them
      db.ref(`users/${currentChatUid}/chats/${currentUser.uid}/unreadCount`).transaction(c => (c||0)+1);
    }
    document.getElementById('sendBtn').onclick = sendMessage;

    // --- SEARCH USERS ---
    async function fetchAllUsers() {
      const snap = await db.ref('users').once('value');
      allUsersCache = [];
      snap.forEach(child => {
          const val = child.val();
          if (val.profile && val.profile.uid !== currentUser.uid) {
              allUsersCache.push(val.profile);
          }
      });
    }

    function searchUsers() {
      const term = document.getElementById('userSearch').value.toLowerCase();
      const sheetList = document.getElementById('sheetList');
      sheetList.innerHTML = '';

      const filtered = allUsersCache.filter(u => 
        (u.username || u.name || '').toLowerCase().includes(term) || 
        (u.email || '').toLowerCase().includes(term)
      );

      filtered.forEach(u => {
        const div = document.createElement('div');
        div.className = 'user-card';
        // --- FIX 4: Instant Click to Chat ---
        div.onclick = () => {
          closeBottomSheet();
          openChat(u.uid, u); // Pass the profile data directly
        };
        const photo = u.photo || DEFAULT_AVATAR;
        div.innerHTML = `
          <div class="avatar" style="background-image:url('${photo}')"></div>
          <div>
            <div style="font-weight:600">${u.username || u.name}</div>
            <div style="font-size:12px; color:var(--text-muted)">${u.email}</div>
          </div>
        `;
        sheetList.appendChild(div);
      });
      
      if(filtered.length === 0) sheetList.innerHTML = '<div style="padding:20px; text-align:center; color:#999">No users found</div>';
    }

    // --- PROFILE ---
    function updateMyAvatarUI(url) {
      document.getElementById('myAvatar').style.backgroundImage = `url('${url}')`;
      document.getElementById('editAvatar').style.backgroundImage = `url('${url}')`;
    }

    async function openProfile() {
      switchView('profileView');
      const snap = await db.ref(`users/${currentUser.uid}/profile`).once('value');
      const p = snap.val() || {};
      document.getElementById('editUsername').value = p.username || p.name || '';
      document.getElementById('readOnlyUid').value = currentUser.uid;
      tempUploadedImageUrl = null;
    }

    async function handleImageUpload(input) {
       if (!input.files[0]) return;
       // For demo purposes, we will just simulate a success or you need your Cloudinary logic here.
       // Since the prompt focused on UI logic, I will alert usage.
       alert("To upload real images, uncomment the Cloudinary code in previous versions. For now, this is a placeholder.");
    }

    async function saveProfile() {
      const name = document.getElementById('editUsername').value;
      if(!name) return alert("Username required");
      await db.ref(`users/${currentUser.uid}/profile`).update({ username: name, name: name });
      alert("Saved");
      navBack();
    }

    // --- UTILS ---
    function switchView(id) {
      document.querySelectorAll('.view').forEach(e => { e.classList.add('hidden'); e.classList.remove('active'); });
      document.getElementById(id).classList.remove('hidden');
      document.getElementById(id).classList.add('active');
    }
    function navBack() { 
      switchView('listView'); 
      currentChatUid = null;
      if(messagesListener) messagesListener.off();
      if(statusListener) statusListener.off();
    }
    function openBottomSheet() { 
       document.getElementById('sheetOverlay').classList.add('active');
       document.getElementById('bottomSheet').classList.add('active');
       searchUsers(); // Populate list
    }
    function closeBottomSheet() {
       document.getElementById('sheetOverlay').classList.remove('active');
       document.getElementById('bottomSheet').classList.remove('active');
    }
    // Auto-resize textarea
    document.getElementById('msgInput').addEventListener('input', function(){
      this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px';
    });
  </script>
</body>
</html>
