<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Privy â€¢ Secure Chat</title>
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg: #0f1115;
      --surface: #181b21;
      --surface-hover: #22262e;
      --border: #2a2f38;
      --primary: #3b82f6;
      --primary-dim: rgba(59, 130, 246, 0.15);
      --text-main: #edf2f7;
      --text-muted: #94a3b8;
      --sent-bg: #3b82f6;
      --recv-bg: #2d3748;
      --danger: #ef4444;
      --success: #10b981;
      --radius: 16px;
      --header-h: 60px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text-main);
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* --- Views & Transitions --- */
    .view {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      z-index: 10;
    }

    .view.hidden { transform: translateX(100%); z-index: 5; pointer-events: none; }
    .view.active { transform: translateX(0); z-index: 10; pointer-events: auto; }
    
    /* Login View special case */
    #loginView { z-index: 50; justify-content: center; align-items: center; padding: 24px; text-align: center; }
    #loginView.hidden { display: none; }

    /* --- Components --- */
    header {
      height: var(--header-h);
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      background: rgba(15, 17, 21, 0.9);
      backdrop-filter: blur(10px);
      z-index: 20;
    }

    .icon-btn {
      background: none; border: none; color: var(--text-main);
      padding: 8px; border-radius: 50%; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .icon-btn:active { background: var(--surface-hover); }

    .avatar {
      width: 42px; height: 42px; border-radius: 50%;
      background: var(--surface-hover);
      background-size: cover; background-position: center;
      flex-shrink: 0;
    }

    /* --- List View --- */
    #chatList { flex: 1; overflow-y: auto; padding-top: 8px; }
    
    .chat-row {
      display: flex; align-items: center; gap: 14px;
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid transparent;
    }
    .chat-row:active { background: var(--surface-hover); }

    .chat-content { flex: 1; min-width: 0; }
    .chat-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
    .chat-preview { font-size: 14px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-meta { font-size: 12px; color: var(--text-muted); text-align: right; }
    .badge { 
      background: var(--primary); color: white; 
      font-size: 10px; font-weight: 700; 
      padding: 2px 6px; border-radius: 10px; 
      margin-top: 4px; display: inline-block;
    }

    /* --- Chat Room --- */
    #msgList {
      flex: 1; overflow-y: auto; padding: 16px;
      display: flex; flex-direction: column; gap: 4px;
    }

    .msg {
      max-width: 75%; padding: 10px 14px;
      font-size: 15px; line-height: 1.4;
      position: relative; word-wrap: break-word;
      animation: popIn 0.2s ease-out;
    }

    @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; }}

    .msg.sent {
      align-self: flex-end;
      background: var(--sent-bg); color: white;
      border-radius: 18px 18px 2px 18px;
    }

    .msg.recv {
      align-self: flex-start;
      background: var(--recv-bg); color: var(--text-main);
      border-radius: 18px 18px 18px 2px;
    }

    .msg-time {
      font-size: 10px; margin-top: 4px; opacity: 0.7;
      text-align: right; display: flex; align-items: center; justify-content: flex-end; gap: 4px;
    }

    /* --- Input Area --- */
    .input-bar {
      padding: 12px 16px;
      background: var(--surface);
      display: flex; align-items: flex-end; gap: 10px;
      border-top: 1px solid var(--border);
    }

    textarea {
      flex: 1; background: #0f1115; color: var(--text-main);
      border: 1px solid var(--border);
      border-radius: 20px; padding: 10px 16px;
      font-family: inherit; font-size: 15px;
      resize: none; max-height: 120px; min-height: 42px;
    }
    textarea:focus { outline: none; border-color: var(--primary); }

    .send-btn {
      width: 42px; height: 42px; border-radius: 50%;
      background: var(--primary); color: white; border: none;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; flex-shrink: 0;
    }

    /* --- Floating Action Button --- */
    .fab {
      position: fixed; bottom: 24px; right: 24px;
      width: 56px; height: 56px;
      background: var(--primary); color: white;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 14px rgba(0,0,0,0.4);
      cursor: pointer; z-index: 30;
      transition: transform 0.2s;
    }
    .fab:active { transform: scale(0.95); }

    /* --- Modals --- */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
      z-index: 100; display: none;
      align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--surface); width: 90%; max-width: 320px;
      padding: 24px; border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    h2 { font-size: 18px; margin-bottom: 16px; }
    
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
    .form-input { 
      width: 100%; background: var(--bg); border: 1px solid var(--border);
      color: white; padding: 12px; border-radius: 8px; font-size: 14px;
    }
    
    .btn {
      width: 100%; padding: 12px; border-radius: 8px;
      border: none; font-weight: 600; cursor: pointer;
      font-size: 14px; transition: opacity 0.2s;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: transparent; color: var(--text-muted); margin-top: 8px; }

    /* --- Login UI --- */
    .login-card {
      width: 100%; max-width: 340px;
    }
    .logo-area { font-size: 32px; font-weight: 800; color: var(--primary); margin-bottom: 8px; }
    .sub-text { color: var(--text-muted); margin-bottom: 32px; }

    /* --- Toast --- */
    #toast {
      position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
      background: #333; color: white; padding: 10px 20px;
      border-radius: 30px; font-size: 13px; pointer-events: none;
      opacity: 0; transition: opacity 0.3s; z-index: 200;
    }
  </style>
</head>
<body>

  <div id="loginView" class="view">
    <div class="login-card">
      <div class="logo-area">Privy.</div>
      <div class="sub-text">End-to-end encrypted messaging.<br>Secure. Private. Simple.</div>
      <button class="btn btn-primary" onclick="handleLogin()">Sign in with Google</button>
      <div style="margin-top:12px; font-size:11px; color:#555">
        Ensure Google Auth is enabled in your Firebase Console.
      </div>
    </div>
  </div>

  <div id="listView" class="view hidden">
    <header>
      <div style="font-weight:700; font-size:20px;">Chats</div>
      <div style="display:flex; gap:12px">
         <div class="avatar" id="myAvatar" onclick="copyMyId()"></div>
      </div>
    </header>

    <div id="chatList"></div>
    
    <div class="fab" onclick="showNewChatModal()">
      <span class="material-symbols-rounded">add</span>
    </div>
  </div>

  <div id="chatView" class="view hidden">
    <header>
      <button class="icon-btn" onclick="navBack()">
        <span class="material-symbols-rounded">arrow_back</span>
      </button>
      <div style="display:flex; align-items:center; gap:10px; flex:1; margin-left:8px">
        <div class="avatar" id="roomAvatar" style="width:36px; height:36px;"></div>
        <div>
          <div class="chat-name" id="roomName" style="font-size:15px; margin:0;">User</div>
          <div style="font-size:11px; color:var(--success);" id="roomStatus">Encrypted</div>
        </div>
      </div>
    </header>

    <div id="msgList"></div>

    <div class="input-bar">
      <textarea id="msgInput" rows="1" placeholder="Type a secure message..."></textarea>
      <button class="send-btn" id="sendBtn">
        <span class="material-symbols-rounded">send</span>
      </button>
    </div>
  </div>

  <div id="newChatModal" class="modal-overlay">
    <div class="modal">
      <h2>Start New Chat</h2>
      <div class="form-group">
        <label>Enter User Email or UID</label>
        <input type="text" class="form-input" id="searchUserVal" placeholder="friend@example.com">
      </div>
      <button class="btn btn-primary" onclick="startChat()">Start Chatting</button>
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    // Initialize
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // --- STATE ---
    let currentUser = null;
    let currentChatUid = null;
    let currentRoomId = null;
    let messagesListener = null;
    let sharedKeys = JSON.parse(localStorage.getItem('sharedKeys') || '{}');

    // --- ENCRYPTION ENGINE (Web Crypto API + AES) ---
    async function generateAndStoreKeyPair() {
      // 1. Generate ECDH Key Pair
      const keyPair = await crypto.subtle.generateKey(
        { name: "ECDH", namedCurve: "P-256" }, 
        true, 
        ["deriveBits"]
      );
      
      // 2. Export Keys
      const pubJwk = await crypto.subtle.exportKey("jwk", keyPair.publicKey);
      const privJwk = await crypto.subtle.exportKey("jwk", keyPair.privateKey);

      // 3. Save Private Key Locally
      localStorage.setItem('privKey', JSON.stringify(privJwk));

      // 4. Return Public Key for Upload
      return pubJwk;
    }

    async function deriveSharedSecret(friendPublicJwk) {
      try {
        const privJwk = JSON.parse(localStorage.getItem('privKey'));
        if (!privJwk) throw new Error("No private key found");

        const privateKey = await crypto.subtle.importKey(
          "jwk", privJwk, { name: "ECDH", namedCurve: "P-256" }, false, ["deriveBits"]
        );
        const friendPublicKey = await crypto.subtle.importKey(
          "jwk", friendPublicJwk, { name: "ECDH", namedCurve: "P-256" }, false, []
        );

        const sharedBits = await crypto.subtle.deriveBits(
          { name: "ECDH", public: friendPublicKey }, privateKey, 256
        );

        // Convert to hex string for easy storage
        return Array.from(new Uint8Array(sharedBits))
          .map(b => b.toString(16).padStart(2,'0')).join('');
      } catch (e) {
        console.error("Key derivation failed", e);
        return null;
      }
    }

    // AES Helpers (using CryptoJS for simple string encryption with the derived secret)
    function encrypt(text, secretHex) {
      if(!secretHex) return text; 
      return CryptoJS.AES.encrypt(text, secretHex).toString();
    }

    function decrypt(ciphertext, secretHex) {
      if(!secretHex) return "Waiting for key...";
      try {
        const bytes = CryptoJS.AES.decrypt(ciphertext, secretHex);
        const original = bytes.toString(CryptoJS.enc.Utf8);
        return original || "[Decryption Error]";
      } catch(e) {
        return "[Locked Message]";
      }
    }

    // --- AUTHENTICATION FLOW ---
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        showToast(`Welcome, ${user.displayName || 'User'}`);
        switchView('listView');
        
        // Setup Avatar
        document.getElementById('myAvatar').style.backgroundImage = `url(${user.photoURL || 'https://i.pravatar.cc/150?u='+user.uid})`;

        // Ensure Keys Exist
        await setupUserProfile(user);
        loadChatList();
      } else {
        switchView('loginView');
      }
    });

    function handleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(e => {
        alert("Login failed: " + e.message);
      });
    }

    async function setupUserProfile(user) {
      // Check if we have a private key locally. If not, generate new pair.
      if (!localStorage.getItem('privKey')) {
        const pubKey = await generateAndStoreKeyPair();
        // Upload Public Key & Info to DB
        await db.ref(`users/${user.uid}/profile`).update({
          name: user.displayName || "Anonymous",
          email: user.email, // store email to allow searching
          photo: user.photoURL,
          publicKey: JSON.stringify(pubKey), // CRITICAL
          uid: user.uid
        });
      } else {
        // Just update basic info (keep existing key)
        await db.ref(`users/${user.uid}/profile`).update({
          name: user.displayName,
          email: user.email,
          photo: user.photoURL
        });
      }
    }

    // --- CHAT LIST LOGIC ---
    function loadChatList() {
      const listEl = document.getElementById('chatList');
      
      db.ref(`users/${currentUser.uid}/chats`).on('value', async (snap) => {
        listEl.innerHTML = '';
        if (!snap.exists()) {
          listEl.innerHTML = '<div style="padding:40px; text-align:center; color:#555">No chats yet.<br>Tap + to start.</div>';
          return;
        }

        const chats = [];
        snap.forEach(c => chats.push({ uid: c.key, ...c.val() }));
        chats.sort((a,b) => b.ts - a.ts);

        for (const chat of chats) {
          // Fetch friend profile for name/photo
          const pSnap = await db.ref(`users/${chat.uid}/profile`).once('value');
          const p = pSnap.val() || {};
          
          // Decrypt Preview
          let preview = "Encrypted message";
          if (sharedKeys[chat.uid]) {
            preview = decrypt(chat.lastMsg, sharedKeys[chat.uid]);
          } else {
            // Try to derive key lazily
            if (p.publicKey) {
               const secret = await deriveSharedSecret(JSON.parse(p.publicKey));
               if (secret) {
                 sharedKeys[chat.uid] = secret;
                 localStorage.setItem('sharedKeys', JSON.stringify(sharedKeys));
                 preview = decrypt(chat.lastMsg, secret);
               }
            }
          }

          const el = document.createElement('div');
          el.className = 'chat-row';
          el.onclick = () => openChat(chat.uid, p);
          el.innerHTML = `
            <div class="avatar" style="background-image: url(${p.photo || 'https://i.pravatar.cc/100'})"></div>
            <div class="chat-content">
              <div class="chat-name">${p.name || 'Unknown'}</div>
              <div class="chat-preview">${preview}</div>
            </div>
            <div class="chat-meta">
              <div>${formatTime(chat.ts)}</div>
              ${chat.unreadCount ? `<div class="badge">${chat.unreadCount}</div>` : ''}
            </div>
          `;
          listEl.appendChild(el);
        }
      });
    }

    // --- CHAT ROOM LOGIC ---
    async function openChat(friendUid, profile) {
      currentChatUid = friendUid;
      // Consistent room ID: sort UIDs so both users look at same path
      currentRoomId = [currentUser.uid, friendUid].sort().join('_');

      // Update UI
      document.getElementById('roomName').innerText = profile.name || "Chat";
      document.getElementById('roomAvatar').style.backgroundImage = `url(${profile.photo || 'https://i.pravatar.cc/100'})`;
      switchView('chatView');

      // Ensure we have encryption key
      if (!sharedKeys[friendUid]) {
        if (profile.publicKey) {
          const secret = await deriveSharedSecret(JSON.parse(profile.publicKey));
          sharedKeys[friendUid] = secret;
          localStorage.setItem('sharedKeys', JSON.stringify(sharedKeys));
        } else {
          showToast("Warning: User has no public key");
        }
      }

      // Reset unread count
      db.ref(`users/${currentUser.uid}/chats/${friendUid}`).update({ unreadCount: 0 });

      loadMessages();
    }

    function loadMessages() {
      const msgList = document.getElementById('msgList');
      msgList.innerHTML = ''; // Clear old

      if(messagesListener) messagesListener.off();

      messagesListener = db.ref(`messages/${currentRoomId}`).limitToLast(50);
      messagesListener.on('child_added', (snap) => {
        const data = snap.val();
        const isMe = data.sender === currentUser.uid;
        
        // Decrypt
        const text = (isMe || !sharedKeys[currentChatUid]) 
          ? decrypt(data.text, sharedKeys[currentChatUid]) // Try decrypting own msg too just to verify key works
          : decrypt(data.text, sharedKeys[currentChatUid]);

        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'sent' : 'recv'}`;
        div.innerHTML = `
          ${text}
          <div class="msg-time">
            ${new Date(data.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
            ${isMe ? '<span class="material-symbols-rounded" style="font-size:12px">done_all</span>' : ''}
          </div>
        `;
        msgList.appendChild(div);
        msgList.scrollTop = msgList.scrollHeight;
      });
    }

    // --- SEND MESSAGE ---
    document.getElementById('sendBtn').onclick = sendMessage;
    
    async function sendMessage() {
      const input = document.getElementById('msgInput');
      const text = input.value.trim();
      if (!text || !currentChatUid) return;

      const secret = sharedKeys[currentChatUid];
      if (!secret) {
        showToast("Error: Encryption handshake missing");
        return;
      }

      const encrypted = encrypt(text, secret);
      const ts = Date.now();

      input.value = '';
      
      // 1. Push Message
      await db.ref(`messages/${currentRoomId}`).push({
        text: encrypted,
        sender: currentUser.uid,
        ts: ts
      });

      // 2. Update Chat Lists for Both Users
      const updatePayload = {
        [`users/${currentUser.uid}/chats/${currentChatUid}/lastMsg`]: encrypted,
        [`users/${currentUser.uid}/chats/${currentChatUid}/ts`]: ts,
        [`users/${currentChatUid}/chats/${currentUser.uid}/lastMsg`]: encrypted,
        [`users/${currentChatUid}/chats/${currentUser.uid}/ts`]: ts
      };
      
      await db.ref().update(updatePayload);
      
      // Increment friend's unread badge (transaction safe)
      db.ref(`users/${currentChatUid}/chats/${currentUser.uid}/unreadCount`)
        .transaction(count => (count || 0) + 1);
    }

    // --- SEARCH / START CHAT ---
    async function startChat() {
      const query = document.getElementById('searchUserVal').value.trim();
      if (!query) return;

      showToast("Searching...");
      
      // Try to find user by Email or UID
      // Note: Realtime DB doesn't have native "WHERE email =" query without an index.
      // For this demo, we scan `users` (efficient only for small apps).
      // In production, index by email.
      
      try {
        const snap = await db.ref('users').once('value');
        let foundUid = null;
        let foundProfile = null;

        snap.forEach(child => {
          const p = child.val().profile || {};
          if (p.email === query || p.uid === query) {
            foundUid = child.key;
            foundProfile = p;
          }
        });

        if (foundUid) {
          if (foundUid === currentUser.uid) {
            showToast("You cannot chat with yourself");
            return;
          }
          closeModal();
          openChat(foundUid, foundProfile);
        } else {
          showToast("User not found");
        }
      } catch(e) {
        showToast("Search failed");
      }
    }

    // --- UI HELPERS ---
    function switchView(id) {
      document.querySelectorAll('.view').forEach(el => {
        el.classList.add('hidden');
        el.classList.remove('active');
      });
      const target = document.getElementById(id);
      target.classList.remove('hidden');
      target.classList.add('active');
    }

    function navBack() {
      switchView('listView');
      currentChatUid = null;
      if(messagesListener) messagesListener.off();
    }

    function showNewChatModal() { document.getElementById('newChatModal').classList.add('active'); }
    function closeModal() { document.getElementById('newChatModal').classList.remove('active'); }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.opacity = '1';
      setTimeout(() => t.style.opacity = '0', 3000);
    }

    function formatTime(ts) {
      const d = new Date(ts);
      if (Date.now() - ts < 86400000) return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      return d.toLocaleDateString();
    }
    
    function copyMyId() {
       navigator.clipboard.writeText(currentUser.uid);
       showToast("User ID Copied to Clipboard");
    }

    // Auto-resize textarea
    const tx = document.getElementById('msgInput');
    tx.addEventListener("input", function(){
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + "px";
    });
  </script>
</body>
</html>
