<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vynix</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --accent-purple: #d946ef;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --bg-color: #f8f9fa;
            --glass-white: rgba(255, 255, 255, 0.95);
            --logo-gradient: linear-gradient(135deg, #000000 0%, var(--accent-purple) 50%, #10b981 100%);
            --online-green: #10b981;
        }
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            box-sizing: border-box;
            outline: none;
        }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-primary); overflow-x: hidden; }
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmerEffect 1.5s infinite linear;
        }
        @keyframes shimmerEffect { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        header {
            position: fixed; top: 0; left: 0; right: 0; height: 75px; background: var(--glass-white);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000; backdrop-filter: blur(12px); border-bottom: 1px solid #eee;
        }
        .user-profile {
            width: 42px; height: 42px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--accent-purple); cursor: pointer;
        }
        .app-title { font-size: 24px; font-weight: 800; background: var(--logo-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1.2px; }
        .pill-nav {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            background: #000; width: 240px; height: 64px; border-radius: 40px;
            display: flex; align-items: center; justify-content: space-around;
            padding: 0 10px; z-index: 2000; box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }
        .nav-item { color: #666; display: flex; flex-direction: column; align-items: center; transition: 0.3s; cursor: pointer; }
        .nav-item.active { color: #fff; }
        .nav-item span { font-size: 26px; }
        main { padding: 90px 16px 120px 16px; min-height: 100vh; }
        #statusTab { display: none; }
        .chat-card {
            display: flex; align-items: center; padding: 15px;
            background: #fff; margin-bottom: 12px; border-radius: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
        }
        .avatar-box {
            margin-right: 15px;
            flex-shrink: 0;
            position: relative;
        }
        .avatar { width: 58px; height: 58px; border-radius: 18px; object-fit: cover; }
        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: var(--online-green);
            border: 2.5px solid #fff;
            border-radius: 50%;
            z-index: 1;
        }
        .chat-info { flex: 1; overflow: hidden; padding-right: 50px; }
        .chat-name { font-weight: 700; font-size: 15px; display: block; color: #111; }
        .chat-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; margin-top: 2px; }
        .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .status-card {
            position: relative; height: 280px; border-radius: 30px; overflow: hidden;
            background: #eee; cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .status-card:active { transform: scale(0.95); }
        .status-card img, .status-card video { width: 100%; height: 100%; object-fit: cover; }
        .status-info {
            position: absolute; bottom: 0; width: 100%; padding: 15px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: #fff; font-size: 13px;
        }
        .status-online-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            background: var(--online-green);
            border: 2px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.6);
        }
        #storyViewer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; display: none;
        }
        .story-header {
            position: absolute; top: 44px; left: 16px; display: flex; align-items: center; z-index: 20; color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .story-progress {
            position: absolute; top: 8px; left: 8px; right: 8px; display: flex; gap: 3px; z-index: 10;
        }
        .progress-segment {
            height: 3px; background: rgba(255,255,255,0.4); flex: 1; border-radius: 2px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: #fff; width: 0%; transition: width linear;
        }
        #storyMedia {
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative;
        }
        #storyMedia img, #storyMedia video {
            width: 100%; height: 100%; object-fit: cover;
        }
        .story-sound-btn, .story-delete {
            position: absolute; background: rgba(0,0,0,0.6); color: #fff;
            width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 28px; z-index: 30; cursor: pointer;
        }
        .story-sound-btn { bottom: 100px; right: 20px; }
        .story-delete { top: 80px; right: 20px; }

        /* ── Story Reply Bar ──────────────────────────────────────── */
        .story-reply-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.42);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 40;
            transition: bottom 0.35s ease-out;
        }
        .story-reply-bar.keyboard-visible {
            bottom: env(keyboard-inset-height, 0px);
            padding-bottom: calc(12px + env(keyboard-inset-height, 0px));
        }
        .reply-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.16);
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.28);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .story-reply-input {
            flex: 1;
            min-width: 0;
            padding: 13px 18px;
            background: transparent;
            border: none;
            color: #ffffff;
            font-size: 15px;
            font-family: 'Poppins', sans-serif;
        }
        .story-reply-input::placeholder {
            color: rgba(255, 255, 255, 0.65);
        }
        .story-reply-input:focus {
            outline: none;
        }
        .reply-send-btn {
            font-size: 26px;
            color: #ffffff;
            padding: 0 16px 0 8px;
            cursor: pointer;
            opacity: 0.85;
            transition: opacity 0.18s, transform 0.14s;
        }
        .reply-send-btn:active {
            opacity: 1;
            transform: scale(1.08);
        }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; z-index: 2500; backdrop-filter: blur(8px); }
        .bottom-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: #fff; border-radius: 35px 35px 0 0; padding: 35px 25px; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2600; max-height: 80vh; overflow-y: auto; }
        .bottom-sheet.active { bottom: 0; }
        .v-input { width: 100%; padding: 18px; border: 2px solid #f3f4f6; border-radius: 20px; margin-bottom: 15px; font-family: inherit; font-size: 15px; }
        .btn-primary { width: 100%; background: #000; color: #fff; border: none; padding: 18px; border-radius: 20px; font-weight: 700; cursor: pointer; font-size: 15px; }
        .btn-danger { background: #ff3b30 !important; }
        .btn-secondary { background: #f1f1f1 !important; color: #000 !important; }
        #toast { position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%); background: #111; color: #fff; padding: 12px 25px; border-radius: 50px; font-size: 13px; z-index: 6000; display: none; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <header>
        <div onclick="openSheet('settingsSheet')">
            <img id="myAvatar" class="user-profile shimmer" src="">
        </div>
        <div class="app-title">Vynix</div>
        <span class="material-symbols-rounded" style="color:#000; font-size:28px;" onclick="openSheet('addFriendSheet')">add_circle</span>
    </header>

    <main id="chatsTab">
        <div id="chatList">
            <!-- Chat cards will be rendered here -->
        </div>
    </main>

    <main id="statusTab">
        <div class="btn-primary" onclick="document.getElementById('fileUpload').click()" style="margin-bottom:20px; background:var(--accent-purple);">
            <span class="material-symbols-rounded" style="vertical-align:middle; margin-right:8px;">add_photo_alternate</span> Post a Moment
        </div>
        <div class="status-grid" id="statusGrid"></div>
    </main>

    <input type="file" id="fileUpload" hidden accept="image/*,video/*" onchange="validateAndUpload(this.files[0])">

    <!-- ── Story Viewer ──────────────────────────────────────────────── -->
    <div id="storyViewer" onclick="handleStoryTap(event)">
        <div class="story-progress" id="storyProgressBars"></div>
        <div class="story-header" id="storyHeaderInfo"></div>
        <div id="storyMedia"></div>

        <div id="storySoundBtn" class="story-sound-btn" onclick="toggleStorySound(event)">
            <span class="material-symbols-rounded" id="soundIcon">volume_off</span>
        </div>
        <div id="storyDeleteBtn" class="story-delete" style="display:none;" onclick="deleteCurrentStory()">delete</div>

        <!-- Reply bar -->
        <div class="story-reply-bar" id="storyReplyBar">
            <div class="reply-input-wrapper">
                <input 
                    type="text" 
                    id="storyReplyInput" 
                    class="story-reply-input" 
                    placeholder="Send message..." 
                    autocomplete="off"
                />
                <span class="material-symbols-rounded reply-send-btn" id="storySendReply">send</span>
            </div>
        </div>
    </div>

    <div class="pill-nav">
        <div class="nav-item active" id="navChats" onclick="switchTab('chats')">
            <span class="material-symbols-rounded">chat_bubble</span>
        </div>
        <div class="nav-item" id="navStatus" onclick="switchTab('status')">
            <span class="material-symbols-rounded">explore</span>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="closeAll()"></div>

    <div class="bottom-sheet" id="addFriendSheet">
        <h2>Add Friend</h2>
        <input type="text" id="friendVynixId" class="v-input" placeholder="e.g. vnx_789">
        <button class="btn-primary" onclick="addFriendLogic()">Add</button>
    </div>

    <div class="bottom-sheet" id="settingsSheet">
        <h2>Settings</h2>
        <img id="settingsAvatar" class="user-profile" src="" onclick="document.getElementById('profilePicUpload').click()">
        <input type="text" id="editDisplayName" class="v-input" placeholder="Display Name">
        <button class="btn-primary" onclick="updateProfile()">Save</button>
    </div>

    <input type="file" id="profilePicUpload" hidden accept="image/*" onchange="uploadProfilePicture(this.files[0])">

    <script>
        // ────────────────────────────────────────────────
        //   Firebase & Cloudinary Config (your original)
        // ────────────────────────────────────────────────
        const CLOUD_NAME = "dqkujefxj";
        const UPLOAD_PRESET = "banter_box";
        const secretBase = "Vynix_E2EE_Core_";

        const firebaseConfig = {
            apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
            authDomain: "fire-b-a8878.firebaseapp.com",
            databaseURL: "https://fire-b-a8878.firebaseio.com",
            projectId: "fire-b-a8878",
            storageBucket: "fire-b-a8878.firebasestorage.app",
            messagingSenderId: "658673187627",
            appId: "1:658673187627:web:6e4c29af661785f0afa36e"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let myVId = "";
        let myProfile = { name: "", photo: "" };
        let storyQueue = [];
        let storyIndex = 0;
        let storyTimer;
        let currentStoryVideo = null;
        let currentStoryKey = null;
        let storyMuted = true;
        let currentStoryReplyTargetUid = null;

        // Story reply elements
        let storyReplyInput = null;
        let storySendReplyBtn = null;

        // ────────────────────────────────────────────────
        //   Story Viewer Functions
        // ────────────────────────────────────────────────

        function openStories(uid) {
            currentStoryReplyTargetUid = uid;

            db.ref(`moments/${uid}`).once('value', snap => {
                storyQueue = [];
                const now = Date.now();
                snap.forEach(s => {
                    const val = s.val();
                    val.key = s.key;
                    if (now - val.ts < 86400000) storyQueue.push(val);
                });
                storyIndex = 0;
                document.getElementById('storyViewer').style.display = 'block';
                showStory();

                const replyBar = document.getElementById('storyReplyBar');
                if (replyBar) {
                    replyBar.style.display = (uid === currentUser?.uid) ? 'none' : 'block';
                }
            });
        }

        function showStory() {
            clearTimeout(storyTimer);
            if (currentStoryVideo) {
                currentStoryVideo.pause();
                currentStoryVideo = null;
            }
            if (storyIndex >= storyQueue.length || storyIndex < 0) return closeStoryViewer();

            const story = storyQueue[storyIndex];
            currentStoryKey = story.key;

            const media = document.getElementById('storyMedia');
            const progress = document.getElementById('storyProgressBars');
            const header = document.getElementById('storyHeaderInfo');
            const soundBtn = document.getElementById('storySoundBtn');
            const deleteBtn = document.getElementById('storyDeleteBtn');

            header.innerHTML = `<b>${story.name || "User"}</b>`;
            if (story.type === 'video') {
                media.innerHTML = `<video src="${story.url}" autoplay playsinline id="currentStoryVideo"></video>`;
                currentStoryVideo = document.getElementById('currentStoryVideo');
                currentStoryVideo.muted = storyMuted;
                soundBtn.style.display = 'flex';
                document.getElementById('soundIcon').textContent = storyMuted ? 'volume_off' : 'volume_up';
            } else {
                media.innerHTML = `<img src="${story.url}">`;
                soundBtn.style.display = 'none';
            }

            deleteBtn.style.display = (story.uid === currentUser?.uid) ? 'flex' : 'none';

            progress.innerHTML = storyQueue.map((_, i) => `
                <div class="progress-segment">
                    <div class="progress-fill" style="width: ${i < storyIndex ? '100%' : '0%'}"></div>
                </div>
            `).join('');

            setTimeout(() => {
                const bar = progress.querySelectorAll('.progress-fill')[storyIndex];
                const duration = story.type === 'video' ? (story.duration || 60) * 1000 : 5000;
                bar.style.transition = `width ${duration}ms linear`;
                bar.style.width = '100%';
            }, 50);

            storyTimer = setTimeout(() => { storyIndex++; showStory(); }, duration);

            // Reset reply input
            if (storyReplyInput) {
                storyReplyInput.value = '';
                storyReplyInput.blur();
            }
        }

        function handleStoryTap(e) {
            if (e.target.closest('.story-sound-btn') || e.target.closest('.story-delete') || e.target.closest('.story-reply-bar')) return;

            const screenWidth = window.innerWidth;
            if (e.clientX < screenWidth / 3) {
                storyIndex--;
            } else {
                storyIndex++;
            }
            showStory();
        }

        function closeStoryViewer() {
            clearTimeout(storyTimer);
            if (currentStoryVideo) {
                currentStoryVideo.pause();
                currentStoryVideo = null;
            }
            document.getElementById('storyViewer').style.display = 'none';
            document.getElementById('storySoundBtn').style.display = 'none';
            document.getElementById('storyDeleteBtn').style.display = 'none';

            if (storyReplyInput) {
                storyReplyInput.value = '';
                storyReplyInput.blur();
            }
            const replyBar = document.getElementById('storyReplyBar');
            if (replyBar) replyBar.style.display = 'none';

            currentStoryKey = null;
            currentStoryReplyTargetUid = null;
        }

        function toggleStorySound(e) {
            e.stopPropagation();
            if (currentStoryVideo) {
                currentStoryVideo.muted = !currentStoryVideo.muted;
                storyMuted = currentStoryVideo.muted;
                document.getElementById('soundIcon').textContent = storyMuted ? 'volume_off' : 'volume_up';
            }
        }

        function deleteCurrentStory() {
            if (!currentStoryKey || !confirm('Delete this moment?')) return;
            db.ref(`moments/${currentUser.uid}/${currentStoryKey}`).remove();
            toast('Moment deleted');
            closeStoryViewer();
        }

        // ────────────────────────────────────────────────
        //   Story Reply Logic
        // ────────────────────────────────────────────────

        function setupStoryReplyHandlers() {
            storyReplyInput = document.getElementById('storyReplyInput');
            storySendReplyBtn = document.getElementById('storySendReply');

            if (!storyReplyInput || !storySendReplyBtn) return;

            storySendReplyBtn.addEventListener('click', sendStoryReply);

            storyReplyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendStoryReply();
                }
            });

            storyReplyInput.addEventListener('focus', () => {
                document.getElementById('storyReplyBar').classList.add('keyboard-visible');
            });

            storyReplyInput.addEventListener('blur', () => {
                document.getElementById('storyReplyBar').classList.remove('keyboard-visible');
            });
        }

        function sendStoryReply() {
            if (!storyReplyInput) return;
            const text = storyReplyInput.value.trim();
            if (!text) return;

            if (!currentStoryReplyTargetUid || !currentStoryKey) {
                toast("Cannot send reply right now");
                return;
            }

            toast(`Reply sent: "${text}"`);

            storyReplyInput.value = '';
            storyReplyInput.blur();

            // Future Firebase save example:
            /*
            db.ref(`story_replies/${currentStoryReplyTargetUid}/${currentStoryKey}`).push({
                text,
                sender: currentUser.uid,
                senderName: myProfile.name,
                ts: Date.now()
            });
            */
        }

        // ────────────────────────────────────────────────
        //   Utility functions (minimal version for demo)
        // ────────────────────────────────────────────────

        function toast(message) {
            const t = document.getElementById('toast');
            t.textContent = message;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2800);
        }

        function switchTab(tab) {
            document.getElementById('chatsTab').style.display = tab === 'chats' ? 'block' : 'none';
            document.getElementById('statusTab').style.display = tab === 'status' ? 'block' : 'none';
            document.getElementById('navChats').classList.toggle('active', tab === 'chats');
            document.getElementById('navStatus').classList.toggle('active', tab === 'status');
        }

        function openSheet(id) {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById(id).classList.add('active');
        }

        function closeAll() {
            document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active'));
            document.getElementById('overlay').style.display = 'none';
        }

        // Dummy / placeholder functions (you can replace with your real logic)
        function validateAndUpload(file) { toast("Upload started (placeholder)"); }
        function uploadProfilePicture(file) { toast("Profile picture upload (placeholder)"); }
        function updateProfile() { toast("Profile updated"); closeAll(); }
        function addFriendLogic() { toast("Friend added (placeholder)"); closeAll(); }

        // ────────────────────────────────────────────────
        //   Init
        // ────────────────────────────────────────────────

        document.addEventListener('DOMContentLoaded', () => {
            setupStoryReplyHandlers();

            // For demo: fake my profile
            myProfile = { name: "Katlego", photo: "https://via.placeholder.com/150/000/fff?text=K" };
            document.getElementById('myAvatar').src = myProfile.photo;
            document.getElementById('settingsAvatar').src = myProfile.photo;

            // Fake some moments to test stories
            document.getElementById('statusGrid').innerHTML = `
                <div class="status-card" onclick="openStories('user1')">
                    <img src="https://via.placeholder.com/300x500/000/fff?text=Story+1">
                    <div class="status-info"><b>Katlego</b></div>
                </div>
            `;
        });

        // For auth simulation (replace with real firebase auth)
        auth.onAuthStateChanged(user => {
            if (user) currentUser = user;
        });
    </script>
</body>
</html>
