<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Privy • Private Chat</title>
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg: #0f1115;
      --surface: #1a1d23;
      --surface2: #22272f;
      --text-primary: #e8ecef;
      --text-secondary: #9da5b0;
      --accent: #2090ea;
      --accent-dark: #1070c0;
      --bubble-sent: #2090ea;
      --bubble-recv: #2b2f33;
      --online: #43b581;
      --border: #2a2f38;
      --radius-sm: 12px;
      --radius-md: 18px;
      --radius-lg: 24px;
    }

    [data-theme="light"] {
      --bg: #f7f9fc;
      --surface: #ffffff;
      --surface2: #f0f2f5;
      --text-primary: #1f2a44;
      --text-secondary: #64748b;
      --bubble-sent: #2090ea;
      --bubble-recv: #e5efff;
      --border: #e2e8f0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      height: 100dvh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    header {
      height: 64px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 600;
      font-size: 18px;
      z-index: 10;
    }

    .back-btn {
      cursor: pointer;
      padding: 8px;
      color: var(--accent);
    }

    #chatListView, #chatView {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #chatList {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      gap: 12px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .chat-item:hover, .chat-item:active {
      background: rgba(255,255,255,0.04);
    }

    .avatar {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: #333;
      flex-shrink: 0;
      object-fit: cover;
    }

    .chat-info {
      flex: 1;
      min-width: 0;
    }

    .chat-name {
      font-weight: 600;
      margin-bottom: 3px;
      font-size: 16px;
    }

    .last-msg {
      font-size: 14px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-time {
      font-size: 12px;
      color: var(--text-secondary);
      align-self: flex-start;
      margin-top: 4px;
    }

    .message-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      background: var(--bg);
    }

    .message {
      max-width: 78%;
      padding: 10px 14px;
      border-radius: var(--radius-md);
      line-height: 1.38;
      font-size: 15px;
      position: relative;
      word-break: break-word;
    }

    .message.sent {
      align-self: flex-end;
      background: var(--bubble-sent);
      color: white;
      border-bottom-right-radius: 5px;
    }

    .message.received {
      align-self: flex-start;
      background: var(--bubble-recv);
      color: var(--text-primary);
      border-bottom-left-radius: 5px;
    }

    .message-tail {
      position: absolute;
      bottom: 0;
      width: 20px;
      height: 12px;
    }

    .message.sent .message-tail {
      right: -4px;
      background: var(--bubble-sent);
      clip-path: polygon(0 100%, 100% 100%, 100% 0);
    }

    .message.received .message-tail {
      left: -4px;
      background: var(--bubble-recv);
      clip-path: polygon(0 0, 100% 0, 0 100%);
    }

    .message-meta {
      font-size: 11px;
      opacity: 0.75;
      margin-top: 3px;
      text-align: right;
      display: flex;
      align-items: center;
      gap: 4px;
      justify-content: flex-end;
    }

    .ticks {
      font-size: 14px;
    }

    .ticks.read {
      color: #4fc3f7;
    }

    .input-area {
      background: var(--surface);
      padding: 12px 16px;
      display: flex;
      align-items: flex-end;
      gap: 12px;
      border-top: 1px solid var(--border);
    }

    textarea {
      flex: 1;
      background: var(--surface2);
      border: none;
      border-radius: 24px;
      padding: 12px 20px;
      color: var(--text-primary);
      font-size: 15px;
      resize: none;
      max-height: 120px;
      min-height: 48px;
      line-height: 1.4;
    }

    button.send {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      background: var(--accent);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      cursor: pointer;
      z-index: 100;
    }

    #toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 12px 24px;
      border-radius: 30px;
      z-index: 200;
      font-size: 14px;
      display: none;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 3px;
    }
  </style>
</head>
<body>

  <!-- Main Chat List View -->
  <div id="chatListView">
    <header>
      <div>Privy</div>
      <span class="material-symbols-rounded">more_vert</span>
    </header>

    <div id="chatList"></div>

    <div class="fab" onclick="openNewChatSheet()">+</div>
  </div>

  <!-- Single Chat View -->
  <div id="chatView" style="display:none;">
    <header>
      <span class="material-symbols-rounded back-btn" onclick="closeChat()">arrow_back</span>
      <div style="display:flex; align-items:center; gap:12px; flex:1;">
        <div class="avatar" id="chatAvatar"></div>
        <div>
          <div class="chat-name" id="chatName">...</div>
          <div id="chatStatus" style="font-size:13px; color:var(--text-secondary);">...</div>
        </div>
      </div>
      <span class="material-symbols-rounded">more_vert</span>
    </header>

    <div class="message-list" id="messageList"></div>

    <div class="input-area">
      <textarea id="messageInput" placeholder="Message" rows="1"></textarea>
      <button class="send material-symbols-rounded" id="sendBtn">send</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <script>
    // ── Firebase Config (your existing project) ─────────────────────────────
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    let currentChatUid = null;
    let currentRoomId = null;
    let sharedKeys = JSON.parse(localStorage.getItem('sharedKeys') || '{}');
    let messagesListener = null;

    const toastEl = document.getElementById('toast');

    function showToast(msg, duration = 2800) {
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      setTimeout(() => toastEl.style.display = 'none', duration);
    }

    // ── Auth & Init ─────────────────────────────────────────────────────────
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        console.log("Logged in:", user.uid);
        loadChatList();
      } else {
        // You can add a login screen here
        showToast("Please sign in first");
      }
    });

    // ── Encryption Helpers (your existing logic) ────────────────────────────
    async function deriveSharedSecret(friendPublicJwk) {
      if (!localStorage.getItem('privateKey')) {
        await generateAndStoreKeyPair();
      }
      const privateKeyJwk = JSON.parse(localStorage.getItem('privateKey'));
      const privateKey = await crypto.subtle.importKey(
        "jwk", privateKeyJwk, { name: "ECDH", namedCurve: "P-256" }, false, ["deriveBits"]
      );
      const friendPublicKey = await crypto.subtle.importKey(
        "jwk", friendPublicJwk, { name: "ECDH", namedCurve: "P-256" }, false, []
      );
      const shared = await crypto.subtle.deriveBits(
        { name: "ECDH", public: friendPublicKey }, privateKey, 256
      );
      return Array.from(new Uint8Array(shared)).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    async function generateAndStoreKeyPair() {
      const keyPair = await crypto.subtle.generateKey(
        { name: "ECDH", namedCurve: "P-256" }, true, ["deriveBits"]
      );
      const pub = await crypto.subtle.exportKey("jwk", keyPair.publicKey);
      const priv = await crypto.subtle.exportKey("jwk", keyPair.privateKey);
      localStorage.setItem('privateKey', JSON.stringify(priv));
      return pub;
    }

    function encrypt(text, key) {
      return CryptoJS.AES.encrypt(text, key).toString();
    }

    function decrypt(ciphertext, key) {
      try {
        const bytes = CryptoJS.AES.decrypt(ciphertext, key);
        return bytes.toString(CryptoJS.enc.Utf8) || "[Decryption failed]";
      } catch (e) {
        return "[Decryption failed]";
      }
    }

    // ── Chat List ───────────────────────────────────────────────────────────
    async function loadChatList() {
      const list = document.getElementById('chatList');
      list.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">Loading...</div>';

      db.ref(`users/${currentUser.uid}/chats`).on('value', async snap => {
        list.innerHTML = '';
        if (!snap.exists()) {
          list.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">No chats yet</div>';
          return;
        }

        const chats = [];
        snap.forEach(child => chats.push({ uid: child.key, ...child.val() }));
        chats.sort((a,b) => (b.ts || 0) - (a.ts || 0));

        for (const chat of chats) {
          const profileSnap = await db.ref(`users/${chat.uid}/profile`).once('value');
          const p = profileSnap.val() || {};
          const name = p.name || chat.uid.slice(0,8);
          const photo = p.photo || `https://i.pravatar.cc/64?u=${chat.uid}`;

          const div = document.createElement('div');
          div.className = 'chat-item';
          div.innerHTML = `
            <div class="avatar" style="background-image:url(${photo})"></div>
            <div class="chat-info">
              <div class="chat-name">${name}</div>
              <div class="last-msg">${chat.lastMsg ? decrypt(chat.lastMsg, sharedKeys[chat.uid] || 'fallback') : 'No messages yet'}</div>
            </div>
            <div class="chat-time">${formatTime(chat.ts)}</div>
          `;
          div.onclick = () => openChat(chat.uid, name, photo);
          list.appendChild(div);
        }
      });
    }

    // ── Open Chat ───────────────────────────────────────────────────────────
    async function openChat(uid, name, photo) {
      currentChatUid = uid;
      currentRoomId = [currentUser.uid, uid].sort().join('_');

      document.getElementById('chatListView').style.display = 'none';
      document.getElementById('chatView').style.display = 'flex';

      document.getElementById('chatName').textContent = name;
      document.getElementById('chatAvatar').style.backgroundImage = `url(${photo})`;

      // Load shared key if missing
      if (!sharedKeys[uid]) {
        const profileSnap = await db.ref(`users/${uid}/profile`).once('value');
        const pubKey = profileSnap.val()?.publicKey;
        if (pubKey) {
          const secret = await deriveSharedSecret(JSON.parse(pubKey));
          sharedKeys[uid] = secret;
          localStorage.setItem('sharedKeys', JSON.stringify(sharedKeys));
        }
      }

      loadMessages();
    }

    function closeChat() {
      if (messagesListener) messagesListener.off();
      document.getElementById('chatView').style.display = 'none';
      document.getElementById('chatListView').style.display = 'flex';
      currentChatUid = null;
      currentRoomId = null;
    }

    // ── Messages ────────────────────────────────────────────────────────────
    function loadMessages() {
      const list = document.getElementById('messageList');
      list.innerHTML = '';

      messagesListener = db.ref(`messages/${currentRoomId}`).limitToLast(80);

      messagesListener.on('child_added', snap => {
        const msg = snap.val();
        const isSent = msg.sender === currentUser.uid;
        const text = isSent || !sharedKeys[currentChatUid] 
          ? msg.text 
          : decrypt(msg.text, sharedKeys[currentChatUid]);

        const div = document.createElement('div');
        div.className = `message ${isSent ? 'sent' : 'received'}`;
        div.innerHTML = `
          ${text}
          <div class="message-meta">
            ${formatMessageTime(msg.ts)}
            ${isSent ? `<span class="ticks ${msg.read ? 'read' : ''}">✓✓</span>` : ''}
          </div>
        `;
        list.appendChild(div);
        list.scrollTop = list.scrollHeight;

        // Mark as read if received
        if (!isSent && !msg.read) {
          db.ref(`messages/\( {currentRoomId}/ \){snap.key}`).update({ read: true });
        }
      });
    }

    // ── Send Message ────────────────────────────────────────────────────────
    document.getElementById('sendBtn').onclick = async () => {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text || !currentChatUid) return;

      const key = sharedKeys[currentChatUid];
      if (!key) {
        showToast("Encryption key missing");
        return;
      }

      const encrypted = encrypt(text, key);
      const ts = Date.now();

      try {
        await db.ref(`messages/${currentRoomId}`).push({
          text: encrypted,
          sender: currentUser.uid,
          ts,
          read: false
        });

        const updates = {};
        updates[`users/\( {currentUser.uid}/chats/ \){currentChatUid}/lastMsg`] = encrypted;
        updates[`users/\( {currentUser.uid}/chats/ \){currentChatUid}/ts`] = ts;
        updates[`users/\( {currentChatUid}/chats/ \){currentUser.uid}/lastMsg`] = encrypted;
        updates[`users/\( {currentChatUid}/chats/ \){currentUser.uid}/ts`] = ts;
        updates[`users/\( {currentChatUid}/chats/ \){currentUser.uid}/unreadCount`] = firebase.database.ServerValue.increment(1);

        await db.ref().update(updates);

        input.value = '';
        input.style.height = 'auto';
      } catch (err) {
        console.error(err);
        showToast("Failed to send");
      }
    };

    document.getElementById('messageInput').addEventListener('keypress', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('sendBtn').click();
      }
    });

    // Auto-resize textarea
    document.getElementById('messageInput').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });

    // ── Helpers ─────────────────────────────────────────────────────────────
    function formatTime(ts) {
      if (!ts) return '';
      const date = new Date(ts);
      const now = Date.now();
      const diff = now - ts;
      if (diff < 86400000) return date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      return date.toLocaleDateString([], {month:'short', day:'numeric'});
    }

    function formatMessageTime(ts) {
      return new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }

    function openNewChatSheet() {
      // Placeholder — you can build a friend search / add screen here
      const id = prompt("Enter friend's Vynix ID or UID:");
      if (id) {
        // Add friend logic here (like your original addFriendLogic)
        alert("Add friend logic can be added here");
      }
    }

    // Initial load
    if (!currentUser) {
      showToast("Waiting for authentication...");
    }
  </script>
</body>
</html>
